<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="舞动乾坤">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="舞动乾坤">
<meta property="og:description" content="Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="舞动乾坤">
<meta name="twitter:description" content="Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/">





  <title>舞动乾坤 - 星光不问赶路人 岁月不负有心人</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband">
    	<div class="eevee"><div class="body"><div class="head"><div class="ears"><div class="ear"><div class="lobe"></div></div><div class="ear"><div class="lobe"></div></div></div><div class="face"><div class="eyes"><div class="eye"><div class="eyelid"></div></div><div class="eye"><div class="eyelid"></div></div></div><div class="nose"></div><div class="mouth"></div></div></div><div class="chest"><div class="fur"><div class="patch"></div></div><div class="fur"><div class="patch"></div></div><div class="fur"><div class="patch"></div></div></div><div class="legs"><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div></div><div class="tail"><div class="tail"><div class="tail"><div class="tail"><div class="tail"><div class="tail -end"></div></div></div></div></div></div></div></div>
    </div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
    	<div id="sky">
				<div id="background" class="container">
			<!-- svg file -->
			<svg id="svgout" height="100%" width="100%" viewbox="0 0 550 400">
				<defs>
					<g id="bottomShadow">
						<path fill="#000000" stroke="none" d="
		M 270.5 225.95
		L 127.35 316.65 266.8 400 409.6 309.25 270.5 225.95 Z"/>
					</g>
					<g id="Layer52_0_FILL">
						<path class="topGrass" fill="#B9D668" stroke="none" d="
	M 397.85 229.3
	L 397.85 225.6 269.85 152 135.75 228.6 135.75 233.65 262.1 306.55 397.85 229.3 Z"/>
					</g>
					<g id="Layer51_0_FILL">
						<path class="leftSideGrass" fill="#6E9E4F" stroke="none" d="
	M 135.1 229.95
	L 135.1 256.85 262.1 328.4 262.1 301.85 135.1 229.95 Z"/>
					</g>
					<g id="Layer50_0_FILL">
						<path class="rightGrassTop" fill="#8CB154" stroke="none" d="
	M 397.85 225.95
	L 395.8 225.95 261.75 301.55 261.75 328.4 397.85 251.15 397.85 225.95 Z"/>
					</g>
					<g id="Layer48_0_FILL">
						<path class="crustLeftTop" fill="#955541" stroke="none" d="
	M 135.45 282.4
	L 135.75 298.15 262.1 372.1 261.75 355.65 135.45 282.4 Z"/>
					</g>
					<g id="Layer47_0_FILL">
						<path class="middleLeftCrust" fill="#C77E61" stroke="none" d="
	M 135.1 270.3
	L 135.1 283.05 275.9 364.35 271.85 348.9 135.1 270.3 Z"/>
					</g>
					<g id="Layer46_0_FILL">
						<path class="crustLeftTop" fill="#955541" stroke="none" d="
	M 135.1 255.15
	L 135.1 270.3 262.1 343.55 262.1 328.05 135.1 255.15 Z"/>
					</g>
					<g id="Layer45_0_FILL">
						<path class="topRightCrust" fill="#A47237" stroke="none" d="
	M 397.5 294.5
	L 397.5 277 261.75 355.3 261.75 372.75 397.5 294.5 Z"/>
					</g>
					<g id="Layer44_0_FILL">
						<path class="middleRightCrust" fill="#C89451" stroke="none" d="
	M 397.5 269.95
	L 397.15 266.6 262.1 343.2 262.1 355.95 397.5 279.7 397.5 269.95 Z"/>
					</g>
					<g id="Layer43_0_FILL">
						<path class="topRightCrust" fill="#A47237" stroke="none" d="
	M 397.5 266.6
	L 397.5 250.45 261.75 328.4 261.75 343.85 397.5 266.6 Z"/>
					</g>
					<g id="Layer41_0_FILL">
						<path class="greyRoad" fill="#B2B2B1" stroke="none" d="
	M 295.05 283.05
	Q 299.05 280.35 308.45 275.3 317.85 269.95 323.6 266.9
	L 268.8 233.65 338.05 191.35 309.15 174.55 177.75 254.5
	Q 191.55 262.2 198.25 266.25 204.65 269.95 209.7 271.95
	L 241.6 250.45 295.05 283.05 Z"/>
					</g>
					<g id="Layer40_0_FILL">
						<path fill="#FFFFFF" stroke="none" d="
	M 199.95 256.85
	Q 194.55 261.2 191.9 262.2
	L 194.9 263.9 200.95 259.2 199.95 256.85
	M 225.8 243.75
	L 224.8 241.75 211.05 250.8 212.05 252.8 225.8 243.75
	M 308.15 275.65
	L 296.7 266.6 295.35 268.6 306.8 277.7 308.15 275.65
	M 275.9 253.5
	L 274.55 255.5 285.95 264.55 287.3 262.55 275.9 253.5
	M 251.7 227.3
	L 250.7 225.25 236.9 234.35 237.9 236.35 251.7 227.3
	M 257.05 240.7
	L 254.05 240.7 268.8 249.8 269.5 247.75 257.05 240.7
	M 277.2 207.8
	L 263.45 216.85 264.45 218.9 278.25 209.8 277.2 207.8
	M 305.1 192.65
	L 304.1 190.65 290.3 199.75 291.35 201.75 305.1 192.65 Z"/>
					</g>
					<g id="Layer38_0_FILL">
						<path class="frontFascia" fill="#ECB27B" stroke="none" d="
	M 359.25 187.95
	L 346.4 174.95 333.85 202.9 359.25 187.95 Z"/>
					</g>
					<g id="Layer37_0_FILL">
						<path class="frontWall" fill="#EFA258" stroke="none" d="
	M 334 201.05
	L 334.35 232 359.2 217.55 359.25 187.95 334 201.05 Z"/>
					</g>
					<g id="Layer36_0_FILL">
						<path class="leftWall" fill="#C57F42" stroke="none" d="
	M 334.35 232.3
	L 334.35 205.1 305.1 191.35 305.1 216.85 334.35 232.3 Z"/>
					</g>
					<g id="Layer35_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 329.7 167.9
	L 331.05 167.9 344.55 176.7 347.85 176.7 363 192.25 363.15 189.55 350.65 176.7 350.55 176.7 334.25 167.5 334.25 159.1 329.7 159.1 329.7 164.9 322.65 160.95 322.3 162.15 329.7 167 329.7 167.9 Z"/>
					</g>
					<g id="Layer34_0_FILL">
						<path class="leftRoof" fill="#F2563B" stroke="none" d="
	M 334.05 207.05
	L 350.65 176.7 322.1 160.45 302.1 192.05 334.05 207.05 Z"/>
					</g>
					<g id="Layer30_0_FILL">
						<path id="windowFour" class="windows" stroke="none" fill="#975A42" d="
	M 341.35 203.3
	Q 340.9 203.45 340.5 203.8 340.1 204.2 339.85 204.75 339.7 205 339.7 205.3 339.6 205.75 339.7 206.1 339.7 206.15 339.7 206.2 339.8 206.5 340 206.8 340.55 207.4 341.45 207.4 342.35 207.4 343 206.8 343.4 206.5 343.65 206.1 343.85 205.75 343.95 205.3 344.05 204.4 343.55 203.8 343.3 203.45 343 203.3 342.65 203.15 342.2 203.15 341.8 203.15 341.35 203.3
	M 355.85 198.45
	Q 355.8 198.2 355.6 198 355.1 197.4 354.2 197.4 353.35 197.4 352.6 198 351.85 198.65 351.7 199.55 351.7 199.7 351.7 199.85 351.6 200.5 352 201.05 352.55 201.65 353.45 201.65 354.3 201.65 355.05 201.05 355.45 200.7 355.7 200.25 355.8 200.05 355.9 199.85 355.95 199.7 355.95 199.55 356.05 198.95 355.85 198.45 Z"/>
						<path class="door" fill="#B65041" stroke="none" d="
	M 351.95 211.2
	L 351.8 211.2 346.05 215.1 346.05 225.2 351.95 221.6 351.95 211.2
	M 351.2 211.2
	L 351.35 211.2 351.35 211.1 351.2 211.2 Z"/>
					</g>
					<g>
						<path id="Layer30_0_FILL" fill="#000000" fill-opacity="1" stroke="none" d="
	M 183.7 215.3
	L 183.7 215.6
	Q 187.25 231.75 212.25 234.35
	L 183.7 215.3 Z"/>
					</g>
					<g id="Layer29_0_FILL">
						<path fill="#000000" fill-opacity="0.4" stroke="none" d="
	M 305.1 216.85
	L 305.15 217.2
	Q 309.45 233.2 334.35 232.3
	L 305.1 216.85 Z"/>
					</g>
					<g id="Layer27_0_FILL">
						<path class="vegetation" fill="#78A950" stroke="none" d="
	M 177.45 231.65
	Q 175.75 235.35 181.8 239.35 185.5 235.7 185.15 231.3 182.8 230.65 181.45 234 179.45 231.3 177.45 231.65
	M 236.9 266.6
	Q 235.2 270.3 241.25 274.3 244.95 270.6 244.65 266.25 242.3 265.6 240.95 268.95 238.9 266.25 236.9 266.6
	M 254.7 277
	Q 253.05 280.7 259.1 284.75 262.75 281.05 262.45 276.65 260.1 276 258.75 279.35 256.7 276.65 254.7 277
	M 315.5 245.75
	Q 313.5 243.05 311.5 243.4 309.8 247.1 315.85 251.15 319.55 247.45 319.2 243.05 316.85 242.4 315.5 245.75
	M 295.35 232.65
	Q 293.7 236.35 299.75 240.4 303.45 236.7 303.1 232.3 300.75 231.65 299.4 235 297.4 232.3 295.35 232.65
	M 277.2 171.85
	Q 275.55 175.55 281.6 179.55 285.3 175.85 284.95 171.5 282.6 170.85 281.25 174.2 279.25 171.5 277.2 171.85 Z"/>
					</g>
					<g id="Layer26_0_FILL">
						<path class="treeWood" fill="#AE663D" stroke="none" d="
	M 175.1 177.55
	L 172.05 177.55 172.05 191.1 159.3 172.85
	Q 154.6 171.5 172.05 195.7
	L 172.05 212.5 175.1 212.5 175.1 177.55
	M 252.7 151.35
	L 249 151.35 249 176.9 252.7 176.9 252.7 151.35 Z"/>
					</g>
					<g id="Layer25_0_FILL">
						<path class="vegetation" fill="#77A951" stroke="none" d="
	M 192.55 179.55
	Q 200.95 173.5 200.95 165.1 200.95 156.4 192.55 150 184.15 144.3 172.05 144.3 160.3 144.3 151.9 150 143.15 156.4 143.15 165.1 143.15 173.5 151.9 179.55 160.3 185.95 172.05 185.95 184.15 185.95 192.55 179.55
	M 236.25 106.65
	Q 230.2 116.05 230.2 129.15 230.2 142.25 236.25 151.35 242.3 160.75 250.7 160.75 258.75 160.75 264.8 151.35 270.85 142.25 270.85 129.15 270.85 116.05 264.8 106.65 258.75 97.6 250.7 97.6 242.3 97.6 236.25 106.65 Z"/>
					</g>
					<g id="Layer24_0_FILL">
						<path class="vegetation" fill="#77A951" stroke="none" d="
	M 158.3 221.9
	Q 160.65 221.9 161.95 220.2 163 219.55 163.3 218.55 164.65 218.9 166.35 218.9 170.05 218.9 172.4 216.2 175.1 213.85 175.1 210.15 175.1 206.45 172.4 203.75 170.05 201.4 166.35 201.4 162.65 201.4 159.95 203.75 157.6 206.45 157.6 210.15 157.6 210.8 157.6 211.15 155.95 211.5 154.6 212.5 152.9 214.15 152.9 216.55 152.9 218.9 154.6 220.2 156.25 221.9 158.3 221.9
	M 338.35 240.05
	Q 341.05 237.7 341.05 234 341.05 230.3 338.35 227.6 336 225.25 332.3 225.25 328.65 225.25 325.95 227.6 323.6 230.3 323.6 234 323.6 237.7 325.95 240.05 328.65 242.75 332.3 242.75 336 242.75 338.35 240.05 Z"/>
					</g>
					<g id="Layer22_0_FILL">
						<path class="rightRoof" fill="#D05041" stroke="none" d="
	M 220 173.85
	L 236.8 186.7 264.35 171.15 244.5 159.55 220 173.85 Z"/>
					</g>
					<g id="Layer21_0_FILL">
						<path class="leftWall" fill="#C57F42" stroke="none" d="
	M 212.25 191.35
	L 183.35 172.3 183.7 215.3 212.25 234.35 212.25 191.35 Z"/>
					</g>
					<g id="Layer20_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 192.1 149.85
	L 236.45 174.8 243.1 171.4
	Q 220.05 150.55 196.3 139.95
	L 192.1 149.85 Z"/>
					</g>
					<g id="Layer19_0_FILL">
						<path class="frontFascia" fill="#EBB17B" stroke="none" d="
	M 226.85 160.95
	L 212 190.6 229.75 192.6 239.75 172.85 226.85 160.95 Z"/>
					</g>
					<g id="Layer18_0_FILL">
						<path class="frontWall" fill="#EFA258" stroke="none" d="
	M 240.15 172.65
	L 211.9 191.6 212.25 233.65 264.35 201.7 264.35 170.8 240.8 184.45 240.15 172.65 Z"/>
					</g>
					<g id="Layer17_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 210.9 142.2
	L 205.9 142.2 205.9 152.65 210.9 152.65 210.9 142.2 Z"/>
					</g>
					<g>
						<path id="Layer16_0_FILL" class="leftRoof" fill="#F2563B" stroke="none" d="
	M 210.25 195.5
	L 227.4 160.95 195.45 141.35 177.65 175.85 210.25 195.5 Z"/>
					</g>
					<g>
						<path id="sun" fill="#E3BD0E" stroke="none" d="
	M 257.05 15.95
	Q 251.7 15.95 248 19.65 244.3 23.35 244.3 28.7 244.3 34.1 248 37.8 251.7 41.5 257.05 41.5 262.45 41.5 266.15 37.8 269.85 34.1 269.85 28.7 269.85 23.35 266.15 19.65 262.45 15.95 257.05 15.95 Z"/>
					</g>
					<g id="Layer8_0_FILL">
						<path fill="#975A42" stroke="none" d="
	M 238.45 189.65
	Q 238.295703125 189.362109375 238.05 189.1 237.35 188.3 236.2 188.3 235.05 188.3 234.15 189.1 233.3 189.9 233.2 191.05 233.1 192.2 233.8 193 234.55 193.8 235.7 193.8 236.85 193.8 237.7 193 238.1970703125 192.558203125 238.45 192 238.6552734375 191.56484375 238.7 191.05 238.7671875 190.276953125 238.45 189.65
	M 220.55 197.55
	Q 220 197.55 219.5 197.75 218.95 197.95 218.5 198.35 217.933203125 198.8833984375 217.7 199.55 217.5833984375 199.916796875 217.55 200.3 217.4923828125 200.96171875 217.7 201.5 217.852734375 201.9103515625 218.15 202.25 218.95 203.05 220.1 203.05 221.25 203.05 222.05 202.25 222.95 201.45 223.05 200.3 223.15 199.15 222.4 198.35 222.05 197.95 221.65 197.75 221.15 197.55 220.55 197.55 Z"/>
					</g>
					<g id="Layer7_0_FILL">
						<path class="door" fill="#B65041" stroke="none" d="
	M 233.55 206.75
	L 225.9 211.95 226.25 225.5 233.95 220.35 233.55 206.75 Z"/>
					</g>
					<g>
						<path id="windowOne" class="windows" fill="#975A42" stroke="none" d="
	M 188.65 198.4
	L 188.8 204.1 198.65 210.45 198.55 204.75 188.65 198.4
	M 208.45 216.8
	L 208.35 211.1 198.55 204.75 198.65 210.45 208.45 216.8
	M 188.8 204.1
	L 188.95 209.8 198.8 216.15 198.65 210.45 188.8 204.1
	M 208.6 222.5
	L 208.45 216.8 198.65 210.45 198.8 216.15 208.6 222.5 Z"/>
					</g>
					<g>
						<path id="windowThree" class="windows" fill="#975A42" stroke="none" d="
	M 311.7 214.1
	L 318.55 217.55 318.45 211.9 311.6 208.45 311.7 214.1
	M 325.4 221
	L 325.25 215.35 318.45 211.9 318.55 217.55 325.4 221
	M 318.4 206.2
	L 311.5 202.75 311.6 208.45 318.45 211.9 318.4 206.2
	M 325.25 215.35
	L 325.2 209.7 318.4 206.2 318.45 211.9 325.25 215.35 Z"/>
					</g>
					<g id="Layer2_0_FILL">
						<path class="door" fill="#B65041" stroke="none" d="
	M 259.7 183.25
	L 244.6 191.9 244.6 213.8 259.7 204.55 259.7 183.25 Z"/>
					</g>
					<path id="windowTwo" fill="#975A42" class="windows" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" d="
	M 223.05 200.3
	Q 222.95 201.45 222.05 202.25 221.25 203.05 220.1 203.05 218.95 203.05 218.15 202.25 217.852734375 201.9103515625 217.7 201.5 217.4923828125 200.96171875 217.55 200.3 217.5833984375 199.916796875 217.7 199.575 217.933203125 198.8833984375 218.5 198.35 218.95 197.95 219.5 197.75 220 197.55 220.55 197.55 221.15 197.55 221.65 197.75 222.05 197.95 222.4 198.35 223.15 199.15 223.05 200.3 Z
	M 238.7 191.05
	Q 238.6552734375 191.56484375 238.45 192 238.1970703125 192.558203125 237.7 193 236.85 193.8 235.7 193.8 234.55 193.8 233.8 193 233.1 192.2 233.2 191.05 233.3 189.9 234.15 189.1 235.05 188.3 236.2 188.3 237.35 188.3 238.05 189.1 238.295703125 189.362109375 238.45 189.65 238.7671875 190.276953125 238.7 191.05 Z"/>
					<path fill="#F2563B" stroke="none" d=" M 351.95 211.2 L 351.8 211.2 346.05 215.1 346.05 225.2 351.95 221.6 351.95 211.2 Z"/>
					<path id="Layer6_0_1_STROKES" class="windowRims" stroke="#AE663D" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" fill="none" d="
	M 198.55 204.75
	L 208.35 211.1 208.45 216.8 208.6 222.5 198.8 216.15 188.95 209.8 188.8 204.1 188.65 198.4 198.55 204.75 198.65 210.45 208.45 216.8
	M 198.8 216.15
	L 198.65 210.45 188.8 204.1"/>
					<path id="Layer5_0_1_STROKES" class="windowRims" stroke="#AE663D" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" fill="none" d="
	M 325.25 215.35
	L 325.4 221 318.55 217.55 311.7 214.1 311.6 208.45 311.5 202.75 318.4 206.2 325.2 209.7 325.25 215.35 318.45 211.9 318.55 217.55
	M 318.4 206.2
	L 318.45 211.9 311.6 208.45"/>
				</defs>
				<g id="shadow">
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use xlink:href="#bottomShadow"/>
					</g>
				</g>
				<g transform="matrix( 1, 0, 0, 1, 0,0) ">
					<use xlink:href="#sun"/>
				</g>
				<g id="earth">
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer52_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer51_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer50_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer48_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer47_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer46_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer45_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer44_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer43_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer41_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer40_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer38_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer37_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer36_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer35_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer34_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowFour"/>
						<use class="element" xlink:href="#Layer32_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer30_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer27_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer26_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer25_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer24_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer22_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer21_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer20_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer19_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer18_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer17_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer16_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer8_0_FILL"/>
						<use class="element" xlink:href="#windowTwo"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer7_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowOne"/>
						<use class="element" xlink:href="#Layer6_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowThree"/>
						<use class="element" xlink:href="#Layer5_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer2_0_FILL"/>
					</g>
				</g>
			</svg>
			<! -- End of SVG file -->
			<! -- Moon/Sun Toggle -->
			<div id="toggleButton" class="day-toggle">
				<div class="sun-icon"></div>
				<label class="switch">
            <input id="toggleCheckbox" type="checkbox">
            <div class="slider"></div>
        </label>
				<div class="cloud-icon"></div>
			</div>
			<! -- Moon/Sun Toggle -->
			<! -- End of Container -->
		</div>
			</div>
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">舞动乾坤</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">星光不问赶路人 岁月不负有心人</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/06/一道赋值面试题引发的思考3【并发数控制】/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/06/一道赋值面试题引发的思考3【并发数控制】/" itemprop="url">一道赋值面试题引发的思考3【并发数控制】</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-06T21:25:02+08:00">
                2019-02-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="记一道控制并发数的前端面试题【手动维护-HTTP-请求排队】"><a href="#记一道控制并发数的前端面试题【手动维护-HTTP-请求排队】" class="headerlink" title="记一道控制并发数的前端面试题【手动维护 HTTP 请求排队】"></a><a href="http://www.heiniaozhi.cn/articles/detail/178" target="_blank" rel="noopener">记一道控制并发数的前端面试题【手动维护 HTTP 请求排队】</a></h2><h2 id="23行代码实现一个带并发数限制的fetch请求函数"><a href="#23行代码实现一个带并发数限制的fetch请求函数" class="headerlink" title="23行代码实现一个带并发数限制的fetch请求函数"></a><a href="https://juejin.im/post/5c89d447f265da2dd37c604c" target="_blank" rel="noopener">23行代码实现一个带并发数限制的fetch请求函数</a></h2><h2 id="Promise面试题1"><a href="#Promise面试题1" class="headerlink" title="Promise面试题1"></a>Promise面试题1</h2><p>有这样一道关于promise的面试题，描述如下：</p>
<blockquote>
<p>页面上有一个输入框，两个按钮，A按钮和B按钮，点击A或者B分别会发送一个异步请求，请求完成后，结果会显示在输入框中。</p>
</blockquote>
<p>题目要求，用户随机点击A和B多次，要求输入框显示结果时，按照用户点击的顺序显示，举例：</p>
<p>用户点击了一次A，然后点击一次B，又点击一次A，输入框显示结果的顺序为先显示A异步请求结果，再次显示B的请求结果，最后再次显示A的请求结果。</p>
<p>UI界面如图：</p>
<p><img src="/2019/02/06/一道赋值面试题引发的思考3【并发数控制】/1.webp" alt=""></p>
<p>这个需求该如何用promise来实现呢？代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//dom元素</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="built_in">document</span>.querySelector(<span class="string">"#a"</span>)</span><br><span class="line"><span class="keyword">var</span> b = <span class="built_in">document</span>.querySelector(<span class="string">"#b"</span>)</span><br><span class="line"><span class="keyword">var</span> i = <span class="built_in">document</span>.querySelector(<span class="string">"#ipt"</span>);</span><br><span class="line"><span class="comment">//全局变量p保存promie实例</span></span><br><span class="line"><span class="keyword">var</span> P = <span class="built_in">Promise</span>.resolve();</span><br><span class="line">a.onclick  = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//将事件过程包装成一个promise并通过then链连接到</span></span><br><span class="line">    <span class="comment">//全局的Promise实例上，并更新全局变量，这样其他点击</span></span><br><span class="line">    <span class="comment">//就可以拿到最新的Promies执行链</span></span><br><span class="line">    P = P.then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//then链里面的函数返回一个新的promise实例</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve,reject</span>)</span>&#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                resolve()</span><br><span class="line">                i.value = <span class="string">"a"</span>;</span><br><span class="line">            &#125;,<span class="number">1000</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">b.onclick  = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    P = P.then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve,reject</span>)</span>&#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                resolve()</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"b"</span>)</span><br><span class="line">                i.value = <span class="string">"b"</span></span><br><span class="line">            &#125;,<span class="number">2000</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们用定时器来模拟异步请求，仔细于阅读代码我们发现，在全局我们定义了一个全局P，P保存了一个promise的实例。</p>
<p>然后再观察点击事件的代码，用户每次点击按钮时，我们在事件中访问全局Promise实例，将异步操作包装到成新的Promise实例，然后通过全局Promise实例的then方法来连接这些行为。</p>
<p>连接的时候需要注意，then链的函数中必须将新的promise实例进行返回，不然就会执行顺序就不正确了。</p>
<p>需要注意的是，then链连接完成后，我们需要更新全局的P变量，只有这样，其它点击事件才能得到最新的Promise的执行链。</p>
<p>这样每次用户点击按钮就不需要关心回调执行时机了，因为promise的then链会按照其连接顺序依次执行。</p>
<p>这样就能保证用户的点击顺序和promise的执行顺序一致了。</p>
<h2 id="Promise面试题2"><a href="#Promise面试题2" class="headerlink" title="Promise面试题2"></a>Promise面试题2</h2><p>按照要求：</p>
<blockquote>
<p>实现 mergePromise 函数，把传进去的函数数组按顺序先后执行，并且把返回的数据先后放到数组 data 中。</p>
</blockquote>
<p>代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> timeout = <span class="function"><span class="params">ms</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        resolve();</span><br><span class="line">    &#125;, ms);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ajax1 = <span class="function"><span class="params">()</span> =&gt;</span> timeout(<span class="number">2000</span>).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'1'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ajax2 = <span class="function"><span class="params">()</span> =&gt;</span> timeout(<span class="number">1000</span>).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'2'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ajax3 = <span class="function"><span class="params">()</span> =&gt;</span> timeout(<span class="number">2000</span>).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'3'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mergePromise = <span class="function"><span class="params">ajaxArray</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 在这里实现你的代码</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">mergePromise([ajax1, ajax2, ajax3]).then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'done'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(data); <span class="comment">// data 为 [1, 2, 3]</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 要求分别输出</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// done</span></span><br><span class="line"><span class="comment">// [1, 2, 3]</span></span><br></pre></td></tr></table></figure></p>
<p>分析： </p>
<p>timeout是一个函数，这个函数执行后返回一个promise实例。</p>
<blockquote>
<p>ajax1 、ajax2、ajax3 都是函数，不过这些函数有一些特点，执行后都会会返回一个 新的promise实例。</p>
</blockquote>
<p>按题目的要求我们只要顺序执行这三个函数就好了，然后把结果放到 data 中，但是这些函数里都是异步操作，想要按顺序执行，然后输出 1，2，3并没有那么简单，看个例子。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">A</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'a'</span>);</span><br><span class="line">  &#125;, <span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">B</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'b'</span>);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">A();</span><br><span class="line">B();</span><br><span class="line"></span><br><span class="line"><span class="comment">// b</span></span><br><span class="line"><span class="comment">// a</span></span><br></pre></td></tr></table></figure></p>
<p>例子中我们是按顺序执行的 A，B 但是输出的结果却是 b，a 对于这些异步函数来说，并不会按顺序执行完一个，再执行后一个。 </p>
<p>这道题主要考察的是Promise 控制异步流程，我们要想办法，让这些函数，一个执行完之后，再执行下一个，代码如何实现呢？<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存数组中的函数执行后的结果</span></span><br><span class="line"><span class="keyword">var</span> data = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Promise.resolve方法调用时不带参数，直接返回一个resolved状态的 Promise 对象。</span></span><br><span class="line"><span class="keyword">var</span> sequence = <span class="built_in">Promise</span>.resolve();</span><br><span class="line"></span><br><span class="line">ajaxArray.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">item</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 第一次的 then 方法用来执行数组中的每个函数，</span></span><br><span class="line">    <span class="comment">// 第二次的 then 方法接受数组中的函数执行后返回的结果，</span></span><br><span class="line">    <span class="comment">// 并把结果添加到 data 中，然后把 data 返回。</span></span><br><span class="line">    sequence = sequence.then(item).then(<span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">        data.push(res);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历结束后，返回一个 Promise，也就是 sequence， 他的 [[PromiseValue]] 值就是 data，</span></span><br><span class="line"><span class="comment">// 而 data（保存数组中的函数执行后的结果） 也会作为参数，传入下次调用的 then 方法中。</span></span><br><span class="line"><span class="keyword">return</span> sequence;</span><br></pre></td></tr></table></figure></p>
<p>大概思路如下：全局定义一个promise实例sequence，循环遍历函数数组，每次循环更新sequence，将要执行的函数item通过sequence的then方法进行串联，并且将执行结果推入data数组，最后将更新的data返回，这样保证后面sequence调用then方法，如何后面的函数需要使用data只需要将函数改为带参数的函数。</p>
<h2 id="Promise面试题3"><a href="#Promise面试题3" class="headerlink" title="Promise面试题3"></a>Promise面试题3</h2><p><img src="/2019/02/06/一道赋值面试题引发的思考3【并发数控制】/2.png" alt=""><br>题目是这样的：</p>
<blockquote>
<p>有 8 个图片资源的 url，已经存储在数组 urls 中（即urls = [‘<a href="http://example.com/1.jpg&#39;" target="_blank" rel="noopener">http://example.com/1.jpg&#39;</a>, …., ‘<a href="http://example.com/8.jpg&#39;]），而且已经有一个函数" target="_blank" rel="noopener">http://example.com/8.jpg&#39;]），而且已经有一个函数</a> function loadImg，输入一个 url 链接，返回一个 Promise，该 Promise 在图片下载完成的时候 resolve，下载失败则 reject。</p>
</blockquote>
<p>但是我们要求，任意时刻，<strong>同时下载的链接数量不可以超过 3 个</strong>。</p>
<p>请写一段代码实现这个需求，要求尽可能快速地将所有图片下载完成。</p>
<p>已有代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> urls = [</span><br><span class="line">    <span class="string">'https://www.kkkk1000.com/images/getImgData/getImgDatadata.jpg'</span>, </span><br><span class="line">    <span class="string">'https://www.kkkk1000.com/images/getImgData/gray.gif'</span>, </span><br><span class="line">    <span class="string">'https://www.kkkk1000.com/images/getImgData/Particle.gif'</span>, </span><br><span class="line">    <span class="string">'https://www.kkkk1000.com/images/getImgData/arithmetic.png'</span>, </span><br><span class="line">    <span class="string">'https://www.kkkk1000.com/images/getImgData/arithmetic2.gif'</span>, </span><br><span class="line">    <span class="string">'https://www.kkkk1000.com/images/getImgData/getImgDataError.jpg'</span>, </span><br><span class="line">    <span class="string">'https://www.kkkk1000.com/images/getImgData/arithmetic.gif'</span>, </span><br><span class="line">    <span class="string">'https://www.kkkk1000.com/images/wxQrCode2.png'</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadImg</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> img = <span class="keyword">new</span> Image()</span><br><span class="line">        img.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'一张图片加载完成'</span>);</span><br><span class="line">            resolve();</span><br><span class="line">        &#125;</span><br><span class="line">        img.onerror = reject</span><br><span class="line">        img.src = url</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>看到这个题目的时候，脑袋里瞬间想到了高效率排队买地铁票的情景，那个情景类似下图：</p>
<p><img src="/2019/02/06/一道赋值面试题引发的思考3【并发数控制】/2.webp" alt=""></p>
<p>上图这样的排队和并发请求的场景基本类似，窗口只有三个，人超过三个之后，后面的人只能排队了。</p>
<p>首先想到的便是利用递归来做，就如这篇文章采取的措施一样，代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//省略代码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//对加载图片的函数做处理，计数器叠加计数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bao</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    count++;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"并发数:"</span>,count)</span><br><span class="line">    <span class="comment">//条件判断，urls长度大于0继续，小于等于零说明图片加载完成</span></span><br><span class="line">    <span class="keyword">if</span>(urls.length&gt;<span class="number">0</span>&amp;&amp;count&lt;=<span class="number">3</span>)&#123;</span><br><span class="line">    <span class="comment">//shift从数组中取出连接</span></span><br><span class="line">        loadImg(urls.shift()).then(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">//计数器递减</span></span><br><span class="line">            count--</span><br><span class="line">            <span class="comment">//递归调用</span></span><br><span class="line">            &#125;).then(bao)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">async1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="comment">//循环开启三次</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++)&#123;</span><br><span class="line">        bao();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">async1()</span><br></pre></td></tr></table></figure></p>
<p>以上是最常规的思路，我将加载图片的函数loadImg封装在bao函数内，根据条件判断，是否发送请求，请求完成后继续递归调用。</p>
<p>以上代码所有逻辑都写在了同一个函数中然后递归调用，可以优化一下，代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> count = <span class="number">0</span>;   <span class="comment">//当前正在进行数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 封装请求的异步函数,增加计数器功能</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">request</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    count++;</span><br><span class="line">    loadImg(urls.shift()).then(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">            count--</span><br><span class="line">            &#125;).then(diaodu)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 负责调度的函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">diaodu</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(urls.length&gt;<span class="number">0</span>&amp;&amp;count&lt;=<span class="number">3</span>)&#123;</span><br><span class="line">        request();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">async1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++)&#123;</span><br><span class="line">        request();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">async1()</span><br></pre></td></tr></table></figure></p>
<p>上面代码将一个递归函数拆分成两个，一个函数只负责计数和发送请求，另外一个负责调度。</p>
<p>这里的请求既然已经被封装成了Promise，那么我们用Promise和saync、await来完成一下，代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//省略代码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 计数器</span></span><br><span class="line"><span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 全局锁</span></span><br><span class="line"><span class="keyword">var</span> lock = [];</span><br><span class="line"><span class="keyword">var</span> l = urls.length;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bao</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(count&gt;=<span class="number">3</span>)&#123;</span><br><span class="line">        <span class="comment">//超过限制利用await和promise进行阻塞;</span></span><br><span class="line">        <span class="keyword">let</span> _resolve;</span><br><span class="line">        <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">            _resolve=resolve;</span><br><span class="line">            <span class="comment">// resolve不执行,将其推入lock数组;</span></span><br><span class="line">            lock.push(_resolve);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(urls.length&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(count);</span><br><span class="line">        count++</span><br><span class="line">        <span class="keyword">await</span> loadImg(urls.shift());</span><br><span class="line">        count--;</span><br><span class="line">        lock.length&amp;&amp;lock.shift()()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; l; i++) &#123;</span><br><span class="line">    bao();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>大致思路是，遍历执行urls.length长度的请求，但是当请求并发数大于限制时，超过的请求用await结合promise将其阻塞，并且将resolve填充到lock数组中，继续执行，并发过程中有图片加载完成后，从lock中推出一项resolve执行，lock相当于一个叫号机；</p>
<p>以上代码可以优化为：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//省略代码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 计数器</span></span><br><span class="line"><span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 全局锁</span></span><br><span class="line"><span class="keyword">var</span> lock = [];</span><br><span class="line"><span class="keyword">var</span> l = urls.length;</span><br><span class="line"><span class="comment">// 阻塞函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">block</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> _resolve;</span><br><span class="line">    <span class="keyword">return</span>  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">        _resolve=resolve;</span><br><span class="line">        <span class="comment">// resolve不执行,将其推入lock数组;</span></span><br><span class="line">        lock.push(_resolve);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 叫号机</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    lock.length&amp;&amp;lock.shift()()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">bao</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(count&gt;=<span class="number">3</span>)&#123;</span><br><span class="line">        <span class="comment">//超过限制利用await和promise进行阻塞;</span></span><br><span class="line">        <span class="keyword">await</span> block();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(urls.length&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(count);</span><br><span class="line">        count++</span><br><span class="line">        <span class="keyword">await</span> loadImg(urls.shift());</span><br><span class="line">        count--;</span><br><span class="line">        next()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; l; i++) &#123;</span><br><span class="line">    bao();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后一种方案，也是我十分喜欢的，思考好久才明白，大概思路如下：</p>
<p>用 Promise.race来实现，先并发请求3个图片资源，这样可以得到 3 个 Promise实例，组成一个数组promises ，然后不断的调用 Promise.race 来返回最快改变状态的 Promise，然后从数组（promises ）中删掉这个 Promise 对象实例，再加入一个新的 Promise实例，直到全部的 url 被取完。</p>
<p>代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//省略代码</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">limitLoad</span>(<span class="params">urls, handler, limit</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 对数组做一个拷贝</span></span><br><span class="line">    <span class="keyword">const</span> sequence = [].concat(urls)</span><br><span class="line">    <span class="keyword">let</span> promises = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//并发请求到最大数</span></span><br><span class="line">    promises = sequence.splice(<span class="number">0</span>, limit).map(<span class="function">(<span class="params">url, index</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 这里返回的 index 是任务在 promises 的脚标，</span></span><br><span class="line">        <span class="comment">//用于在 Promise.race 之后找到完成的任务脚标</span></span><br><span class="line">        <span class="keyword">return</span> handler(url).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> index</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    (<span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">loop</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> p = <span class="built_in">Promise</span>.race(promises);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; sequence.length; i++) &#123;</span><br><span class="line">            p = p.then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">                promises[res] = handler(sequence[i]).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> res</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">Promise</span>.race(promises)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)()</span><br><span class="line">&#125;</span><br><span class="line">limitLoad(urls, loadImg, <span class="number">3</span>)</span><br></pre></td></tr></table></figure></p>
<p>第三种方案的巧妙之处，在于使用了Promise.race。并且在循环时用then链串起了执行顺序。</p>
<h3 id="15-行代码实现并发控制（javascript）"><a href="#15-行代码实现并发控制（javascript）" class="headerlink" title="15 行代码实现并发控制（javascript）"></a>15 行代码实现并发控制（javascript）</h3><p>做过爬虫的都知道，要控制爬虫的请求并发量，其实也就是控制其爬取频率，以免被封IP，还有的就是以此来控制爬虫应用运行内存，否则一下子处理N个请求，内存分分钟会爆。 </p>
<p>而 <code>python</code>爬虫一般用多线程来控制并发，</p>
<p>然而如果是<code>node.js</code>爬虫，由于其<strong>单线程无阻塞</strong>性质以及事件循环机制，一般不用多线程来控制并发（当然<code>node.js</code>也可以实现多线程，此处非重点不再多讲），而是更加简便地直接在代码层级上实现并发。</p>
<p>为图方便，开发者在开发<code>node</code>爬虫一般会找一个并发控制的<code>npm包</code>，然而第三方的模块有时候也并不能完全满足我们的特殊需求，这时候我们可能就需要一个自己定制版的并发控制函数。</p>
<p>下面我们用15行代码实现一个并发控制的函数。</p>
<p>首先，一个基本的并发控制函数，基本要有以下3个参数：</p>
<ul>
<li><code>list</code> {Array} - 要迭代的数组</li>
<li><code>limit</code> {number} - 控制的并发数量</li>
<li><code>asyncHandle</code> {function} - 对<code>list</code>的每一个项的处理函数</li>
</ul>
<h4 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h4><p>以下以爬虫为实例进行讲解</p>
<p>设计思路其实很简单，假如并发量控制是 5</p>
<p>1.首先，瞬发 5 个异步请求，我们就得到了并发的 5 个异步请求</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// limit = 5</span></span><br><span class="line"><span class="keyword">while</span>(limit--) &#123;</span><br><span class="line">    handleFunction(list)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>然后，这 5 个异步请求中无论哪一个先执行完，都会继续执行下一个<code>list</code>项</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> recursion = <span class="function">(<span class="params">arr</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> asyncHandle(arr.shift())</span><br><span class="line">        .then(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">            <span class="comment">// 迭代数组长度不为0， 递归执行自身if (arr.length!==0) return recursion(arr) </span></span><br><span class="line">            <span class="comment">// 迭代数组长度为0，结束 elsereturn'finish';</span></span><br><span class="line">        &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>等<code>list</code>所有的项迭代完之后的回调</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="built_in">Promise</span>.all(allHandle)</span><br></pre></td></tr></table></figure>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>上述步骤组合起来，就是<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @params list &#123;Array&#125; - 要迭代的数组</span></span><br><span class="line"><span class="comment"> * @params limit &#123;Number&#125; - 并发数量控制数</span></span><br><span class="line"><span class="comment"> * @params asyncHandle &#123;Function&#125; - 对`list`的每一个项的处理函数，参数为当前处理项，必须 return 一个Promise来确定是否继续进行迭代</span></span><br><span class="line"><span class="comment"> * @return &#123;Promise&#125; - 返回一个 Promise 值来确认所有数据是否迭代完成</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">let</span> mapLimit = <span class="function">(<span class="params">list, limit, asyncHandle</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> recursion = <span class="function">(<span class="params">arr</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> asyncHandle(arr.shift())</span><br><span class="line">            .then(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (arr.length!==<span class="number">0</span>) <span class="keyword">return</span> recursion(arr)   <span class="comment">// 数组还未迭代完，递归继续进行迭代</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">'finish'</span>;</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> listCopy = [].concat(list);</span><br><span class="line">    <span class="keyword">let</span> asyncList = []; <span class="comment">// 正在进行的所有并发异步操作</span></span><br><span class="line">    <span class="keyword">while</span>(limit--) &#123;</span><br><span class="line">        asyncList.push( recursion(listCopy) ); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.all(asyncList);  <span class="comment">// 所有并发异步操作都完成后，本次并发控制迭代完成</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="测试demo"><a href="#测试demo" class="headerlink" title="测试demo"></a>测试demo</h3><p>模拟一下异步的并发情况<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dataLists = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">11</span>,<span class="number">100</span>,<span class="number">123</span>];</span><br><span class="line"><span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">mapLimit(dataLists, <span class="number">3</span>, (curItem)=&gt;&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        count++</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(curItem, <span class="string">'当前并发量:'</span>, count--)</span><br><span class="line">            resolve();</span><br><span class="line">        &#125;, <span class="built_in">Math</span>.random() * <span class="number">5000</span>)  </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;).then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'finish'</span>, response)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="完整Code"><a href="#完整Code" class="headerlink" title="完整Code"></a>完整Code</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * @params list &#123;Array&#125; - 要迭代的数组 </span></span><br><span class="line"><span class="comment"> * @params limit &#123;Number&#125; - 并发数量控制数 </span></span><br><span class="line"><span class="comment"> * @params asyncHandle &#123;Function&#125; - 对`list`的每一个项的处理函数，参数为当前处理项，必须 return 一个Promise来确定是否继续进行迭代 </span></span><br><span class="line"><span class="comment"> * @return &#123;Promise&#125; - 返回一个 Promise 值来确认所有数据是否迭代完成 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapLimit</span>(<span class="params">list, limit, asyncHandle</span>) </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">recursion</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> asyncHandle(arr.shift())</span><br><span class="line">			.then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">				<span class="keyword">if</span>(arr.length !== <span class="number">0</span>) <span class="keyword">return</span> recursion(arr) <span class="comment">// 数组还未迭代完，递归继续进行迭代 </span></span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">return</span> <span class="string">'finish'</span>;</span><br><span class="line">			&#125;)</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">let</span> listCopy = [].concat(list);</span><br><span class="line">	<span class="keyword">let</span> asyncList = []; <span class="comment">// 正在进行的所有并发异步操作 </span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(limit--) &#123;</span><br><span class="line">		asyncList.push(recursion(listCopy));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Promise</span>.all(asyncList); <span class="comment">// 所有并发异步操作都完成后，本次并发控制迭代完成 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//测试</span></span><br><span class="line"><span class="keyword">var</span> dataLists = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">11</span>, <span class="number">100</span>, <span class="number">123</span>];</span><br><span class="line"><span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">mapLimit(dataLists, <span class="number">3</span>, <span class="function"><span class="keyword">function</span>(<span class="params">curItem</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">		count++</span><br><span class="line">		setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">			<span class="built_in">console</span>.log(curItem, <span class="string">'当前并发量:'</span>, count--)</span><br><span class="line">			resolve();</span><br><span class="line">		&#125;, <span class="built_in">Math</span>.random() * <span class="number">1000</span>)</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;).then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'finish'</span>, response)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<p><img src="/2019/02/06/一道赋值面试题引发的思考3【并发数控制】/3.webp" alt=""></p>
<p>手动抛出异常中断并发函数测试：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dataLists = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">11</span>,<span class="number">100</span>,<span class="number">123</span>];</span><br><span class="line"><span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">mapLimit(dataLists, <span class="number">3</span>, (curItem)=&gt;&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        count++</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(curItem, <span class="string">'当前并发量:'</span>, count--)</span><br><span class="line">            <span class="keyword">if</span>(curItem &gt; <span class="number">4</span>) reject(<span class="string">'error happen'</span>)</span><br><span class="line">            resolve();</span><br><span class="line">        &#125;, <span class="built_in">Math</span>.random() * <span class="number">5000</span>)  </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;).then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'finish'</span>, response)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>并发控制情况下，迭代到5,6,7 手动抛出异常，停止后续迭代：</p>
<p><img src="/2019/02/06/一道赋值面试题引发的思考3【并发数控制】/4.webp" alt=""> </p>
<h2 id="JS数组拍平-扁平化-的3种方法"><a href="#JS数组拍平-扁平化-的3种方法" class="headerlink" title="JS数组拍平[扁平化]的3种方法"></a>JS数组拍平[扁平化]的3种方法</h2><p>在开发过程中有得时候总是碰一些共性的问题，比如将一个二维数组拍平成一维数组，或者三维数组拍平成一维数组。这些问题在遇到的时候总会重新思考，不如将其提炼出来，总结一下。</p>
<p>下面笔者将为大家演示一下，将一个多维数组拍平成一个一维数组的两种方法，算是抛砖引玉，大家有更好的方法可以在留言区发表。</p>
<p>首先是第一种方法，闭包+递归处理，代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, [<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, [<span class="number">5</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]],[<span class="number">333</span>, <span class="number">4444</span>]];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">product</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 1、创建一个空数组,</span></span><br><span class="line">    <span class="keyword">var</span> newarr = [];</span><br><span class="line">    <span class="comment">///2、并且返回一个函数,函数参数为要拍平的数组</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">flatten</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 3、循环数组，判断每一项,不为输的话将其塞入newarr</span></span><br><span class="line">        <span class="comment">// 若为数组,递归调用 faltten,并将结果与newarr合并</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> t <span class="keyword">of</span> arr) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(t)) &#123;</span><br><span class="line">                newarr.push(t);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                newarr.concat(flatten(t))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newarr</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> flatten = product();</span><br><span class="line"><span class="built_in">console</span>.log(flatten(arr))</span><br></pre></td></tr></table></figure></p>
<p>执行结果为：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">333</span>, <span class="number">4444</span>]</span><br></pre></td></tr></table></figure></p>
<p>上面这这种方法比较中规中矩，代码详解见注释，下面这种方法运用到了javascript语言的一些新特性，代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, [<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, [<span class="number">5</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]], [<span class="number">333</span>, <span class="number">4444</span>] ];</span><br><span class="line">functionflatten(arr)&#123;</span><br><span class="line">  <span class="keyword">return</span>  arr.reduce(<span class="function"><span class="keyword">function</span>(<span class="params">pre,cur</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">Array</span>.isArray(cur))&#123;</span><br><span class="line">            <span class="keyword">return</span> [...pre,cur];</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> [...pre,...flatten(cur)]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,[])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(flatten(arr))</span><br></pre></td></tr></table></figure></p>
<p>上面代码中用了ES6的一个新特性扩展云算法 “…”，“[…abc,…fff]”其作用相当于abc.concat(fff),这种用法更加直观明了，还有就是运用了reduce方法。reduce是javascript语言中数组的一个方法。</p>
<p>数组调用recduce方法时，可以传递两个参数，第一个参数为回调函数，第二个参数为一个初始值。回调函数中需要传递两个参数，第一个参数为每次执行函数的返回值，第二个参数为当前索引对应数组的值。reduce的第二个参数是可以省略的，省略的话，回调函数第一次调用的参数为数组的第一项和第二项的值，如果没有省略，回调函数的第一个参数就是这个初始值。上面的例子，reduce的第二个参数设置了一个空数组。</p>
<p>相比来说第一种比较好理解，第二种的难点在于对reduce函数的运用和理解。</p>
<p>第三种比较粗暴<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, [<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, [<span class="number">5</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]],[<span class="number">333</span>, <span class="number">4444</span>]];</span><br><span class="line"> </span><br><span class="line">arr.join(<span class="string">","</span>).split(<span class="string">","</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//["1", "2", "3", "3", "3", "3", "5", "4", "5", "6", "6", "7", "8", "333", "4444"]</span></span><br></pre></td></tr></table></figure></p>
<h2 id="页面返回要刷新"><a href="#页面返回要刷新" class="headerlink" title="页面返回要刷新"></a>页面返回要刷新</h2><p><strong> 之前在项目中使用pageshow，发现页面返回的时候persisted依然为false，这时候只好找其他方案解决。</strong><br>这时候发现有一个window.performance对象，performance.navigation.type是一个无符号短整型</p>
<ul>
<li>TYPE_NAVIGATE (0)：<br>当前页面是通过点击链接，书签和表单提交，或者脚本操作，或者在url中直接输入地址，type值为0</li>
<li>TYPE_RELOAD (1)<br>点击刷新页面按钮或者通过Location.reload()方法显示的页面，type值为1</li>
<li>TYPE_BACK_FORWARD (2)<br>页面通过历史记录和前进后退访问时。type值为2</li>
<li>TYPE_RESERVED (255)<br>任何其他方式，type值为255</li>
</ul>
<p>这真是我们需要的部分，于是可以预见，解决方案如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'pageshow'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (e.persisted || (<span class="built_in">window</span>.performance &amp;&amp; </span><br><span class="line">    <span class="built_in">window</span>.performance.navigation.type == <span class="number">2</span>)) &#123;</span><br><span class="line">    location.reload()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="literal">false</span>)</span><br></pre></td></tr></table></figure></p>
<h2 id="两个鲜有人知的-Vuex-技巧"><a href="#两个鲜有人知的-Vuex-技巧" class="headerlink" title="两个鲜有人知的 Vuex 技巧"></a>两个鲜有人知的 Vuex 技巧</h2><p>当在我们 Vue.js 的组件中使用了 Vuex，除了映射功能的函数之外，我们好像忘记了它所暴露出来的其他有用的 API。</p>
<p>我们一起来看看可以利用它来干些什么。首先，还是先来创建一个基本的 store：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    count: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  getters: &#123;</span><br><span class="line">    getCountPlusOne: <span class="function"><span class="params">state</span> =&gt;</span> state.count + <span class="number">1</span></span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    increment(state) &#123;</span><br><span class="line">      state.count++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="Watch-方法"><a href="#Watch-方法" class="headerlink" title="Watch 方法"></a>Watch 方法</h3><p><code>watch</code> 是将 Vuex 与其他外部代码整合的最有用的方法，可以在你的 <code>awesomeService</code> 或者是在 <code>catchAllAuthUtils</code> 等等类似的服务中使用。</p>
<p>使用示例：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> unsubscribe = store.watch(</span><br><span class="line">  (state, getters) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> [state.count, getters.getCountPlusOne];</span><br><span class="line">  &#125;,</span><br><span class="line">  watched =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Count is:"</span>, watched[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Count plus one is:"</span>, watched[<span class="number">1</span>]);</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;&#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// To unsubscribe:</span></span><br><span class="line">unsubscribe();</span><br></pre></td></tr></table></figure></p>
<p>我们所做的就是在调用 vuex 的实例方法 <code>watch</code> 时，传入两个函数作为实参，第一个函数实参返回我们想要在 state 与/或 getters 上监听的属性；第二个函数实参是当属性值 <code>state.count</code> 或 <code>getters.getCountPlusOne</code> 有改变时，调用的回调函数。</p>
<p>这是用来结合 Vuex 与 react 或者 angular 甚至是 JQuery 代码时，非常有用的技巧。</p>
<p>可以在这个 <a href="https://codesandbox.io/s/vm6r05qjq0" target="_blank" rel="noopener">CodeSandbox</a> 上查看例子。</p>
<h3 id="SubscribeAction-方法"><a href="#SubscribeAction-方法" class="headerlink" title="SubscribeAction 方法"></a>SubscribeAction 方法</h3><p>有时候，与其监听 store 中的一个属性改变，不如使用 <code>subscribeAction</code> 方法订阅一个特定的 action，比如像 <code>login</code> 和 <code>logout</code> 之类的异步请求，这也是更有用的方案。</p>
<p>调用监听函数，在每一个 action 分发的时候调用指定的回调函数，并在其中调用自定义代码。</p>
<p>我们在每一个 action 的分发前以及完成后，来分别开始和停止全局的 spinner。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> unsubscribe = store.subscribeAction(&#123;</span><br><span class="line">  before: <span class="function">(<span class="params">action, state</span>) =&gt;</span> &#123;</span><br><span class="line">    startBigLoadingSpinner();</span><br><span class="line">  &#125;,</span><br><span class="line">  after: <span class="function">(<span class="params">action, state</span>) =&gt;</span> &#123;</span><br><span class="line">    stoptBigLoadingSpinner();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// To unsubscribe:</span></span><br><span class="line">unsubscribe();</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/03/Vue组件通信方式全面详解/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/03/Vue组件通信方式全面详解/" itemprop="url">Vue组件通信方式全面详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-03T15:22:59+08:00">
                2019-02-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>众所周知，Vue 主要思想之一就是组件式开发。因此，在实际的项目开发中，肯定会以组件的开发模式进行。形如页面和页面之间需要通信一样，Vue 组件和组件之间肯定也需要互通有无、共享状态。接下来，我们就悉数给大家展示所有 Vue 组件之间的通信方式。</p>
<h2 id="组件关系"><a href="#组件关系" class="headerlink" title="组件关系"></a>组件关系</h2><p><img src="/2019/02/03/Vue组件通信方式全面详解/1.png" alt="Vue 组件通信.png"></p>
<p>上面展示的图片可以引入所有 Vue 组件的关系形式：</p>
<ul>
<li>A 组件和 B 组件、B 组件和 C 组件、B 组件和 D 组件形成了父子关系</li>
<li>C 组件和 D 组件形成了兄弟关系</li>
<li>A 组件和 C 组件、A 组件和 D 组件形成了隔代关系（其中的层级可能是多级，即隔多代）</li>
</ul>
<h2 id="组件通信"><a href="#组件通信" class="headerlink" title="组件通信"></a>组件通信</h2><p>这么多的组件关系，那么组件和组件之间又有哪些通信的方式呢？各种方式的区别又是什么？适用场景又是什么呢？带着问题继续往下看吧！</p>
<h3 id="props-和-emit"><a href="#props-和-emit" class="headerlink" title="props 和 $emit"></a><code>props</code> 和 <code>$emit</code></h3><p>用过 Vue 技术栈开发项目过的开发者对这样一个组合肯定不会陌生，这种组件通信的方式是我们运用的非常多的一种。props 以单向数据流的形式可以很好的完成父子组件的通信。</p>
<p>所谓单向数据流：就是数据只能通过 props 由父组件流向子组件，而子组件并不能通过修改 props 传过来的数据修改父组件的相应状态。至于为什么这样做，Vue 官网做出了解释：</p>
<p><strong>所有的 prop 都使得其父子 prop 之间形成了一个<code>单向下行绑定</code>：父级 prop 的更新会向下流动到子组件中，但是反过来则不行。这样会防止从子组件意外改变父级组件的状态，从而导致你的应用的数据流向难以理解。</strong></p>
<p><strong>额外的，每次父级组件发生更新时，子组件中所有的 prop 都将会刷新为最新的值。这意味着你不应该在一个子组件内部改变 prop。如果你这样做了，Vue 会在浏览器的控制台中发出警告。</strong></p>
<p>正因为这个特性，于是就有了对应的 <code>$emit</code>。<code>$emit</code> 用来触发当前实例上的事件。对此，我们可以在父组件自定义一个处理接受变化状态的逻辑，然后在子组件中如若相关的状态改变时，就触发父组件的逻辑处理事件。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 父组件</span></span><br><span class="line">Vue.component(<span class="string">'parent'</span>, &#123;</span><br><span class="line">  template:<span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;this is parent component!&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;child :message="message" v-on:getChildData="getChildData"&gt;&lt;/child&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      message: <span class="string">'hello'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods:&#123;</span><br><span class="line">    <span class="comment">// 执行子组件触发的事件</span></span><br><span class="line">    getChildData(val) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(val);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子组件</span></span><br><span class="line">Vue.component(<span class="string">'child'</span>, &#123;</span><br><span class="line">  template:<span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;input type="text" v-model="myMessage" @input="passData(myMessage)"&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 得到父组件传递过来的数据</span></span><br><span class="line"><span class="comment">   * 这里的定义最好是写成数据校验的形式，免得得到的数据是我们意料之外的</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * props: &#123;</span></span><br><span class="line"><span class="comment">   *   message: &#123;</span></span><br><span class="line"><span class="comment">   *     type: String,</span></span><br><span class="line"><span class="comment">   *     default: ''</span></span><br><span class="line"><span class="comment">   *   &#125;</span></span><br><span class="line"><span class="comment">   * &#125;</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  props:[<span class="string">'message'</span>], </span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// 这里是必要的，因为你不能直接修改 props 的值</span></span><br><span class="line">      myMessage: <span class="keyword">this</span>.message</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods:&#123;</span><br><span class="line">    passData(val) &#123;</span><br><span class="line">      <span class="comment">// 数据状态变化时触发父组件中的事件this.$emit('getChildData', val);</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">    </span><br><span class="line"><span class="keyword">var</span> app=<span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;parent /&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>在上面的例子中，有父组件 parent 和子组件 child。</p>
<ul>
<li>父组件传递了 message 数据给子组件，并且通过v-on绑定了一个 getChildData 事件来监听子组件的触发事件；</li>
<li>子组件通过 props 得到相关的 message 数据，然后将数据缓存在 data 里面，最后当属性数据值发生变化时，通过 this.$emit 触发了父组件注册的 getChildData 事件处理数据逻辑。</li>
</ul>
<h3 id="attrs-和-listeners"><a href="#attrs-和-listeners" class="headerlink" title="$attrs 和 $listeners"></a><code>$attrs</code> 和 <code>$listeners</code></h3><p>上面这种组件通信的方式只适合直接的父子组件，也就是如果父组件A下面有子组件B，组件B下面有组件C，这时如果组件A直接想传递数据给组件C那就行不通了！ 只能是组件A通过 props 将数据传给组件B，然后组件B获取到组件A 传递过来的数据后再通过 props 将数据传给组件C。当然这种方式是非常复杂的，无关组件中的逻辑业务一种增多了，代码维护也没变得困难，再加上如果嵌套的层级越多逻辑也复杂，无关代码越多！</p>
<p>针对这样一个问题，<code>Vue 2.4</code> 提供了<code>$attrs</code> 和 <code>$listeners</code> 来实现能够直接让组件A传递消息给组件C。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 组件A</span></span><br><span class="line">Vue.component(<span class="string">'A'</span>, &#123;</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;this is parent component!&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;B :messagec="messagec" :message="message" v-on:getCData="getCData" v-on:getChildData="getChildData(message)"&gt;&lt;/B&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      message: <span class="string">'hello'</span>,</span><br><span class="line">      messagec: <span class="string">'hello c'</span><span class="comment">//传递给c组件的数据</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    <span class="comment">// 执行B子组件触发的事件</span></span><br><span class="line">    getChildData(val) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`这是来自B组件的数据：<span class="subst">$&#123;val&#125;</span>`</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行C子组件触发的事件</span></span><br><span class="line">    getCData(val) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`这是来自C组件的数据：<span class="subst">$&#123;val&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 组件B</span></span><br><span class="line">Vue.component(<span class="string">'B'</span>, &#123;</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;input type="text" v-model="mymessage" @input="passData(mymessage)"&gt; </span></span><br><span class="line"><span class="string">      &lt;!-- C组件中能直接触发 getCData 的原因在于：B组件调用 C组件时，使用 v-on 绑定了 $listeners 属性 --&gt;</span></span><br><span class="line"><span class="string">      &lt;!-- 通过v-bind 绑定 $attrs 属性，C组件可以直接获取到 A组件中传递下来的 props（除了 B组件中 props声明的） --&gt;</span></span><br><span class="line"><span class="string">      &lt;C v-bind="$attrs" v-on="$listeners"&gt;&lt;/C&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 得到父组件传递过来的数据</span></span><br><span class="line"><span class="comment">   * 这里的定义最好是写成数据校验的形式，免得得到的数据是我们意料之外的</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * props: &#123;</span></span><br><span class="line"><span class="comment">   *   message: &#123;</span></span><br><span class="line"><span class="comment">   *     type: String,</span></span><br><span class="line"><span class="comment">   *     default: ''</span></span><br><span class="line"><span class="comment">   *   &#125;</span></span><br><span class="line"><span class="comment">   * &#125;</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  props: [<span class="string">'message'</span>],</span><br><span class="line">  data()&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      mymessage: <span class="keyword">this</span>.message</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    passData(val)&#123;</span><br><span class="line">      <span class="comment">//触发父组件中的事件this.$emit('getChildData', val)</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 组件C</span></span><br><span class="line">Vue.component(<span class="string">'C'</span>, &#123;</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;input type="text" v-model="$attrs.messagec" @input="passCData($attrs.messagec)"&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    passCData(val) &#123;</span><br><span class="line">      <span class="comment">// 触发父组件A中的事件this.$emit('getCData',val)</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">    </span><br><span class="line"><span class="keyword">var</span> app=<span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el:<span class="string">'#app'</span>,</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;A /&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>在上面的例子中，我们定义了 A，B，C 三个组件，其中组件B 是组件 A 的子组件，组件C 是组件B 的子组件。</p>
<ul>
<li>在组件 A 里面为组件 B 和组件 C 分别定义了一个属性值（message，messagec）和监听事件（getChildData，getCData），并将这些通过 props 传递给了组件 A 的直接子组件 B；</li>
<li>在组件 B 中通过 props 只获取了与自身直接相关的属性（message），并将属性值缓存在了 data 中，以便后续的变化监听处理，然后当属性值变化时触发父组件 A 定义的数据逻辑处理事件（getChildData）。关于组件 B 的直接子组件 C，传递了属性 <code>$attrs</code> 和绑定了事件 <code>$listeners</code>；</li>
<li>在组件 C 中直接在 v-model 上绑定了 <code>$attrs</code> 属性，通过 v-on 绑定了 <code>$listeners</code>；</li>
</ul>
<p>最后就将 <code>$attrs</code> 和 <code>$listeners</code> 单独拿出来说说吧！</p>
<ul>
<li><p><code>$attrs</code>：包含了父作用域中不被 prop 所识别 (且获取) 的特性绑定 (<code>class</code> 和 <code>style</code> 除外)。当一个组件没有声明任何 prop 时，这里会包含所有父作用域的绑定属性 (class和 <code>style</code> 除外)，并且可以通过 <code>v-bind=&quot;$attrs&quot;</code> 传入内部组件。</p>
</li>
<li><p><code>$listeners</code>：包含了父作用域中的 (不含 <code>.native</code> 修饰器的) <code>v-on</code> 事件监听器。它可以通过 <code>v-on=&quot;$listeners&quot;</code> 传入内部组件。</p>
</li>
</ul>
<h3 id="中央事件总线-EventBus"><a href="#中央事件总线-EventBus" class="headerlink" title="中央事件总线 EventBus"></a>中央事件总线 EventBus</h3><p>对于父子组件之间的通信，上面的两种方式是完全可以实现的，但是对于两个组件不是父子关系，那么又该如何实现通信呢？在项目规模不大的情况下，完全可以使用中央事件总线 <code>EventBus</code> 的方式。如果你的项目规模是大中型的，那你可以使用我们后面即将介绍的 <a href="https://link.juejin.im?target=https%3A%2F%2Fwww.yuque.com%2Flittlelane%2Fvue%2Fkllzcm%231765f2e8" target="_blank" rel="noopener">Vuex 状态管理</a>。</p>
<p><code>EventBus</code> 通过新建一个 <code>Vue</code> 事件 <code>bus</code> 对象，然后通过 <code>bus.$emit</code> 触发事件，<code>bus.$on</code> 监听触发的事件。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 组件 A</span></span><br><span class="line">Vue.component(<span class="string">'A'</span>, &#123;</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;this is A component!&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;input type="text" v-model="mymessage" @input="passData(mymessage)"&gt; </span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      mymessage: <span class="string">'hello brother1'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    passData(val) &#123;</span><br><span class="line">      <span class="comment">//触发全局事件globalEventthis.$EventBus.$emit('globalEvent', val)</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 组件 B</span></span><br><span class="line">Vue.component(<span class="string">'B'</span>, &#123;</span><br><span class="line">  template:<span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;this is B component!&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;组件A 传递过来的数据：&#123;&#123;brothermessage&#125;&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      mymessage: <span class="string">'hello brother2'</span>,</span><br><span class="line">      brothermessage: <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    <span class="comment">//绑定全局事件globalEventthis.$EventBus.$on('globalEvent', (val) =&gt; &#123;</span></span><br><span class="line">      <span class="keyword">this</span>.brothermessage = val;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义中央事件总线const EventBus = new Vue();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将中央事件总线赋值到 Vue.prototype 上，这样所有组件都能访问到了</span></span><br><span class="line">Vue.prototype.$EventBus = EventBus;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;A /&gt;</span></span><br><span class="line"><span class="string">      &lt;B /&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>在上面的实例中，我们定义了组件 A 和组件 B，但是组件 A 和组件 B 之间没有任何的关系。</p>
<ul>
<li>1)、 首先我们通过 <code>new Vue()</code> 实例化了一个 Vue 的实例，也就是我们这里称呼的中央事件总线 EventBus ，然后将其赋值给了 <code>Vue.prototype.$EventBus</code>，使得所有的业务逻辑组件都能够访问到；</li>
<li>2)、 然后定义了组件 A，在组件 A 里面定义了一个处理的方法 passData，主要定义触发一个全局的 <code>globalEvent</code> 事件，并传递一个参数；</li>
<li>3). 最后定义了组件 B，在组件 B 里面的 <code>mounted</code> 生命周期监听了组件 A 里面定义的全局 <code>globalEvent</code> 事件，并在回调函数里面执行了一些逻辑处理。</li>
</ul>
<p>中央事件总线 <code>EventBus</code> 非常简单，就是任意组件和组件之间打交道，没有多余的业务逻辑，只需要在状态变化组件触发一个事件，然后在处理逻辑组件监听该事件就可以。该方法非常适合小型的项目！</p>
<h3 id="provide-和-inject"><a href="#provide-和-inject" class="headerlink" title="provide 和 inject"></a><code>provide</code> 和 <code>inject</code></h3><p>熟悉 React 开发的同学对 <code>Context API</code> 肯定不会陌生吧！在 Vue 中也提供了类似的 API 用于组件之间的通信。</p>
<p>在父组件中通过 <code>provider</code> 来提供属性，然后在子组件中通过 inject 来注入变量。不论子组件有多深，只要调用了 <code>inject</code> 那么就可以注入在 provider 中提供的数据，而不是局限于只能从当前父组件的 prop 属性来获取数据，只要在父组件的生命周期内，子组件都可以调用。这和 React 中的 <code>Context API</code> 有没有很相似！<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义 parent 组件</span></span><br><span class="line">Vue.component(<span class="string">'parent'</span>, &#123;</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;this is parent component!&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;child&gt;&lt;/child&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  provide: &#123;</span><br><span class="line">    <span class="keyword">for</span>:<span class="string">'test'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      message: <span class="string">'hello'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 child 组件</span></span><br><span class="line">Vue.component(<span class="string">'child'</span>, &#123;</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;input type="tet" v-model="mymessage"&gt; </span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  inject: [<span class="string">'for'</span>],	<span class="comment">// 得到父组件传递过来的数据</span></span><br><span class="line">  data()&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      mymessage: <span class="keyword">this</span>.for</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;parent /&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>在上面的实例中，我们定义了组件 <code>parent</code> 和组件 <code>child</code>，组件 <code>parent</code> 和组件 <code>child</code> 是父子关系。</p>
<ul>
<li>1)、 在 <code>parent</code> 组件中，通过 <code>provide</code> 属性，以对象的形式向子孙组件暴露了一些属性</li>
<li>2)、 在 <code>child</code> 组件中，通过 <code>inject</code> 属性注入了 <code>parent</code> 组件提供的数据，实际这些通过 <code>inject</code> 注入的属性是挂载到 Vue 实例上的，所以在组件内部可以通过 this 来访问。</li>
</ul>
<blockquote>
<p>⚠️ 注意：官网文档提及 provide 和 inject 主要为高阶插件/组件库提供用例，并不推荐直接用于应用程序代码中。</p>
</blockquote>
<p>关于 <code>provide</code> 和 <code>inject</code> 这对属性的更多具体用法可以参照<a href="https://link.juejin.im?target=https%3A%2F%2Fcn.vuejs.org%2Fv2%2Fapi%2F%3F%23provide-inject" target="_blank" rel="noopener">官网的文档</a>。</p>
<h3 id="v-model"><a href="#v-model" class="headerlink" title="v-model"></a><code>v-model</code></h3><p>这种方式和前面讲到的 props 有点类型，但是既然单独提出来说了，那肯定也有其独特之处！不管了，先上代码吧！<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义 parent 组件</span></span><br><span class="line">Vue.component(<span class="string">'parent'</span>, &#123;</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;this is parent component!&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;&#123;&#123;message&#125;&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;child v-model="message"&gt;&lt;/child&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      message: <span class="string">'hello'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 child 组件</span></span><br><span class="line">Vue.component(<span class="string">'child'</span>, &#123;</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;input type="text" v-model="mymessage" @change="changeValue"&gt; </span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  props: &#123;</span><br><span class="line">    value: <span class="built_in">String</span>, <span class="comment">// v-model 会自动传递一个字段为 value 的 props 属性</span></span><br><span class="line">  &#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      mymessage: <span class="keyword">this</span>.value</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    changeValue() &#123;</span><br><span class="line">      <span class="keyword">this</span>.$emit(<span class="string">'input'</span>, <span class="keyword">this</span>.mymessage); <span class="comment">//通过如此调用可以改变父组件上 v-model 绑定的值</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">     &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;parent /&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>说到 v-model 这个指定，大家肯定会想到双向数据绑定，如 input 输入值，下面的显示就是实时的根据输入的不同而显示相应的内容。刚开始学习 Vue 的时候有没有觉得很神奇，不管你有没有，反正我有过这种感觉！</p>
<p>关于详细的 v-model 用法和自定义组件 v-model 的实现，可以到<a href="https://link.juejin.im?target=https%3A%2F%2Fwww.yuque.com%2Flittlelane%2Fvue%2Fiqevua" target="_blank" rel="noopener">这里</a>查看！这里我们主要讲解 v-model 是如何实现父子组件通信的。</p>
<p>在上面的实例代码中，我们定义了 parent 和 child 两个组件，这两个组件是父子关系，v-model 也只能实现父子组件之间的通信。</p>
<ul>
<li>1)、 在 parent 组件中，我们给自定义的 child 组件实现了 v-model 绑定了 message 属性。此时相当于给 child 组件传递了 value 属性和绑定了 input 事件。</li>
<li>2)、 顺理成章，在定义的 child 组件中，可以通过 props 获取 value 属性，根据 props 单向数据流的原则，又将 value 缓存在了 data 里面的 mymessage 上，再在 input 上通过 <code>v-model</code> 绑定了 <code>mymessage</code> 属性和一个 <code>change</code> 事件。当 input 值变化时，就会触发 change 事件，处理 parent 组件通过 <code>v-model</code> 给 child 组件绑定的 <code>input</code> 事件，触发 <code>parent</code> 组件中 <code>message</code> 属性值的变化，完成 <code>child</code> 子组件改变 parent 组件的属性值。</li>
</ul>
<p>这里主要是 <code>v-model</code> 的实现原理要着重了解一下！这种方式的用处适合于将展示组件和业务逻辑组件分离。</p>
<h3 id="parent-和-children"><a href="#parent-和-children" class="headerlink" title="$parent 和 $children"></a><code>$parent</code> 和 <code>$children</code></h3><p>这里要说的这种方式就比较直观了，直接操作父子组件的实例。<code>$parent</code> 就是父组件的实例对象，而 <code>$children</code> 就是当前实例的直接子组件实例了，不过这个属性值是数组类型的，且并不保证顺序，也不是响应式的。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义 parent 组件</span></span><br><span class="line">Vue.component(<span class="string">'parent'</span>, &#123;</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;p&gt;this is parent component!&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;button @click="changeChildValue"&gt;test&lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;child /&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      message: <span class="string">'hello'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    changeChildValue()&#123;</span><br><span class="line">      <span class="keyword">this</span>.$children[<span class="number">0</span>].mymessage = <span class="string">'hello'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 child 组件</span></span><br><span class="line">Vue.component(<span class="string">'child'</span>, &#123;</span><br><span class="line">  template:<span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;input type="text" v-model="mymessage" @change="changeValue" /&gt; </span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      mymessage: <span class="keyword">this</span>.$parent.message</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    changeValue()&#123;</span><br><span class="line">      <span class="keyword">this</span>.$parent.message = <span class="keyword">this</span>.mymessage;<span class="comment">//通过如此调用可以改变父组件的值</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">    </span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;parent /&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>在上面实例代码中，分别定义了 parent 和 child 组件，这两个组件是直接的父子关系。两个组件分别在内部定义了自己的属性。在 parent 组件中，直接通过 <code>this.$children[0].mymessage = &#39;hello&#39;;</code> 给 <code>child</code> 组件内的 <code>mymessage</code> 属性赋值，而在 child 子组件中，同样也是直接通过<code>this.$parent.message</code> 给 <code>parent</code> 组件中的 <code>message</code> 赋值，形成了父子组件通信。</p>
<p>关于 <a href="https://link.juejin.im?target=https%3A%2F%2Fcn.vuejs.org%2Fv2%2Fapi%2F%23vm-parent" target="_blank" rel="noopener"><code>$parent</code></a> 和 <a href="https://link.juejin.im?target=https%3A%2F%2Fcn.vuejs.org%2Fv2%2Fapi%2F%23vm-children" target="_blank" rel="noopener"><code>$children</code></a> 这对属性的详细介绍可以查询官网文档！</p>
<h3 id="boradcast-和-dispatch"><a href="#boradcast-和-dispatch" class="headerlink" title="$boradcast 和 $dispatch"></a><code>$boradcast</code> 和 <code>$dispatch</code></h3><p>这也是一对成对出现的方法，不过只是在 <code>Vue1.0</code> 中提供了，而 <code>Vue2.0</code> 被废弃了，但是还是有很多开源软件都自己封装了这种组件通信的方式，比如 <a href="https://link.juejin.im?target=http%3A%2F%2Fmint-ui.github.io%2F%23!%2Fzh-cn" target="_blank" rel="noopener">Mint UI</a>、<a href="https://link.juejin.im?target=http%3A%2F%2Felement-cn.eleme.io%2F%23%2Fzh-CN" target="_blank" rel="noopener">Element UI</a> 和 <a href="https://link.juejin.im?target=https%3A%2F%2Fwww.iviewui.com%2F" target="_blank" rel="noopener">iView</a> 等。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// broadcast 方法的主逻辑处理方法functionbroadcast(componentName, eventName, params) &#123;</span></span><br><span class="line">  <span class="keyword">this</span>.$children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> name = child.$options.componentName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (name === componentName) &#123;</span><br><span class="line">      child.$emit.apply(child, [eventName].concat(params));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      broadcast.apply(child, [componentName, eventName].concat(params));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">exportdefault &#123;</span><br><span class="line">  methods: &#123;</span><br><span class="line">    <span class="comment">// 定义 dispatch 方法</span></span><br><span class="line">    dispatch(componentName, eventName, params) &#123;</span><br><span class="line">      <span class="keyword">let</span> parent = <span class="keyword">this</span>.$parent;</span><br><span class="line">      <span class="keyword">let</span> name = parent.$options.componentName;</span><br><span class="line">      <span class="keyword">while</span> (parent &amp;&amp; (!name || name !== componentName)) &#123;</span><br><span class="line">        parent = parent.$parent;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parent) &#123;</span><br><span class="line">          name = parent.$options.componentName;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (parent) &#123;</span><br><span class="line">        parent.$emit.apply(parent, [eventName].concat(params));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 定义 broadcast 方法</span></span><br><span class="line">    broadcast(componentName, eventName, params) &#123;</span><br><span class="line">      broadcast.call(<span class="keyword">this</span>, componentName, eventName, params);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>上面所示的代码，一般都作为一个 <code>mixins</code> 去混入使用, <code>broadcast</code> 是向特定的父组件触发事件，<code>dispatch</code> 是向特定的子组件触发事件，本质上这种方式还是 <code>on</code> 和 <code>emit</code> 的封装，在一些基础组件中都很实用。</p>
<p>因为在 <code>Vue 2.0</code> 这个 API 已经废弃，那我们在这里也就提一下，如果想详细了解 <code>Vue 1.0</code> 和其他基于 Vue 的 UI 框架关于这个 API 的实现，可以点击查看<a href="https://link.juejin.im?target=https%3A%2F%2Fwww.yuque.com%2Flittlelane%2Fvue%2Fusdfkw" target="_blank" rel="noopener">这篇文章</a>！</p>
<h3 id="Vuex-状态管理"><a href="#Vuex-状态管理" class="headerlink" title="Vuex 状态管理"></a>Vuex 状态管理</h3><p>Vuex 是状态管理工具，实现了项目状态的集中式管理。工具的实现借鉴了 <a href="https://link.juejin.im?target=https%3A%2F%2Ffacebook.github.io%2Fflux%2Fdocs%2Foverview.html" target="_blank" rel="noopener">Flux</a>、<a href="https://link.juejin.im?target=http%3A%2F%2Fredux.js.org%2F" target="_blank" rel="noopener">Redux</a>、和 <a href="https://link.juejin.im?target=https%3A%2F%2Fguide.elm-lang.org%2Farchitecture%2F" target="_blank" rel="noopener">The Elm Architecture</a> 的模式和概念。当然与其他模式不同的是，Vuex 是专门为 Vue.js 设计的状态管理库，以利用 Vue.js 的细粒度数据响应机制来进行高效的状态更新。详细的关于 Vuex 的介绍，你既可以去查看<a href="https://link.juejin.im?target=https%3A%2F%2Fvuex.vuejs.org%2Fzh%2F" target="_blank" rel="noopener">官网文档</a>，也可以查看本专栏关于 Vuex 一系列的介绍。</p>
<h3 id="refs"><a href="#refs" class="headerlink" title="refs"></a>refs</h3><p>通过this.$refs.XXX 拿到组件上面的所有方法属性</p>
<h3 id="vue-sync修饰符"><a href="#vue-sync修饰符" class="headerlink" title="vue .sync修饰符"></a>vue .sync修饰符</h3><p>在说vue 修饰符sync前，我们先看下官方文档：vue .sync 修饰符，里面说vue .sync 修饰符以前存在于vue1.0版本里，但是在在 2.0 中移除了 .sync 。但是在 2.0 发布之后的实际应用中，我们发现 .sync 还是有其适用之处，比如在开发可复用的组件库时。我们需要做的只是让子组件改变父组件状态的代码更容易被区分。从 2.3.0 起我们重新引入了 .sync 修饰符，但是这次它只是作为一个编译时的语法糖存在。它会被扩展为一个自动更新父组件属性的 v-on 监听器。<br>示例代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;comp :foo.sync=&quot;bar&quot;&gt;&lt;/comp&gt;</span><br></pre></td></tr></table></figure></p>
<p>会被扩展为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;comp :foo=&quot;bar&quot; @update:foo=&quot;val =&gt; bar = val&quot;&gt;&lt;/comp&gt;</span><br></pre></td></tr></table></figure></p>
<p>当子组件需要更新 foo 的值时，它需要显式地触发一个更新事件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.$emit(&apos;update:foo&apos;, newValue)</span><br></pre></td></tr></table></figure></p>
<p>vue 修饰符sync的功能是：当一个子组件改变了一个 prop 的值时，这个变化也会同步到父组件中所绑定。如果我们不用.sync，我们想做上面的那个弹窗功能，我们也可以props传初始值，然后事件监听，实现起来也不算复杂。这里用sync实现，只是给大家提供一个思路，让其明白他的实现原理，可能有其它复杂的功能适用sync。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>写到这里，Vue 中关于组件通信的所有方式就介绍完了，是不是感觉还是颇丰的呢？其实还有另外的两种方式可以实现组件的通信，一是通过 <a href="https://link.juejin.im?target=https%3A%2F%2Frouter.vuejs.org%2Fzh%2F" target="_blank" rel="noopener">Vue Router</a> 通信，二是通过浏览器本地存储实现组件通信。关于这两种方式，这里我就不讲了，当然我会在本专栏中单独开篇讲解的，希望大家有兴趣就去看看！</p>
<p>准确来说本文详细讲解了实现 Vue 通信的六种方式，每种方式都有其特点。在实际的项目，大家可以酌情的进行使用。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/25/async-await优雅的错误处理方法/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/25/async-await优雅的错误处理方法/" itemprop="url">async/await优雅的错误处理方法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-25T22:58:50+08:00">
                2019-01-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="async-await错误处理"><a href="#async-await错误处理" class="headerlink" title="async/await错误处理"></a>async/await错误处理</h3><p>一般情况下 async/await 在错误处理方面，主要使用 <code>try/catch</code>，像这样<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fetchData = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            resolve(<span class="string">'fetch data is me'</span>)</span><br><span class="line">        &#125;, <span class="number">1000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> fetchData()</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'data is -&gt;'</span>, data)</span><br><span class="line">    &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'err is -&gt;'</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure></p>
<p>这么看，感觉倒是没什么问题，如果是这样呢？有多个异步操作，需要对每个异步返回的 error 错误状态进行不同的处理，以下是示例代码<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fetchDataA = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            resolve(<span class="string">'fetch data is A'</span>)</span><br><span class="line">        &#125;, <span class="number">1000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fetchDataB = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            resolve(<span class="string">'fetch data is B'</span>)</span><br><span class="line">        &#125;, <span class="number">1000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fetchDataC = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            resolve(<span class="string">'fetch data is C'</span>)</span><br><span class="line">        &#125;, <span class="number">1000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> dataA = <span class="keyword">await</span> fetchDataA()</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'dataA is -&gt;'</span>, dataA)</span><br><span class="line">    &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'err is -&gt;'</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> dataB = <span class="keyword">await</span> fetchDataB()</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'dataB is -&gt;'</span>, dataB)</span><br><span class="line">    &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'err is -&gt;'</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> dataC = <span class="keyword">await</span> fetchDataC()</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'dataC is -&gt;'</span>, dataC)</span><br><span class="line">    &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'err is -&gt;'</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure></p>
<p>这样写代码里充斥着 <code>try/catch</code>，有代码洁癖的你能忍受的了吗？这时可能会想到只用一个 <code>try/catch</code>。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ... 这里 fetch 函数省略</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> dataA = <span class="keyword">await</span> fetchDataA()</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'dataA is -&gt;'</span>, dataA)</span><br><span class="line">        <span class="keyword">const</span> dataB = <span class="keyword">await</span> fetchDataB()</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'dataB is -&gt;'</span>, dataB)</span><br><span class="line">        <span class="keyword">const</span> dataC = <span class="keyword">await</span> fetchDataC()</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'dataC is -&gt;'</span>, dataC)</span><br><span class="line">    &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'err is -&gt;'</span>, err)</span><br><span class="line">        <span class="comment">// 难道要定义 err 类型，然后判断吗？？/**</span></span><br><span class="line">         * <span class="keyword">if</span> (err.type === <span class="string">'dataA'</span>) &#123;</span><br><span class="line">         *  <span class="built_in">console</span>.log(<span class="string">'dataA err is'</span>, err)</span><br><span class="line">         * &#125;</span><br><span class="line">         * ......</span><br><span class="line">         * *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;)()</span></span><br></pre></td></tr></table></figure></p>
<p>如果是这样写只会增加编码的复杂度，而且要多写代码，这个时候就应该想想怎么优雅的解决，<code>async/await</code> 本质就是 <code>promise</code> 的语法糖，既然是 <code>promise</code> 那么就可以使用 <code>then</code> 函数了<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> fetchData = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                resolve(<span class="string">'fetch data is me'</span>)</span><br><span class="line">            &#125;, <span class="number">1000</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> fetchData().then(<span class="function"><span class="params">data</span> =&gt;</span> data ).catch(<span class="function"><span class="params">err</span> =&gt;</span> err)</span><br><span class="line">    <span class="built_in">console</span>.log(data)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure></p>
<p>在上面写法中，如果 fetchData 返回 resolve 正确结果时，data 是我们要的结果，如果是 reject 了，发生错误了，那么 data 是错误结果，这显然是行不通的，再对其完善。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> fetchData = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                resolve(<span class="string">'fetch data is me'</span>)</span><br><span class="line">            &#125;, <span class="number">1000</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> [err, data] = <span class="keyword">await</span> fetchData().then(<span class="function"><span class="params">data</span> =&gt;</span> [<span class="literal">null</span>, data] ).catch(<span class="function"><span class="params">err</span> =&gt;</span> [err, <span class="literal">null</span>])</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'err'</span>, err)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'data'</span>, data)</span><br><span class="line">    <span class="comment">// err null// data fetch data is me</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure></p>
<p>这样是不是好很多了呢，但是问题又来了，不能每个 await 都写这么长，写着也不方便也不优雅，再优化一下<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> fetchData = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                resolve(<span class="string">'fetch data is me'</span>)</span><br><span class="line">            &#125;, <span class="number">1000</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 抽离成公共方法</span></span><br><span class="line">    <span class="keyword">const</span> awaitWrap = <span class="function">(<span class="params">promise</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> promise</span><br><span class="line">            .then(<span class="function"><span class="params">data</span> =&gt;</span> [<span class="literal">null</span>, data])</span><br><span class="line">            .catch(<span class="function"><span class="params">err</span> =&gt;</span> [err, <span class="literal">null</span>])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> [err, data] = <span class="keyword">await</span> awaitWrap(fetchData())</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'err'</span>, err)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'data'</span>, data)</span><br><span class="line">    <span class="comment">// err null// data fetch data is me</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure></p>
<p>将对 <code>await</code> 处理的方法抽离成公共的方法，在使用 <code>await</code> 调用 <code>awaitWrap</code> 这样的方法是不是更优雅了呢。如果使用 typescript 实现大概是这个样子<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">functionawaitWrap&lt;T, U = any&gt;(promise: <span class="built_in">Promise</span>&lt;T&gt;): <span class="built_in">Promise</span>&lt;[U | <span class="literal">null</span>, T | <span class="literal">null</span>]&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> promise</span><br><span class="line">        .then&lt;[<span class="literal">null</span>, T]&gt;<span class="function">(<span class="params">(data: T</span>) =&gt;</span> [<span class="literal">null</span>, data])</span><br><span class="line">        .catch&lt;[U, <span class="literal">null</span>]&gt;(<span class="function"><span class="params">err</span> =&gt;</span> [err, <span class="literal">null</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Promise-prototype-finally"><a href="#Promise-prototype-finally" class="headerlink" title="Promise.prototype.finally"></a>Promise.prototype.finally</h3><p>ES2018另一振奋人心的特效是finally()方法。 之前有几个 JavaScript 库实现了类似的方法，并且它被证实是有用的。这促使 Ecma技术委员会正式将finally()添加到规范中。 使用该方法，开发者可无需理会 promise 命数如何，直接执行这个代码块中的代码。 我们来看一个简单的例子：<br><img src="/2019/01/25/async-await优雅的错误处理方法/1.webp" alt=""><br>finally() 方法可在操作完成后进行一些扫尾（clean up）工作，无论操作是否成功。 在此代码中，finally() 方法在数据获取处理后直接隐藏了加载 spinner。 无论 promise 完成与否，函数中的注册代码都会执行，开发者不必在 then() 和 catch() 方法中重复编写逻辑。使用promise.then(func, func)也可实现与promise.then(func, func) 同样的效果，但你必须在 fulfillment 句柄及 rejection 句柄中重复相同的代码，或者引入一个变量：<br><img src="/2019/01/25/async-await优雅的错误处理方法/2.webp" alt=""><br>与 then() 和 catch() 相同，finally() 方法总是返回一个 promise，因此你可以链接更多的方法。 一般来说，我们会将 finally() 作为最后一环。但某些情况，例如在创建 HTTP 请求时，在 finally() 之后链接另一个catch(),以处理请求中可能发生的错误是不错的实践。<br><img src="/2019/01/25/async-await优雅的错误处理方法/3.webp" alt=""></p>
<h3 id="ES7-Async-await"><a href="#ES7-Async-await" class="headerlink" title="ES7 Async / await"></a>ES7 Async / await</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">asyncTask</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> UserModel.findById(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(!user) <span class="keyword">return</span> cb(<span class="string">'No user found'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> savedTask = <span class="keyword">await</span> TaskModel(&#123;<span class="attr">userId</span>: user.id, <span class="attr">name</span>: <span class="string">'Demo Task'</span>&#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(user.notificationsEnabled) &#123;</span><br><span class="line">         <span class="keyword">await</span> NotificationService.sendNotification(user.id, <span class="string">'Task Created'</span>);  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(savedTask.assignedUser.id !== user.id) &#123;</span><br><span class="line">        <span class="keyword">await</span> NotificationService.sendNotification(savedTask.assignedUser.id, <span class="string">'Task was created for you'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cb(<span class="literal">null</span>, savedTask);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码看起来更清晰，<strong>但是，错误处理呢？</strong></p>
<p>在进行异步调用时，在执行promise（DB连接错误，db模型验证错误等等）时可能会发生某些事情。</p>
<p>由于异步函数正在等待Promise，因此当promise遇到错误时，它会抛出一个异常，该异常将在promise的catch方法中捕获。</p>
<p>在async / await函数中，通常使用<strong>try / catch</strong>块来捕获此类错误。</p>
<p>我不是来自一个打字的语言背景，所以try / catch为我添加了额外的代码，在我看来，看起来并不干净。我确定这是个人偏好的问题，但这是我的看法。</p>
<p>所以前面的代码看起来像这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">asyncTask</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="keyword">const</span> user = <span class="keyword">await</span> UserModel.findById(<span class="number">1</span>);</span><br><span class="line">       <span class="keyword">if</span>(!user) <span class="keyword">return</span> cb(<span class="string">'No user found'</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="keyword">return</span> cb(<span class="string">'Unexpected error occurred'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="keyword">const</span> savedTask = <span class="keyword">await</span> TaskModel(&#123;<span class="attr">userId</span>: user.id, <span class="attr">name</span>: <span class="string">'Demo Task'</span>&#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="keyword">return</span> cb(<span class="string">'Error occurred while saving task'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(user.notificationsEnabled) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> NotificationService.sendNotification(user.id, <span class="string">'Task Created'</span>);  </span><br><span class="line">        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">            <span class="keyword">return</span> cb(<span class="string">'Error while sending notification'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(savedTask.assignedUser.id !== user.id) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> NotificationService.sendNotification(savedTask.assignedUser.id, <span class="string">'Task was created for you'</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">            <span class="keyword">return</span> cb(<span class="string">'Error while sending notification'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cb(<span class="literal">null</span>, savedTask);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="一种不同的做事方式"><a href="#一种不同的做事方式" class="headerlink" title="一种不同的做事方式"></a>一种不同的做事方式</h3><p>最近我一直在使用<strong>go-lang</strong>进行编码，并且非常喜欢他们的解决方案，看起来像这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data, <span class="attr">err</span> := db.Query(<span class="string">"SELECT ..."</span>)</span><br><span class="line"><span class="keyword">if</span> err != nil &#123; <span class="keyword">return</span> err &#125;</span><br></pre></td></tr></table></figure>
<p>我认为它比使用try-catch块更清晰，并且代码更少，这使得它具有可读性和可维护性。</p>
<p>但是<strong>等待</strong>的问题是，如果没有为它提供try-catch块，它将默默地退出你的函数。除非提供catch子句，否则你无法控制它。</p>
<p>当我和我的好朋友Tomer Barnea坐下来并试图寻找更清洁的解决方案时，我们完成了下一个方法：</p>
<p>还记得<strong>await</strong>正在等待解决的承诺吗？</p>
<p>有了这些知识，我们可以使用小实用功能来帮助我们捕获这些错误：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// to.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">to</span>(<span class="params">promise</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> promise.then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> [<span class="literal">null</span>, data];</span><br><span class="line">   &#125;)</span><br><span class="line">   .catch(<span class="function"><span class="params">err</span> =&gt;</span> [err]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实用程序函数接收一个promise，然后使用返回数据作为第二项解析对数组的成功响应。并且从第一个接收到的错误。</p>
<p>然后我们可以使异步代码看起来像这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> to <span class="keyword">from</span> <span class="string">'./to.js'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">asyncTask</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">     <span class="keyword">let</span> err, user, savedTask;</span><br><span class="line"></span><br><span class="line">     [err, user] = <span class="keyword">await</span> to(UserModel.findById(<span class="number">1</span>));</span><br><span class="line">     <span class="keyword">if</span>(!user) <span class="keyword">throw</span> <span class="keyword">new</span> CustomerError(<span class="string">'No user found'</span>);</span><br><span class="line"></span><br><span class="line">     [err, savedTask] = <span class="keyword">await</span> to(TaskModel(&#123;<span class="attr">userId</span>: user.id, <span class="attr">name</span>: <span class="string">'Demo Task'</span>&#125;));</span><br><span class="line">     <span class="keyword">if</span>(err) <span class="keyword">throw</span> <span class="keyword">new</span> CustomError(<span class="string">'Error occurred while saving task'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(user.notificationsEnabled) &#123;</span><br><span class="line">       <span class="keyword">const</span> [err] = <span class="keyword">await</span> to(NotificationService.sendNotification(user.id, <span class="string">'Task Created'</span>));  </span><br><span class="line">       <span class="keyword">if</span> (err) <span class="built_in">console</span>.error(<span class="string">'Just log the error and continue flow'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的示例只是解决方案的一个简单用例，您可以在to.js方法中附加拦截器，该方法将接收原始错误对象，记录它或在传回之前执行您需要做的任何操作。</p>
<blockquote>
<p>这篇文章只是查看异步/等待错误处理的另一种方式。它不应该被用作你编写的每个async / await函数的goto，并且在很多情况下在顶部有一个catch会做得很好。有时我们不希望公开模型实现的错误对象，而是希望提供一个自定义错误对象来屏蔽底层的mongoose错误实现。</p>
</blockquote>
<h3 id="Github-Repo"><a href="#Github-Repo" class="headerlink" title=" Github Repo "></a><a href="https://github.com/scopsy/await-to-js" target="_blank" rel="noopener"><strong> Github Repo </strong></a></h3><p>我们为这个库创建了一个简单的NPM包，你可以使用它来安装它：</p>
<pre><code class="js">npm i <span class="keyword">await</span>-to-js
</code></pre>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/16/更优雅的方式处理数组/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/16/更优雅的方式处理数组/" itemprop="url">更优雅的方式处理数组</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-16T23:23:17+08:00">
                2019-01-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="使用Set处理数组去重和元素剔除问题"><a href="#使用Set处理数组去重和元素剔除问题" class="headerlink" title="使用Set处理数组去重和元素剔除问题"></a>使用<code>Set</code>处理数组去重和元素剔除问题</h3><p><code>Set</code>是es6新增的一种<strong>数据结构</strong>，它和数组非常相似，但是成员的值都是唯一的，没有重复的值。它提供了4个语义化的API：</p>
<ol>
<li><code>add(value)</code>：添加某个值，返回Set结构本身。</li>
<li><code>delete(value)</code>：删除某个值，返回一个布尔值，表示删除是否成功。</li>
<li><code>has(value)</code>：返回一个布尔值，表示该值是否为Set的成员。</li>
<li><code>clear()</code>：清除所有成员，没有返回值。</li>
</ol>
<blockquote>
<p>参考自@阮一峰 老师的<a href="https://link.juejin.im?target=http%3A%2F%2Fes6.ruanyifeng.com%2F%23docs%2Fset-map" target="_blank" rel="noopener">《ECMAScript 6 入门》</a></p>
</blockquote>
<p>那么我们可以用<code>Set</code>来干嘛呢？</p>
<p>第一个用法，数组去重。对于一个一维数组，我们可以先把它转化成<code>Set</code>，再配合<code>...</code>解构运算符重新转化为数组，达到去重的目的。请看例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const arr = [1, 1, 2, 2, 3, 4, 5, 5]</span><br><span class="line"></span><br><span class="line">const newArr = [...new Set(arr)]</span><br><span class="line"></span><br><span class="line">console.log(newArr)</span><br><span class="line"></span><br><span class="line">// [1, 2, 3, 4, 5]</span><br></pre></td></tr></table></figure></p>
<p>值得注意的是，这个方法不能对元素为“对象”的数组奏效：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const arr = [&#123; name: &apos;Alice&apos;, age: 12 &#125;, &#123; name: &apos;Alice&apos;, age: 12 &#125;, &#123; name: &apos;Bob&apos;, age: 13 &#125;]</span><br><span class="line"></span><br><span class="line">const newArr = [...new Set(arr)]</span><br><span class="line"></span><br><span class="line">console.log(newArr)</span><br><span class="line"></span><br><span class="line">// [&#123; name: &apos;Alice&apos;, age: 12 &#125;, &#123; name: &apos;Alice&apos;, age: 12 &#125;, &#123; name: &apos;Bob&apos;, age: 13 &#125;]</span><br></pre></td></tr></table></figure></p>
<p>这是因为<code>Set</code>判断元素是否重复的办法类似于<code>===</code>运算符，两个对象总是不相等的。</p>
<p>除了去重，<code>Set</code>提供的<code>delete()</code>方法也是非常实用。在以往的做法中，如果要删除数组中指定的元素，我们需要先获取该元素所在下标，然后通过<code>splice()</code>方法去删除对应下标的元素，在理解上容易引起混乱：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 我想删除数组当中值为2的元素const arr = [1, 2, 3]</span><br><span class="line">const index = arr.indexOf(2)</span><br><span class="line">if (index !== -1) &#123;</span><br><span class="line">    arr.splice(index, 1)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">console.log(arr)</span><br><span class="line"></span><br><span class="line">// [1, 3]</span><br></pre></td></tr></table></figure></p>
<p>使用<code>Set</code>就清晰多了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const arr = [1, 2, 3]</span><br><span class="line">const set = newSet(arr)</span><br><span class="line">set.delete(2)</span><br><span class="line">arr = [...set]</span><br><span class="line"></span><br><span class="line">console.log(arr)</span><br><span class="line"></span><br><span class="line">// [1, 3]</span><br></pre></td></tr></table></figure></p>
<h3 id="使用map-方法和对象解构语法提取字段"><a href="#使用map-方法和对象解构语法提取字段" class="headerlink" title="使用map()方法和对象解构语法提取字段"></a>使用<code>map()</code>方法和对象解构语法提取字段</h3><p>请求后台接口返回的数据中，很可能会遇到下面这种数据格式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">studentInfo = [</span><br><span class="line">  &#123; name: &apos;Alice&apos;, age: 18, no: 2 &#125;,</span><br><span class="line">  &#123; name: &apos;Bob&apos;, age: 16, no: 5 &#125;,</span><br><span class="line">  &#123; name: &apos;Candy&apos;, age: 17, no: 3 &#125;,</span><br><span class="line">  &#123; name: &apos;Den&apos;, age: 18, no: 4 &#125;,</span><br><span class="line">  &#123; name: &apos;Eve&apos;, age: 16, no: 1 &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>当我们要获取姓名列表、年龄列表和编号列表的时候，我们可以通过<code>map()</code>再配合对象的解构语法方便快捷地进行处理：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const nameList = studentInfo.map((&#123; name &#125;) =&gt; name)</span><br><span class="line">const ageList = studentInfo.map((&#123; age &#125;) =&gt; age)</span><br><span class="line">const noList = studentInfo.map((&#123; no &#125;) =&gt; no)</span><br><span class="line"></span><br><span class="line">// nameList: [ &apos;Alice&apos;, &apos;Bob&apos;, &apos;Candy&apos;, &apos;Den&apos;, &apos;Eve&apos; ]// ageList: [ 18, 16, 17, 18, 16 ]// noList: [ 2, 5, 3, 4, 1 ]</span><br></pre></td></tr></table></figure></p>
<h3 id="使用filter-方法和对象解构语法过滤数组"><a href="#使用filter-方法和对象解构语法过滤数组" class="headerlink" title="使用filter()方法和对象解构语法过滤数组"></a>使用<code>filter()</code>方法和对象解构语法过滤数组</h3><p>接上上面的例子，如果我想获取一个“年龄小于等于17岁”的新列表，应该怎么做呢？类似<code>map()</code>方法，我们可以用<code>filter()</code>方法进行过滤：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const newStudentInfo = studentInfo.filter((&#123; age &#125;) =&gt; &#123;</span><br><span class="line">  return age &lt;= 17</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">newStudentInfo: [</span><br><span class="line">  &#123; name: &apos;Bob&apos;, age: 16, no: 5 &#125;,</span><br><span class="line">  &#123; name: &apos;Candy&apos;, age: 17, no: 3 &#125;,</span><br><span class="line">  &#123; name: &apos;Eve&apos;, age: 16, no: 1 &#125;</span><br><span class="line">]</span><br><span class="line">*/</span><br></pre></td></tr></table></figure></p>
<h3 id="借助includes-方法求两个数组的差集"><a href="#借助includes-方法求两个数组的差集" class="headerlink" title="借助includes()方法求两个数组的差集"></a>借助<code>includes()</code>方法求两个数组的差集</h3><p>假设我们有以下两个数组：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var a = [1, 2, &#123;s:3&#125;, &#123;s:4&#125;, &#123;s:5&#125;]</span><br><span class="line">var b = [&#123;s:2&#125;, &#123;s:3&#125;, &#123;s:4&#125;, &apos;a&apos;]</span><br></pre></td></tr></table></figure></p>
<p>我们应该如何找到它们的差集呢？传统的方法可能需要把它们以Object形式hash化，但其实我们可以通过<code>.includes()</code>方法更加优雅方便地找出差集，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var a = [1, 2, &#123;s:3&#125;, &#123;s:4&#125;, &#123;s:5&#125;].map(item =&gt;JSON.stringify(item))</span><br><span class="line">var b = [&#123;s:2&#125;, &#123;s:3&#125;, &#123;s:4&#125;, &apos;a&apos;].map(item =&gt;JSON.stringify(item))</span><br><span class="line"></span><br><span class="line">var diff = a.concat(b)</span><br><span class="line">            .filter(v =&gt; !a.includes(v) || !b.includes(v))</span><br><span class="line">            .map(item =&gt;JSON.parse(item))</span><br><span class="line">            </span><br><span class="line">// diff: [1, 2, &#123;s:5&#125;, &#123;s:2&#125;, &quot;a&quot;]</span><br></pre></td></tr></table></figure></p>
<p>至于为什么要<code>JSON.stringify()</code>，是因为要对比两个“对象元素”是否相等，是无法直接以“对象”形式比较的（永远返回不相等）。</p>
<hr>
<h3 id="Array-includes-与条件判断"><a href="#Array-includes-与条件判断" class="headerlink" title="Array.includes 与条件判断"></a>Array.includes 与条件判断</h3><p>一般我们判断或用 ||<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// condition</span><br><span class="line">function test(fruit) &#123;</span><br><span class="line">  if (fruit == &quot;apple&quot; || fruit == &quot;strawberry&quot;) &#123;</span><br><span class="line">    console.log(&quot;red&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果我们有更多水果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function test(fruit) &#123;</span><br><span class="line">  const redFruits = [&quot;apple&quot;, &quot;strawberry&quot;, &quot;cherry&quot;, &quot;cranberries&quot;];</span><br><span class="line"></span><br><span class="line">  if (redFruits.includes(fruit)) &#123;</span><br><span class="line">    console.log(&quot;red&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Set-与去重"><a href="#Set-与去重" class="headerlink" title="Set 与去重"></a>Set 与去重</h3><p>ES6 提供了新的数据结构 Set。它类似于数组，但是成员的值都是唯一的，没有重复的值。Set 本身是一个构造函数，用来生成 Set 数据结构。</p>
<p>数组去重<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const arr = [3, 5, 2, 2, 5, 5];</span><br><span class="line">const unique = [...new Set(arr)];</span><br><span class="line">// [3,5,2]</span><br></pre></td></tr></table></figure></p>
<p>Array.from 方法可以将 Set 结构转为数组。我们可以专门编写使用一个去重的函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function unique(array) &#123;</span><br><span class="line">  return Array.from(new Set(array));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">unique([1, 1, 2, 3]); // [1, 2, 3]</span><br></pre></td></tr></table></figure></p>
<p><strong>字符去重</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">let str = [...new Set(&quot;ababbc&quot;)].join(&quot;&quot;);</span><br><span class="line">console.log(str);</span><br><span class="line">// &apos;abc&apos;</span><br></pre></td></tr></table></figure></p>
<p>另外 Set 是如此强大，因此使用 Set 可以很容易地实现并集（Union）、交集（Intersect）和差集（Difference）。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">let a = new Set([1, 2, 3]);</span><br><span class="line">let b = new Set([4, 3, 2]);</span><br><span class="line"></span><br><span class="line">// 并集</span><br><span class="line">let union = new Set([...a, ...b]);</span><br><span class="line">// Set &#123;1, 2, 3, 4&#125;</span><br><span class="line"></span><br><span class="line">// 交集</span><br><span class="line">let intersect = new Set([...a].filter(x =&gt; b.has(x)));</span><br><span class="line">// set &#123;2, 3&#125;</span><br><span class="line"></span><br><span class="line">// 差集</span><br><span class="line">let difference = new Set([...a].filter(x =&gt; !b.has(x)));</span><br><span class="line">// Set &#123;1&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Map-与字典类型数据"><a href="#Map-与字典类型数据" class="headerlink" title="Map 与字典类型数据"></a>Map 与字典类型数据</h3><p>一般而已，JavaScript 实现字典数据是基于 Object 对象。但是 JavaScript 的对象的键只能是字符串。对于编程来说有很多不便。 ES6 提供了 Map 数据结构。它类似于 Object 对象，也是键值对的集合，但是“键”的范围不限于字符串，各种类型的值，字符串、数值、布尔值、数组、对象等等都可以当作键。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const resultMap = new Map()</span><br><span class="line">  .set(-1, &#123;text:&apos;小于&apos;,color:&apos;yellow&apos;)</span><br><span class="line">  .set(0, &#123;text:&apos;等于&apos;,color:&apos;black&apos;)</span><br><span class="line">  .set(1, &#123;text:&apos;大于&apos;,color:&apos;green&apos;)</span><br><span class="line">  .set(null,&#123;text:&apos;没有物品&apos;,color:&apos;red&apos;&#125;)</span><br><span class="line"></span><br><span class="line">let state = resultMap.get(null)</span><br><span class="line">// &#123;text:&apos;没有物品&apos;,color:&apos;red&apos;&#125;</span><br></pre></td></tr></table></figure></p>
<p>Map 的遍历顺序就是插入顺序<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">const map = new Map([[&quot;F&quot;, &quot;no&quot;], [&quot;T&quot;, &quot;yes&quot;]]);</span><br><span class="line"></span><br><span class="line">for (let key of map.keys) &#123;</span><br><span class="line">  console.log(key);</span><br><span class="line">&#125;</span><br><span class="line">// &quot;F&quot;</span><br><span class="line">// &quot;T&quot;</span><br><span class="line"></span><br><span class="line">for (let value of map.value()) &#123;</span><br><span class="line">  console.log(value);</span><br><span class="line">&#125;</span><br><span class="line">// &quot;no&quot;</span><br><span class="line">// &quot;yes&quot;</span><br></pre></td></tr></table></figure></p>
<h3 id="函数式的方式处理数据"><a href="#函数式的方式处理数据" class="headerlink" title="函数式的方式处理数据"></a>函数式的方式处理数据</h3><p>按照我的理解，函数式编程主张函数必须接受至少一个参数并返回一个值。所以所有的关于数据的操作，都可以用函数式的方式处理。</p>
<p>假设我们有这样的需求，需要先把数组 foo 中的对象结构更改，然后从中挑选出一些符合条件的对象，并且把这些对象放进新数组 result 里。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">let foo = [</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;Stark&quot;,</span><br><span class="line">    age: 21</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;Jarvis&quot;,</span><br><span class="line">    age: 20</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: &quot;Pepper&quot;,</span><br><span class="line">    age: 16</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">//我们希望得到结构稍微不同，age大于16的对象：</span><br><span class="line">let result = [</span><br><span class="line">  &#123;</span><br><span class="line">    person: &#123;</span><br><span class="line">      name: &quot;Stark&quot;,</span><br><span class="line">      age: 21</span><br><span class="line">    &#125;,</span><br><span class="line">    friends: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    person: &#123;</span><br><span class="line">      name: &quot;Jarvis&quot;,</span><br><span class="line">      age: 20</span><br><span class="line">    &#125;,</span><br><span class="line">    friends: []</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure></p>
<p>从直觉上我们很容易写出这样的代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">let result = [];</span><br><span class="line"></span><br><span class="line">//有时甚至是普通的for循环</span><br><span class="line">foo.forEach(function(person)&#123;</span><br><span class="line">    if(person.age &gt; 16)&#123;</span><br><span class="line">        let newItem = &#123;</span><br><span class="line">            person: person,</span><br><span class="line">            friends: [];</span><br><span class="line">        &#125;;</span><br><span class="line">        result.push(newItem);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>使用函数式的写法，可以优雅得多<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">let result = foo</span><br><span class="line">  .filter(person =&gt; person.age &gt; 16)</span><br><span class="line">  .map(person =&gt; (&#123;</span><br><span class="line">    person: person,</span><br><span class="line">    friends: []</span><br><span class="line">  &#125;));</span><br></pre></td></tr></table></figure></p>
<p>数组求和<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">let foo = [1, 2, 3, 4, 5];</span><br><span class="line"></span><br><span class="line">//不优雅</span><br><span class="line">function sum(arr) &#123;</span><br><span class="line">  let x = 0;</span><br><span class="line">  for (let i = 0; i &lt; arr.length; i++) &#123;</span><br><span class="line">    x += arr[i];</span><br><span class="line">  &#125;</span><br><span class="line">  return x;</span><br><span class="line">&#125;</span><br><span class="line">sum(foo); // =&gt; 15</span><br><span class="line"></span><br><span class="line">//优雅</span><br><span class="line">foo.reduce((a, b) =&gt; a + b); // =&gt; 15</span><br></pre></td></tr></table></figure></p>
<h3 id="compose-与函数组合"><a href="#compose-与函数组合" class="headerlink" title="compose 与函数组合"></a>compose 与函数组合</h3><p>以下代码称为组合 compose<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const compose = function(f, g) &#123;</span><br><span class="line">  return function(x) &#123;</span><br><span class="line">    return f(g(x));</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>由于函数式编程大行其道，所以现在将会在 JavaScript 代码看到大量的箭头()=&gt;()=&gt;()=&gt;的代码。</p>
<p>ES6 版本 compose<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const compose = (f, g) =&gt; x =&gt; f(g(x));</span><br></pre></td></tr></table></figure></p>
<p>在 compose 的定义中， g 将先于 f 执行，因此就创建了一个从右到左的数据 流。这样做的可读性远远高于嵌套一大堆的函数调用.</p>
<p>我们选择一些函数，让它们结合，生成一个崭新的函数。</p>
<p>reverse 反转列表， head 取列表中的第一个元素；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const head = arr =&gt; arr[0];</span><br><span class="line">const reverse = arr =&gt; [].concat(arr).reverse();</span><br><span class="line"></span><br><span class="line">const last = compose(head, reverse);</span><br><span class="line">last([&quot;jumpkick&quot;, &quot;roundhouse&quot;, &quot;uppercut&quot;]);</span><br><span class="line">// &quot;uppercut&quot;</span><br></pre></td></tr></table></figure></p>
<p>但是我们这个这个compose不够完善，只能处理两个函数参数。redux源码有个很完备的compose函数，我们借鉴一下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function compose(...funcs)&#123;</span><br><span class="line">  if (funcs.length === 0)&#123;</span><br><span class="line">      return arg =&gt; arg</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (funcs.length === 1 )&#123;</span><br><span class="line">      return funcs[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return funcs.reduce((a,b)=&gt;(...args) =&gt; a(b(...args)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>有了这个函数，我们可以随意组合无数个函数。现在我们增加需求，组合出一个lastAndUpper函数，内容是先reverse 反转列表， head 取列表中的第一个元素, 最后toUpperCase大写。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">const head = arr =&gt; arr[0];</span><br><span class="line">const reverse = arr =&gt; [].concat(arr).reverse();</span><br><span class="line">const toUpperCase = str =&gt; str.toUpperCase();</span><br><span class="line"></span><br><span class="line">const last = compose(head, reverse);</span><br><span class="line"></span><br><span class="line">const lastAndUpper = compose(toUpperCase, head, reverse,);</span><br><span class="line"></span><br><span class="line">console.log(last([&quot;jumpkick&quot;, &quot;roundhouse&quot;, &quot;uppercut&quot;]));</span><br><span class="line">// &quot;uppercut&quot;</span><br><span class="line">console.log(lastAndUpper([&quot;jumpkick&quot;, &quot;roundhouse&quot;, &quot;uppercut&quot;]))</span><br><span class="line">// &quot;UPPERCUT&quot;</span><br></pre></td></tr></table></figure></p>
<hr>
<p>过去的一年， <code>JavaScript</code> 在持续变化着，其使用范围也越来越广。接下来，我将针对 <code>JavaScript</code> 的使用，列出 9 条 建议，以帮助你写出更加整洁高效的代码，成为更好的开发者。</p>
<h3 id="async-await"><a href="#async-await" class="headerlink" title="async/await"></a>async/await</h3><p><code>JavaScript</code> 极速发展的今天，回调地狱所产生的问题已不复存在。实际开发过程中我们应当尽量避免使用回调函数，除非为了遵守代码库规则或是维护性能。而解决回调地狱的一个常用方法为 <code>Promise</code>，但在代码量较多时使用会适得其反。于是提出了 <code>async / await</code>，使代码结构更加清晰明了，便于阅读和维护。一般而言，可以 <code>await</code> 任何 <code>Promise</code> 以防止正使用的库的返回值为 <code>Promise</code> ，也就是说 <code>async/await</code> 是 <code>Promise</code> 的语法糖，而且使用方法也十分简单：在函数前加 <code>async</code>。下面是一个简单的例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">async function getData() &#123;</span><br><span class="line">    const result = await axios.get(&apos;https://dube.io/service/ping&apos;)</span><br><span class="line">    const data = result.data</span><br><span class="line">    console.log(&apos;data&apos;, data)</span><br><span class="line">    return data</span><br><span class="line">&#125;</span><br><span class="line">getData()</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>await 只能使用在 async 函数中，不能用于全局作用域。</p>
</blockquote>
<blockquote>
<p><code>async/await</code> 是 ES2017 中引入的，使用时请进行转换。</p>
</blockquote>
<h3 id="异步控制流"><a href="#异步控制流" class="headerlink" title="异步控制流"></a>异步控制流</h3><p>当我们进行异步调用并获得返回值时，通常期望直接获取多个数据集，并且分别操作每个数据集。因此有了以下方式：</p>
<h4 id="for…of"><a href="#for…of" class="headerlink" title="for…of"></a>for…of</h4><p>假设页面上要展示 Pokemon 数据，可以通过 <code>axios</code> 获取它们的详细信息，我们所期望的是在得到返回值时立即更新页面中的所有数据，而不是等所有调用完成后才进行更新。</p>
<p>我们可以使用 <code>for...of</code> 解决上述问题。 首先循环遍历数组，并在每个循环内执行异步代码，当所有调用都成功时跳出循环。需要注意的是，这种方法虽然会对性能产生一些影响，但也不乏是一个很好的方法。</p>
<p>以下是一个例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import axios from&apos;axios&apos;</span><br><span class="line">let myData = [&#123; id: 0 &#125;, &#123; id: 1 &#125;, &#123; id: 2 &#125;, &#123; id: 3 &#125;]</span><br><span class="line"></span><br><span class="line">async function fetchData(dataSet) &#123;</span><br><span class="line">    for (entry of dataSet) &#123;</span><br><span class="line">        const result = await axios.get(`https://ironhack-pokeapi.herokuapp.com/pokemon/$&#123;entry.id&#125;`)</span><br><span class="line">        const newData = result.data</span><br><span class="line">        updateData(newData)</span><br><span class="line">        console.log(myData)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">function updateData(newData) &#123;</span><br><span class="line">    myData = myData.map(el =&gt; &#123;</span><br><span class="line">        if (el.id === newData.id) return newData</span><br><span class="line">        return el</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">fetchData(myData)</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>可以将这些例子复制粘贴到编辑器中调试运行。</p>
</blockquote>
<blockquote>
<p>译者注：除了循环本身带来的性能问题之外，在使用 <code>async/await</code> 处理异步请求时也会对性能造成影响：如果使用过多 <code>await</code> 语句，而且候这些语句并不需要依赖于之前的语句，则会产生 <code>async/await</code> 地狱，影响性能。</p>
</blockquote>
<h4 id="Promise-all"><a href="#Promise-all" class="headerlink" title="Promise.all"></a>Promise.all</h4><p>如果想要并行获取所有的 Pokemon，我们可以使用 <code>Promise.all</code> 方法来 <code>await</code> 所有 <code>Promise</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import axios from&apos;axios&apos;</span><br><span class="line">let myData = [&#123; id: 0 &#125;, &#123; id: 1 &#125;, &#123; id: 2 &#125;, &#123; id: 3 &#125;]</span><br><span class="line">async function fetchData(dataSet) &#123;</span><br><span class="line">    const pokemonPromises = dataSet.map(entry =&gt; &#123;</span><br><span class="line">        return axios.get(`https://ironhack-pokeapi.herokuapp.com/pokemon/$&#123;entry.id&#125;`)</span><br><span class="line">    &#125;)</span><br><span class="line">    const results = awaitPromise.all(pokemonPromises)</span><br><span class="line">    results.forEach(result =&gt; &#123;</span><br><span class="line">        updateData(result.data)</span><br><span class="line">    &#125;)</span><br><span class="line">    console.log(myData)</span><br><span class="line">&#125;</span><br><span class="line">function updateData(newData) &#123;</span><br><span class="line">    myData = myData.map(el =&gt; &#123;</span><br><span class="line">        if (el.id === newData.id) return newData</span><br><span class="line">        return el</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">fetchData(myData)</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><code>for...of</code> 和 <code>Promise.all</code> 都是 <code>ES6+</code> 引入的，使用时请进行转换。</p>
</blockquote>
<h3 id="解构赋值-amp-默认值"><a href="#解构赋值-amp-默认值" class="headerlink" title="解构赋值 &amp; 默认值"></a>解构赋值 &amp; 默认值</h3><p>回到上个例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const result = axios.get(`https://ironhack-pokeapi.herokuapp.com/pokemon/$&#123;entry.id&#125;`)</span><br><span class="line">const data = result.data</span><br></pre></td></tr></table></figure></p>
<p>现在有一种更简单的方法来实现它：通过解构赋值的方式从对象或数组中获取一个或多个值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const &#123; data &#125; = await axios.get(...)</span><br></pre></td></tr></table></figure></p>
<p>也可对变量重命名：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const &#123; data: newData &#125; = await axios.get(...)</span><br></pre></td></tr></table></figure></p>
<p>另一种方法是在解构赋值时指定默认值，这样做可以确保代码不会出现 <code>undefined</code>，也避免手动检查变量的麻烦。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const &#123; id = 5 &#125; = &#123;&#125;</span><br><span class="line">console.log(id) // 5</span><br></pre></td></tr></table></figure></p>
<p>这些方法也可以用于函数参数，例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function calculate(&#123; operands = [1, 2], type = &apos;addition&apos; &#125; = &#123;&#125;) &#123;</span><br><span class="line">    return operands.reduce((acc, val) =&gt; &#123;</span><br><span class="line">        switch (type) &#123;</span><br><span class="line">            case&apos;addition&apos;:</span><br><span class="line">                return acc + val</span><br><span class="line">            case&apos;subtraction&apos;:</span><br><span class="line">                return acc - val</span><br><span class="line">            case&apos;multiplication&apos;:</span><br><span class="line">                return acc * val</span><br><span class="line">            case&apos;division&apos;:</span><br><span class="line">                return acc / val</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, [&apos;addition&apos;, &apos;subtraction&apos;].includes(type) ? 0 : 1)</span><br><span class="line">&#125;</span><br><span class="line">console.log(calculate()) // 3 </span><br><span class="line">console.log(calculate(&#123; type: &apos;division&apos; &#125;)) // 0.5 </span><br><span class="line">console.log(calculate(&#123; operands: [2, 3, 4], type: &apos;multiplication&apos; &#125;)) // 24</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><code>ES6</code> 引入了解构赋值和默认值，使用时请进行转换。</p>
</blockquote>
<h3 id="真值和虚值"><a href="#真值和虚值" class="headerlink" title="真值和虚值"></a>真值和虚值</h3><p>当我们使用默认值时，通常要对现有值进行一系列判断，这种方法使代码变得异常繁琐，而现在我们可以真值（<code>Truthy</code>）和虚值（<code>Falsy</code>）的方式来改进它，不仅可以节省代码量，还使人更加信服。</p>
<p>以下是之前的做法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if (myBool === true) &#123;</span><br><span class="line">    console.log(...)</span><br><span class="line">&#125;</span><br><span class="line">// OR</span><br><span class="line">if (myString.length &gt; 0) &#123;</span><br><span class="line">    console.log(...)</span><br><span class="line">&#125;</span><br><span class="line">// OR</span><br><span class="line">if (isNaN(myNumber)) &#123;</span><br><span class="line">    console.log(...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>简化后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if (myBool) &#123;</span><br><span class="line">    console.log(...)</span><br><span class="line">&#125;</span><br><span class="line">// OR</span><br><span class="line">if (myString) &#123;</span><br><span class="line">    console.log(...)</span><br><span class="line">&#125;</span><br><span class="line">// OR</span><br><span class="line">if (!myNumber) &#123;</span><br><span class="line">    console.log(...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以下为 <code>Falsy</code> 和 <code>Truthy</code> 的概念：</p>
<p><strong>False</strong></p>
<ul>
<li>长度为0的字符串</li>
<li>数字 <code>0</code></li>
<li><code>false</code></li>
<li><code>undefined</code></li>
<li><code>null</code></li>
<li><code>NaN</code></li>
</ul>
<p><strong>True</strong></p>
<ul>
<li>空数组</li>
<li>空对象</li>
<li>其他</li>
</ul>
<p>使用真值和虚值时没有确切的比较方式，这类似于我们进行比较时常使用双等号 <code>==</code> 而不是三等号 <code>===</code>。一般而言，这两者的判定方式相同，但在某些情况下也会遇到一些错误，对我来说主要为数字 <code>0</code>。</p>
<h3 id="逻辑运算符和三元运算符"><a href="#逻辑运算符和三元运算符" class="headerlink" title="逻辑运算符和三元运算符"></a>逻辑运算符和三元运算符</h3><p>逻辑运算符和三元运算符主要用于精简代码，有助于保持代码整洁度，但当他们形成运算链时会显得杂乱。</p>
<h3 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h3><p>逻辑运算符：和（<code>&amp;&amp;</code>）、或（<code>||</code>），一般用于比较两个表达式，返回值为： <code>true</code>、<code>false</code> 或着它的匹配值。如下例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">console.log(true &amp;&amp; true) // true</span><br><span class="line">console.log(false &amp;&amp; true) // false</span><br><span class="line">console.log(true &amp;&amp; false) // false</span><br><span class="line">console.log(false &amp;&amp; false) // false</span><br><span class="line">console.log(true || true) // true</span><br><span class="line">console.log(true || false) // true</span><br><span class="line">console.log(false || true) // true</span><br><span class="line">console.log(false || false) // false</span><br></pre></td></tr></table></figure></p>
<p>我们可以将逻辑运算符与真值和虚值的相关知识结合起来。</p>
<p>如果有表达式 <code>A</code> 和 <code>B</code>，针对两种逻辑运算符，有以下规则：</p>
<ul>
<li><code>A &amp;&amp; B</code> ： 当 <code>A</code> 为 <code>false</code> 时则直接返回 <code>A</code> 的值 ；否则返回 <code>B</code> 的值。</li>
<li><code>A || B</code> ： 当 <code>A</code> 为 <code>true</code> 时则直接返回 <code>A</code> 的值 ；否则返回 <code>B</code> 的值。</li>
</ul>
<blockquote>
<p>译者注：上述规则为逻辑运算中的短路现象。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">console.log(0 &amp;&amp; &#123; a: 1 &#125;) // 0</span><br><span class="line">console.log(false &amp;&amp; &apos;a&apos;) // false</span><br><span class="line">console.log(&apos;2&apos; &amp;&amp; 5) // 5</span><br><span class="line">console.log([] || false) // []</span><br><span class="line">console.log(NaN || null) // null</span><br><span class="line">console.log(true || &apos;a&apos;) // true</span><br></pre></td></tr></table></figure>
<h3 id="三元运算符"><a href="#三元运算符" class="headerlink" title="三元运算符"></a>三元运算符</h3><p>三元运算符与逻辑运算符非常相似，但有由三个部分组成：</p>
<ol>
<li>条件表达式：其结果为真值或是虚值</li>
<li>返回值 1：条件表达式为真值时，返回该值</li>
<li>返回值 2：条件表达式为虚值时，返回该值</li>
</ol>
<p>例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const lang = &apos;German&apos;</span><br><span class="line">console.log(lang === &apos;German&apos; ? &apos;Hallo&apos; : &apos;Hello&apos;) // Hallo</span><br><span class="line">console.log(lang ? &apos;Ja&apos; : &apos;Yes&apos;) // Ja</span><br><span class="line">console.log(lang === &apos;French&apos; ? &apos;Bon soir&apos; : &apos;Good evening&apos;) // Good eveing</span><br></pre></td></tr></table></figure></p>
<h3 id="自判断链接"><a href="#自判断链接" class="headerlink" title="自判断链接"></a>自判断链接</h3><p>当访问某个嵌套对象的属性时，由于不能确定目标对象或者属性性是否存在，而需要进行一系列判断：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">let data</span><br><span class="line">if (myObj &amp;&amp; myObj.firstProp &amp;&amp; myObj.firstProp.secondProp &amp;&amp; myObj.firstProp.secondProp.actualData)</span><br><span class="line">    data = myObj.firstProp.secondProp.actualData</span><br></pre></td></tr></table></figure></p>
<p>显而易见，代码变得非常臃肿难看。而自判断链接（<code>optional chaining</code>）的提出，正好可以满足对嵌套属性的校验需求，并使代码更加清晰整洁。如下例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const data = myObj?.firstProp?.secondProp?.actualData</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function safeGet(o, path)&#123;</span><br><span class="line">   </span><br><span class="line">   return path.split(&apos;.&apos;).reduce((o=&#123;&#125;,b)=&#123;   //用到参数默认值</span><br><span class="line">     </span><br><span class="line">      return o[b]  </span><br><span class="line">   &#125;,o)</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>译者注：自判断链接： 检查一个对象上面是否存在某属性。</p>
<p>出现原因：调用某 <code>Object</code>属性链中的某个属性时，如果该属性不存在，会导致 <code>Cannot read property xxx of undefined</code> 错误。于是自判断链接 <code>?.</code> 出现。</p>
<p>使用方式：<code>obj?.a?.b?.c</code>。依次对代码中的属性进行判断，如果为 <code>null</code> 或者 <code>undefined</code> 时，结束调用，返回 <code>undefined</code> 。</p>
</blockquote>
<blockquote>
<p>目前，自判断链接还未纳入官方规范中，只处于第一阶段的实验特性。您需要在 <code>babelrc</code> 中添加 <code>@ babel / plugin-proposal-optional-chaining</code> 后方可使用它。</p>
</blockquote>
<h3 id="类属性-amp-绑定"><a href="#类属性-amp-绑定" class="headerlink" title="类属性 &amp; 绑定"></a>类属性 &amp; 绑定</h3><p><code>JavaScript</code> 中经常会用到绑定（<code>bind</code>）。<code>ES6</code> 规范中箭头函数的引入，使 <code>JavaScript</code> 开发人员有了一种将函数自动绑定到执行上下文中的常用方法，同时这种方法非常重要。</p>
<p>由于 <code>JavaScript</code> 中的类方法有特定的调用方式，因此当我们首次声明一个类时不能使用箭头函数，因此需要在其他位置进行函数绑定，比如在构造函数中（以 <code>React.js</code> 为例）。工作当中我总是先定义类方法再对其进行绑定，这种方法非常繁琐且容易出错。但如果使用 <code>class</code> 语法，我们可以通过箭头函数自动绑定它。以下是绑定 <code>_increaseCount</code> 的例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">classCounterextendsReact.Component&#123;</span><br><span class="line">    constructor(props) &#123;</span><br><span class="line">        super(props)</span><br><span class="line">        this.state = &#123; count: 0 &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    render() &#123;</span><br><span class="line">        return (</span><br><span class="line">            &lt;div&gt;&lt;h1&gt;&#123;this.state.count&#125;&lt;/h1&gt;&lt;buttononClick=&#123;this._increaseCount&#125;&gt;Increase Count&lt;/button&gt;&lt;/div&gt;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">    _increaseCount = () =&gt; &#123;</span><br><span class="line">        this.setState(&#123; count: this.state.count + 1 &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>目前，类属性还未纳入官方规范中，只处于第三阶段的实验特性。您需要在 <code>babelrc</code> 中添加 <code>@ babel / plugin-proposal-class-properties</code> 后方可使用。</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/13/一道赋值面试题引发的思考2/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/13/一道赋值面试题引发的思考2/" itemprop="url">一道赋值面试题引发的思考2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-13T14:14:11+08:00">
                2019-01-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="从面试题看-JS-事件循环与-macro-micro-任务队列"><a href="#从面试题看-JS-事件循环与-macro-micro-任务队列" class="headerlink" title="从面试题看 JS 事件循环与 macro micro 任务队列"></a><a href="https://juejin.im/post/5c8a024d51882546be0a3082" target="_blank" rel="noopener">从面试题看 JS 事件循环与 macro micro 任务队列</a></h2><h2 id="一道面试题"><a href="#一道面试题" class="headerlink" title="一道面试题"></a>一道面试题</h2><p>最近，有篇名为 <strong> <a href="https://segmentfault.com/a/1190000017224799" target="_blank" rel="noopener">《8张图帮你一步步看清 async/await 和 promise 的执行顺序》</a> </strong> 的文章引起了我的关注。</p>
<p>作者用一道2017年「今日头条」的前端面试题为引子，分步讲解了最终结果的执行原因。其中涉及到了不少概念，比如异步的执行顺序，宏任务，微任务等等，同时作者限定了执行范围，以浏览器的 event loop 机制为准。下面是原题的代码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> functionasync1 () &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'async1 start'</span>);</span><br><span class="line">    <span class="keyword">await</span> async2();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'async1 end'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> functionasync2 () &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'async2'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'script start'</span>);</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'setTimeout'</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">async1();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'promise1'</span>);</span><br><span class="line">    resolve();</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'promise2'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'script end'</span>);</span><br></pre></td></tr></table></figure></p>
<h5 id="chromeV71"><a href="#chromeV71" class="headerlink" title="chromeV71:"></a>chromeV71:</h5><p><img src="/2019/01/13/一道赋值面试题引发的思考2/1.png" alt=""></p>
<p>紧接着，作者先给出了答案。并希望读者先行自我测试。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">script start</span><br><span class="line">async1 start</span><br><span class="line">async2</span><br><span class="line">promise1</span><br><span class="line">script end</span><br><span class="line">promise2</span><br><span class="line">async1 end</span><br><span class="line">setTimeout</span><br></pre></td></tr></table></figure></p>
<p>我在看这道题的时候，先按照自己的理解写出了结果。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">script start</span><br><span class="line">async1 start</span><br><span class="line">async2</span><br><span class="line">promise1</span><br><span class="line">script end</span><br><span class="line">async1 end</span><br><span class="line">promise2</span><br><span class="line">setTimeout</span><br></pre></td></tr></table></figure></p>
<h2 id="一些重要的概念"><a href="#一些重要的概念" class="headerlink" title="一些重要的概念"></a>一些重要的概念</h2><p>这里需要先简单地说一些 event loop 的概念。</p>
<ul>
<li>Javascript是单线程的，所有的同步任务都会在主线程中执行。</li>
<li>主线程之外，还有一个任务队列。每当一个异步任务有结果了，就往任务队列里塞一个事件。</li>
<li>当主线程中的任务，都执行完之后，系统会 “依次” 读取任务队列里的事件。与之相对应的异步任务进入主线程，开始执行。</li>
<li>异步任务之间，会存在差异，所以它们执行的优先级也会有区别。大致分为 微任务（micro task，如：Promise、MutaionObserver等）和宏任务（macro task，如：setTimeout、setInterval、I/O等）。同一次事件循环中，微任务永远在宏任务之前执行。</li>
<li>主线程会不断重复上面的步骤，直到执行完所有任务。</li>
</ul>
<p>另外，还有 async/await 的概念。</p>
<ul>
<li>async 函数，可以理解为是Generator 函数的语法糖。</li>
<li>它建立在promise之上，总是与await一起使用的。</li>
<li>await会返回一个Promise 对象，或者一个表达式的值。</li>
<li>其目的是为了让异步操作更优雅，能像同步一样地书写。</li>
</ul>
<h2 id="我的理解"><a href="#我的理解" class="headerlink" title="我的理解"></a>我的理解</h2><p>再说说我对这道题的理解。</p>
<ul>
<li>首先，从console的数量上看，会输出8行结果。</li>
<li>再瞟了一眼代码，看到了setTimeout，于是，默默地把它填入第8行。</li>
<li>在setTimeout附近，看到了 console.log( ‘script start’ ) 和 async1()，可以确认它们是同步任务，会先在主线程中执行。所以，妥妥地在第1行填入 script start，第2行填入async1方法中的第一行 async1 start。</li>
<li>接下来，遇到了await。从字面意思理解，让我们等等。需要等待async2()函数的返回，同时会阻塞后面的代码。所以，第3行填入 async2。</li>
<li>讲道理，await都执行完了，该轮到console.log( ‘async1 end’ )的输出了。但是，别忘了下面还有个Promise，有一点需要注意的是：当 new 一个 Promise的时候，其 resolve 方法中的代码会立即执行。如果不是 async1()的 await 横插一杠，promise1 可以排得更前面。所以，现在第4行填入 promise1。</li>
<li>再接下来，同步任务 console.log( ‘script end’ ) 执行。第5行填入 script end。</li>
<li>还有第6和第7行，未填。回顾一下上面提到 async/await 的概念，其目的是为了让异步能像同步一样地书写。那么，我认为 console.log( ‘async1 end’ ) 就是个同步任务。所以，第6行填入async1 end。</li>
<li>最后，顺理成章地在第7行填入 promise2。</li>
</ul>
<h2 id="与作者答案的不同"><a href="#与作者答案的不同" class="headerlink" title="与作者答案的不同"></a>与作者答案的不同</h2><p>回过头对比与作者的答案，发现第6和第7行的顺序有问题。</p>
<p>再耐心地往下看文章，反复地看了几遍 async1 end 和 promise2 谁先谁后，还是无法理解为何在chrome浏览器中，promise2 会先于 async1 end 输出。</p>
<p>然后，看到评论区，发现也有人提出了相同的疑惑。<a href="https://link.juejin.im?target=https%3A%2F%2Fsegmentfault.com%2Fu%2Frhinel" target="_blank" rel="noopener">@rhinel</a>提出，在他的72.0.3622.0（正式版本）dev（64 位）的chrome中，跑出来的结果是 async1 end 在 promise2 之前。</p>
<p><strong>随即我想到了一种可能，JS的规范可能会在未来有变化。于是，我用自己的react工程试了一下（工程中的babel-loader版本为7.1.5。.babelrc的presets设置了stage-3），结果与我的理解一致。当前的最新版本 chromeV71，在这里的执行顺序上，的确存在有问题。</strong></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><h4 id="从面试题看-JS-事件循环与-macro-micro-任务队列-1"><a href="#从面试题看-JS-事件循环与-macro-micro-任务队列-1" class="headerlink" title="从面试题看 JS 事件循环与 macro micro 任务队列"></a><a href="https://juejin.im/post/5c8a024d51882546be0a3082" target="_blank" rel="noopener">从面试题看 JS 事件循环与 macro micro 任务队列</a></h4><h4 id="8张图帮你一步步看清-async-await-和-promise-的执行顺序"><a href="#8张图帮你一步步看清-async-await-和-promise-的执行顺序" class="headerlink" title="8张图帮你一步步看清 async/await 和 promise 的执行顺序"></a><a href="https://segmentfault.com/a/1190000017224799" target="_blank" rel="noopener">8张图帮你一步步看清 async/await 和 promise 的执行顺序</a></h4><h4 id="简单理解async、await语法实现原理"><a href="#简单理解async、await语法实现原理" class="headerlink" title="简单理解async、await语法实现原理"></a><a href="https://libin1991.github.io/2018/10/04/%E7%AE%80%E5%8D%95%E7%90%86%E8%A7%A3async%E3%80%81await%E8%AF%AD%E6%B3%95%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" target="_blank" rel="noopener">简单理解async、await语法实现原理</a></h4><h4 id="细说-async-await-相较于-Promise-的优势"><a href="#细说-async-await-相较于-Promise-的优势" class="headerlink" title="细说 async/await 相较于 Promise 的优势"></a><a href="https://juejin.im/post/5c39523651882525a67c53d6" target="_blank" rel="noopener">细说 async/await 相较于 Promise 的优势</a></h4>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/06/一道赋值面试题引发的思考/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/06/一道赋值面试题引发的思考/" itemprop="url">一道赋值面试题引发的思考</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-06T17:53:16+08:00">
                2019-01-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="开头先来做一道面试题"><a href="#开头先来做一道面试题" class="headerlink" title="开头先来做一道面试题"></a>开头先来做一道面试题</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a=&#123;<span class="attr">n</span>:<span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> b=a;</span><br><span class="line">a.x=a=&#123;<span class="attr">n</span>:<span class="number">2</span>&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(a.x);</span><br><span class="line"><span class="built_in">console</span>.log(b.x);</span><br></pre></td></tr></table></figure>
<p>最后输出的是什么？ 先不说答案，我们来分析一下</p>
<p>(第二行) 我们把a赋值给b， 由于a是对象类型，这就意味着b和a指向同一个内存地址<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a.x = a = &#123; <span class="attr">n</span>: <span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们有个疑惑，这句语句执行顺序是 <code>a = {n: 2} &amp;&amp; a.x = {n:2}</code> 还是 <code>a.x = {n:2} &amp;&amp; a= {n:2}</code> 还是这种 <code>a = {n: 2} &amp;&amp; a.x = a</code></p>
<p>我们这里可以借助 <code>Object.defineProperty</code> 或 ES6的 <code>Proxy</code>来验证多项赋值的顺序是怎样的<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = newProxy(&#123;&#125;, &#123;</span><br><span class="line">  set(target, key, value, r) &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(key, value)</span><br><span class="line">	<span class="keyword">if</span> (key === <span class="string">'a'</span>) <span class="built_in">Reflect</span>.set(target, key, <span class="string">'isA'</span>, r);</span><br><span class="line">	<span class="keyword">else</span> <span class="built_in">Reflect</span>.set(target, key, value, r);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">obj.b = obj.a= &#123;<span class="attr">n</span>: <span class="number">1</span>&#125;;</span><br><span class="line"><span class="comment">// 输出:</span></span><br><span class="line"><span class="comment">// "a" &#123;n: 1&#125;</span></span><br><span class="line"><span class="comment">// "b" &#123;n: 1&#125;</span></span><br><span class="line"></span><br><span class="line">obj.a; <span class="comment">// isA</span></span><br><span class="line">obj.b; <span class="comment">// &#123;n: 1&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>所以我们可以得出 赋值的顺序是从右边开始到左边的。而且是直接 <code>a = {n: 1}, a.x = {n:1 }</code>，而不是 <code>a.x = a</code> 这样去赋值</p>
<p>现在我们再借助 Proxy 来分析一开始part1这道题，用obj.a, obj.b 来代替原题目的 a和b。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = newProxy(&#123;&#125;, &#123;</span><br><span class="line">  get: <span class="function"><span class="keyword">function</span> (<span class="params">target, key, receiver</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`getting <span class="subst">$&#123;key&#125;</span>!`</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, key, receiver);</span><br><span class="line">  &#125;,</span><br><span class="line">  set: <span class="function"><span class="keyword">function</span> (<span class="params">target, key, value, receiver</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`setting <span class="subst">$&#123;key&#125;</span>!`</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Reflect</span>.set(target, key, value, receiver);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">obj.a = &#123;<span class="attr">n</span>: <span class="number">1</span> &#125;;<span class="comment">// getting a;</span></span><br><span class="line">obj.b = obj.a; <span class="comment">// getting a; setting b;</span></span><br><span class="line">obj.a.x = obj.a = &#123;<span class="attr">n</span>:<span class="number">2</span> &#125;; <span class="comment">// getting a; setting a;</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到 <code>obj.a.x = obj.a = {n: 2}</code>这段语句执行时，会先输出一个 <strong>getting a</strong> 再输出 <strong>setting a</strong>。<br>这就意味着在对 <code>obj.a.x</code> 赋值时，程序是先获取 <code>obj.a</code>指向的对象的内存地址，此时触发了 <strong>getting a</strong>，然后再对右边 <code>obj.a</code> 进行赋值，触发了 <strong>setting a</strong>， 赋值完最后一步才是对 <code>obj.a.x</code>赋值 <code>{n:2 }</code>。</p>
<p><font color="#ff0000"> <strong> 重点: 在对obj.a.x赋值的时刻已经获取了obj.a该对象指向的内存地址【也就是obj.a.x在obj.a赋值前就已经确定了】，所以后面a就算指向其他地址，也和这里的obj.a.x无关。此时指向该地址的还有obj.b </strong> </font> <br> </p>
<p>我们再用三张图来捋一捋整理的思路</p>
<p>执行 <code>obj.a = {n: 1}; obj.b = obj.a</code>后obj对应的引用是这样的</p>
<p><img src="/2019/01/06/一道赋值面试题引发的思考/init.png" alt=""></p>
<p>执行 <code>obj.a.x = xxx</code> 时</p>
<p><img src="/2019/01/06/一道赋值面试题引发的思考/obj.a.x.png" alt=""></p>
<p>执行<code>obj.a.x = obj.a = {n:2}</code> 后</p>
<p><img src="/2019/01/06/一道赋值面试题引发的思考/result.png" alt=""></p>
<p>至此，这道面试题相信大家都有答案了，可以自己去控制台验证一下。 假如这时候再执行 <code>obj.a.n = 3</code>， 打印<code>obj.b</code>会输出什么呢？</p>
<p><img src="/2019/01/06/一道赋值面试题引发的思考/1.png" alt=""></p>
<h2 id="对象循环引用"><a href="#对象循环引用" class="headerlink" title="对象循环引用"></a>对象循环引用</h2><p>接下来我们来看另一道题，关于对象循环引用的<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = &#123; <span class="attr">n</span>: <span class="number">1</span>&#125;</span><br><span class="line">a.b = a;</span><br></pre></td></tr></table></figure></p>
<p>这里的a明显是循环引用，那么我们要怎样才能判断一个对象是否是循环引用呢？<br><img src="/2019/01/06/一道赋值面试题引发的思考/2.png" alt=""></p>
<p>其实这道题我一开始除了递归判断外没有很好的解决方案，后面是群里一个大佬说(这道题也是他出的)直接用 <code>JSON.stringify</code>，微信小游戏的源码里面就是这么去判断。</p>
<p><code>JSON.stringify</code> 如果遇到参数里有循环引用的，就会抛出一个循环调用的错误 <strong>Uncaught TypeError: Converting circular structure to JSON</strong><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Uncaught <span class="built_in">TypeError</span>: Converting circular structure to <span class="built_in">JSON</span></span><br><span class="line">    at <span class="built_in">JSON</span>.stringify (<span class="xml"><span class="tag">&lt;<span class="name">anonymous</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">    at mainctrl.js:234</span></span><br><span class="line"><span class="xml">    at Object.getUser (api.js:247)</span></span><br><span class="line"><span class="xml">    at mainctrl.js:228</span></span><br></pre></td></tr></table></figure></p>
<p>那如果不用JSON.stringify或者想要自己实现一个去检测循环调用，该怎么写呢？（面试官和部门前端leader最喜欢这么问）</p>
<p>一般遇到这种，最简单的方法就是去找这个方法的 polyfill， <a href="https://github.com/bestiejs/json3" target="_blank" rel="noopener">json3</a>。我找的是 json3的 polyfill 里面大概是遍历对象存到stack数组，再在解析的时候去判断是否有循环引用的情况。 <a href="https://github.com/bestiejs/json3/blob/master/lib/json3.js#L482" target="_blank" rel="noopener">json3.js#L482</a></p>
<p>照着他的思路大概写了一个，其实就是前面说到的简单递归判断</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> stack = [];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> len;</span><br><span class="line">    <span class="keyword">for</span> (len = stack.length; len--;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stack[len] === obj) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"循环引用"</span>)     <span class="comment">//循环引用</span></span><br><span class="line">    &#125;</span><br><span class="line">    stack.push(obj);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">in</span> obj) &#123;</span><br><span class="line">        <span class="keyword">const</span> value = obj[k]</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'object'</span>) fn(value);     <span class="comment">//递归判断</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2019/01/06/一道赋值面试题引发的思考/3.png" alt=""> </p>
<h2 id="对象循环引用破解办法"><a href="#对象循环引用破解办法" class="headerlink" title="对象循环引用破解办法"></a>对象循环引用破解办法</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Demo: Circular reference</span></span><br><span class="line"><span class="keyword">var</span> o = &#123;&#125;;</span><br><span class="line">o.o = o;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Note: cache should not be re-used by repeated calls to JSON.stringify.</span></span><br><span class="line"><span class="keyword">var</span> cache = [];</span><br><span class="line"><span class="built_in">JSON</span>.stringify(o, <span class="function"><span class="keyword">function</span>(<span class="params">key, value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'object'</span> &amp;&amp; value !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cache.indexOf(value) !== <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="comment">// Circular reference found, discard key</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Store value in our collection</span></span><br><span class="line">        cache.push(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;);</span><br><span class="line">cache = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/2019/01/06/一道赋值面试题引发的思考/4.png" alt=""> </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/03/JS设计模式/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/03/JS设计模式/" itemprop="url">JS设计模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-03T13:11:06+08:00">
                2019-01-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="发布订阅模式"><a href="#发布订阅模式" class="headerlink" title="发布订阅模式"></a>发布订阅模式</h2><blockquote>
<p>订阅-发布模式定义了对象之间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖它的对象都可以得到通知。</p>
</blockquote>
<p>了解过事件机制或者函数式编程的朋友，应该会体会到“订阅-发布模式”所带来的“<strong>时间解耦</strong>”和“<strong>空间解耦</strong>”的优点。<br>借助函数式编程中闭包和回调的概念，可以很优雅地实现这种设计模式。</p>
<h3 id="“订阅-发布模式”-vs-观察者模式"><a href="#“订阅-发布模式”-vs-观察者模式" class="headerlink" title="“订阅-发布模式” vs 观察者模式"></a>“订阅-发布模式” vs 观察者模式</h3><p>订阅-发布模式和观察者模式概念相似，但在订阅-发布模式中，订阅者和发布者之间多了一层中间件：一个被抽象出来的信息调度中心。<br>最大的特点是集中管理，统一触发。</p>
<p>JS中一般用事件模型来代替传统的发布-订阅模式。任何一个对象的原型链被指向<code>Event</code>的时候，这个对象便可以绑定自定义事件和对应的回调函数。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Event = &#123;</span><br><span class="line">  clientList: &#123;&#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 绑定事件监听</span></span><br><span class="line">  listen(key, fn)&#123;</span><br><span class="line">    <span class="keyword">if</span>(! <span class="keyword">this</span>.clientList[key])&#123;</span><br><span class="line">      <span class="keyword">this</span>.clientList[key] = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.clientList[key].push(fn);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 触发对应事件</span></span><br><span class="line">  trigger()&#123;</span><br><span class="line">    <span class="keyword">const</span> key = <span class="built_in">Array</span>.prototype.shift.apply(<span class="built_in">arguments</span>),</span><br><span class="line">      fns = <span class="keyword">this</span>.clientList[key];</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span>(!fns || fns.length === <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">let</span> fn <span class="keyword">of</span> fns)&#123;</span><br><span class="line">        fn.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 移除相关事件</span></span><br><span class="line">  remove(key, fn)&#123;</span><br><span class="line">    <span class="keyword">let</span> fns = <span class="keyword">this</span>.clientList[key];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果之前没有绑定事件</span></span><br><span class="line">    <span class="comment">// 或者没有指明要移除的事件</span></span><br><span class="line">    <span class="comment">// 直接返回</span></span><br><span class="line">    <span class="keyword">if</span>(!fns || !fn)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 反向遍历移除置指定事件函数</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> l = fns.length - <span class="number">1</span>; l &gt;= <span class="number">0</span>; l--)&#123;</span><br><span class="line">      <span class="keyword">let</span> _fn = fns[l];</span><br><span class="line">      <span class="keyword">if</span>(_fn === fn)&#123;</span><br><span class="line">        fns.splice(l, <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为对象动态安装 发布-订阅 功能</span></span><br><span class="line"><span class="keyword">const</span> installEvent = <span class="function">(<span class="params">obj</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> key <span class="keyword">in</span> Event)&#123;</span><br><span class="line">    obj[key] = Event[key];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> salesOffices = &#123;&#125;;</span><br><span class="line">installEvent(salesOffices);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定自定义事件和回调函数</span></span><br><span class="line"></span><br><span class="line">salesOffices.listen(<span class="string">"event01"</span>, fn1 = <span class="function">(<span class="params">price</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Price is"</span>, price, <span class="string">"at event01"</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">salesOffices.listen(<span class="string">"event02"</span>, fn2 = <span class="function">(<span class="params">price</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Price is"</span>, price, <span class="string">"at event02"</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">salesOffices.trigger(<span class="string">"event01"</span>, <span class="number">1000</span>);</span><br><span class="line">salesOffices.trigger(<span class="string">"event02"</span>, <span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">salesOffices.remove(<span class="string">"event01"</span>, fn1);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出: false</span></span><br><span class="line"><span class="comment">// 说明删除成功</span></span><br><span class="line"><span class="built_in">console</span>.log(salesOffices.trigger(<span class="string">"event01"</span>, <span class="number">1000</span>));</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="状态模式"><a href="#状态模式" class="headerlink" title="状态模式"></a>状态模式</h2><p>状态模式：对象行为是基于状态来改变的。</p>
<p>内部的状态转化，导致了行为表现形式不同。<br>所以，用户在外面看起来，好像是修改了行为。</p>
<h3 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h3><p>优点</p>
<blockquote>
<p>封装了转化规则，对于大量分支语句，可以考虑使用状态类进一步封装。<br>每个状态都是确定的，所以对象行为是可控的。</p>
</blockquote>
<p>缺点</p>
<blockquote>
<p>状态模式的关键是将事物的状态都封装成单独的类，这个类的各种方法就是“此种状态对应的表现行为”。<br>因此，状态类会增加程序开销。</p>
</blockquote>
<p>在JavaScript中，可以直接用JSON对象来代替状态类。</p>
<p>下面代码展示的就是FSM（有限状态机）里面有3种状态：download、pause、deleted。<br>控制状态转化的代码也在其中。</p>
<p>DownLoad类就是，常说的Context对象，它的行为会随着状态的改变而改变。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> FSM = <span class="function">(<span class="params">(</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> currenState = <span class="string">"download"</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    download: &#123;</span><br><span class="line">      click: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"暂停下载"</span>);</span><br><span class="line">        currenState = <span class="string">"pause"</span>;</span><br><span class="line">      &#125;,</span><br><span class="line">      del: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"先暂停, 再删除"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    pause: &#123;</span><br><span class="line">      click: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"继续下载"</span>);</span><br><span class="line">        currenState = <span class="string">"download"</span>;</span><br><span class="line">      &#125;,</span><br><span class="line">      del: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"删除任务"</span>);</span><br><span class="line">        currenState = <span class="string">"deleted"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    deleted: &#123;</span><br><span class="line">      click: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"任务已删除, 请重新开始"</span>);</span><br><span class="line">      &#125;,</span><br><span class="line">      del: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"任务已删除"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    getState: <span class="function"><span class="params">()</span> =&gt;</span> currenState</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Download</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(fsm) &#123;</span><br><span class="line">    <span class="keyword">this</span>.fsm = fsm;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleClick() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; fsm &#125; = <span class="keyword">this</span>;</span><br><span class="line">    fsm[fsm.getState()].click();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hanldeDel() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; fsm &#125; = <span class="keyword">this</span>;</span><br><span class="line">    fsm[fsm.getState()].del();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开始下载</span></span><br><span class="line"><span class="keyword">let</span> download = <span class="keyword">new</span> Download(FSM);</span><br><span class="line"></span><br><span class="line">download.handleClick(); <span class="comment">// 暂停下载</span></span><br><span class="line">download.handleClick(); <span class="comment">// 继续下载</span></span><br><span class="line">download.hanldeDel(); <span class="comment">// 下载中，无法执行删除操作</span></span><br><span class="line">download.handleClick(); <span class="comment">// 暂停下载</span></span><br><span class="line">download.hanldeDel(); <span class="comment">// 删除任务</span></span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="装饰者模式"><a href="#装饰者模式" class="headerlink" title="装饰者模式"></a>装饰者模式</h2><p>装饰者模式：在不改变对象自身的基础上，动态地添加功能代码。</p>
<p>根据描述，装饰者显然比继承等方式更灵活，而且不污染原来的代码，代码逻辑松耦合。</p>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>装饰者模式由于松耦合，多用于一开始不确定对象的功能、或者对象功能经常变动的时候。<br>尤其是在参数检查、参数拦截等场景。</p>
<p>ES6的装饰器语法规范只是在“提案阶段”，而且不能装饰普通函数或者箭头函数。</p>
<p>下面的代码，addDecorator可以为指定函数增加装饰器。</p>
<p>其中，装饰器的触发可以在函数运行之前，也可以在函数运行之后。</p>
<p>注意：装饰器需要保存函数的运行结果，并且返回。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> addDecorator = <span class="function">(<span class="params">fn, before, after</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> isFn = <span class="function"><span class="params">fn</span> =&gt;</span> <span class="keyword">typeof</span> fn === <span class="string">"function"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!isFn(fn)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> result;</span><br><span class="line">    <span class="comment">// 按照顺序执行“装饰函数”</span></span><br><span class="line">    isFn(before) &amp;&amp; before(...args);</span><br><span class="line">    <span class="comment">// 保存返回函数结果</span></span><br><span class="line">    isFn(fn) &amp;&amp; (result = fn(...args));</span><br><span class="line">    isFn(after) &amp;&amp; after(...args);</span><br><span class="line">    <span class="comment">// 最后返回结果</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************以下是测试代码******************/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> beforeHello = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Before Hello, args are <span class="subst">$&#123;args&#125;</span>`</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hello = <span class="function">(<span class="params">name = <span class="string">"user"</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Hello, <span class="subst">$&#123;name&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">return</span> name;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> afterHello = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`After Hello, args are <span class="subst">$&#123;args&#125;</span>`</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wrappedHello = addDecorator(hello, beforeHello, afterHello);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> result = wrappedHello(<span class="string">"godbmw.com"</span>);   <span class="comment">//高阶函数</span></span><br><span class="line"><span class="built_in">console</span>.log(result);</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="责任链模式"><a href="#责任链模式" class="headerlink" title="责任链模式"></a>责任链模式</h2><p>责任链模式：多个对象均有机会处理请求，从而解除发送者和接受者之间的耦合关系。这些对象连接成为链式结构，每个节点转发请求，直到有对象处理请求为止。</p>
<p>其核心就是：请求者不必知道是谁哪个节点对象处理的请求。如果当前不符合终止条件，那么把请求转发给下一个节点处理。</p>
<p>而当需求具有“传递”的性质时（代码中其中一种体现就是：多个if、else if、else if、else嵌套），就可以考虑将每个分支拆分成一个节点对象，拼接成为责任链。</p>
<h3 id="优点与代价"><a href="#优点与代价" class="headerlink" title="优点与代价"></a>优点与代价</h3><p>优点</p>
<blockquote>
<p>可以根据需求变动，任意向责任链中添加 / 删除节点对象<br>没有固定的“开始节点”，可以从任意节点开始</p>
</blockquote>
<p>代价</p>
<blockquote>
<p>责任链最大的代价就是每个节点带来的多余消耗。当责任链过长，很多节点只有传递的作用，而不是真正地处理逻辑。</p>
</blockquote>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>为了方便演示，模拟常见的“日志打印”场景。模拟了 3 种级别的日志输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LogHandler: 普通日志</span><br><span class="line">WarnHandler：警告日志</span><br><span class="line">ErrorHandler：错误日志</span><br></pre></td></tr></table></figure></p>
<p>首先我们会构造“责任链”：LogHandler -&gt; WarnHandler -&gt; ErrorHandler。LogHandler作为链的开始节点。</p>
<p>如果是普通日志，那么就由 LogHandler 处理，停止传播；如果是 Warn 级别的日志，那么 LogHandler 就会自动向下传递，WarnHandler 接收到并且处理，停止传播；Error 级别日志同理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.next = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setNext(handler) &#123;</span><br><span class="line">    <span class="keyword">this</span>.next = handler;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(...props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(...props);</span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">"log"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handle(level, msg) &#123;</span><br><span class="line">    <span class="keyword">if</span> (level === <span class="keyword">this</span>.name) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`LOG: <span class="subst">$&#123;msg&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.next &amp;&amp; <span class="keyword">this</span>.next.handle(...arguments);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WarnHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(...props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(...props);</span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">"warn"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handle(level, msg) &#123;</span><br><span class="line">    <span class="keyword">if</span> (level === <span class="keyword">this</span>.name) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`WARN: <span class="subst">$&#123;msg&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.next &amp;&amp; <span class="keyword">this</span>.next.handle(...arguments);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ErrorHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(...props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(...props);</span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">"error"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handle(level, msg) &#123;</span><br><span class="line">    <span class="keyword">if</span> (level === <span class="keyword">this</span>.name) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`ERROR: <span class="subst">$&#123;msg&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.next &amp;&amp; <span class="keyword">this</span>.next.handle(...arguments);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************以下是测试代码******************/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> logHandler = <span class="keyword">new</span> LogHandler();</span><br><span class="line"><span class="keyword">let</span> warnHandler = <span class="keyword">new</span> WarnHandler();</span><br><span class="line"><span class="keyword">let</span> errorHandler = <span class="keyword">new</span> ErrorHandler();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置下一个处理的节点</span></span><br><span class="line">logHandler.setNext(warnHandler);</span><br><span class="line">warnHandler.setNext(errorHandler);</span><br><span class="line"></span><br><span class="line">logHandler.handle(<span class="string">"error"</span>, <span class="string">"Some error occur"</span>);</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="享元模式"><a href="#享元模式" class="headerlink" title="享元模式"></a>享元模式</h2><p>享元模式：运用共享技术来减少创建对象的数量，从而减少内存占用、提高性能。</p>
<p>享元模式提醒我们将一个对象的属性划分为内部和外部状态。<br>内部状态：可以被对象集合共享，通常不会改变<br>外部状态：根据应用场景经常改变<br>享元模式是利用时间换取空间的优化模式。</p>
<h3 id="应用场景-1"><a href="#应用场景-1" class="headerlink" title="应用场景"></a>应用场景</h3><p>享元模式虽然名字听起来比较高深，但是实际使用非常容易：只要是需要大量创建重复的类的代码块，均可以使用享元模式抽离内部/外部状态，减少重复类的创建。</p>
<p>为了显示它的强大，下面的代码是简单地实现了大家耳熟能详的“对象池”，以彰显这种设计模式的魅力。</p>
<h3 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h3><p>这里利用javascript实现了一个“通用对象池”类–ObjectPool。这个类管理一个装载空闲对象的数组，如果外部需要一个对象，直接从对象池中获取，而不是通过new操作。</p>
<p>对象池可以大量减少重复创建相同的对象，从而节省了系统内存，提高运行效率。</p>
<p>为了形象说明“享元模式”在“对象池”实现和应用，特别准备了模拟了File类，并且模拟了“文件下载”操作。</p>
<p>通过阅读下方代码可以发现：对于File类，内部状态是pool属性和download方法；外部状态是name和src(文件名和文件链接)。借助对象池，实现了File类的复用。</p>
<blockquote>
<p>注：为了方便演示，Javascript实现的是并发操作。输出结果略有不同。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对象池</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectPool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>._pool = []; <span class="comment">//</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建对象</span></span><br><span class="line">  create(Obj) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._pool.length === <span class="number">0</span></span><br><span class="line">      ? <span class="keyword">new</span> Obj(<span class="keyword">this</span>) <span class="comment">// 对象池中没有空闲对象，则创建一个新的对象</span></span><br><span class="line">      : <span class="keyword">this</span>._pool.shift(); <span class="comment">// 对象池中有空闲对象，直接取出，无需再次创建</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 对象回收</span></span><br><span class="line">  recover(obj) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._pool.push(obj);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 对象池大小</span></span><br><span class="line">  size() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._pool.length;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模拟文件对象</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(pool) &#123;</span><br><span class="line">    <span class="keyword">this</span>.pool = pool;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 模拟下载操作</span></span><br><span class="line">  download() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`+ 从 <span class="subst">$&#123;<span class="keyword">this</span>.src&#125;</span> 开始下载 <span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>`</span>);</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`- <span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span> 下载完毕`</span>); <span class="comment">// 下载完毕后, 将对象重新放入对象池</span></span><br><span class="line">      <span class="keyword">this</span>.pool.recover(<span class="keyword">this</span>);</span><br><span class="line">    &#125;, <span class="number">100</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/****************** 以下是测试函数 **********************/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> objPool = <span class="keyword">new</span> ObjectPool();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> file1 = objPool.create(File);</span><br><span class="line">file1.name = <span class="string">"文件1"</span>;</span><br><span class="line">file1.src = <span class="string">"https://download1.com"</span>;</span><br><span class="line">file1.download();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> file2 = objPool.create(File);</span><br><span class="line">file2.name = <span class="string">"文件2"</span>;</span><br><span class="line">file2.src = <span class="string">"https://download2.com"</span>;</span><br><span class="line">file2.download();</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> file3 = objPool.create(File);</span><br><span class="line">  file3.name = <span class="string">"文件3"</span>;</span><br><span class="line">  file3.src = <span class="string">"https://download3.com"</span>;</span><br><span class="line">  file3.download();</span><br><span class="line">&#125;, <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">setTimeout(</span><br><span class="line">  () =&gt;</span><br><span class="line">    <span class="built_in">console</span>.log(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;<span class="string">"*"</span>.repeat(<span class="number">50</span>)&#125;</span>\n下载了3个文件，但其实只创建了<span class="subst">$&#123;objPool.size()&#125;</span>个对象`</span></span><br><span class="line">    ),</span><br><span class="line">  <span class="number">1000</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>输出结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+ 从 https://download1.com 开始下载 文件1</span><br><span class="line">+ 从 https://download2.com 开始下载 文件2</span><br><span class="line">- 文件1 下载完毕</span><br><span class="line">- 文件2 下载完毕</span><br><span class="line">+ 从 https://download3.com 开始下载 文件3</span><br><span class="line">- 文件3 下载完毕</span><br><span class="line">**************************************************</span><br><span class="line">下载了3个文件，但其实只创建了2个对象</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="组合模式"><a href="#组合模式" class="headerlink" title="组合模式"></a>组合模式</h2><p>组合模式，将对象组合成树形结构以表示“部分-整体”的层次结构。</p>
<p>用小的子对象构造更大的父对象，而这些子对象也由更小的子对象构成<br>单个对象和组合对象对于用户暴露的接口具有一致性，而同种接口不同表现形式亦体现了多态性</p>
<h3 id="应用场景-2"><a href="#应用场景-2" class="headerlink" title="应用场景"></a>应用场景</h3><p>组合模式可以在需要针对“树形结构”进行操作的应用中使用，例如扫描文件夹、渲染网站导航结构等等。</p>
<h3 id="代码实现-2"><a href="#代码实现-2" class="headerlink" title="代码实现"></a>代码实现</h3><p>这里用代码模拟文件扫描功能，封装了File和Folder两个类。在组合模式下，用户可以向Folder类嵌套File或者Folder来模拟真实的“文件目录”的树结构。</p>
<p>同时，两个类都对外提供了scan接口，File下的scan是扫描文件，Folder下的scan是调用子文件夹和子文件的scan方法。整个过程采用的是深度优先。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(name) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name || <span class="string">"File"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  add() &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"文件夹下面不能添加文件"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  scan() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"扫描文件: "</span> + <span class="keyword">this</span>.name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文件夹类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Folder</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(name) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name || <span class="string">"Folder"</span>;</span><br><span class="line">    <span class="keyword">this</span>.files = [];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  add(file) &#123;</span><br><span class="line">    <span class="keyword">this</span>.files.push(file);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  scan() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"扫描文件夹: "</span> + <span class="keyword">this</span>.name);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> file <span class="keyword">of</span> <span class="keyword">this</span>.files) &#123;</span><br><span class="line">      file.scan();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> home = <span class="keyword">new</span> Folder(<span class="string">"用户根目录"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> folder1 = <span class="keyword">new</span> Folder(<span class="string">"第一个文件夹"</span>),</span><br><span class="line">  folder2 = <span class="keyword">new</span> Folder(<span class="string">"第二个文件夹"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> file1 = <span class="keyword">new</span> File(<span class="string">"1号文件"</span>),</span><br><span class="line">  file2 = <span class="keyword">new</span> File(<span class="string">"2号文件"</span>),</span><br><span class="line">  file3 = <span class="keyword">new</span> File(<span class="string">"3号文件"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将文件添加到对应文件夹中</span></span><br><span class="line">folder1.add(file1);</span><br><span class="line"></span><br><span class="line">folder2.add(file2);</span><br><span class="line">folder2.add(file3);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将文件夹添加到更高级的目录文件夹中</span></span><br><span class="line">home.add(folder1);</span><br><span class="line">home.add(folder2);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描目录文件夹</span></span><br><span class="line">home.scan();</span><br></pre></td></tr></table></figure>
<p>执行<code>$ node main.js</code>，最终输出结果是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">扫描文件夹: 用户根目录</span><br><span class="line">扫描文件夹: 第一个文件夹</span><br><span class="line">扫描文件: 1号文件</span><br><span class="line">扫描文件夹: 第二个文件夹</span><br><span class="line">扫描文件: 2号文件</span><br><span class="line">扫描文件: 3号文件</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h2><p>命令模式是一种数据驱动的设计模式，它属于行为型模式。</p>
<p>请求以命令的形式包裹在对象中，并传给调用对象。<br>调用对象寻找可以处理该命令的合适的对象，并把该命令传给相应的对象。<br>该对象执行命令。<br>在这三步骤中，分别有3个不同的主体：发送者、传递者和执行者。在实现过程中，需要特别关注。</p>
<h3 id="应用场景-3"><a href="#应用场景-3" class="headerlink" title="应用场景"></a>应用场景</h3><p>有时候需要向某些对象发送请求，但是又不知道请求的接受者是谁，更不知道被请求的操作是什么。此时，命令模式就是以一种松耦合的方式来设计程序。</p>
<p>setCommand方法为按钮指定了命令对象，命令对象为调用者（按钮）找到了接收者（MenuBar），并且执行了相关操作。而按钮本身并不需要关心接收者和接受操作。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接受到命令，执行相关操作</span></span><br><span class="line"><span class="keyword">const</span> MenuBar = &#123;</span><br><span class="line">  refresh()&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"刷新菜单页面"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 命令对象，execute方法就是执行相关命令</span></span><br><span class="line"><span class="keyword">const</span> RefreshMenuBarCommand = <span class="function"><span class="params">receiver</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    execute()&#123;</span><br><span class="line">      receiver.refresh();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为按钮对象指定对应的 对象 </span></span><br><span class="line"><span class="keyword">const</span> setCommand = <span class="function">(<span class="params">button, command</span>) =&gt;</span> &#123;</span><br><span class="line">  button.onclick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    command.execute();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> refreshMenuBarCommand = RefreshMenuBarCommand(MenuBar);</span><br><span class="line"><span class="keyword">let</span> button = <span class="built_in">document</span>.querySelector(<span class="string">"button"</span>);</span><br><span class="line">setCommand(button, refreshMenuBarCommand);</span><br></pre></td></tr></table></figure>
<p>下面是同级目录的html代码，在谷歌浏览器中打开创建的index.html，并且打开控制台，即可看到效果。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>命令模式<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span>&gt;</span>按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./main.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="迭代器模式"><a href="#迭代器模式" class="headerlink" title="迭代器模式"></a>迭代器模式</h2><p>迭代器模式是指提供一种方法顺序访问一个集合对象的各个元素，使用者不需要了解集合对象的底层实现。</p>
<h3 id="内部迭代器和外部迭代器"><a href="#内部迭代器和外部迭代器" class="headerlink" title="内部迭代器和外部迭代器"></a>内部迭代器和外部迭代器</h3><p>内部迭代器：封装的方法完全接手迭代过程，外部只需要一次调用。</p>
<p>外部迭代器：用户必须显式地请求迭代下一元素。熟悉C++的朋友，可以类比C++内置对象的迭代器的 end()、next()等方法。</p>
<blockquote>
<p>这里实现的是一个外部迭代器。需要实现边界判断函数、元素获取函数和更新索引函数。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Iterator = <span class="function"><span class="params">obj</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> current = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> next = <span class="function"><span class="params">()</span> =&gt;</span> current += <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">let</span> end = <span class="function"><span class="params">()</span> =&gt;</span> current &gt;= obj.length;</span><br><span class="line">  <span class="keyword">let</span> get = <span class="function"><span class="params">()</span> =&gt;</span> obj[current];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    next,</span><br><span class="line">    end,</span><br><span class="line">    get</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myIter = Iterator([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="keyword">while</span>(!myIter.end()) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(myIter.get())</span><br><span class="line">  myIter.next();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h2><p>代理模式的定义：为一个对象提供一种代理以方便对它的访问。</p>
<p>代理模式可以解决避免对一些对象的直接访问，以此为基础，常见的有保护代理和虚拟代理。保护代理可以在代理中直接拒绝对对象的访问；虚拟代理可以延迟访问到真正需要的时候，以节省程序开销。</p>
<h3 id="代理模式优缺点"><a href="#代理模式优缺点" class="headerlink" title="代理模式优缺点"></a>代理模式优缺点</h3><p>代理模式有高度解耦、对象保护、易修改等优点。</p>
<p>同样地，因为是通过“代理”访问对象，因此开销会更大，时间也会更慢。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">const</span> myImg = &#123;</span><br><span class="line">  setSrc(imgNode, src) &#123;</span><br><span class="line">    imgNode.src = src;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 利用代理模式实现图片懒加载</span></span><br><span class="line"><span class="keyword">const</span> proxyImg = &#123;</span><br><span class="line">  setSrc(imgNode, src) &#123;</span><br><span class="line">    myImg.setSrc(imgNode, <span class="string">"./image.png"</span>); <span class="comment">// NO1. 加载占位图片并且将图片放入&lt;img&gt;元素</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> img = <span class="keyword">new</span> Image();</span><br><span class="line">    img.onload = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      myImg.setSrc(imgNode, src); <span class="comment">// NO3. 完成加载后, 更新 &lt;img&gt; 元素中的图片</span></span><br><span class="line">    &#125;;</span><br><span class="line">    img.src = src; <span class="comment">// NO2. 加载真正需要的图片</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> imgNode = <span class="built_in">document</span>.createElement(<span class="string">"img"</span>),</span><br><span class="line">  imgSrc =</span><br><span class="line">    <span class="string">"https://upload-images.jianshu.io/upload_images/5486602-5cab95ba00b272bd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp"</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.body.appendChild(imgNode);</span><br><span class="line"></span><br><span class="line">proxyImg.setSrc(imgNode, imgSrc);</span><br></pre></td></tr></table></figure></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- main.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>每天一个设计模式 · 代理模式<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./main.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="策略模式"><a href="#策略模式" class="headerlink" title="策略模式"></a>策略模式</h2><p>策略模式定义：就是能够把一系列“可互换的”算法封装起来，并根据用户需求来选择其中一种。</p>
<p>策略模式实现的核心就是：将算法的使用和算法的实现分离。算法的实现交给策略类。算法的使用交给环境类，环境类会根据不同的情况选择合适的算法。</p>
<h3 id="策略模式优缺点"><a href="#策略模式优缺点" class="headerlink" title="策略模式优缺点"></a>策略模式优缺点</h3><p>在使用策略模式的时候，需要了解所有的“策略”（strategy）之间的异同点，才能选择合适的“策略”进行调用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 策略类</span></span><br><span class="line"><span class="keyword">const</span> strategies = &#123;</span><br><span class="line">  A() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"This is stragegy A"</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  B() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"This is stragegy B"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 环境类</span></span><br><span class="line"><span class="keyword">const</span> context = <span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> strategies[name]();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用策略A</span></span><br><span class="line">context(<span class="string">"A"</span>);</span><br><span class="line"><span class="comment">// 调用策略B</span></span><br><span class="line">context(<span class="string">"B"</span>);</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h2><p>单例模式定义：保证一个类仅有一个实例，并提供访问此实例的全局访问点。</p>
<h3 id="单例模式用途"><a href="#单例模式用途" class="headerlink" title="单例模式用途"></a>单例模式用途</h3><p>如果一个类负责连接数据库的线程池、日志记录逻辑等等，此时需要单例模式来保证对象不被重复创建，以达到降低开销的目的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Singleton = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">Singleton.getInstance = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 由于es6没有静态类型,故闭包: 函数外部无法访问 instance</span></span><br><span class="line">  <span class="keyword">let</span> instance = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 检查是否存在实例</span></span><br><span class="line">    <span class="keyword">if</span> (!instance) &#123;</span><br><span class="line">      instance = <span class="keyword">new</span> Singleton();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> s1 = Singleton.getInstance();</span><br><span class="line"><span class="keyword">let</span> s2 = Singleton.getInstance();</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(s1 === s2);</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/02/JS实现多行溢出省略号思路/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/02/JS实现多行溢出省略号思路/" itemprop="url">JS实现多行溢出省略号思路</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-02T20:43:06+08:00">
                2019-01-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>说起多行溢出省略号,用CSS实现最简单<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.one-line</span> &#123;</span><br><span class="line">	<span class="attribute">display</span>: -webkit-box <span class="meta">!important</span>;</span><br><span class="line">	<span class="attribute">overflow</span>: hidden;</span><br><span class="line">	<span class="attribute">text-overflow</span>: ellipsis;</span><br><span class="line">	<span class="attribute">word-break</span>: break-all;</span><br><span class="line">	<span class="attribute">-webkit-box-orient</span>: vertical;</span><br><span class="line">	<span class="attribute">-webkit-line-clamp</span>: <span class="number">1</span>;</span><br><span class="line">	<span class="comment">/*clip  修剪文本。*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.more-line</span> &#123;</span><br><span class="line">	<span class="attribute">display</span>: -webkit-box <span class="meta">!important</span>;</span><br><span class="line">	<span class="attribute">overflow</span>: hidden;</span><br><span class="line">	<span class="attribute">text-overflow</span>: ellipsis;</span><br><span class="line">	<span class="attribute">word-break</span>: break-all;</span><br><span class="line">	<span class="attribute">-webkit-box-orient</span>: vertical;</span><br><span class="line">	<span class="attribute">-webkit-line-clamp</span>: <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong> 下面就摸索下用JS如何实现：</strong></p>
<h3 id="Github-DEMO"><a href="#Github-DEMO" class="headerlink" title="Github DEMO"></a><a href="https://libin1991.github.io/vue-text-clamp/demo/?lang=zh" target="_blank" rel="noopener"><font color="#ff0000">Github DEMO</font></a></h3><p><img src="/2019/01/02/JS实现多行溢出省略号思路/3.gif" alt=""></p>
<h3 id="先看两个API："><a href="#先看两个API：" class="headerlink" title="先看两个API："></a>先看两个API：</h3><p><strong> getClientRects </strong>获取元素占据页面的所有矩形区域 :</p>
<blockquote>
<p>getClientRects 返回一个TextRectangle集合，就是TextRectangleList对象。TextRectangle对象包含了, top left bottom right width height 六个属性TextRectangle对于文本对象，W3C提供了一个 TextRectangle 对象，这个对象是对文本区域的一个解释。这里的文本区域只针对inline<br> 元素，比如：a, span, em这类标签元素。浏览器差异getClientRects() 最先由MS IE提出，后被W3C引入并制订了标准。目前主流浏览器都支持该标准，而IE只支持TextRectangle的top left bottom right四个属性。IE下可以通过right-left来计算width、bottom-top来计算height。ie 和非ie浏览器在使用getClientRects还是有些差别的，ie获取TextRectangleList的范围很大。而非ie获取的范围比较小，<br> 只有display:inline的对象才能获取到TextRectangleList，例如em i span 等标签。应用场景getClientRects常用于获取鼠标的位置，如放大镜效果。微博的用户信息卡也是通过改方法获得的。<br>总结：<font color="#ff0000">只能用于行内元素,返回每一行的信息，返回信息和getBoundingClientRect返回类似。 </font></p>
</blockquote>
<p>DEMO：<br> <img src="/2019/01/02/JS实现多行溢出省略号思路/2.png" alt=""><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">			* &#123;</span></span><br><span class="line"><span class="undefined">				padding: 0px;</span></span><br><span class="line"><span class="undefined">				margin: 0px;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="undefined">			div &#123;</span></span><br><span class="line"><span class="undefined">				width: 80%;</span></span><br><span class="line"><span class="undefined">				height: 90px;</span></span><br><span class="line"><span class="undefined">				border: 1px solid red;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="css">			<span class="selector-id">#test</span>&#123;</span></span><br><span class="line"><span class="css">				<span class="selector-tag">width</span><span class="selector-pseudo">:400px</span>;</span></span><br><span class="line"><span class="undefined">				height: 10px;</span></span><br><span class="line"><span class="undefined">				background: red;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"main"</span>&gt;</span>返回值是ClientRect对象集合，该对象是与该元素相关的CSS边框。每个ClientRect对象包含一组描述该边框的只读属性——left、top、right和bottom，单位为像素，这些属性值是相对于视口的top-left的。即使当表格的标题在表格的边框外面，该标题仍会被计算在内。<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"test"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">		<span class="built_in">console</span>.log(<span class="built_in">document</span>.getElementById(<span class="string">"main"</span>).getClientRects());</span></span><br><span class="line"><span class="undefined">		 </span></span><br><span class="line"><span class="undefined">	</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><strong>getBoundingClientRect获取元素位置 </strong>getBoundingClientRect用于获得页面中某个元素的左，上，右和下分别相对浏览器视窗的位置。getBoundingClientRect是DOM元素到浏览器可视范围的距离（不包含文档卷起的部分）。该函数返回一个Object对象，该对象有6个属性：top,lef,right,bottom,width,height；这里的top、left和css中的理解很相似，width、height是元素自身的宽高，但是right，bottom和css中的理解有点不一样。right是指元素右边界距窗口最左边的距离，bottom是指元素下边界距窗口最上面的距离。</p>
<blockquote>
<p>getBoundingClientRect()最先是IE的私有属性，现在已经是一个W3C标准。所以你不用当心浏览器兼容问题，不过还是有区别的：IE只返回top,lef,right,bottom四个值，</p>
</blockquote>
<p>返回差异：</p>
<p><strong>getClientRects 和 getBoundingClientRect 的区别返回类型差异：
</strong>getClientRects 返回一个TextRectangle集合，就是TextRectangleList对象。getBoundingClientRect返回 一个TextRectangle对象，即使DOM里没有文本也能返回TextRectangle对象.浏览器差异:除了safari，firefox2.0外所有浏览器都支持getClientRects和getBoundingClientRect，firefox 3.1给TextRectangle增加了 width 和 height。ie 和非ie浏览器在使用getClientRects还是有些差别的，ie获取TextRectangleList的范围很大。而非ie获取的范围比较小， 只有display:inline的对象才能获取到TextRectangleList，例如em i span 等标签。通过测试，至少Chrome 2+\Safari 4\Firefox3.5\0pera 9.63+已经支持getBoundingClientRect方法。使用场景差异:出于浏览器兼容的考虑，现在用得最多的是getBoundingClientRect，经常用来获取一个element元素的viewport坐标。<br> <img src="/2019/01/02/JS实现多行溢出省略号思路/1.jpg" alt=""></p>
<h3 id="Vue多行溢出省略号"><a href="#Vue多行溢出省略号" class="headerlink" title="Vue多行溢出省略号"></a>Vue多行溢出省略号</h3><blockquote>
<p>监听DOM尺寸变化 </p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; addListener, removeListener &#125; <span class="keyword">from</span> <span class="string">'resize-detector'</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">this</span>.autoresize) &#123;</span><br><span class="line">    <span class="keyword">let</span> resizeCallback = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.update()</span><br><span class="line">    &#125;</span><br><span class="line">    addListener(<span class="keyword">this</span>.$el, resizeCallback)   <span class="comment">//监听</span></span><br><span class="line">    <span class="keyword">this</span>.unregisterResizeCallback = <span class="function"><span class="params">()</span> =&gt;</span> &#123;   <span class="comment">//移除</span></span><br><span class="line">      removeListener(<span class="keyword">this</span>.$el, resizeCallback)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>判断是否溢出</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">isOverflow () &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.maxLines &amp;&amp; !<span class="keyword">this</span>.maxHeight) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.maxLines) &#123;   </span><br><span class="line">      <span class="comment">//获取全部显示的行数</span></span><br><span class="line">      <span class="keyword">let</span> actualLines = <span class="keyword">this</span>.$refs.content.getClientRects().length</span><br><span class="line">      <span class="keyword">if</span> (actualLines &gt; <span class="keyword">this</span>.maxLines) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.maxHeight) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.$el.scrollHeight &gt; <span class="keyword">this</span>.$el.offsetHeight) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<blockquote>
<p>二分查找多行截取字符临界值</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">moveEdge (steps) &#123;</span><br><span class="line">  <span class="keyword">this</span>.clampAt(<span class="keyword">this</span>.offset + steps)</span><br><span class="line">&#125;,</span><br><span class="line">clampAt (offset) &#123;</span><br><span class="line">  <span class="keyword">this</span>.offset = offset</span><br><span class="line">  <span class="keyword">this</span>.applyChange()</span><br><span class="line">&#125;,</span><br><span class="line">applyChange () &#123;</span><br><span class="line">  <span class="keyword">this</span>.$refs.text.textContent = <span class="keyword">this</span>.realText</span><br><span class="line">&#125;,</span><br><span class="line">stepToFit () &#123;</span><br><span class="line">  <span class="keyword">this</span>.fill()</span><br><span class="line">  <span class="keyword">this</span>.clamp()</span><br><span class="line">&#125;,</span><br><span class="line">fill () &#123;</span><br><span class="line">  <span class="keyword">while</span> (!<span class="keyword">this</span>.isOverflow() &amp;&amp; <span class="keyword">this</span>.offset &lt; <span class="keyword">this</span>.text.length) &#123;</span><br><span class="line">    <span class="keyword">this</span>.moveEdge(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">clamp () &#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">this</span>.isOverflow() &amp;&amp; <span class="keyword">this</span>.offset &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.moveEdge(<span class="number">-1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">search (...range) &#123;</span><br><span class="line">  <span class="keyword">let</span> [<span class="keyword">from</span> = <span class="number">0</span>, to = <span class="keyword">this</span>.offset] = range</span><br><span class="line">  <span class="keyword">if</span> (to - <span class="keyword">from</span> &lt;= <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.stepToFit()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> target = <span class="built_in">Math</span>.floor((to + <span class="keyword">from</span>) / <span class="number">2</span>)    <span class="comment">//从中间找临界值</span></span><br><span class="line">  <span class="keyword">this</span>.clampAt(target)</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.isOverflow()) &#123;</span><br><span class="line">    <span class="keyword">this</span>.search(<span class="keyword">from</span>, target)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.search(target, to)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="完整代码："><a href="#完整代码：" class="headerlink" title="完整代码："></a>完整代码：</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; addListener, removeListener &#125; <span class="keyword">from</span> <span class="string">'resize-detector'</span></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UPDATE_TRIGGERS = [<span class="string">'maxLines'</span>, <span class="string">'maxHeight'</span>, <span class="string">'ellipsis'</span>]</span><br><span class="line"><span class="keyword">const</span> INIT_TRIGGERS = [<span class="string">'tag'</span>, <span class="string">'text'</span>, <span class="string">'autoresize'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  name: <span class="string">'vue-clamper'</span>,</span><br><span class="line">  props: &#123;</span><br><span class="line">    tag: &#123;</span><br><span class="line">      type: <span class="built_in">String</span>,</span><br><span class="line">      <span class="keyword">default</span>: <span class="string">'div'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    autoresize: &#123;</span><br><span class="line">      type: <span class="built_in">Boolean</span>,</span><br><span class="line">      <span class="keyword">default</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    maxLines: <span class="built_in">Number</span>,</span><br><span class="line">    maxHeight: [<span class="built_in">String</span>, <span class="built_in">Number</span>],</span><br><span class="line">    ellipsis: &#123;</span><br><span class="line">      type: <span class="built_in">String</span>,</span><br><span class="line">      <span class="keyword">default</span>: <span class="string">'…'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    expanded: <span class="built_in">Boolean</span></span><br><span class="line">  &#125;,</span><br><span class="line">  data () &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      offset: <span class="literal">null</span>,</span><br><span class="line">      text: <span class="keyword">this</span>.getText(),</span><br><span class="line">      localExpanded: !!<span class="keyword">this</span>.expanded</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  computed: &#123;</span><br><span class="line">    clampedText () &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.text.slice(<span class="number">0</span>, <span class="keyword">this</span>.offset) + <span class="keyword">this</span>.ellipsis</span><br><span class="line">    &#125;,</span><br><span class="line">    isClamped () &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.text) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.offset !== <span class="keyword">this</span>.text.length</span><br><span class="line">    &#125;,</span><br><span class="line">    realText () &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.isClamped ? <span class="keyword">this</span>.clampedText : <span class="keyword">this</span>.text</span><br><span class="line">    &#125;,</span><br><span class="line">    realMaxHeight () &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.localExpanded) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> &#123; maxHeight &#125; = <span class="keyword">this</span></span><br><span class="line">      <span class="keyword">if</span> (!maxHeight) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">typeof</span> maxHeight === <span class="string">'number'</span> ? <span class="string">`<span class="subst">$&#123;maxHeight&#125;</span>px`</span> : maxHeight</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  watch: &#123;</span><br><span class="line">    expanded (val) &#123;</span><br><span class="line">      <span class="keyword">this</span>.localExpanded = val</span><br><span class="line">    &#125;,</span><br><span class="line">    localExpanded (val) &#123;</span><br><span class="line">      <span class="keyword">if</span> (val) &#123;</span><br><span class="line">        <span class="keyword">this</span>.clampAt(<span class="keyword">this</span>.text.length)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.update()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.expanded !== val) &#123;</span><br><span class="line">        <span class="keyword">this</span>.$emit(<span class="string">'update:expanded'</span>, val)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted () &#123;</span><br><span class="line">    <span class="keyword">this</span>.init()</span><br><span class="line"></span><br><span class="line">    INIT_TRIGGERS.forEach(<span class="function"><span class="params">prop</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.$watch(prop, <span class="keyword">this</span>.init)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    UPDATE_TRIGGERS.forEach(<span class="function"><span class="params">prop</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.$watch(prop, <span class="keyword">this</span>.update)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  updated () &#123;</span><br><span class="line">    <span class="keyword">this</span>.text = <span class="keyword">this</span>.getText()</span><br><span class="line">    <span class="keyword">this</span>.applyChange()</span><br><span class="line">  &#125;,</span><br><span class="line">  beforeDestroy () &#123;</span><br><span class="line">    <span class="keyword">this</span>.cleanUp()</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    init () &#123;</span><br><span class="line">      <span class="keyword">let</span> contents = <span class="keyword">this</span>.$slots.default</span><br><span class="line">      <span class="keyword">if</span> (!contents) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(contents) &amp;&amp; contents.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        Vue.util.warn(</span><br><span class="line">          <span class="string">'VueClamper only supports clamping plain text content.'</span>,</span><br><span class="line">          <span class="keyword">this</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> [content] = contents</span><br><span class="line">      <span class="keyword">if</span> (content &amp;&amp; content.tag) &#123;</span><br><span class="line">        Vue.util.warn(</span><br><span class="line">          <span class="string">'VueClamper only supports clamping plain text content.'</span>,</span><br><span class="line">          <span class="keyword">this</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.offset = <span class="keyword">this</span>.text.length</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.cleanUp()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.autoresize) &#123;</span><br><span class="line">        <span class="keyword">let</span> resizeCallback = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.update()</span><br><span class="line">        &#125;</span><br><span class="line">        addListener(<span class="keyword">this</span>.$el, resizeCallback)</span><br><span class="line">        <span class="keyword">this</span>.unregisterResizeCallback = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          removeListener(<span class="keyword">this</span>.$el, resizeCallback)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.update()</span><br><span class="line">    &#125;,</span><br><span class="line">    update () &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.localExpanded) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.applyChange()</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.isOverflow() || <span class="keyword">this</span>.isClamped) &#123;</span><br><span class="line">        <span class="keyword">this</span>.search()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    expand () &#123;</span><br><span class="line">      <span class="keyword">this</span>.localExpanded = <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    collapse () &#123;</span><br><span class="line">      <span class="keyword">this</span>.localExpanded = <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    toggle () &#123;</span><br><span class="line">      <span class="keyword">this</span>.localExpanded = !<span class="keyword">this</span>.localExpanded</span><br><span class="line">    &#125;,</span><br><span class="line">    isOverflow () &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.maxLines &amp;&amp; !<span class="keyword">this</span>.maxHeight) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.maxLines) &#123;</span><br><span class="line">        <span class="keyword">let</span> actualLines = <span class="keyword">this</span>.$refs.content.getClientRects().length</span><br><span class="line">        <span class="keyword">if</span> (actualLines &gt; <span class="keyword">this</span>.maxLines) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.maxHeight) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.$el.scrollHeight &gt; <span class="keyword">this</span>.$el.offsetHeight) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    getText () &#123;</span><br><span class="line">      <span class="keyword">let</span> [content] = <span class="keyword">this</span>.$slots.default || []</span><br><span class="line">      <span class="keyword">return</span> content ? content.text : <span class="string">''</span></span><br><span class="line">    &#125;,</span><br><span class="line">    moveEdge (steps) &#123;</span><br><span class="line">      <span class="keyword">this</span>.clampAt(<span class="keyword">this</span>.offset + steps)</span><br><span class="line">    &#125;,</span><br><span class="line">    clampAt (offset) &#123;</span><br><span class="line">      <span class="keyword">this</span>.offset = offset</span><br><span class="line">      <span class="keyword">this</span>.applyChange()</span><br><span class="line">    &#125;,</span><br><span class="line">    applyChange () &#123;</span><br><span class="line">      <span class="keyword">this</span>.$refs.text.textContent = <span class="keyword">this</span>.realText</span><br><span class="line">    &#125;,</span><br><span class="line">    stepToFit () &#123;</span><br><span class="line">      <span class="keyword">this</span>.fill()</span><br><span class="line">      <span class="keyword">this</span>.clamp()</span><br><span class="line">    &#125;,</span><br><span class="line">    fill () &#123;</span><br><span class="line">      <span class="keyword">while</span> (!<span class="keyword">this</span>.isOverflow() &amp;&amp; <span class="keyword">this</span>.offset &lt; <span class="keyword">this</span>.text.length) &#123;</span><br><span class="line">        <span class="keyword">this</span>.moveEdge(<span class="number">1</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    clamp () &#123;</span><br><span class="line">      <span class="keyword">while</span> (<span class="keyword">this</span>.isOverflow() &amp;&amp; <span class="keyword">this</span>.offset &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.moveEdge(<span class="number">-1</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    search (...range) &#123;</span><br><span class="line">      <span class="keyword">let</span> [<span class="keyword">from</span> = <span class="number">0</span>, to = <span class="keyword">this</span>.offset] = range</span><br><span class="line">      <span class="keyword">if</span> (to - <span class="keyword">from</span> &lt;= <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.stepToFit()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> target = <span class="built_in">Math</span>.floor((to + <span class="keyword">from</span>) / <span class="number">2</span>)</span><br><span class="line">      <span class="keyword">this</span>.clampAt(target)</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.isOverflow()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.search(<span class="keyword">from</span>, target)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.search(target, to)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    cleanUp () &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.unregisterResizeCallback) &#123;</span><br><span class="line">        <span class="keyword">this</span>.unregisterResizeCallback()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  render (h) &#123;</span><br><span class="line">    <span class="keyword">let</span> contents = [</span><br><span class="line">      h(</span><br><span class="line">        <span class="string">'span'</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          ref: <span class="string">'text'</span>,</span><br><span class="line">          attrs: &#123;</span><br><span class="line">            <span class="string">'aria-label'</span>: <span class="keyword">this</span>.text.trim()</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">this</span>.realText</span><br><span class="line">      )</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> &#123; expand, collapse, toggle &#125; = <span class="keyword">this</span></span><br><span class="line">    <span class="keyword">let</span> scope = &#123; expand, collapse, toggle &#125;</span><br><span class="line">    <span class="keyword">let</span> before = <span class="keyword">this</span>.$scopedSlots.before</span><br><span class="line">      ? <span class="keyword">this</span>.$scopedSlots.before(scope)</span><br><span class="line">      : <span class="keyword">this</span>.$slots.before</span><br><span class="line">    <span class="keyword">if</span> (before) &#123;</span><br><span class="line">      contents.unshift(...(<span class="built_in">Array</span>.isArray(before) ? before : [before]))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> after = <span class="keyword">this</span>.$scopedSlots.after</span><br><span class="line">      ? <span class="keyword">this</span>.$scopedSlots.after(scope)</span><br><span class="line">      : <span class="keyword">this</span>.$slots.after</span><br><span class="line">    <span class="keyword">if</span> (after) &#123;</span><br><span class="line">      contents.push(...(<span class="built_in">Array</span>.isArray(after) ? after : [after]))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> lines = [</span><br><span class="line">      h(</span><br><span class="line">        <span class="string">'span'</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          style: &#123;</span><br><span class="line">            boxShadow: <span class="string">'transparent 0 0'</span></span><br><span class="line">          &#125;,</span><br><span class="line">          ref: <span class="string">'content'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        contents</span><br><span class="line">      )</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">return</span> h(</span><br><span class="line">      <span class="keyword">this</span>.tag,</span><br><span class="line">      &#123;</span><br><span class="line">        style: &#123;</span><br><span class="line">          maxHeight: <span class="keyword">this</span>.realMaxHeight,</span><br><span class="line">          overflow: <span class="string">'hidden'</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      lines</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> VClamp <span class="keyword">from</span> <span class="string">'./components/Clamp.js'</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">v-clamp</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:class</span>=<span class="string">"&#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">    demo: true,</span></span></span><br><span class="line"><span class="tag"><span class="string">    hyphens: hyphens1</span></span></span><br><span class="line"><span class="tag"><span class="string">  &#125;"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:max-lines</span>=<span class="string">"lines"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">autoresize</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:style</span>=<span class="string">"&#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">    width: `$&#123;width1&#125;px`</span></span></span><br><span class="line"><span class="tag"><span class="string">  &#125;"</span></span></span><br><span class="line"><span class="tag">&gt;</span></span><br><span class="line">  &#123;&#123; zh ? textZh : text &#125;&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span></span></span><br><span class="line"><span class="tag">    <span class="attr">slot</span>=<span class="string">"after"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">slot-scope</span>=<span class="string">"&#123; toggle &#125;"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">class</span>=<span class="string">"toggle btn btn-sm"</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">click</span>=<span class="string">"toggle"</span></span></span><br><span class="line"><span class="tag">  &gt;</span></span><br><span class="line">    &#123;&#123; zh ? '切换' : 'Toggle' &#125;&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">v-clamp</span>&gt;</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/01/JS监听div元素的resize/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/01/JS监听div元素的resize/" itemprop="url">JS监听div元素的resize</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-01T20:21:48+08:00">
                2019-01-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在实现一个<strong>自定义滚动条</strong>需求的时候，需要监听到某个div元素的宽高变化，第一时间想到的是resize事件，但是很不幸运的是，resize事件只能加在window对象上，并不能监听具体某个DOM元素。</p>
<p>多方查阅之后，了解到<span style="border-bottom:2px solid red;"><strong>MutationObserver</strong></span>和<span style="border-bottom:2px solid red;"><strong>Resize Observer</strong></span>, <span style="border-bottom:2px solid red;"> <strong>DOMSubtreeModified </strong></span>,迫不及待的直接看直接看  <a href="#resize-detector实现方式"><font color="#00dd00"><strong> resize-detector实现方式  </strong></font></a> 可以用来监听整个DOM中任何变化的东西，可以把它理解为一个类，实例化之后调用类实例的几个简单接口即可完成监听，以下具体介绍：</p>
<h3 id="MutationObserver介绍"><a href="#MutationObserver介绍" class="headerlink" title="MutationObserver介绍"></a>MutationObserver介绍</h3><h4 id="构造函数为window-MutationObserver，参数为一个回调函数。"><a href="#构造函数为window-MutationObserver，参数为一个回调函数。" class="headerlink" title="构造函数为window.MutationObserver，参数为一个回调函数。"></a>构造函数为window.MutationObserver，参数为一个回调函数。</h4><p>监控到DOM中的改变并且等待一系列改变结束后就会触发回调函数。它与事件的不同之处在于，它在DOM变化时，会记录每一个DOM的变化（为一个MutationRecord对象），但是到DOM变化结束时触发回调。DOM变化可能是一系列的（比如元素的宽和高同时改变），那么这一系列的变化就会产生一个队列，这个队列会作为参数传递给回调函数。</p>
<p>由于浏览器差异的原因，一些版本的浏览器各自支持了构造函数，但是用法都是一样的，实例化一个观察者的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> MutationObserver = <span class="built_in">window</span>.MutationObserver ||</span><br><span class="line">                       <span class="built_in">window</span>.WebKitMutationObserver || </span><br><span class="line">                       <span class="built_in">window</span>.MozMutationObserver</span><br><span class="line">                       </span><br><span class="line"><span class="keyword">let</span> observer = <span class="keyword">new</span> MutationObserver(callback)</span><br></pre></td></tr></table></figure>
<h4 id="调用接口开始监控DOM。"><a href="#调用接口开始监控DOM。" class="headerlink" title="调用接口开始监控DOM。"></a>调用接口开始监控DOM。</h4><blockquote>
<p>常用的接口有三个：</p>
</blockquote>
<ul>
<li><p>observe(element, options)　配置<code>MutationObserver</code>在DOM更改匹配给定选项时，通过其回调函数开始接收通知。</p>
<p>element即要监听的DOM元素，options为监听选项对象，可选的选项如下：</p>
</li>
</ul>
<p><img src="/2019/01/01/JS监听div元素的resize/1.jpg" alt=""></p>
<p>　所以监听元素宽高变化，就是监听其style属性变化：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">observer.observe(element, &#123; </span><br><span class="line">        attributes: <span class="literal">true</span>, </span><br><span class="line">        attributeFilter: [<span class="string">'style'</span>], </span><br><span class="line">        attributeOldValue: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure></p>
<p>   这样当元素的style发生改变的时候，就会触发构造函数中传入的callback函数。</p>
<ul>
<li><p>disconnect()  <code>阻止 MutationObserver</code> 实例继续接收的通知，直到再次调用其observe方法，该观察者对象包含的回调函数都不会再被调用。</p>
</li>
<li><p>takeRecords() 从MutationObserver的通知队列中删除所有待处理的通知，并将它们返回到一个MutationRecord对象构成的新数组中。</p>
</li>
</ul>
<blockquote>
<p>示例</p>
</blockquote>
<p>这里以Vue中的一个组件作为实例，了解了以上所述内容后其实非常简单,代码如下:</p>
<p><img src="/2019/01/01/JS监听div元素的resize/2.webp" alt=""><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/vue.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">			html,body&#123;</span></span><br><span class="line"><span class="undefined">				width: 100%;</span></span><br><span class="line"><span class="undefined">				height: 100%;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="css">			<span class="selector-class">.container</span> &#123;</span></span><br><span class="line"><span class="undefined">				width: 100%;</span></span><br><span class="line"><span class="undefined">				height: 100%;</span></span><br><span class="line"><span class="undefined">				position: relative</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="css">			<span class="selector-class">.resize-element</span> &#123;</span></span><br><span class="line"><span class="undefined">				position: absolute;</span></span><br><span class="line"><span class="undefined">				top: 50%;</span></span><br><span class="line"><span class="undefined">				left: 50%;</span></span><br><span class="line"><span class="undefined">				height: 10rem;</span></span><br><span class="line"><span class="undefined">				width: 10rem;</span></span><br><span class="line"><span class="undefined">				transform: translate(-50%,-50%);</span></span><br><span class="line"><span class="undefined">				overflow: hidden;</span></span><br><span class="line"><span class="css">				<span class="selector-tag">resize</span>: <span class="selector-tag">both</span>;   <span class="comment">/*用户可以调节元素的宽度和高度*/</span></span></span><br><span class="line"><span class="undefined">				display: block;</span></span><br><span class="line"><span class="css">				<span class="selector-tag">box-shadow</span>: 0 0 1<span class="selector-tag">px</span> 1<span class="selector-tag">px</span> <span class="selector-id">#3361D8</span>;</span></span><br><span class="line"><span class="undefined">				border-radius: 2px;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span> <span class="attr">id</span>=<span class="string">"main"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"resize-element"</span>&gt;</span></span><br><span class="line">				改变大小试试</span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"resize-record"</span>&gt;</span></span><br><span class="line">				触发了&#123;&#123;firedNum&#125;&#125;次resize事件。</span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">				el: <span class="string">"#main"</span>,</span></span><br><span class="line"><span class="undefined">				data: &#123;</span></span><br><span class="line"><span class="javascript">					observer: <span class="literal">null</span>,</span></span><br><span class="line"><span class="undefined">					firedNum: 0,</span></span><br><span class="line"><span class="javascript">					recordOldValue: &#123; <span class="comment">// 记录下旧的宽高数据，避免重复触发回调函数</span></span></span><br><span class="line"><span class="javascript">						width: <span class="string">'0'</span>,</span></span><br><span class="line"><span class="javascript">						height: <span class="string">'0'</span></span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined">				&#125;,</span></span><br><span class="line"><span class="undefined">				mounted() &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">let</span> MutationObserver = <span class="built_in">window</span>.MutationObserver || <span class="built_in">window</span>.WebKitMutationObserver || <span class="built_in">window</span>.MozMutationObserver</span></span><br><span class="line"><span class="javascript">					<span class="keyword">let</span> element = <span class="built_in">document</span>.querySelector(<span class="string">'.resize-element'</span>)</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.observer = <span class="keyword">new</span> MutationObserver(<span class="function">(<span class="params">mutationList</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">for</span>(<span class="keyword">let</span> mutation <span class="keyword">of</span> mutationList) &#123;</span></span><br><span class="line"><span class="javascript">							<span class="built_in">console</span>.log(mutation)</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">let</span> width = getComputedStyle(element).getPropertyValue(<span class="string">'width'</span>)</span></span><br><span class="line"><span class="javascript">						<span class="keyword">let</span> height = getComputedStyle(element).getPropertyValue(<span class="string">'height'</span>)</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(width === <span class="keyword">this</span>.recordOldValue.width &amp;&amp; height === <span class="keyword">this</span>.recordOldValue.height) <span class="keyword">return</span></span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.recordOldValue = &#123;</span></span><br><span class="line"><span class="undefined">							width,</span></span><br><span class="line"><span class="undefined">							height</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.firedNum += <span class="number">1</span></span></span><br><span class="line"><span class="undefined">					&#125;)</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.observer.observe(element, &#123;</span></span><br><span class="line"><span class="javascript">						attributes: <span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">						attributeFilter: [<span class="string">'style'</span>],</span></span><br><span class="line"><span class="javascript">						attributeOldValue: <span class="literal">true</span></span></span><br><span class="line"><span class="undefined">					&#125;)</span></span><br><span class="line"><span class="undefined">				&#125;,</span></span><br><span class="line"><span class="undefined">				beforeDestroyed() &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="keyword">this</span>.observer) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.observer.disconnect()</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.observer.takeRecords()</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.observer = <span class="literal">null</span></span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">			&#125;)</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>这里记录了旧的宽高数据来避免重复触发回调函数，这样做的原因在于宽高数据改变时，不一定是整数，而MutationRecord.recordOldValue中记录的是取整后的数据，这样就会导致在拖动改变DOM元素的宽高时，数值一直在整数和小数之间跳动，会多次触发。</strong></p>
</blockquote>
<h3 id="MutationObserver实现Vue-nextTick"><a href="#MutationObserver实现Vue-nextTick" class="headerlink" title="MutationObserver实现Vue nextTick"></a>MutationObserver实现Vue nextTick</h3><p>Vue 倡导开发者尽量不直接操作DOM，但有的时候由于各种需求让开发者不得不这样做，于是 <strong>nextTick</strong> 的实现就是让开发者在修改数据后，能够在数据更新到DOM后才执行对应的函数，从而获取最新的 DON 数据。</p>
<p>那么如何实现 <strong>nextTick</strong>呢，我们首先可以想到的是利用 <strong>setTimeout</strong> 的异步回调来实现，不过由于各个浏览器的不同，setTimeout 的延迟很高，因此在 <strong>nextTick</strong> 中只作为最后的备胎，首选的方案则是 <strong>MutationObserver</strong>(在后面的内容中 MO 代表 MutationObserver)</p>
<h4 id="nextTick-的源码实现"><a href="#nextTick-的源码实现" class="headerlink" title="nextTick 的源码实现"></a>nextTick 的源码实现</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> nextTick = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> callbacks = []</span><br><span class="line">  <span class="keyword">var</span> pending = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">var</span> timerFunc</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">nextTickHandler</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    pending = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">var</span> copies = callbacks.slice(<span class="number">0</span>)</span><br><span class="line">    callbacks = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; copies.length; i++) &#123;</span><br><span class="line">      copies[i]()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> MutationObserver !== <span class="string">'undefined'</span>) &#123; <span class="comment">// 首选 MutationObserver </span></span><br><span class="line">    <span class="keyword">var</span> counter = <span class="number">1</span></span><br><span class="line">    <span class="keyword">var</span> observer = <span class="keyword">new</span> MutationObserver(nextTickHandler) <span class="comment">// 声明 MO 和回调函数</span></span><br><span class="line">    <span class="keyword">var</span> textNode = <span class="built_in">document</span>.createTextNode(counter)</span><br><span class="line">    observer.observe(textNode, &#123; <span class="comment">// 监听 textNode 这个文本节点</span></span><br><span class="line">      characterData: <span class="literal">true</span> <span class="comment">// 一旦文本改变则触发回调函数 nextTickHandler</span></span><br><span class="line">    &#125;)</span><br><span class="line">    timerFunc = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      counter = (counter + <span class="number">1</span>) % <span class="number">2</span> <span class="comment">// 每次执行 timeFunc 都会让文本在 1 和 0 间切换</span></span><br><span class="line">      textNode.data = counter</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    timerFunc = setTimeout <span class="comment">// 如果不支持 MutationObserver, 退选 setTimeout</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">cb, ctx</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> func = ctx</span><br><span class="line">      ? <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; cb.call(ctx) &#125;</span><br><span class="line">      : cb</span><br><span class="line">    callbacks.push(func)</span><br><span class="line">    <span class="keyword">if</span> (pending) <span class="keyword">return</span></span><br><span class="line">    pending = <span class="literal">true</span></span><br><span class="line">    timerFunc(nextTickHandler, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<h4 id="从Vue-2-5-开始，抽出来了一个单独的文件next-tick-js来执行它"><a href="#从Vue-2-5-开始，抽出来了一个单独的文件next-tick-js来执行它" class="headerlink" title="从Vue 2.5+开始，抽出来了一个单独的文件next-tick.js来执行它"></a>从Vue 2.5+开始，抽出来了一个单独的文件next-tick.js来执行它</h4><p><a href="https://libin1991.github.io/2017/10/21/%E9%9D%A2%E8%AF%95%E4%B9%8BVue-nextTick%E5%8E%9F%E7%90%86/" target="_blank" rel="noopener">面试之Vue.$nextTick原理</a><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">    延迟一个任务使其异步执行，在下一个tick时执行，一个立即执行函数，返回一个function</span></span><br><span class="line"><span class="comment">    这个函数的作用是在task或者microtask中推入一个timerFunc，</span></span><br><span class="line"><span class="comment">    在当前调用栈执行完以后以此执行直到执行到timerFunc</span></span><br><span class="line"><span class="comment">    目的是延迟到当前调用栈执行完以后执行</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/*存放异步执行的回调*/</span></span><br><span class="line"><span class="keyword">const</span> callbacks = []</span><br><span class="line"><span class="comment">/*一个标记位，如果已经有timerFunc被推送到任务队列中去则不需要重复推送*/</span></span><br><span class="line"><span class="keyword">let</span> pending = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*下一个tick时的回调*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushCallbacks</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">/*一个标记位，标记等待状态（即函数已经被推入任务队列或者主线程，已经在等待当前栈执行完毕去执行），这样就不需要在push多个回调到callbacks时将timerFunc多次推入任务队列或者主线程*/</span></span><br><span class="line">  pending = <span class="literal">false</span></span><br><span class="line">  <span class="comment">//复制callback</span></span><br><span class="line">  <span class="keyword">const</span> copies = callbacks.slice(<span class="number">0</span>)</span><br><span class="line">  <span class="comment">//清除callbacks</span></span><br><span class="line">  callbacks.length = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; copies.length; i++) &#123;</span><br><span class="line">  <span class="comment">//触发callback的回调函数</span></span><br><span class="line">    copies[i]()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Here we have async deferring wrappers using both microtasks and (macro) tasks.</span></span><br><span class="line"><span class="comment">// In &lt; 2.4 we used microtasks everywhere, but there are some scenarios where</span></span><br><span class="line"><span class="comment">// microtasks have too high a priority and fire in between supposedly</span></span><br><span class="line"><span class="comment">// sequential events (e.g. #4521, #6690) or even between bubbling of the same</span></span><br><span class="line"><span class="comment">// event (#6566). However, using (macro) tasks everywhere also has subtle problems</span></span><br><span class="line"><span class="comment">// when state is changed right before repaint (e.g. #6813, out-in transitions).</span></span><br><span class="line"><span class="comment">// Here we use microtask by default, but expose a way to force (macro) task when</span></span><br><span class="line"><span class="comment">// needed (e.g. in event handlers attached by v-on).</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">其大概的意思就是：在Vue2.4之前的版本中，nextTick几乎都是基于microTask实现的，</span></span><br><span class="line"><span class="comment">但是由于microTask的执行优先级非常高，在某些场景之下它甚至要比事件冒泡还要快，</span></span><br><span class="line"><span class="comment">就会导致一些诡异的问题；但是如果全部都改成macroTask，对一些有重绘和动画的场</span></span><br><span class="line"><span class="comment">景也会有性能的影响。所以最终nextTick采取的策略是默认走microTask，对于一些DOM</span></span><br><span class="line"><span class="comment">的交互事件，如v-on绑定的事件回调处理函数的处理，会强制走macroTask。</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> microTimerFunc</span><br><span class="line"><span class="keyword">let</span> macroTimerFunc</span><br><span class="line"><span class="keyword">let</span> useMacroTask = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Determine (macro) task defer implementation.</span></span><br><span class="line"><span class="comment">// Technically setImmediate should be the ideal choice, but it's only available</span></span><br><span class="line"><span class="comment">// in IE. The only polyfill that consistently queues the callback after all DOM</span></span><br><span class="line"><span class="comment">// events triggered in the same loop is by using MessageChannel.</span></span><br><span class="line"><span class="comment">/* istanbul ignore if */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">而对于macroTask的执行，Vue优先检测是否支持原生setImmediate（高版本IE和Edge支持），</span></span><br><span class="line"><span class="comment">不支持的话再去检测是否支持原生MessageChannel，如果还不支持的话为setTimeout(fn, 0)。</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> setImmediate !== <span class="string">'undefined'</span> &amp;&amp; isNative(setImmediate)) &#123;</span><br><span class="line">  macroTimerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setImmediate(flushCallbacks)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> MessageChannel !== <span class="string">'undefined'</span> &amp;&amp; ( </span><br><span class="line"><span class="comment">// MessageChannel与原先的MutationObserver异曲同工</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">在Vue 2.4版本以前使用的MutationObserver来模拟异步任务。</span></span><br><span class="line"><span class="comment">而Vue 2.5版本以后，由于兼容性弃用了MutationObserver。</span></span><br><span class="line"><span class="comment">Vue 2.5+版本使用了MessageChannel来模拟macroTask。</span></span><br><span class="line"><span class="comment">除了IE以外，messageChannel的兼容性还是比较可观的。</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">  isNative(MessageChannel) ||</span><br><span class="line">  <span class="comment">// PhantomJS</span></span><br><span class="line">  MessageChannel.toString() === <span class="string">'[object MessageChannelConstructor]'</span></span><br><span class="line">)) &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  可见，新建一个MessageChannel对象，该对象通过port1来检测信息，port2发送信息。</span></span><br><span class="line"><span class="comment">  通过port2的主动postMessage来触发port1的onmessage事件，</span></span><br><span class="line"><span class="comment">  进而把回调函数flushCallbacks作为macroTask参与事件循环。</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  <span class="keyword">const</span> channel = <span class="keyword">new</span> MessageChannel()</span><br><span class="line">  <span class="keyword">const</span> port = channel.port2</span><br><span class="line">  channel.port1.onmessage = flushCallbacks</span><br><span class="line">  macroTimerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    port.postMessage(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">/* istanbul ignore next */</span></span><br><span class="line">   <span class="comment">//上面两种都不支持，用setTimeout</span></span><br><span class="line">  macroTimerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(flushCallbacks, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Determine microtask defer implementation.</span></span><br><span class="line"><span class="comment">/* istanbul ignore next, $flow-disable-line */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">Promise</span> !== <span class="string">'undefined'</span> &amp;&amp; isNative(<span class="built_in">Promise</span>)) &#123;</span><br><span class="line"><span class="comment">/*使用Promise*/</span></span><br><span class="line">  <span class="keyword">const</span> p = <span class="built_in">Promise</span>.resolve()</span><br><span class="line">  microTimerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    p.then(flushCallbacks)</span><br><span class="line">    <span class="comment">// in problematic UIWebViews, Promise.then doesn't completely break, but</span></span><br><span class="line">    <span class="comment">// it can get stuck in a weird state where callbacks are pushed into the</span></span><br><span class="line">    <span class="comment">// microtask queue but the queue isn't being flushed, until the browser</span></span><br><span class="line">    <span class="comment">// needs to do some other work, e.g. handle a timer. Therefore we can</span></span><br><span class="line">    <span class="comment">// "force" the microtask queue to be flushed by adding an empty timer.</span></span><br><span class="line">    <span class="comment">//iOS的webview下，需要强制刷新队列，执行上面的回调函数</span></span><br><span class="line">    <span class="keyword">if</span> (isIOS) setTimeout(noop)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// fallback to macro</span></span><br><span class="line">  microTimerFunc = macroTimerFunc</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Wrap a function so that if any code inside triggers state change,</span></span><br><span class="line"><span class="comment"> * the changes are queued using a (macro) task instead of a microtask.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> 在Vue执行绑定的DOM事件时，默认会给回调的handler函数调用withMacroTask方法做一层包装，</span></span><br><span class="line"><span class="comment"> 它保证整个回调函数的执行过程中，遇到数据状态的改变，这些改变而导致的视图更新（DOM更新）</span></span><br><span class="line"><span class="comment"> 的任务都会被推到macroTask而不是microtask。</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">withMacroTask</span> (<span class="params">fn: Function</span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> fn._withTask || (fn._withTask = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    useMacroTask = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">const</span> res = fn.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>)</span><br><span class="line">    useMacroTask = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">    推送到队列中下一个tick时执行</span></span><br><span class="line"><span class="comment">    cb 回调函数</span></span><br><span class="line"><span class="comment">    ctx 上下文</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">nextTick</span> (<span class="params">cb?: Function, ctx?: Object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> _resolve</span><br><span class="line">   <span class="comment">/*cb存到callbacks中*/</span></span><br><span class="line">  callbacks.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cb) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        cb.call(ctx)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        handleError(e, ctx, <span class="string">'nextTick'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_resolve) &#123;</span><br><span class="line">      _resolve(ctx)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (!pending) &#123;</span><br><span class="line">    pending = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (useMacroTask) &#123;</span><br><span class="line">      macroTimerFunc()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      microTimerFunc()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// $flow-disable-line</span></span><br><span class="line">  <span class="keyword">if</span> (!cb &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">Promise</span> !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      _resolve = resolve</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>看了源码发现timerFunc会检测当前环境而不同实现，其实就是按照Promise，MutationObserver，setTimeout优先级，哪个存在使用哪个，最不济的环境下使用setTimeout</p>
<p><span style="border-bottom:2px solid red;">setTimeout是最后的一种备选方案，并且默认有4ms延时，setTimeout延时0不会老老实实立即执行：</span><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"我不是立即执行的,一般我会延时4ms,哈哈"</span>);</span><br><span class="line">&#125;,<span class="number">0</span>);</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>优先使用Promise，在Promise不存在的情况下使用MutationObserver，这两个方法的回调函数都会在microtask中执行，它们会比setTimeout更早执行，所以优先使用。<br>如果上述两种方法都不支持的环境则会使用setTimeout，在task尾部推入这个函数，等待调用执行。</p>
</blockquote>
<h4 id="Event-Loop"><a href="#Event-Loop" class="headerlink" title="Event Loop"></a>Event Loop</h4><p>当一个程序有：setTimeout， setInterval ，setImmediate， I/O， UI渲染，Promise ，process.nextTick， Object.observe， MutationObserver的时候：</p>
<ul>
<li>先执行 macrotasks：I/O -》 UI渲染</li>
<li>再执行 microtasks ：process.nextTick -》 Promise -》MutationObserver -&gt;Object.observe</li>
<li>再把setTimeout setInterval setImmediate 塞入一个新的macrotasks，依次： setTimeout ，setInterval –&gt; setImmediate</li>
</ul>
<p>综上，nextTick的目的就是产生一个回调函数加入task或者microtask中，当前栈执行完以后（可能中间还有别的排在前面的函数）调用该回调函数，起到了异步触发（即下一个tick时触发）的目的。</p>
<p>任务队列<br>异步任务分为task（宏任务，也可称为macroTask）和microtask（微任务）两类。<br>当满足执行条件时，task和microtask会被放入各自的队列中等待放入主线程执行，我们把这两个队列称为Task Queue(也叫Macrotask Queue)和Microtask Queue。</p>
<blockquote>
<font color="#dd0000"> <strong> macrotasks: </strong>   script中代码, setTimeout ，setInterval， setImmediate，requestAnimationFrame, I/O ，UI渲染  </font>
</blockquote>
<blockquote>
<font color="#dd0000"> <strong> microtasks: </strong>   Promise， process.nextTick， Object.observe， MutationObserver  </font>
</blockquote>
<p><table><tr><td bgcolor="#000"><font color="#fff"> microtask(微任务)一定比macroTask(宏任务)先执行吗：script中代码最先执行，但是script代码是macrotasks(宏任务) </font></td></tr></table></p>
<blockquote>
<p><strong>其实promise的then和catch才是microtask，本身的内部代码不是</strong></p>
</blockquote>
<h4 id="具体过程"><a href="#具体过程" class="headerlink" title="具体过程"></a>具体过程</h4><ul>
<li>执行完主执行线程中的任务</li>
<li>取出Microtask Queue中任务执行直到清空。</li>
<li>取出Macrotask Queue中一个任务执行。</li>
<li>取出Microtask Queue中任务执行直到清空。</li>
<li>重复3和4。</li>
</ul>
<p>即为同步完成，一个宏任务，所有微任务，一个宏任务，所有微任务……</p>
<p><img src="/2019/01/01/JS监听div元素的resize/7.jpg" alt=""><br><img src="/2019/01/01/JS监听div元素的resize/8.jpg" alt=""></p>
<hr>
<h3 id="MutationObserver-的功能和作用"><a href="#MutationObserver-的功能和作用" class="headerlink" title="MutationObserver 的功能和作用"></a>MutationObserver 的功能和作用</h3><blockquote>
<p>MO 给开发者提供了一种能在某个范围内的DOM数发生变化时作出适当反应的能力 </p>
</blockquote>
<p>用人话说是开发者能通过它创建一个观察者对象，这个对象会监听某个DOM元素，并在它的DOM树发生变化时执行我们提供的回调函数。</p>
<p>具体参考这个 <a href="https://jsfiddle.net/chenjsh36/1b5LL0b7/1/" target="_blank" rel="noopener">DEMO</a>点击预览</p>
<p>比较特别的是实例化的时候需要先传入回调函数：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observer = <span class="keyword">new</span> MutationObserver(<span class="function"><span class="keyword">function</span>(<span class="params">mutations</span>) </span>&#123;</span><br><span class="line">  mutations.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">mutation</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(mutation.type);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>然后才配置观察选项，包括观察节点和观察的属性：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 选择目标节点</span></span><br><span class="line"><span class="keyword">var</span> target = <span class="built_in">document</span>.querySelector(<span class="string">'#some-id'</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 配置观察选项:</span></span><br><span class="line"><span class="keyword">var</span> config = &#123; <span class="attr">attributes</span>: <span class="literal">true</span>, <span class="attr">childList</span>: <span class="literal">true</span>, <span class="attr">characterData</span>: <span class="literal">true</span> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 传入目标节点和观察选项</span></span><br><span class="line">observer.observe(target, config);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 随后,你还可以停止观察</span></span><br><span class="line">observer.disconnect();</span><br></pre></td></tr></table></figure>
<p>对于老版本的谷歌和火狐，则需要使用带前缀的 MO：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var MutationObserver = window.MutationObserver || </span><br><span class="line">                       window.WebKitMutationObserver || </span><br><span class="line">                       window.MozMutationObserver</span><br></pre></td></tr></table></figure>
<h3 id="MutationObserver-和-microtask"><a href="#MutationObserver-和-microtask" class="headerlink" title="MutationObserver 和 microtask"></a>MutationObserver 和 microtask</h3><p>那么为什么优选使用 MutationObserver呢？</p>
<p>一开始以为是 MO 就是用来监听 DOM 变化的，那么使用 textnode 模拟 DOM 变化再利用 MO 来监听触发从而实现 nextTick 不就很适合，直到了解看到了知乎上的<a href="https://www.zhihu.com/question/55364497" target="_blank" rel="noopener">问答</a>才知道是因为 MO 会比 setTimeout 早执行的缘故，</p>
<p>这里需要了解<strong>JS的运行运行机制</strong>（重新刷新了我的三观）, JS 的事件运行机制执行的时候会区分 <strong>task</strong> 和 <strong>microtask</strong>, 引擎在每个 <strong>task</strong> 执行完毕，并在从队列里取<strong>下一个task来执行之前</strong>， 执行完所有的 <strong>microtask</strong> 队列中的 microtask.</p>
<p><strong> setTimeout</strong> 回调会被分配到一个新的task中等待执行，而 Promise 的 resolver、MO 的 回调都会被分配到 microtask 的队列中，所以会比 setTimout 先执行.</p>
<p>除了比 setTimout 快之外，还有 <strong>渲染性能</strong> 的问题，根据<a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model" target="_blank" rel="noopener">HTML Standard</a>, <strong>每个 task 运行完以后， UI 都会重新渲染，那么在 microtask 中就完成数据更新， 当前 task 结束就可以得到最新的 UI， 反之如果新建一个 task 来做数据更新，那么渲染就会进行两次。</strong></p>
<p>所以性价比如此高的 MO 自然成为了首选</p>
<p>关于 microtask，具体可以阅读 Jake 写的 <a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/" target="_blank" rel="noopener">Tasks, microtasks, queues and schedules</a></p>
<h3 id="Vue-nextTick的版本迭代"><a href="#Vue-nextTick的版本迭代" class="headerlink" title="Vue nextTick的版本迭代"></a>Vue nextTick的版本迭代</h3><p>上面关于 <strong>nextTick</strong> 的源码实现属于 vue 最早的版本 v1.0.9，在深挖 mutationObserver 的时候发现 <strong>nextTick</strong> 在vue的版本迭代中也在不断的进化，同事也发生过退化，非常有趣：</p>
<p>先说说退化的事件，尤大（vue的作者）曾经使用 <code>window.postMessage</code> 来替代 MO 实现 nextTick，结果开发者使用后发现了问题，可以看看这两个 JSFiddle：<a href="https://jsfiddle.net/k6bgu2z6/4/" target="_blank" rel="noopener">jsfiddle1</a>点击预览 和 <a href="https://jsfiddle.net/v9q9L0hw/2/" target="_blank" rel="noopener">jsfiddle2</a>点击预览, 两个例子用了不同版本来实现元素的绝对定位，第一个使用的是 2.0.0-rc6，这个版本采用的是 MO，而后来因为 IOS 9.3 的 WebView 里 MO 有 bug，尤大便换成 window.postMessage来实现，即第二个实例版本为 2.0.0-rc7, 但是由于 postMessage 会将回调放到 macrotask 其实也就是 task 里面，导致可能执行了多次 UI 的task都没有执行 window.postMessage 的 task，也就延迟了更新DOM操作的时间。尤大在后续版本撤回了这一次修改，具体的讨论可以看<a href="https://github.com/vuejs/vue/issues/3771#issuecomment-249692588" target="_blank" rel="noopener">issue</a></p>
<p>关于进化，在后续的版本里，由于 es6 的新语法，nextTick 开始使用 Promise.then 和 MO 来做首选和次选，在前面的讨论中已经提到，Promise.then 也属于 microtask。</p>
<h3 id="Resize-Observer"><a href="#Resize-Observer" class="headerlink" title="Resize Observer"></a>Resize Observer</h3><blockquote>
<p>Resize Observer是一个新的JavaScript API，与Intersection Observer API、Mutation Observer等其他观察者API非常相似。<br>它允许在尺寸发生变化时通知元素。</p>
</blockquote>
<p>ResizeObserver的解释:开发过程当中经常遇到的一个问题就是如何监听一个 div 的尺寸变化。但众所周知，为了监听 div 的尺寸变化，都将侦听器附加到 window 中的 resize 事件。但这很容易导致性能问题，因为大量的触发事件。换句话说，使用 window.resize 通常是浪费的，因为它告诉我们每个视窗大小的变化，而不仅仅是当一个元素的大小发生变化。</p>
<p>使用 ResizeObserver 的API的另一个用例就是视窗 resize 事件不能帮助我们：当元素被动态地添加或删除时，会影响父元素的大小。这也是现代单页应用程序越来越频繁使用 ResizeObserver 原因之一。<br>通过 window.resize 事件的监听，可以调用一个回调函数。在这个回调函数中做我们需要做的事情。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// define a callback</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// something cool here</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// add resize listener to window object</span></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'resize'</span>, callback)</span><br></pre></td></tr></table></figure>
<p>比如说，你要调整一个元素的大小，那就需要在 resize 的回调函数 callback() 中调用 getBoundingClientRect 或 getComputerStyle 不过你要是不小心处理所有的读和写操作，就会导致布局混乱。比如下面这个小示例：</p>
<p>当你改变浏览器视窗大小的时候，就可以看到相应的变化：</p>
<p><img src="/2019/01/01/JS监听div元素的resize/3.gif" alt=""></p>
<p>这也就是为什么 ResizeObserver 是一个有用的API。它对所观察到的任何元素的大小的变化做出反应，而不依赖于所引起的变化。它还提供了对所观察元素的新大小的访问。那接下来让我们直接切入正题。</p>
<h4 id="简单总结一下："><a href="#简单总结一下：" class="headerlink" title="简单总结一下："></a>简单总结一下：</h4><p>ResizeObserver 允许我们观察DOM元素的内容矩形大小（宽度、高度）的变化，并做出相应的响应。它就像给元素添加 document.onresize() 或 window.resize() 事件（但在JavaScript中，只有 window 才有 resize 事件）。当元素改变大小而不调整视窗大小时，它是有用的。 下面描述一些调整观察者的行为：</p>
<ul>
<li>当观察到的元素被插入或从DOM中删除时，观察将会触发</li>
<li>当观察到的元素 display 值为 none 时，观察都会触发</li>
<li>观察不会对未替换的内联元素（non-replaced inline element）触发</li>
<li>观察不会由CSS的 transform 触发</li>
<li>如果元素有显示，而且元素大小不是 0,0 ，观察将会触发</li>
</ul>
<p>基本用法<br>使用Resize Observer非常简单，只需实例化一个新的ResizeObserver对象并传入一个回调函数，该函数接收观察到的条目</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myObserver = <span class="keyword">new</span> ResizeObserver(<span class="function"><span class="params">entries</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 遍历条目，做一些事情</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>然后，我们可以在实例上调用observe并传入一个元素来观察</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> someEl = <span class="built_in">document</span>.querySelector(<span class="string">'.some-element'</span>);</span><br><span class="line"><span class="keyword">const</span> someOtherEl = <span class="built_in">document</span>.querySelector(<span class="string">'.some-other-element'</span>);</span><br><span class="line"></span><br><span class="line">myObserver.observe(someEl);</span><br><span class="line">myObserver.observe(someOtherEl);</span><br></pre></td></tr></table></figure>
<p>对于每个entry，我们都会得到一个包含contentRect和一个target属性的对象。target是DOM元素本身，contentRect是具有以下属性的对象：width，height，x，y，top，right，bottom和left。</p>
<p>与元素的<strong>getBoundingClientRect</strong>不同，contentRect的width和height值不包含padding。contentRect.top是元素的顶部padding，contentRect.left是元素的左侧padding。</p>
<p>比如要打印出被监听元素寸尺变化时width和height的值，可以像下面这样做:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myObserver = <span class="keyword">new</span> ResizeObserver(<span class="function"><span class="params">entries</span> =&gt;</span> &#123;</span><br><span class="line">  entries.forEach(<span class="function"><span class="params">entry</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'width'</span>, entry.contentRect.width);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'height'</span>, entry.contentRect.height);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> someEl = <span class="built_in">document</span>.querySelector(<span class="string">'.some-element'</span>);</span><br><span class="line">myObserver.observe(someEl);</span><br></pre></td></tr></table></figure></p>
<p>上面的示例中，使用了forEach 循环来遍历观察者的回调中的 entries ，其实在 entries 上使用  for … of  可以得到相同的效果</p>
<h4 id="Resize-Observer-API-示例"><a href="#Resize-Observer-API-示例" class="headerlink" title="Resize Observer API 示例"></a>Resize Observer API 示例</h4><p>下面是一个简单的演示，以查看Resize Observer API的实际应用。<br>通过调整浏览器窗口的大小来尝试一下，注意渐变角度和文本内容仅在元素的大小受到影响时才发生变化：</p>
<p><img src="/2019/01/01/JS监听div元素的resize/4.webp" alt=""><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/vue.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">			html,</span></span><br><span class="line"><span class="undefined">			body &#123;</span></span><br><span class="line"><span class="undefined">				width: 100%;</span></span><br><span class="line"><span class="undefined">				height: 100%;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="css">			<span class="selector-class">.box</span> &#123;</span></span><br><span class="line"><span class="undefined">				text-align: center;</span></span><br><span class="line"><span class="undefined">				height: 20vh;</span></span><br><span class="line"><span class="undefined">				border-radius: 8px;</span></span><br><span class="line"><span class="undefined">				box-shadow: 0 0 4px var(--subtle);</span></span><br><span class="line"><span class="undefined">				display: flex;</span></span><br><span class="line"><span class="undefined">				justify-content: center;</span></span><br><span class="line"><span class="undefined">				align-items: center;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="css">			<span class="selector-class">.box</span> <span class="selector-tag">h3</span> &#123;</span></span><br><span class="line"><span class="css">				<span class="selector-tag">color</span>: <span class="selector-id">#fff</span>;</span></span><br><span class="line"><span class="undefined">				margin: 0;</span></span><br><span class="line"><span class="undefined">				font-size: 5vmin;</span></span><br><span class="line"><span class="css">				<span class="selector-tag">text-shadow</span>: 0 0 10<span class="selector-tag">px</span> <span class="selector-tag">rgba</span>(0, 0, 0, 0<span class="selector-class">.4</span>);</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="css">			<span class="selector-class">.box</span><span class="selector-class">.small</span> &#123;</span></span><br><span class="line"><span class="undefined">				max-width: 550px;</span></span><br><span class="line"><span class="undefined">				margin: 1rem auto;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"info"</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box small"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"info"</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">const</span> boxes = <span class="built_in">document</span>.querySelectorAll(<span class="string">'.box'</span>);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">const</span> myObserver = <span class="keyword">new</span> ResizeObserver(<span class="function"><span class="params">entries</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">for</span>(<span class="keyword">let</span> entry <span class="keyword">of</span> entries) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> infoEl = entry.target.querySelector(<span class="string">'.info'</span>);</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> width = <span class="built_in">Math</span>.floor(entry.contentRect.width);</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> height = <span class="built_in">Math</span>.floor(entry.contentRect.height);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> angle = <span class="built_in">Math</span>.floor(width / <span class="number">360</span> * <span class="number">100</span>);</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> gradient = <span class="string">`linear-gradient(<span class="subst">$&#123; angle &#125;</span>deg, rgba(0,143,104,1) 50%, rgba(250,224,66,1) 50%)`</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">					entry.target.style.background = gradient;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					infoEl.innerText = <span class="string">`I'm <span class="subst">$&#123; width &#125;</span>px and <span class="subst">$&#123; height &#125;</span>px tall`</span>;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			boxes.forEach(<span class="function"><span class="params">box</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">				myObserver.observe(box);</span></span><br><span class="line"><span class="undefined">			&#125;);</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="DOM变动事件的用法"><a href="#DOM变动事件的用法" class="headerlink" title="DOM变动事件的用法"></a>DOM变动事件的用法</h3><p>DOM2级的変动事件是为XML或html的DOM设计的，不特定于某种语言。 </p>
<h4 id="变动事件的分类有7种，最常用的浏览器支持最多的有3种"><a href="#变动事件的分类有7种，最常用的浏览器支持最多的有3种" class="headerlink" title="变动事件的分类有7种，最常用的浏览器支持最多的有3种:"></a>变动事件的分类有7种，最常用的浏览器支持最多的有3种:</h4><ol>
<li><strong>DOMSubtreeModified</strong>：在DOM结构中发生任何变化时触发； </li>
<li><strong>DOMNodeInserted</strong>：在一个节点作为子节点被插入到另一个节点中时触发； </li>
<li><strong>DOMNodeRemoved</strong>：在节点从其父节点中被移除时触发； </li>
<li>DOMNodeInsertedIntoDocument：在一个节点被直接插入文档中或者通过子树间接插入文档后触发。在DOMNodeInserted之后触发； </li>
<li>DOMNodeRemovedFromDocument：在一个节点被直接从文档中删除或通过子树间接从文档中移除之前触发。在DOMNodeRemoved之后触发。 </li>
<li>DOMAttrModified：在特性被修改之后触发； </li>
<li>DOMCharacterDataModified：在文本节点的值发生变化的时候触发。 </li>
</ol>
<h4 id="删除节点检测？"><a href="#删除节点检测？" class="headerlink" title="删除节点检测？"></a>删除节点检测？</h4><ul>
<li>首先触发的是DOMNodeRemoved事件，它对应的event对象中的target属性值是被删除的节点，relatedNode属性值是被删除节点的父节点，该事件会冒泡；</li>
<li>其次出发的是DOMNodeRemovedFromDocument事件，它对应的event对象中的target属性值为指定的被删除的子节点。只有绑定到它的子节点上才能被触发。</li>
<li>最后触发的是DOMSubtreeModified事件。这个事件对应event对象中的target属性是被移除节点的父节点。 </li>
</ul>
<p>(下面注释的序号为触发的顺序:)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">functiongetFirstChild(obj)&#123;// 获取第一子节点(找到第一个不为空的节点)var first = obj.firstChild;</span><br><span class="line">        while(first.nodeType != 1)&#123;</span><br><span class="line">            first = first.nextSibling;</span><br><span class="line">        &#125;</span><br><span class="line">        return first;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">EventUtil.addHandler(window,&quot;load&quot;,function(event)&#123;</span><br><span class="line">    varlist = document.getElementById(&apos;myList&apos;);</span><br><span class="line">    var btn = document.getElementById(&quot;mbtn&quot;);</span><br><span class="line"></span><br><span class="line">    EventUtil.addHandler(document,&quot;DOMNodeRemoved&quot;,function(event)&#123;</span><br><span class="line">        console.log(event.type);        //1:DOMNodeRemoved</span><br><span class="line">        console.log(event.target);      //2:ul节点,即被删除的节点</span><br><span class="line">        console.log(event.relatedNode); //3:body节点,即被删除节点的父节点</span><br><span class="line">    &#125;)</span><br><span class="line">    EventUtil.addHandler(getFirstChild(list),&quot;DOMNodeRemovedFromDocument&quot;,function(event)&#123;</span><br><span class="line">        console.log(event.type)         //4:DOMNodeRemovedFromDocument</span><br><span class="line">        console.log(event.target)       //5:li节点，即&lt;li&gt;item1&lt;/li&gt;</span><br><span class="line">    &#125;);</span><br><span class="line">    EventUtil.addHandler(document,&quot;DOMSubtreeModified&quot;,function(event)&#123;</span><br><span class="line">        console.log(event.type);        //6:DOMSubtreeModified</span><br><span class="line">        console.log(event.target);      //7:body节点，即被删除节点的父节点</span><br><span class="line">    &#125;)</span><br><span class="line">    EventUtil.addHandler(btn,&apos;click&apos;,function(event)&#123;</span><br><span class="line">        list.parentNode.removeChild(list);  //</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h4 id="插入节点检测？"><a href="#插入节点检测？" class="headerlink" title="插入节点检测？"></a>插入节点检测？</h4><p> 在使用appendChild()、replaceChild()或insertBefore()向DOM中插入节点的时候：</p>
<ul>
<li>首先触发DOMInserted事件，它对应的event对象中的target属性为添加的节点，relateNode属性对应被添加节点的父节点。（可冒泡）；</li>
<li>其次触发的是DOMNodeInsertedIntoDocument事件，它对应的event对象中的target属性是添加的节点，只有指定给一个子节点的事件处理程序才会被调用</li>
<li>最后出发的是DOMSubtreeModified事件，它对应的event对象长得target属性值是新节点的父节点。 </li>
</ul>
<blockquote>
<p>代码如下所示：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">functiongetFirstChild(obj)&#123;<span class="comment">// 获取第一子节点(找到第一个不为空的节点)var first = obj.firstChild;</span></span><br><span class="line">    <span class="keyword">while</span>(first.nodeType != <span class="number">1</span>)&#123;</span><br><span class="line">        first = first.nextSibling;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> first;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EventUtil.addHandler(<span class="built_in">window</span>,<span class="string">"load"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> list = <span class="built_in">document</span>.getElementById(<span class="string">'myList'</span>);</span><br><span class="line">    <span class="keyword">var</span> btn = <span class="built_in">document</span>.getElementById(<span class="string">"mbtn"</span>);</span><br><span class="line">    <span class="keyword">var</span> item4 = <span class="built_in">document</span>.createElement(<span class="string">'li'</span>);</span><br><span class="line">    <span class="keyword">var</span> item4Text = <span class="built_in">document</span>.createTextNode(<span class="string">'item4'</span>);</span><br><span class="line"></span><br><span class="line">    EventUtil.addHandler(<span class="built_in">document</span>,<span class="string">"DOMNodeInserted"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(event.type);        <span class="comment">//1:DOMNodeInserted</span></span><br><span class="line">        <span class="built_in">console</span>.log(event.target);      <span class="comment">//2:li节点，即被添加的节点</span></span><br><span class="line">        <span class="built_in">console</span>.log(event.relatedNode); <span class="comment">//3:ul节点，即被添加节点的父节点</span></span><br><span class="line">    &#125;);</span><br><span class="line">    EventUtil.addHandler(item4,<span class="string">"DOMNodeInsertedIntoDocument"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(event.type);        <span class="comment">//4:DOMNodeInsertedIntoDocument</span></span><br><span class="line">        <span class="built_in">console</span>.log(event.target);      <span class="comment">//5:li节点，即被添加的节点&lt;li&gt;item4&lt;/li&gt;</span></span><br><span class="line">    &#125;);</span><br><span class="line">    EventUtil.addHandler(<span class="built_in">document</span>,<span class="string">"DOMSubtreeModified"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(event.type);        <span class="comment">//6:DOMSubtreeModified</span></span><br><span class="line">        <span class="built_in">console</span>.log(event.target);      <span class="comment">//7:ul节点，即被触发节点的父节点</span></span><br><span class="line">    &#125;)</span><br><span class="line">    EventUtil.addHandler(btn,<span class="string">'click'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        item4.appendChild(item4Text);     getFirstChild</span><br><span class="line"></span><br><span class="line">        list.replaceChild(item4,getFirstChild(list));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="常用npm包"><a href="#常用npm包" class="headerlink" title="常用npm包"></a>常用npm包</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">element-resize-detector 【推荐】</span><br><span class="line">resize-detector</span><br><span class="line">size-sensor</span><br></pre></td></tr></table></figure>
<p><img src="/2019/01/01/JS监听div元素的resize/5.png" alt=""></p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><ul>
<li>Install</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm i --save size-sensor</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; bind, clear &#125; <span class="keyword">from</span> <span class="string">'size-sensor'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>bind&amp;unbind</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; bind, clear &#125; <span class="keyword">from</span> <span class="string">'size-sensor'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// bind the event on element, will get the `unbind` function</span></span><br><span class="line"><span class="keyword">const</span> unbind1 = bind(<span class="built_in">document</span>.querySelector(<span class="string">'.container'</span>), element =&gt; &#123;</span><br><span class="line">  <span class="comment">// do what you want to to.</span></span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> unbind2 = bind(<span class="built_in">document</span>.querySelector(<span class="string">'.container'</span>), element =&gt; &#123;</span><br><span class="line">  <span class="comment">// do what you want to to.</span></span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// if you want to cancel bind event.</span></span><br><span class="line">unbind1();</span><br></pre></td></tr></table></figure>
<ul>
<li>clear</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; bind, clear &#125; <span class="keyword">from</span> <span class="string">'size-sensor'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * // bind the resize event.</span></span><br><span class="line"><span class="comment"> * const unbind1 = bind(...);</span></span><br><span class="line"><span class="comment"> * const unbind2 = bind(...);</span></span><br><span class="line"><span class="comment"> * ...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// you can cancel all the event of element.</span></span><br><span class="line">clear(element);</span><br></pre></td></tr></table></figure>
<ul>
<li>实现方式：<br><img src="/2019/01/01/JS监听div元素的resize/6.webp" alt=""></li>
</ul>
<h3 id="resize-detector实现方式"><a href="#resize-detector实现方式" class="headerlink" title="resize-detector实现方式"></a>resize-detector实现方式</h3><h4 id="Github"><a href="#Github" class="headerlink" title="Github"></a><a href="https://github.com/libin1991/resize-detector" target="_blank" rel="noopener"><font color="#dd0000">Github</font></a></h4><blockquote>
<font color="#ff0000"><strong> 依次判断window.ResizeObserver,DOMSubtreeModified,window.MutationObserver </strong></font>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  createStyles,</span><br><span class="line">  createElement,</span><br><span class="line">  requestAnimationFrame,</span><br><span class="line">  cancelAnimationFrame,</span><br><span class="line">  getComputedStyle,</span><br><span class="line">  getRenderInfo</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'./util'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> triggerStyles <span class="keyword">from</span> <span class="string">'./triggers.css'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> total = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> style = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">addListener</span> (<span class="params">elem, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!elem.__resize_mutation_handler__) &#123;</span><br><span class="line">    elem.__resize_mutation_handler__ = handleMutation.bind(elem)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> listeners = elem.__resize_listeners__</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!listeners) &#123;</span><br><span class="line">    elem.__resize_listeners__ = []</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.ResizeObserver) &#123;</span><br><span class="line">      <span class="keyword">let</span> &#123; offsetWidth, offsetHeight &#125; = elem</span><br><span class="line">      <span class="keyword">let</span> ro = <span class="keyword">new</span> ResizeObserver(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!elem.__resize_observer_triggered__) &#123;</span><br><span class="line">          elem.__resize_observer_triggered__ = <span class="literal">true</span></span><br><span class="line">          <span class="keyword">if</span> (elem.offsetWidth === offsetWidth &amp;&amp; elem.offsetHeight === offsetHeight) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        runCallbacks(elem)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// initially display none won't trigger ResizeObserver callback</span></span><br><span class="line">      <span class="keyword">let</span> &#123; detached, rendered &#125; = getRenderInfo(elem)</span><br><span class="line">      elem.__resize_observer_triggered__ = detached === <span class="literal">false</span> &amp;&amp; rendered === <span class="literal">false</span></span><br><span class="line">      elem.__resize_observer__ = ro</span><br><span class="line">      ro.observe(elem)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (elem.attachEvent &amp;&amp; elem.addEventListener) &#123;</span><br><span class="line">      <span class="comment">// targeting IE9/10</span></span><br><span class="line">      elem.__resize_legacy_resize_handler__ = <span class="function"><span class="keyword">function</span> <span class="title">handleLegacyResize</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        runCallbacks(elem)</span><br><span class="line">      &#125;</span><br><span class="line">      elem.attachEvent(<span class="string">'onresize'</span>, elem.__resize_legacy_resize_handler__)</span><br><span class="line">      <span class="built_in">document</span>.addEventListener(<span class="string">'DOMSubtreeModified'</span>, elem.__resize_mutation_handler__)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!total) &#123;</span><br><span class="line">        style = createStyles(triggerStyles)</span><br><span class="line">      &#125;</span><br><span class="line">      initTriggers(elem)</span><br><span class="line"></span><br><span class="line">      elem.__resize_rendered__ = getRenderInfo(elem).rendered</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">window</span>.MutationObserver) &#123;</span><br><span class="line">        <span class="keyword">let</span> mo = <span class="keyword">new</span> MutationObserver(elem.__resize_mutation_handler__)</span><br><span class="line">        mo.observe(<span class="built_in">document</span>, &#123;</span><br><span class="line">          attributes: <span class="literal">true</span>,</span><br><span class="line">          childList: <span class="literal">true</span>,</span><br><span class="line">          characterData: <span class="literal">true</span>,</span><br><span class="line">          subtree: <span class="literal">true</span></span><br><span class="line">        &#125;)</span><br><span class="line">        elem.__resize_mutation_observer__ = mo</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  elem.__resize_listeners__.push(callback)</span><br><span class="line">  total++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">removeListener</span> (<span class="params">elem, callback</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// targeting IE9/10</span></span><br><span class="line">  <span class="keyword">if</span> (elem.detachEvent &amp;&amp; elem.removeEventListener) &#123;</span><br><span class="line">    elem.detachEvent(<span class="string">'onresize'</span>, elem.__resize_legacy_resize_handler__)</span><br><span class="line">    <span class="built_in">document</span>.removeEventListener(<span class="string">'DOMSubtreeModified'</span>, elem.__resize_mutation_handler__)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> listeners = elem.__resize_listeners__</span><br><span class="line">  <span class="keyword">if</span> (!listeners) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  listeners.splice(listeners.indexOf(callback), <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!listeners.length) &#123;</span><br><span class="line">    <span class="keyword">if</span> (elem.__resize_observer__) &#123;</span><br><span class="line">      elem.__resize_observer__.unobserve(elem)</span><br><span class="line">      elem.__resize_observer__.disconnect()</span><br><span class="line">      elem.__resize_observer__ = <span class="literal">null</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (elem.__resize_mutation_observer__) &#123;</span><br><span class="line">        elem.__resize_mutation_observer__.disconnect()</span><br><span class="line">        elem.__resize_mutation_observer__ = <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">      elem.removeEventListener(<span class="string">'scroll'</span>, handleScroll)</span><br><span class="line">      elem.removeChild(elem.__resize_triggers__.triggers)</span><br><span class="line">      elem.__resize_triggers__ = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    elem.__resize_listeners__ = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!--total &amp;&amp; style) &#123;</span><br><span class="line">    style.parentNode.removeChild(style)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUpdatedSize</span> (<span class="params">elem</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> &#123; width, height &#125; = elem.__resize_last__</span><br><span class="line">  <span class="keyword">let</span> &#123; offsetWidth, offsetHeight &#125; = elem</span><br><span class="line">  <span class="keyword">if</span> (offsetWidth !== width || offsetHeight !== height) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      width: offsetWidth,</span><br><span class="line">      height: offsetHeight</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleMutation</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// `this` denotes the scrolling element</span></span><br><span class="line">  <span class="keyword">let</span> &#123; rendered, detached &#125; = getRenderInfo(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">if</span> (rendered !== <span class="keyword">this</span>.__resize_rendered__) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!detached &amp;&amp; <span class="keyword">this</span>.__resize_triggers__) &#123;</span><br><span class="line">      resetTriggers(<span class="keyword">this</span>)</span><br><span class="line">      <span class="keyword">this</span>.addEventListener(<span class="string">'scroll'</span>, handleScroll, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.__resize_rendered__ = rendered</span><br><span class="line">    runCallbacks(<span class="keyword">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleScroll</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// `this` denotes the scrolling element</span></span><br><span class="line">  resetTriggers(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.__resize_raf__) &#123;</span><br><span class="line">    cancelAnimationFrame(<span class="keyword">this</span>.__resize_raf__)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.__resize_raf__ = requestAnimationFrame(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> updated = getUpdatedSize(<span class="keyword">this</span>)</span><br><span class="line">    <span class="keyword">if</span> (updated) &#123;</span><br><span class="line">      <span class="keyword">this</span>.__resize_last__ = updated</span><br><span class="line">      runCallbacks(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runCallbacks</span> (<span class="params">elem</span>) </span>&#123;</span><br><span class="line">  elem.__resize_listeners__.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">    callback.call(elem)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initTriggers</span> (<span class="params">elem</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> position = getComputedStyle(elem, <span class="string">'position'</span>)</span><br><span class="line">  <span class="keyword">if</span> (!position || position === <span class="string">'static'</span>) &#123;</span><br><span class="line">    elem.style.position = <span class="string">'relative'</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  elem.__resize_old_position__ = position</span><br><span class="line">  elem.__resize_last__ = &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> triggers = createElement(<span class="string">'div'</span>, &#123;</span><br><span class="line">    className: <span class="string">'resize-triggers'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">let</span> expand = createElement(<span class="string">'div'</span>, &#123;</span><br><span class="line">    className: <span class="string">'resize-expand-trigger'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">let</span> expandChild = createElement(<span class="string">'div'</span>)</span><br><span class="line">  <span class="keyword">let</span> contract = createElement(<span class="string">'div'</span>, &#123;</span><br><span class="line">    className: <span class="string">'resize-contract-trigger'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  expand.appendChild(expandChild)</span><br><span class="line">  triggers.appendChild(expand)</span><br><span class="line">  triggers.appendChild(contract)</span><br><span class="line">  elem.appendChild(triggers)</span><br><span class="line"></span><br><span class="line">  elem.__resize_triggers__ = &#123;</span><br><span class="line">    triggers,</span><br><span class="line">    expand,</span><br><span class="line">    expandChild,</span><br><span class="line">    contract</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resetTriggers(elem)</span><br><span class="line">  elem.addEventListener(<span class="string">'scroll'</span>, handleScroll, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">  elem.__resize_last__ = &#123;</span><br><span class="line">    width: elem.offsetWidth,</span><br><span class="line">    height: elem.offsetHeight</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resetTriggers</span> (<span class="params">elem</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> &#123; expand, expandChild, contract &#125; = elem.__resize_triggers__</span><br><span class="line"></span><br><span class="line">  <span class="comment">// batch read</span></span><br><span class="line">  <span class="keyword">let</span> &#123; <span class="attr">scrollWidth</span>: csw, <span class="attr">scrollHeight</span>: csh &#125; = contract</span><br><span class="line">  <span class="keyword">let</span> &#123; <span class="attr">offsetWidth</span>: eow, <span class="attr">offsetHeight</span>: eoh, <span class="attr">scrollWidth</span>: esw, <span class="attr">scrollHeight</span>: esh &#125; = expand</span><br><span class="line"></span><br><span class="line">  <span class="comment">// batch write</span></span><br><span class="line">  contract.scrollLeft = csw</span><br><span class="line">  contract.scrollTop = csh</span><br><span class="line">  expandChild.style.width = eow + <span class="number">1</span> + <span class="string">'px'</span></span><br><span class="line">  expandChild.style.height = eoh + <span class="number">1</span> + <span class="string">'px'</span></span><br><span class="line">  expand.scrollLeft = esw</span><br><span class="line">  expand.scrollTop = esh</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//util.js</span></span><br><span class="line"><span class="keyword">let</span> raf = <span class="literal">null</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">requestAnimationFrame</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!raf) &#123;</span><br><span class="line">    raf = (</span><br><span class="line">      <span class="built_in">window</span>.requestAnimationFrame ||</span><br><span class="line">      <span class="built_in">window</span>.webkitRequestAnimationFrame ||</span><br><span class="line">      <span class="built_in">window</span>.mozRequestAnimationFrame ||</span><br><span class="line">      <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> setTimeout(callback, <span class="number">16</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ).bind(<span class="built_in">window</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> raf(callback)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> caf = <span class="literal">null</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">cancelAnimationFrame</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!caf) &#123;</span><br><span class="line">    caf = (</span><br><span class="line">      <span class="built_in">window</span>.cancelAnimationFrame ||</span><br><span class="line">      <span class="built_in">window</span>.webkitCancelAnimationFrame ||</span><br><span class="line">      <span class="built_in">window</span>.mozCancelAnimationFrame ||</span><br><span class="line">      <span class="function"><span class="keyword">function</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">        clearTimeout(id)</span><br><span class="line">      &#125;</span><br><span class="line">    ).bind(<span class="built_in">window</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  caf(id)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createStyles</span> (<span class="params">styleText</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> style = <span class="built_in">document</span>.createElement(<span class="string">'style'</span>)</span><br><span class="line">  style.type = <span class="string">'text/css'</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (style.styleSheet) &#123;</span><br><span class="line">    style.styleSheet.cssText = styleText</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    style.appendChild(<span class="built_in">document</span>.createTextNode(styleText))</span><br><span class="line">  &#125;</span><br><span class="line">  (<span class="built_in">document</span>.querySelector(<span class="string">'head'</span>) || <span class="built_in">document</span>.body).appendChild(style)</span><br><span class="line">  <span class="keyword">return</span> style</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElement</span> (<span class="params">tagName, props = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> elem = <span class="built_in">document</span>.createElement(tagName)</span><br><span class="line">  <span class="built_in">Object</span>.keys(props).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    elem[key] = props[key]</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> elem</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getComputedStyle</span> (<span class="params">elem, prop, pseudo</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// for older versions of Firefox, `getComputedStyle` required</span></span><br><span class="line">  <span class="comment">// the second argument and may return `null` for some elements</span></span><br><span class="line">  <span class="comment">// when `display: none`</span></span><br><span class="line">  <span class="keyword">let</span> computedStyle = <span class="built_in">window</span>.getComputedStyle(elem, pseudo || <span class="literal">null</span>) || &#123;</span><br><span class="line">    display: <span class="string">'none'</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> computedStyle[prop]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getRenderInfo</span> (<span class="params">elem</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">document</span>.documentElement.contains(elem)) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      detached: <span class="literal">true</span>,</span><br><span class="line">      rendered: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> current = elem</span><br><span class="line">  <span class="keyword">while</span> (current !== <span class="built_in">document</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (getComputedStyle(current, <span class="string">'display'</span>) === <span class="string">'none'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        detached: <span class="literal">false</span>,</span><br><span class="line">        rendered: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    current = current.parentNode</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    detached: <span class="literal">false</span>,</span><br><span class="line">    rendered: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自适应滚动条"><a href="#自适应滚动条" class="headerlink" title="自适应滚动条"></a>自适应滚动条</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">"box"</span> <span class="attr">class</span>=<span class="string">"scrollbar_box"</span> </span></span><br><span class="line"><span class="tag">		@<span class="attr">wheel</span>=<span class="string">"scroll"</span> </span></span><br><span class="line"><span class="tag">		@<span class="attr">mouseenter</span>=<span class="string">"mouseenter($event)"</span></span></span><br><span class="line"><span class="tag">		@<span class="attr">mouseleave</span>=<span class="string">"mouseleave($event)"</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">"container"</span> <span class="attr">class</span>=<span class="string">"scrollbar_container"</span> </span></span><br><span class="line"><span class="tag">			<span class="attr">:style</span>=<span class="string">"&#123; transform : `translate(0px, $&#123;top*-1&#125;px)` &#125;"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">slot</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">"scrollbarPath"</span> <span class="attr">class</span>=<span class="string">"scrollbar_path"</span> </span></span><br><span class="line"><span class="tag">			<span class="attr">v-show</span>=<span class="string">"isVerticalBtn"</span> </span></span><br><span class="line"><span class="tag">			<span class="attr">:class</span>=<span class="string">"&#123;on: verticalCur&#125;"</span>&gt;</span></span><br><span class="line">			</span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">"verticalBtn"</span> </span></span><br><span class="line"><span class="tag">				<span class="attr">class</span>=<span class="string">"scrollbar_verticalBtn"</span> </span></span><br><span class="line"><span class="tag">				<span class="attr">:style</span>=<span class="string">"&#123; height: `$&#123;barHeight&#125;%`, top : `$&#123;barTop&#125;%` &#125;"</span> </span></span><br><span class="line"><span class="tag">				@<span class="attr">mousedown</span>=<span class="string">"startmoveV"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">	<span class="keyword">import</span> ElementResizeDetectorMaker <span class="keyword">from</span> <span class="string">'element-resize-detector'</span></span></span><br><span class="line"><span class="javascript">	<span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="undefined">		data() &#123;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">				top: <span class="number">0</span>, <span class="comment">//box偏移量px</span></span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				barHeight: <span class="number">0</span>, <span class="comment">//竖直滚动条高度</span></span></span><br><span class="line"><span class="javascript">				barTop: <span class="number">0</span>, <span class="comment">//竖直滚动条上下偏移量%</span></span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				isVerticalBtn: <span class="literal">false</span>, <span class="comment">//竖直滚动条是否显示</span></span></span><br><span class="line"><span class="javascript">				verticalCur: <span class="literal">false</span>,  <span class="comment">//鼠标悬浮滚动条显示</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				isStartmoveV: <span class="literal">false</span>, <span class="comment">//点击拖拽垂直标志位</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				point: &#123; <span class="comment">//相对拖快左上角的x,y坐标</span></span></span><br><span class="line"><span class="undefined">					y: 0</span></span><br><span class="line"><span class="undefined">				&#125;,</span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				boxPoint: &#123; <span class="comment">// 4个角容器的坐标</span></span></span><br><span class="line"><span class="undefined">					minY: 0</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="undefined">		props: &#123;</span></span><br><span class="line"><span class="javascript">			speed: &#123; <span class="comment">//鼠标滚轮速度</span></span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">Number</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="number">20</span></span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			changeTop: &#123; <span class="comment">//上下偏移量 px</span></span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">Number</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="number">0</span></span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="javascript">			containerH:&#123;  <span class="comment">//滚动区域高度</span></span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">Number</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="number">0</span></span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="undefined">		watch: &#123;</span></span><br><span class="line"><span class="javascript">			changeTop() &#123; <span class="comment">// 当外面传这个发送变化时就让到这个位置</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.setbarTop();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.setbarHeight();</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="undefined">		computed: &#123;&#125;,</span></span><br><span class="line"><span class="undefined">		methods: &#123;</span></span><br><span class="line"><span class="undefined">			mouseenter() &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.verticalCur = <span class="literal">true</span>;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			mouseleave() &#123;</span></span><br><span class="line"><span class="javascript">				setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.verticalCur = <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">				&#125;, 1000)</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="javascript">			<span class="comment">// 滚动</span></span></span><br><span class="line"><span class="undefined">			scroll(e) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.verticalCur = <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.isVerticalBtn) &#123;</span></span><br><span class="line"><span class="undefined">					e.preventDefault();</span></span><br><span class="line"><span class="undefined">					e.stopPropagation();</span></span><br><span class="line"><span class="javascript">				&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> speed = <span class="keyword">this</span>.speed;</span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				<span class="comment">//如果delta的值是负的，那么滚轮就是向下滚动，正的就是向上</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> scrollY = e.deltaY &gt; <span class="number">0</span> ? speed * <span class="number">1</span> : speed * <span class="number">-1</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> nextY = <span class="keyword">this</span>.top * <span class="number">1</span> + scrollY;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="comment">// 如果没有垂直的滚动条就滚动横向的</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.isVerticalBtn) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.setVerticalScroll(nextY)</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="javascript">			<span class="comment">//val是偏移量 滚动的 </span></span></span><br><span class="line"><span class="undefined">			setVerticalScroll(val) &#123; </span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> size = <span class="keyword">this</span>.getSize();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> topEnd = size.containerHeight - size.boxHeight;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(val &gt;= topEnd) &#123;</span></span><br><span class="line"><span class="undefined">					val = topEnd;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="keyword">this</span>.top == val) &#123; <span class="comment">// 已经到底部就不用继续执行了</span></span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.$emit(<span class="string">'bottom'</span>);</span></span><br><span class="line"><span class="undefined">				&#125;;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(val &lt;= <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="undefined">					val = 0;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="keyword">this</span>.top == val) &#123; <span class="comment">// 已经到顶部就不用继续执行了</span></span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.$emit(<span class="string">'top'</span>);</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.top = val;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.$emit(<span class="string">'update:changeTop'</span>, <span class="keyword">this</span>.top);</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.$emit(<span class="string">'update:containerH'</span>, size.containerHeight);</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.barTop = (val / size.containerHeight) * <span class="number">100</span>; <span class="comment">// 导航条的top的计算 </span></span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="javascript">			<span class="comment">// 垂直btn点击后的事件</span></span></span><br><span class="line"><span class="undefined">			startmoveV(e) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.verticalCur = <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">				e.preventDefault(); <span class="comment">//阻止默认事件，取消文字选中</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> verticalBtnReat=<span class="keyword">this</span>.$refs.verticalBtn.getBoundingClientRect()  <span class="comment">//获取滑块的坐标</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.point.y = e.clientY-verticalBtnReat.top</span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.isStartmoveV = <span class="literal">true</span> <span class="comment">//鼠标按下标志位</span></span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				<span class="built_in">document</span>.addEventListener(<span class="string">'mousemove'</span>, <span class="keyword">this</span>.fnMousemoveV, <span class="literal">false</span>);</span></span><br><span class="line"><span class="javascript">				<span class="built_in">document</span>.addEventListener(<span class="string">'mouseup'</span>, <span class="keyword">this</span>.fnMouseup, <span class="literal">false</span>);</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="javascript">			<span class="comment">// 垂直移动监听</span></span></span><br><span class="line"><span class="undefined">			fnMousemoveV(e) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.verticalCur = <span class="literal">true</span>;</span></span><br><span class="line"><span class="undefined">				e.preventDefault();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.isStartmoveV) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.setVerticalClick(e.clientY - <span class="keyword">this</span>.point.y);   <span class="comment">//鼠标移动位置</span></span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="javascript">			<span class="comment">// 点击拖拽设置</span></span></span><br><span class="line"><span class="undefined">			setVerticalClick(val) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.verticalCur = <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> size = <span class="keyword">this</span>.getSize();</span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				<span class="comment">//计算出拖快top值换算成百分比</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> barTop = ((val - <span class="keyword">this</span>.boxPoint.minY) / <span class="keyword">this</span>.$refs.box.clientHeight) * <span class="number">100</span>; </span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(barTop &lt;= <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="undefined">					barTop = 0;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="keyword">this</span>.barTop == barTop) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.$emit(<span class="string">'top'</span>);</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(barTop + <span class="keyword">this</span>.barHeight &gt;= <span class="number">100</span>) &#123;</span></span><br><span class="line"><span class="javascript">					barTop = <span class="number">100</span> - <span class="keyword">this</span>.barHeight;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="keyword">this</span>.barTop == barTop) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.$emit(<span class="string">'bottom'</span>);</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.barTop = barTop; <span class="comment">// 这里是百分比的需要转换</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.top = ((barTop / <span class="number">100</span>) * size.containerHeight).toFixed(<span class="number">2</span>) * <span class="number">1</span>; <span class="comment">//换算百分百</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.$emit(<span class="string">'update:changeTop'</span>, <span class="keyword">this</span>.top);</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.$emit(<span class="string">'update:containerH'</span>, size.containerHeight);</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="javascript">			<span class="comment">// 鼠标抬起监听</span></span></span><br><span class="line"><span class="undefined">			fnMouseup(e) &#123;</span></span><br><span class="line"><span class="undefined">				e.preventDefault();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.isStartmoveV = <span class="literal">false</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.clearMousemove();</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="javascript">			<span class="comment">// 清除监听</span></span></span><br><span class="line"><span class="undefined">			clearMousemove() &#123;</span></span><br><span class="line"><span class="javascript">				<span class="built_in">document</span>.removeEventListener(<span class="string">'mousemove'</span>, <span class="keyword">this</span>.fnMousemoveV, <span class="literal">false</span>);</span></span><br><span class="line"><span class="javascript">				<span class="built_in">document</span>.removeEventListener(<span class="string">'mouseup'</span>, <span class="keyword">this</span>.fnMouseup, <span class="literal">false</span>);</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="javascript">			<span class="comment">// 返回盒子尺寸</span></span></span><br><span class="line"><span class="undefined">			getSize() &#123; </span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> _container = <span class="keyword">this</span>.$refs.container;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> _box = <span class="keyword">this</span>.$refs.box;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">					containerHeight: _container.clientHeight, <span class="comment">//滚动内容的高度宽度</span></span></span><br><span class="line"><span class="undefined">					containerWidth: _container.clientWidth,</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					boxHeight: _box.clientHeight, <span class="comment">//最外面盒子的高度宽度</span></span></span><br><span class="line"><span class="undefined">					boxWidth: _box.clientWidth,</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="javascript">			setbarHeight() &#123; <span class="comment">//设置拖快高度</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> size = <span class="keyword">this</span>.getSize();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> boxPoint = <span class="keyword">this</span>.$refs.box.getBoundingClientRect(); <span class="comment">// container的极坐标</span></span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				<span class="comment">// 保存box窗口坐标</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.boxPoint.minY = boxPoint.top;</span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				<span class="comment">// 计算拖拽条的宽高</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.barHeight = (size.boxHeight / size.containerHeight) * <span class="number">100</span>; <span class="comment">//100是百分比，box的高度是100%,比例计算</span></span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				<span class="comment">// 是否显示拖拽条</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.isVerticalBtn = (<span class="keyword">this</span>.barHeight &gt;= <span class="number">100</span> &amp;&amp; !!<span class="keyword">this</span>.barHeight) ? <span class="literal">false</span> : <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(!<span class="keyword">this</span>.isVerticalBtn) &#123;  <span class="comment">//不显示滚动条清0 </span></span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.top = <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.barTop = <span class="number">0</span>;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			setbarTop() &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.top == <span class="keyword">this</span>.changeTop) <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> size = <span class="keyword">this</span>.getSize();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> topEnd = size.containerHeight - size.boxHeight;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.changeTop &lt; <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.top = <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">				&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.changeTop &gt;= topEnd) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.top = topEnd;</span></span><br><span class="line"><span class="javascript">				&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.top = <span class="keyword">this</span>.changeTop;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.barTop = ((<span class="keyword">this</span>.top * <span class="number">100</span>) / size.containerHeight) * <span class="number">1</span>;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			resizeListener() &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> elementResizeDetector = ElementResizeDetectorMaker(&#123;</span></span><br><span class="line"><span class="javascript">					strategy: <span class="string">'scroll'</span>,</span></span><br><span class="line"><span class="javascript">					callOnAdd: <span class="literal">false</span></span></span><br><span class="line"><span class="undefined">				&#125;)</span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				elementResizeDetector.listenTo(<span class="keyword">this</span>.$refs.container, () =&gt; &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> newcontainerH = <span class="keyword">this</span>.$slots.default[<span class="number">0</span>][<span class="string">'elm'</span>]</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="keyword">this</span>.top==<span class="number">0</span>)&#123;</span></span><br><span class="line"><span class="javascript">						<span class="built_in">console</span>.log(newcontainerH.clientHeight-<span class="keyword">this</span>.containerH)</span></span><br><span class="line"><span class="javascript">						<span class="keyword">var</span> top=newcontainerH.clientHeight-<span class="keyword">this</span>.containerH;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.$emit(<span class="string">'update:changeTop'</span>, top);</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined">					</span></span><br><span class="line"><span class="undefined">				&#125;)</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="undefined">		mounted() &#123;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">this</span>.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.setbarTop();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.setbarHeight();</span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.resizeListener();</span></span><br><span class="line"><span class="undefined">			&#125;);</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="javascript">		updated() &#123; <span class="comment">//由于数据更改导致的虚拟 DOM 重新渲染和打补丁，在这之后会调用该钩子</span></span></span><br><span class="line"><span class="javascript">			<span class="keyword">this</span>.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.setbarTop();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.setbarHeight();</span></span><br><span class="line"><span class="undefined">			&#125;);</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span> <span class="attr">lang</span>=<span class="string">"less"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">	<span class="selector-class">.scrollbar_box</span> &#123;</span></span><br><span class="line"><span class="undefined">		overflow: hidden;</span></span><br><span class="line"><span class="undefined">		position: relative;</span></span><br><span class="line"><span class="undefined">		height: 100%;</span></span><br><span class="line"><span class="undefined">		width: 100%;</span></span><br><span class="line"><span class="undefined">		transform: translateZ(0);</span></span><br><span class="line"><span class="undefined">		backface-visibility: hidden;</span></span><br><span class="line"><span class="undefined">		perspective: 1000;</span></span><br><span class="line"><span class="undefined">		transform: translate3d(0, 0, 0);</span></span><br><span class="line"><span class="css">		<span class="selector-class">.scrollbar_path</span> &#123;</span></span><br><span class="line"><span class="undefined">			position: absolute;</span></span><br><span class="line"><span class="undefined">			top: 0px;</span></span><br><span class="line"><span class="undefined">			right: 0px;</span></span><br><span class="line"><span class="undefined">			width: 6px;</span></span><br><span class="line"><span class="undefined">			height: 100%;</span></span><br><span class="line"><span class="undefined">			background-color: white;</span></span><br><span class="line"><span class="undefined">			opacity: 0;</span></span><br><span class="line"><span class="undefined">			transition: opacity 500ms;</span></span><br><span class="line"><span class="css">			&amp;<span class="selector-class">.on</span> &#123;</span></span><br><span class="line"><span class="undefined">				opacity: 1;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="css">			<span class="selector-class">.scrollbar_verticalBtn</span> &#123;</span></span><br><span class="line"><span class="undefined">				position: absolute;</span></span><br><span class="line"><span class="undefined">				top: 0px;</span></span><br><span class="line"><span class="undefined">				right: 0px;</span></span><br><span class="line"><span class="undefined">				width: 6px;</span></span><br><span class="line"><span class="undefined">				border-radius: 3px;</span></span><br><span class="line"><span class="css">				<span class="selector-tag">background-color</span>: <span class="selector-id">#51555e</span>;</span></span><br><span class="line"><span class="undefined">				cursor: pointer;</span></span><br><span class="line"><span class="undefined">				z-index: 50;</span></span><br><span class="line"><span class="css">				&amp;<span class="selector-pseudo">:hover</span> &#123;</span></span><br><span class="line"><span class="undefined">					background-color: green;</span></span><br><span class="line"><span class="undefined">					z-index: 51;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用方法</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"box"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">scrollbar</span> @<span class="attr">bottom</span>=<span class="string">"bottom"</span> @<span class="attr">top</span>=<span class="string">"top"</span> <span class="attr">:changeTop.sync</span>=<span class="string">"changeTop"</span> <span class="attr">:containerH.sync</span>=<span class="string">"containerH"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">				<span class="comment">&lt;!--&lt;p&gt;Vue自定义滚动条&lt;/p&gt;--&gt;</span></span><br><span class="line"> 				<span class="tag">&lt;<span class="name">div</span> <span class="attr">v-for</span>=<span class="string">"(str,index) in data"</span>&gt;</span> &#123;&#123;str&#125;&#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">scrollbar</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"loadingbox"</span> <span class="attr">v-show</span>=<span class="string">"isloading"</span>&gt;</span>loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">	<span class="keyword">import</span> scrollbar <span class="keyword">from</span> <span class="string">'./vue-scroll.vue'</span></span></span><br><span class="line"><span class="javascript">	<span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="undefined">		components: &#123;</span></span><br><span class="line"><span class="undefined">			scrollbar</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="undefined">		data() &#123;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="undefined">				data: [...Array(30).keys()],</span></span><br><span class="line"><span class="javascript">				isloading: <span class="literal">false</span>,</span></span><br><span class="line"><span class="undefined">				changeTop: 10000000,</span></span><br><span class="line"><span class="undefined">				containerH:0</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="undefined">		methods: &#123;</span></span><br><span class="line"><span class="undefined">			top() &#123;</span></span><br><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'顶部'</span>);</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.isloading = <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> newdata = [</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="undefined">				];</span></span><br><span class="line"><span class="javascript">				setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.data = [...newdata,...this.data];</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.isloading = <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">				&#125;, 1500);</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			bottom() &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">return</span></span></span><br><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'底部'</span>)</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.isloading = <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> newdata = [</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="undefined">				];</span></span><br><span class="line"><span class="javascript">				setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.data = [...this.data,...newdata];</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.isloading = <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">				&#125;, 1500);</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">	* &#123;</span></span><br><span class="line"><span class="undefined">		padding: 0px;</span></span><br><span class="line"><span class="undefined">		margin: 0px;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined">	</span></span><br><span class="line"><span class="css">	<span class="selector-id">#box</span> &#123;</span></span><br><span class="line"><span class="undefined">		margin: 50px auto;</span></span><br><span class="line"><span class="undefined">		text-align: center;</span></span><br><span class="line"><span class="undefined">		width: 500px;</span></span><br><span class="line"><span class="undefined">		height: 500px;</span></span><br><span class="line"><span class="undefined">		border: 1px solid red;</span></span><br><span class="line"><span class="undefined">		border-radius: 3px;</span></span><br><span class="line"><span class="undefined">		position: relative;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined">	</span></span><br><span class="line"><span class="css">	<span class="selector-id">#container</span> &#123;</span></span><br><span class="line"><span class="undefined">		width: 100%;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined">	</span></span><br><span class="line"><span class="css">	<span class="selector-id">#loadingbox</span> &#123;</span></span><br><span class="line"><span class="undefined">		width: 100%;</span></span><br><span class="line"><span class="css">		<span class="selector-tag">background</span>: <span class="selector-tag">rgba</span>(255, 255, 255, <span class="selector-class">.8</span>);</span></span><br><span class="line"><span class="undefined">		position: absolute;</span></span><br><span class="line"><span class="undefined">		left: 0;</span></span><br><span class="line"><span class="undefined">		bottom: 0;</span></span><br><span class="line"><span class="undefined">		text-align: center;</span></span><br><span class="line"><span class="undefined">		font-weight: bold;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="模拟windows的resize"><a href="#模拟windows的resize" class="headerlink" title="模拟windows的resize"></a>模拟windows的resize</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/vue.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">			html,body&#123;</span></span><br><span class="line"><span class="undefined">				width: 100%;</span></span><br><span class="line"><span class="undefined">				height: 100%;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="css">			<span class="selector-class">.container</span> &#123;</span></span><br><span class="line"><span class="undefined">				width: 100%;</span></span><br><span class="line"><span class="undefined">				height: 100%;</span></span><br><span class="line"><span class="undefined">				position: relative</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="css">			<span class="selector-class">.resize-element</span> &#123;</span></span><br><span class="line"><span class="undefined">				position: absolute;</span></span><br><span class="line"><span class="undefined">				top: 50%;</span></span><br><span class="line"><span class="undefined">				left: 50%;</span></span><br><span class="line"><span class="undefined">				height: 10rem;</span></span><br><span class="line"><span class="undefined">				width: 10rem;</span></span><br><span class="line"><span class="undefined">				transform: translate(-50%,-50%);</span></span><br><span class="line"><span class="undefined">				overflow: hidden;</span></span><br><span class="line"><span class="css">				<span class="selector-tag">resize</span>: <span class="selector-tag">both</span>;   <span class="comment">/*用户可以调节元素的宽度和高度*/</span></span></span><br><span class="line"><span class="undefined">				display: block;</span></span><br><span class="line"><span class="css">				<span class="selector-tag">box-shadow</span>: 0 0 1<span class="selector-tag">px</span> 1<span class="selector-tag">px</span> <span class="selector-id">#3361D8</span>;</span></span><br><span class="line"><span class="undefined">				border-radius: 2px;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span> <span class="attr">id</span>=<span class="string">"main"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"resize-element"</span>&gt;</span></span><br><span class="line">				改变大小试试</span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"resize-record"</span>&gt;</span></span><br><span class="line">				窗口触发了&#123;&#123;firedNum&#125;&#125;次resize事件。</span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">const</span> CSS = <span class="string">'position:absolute;left:0;top:-100%;width:100%;height:100%;margin:1px 0 0;border:none;opacity:0;visibility:hidden;pointer-events:none;'</span>;</span></span><br><span class="line"><span class="javascript">			<span class="function"><span class="keyword">function</span> <span class="title">observeResize</span>(<span class="params">element, handler</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> frame = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span></span><br><span class="line"><span class="undefined">				frame.style.cssText = CSS;</span></span><br><span class="line"><span class="javascript">				frame.onload = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">					frame.contentWindow.onresize = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">						handler(element);</span></span><br><span class="line"><span class="undefined">					&#125;;</span></span><br><span class="line"><span class="undefined">				&#125;;</span></span><br><span class="line"><span class="undefined">				element.appendChild(frame);</span></span><br><span class="line"><span class="javascript">				<span class="keyword">return</span> frame;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">let</span> element = <span class="built_in">document</span>.getElementById(<span class="string">'main'</span>);</span></span><br><span class="line"><span class="javascript">			<span class="comment">// listen for resize</span></span></span><br><span class="line"><span class="undefined">			observeResize(element, () =&gt; &#123;</span></span><br><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'new size: '</span>, &#123;</span></span><br><span class="line"><span class="undefined">					width: element.clientWidth,</span></span><br><span class="line"><span class="undefined">					height: element.clientHeight</span></span><br><span class="line"><span class="undefined">				&#125;);</span></span><br><span class="line"><span class="undefined">			&#125;);</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="实现一个简单的div-resize-Listener"><a href="#实现一个简单的div-resize-Listener" class="headerlink" title="实现一个简单的div resize Listener"></a>实现一个简单的div resize Listener</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span>Example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="function"><span class="keyword">function</span> <span class="title">ResizeSensor</span>(<span class="params">element, callback</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">				<span class="function"><span class="keyword">function</span> <span class="title">EventQueue</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.q = [];</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.add = <span class="function"><span class="keyword">function</span>(<span class="params">ev</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.q.push(ev);</span></span><br><span class="line"><span class="undefined">					&#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> i, j;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.call = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">for</span>(i = <span class="number">0</span>, j = <span class="keyword">this</span>.q.length; i &lt; j; i++) &#123;</span></span><br><span class="line"><span class="javascript">							<span class="keyword">this</span>.q[i].call();</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="undefined">					&#125;;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="function"><span class="keyword">function</span> <span class="title">getComputedStyle</span>(<span class="params">element, prop</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(element.currentStyle) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> element.currentStyle[prop];</span></span><br><span class="line"><span class="javascript">					&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">window</span>.getComputedStyle) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> <span class="built_in">window</span>.getComputedStyle(element, <span class="literal">null</span>).getPropertyValue(prop);</span></span><br><span class="line"><span class="javascript">					&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> element.style[prop];</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="function"><span class="keyword">function</span> <span class="title">attachResizeEvent</span>(<span class="params">element, resized</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(!element.resizedAttached) &#123;</span></span><br><span class="line"><span class="javascript">						element.resizedAttached = <span class="keyword">new</span> EventQueue();</span></span><br><span class="line"><span class="undefined">						element.resizedAttached.add(resized);</span></span><br><span class="line"><span class="javascript">					&#125; <span class="keyword">else</span> <span class="keyword">if</span>(element.resizedAttached) &#123;</span></span><br><span class="line"><span class="undefined">						element.resizedAttached.add(resized);</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span>;</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					element.resizeSensor = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span></span><br><span class="line"><span class="javascript">					element.resizeSensor.className = <span class="string">'resize-sensor'</span>;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> style = <span class="string">'position: absolute; left: 0; top: 0; right: 0; bottom: 0; overflow: scroll; z-index: -1; visibility: hidden;'</span>;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> styleChild = <span class="string">'position: absolute; left: 0; top: 0;'</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">					element.resizeSensor.style.cssText = style;</span></span><br><span class="line"><span class="undefined">					element.resizeSensor.innerHTML =</span></span><br><span class="line"><span class="xml">						'<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"resize-sensor-expand"</span> <span class="attr">style</span>=<span class="string">"' + style + '"</span>&gt;</span>' +</span></span><br><span class="line"><span class="xml">						'<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"' + styleChild + '"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>' +</span></span><br><span class="line"><span class="javascript">						<span class="string">'&lt;/div&gt;'</span> +</span></span><br><span class="line"><span class="xml">						'<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"resize-sensor-shrink"</span> <span class="attr">style</span>=<span class="string">"' + style + '"</span>&gt;</span>' +</span></span><br><span class="line"><span class="xml">						'<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"' + styleChild + ' width: 200%; height: 200%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>' +</span></span><br><span class="line"><span class="javascript">						<span class="string">'&lt;/div&gt;'</span>;</span></span><br><span class="line"><span class="undefined">					element.appendChild(element.resizeSensor);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(!&#123;</span></span><br><span class="line"><span class="undefined">							fixed: 1,</span></span><br><span class="line"><span class="undefined">							absolute: 1</span></span><br><span class="line"><span class="javascript">						&#125;[getComputedStyle(element, <span class="string">'position'</span>)]) &#123;</span></span><br><span class="line"><span class="javascript">						element.style.position = <span class="string">'relative'</span>;</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> expand = element.resizeSensor.childNodes[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> expandChild = expand.childNodes[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> shrink = element.resizeSensor.childNodes[<span class="number">1</span>];</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> shrinkChild = shrink.childNodes[<span class="number">0</span>];</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> lastWidth, lastHeight;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> reset = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						expandChild.style.width = expand.offsetWidth + <span class="number">10</span> + <span class="string">'px'</span>;</span></span><br><span class="line"><span class="javascript">						expandChild.style.height = expand.offsetHeight + <span class="number">10</span> + <span class="string">'px'</span>;</span></span><br><span class="line"><span class="undefined">						expand.scrollLeft = expand.scrollWidth;</span></span><br><span class="line"><span class="undefined">						expand.scrollTop = expand.scrollHeight;</span></span><br><span class="line"><span class="undefined">						shrink.scrollLeft = shrink.scrollWidth;</span></span><br><span class="line"><span class="undefined">						shrink.scrollTop = shrink.scrollHeight;</span></span><br><span class="line"><span class="undefined">						lastWidth = element.offsetWidth;</span></span><br><span class="line"><span class="undefined">						lastHeight = element.offsetHeight;</span></span><br><span class="line"><span class="undefined">					&#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">					reset();</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> changed = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(element.resizedAttached) &#123;</span></span><br><span class="line"><span class="undefined">							element.resizedAttached.call();</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="undefined">					&#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> addEvent = <span class="function"><span class="keyword">function</span>(<span class="params">el, name, cb</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(el.attachEvent) &#123;</span></span><br><span class="line"><span class="javascript">							el.attachEvent(<span class="string">'on'</span> + name, cb);</span></span><br><span class="line"><span class="javascript">						&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="undefined">							el.addEventListener(name, cb);</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="undefined">					&#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					addEvent(expand, <span class="string">'scroll'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(element.offsetWidth &gt; lastWidth || element.offsetHeight &gt; lastHeight) &#123;</span></span><br><span class="line"><span class="undefined">							changed();</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="undefined">						reset();</span></span><br><span class="line"><span class="undefined">					&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					addEvent(shrink, <span class="string">'scroll'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(element.offsetWidth &lt; lastWidth || element.offsetHeight &lt; lastHeight) &#123;</span></span><br><span class="line"><span class="undefined">							changed();</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="undefined">						reset();</span></span><br><span class="line"><span class="undefined">					&#125;);</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="string">"[object Array]"</span> === <span class="built_in">Object</span>.prototype.toString.call(element) ||(<span class="string">'undefined'</span> !== <span class="keyword">typeof</span> jQuery &amp;&amp; element <span class="keyword">instanceof</span> jQuery) <span class="comment">//jquery</span></span></span><br><span class="line"><span class="javascript">					||(<span class="string">'undefined'</span> !== <span class="keyword">typeof</span> Elements &amp;&amp; element <span class="keyword">instanceof</span> Elements) <span class="comment">//mootools</span></span></span><br><span class="line"><span class="undefined">				) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> i = <span class="number">0</span>,</span></span><br><span class="line"><span class="undefined">						j = element.length;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">for</span>(; i &lt; j; i++) &#123;</span></span><br><span class="line"><span class="undefined">						attachResizeEvent(element[i], callback);</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="javascript">				&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="undefined">					attachResizeEvent(element, callback);</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.detach = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="undefined">					ResizeSensor.detach(element);</span></span><br><span class="line"><span class="undefined">				&#125;;</span></span><br><span class="line"><span class="undefined">			&#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			ResizeSensor.detach = <span class="function"><span class="keyword">function</span>(<span class="params">element</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(element.resizeSensor) &#123;</span></span><br><span class="line"><span class="undefined">					element.removeChild(element.resizeSensor);</span></span><br><span class="line"><span class="javascript">					<span class="keyword">delete</span> element.resizeSensor;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">delete</span> element.resizedAttached;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;;</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"width"</span>&gt;</span>100px wide<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"main"</span> <span class="attr">style</span>=<span class="string">"resize:both;width:100px;overflow:scroll;border:1px solid black;"</span> <span class="attr">id</span>=<span class="string">"resize"</span>&gt;</span>You can resize me!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">"textarea"</span>&gt;</span>You can focus me!<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">var</span> sensor = <span class="keyword">new</span> ResizeSensor(<span class="built_in">document</span>.getElementById(<span class="string">"main"</span>),<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">					<span class="built_in">console</span>.log(<span class="string">"anything inside of element caused my size to change"</span>);</span></span><br><span class="line"><span class="undefined">				&#125;)</span></span><br><span class="line"><span class="javascript">			<span class="keyword">var</span> sensor2 = <span class="keyword">new</span> ResizeSensor(<span class="built_in">document</span>.getElementById(<span class="string">"textarea"</span>),<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">					<span class="built_in">console</span>.log(<span class="string">"anything inside of element caused my size to change"</span>);</span></span><br><span class="line"><span class="undefined">				&#125;)</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/31/写一个webpack-loader-插件/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/31/写一个webpack-loader-插件/" itemprop="url">写一个webpack-loader-插件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-31T22:39:14+08:00">
                2018-12-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="DEMO-Code-地址"><a href="#DEMO-Code-地址" class="headerlink" title="DEMO Code 地址"></a><a href="https://github.com/libin1991/webpack4-vue-more-page-cli/tree/master/%E5%86%99%E4%B8%80%E4%B8%AAwebpack-loader-%E6%8F%92%E4%BB%B6" target="_blank" rel="noopener"><font color="#ff0000">DEMO Code 地址</font></a></h3><h3 id="Webpack-Loader"><a href="#Webpack-Loader" class="headerlink" title="Webpack Loader"></a>Webpack Loader</h3><p>loader 用于对模块的源代码进行转换。loader 可以使你在 import 或”加载”模块时预处理文件。因此，loader 类似于其他构建工具中“任务(task)”，并提供了处理前端构建步骤的强大方法。loader 可以将文件从不同的语言（如 TypeScript）转换为 JavaScript，或将内联图像转换为 data URL。</p>
<p>loader 是导出为一个函数的 node 模块。该函数在 loader 转换资源的时候调用。给定的函数将调用 loader API，并通过 this 上下文访问。</p>
<p>loader是一个node module,那么它的基本形式如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">module.exports = function(source) &#123;</span><br><span class="line">  return source;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>loader只能传入一个包含包含资源文件内容的字符串（source）<br>如果是同步loader,可以用 return 或者 this.callback(err, value…) 将代码返回<br>异步loader：在一个异步的模块中，回传时需要调用 Loader API 提供的回调方法 this.async 来获取 callback 函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">module.exports = function(content, map, meta) &#123;</span><br><span class="line">  var callback = this.async();</span><br><span class="line">  someAsyncOperation(content, function(err, result) &#123;</span><br><span class="line">    if (err) return callback(err);</span><br><span class="line">    callback(null, result, map, meta);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h4 id="txt-loader"><a href="#txt-loader" class="headerlink" title="txt-loader"></a>txt-loader</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">const &#123; getOptions &#125; = require(&apos;loader-utils&apos;);</span><br><span class="line">const validateOptions = require(&apos;schema-utils&apos;);</span><br><span class="line"></span><br><span class="line">const schema = require(&apos;./options&apos;);</span><br><span class="line"></span><br><span class="line">module.exports = function rawLoader(source) &#123;</span><br><span class="line">  const options = getOptions(this) || &#123;&#125;;</span><br><span class="line">   </span><br><span class="line">  validateOptions(schema, options, &apos;Raw Loader&apos;);</span><br><span class="line"></span><br><span class="line">  const json = JSON.stringify(source)</span><br><span class="line">    .replace(/\u2028/g, &apos;\\u2028&apos;)</span><br><span class="line">    .replace(/\u2029/g, &apos;\\u2029&apos;);</span><br><span class="line">  return `module.exports = $&#123;json&#125;`;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="webpack-config-js"><a href="#webpack-config-js" class="headerlink" title="webpack.config.js"></a>webpack.config.js</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">let path=require(&quot;path&quot;);</span><br><span class="line">let HtmlWebpackPlugin=require(&quot;html-webpack-plugin&quot;);</span><br><span class="line">let ExtractTextWebpackPlugin=require(&quot;extract-text-webpack-plugin&quot;);</span><br><span class="line">let CleanWebpackPlugin=require(&quot;clean-webpack-plugin&quot;);</span><br><span class="line">let webpack=require(&quot;webpack&quot;);</span><br><span class="line">let VueLoaderPlugin = require(&apos;vue-loader/lib/plugin&apos;);</span><br><span class="line"></span><br><span class="line">module.exports=&#123;</span><br><span class="line">    entry:&quot;./src/index.js&quot;,</span><br><span class="line">    output:&#123;</span><br><span class="line">        filename:&quot;bundle.[hash:4].js&quot;,</span><br><span class="line">        path:path.resolve(&quot;dist&quot;)</span><br><span class="line">    &#125;,</span><br><span class="line">    resolveLoader: &#123;</span><br><span class="line">        modules: [</span><br><span class="line">            path.resolve(__dirname, &apos;loaders&apos;),</span><br><span class="line">            &apos;node_modules&apos;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    module:&#123;</span><br><span class="line">        rules:[</span><br><span class="line">            &#123;</span><br><span class="line">                test:/\.css$/,</span><br><span class="line">                use:ExtractTextWebpackPlugin.extract(&#123;</span><br><span class="line">                    use:&quot;css-loader&quot;,</span><br><span class="line">                    publicPath:&quot;../&quot;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test:/\.less$/,</span><br><span class="line">                use:[</span><br><span class="line">                    &#123;loader:&quot;style-loader&quot;&#125;,</span><br><span class="line">                    &#123;loader:&quot;css-loader&quot;&#125;,</span><br><span class="line">                    &#123;loader:&quot;less-loader&quot;&#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test:/\.(jpe?g|png|gif)$/,</span><br><span class="line">                use:[</span><br><span class="line">                    &#123;</span><br><span class="line">                        loader:&quot;url-loader&quot;,</span><br><span class="line">                        options:&#123;</span><br><span class="line">                            limit:8192,</span><br><span class="line">                            outputPath:&quot;images/&quot;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test:/\.(htm|html)$/,</span><br><span class="line">                use:&quot;html-withimg-loader&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test:/\.(eot|ttf|woff|svg)$/,</span><br><span class="line">                use:&quot;file-loader&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test:/\.js$/,</span><br><span class="line">                include:/src/,</span><br><span class="line">                exclude:/node_modules/,</span><br><span class="line">                use:&#123;</span><br><span class="line">                    loader:&quot;babel-loader&quot;,</span><br><span class="line">                    options:&#123;</span><br><span class="line">                        presets:[&quot;@babel/preset-env&quot;]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test:/\.vue$/,</span><br><span class="line">                use:&quot;vue-loader&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">		        test: /\.txt$/,</span><br><span class="line">		        use: &#123;</span><br><span class="line">		            loader:&apos;txt-loader&apos;,</span><br><span class="line">		            options:&#123;</span><br><span class="line">                       </span><br><span class="line">                    &#125;</span><br><span class="line">		        &#125;</span><br><span class="line">		      &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins:[</span><br><span class="line">        new HtmlWebpackPlugin(&#123;</span><br><span class="line">            template:&quot;./src/index.html&quot;,</span><br><span class="line">            hash:true</span><br><span class="line">        &#125;),</span><br><span class="line">        new ExtractTextWebpackPlugin(&quot;css/style.css&quot;),</span><br><span class="line">        new CleanWebpackPlugin(&quot;dist&quot;),</span><br><span class="line">        new webpack.HotModuleReplacementPlugin(),</span><br><span class="line">        new VueLoaderPlugin()</span><br><span class="line">    ],</span><br><span class="line">    devServer:&#123;</span><br><span class="line">        contentBase:&quot;./dist&quot;,</span><br><span class="line">        host:&quot;localhost&quot;,</span><br><span class="line">        port:8888,</span><br><span class="line">        open:true,</span><br><span class="line">        hot:true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="file-txt"><a href="#file-txt" class="headerlink" title="file.txt"></a>file.txt</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//file.txt</span><br><span class="line"></span><br><span class="line">123456</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import txt from &apos;./file.txt&apos;;</span><br><span class="line">console.log(txt)   //123456</span><br></pre></td></tr></table></figure>
<h3 id="写一个webpack插件："><a href="#写一个webpack插件：" class="headerlink" title="写一个webpack插件："></a>写一个webpack插件：</h3><p>主要的步骤如下:</p>
<ul>
<li>编写一个JavaScript命名函数。</li>
<li>在它的原型上定义一个apply方法。</li>
<li>指定挂载的webpack事件钩子。</li>
<li>处理webpack内部实例的特定数据。<br>  功能完成后调用webpack提供的回调。<br>  编写插件之前要理解compiler和compilation两个对象，以及webpack生命周期的各个阶段和钩子，plugin比loader强大，通过plugin你可以访问compliler和compilation过程，通过钩子拦截webpack的执行。</li>
</ul>
<p>比如我们可以在构建读取txt文件内容生成到文件名到out.txt的文件中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&apos;fs&apos;);</span><br><span class="line">var RawSource = require(&apos;webpack-core/lib/RawSource&apos;);</span><br><span class="line"></span><br><span class="line">module.exports = TestPlugin;</span><br><span class="line"></span><br><span class="line">function TestPlugin() &#123;</span><br><span class="line">	this.imports = [];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TestPlugin.prototype.apply = function(compiler) &#123;</span><br><span class="line">	var imports = this.imports;</span><br><span class="line"></span><br><span class="line">	compiler.plugin(&apos;this-compilation&apos;, function(compilation) &#123;</span><br><span class="line">		compilation.plugin(&apos;normal-module-loader&apos;, function(loaderContext, module) &#123;</span><br><span class="line">			loaderContext[__dirname] = function(file) &#123;</span><br><span class="line">				if(imports.indexOf(file) === -1) &#123;</span><br><span class="line">					imports.push(file);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	compiler.plugin(&apos;after-compile&apos;, function(compilation, callback) &#123;</span><br><span class="line">		var filename = &apos;out.txt&apos;;</span><br><span class="line">		var content = imports.map(function(file) &#123;</span><br><span class="line">			return fs.readFileSync(file);</span><br><span class="line">		&#125;).join(&apos;\n&apos;);</span><br><span class="line">		console.log(content);</span><br><span class="line">		compilation.assets[filename] = new RawSource(content);</span><br><span class="line">		callback();</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="webpack-config-js-1"><a href="#webpack-config-js-1" class="headerlink" title="webpack.config.js"></a>webpack.config.js</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">var MyPlugin = require(&apos;./plugin&apos;);</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">	entry: &apos;./index.js&apos;,</span><br><span class="line">	output: &#123;</span><br><span class="line">		filename: &apos;out.js&apos;</span><br><span class="line">	&#125;,</span><br><span class="line">	module: &#123;</span><br><span class="line">		loaders: [</span><br><span class="line">			&#123;</span><br><span class="line">				test: /\.txt$/,</span><br><span class="line">				loader: &apos;./loader&apos;,</span><br><span class="line">			&#125;</span><br><span class="line">		]</span><br><span class="line">	&#125;,</span><br><span class="line">	plugins: [</span><br><span class="line">		new MyPlugin()</span><br><span class="line">	]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="index-js"><a href="#index-js" class="headerlink" title="index.js"></a>index.js</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">require(&apos;./sample.txt&apos;);</span><br><span class="line">require(&apos;./sample2.txt&apos;);</span><br><span class="line">require(&apos;./sample3.txt&apos;);</span><br></pre></td></tr></table></figure>
<h3 id="webpack-loader—自己写一个按需加载插件"><a href="#webpack-loader—自己写一个按需加载插件" class="headerlink" title="webpack loader—自己写一个按需加载插件"></a><a href="https://juejin.im/post/5b8e3162f265da432f655639#heading-5" target="_blank" rel="noopener">webpack loader—自己写一个按需加载插件</a></h3><h3 id="webpack-之-loader-和-plugin-简介"><a href="#webpack-之-loader-和-plugin-简介" class="headerlink" title="webpack 之 loader 和 plugin 简介"></a><a href="https://juejin.im/post/5980752ef265da3e2e56e82e#heading-0" target="_blank" rel="noopener">webpack 之 loader 和 plugin 简介</a></h3><h3 id="webpack-doc"><a href="#webpack-doc" class="headerlink" title="webpack doc"></a><a href="https://webpack.js.org/contribute/writing-a-loader/" target="_blank" rel="noopener">webpack doc</a></h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/tx.jpg" alt="李斌">
            
              <p class="site-author-name" itemprop="name">李斌</p>
              <p class="site-description motion-element" itemprop="description">想要飞得高，那就把地平线忘掉</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">154</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">109</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/libin1991" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://juejin.im/user/57e737f6c4c971005f6bcd8d" target="_blank" title="juejin">
                      
                        <i class="fa fa-fw fa-spinner"></i>juejin</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李斌</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
<script type="text/javascript" src="/js/src/clicklove.js"></script>

