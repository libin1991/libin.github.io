<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="舞动乾坤">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="舞动乾坤">
<meta property="og:description" content="Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="舞动乾坤">
<meta name="twitter:description" content="Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/">





  <title>舞动乾坤 - 星光不问赶路人 岁月不负有心人</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband">
    	<div class="eevee"><div class="body"><div class="head"><div class="ears"><div class="ear"><div class="lobe"></div></div><div class="ear"><div class="lobe"></div></div></div><div class="face"><div class="eyes"><div class="eye"><div class="eyelid"></div></div><div class="eye"><div class="eyelid"></div></div></div><div class="nose"></div><div class="mouth"></div></div></div><div class="chest"><div class="fur"><div class="patch"></div></div><div class="fur"><div class="patch"></div></div><div class="fur"><div class="patch"></div></div></div><div class="legs"><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div></div><div class="tail"><div class="tail"><div class="tail"><div class="tail"><div class="tail"><div class="tail -end"></div></div></div></div></div></div></div></div>
    </div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
    	<div id="sky">
				<div id="background" class="container">
			<!-- svg file -->
			<svg id="svgout" height="100%" width="100%" viewbox="0 0 550 400">
				<defs>
					<g id="bottomShadow">
						<path fill="#000000" stroke="none" d="
		M 270.5 225.95
		L 127.35 316.65 266.8 400 409.6 309.25 270.5 225.95 Z"/>
					</g>
					<g id="Layer52_0_FILL">
						<path class="topGrass" fill="#B9D668" stroke="none" d="
	M 397.85 229.3
	L 397.85 225.6 269.85 152 135.75 228.6 135.75 233.65 262.1 306.55 397.85 229.3 Z"/>
					</g>
					<g id="Layer51_0_FILL">
						<path class="leftSideGrass" fill="#6E9E4F" stroke="none" d="
	M 135.1 229.95
	L 135.1 256.85 262.1 328.4 262.1 301.85 135.1 229.95 Z"/>
					</g>
					<g id="Layer50_0_FILL">
						<path class="rightGrassTop" fill="#8CB154" stroke="none" d="
	M 397.85 225.95
	L 395.8 225.95 261.75 301.55 261.75 328.4 397.85 251.15 397.85 225.95 Z"/>
					</g>
					<g id="Layer48_0_FILL">
						<path class="crustLeftTop" fill="#955541" stroke="none" d="
	M 135.45 282.4
	L 135.75 298.15 262.1 372.1 261.75 355.65 135.45 282.4 Z"/>
					</g>
					<g id="Layer47_0_FILL">
						<path class="middleLeftCrust" fill="#C77E61" stroke="none" d="
	M 135.1 270.3
	L 135.1 283.05 275.9 364.35 271.85 348.9 135.1 270.3 Z"/>
					</g>
					<g id="Layer46_0_FILL">
						<path class="crustLeftTop" fill="#955541" stroke="none" d="
	M 135.1 255.15
	L 135.1 270.3 262.1 343.55 262.1 328.05 135.1 255.15 Z"/>
					</g>
					<g id="Layer45_0_FILL">
						<path class="topRightCrust" fill="#A47237" stroke="none" d="
	M 397.5 294.5
	L 397.5 277 261.75 355.3 261.75 372.75 397.5 294.5 Z"/>
					</g>
					<g id="Layer44_0_FILL">
						<path class="middleRightCrust" fill="#C89451" stroke="none" d="
	M 397.5 269.95
	L 397.15 266.6 262.1 343.2 262.1 355.95 397.5 279.7 397.5 269.95 Z"/>
					</g>
					<g id="Layer43_0_FILL">
						<path class="topRightCrust" fill="#A47237" stroke="none" d="
	M 397.5 266.6
	L 397.5 250.45 261.75 328.4 261.75 343.85 397.5 266.6 Z"/>
					</g>
					<g id="Layer41_0_FILL">
						<path class="greyRoad" fill="#B2B2B1" stroke="none" d="
	M 295.05 283.05
	Q 299.05 280.35 308.45 275.3 317.85 269.95 323.6 266.9
	L 268.8 233.65 338.05 191.35 309.15 174.55 177.75 254.5
	Q 191.55 262.2 198.25 266.25 204.65 269.95 209.7 271.95
	L 241.6 250.45 295.05 283.05 Z"/>
					</g>
					<g id="Layer40_0_FILL">
						<path fill="#FFFFFF" stroke="none" d="
	M 199.95 256.85
	Q 194.55 261.2 191.9 262.2
	L 194.9 263.9 200.95 259.2 199.95 256.85
	M 225.8 243.75
	L 224.8 241.75 211.05 250.8 212.05 252.8 225.8 243.75
	M 308.15 275.65
	L 296.7 266.6 295.35 268.6 306.8 277.7 308.15 275.65
	M 275.9 253.5
	L 274.55 255.5 285.95 264.55 287.3 262.55 275.9 253.5
	M 251.7 227.3
	L 250.7 225.25 236.9 234.35 237.9 236.35 251.7 227.3
	M 257.05 240.7
	L 254.05 240.7 268.8 249.8 269.5 247.75 257.05 240.7
	M 277.2 207.8
	L 263.45 216.85 264.45 218.9 278.25 209.8 277.2 207.8
	M 305.1 192.65
	L 304.1 190.65 290.3 199.75 291.35 201.75 305.1 192.65 Z"/>
					</g>
					<g id="Layer38_0_FILL">
						<path class="frontFascia" fill="#ECB27B" stroke="none" d="
	M 359.25 187.95
	L 346.4 174.95 333.85 202.9 359.25 187.95 Z"/>
					</g>
					<g id="Layer37_0_FILL">
						<path class="frontWall" fill="#EFA258" stroke="none" d="
	M 334 201.05
	L 334.35 232 359.2 217.55 359.25 187.95 334 201.05 Z"/>
					</g>
					<g id="Layer36_0_FILL">
						<path class="leftWall" fill="#C57F42" stroke="none" d="
	M 334.35 232.3
	L 334.35 205.1 305.1 191.35 305.1 216.85 334.35 232.3 Z"/>
					</g>
					<g id="Layer35_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 329.7 167.9
	L 331.05 167.9 344.55 176.7 347.85 176.7 363 192.25 363.15 189.55 350.65 176.7 350.55 176.7 334.25 167.5 334.25 159.1 329.7 159.1 329.7 164.9 322.65 160.95 322.3 162.15 329.7 167 329.7 167.9 Z"/>
					</g>
					<g id="Layer34_0_FILL">
						<path class="leftRoof" fill="#F2563B" stroke="none" d="
	M 334.05 207.05
	L 350.65 176.7 322.1 160.45 302.1 192.05 334.05 207.05 Z"/>
					</g>
					<g id="Layer30_0_FILL">
						<path id="windowFour" class="windows" stroke="none" fill="#975A42" d="
	M 341.35 203.3
	Q 340.9 203.45 340.5 203.8 340.1 204.2 339.85 204.75 339.7 205 339.7 205.3 339.6 205.75 339.7 206.1 339.7 206.15 339.7 206.2 339.8 206.5 340 206.8 340.55 207.4 341.45 207.4 342.35 207.4 343 206.8 343.4 206.5 343.65 206.1 343.85 205.75 343.95 205.3 344.05 204.4 343.55 203.8 343.3 203.45 343 203.3 342.65 203.15 342.2 203.15 341.8 203.15 341.35 203.3
	M 355.85 198.45
	Q 355.8 198.2 355.6 198 355.1 197.4 354.2 197.4 353.35 197.4 352.6 198 351.85 198.65 351.7 199.55 351.7 199.7 351.7 199.85 351.6 200.5 352 201.05 352.55 201.65 353.45 201.65 354.3 201.65 355.05 201.05 355.45 200.7 355.7 200.25 355.8 200.05 355.9 199.85 355.95 199.7 355.95 199.55 356.05 198.95 355.85 198.45 Z"/>
						<path class="door" fill="#B65041" stroke="none" d="
	M 351.95 211.2
	L 351.8 211.2 346.05 215.1 346.05 225.2 351.95 221.6 351.95 211.2
	M 351.2 211.2
	L 351.35 211.2 351.35 211.1 351.2 211.2 Z"/>
					</g>
					<g>
						<path id="Layer30_0_FILL" fill="#000000" fill-opacity="1" stroke="none" d="
	M 183.7 215.3
	L 183.7 215.6
	Q 187.25 231.75 212.25 234.35
	L 183.7 215.3 Z"/>
					</g>
					<g id="Layer29_0_FILL">
						<path fill="#000000" fill-opacity="0.4" stroke="none" d="
	M 305.1 216.85
	L 305.15 217.2
	Q 309.45 233.2 334.35 232.3
	L 305.1 216.85 Z"/>
					</g>
					<g id="Layer27_0_FILL">
						<path class="vegetation" fill="#78A950" stroke="none" d="
	M 177.45 231.65
	Q 175.75 235.35 181.8 239.35 185.5 235.7 185.15 231.3 182.8 230.65 181.45 234 179.45 231.3 177.45 231.65
	M 236.9 266.6
	Q 235.2 270.3 241.25 274.3 244.95 270.6 244.65 266.25 242.3 265.6 240.95 268.95 238.9 266.25 236.9 266.6
	M 254.7 277
	Q 253.05 280.7 259.1 284.75 262.75 281.05 262.45 276.65 260.1 276 258.75 279.35 256.7 276.65 254.7 277
	M 315.5 245.75
	Q 313.5 243.05 311.5 243.4 309.8 247.1 315.85 251.15 319.55 247.45 319.2 243.05 316.85 242.4 315.5 245.75
	M 295.35 232.65
	Q 293.7 236.35 299.75 240.4 303.45 236.7 303.1 232.3 300.75 231.65 299.4 235 297.4 232.3 295.35 232.65
	M 277.2 171.85
	Q 275.55 175.55 281.6 179.55 285.3 175.85 284.95 171.5 282.6 170.85 281.25 174.2 279.25 171.5 277.2 171.85 Z"/>
					</g>
					<g id="Layer26_0_FILL">
						<path class="treeWood" fill="#AE663D" stroke="none" d="
	M 175.1 177.55
	L 172.05 177.55 172.05 191.1 159.3 172.85
	Q 154.6 171.5 172.05 195.7
	L 172.05 212.5 175.1 212.5 175.1 177.55
	M 252.7 151.35
	L 249 151.35 249 176.9 252.7 176.9 252.7 151.35 Z"/>
					</g>
					<g id="Layer25_0_FILL">
						<path class="vegetation" fill="#77A951" stroke="none" d="
	M 192.55 179.55
	Q 200.95 173.5 200.95 165.1 200.95 156.4 192.55 150 184.15 144.3 172.05 144.3 160.3 144.3 151.9 150 143.15 156.4 143.15 165.1 143.15 173.5 151.9 179.55 160.3 185.95 172.05 185.95 184.15 185.95 192.55 179.55
	M 236.25 106.65
	Q 230.2 116.05 230.2 129.15 230.2 142.25 236.25 151.35 242.3 160.75 250.7 160.75 258.75 160.75 264.8 151.35 270.85 142.25 270.85 129.15 270.85 116.05 264.8 106.65 258.75 97.6 250.7 97.6 242.3 97.6 236.25 106.65 Z"/>
					</g>
					<g id="Layer24_0_FILL">
						<path class="vegetation" fill="#77A951" stroke="none" d="
	M 158.3 221.9
	Q 160.65 221.9 161.95 220.2 163 219.55 163.3 218.55 164.65 218.9 166.35 218.9 170.05 218.9 172.4 216.2 175.1 213.85 175.1 210.15 175.1 206.45 172.4 203.75 170.05 201.4 166.35 201.4 162.65 201.4 159.95 203.75 157.6 206.45 157.6 210.15 157.6 210.8 157.6 211.15 155.95 211.5 154.6 212.5 152.9 214.15 152.9 216.55 152.9 218.9 154.6 220.2 156.25 221.9 158.3 221.9
	M 338.35 240.05
	Q 341.05 237.7 341.05 234 341.05 230.3 338.35 227.6 336 225.25 332.3 225.25 328.65 225.25 325.95 227.6 323.6 230.3 323.6 234 323.6 237.7 325.95 240.05 328.65 242.75 332.3 242.75 336 242.75 338.35 240.05 Z"/>
					</g>
					<g id="Layer22_0_FILL">
						<path class="rightRoof" fill="#D05041" stroke="none" d="
	M 220 173.85
	L 236.8 186.7 264.35 171.15 244.5 159.55 220 173.85 Z"/>
					</g>
					<g id="Layer21_0_FILL">
						<path class="leftWall" fill="#C57F42" stroke="none" d="
	M 212.25 191.35
	L 183.35 172.3 183.7 215.3 212.25 234.35 212.25 191.35 Z"/>
					</g>
					<g id="Layer20_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 192.1 149.85
	L 236.45 174.8 243.1 171.4
	Q 220.05 150.55 196.3 139.95
	L 192.1 149.85 Z"/>
					</g>
					<g id="Layer19_0_FILL">
						<path class="frontFascia" fill="#EBB17B" stroke="none" d="
	M 226.85 160.95
	L 212 190.6 229.75 192.6 239.75 172.85 226.85 160.95 Z"/>
					</g>
					<g id="Layer18_0_FILL">
						<path class="frontWall" fill="#EFA258" stroke="none" d="
	M 240.15 172.65
	L 211.9 191.6 212.25 233.65 264.35 201.7 264.35 170.8 240.8 184.45 240.15 172.65 Z"/>
					</g>
					<g id="Layer17_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 210.9 142.2
	L 205.9 142.2 205.9 152.65 210.9 152.65 210.9 142.2 Z"/>
					</g>
					<g>
						<path id="Layer16_0_FILL" class="leftRoof" fill="#F2563B" stroke="none" d="
	M 210.25 195.5
	L 227.4 160.95 195.45 141.35 177.65 175.85 210.25 195.5 Z"/>
					</g>
					<g>
						<path id="sun" fill="#E3BD0E" stroke="none" d="
	M 257.05 15.95
	Q 251.7 15.95 248 19.65 244.3 23.35 244.3 28.7 244.3 34.1 248 37.8 251.7 41.5 257.05 41.5 262.45 41.5 266.15 37.8 269.85 34.1 269.85 28.7 269.85 23.35 266.15 19.65 262.45 15.95 257.05 15.95 Z"/>
					</g>
					<g id="Layer8_0_FILL">
						<path fill="#975A42" stroke="none" d="
	M 238.45 189.65
	Q 238.295703125 189.362109375 238.05 189.1 237.35 188.3 236.2 188.3 235.05 188.3 234.15 189.1 233.3 189.9 233.2 191.05 233.1 192.2 233.8 193 234.55 193.8 235.7 193.8 236.85 193.8 237.7 193 238.1970703125 192.558203125 238.45 192 238.6552734375 191.56484375 238.7 191.05 238.7671875 190.276953125 238.45 189.65
	M 220.55 197.55
	Q 220 197.55 219.5 197.75 218.95 197.95 218.5 198.35 217.933203125 198.8833984375 217.7 199.55 217.5833984375 199.916796875 217.55 200.3 217.4923828125 200.96171875 217.7 201.5 217.852734375 201.9103515625 218.15 202.25 218.95 203.05 220.1 203.05 221.25 203.05 222.05 202.25 222.95 201.45 223.05 200.3 223.15 199.15 222.4 198.35 222.05 197.95 221.65 197.75 221.15 197.55 220.55 197.55 Z"/>
					</g>
					<g id="Layer7_0_FILL">
						<path class="door" fill="#B65041" stroke="none" d="
	M 233.55 206.75
	L 225.9 211.95 226.25 225.5 233.95 220.35 233.55 206.75 Z"/>
					</g>
					<g>
						<path id="windowOne" class="windows" fill="#975A42" stroke="none" d="
	M 188.65 198.4
	L 188.8 204.1 198.65 210.45 198.55 204.75 188.65 198.4
	M 208.45 216.8
	L 208.35 211.1 198.55 204.75 198.65 210.45 208.45 216.8
	M 188.8 204.1
	L 188.95 209.8 198.8 216.15 198.65 210.45 188.8 204.1
	M 208.6 222.5
	L 208.45 216.8 198.65 210.45 198.8 216.15 208.6 222.5 Z"/>
					</g>
					<g>
						<path id="windowThree" class="windows" fill="#975A42" stroke="none" d="
	M 311.7 214.1
	L 318.55 217.55 318.45 211.9 311.6 208.45 311.7 214.1
	M 325.4 221
	L 325.25 215.35 318.45 211.9 318.55 217.55 325.4 221
	M 318.4 206.2
	L 311.5 202.75 311.6 208.45 318.45 211.9 318.4 206.2
	M 325.25 215.35
	L 325.2 209.7 318.4 206.2 318.45 211.9 325.25 215.35 Z"/>
					</g>
					<g id="Layer2_0_FILL">
						<path class="door" fill="#B65041" stroke="none" d="
	M 259.7 183.25
	L 244.6 191.9 244.6 213.8 259.7 204.55 259.7 183.25 Z"/>
					</g>
					<path id="windowTwo" fill="#975A42" class="windows" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" d="
	M 223.05 200.3
	Q 222.95 201.45 222.05 202.25 221.25 203.05 220.1 203.05 218.95 203.05 218.15 202.25 217.852734375 201.9103515625 217.7 201.5 217.4923828125 200.96171875 217.55 200.3 217.5833984375 199.916796875 217.7 199.575 217.933203125 198.8833984375 218.5 198.35 218.95 197.95 219.5 197.75 220 197.55 220.55 197.55 221.15 197.55 221.65 197.75 222.05 197.95 222.4 198.35 223.15 199.15 223.05 200.3 Z
	M 238.7 191.05
	Q 238.6552734375 191.56484375 238.45 192 238.1970703125 192.558203125 237.7 193 236.85 193.8 235.7 193.8 234.55 193.8 233.8 193 233.1 192.2 233.2 191.05 233.3 189.9 234.15 189.1 235.05 188.3 236.2 188.3 237.35 188.3 238.05 189.1 238.295703125 189.362109375 238.45 189.65 238.7671875 190.276953125 238.7 191.05 Z"/>
					<path fill="#F2563B" stroke="none" d=" M 351.95 211.2 L 351.8 211.2 346.05 215.1 346.05 225.2 351.95 221.6 351.95 211.2 Z"/>
					<path id="Layer6_0_1_STROKES" class="windowRims" stroke="#AE663D" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" fill="none" d="
	M 198.55 204.75
	L 208.35 211.1 208.45 216.8 208.6 222.5 198.8 216.15 188.95 209.8 188.8 204.1 188.65 198.4 198.55 204.75 198.65 210.45 208.45 216.8
	M 198.8 216.15
	L 198.65 210.45 188.8 204.1"/>
					<path id="Layer5_0_1_STROKES" class="windowRims" stroke="#AE663D" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" fill="none" d="
	M 325.25 215.35
	L 325.4 221 318.55 217.55 311.7 214.1 311.6 208.45 311.5 202.75 318.4 206.2 325.2 209.7 325.25 215.35 318.45 211.9 318.55 217.55
	M 318.4 206.2
	L 318.45 211.9 311.6 208.45"/>
				</defs>
				<g id="shadow">
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use xlink:href="#bottomShadow"/>
					</g>
				</g>
				<g transform="matrix( 1, 0, 0, 1, 0,0) ">
					<use xlink:href="#sun"/>
				</g>
				<g id="earth">
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer52_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer51_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer50_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer48_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer47_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer46_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer45_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer44_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer43_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer41_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer40_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer38_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer37_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer36_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer35_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer34_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowFour"/>
						<use class="element" xlink:href="#Layer32_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer30_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer27_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer26_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer25_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer24_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer22_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer21_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer20_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer19_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer18_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer17_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer16_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer8_0_FILL"/>
						<use class="element" xlink:href="#windowTwo"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer7_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowOne"/>
						<use class="element" xlink:href="#Layer6_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowThree"/>
						<use class="element" xlink:href="#Layer5_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer2_0_FILL"/>
					</g>
				</g>
			</svg>
			<! -- End of SVG file -->
			<! -- Moon/Sun Toggle -->
			<div id="toggleButton" class="day-toggle">
				<div class="sun-icon"></div>
				<label class="switch">
            <input id="toggleCheckbox" type="checkbox">
            <div class="slider"></div>
        </label>
				<div class="cloud-icon"></div>
			</div>
			<! -- Moon/Sun Toggle -->
			<! -- End of Container -->
		</div>
			</div>
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">舞动乾坤</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">星光不问赶路人 岁月不负有心人</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/06/一道赋值面试题引发的思考/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/06/一道赋值面试题引发的思考/" itemprop="url">一道赋值面试题引发的思考</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-06T17:53:16+08:00">
                2019-01-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="开头先来做一道面试题"><a href="#开头先来做一道面试题" class="headerlink" title="开头先来做一道面试题"></a>开头先来做一道面试题</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a=&#123;<span class="attr">n</span>:<span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> b=a;</span><br><span class="line">a.x=a=&#123;<span class="attr">n</span>:<span class="number">2</span>&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(a.x);</span><br><span class="line"><span class="built_in">console</span>.log(b.x);</span><br></pre></td></tr></table></figure>
<p>最后输出的是什么？ 先不说答案，我们来分析一下</p>
<p>(第二行) 我们把a赋值给b， 由于a是对象类型，这就意味着b和a指向同一个内存地址<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a.x = a = &#123; <span class="attr">n</span>: <span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们有个疑惑，这句语句执行顺序是 <code>a = {n: 2} &amp;&amp; a.x = {n:2}</code> 还是 <code>a.x = {n:2} &amp;&amp; a= {n:2}</code> 还是这种 <code>a = {n: 2} &amp;&amp; a.x = a</code></p>
<p>我们这里可以借助 <code>Object.defineProperty</code> 或 ES6的 <code>Proxy</code>来验证多项赋值的顺序是怎样的<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = newProxy(&#123;&#125;, &#123;</span><br><span class="line">  set(target, key, value, r) &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(key, value)</span><br><span class="line">	<span class="keyword">if</span> (key === <span class="string">'a'</span>) <span class="built_in">Reflect</span>.set(target, key, <span class="string">'isA'</span>, r);</span><br><span class="line">	<span class="keyword">else</span> <span class="built_in">Reflect</span>.set(target, key, value, r);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">obj.b = obj.a= &#123;<span class="attr">n</span>: <span class="number">1</span>&#125;;</span><br><span class="line"><span class="comment">// 输出:</span></span><br><span class="line"><span class="comment">// "a" &#123;n: 1&#125;</span></span><br><span class="line"><span class="comment">// "b" &#123;n: 1&#125;</span></span><br><span class="line"></span><br><span class="line">obj.a; <span class="comment">// isA</span></span><br><span class="line">obj.b; <span class="comment">// &#123;n: 1&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>所以我们可以得出 赋值的顺序是从右边开始到左边的。而且是直接 <code>a = {n: 1}, a.x = {n:1 }</code>，而不是 <code>a.x = a</code> 这样去赋值</p>
<p>现在我们再借助 Proxy 来分析一开始part1这道题，用obj.a, obj.b 来代替原题目的 a和b。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = newProxy(&#123;&#125;, &#123;</span><br><span class="line">  get: <span class="function"><span class="keyword">function</span> (<span class="params">target, key, receiver</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`getting <span class="subst">$&#123;key&#125;</span>!`</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, key, receiver);</span><br><span class="line">  &#125;,</span><br><span class="line">  set: <span class="function"><span class="keyword">function</span> (<span class="params">target, key, value, receiver</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`setting <span class="subst">$&#123;key&#125;</span>!`</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Reflect</span>.set(target, key, value, receiver);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">obj.a = &#123;<span class="attr">n</span>: <span class="number">1</span> &#125;;<span class="comment">// getting a;</span></span><br><span class="line">obj.b = obj.a; <span class="comment">// getting a; setting b;</span></span><br><span class="line">obj.a.x = obj.a = &#123;<span class="attr">n</span>:<span class="number">2</span> &#125;; <span class="comment">// getting a; setting a;</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到 <code>obj.a.x = obj.a = {n: 2}</code>这段语句执行时，会先输出一个 <strong>getting a</strong> 再输出 <strong>setting a</strong>。<br>这就意味着在对 <code>obj.a.x</code> 赋值时，程序是先获取 <code>obj.a</code>指向的对象的内存地址，此时触发了 <strong>getting a</strong>，然后再对右边 <code>obj.a</code> 进行赋值，触发了 <strong>setting a</strong>， 赋值完最后一步才是对 <code>obj.a.x</code>赋值 <code>{n:2 }</code>。</p>
<p><font color="#ff0000"> <strong> 重点: 在对obj.a.x赋值的时刻已经获取了obj.a该对象指向的内存地址【也就是obj.a.x在obj.a赋值前就已经确定了】，所以后面a就算指向其他地址，也和这里的obj.a.x无关。此时指向该地址的还有obj.b </strong> </font> <br> </p>
<p>我们再用三张图来捋一捋整理的思路</p>
<p>执行 <code>obj.a = {n: 1}; obj.b = obj.a</code>后obj对应的引用是这样的</p>
<p><img src="/2019/01/06/一道赋值面试题引发的思考/init.png" alt=""></p>
<p>执行 <code>obj.a.x = xxx</code> 时</p>
<p><img src="/2019/01/06/一道赋值面试题引发的思考/obj.a.x.png" alt=""></p>
<p>执行<code>obj.a.x = obj.a = {n:2}</code> 后</p>
<p><img src="/2019/01/06/一道赋值面试题引发的思考/result.png" alt=""></p>
<p>至此，这道面试题相信大家都有答案了，可以自己去控制台验证一下。 假如这时候再执行 <code>obj.a.n = 3</code>， 打印<code>obj.b</code>会输出什么呢？</p>
<p><img src="/2019/01/06/一道赋值面试题引发的思考/1.png" alt=""></p>
<h2 id="对象循环引用"><a href="#对象循环引用" class="headerlink" title="对象循环引用"></a>对象循环引用</h2><p>接下来我们来看另一道题，关于对象循环引用的<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = &#123; <span class="attr">n</span>: <span class="number">1</span>&#125;</span><br><span class="line">a.b = a;</span><br></pre></td></tr></table></figure></p>
<p>这里的a明显是循环引用，那么我们要怎样才能判断一个对象是否是循环引用呢？<br><img src="/2019/01/06/一道赋值面试题引发的思考/2.png" alt=""></p>
<p>其实这道题我一开始除了递归判断外没有很好的解决方案，后面是群里一个大佬说(这道题也是他出的)直接用 <code>JSON.stringify</code>，微信小游戏的源码里面就是这么去判断。</p>
<p><code>JSON.stringify</code> 如果遇到参数里有循环引用的，就会抛出一个循环调用的错误 <strong>Uncaught TypeError: Converting circular structure to JSON</strong><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Uncaught <span class="built_in">TypeError</span>: Converting circular structure to <span class="built_in">JSON</span></span><br><span class="line">    at <span class="built_in">JSON</span>.stringify (<span class="xml"><span class="tag">&lt;<span class="name">anonymous</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">    at mainctrl.js:234</span></span><br><span class="line"><span class="xml">    at Object.getUser (api.js:247)</span></span><br><span class="line"><span class="xml">    at mainctrl.js:228</span></span><br></pre></td></tr></table></figure></p>
<p>那如果不用JSON.stringify或者想要自己实现一个去检测循环调用，该怎么写呢？（面试官和部门前端leader最喜欢这么问）</p>
<p>一般遇到这种，最简单的方法就是去找这个方法的 polyfill， <a href="https://github.com/bestiejs/json3" target="_blank" rel="noopener">json3</a>。我找的是 json3的 polyfill 里面大概是遍历对象存到stack数组，再在解析的时候去判断是否有循环引用的情况。 <a href="https://github.com/bestiejs/json3/blob/master/lib/json3.js#L482" target="_blank" rel="noopener">json3.js#L482</a></p>
<p>照着他的思路大概写了一个，其实就是前面说到的简单递归判断</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> stack = [];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> len;</span><br><span class="line">    <span class="keyword">for</span> (len = stack.length; len--;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stack[len] === obj) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"循环引用"</span>)     <span class="comment">//循环引用</span></span><br><span class="line">    &#125;</span><br><span class="line">    stack.push(obj);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">in</span> obj) &#123;</span><br><span class="line">        <span class="keyword">const</span> value = obj[k]</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'object'</span>) fn(value);     <span class="comment">//递归判断</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2019/01/06/一道赋值面试题引发的思考/3.png" alt=""> </p>
<h2 id="对象循环引用破解办法"><a href="#对象循环引用破解办法" class="headerlink" title="对象循环引用破解办法"></a>对象循环引用破解办法</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Demo: Circular reference</span></span><br><span class="line"><span class="keyword">var</span> o = &#123;&#125;;</span><br><span class="line">o.o = o;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Note: cache should not be re-used by repeated calls to JSON.stringify.</span></span><br><span class="line"><span class="keyword">var</span> cache = [];</span><br><span class="line"><span class="built_in">JSON</span>.stringify(o, <span class="function"><span class="keyword">function</span>(<span class="params">key, value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'object'</span> &amp;&amp; value !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cache.indexOf(value) !== <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="comment">// Circular reference found, discard key</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Store value in our collection</span></span><br><span class="line">        cache.push(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;);</span><br><span class="line">cache = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
<p><img src="/2019/01/06/一道赋值面试题引发的思考/4.png" alt=""> </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/03/JS设计模式/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/03/JS设计模式/" itemprop="url">JS设计模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-03T13:11:06+08:00">
                2019-01-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="发布订阅模式"><a href="#发布订阅模式" class="headerlink" title="发布订阅模式"></a>发布订阅模式</h2><blockquote>
<p>订阅-发布模式定义了对象之间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖它的对象都可以得到通知。</p>
</blockquote>
<p>了解过事件机制或者函数式编程的朋友，应该会体会到“订阅-发布模式”所带来的“<strong>时间解耦</strong>”和“<strong>空间解耦</strong>”的优点。<br>借助函数式编程中闭包和回调的概念，可以很优雅地实现这种设计模式。</p>
<h3 id="“订阅-发布模式”-vs-观察者模式"><a href="#“订阅-发布模式”-vs-观察者模式" class="headerlink" title="“订阅-发布模式” vs 观察者模式"></a>“订阅-发布模式” vs 观察者模式</h3><p>订阅-发布模式和观察者模式概念相似，但在订阅-发布模式中，订阅者和发布者之间多了一层中间件：一个被抽象出来的信息调度中心。<br>最大的特点是集中管理，统一触发。</p>
<p>JS中一般用事件模型来代替传统的发布-订阅模式。任何一个对象的原型链被指向<code>Event</code>的时候，这个对象便可以绑定自定义事件和对应的回调函数。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Event = &#123;</span><br><span class="line">  clientList: &#123;&#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 绑定事件监听</span></span><br><span class="line">  listen(key, fn)&#123;</span><br><span class="line">    <span class="keyword">if</span>(! <span class="keyword">this</span>.clientList[key])&#123;</span><br><span class="line">      <span class="keyword">this</span>.clientList[key] = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.clientList[key].push(fn);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 触发对应事件</span></span><br><span class="line">  trigger()&#123;</span><br><span class="line">    <span class="keyword">const</span> key = <span class="built_in">Array</span>.prototype.shift.apply(<span class="built_in">arguments</span>),</span><br><span class="line">      fns = <span class="keyword">this</span>.clientList[key];</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span>(!fns || fns.length === <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">let</span> fn <span class="keyword">of</span> fns)&#123;</span><br><span class="line">        fn.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 移除相关事件</span></span><br><span class="line">  remove(key, fn)&#123;</span><br><span class="line">    <span class="keyword">let</span> fns = <span class="keyword">this</span>.clientList[key];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果之前没有绑定事件</span></span><br><span class="line">    <span class="comment">// 或者没有指明要移除的事件</span></span><br><span class="line">    <span class="comment">// 直接返回</span></span><br><span class="line">    <span class="keyword">if</span>(!fns || !fn)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 反向遍历移除置指定事件函数</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> l = fns.length - <span class="number">1</span>; l &gt;= <span class="number">0</span>; l--)&#123;</span><br><span class="line">      <span class="keyword">let</span> _fn = fns[l];</span><br><span class="line">      <span class="keyword">if</span>(_fn === fn)&#123;</span><br><span class="line">        fns.splice(l, <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为对象动态安装 发布-订阅 功能</span></span><br><span class="line"><span class="keyword">const</span> installEvent = <span class="function">(<span class="params">obj</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> key <span class="keyword">in</span> Event)&#123;</span><br><span class="line">    obj[key] = Event[key];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> salesOffices = &#123;&#125;;</span><br><span class="line">installEvent(salesOffices);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定自定义事件和回调函数</span></span><br><span class="line"></span><br><span class="line">salesOffices.listen(<span class="string">"event01"</span>, fn1 = <span class="function">(<span class="params">price</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Price is"</span>, price, <span class="string">"at event01"</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">salesOffices.listen(<span class="string">"event02"</span>, fn2 = <span class="function">(<span class="params">price</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Price is"</span>, price, <span class="string">"at event02"</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">salesOffices.trigger(<span class="string">"event01"</span>, <span class="number">1000</span>);</span><br><span class="line">salesOffices.trigger(<span class="string">"event02"</span>, <span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">salesOffices.remove(<span class="string">"event01"</span>, fn1);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出: false</span></span><br><span class="line"><span class="comment">// 说明删除成功</span></span><br><span class="line"><span class="built_in">console</span>.log(salesOffices.trigger(<span class="string">"event01"</span>, <span class="number">1000</span>));</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="状态模式"><a href="#状态模式" class="headerlink" title="状态模式"></a>状态模式</h2><p>状态模式：对象行为是基于状态来改变的。</p>
<p>内部的状态转化，导致了行为表现形式不同。<br>所以，用户在外面看起来，好像是修改了行为。</p>
<h3 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h3><p>优点</p>
<blockquote>
<p>封装了转化规则，对于大量分支语句，可以考虑使用状态类进一步封装。<br>每个状态都是确定的，所以对象行为是可控的。</p>
</blockquote>
<p>缺点</p>
<blockquote>
<p>状态模式的关键是将事物的状态都封装成单独的类，这个类的各种方法就是“此种状态对应的表现行为”。<br>因此，状态类会增加程序开销。</p>
</blockquote>
<p>在JavaScript中，可以直接用JSON对象来代替状态类。</p>
<p>下面代码展示的就是FSM（有限状态机）里面有3种状态：download、pause、deleted。<br>控制状态转化的代码也在其中。</p>
<p>DownLoad类就是，常说的Context对象，它的行为会随着状态的改变而改变。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> FSM = <span class="function">(<span class="params">(</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> currenState = <span class="string">"download"</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    download: &#123;</span><br><span class="line">      click: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"暂停下载"</span>);</span><br><span class="line">        currenState = <span class="string">"pause"</span>;</span><br><span class="line">      &#125;,</span><br><span class="line">      del: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"先暂停, 再删除"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    pause: &#123;</span><br><span class="line">      click: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"继续下载"</span>);</span><br><span class="line">        currenState = <span class="string">"download"</span>;</span><br><span class="line">      &#125;,</span><br><span class="line">      del: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"删除任务"</span>);</span><br><span class="line">        currenState = <span class="string">"deleted"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    deleted: &#123;</span><br><span class="line">      click: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"任务已删除, 请重新开始"</span>);</span><br><span class="line">      &#125;,</span><br><span class="line">      del: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"任务已删除"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    getState: <span class="function"><span class="params">()</span> =&gt;</span> currenState</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Download</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(fsm) &#123;</span><br><span class="line">    <span class="keyword">this</span>.fsm = fsm;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleClick() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; fsm &#125; = <span class="keyword">this</span>;</span><br><span class="line">    fsm[fsm.getState()].click();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hanldeDel() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; fsm &#125; = <span class="keyword">this</span>;</span><br><span class="line">    fsm[fsm.getState()].del();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开始下载</span></span><br><span class="line"><span class="keyword">let</span> download = <span class="keyword">new</span> Download(FSM);</span><br><span class="line"></span><br><span class="line">download.handleClick(); <span class="comment">// 暂停下载</span></span><br><span class="line">download.handleClick(); <span class="comment">// 继续下载</span></span><br><span class="line">download.hanldeDel(); <span class="comment">// 下载中，无法执行删除操作</span></span><br><span class="line">download.handleClick(); <span class="comment">// 暂停下载</span></span><br><span class="line">download.hanldeDel(); <span class="comment">// 删除任务</span></span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="装饰者模式"><a href="#装饰者模式" class="headerlink" title="装饰者模式"></a>装饰者模式</h2><p>装饰者模式：在不改变对象自身的基础上，动态地添加功能代码。</p>
<p>根据描述，装饰者显然比继承等方式更灵活，而且不污染原来的代码，代码逻辑松耦合。</p>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>装饰者模式由于松耦合，多用于一开始不确定对象的功能、或者对象功能经常变动的时候。<br>尤其是在参数检查、参数拦截等场景。</p>
<p>ES6的装饰器语法规范只是在“提案阶段”，而且不能装饰普通函数或者箭头函数。</p>
<p>下面的代码，addDecorator可以为指定函数增加装饰器。</p>
<p>其中，装饰器的触发可以在函数运行之前，也可以在函数运行之后。</p>
<p>注意：装饰器需要保存函数的运行结果，并且返回。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> addDecorator = <span class="function">(<span class="params">fn, before, after</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> isFn = <span class="function"><span class="params">fn</span> =&gt;</span> <span class="keyword">typeof</span> fn === <span class="string">"function"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!isFn(fn)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> result;</span><br><span class="line">    <span class="comment">// 按照顺序执行“装饰函数”</span></span><br><span class="line">    isFn(before) &amp;&amp; before(...args);</span><br><span class="line">    <span class="comment">// 保存返回函数结果</span></span><br><span class="line">    isFn(fn) &amp;&amp; (result = fn(...args));</span><br><span class="line">    isFn(after) &amp;&amp; after(...args);</span><br><span class="line">    <span class="comment">// 最后返回结果</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************以下是测试代码******************/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> beforeHello = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Before Hello, args are <span class="subst">$&#123;args&#125;</span>`</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hello = <span class="function">(<span class="params">name = <span class="string">"user"</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Hello, <span class="subst">$&#123;name&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">return</span> name;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> afterHello = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`After Hello, args are <span class="subst">$&#123;args&#125;</span>`</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wrappedHello = addDecorator(hello, beforeHello, afterHello);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> result = wrappedHello(<span class="string">"godbmw.com"</span>);   <span class="comment">//高阶函数</span></span><br><span class="line"><span class="built_in">console</span>.log(result);</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="责任链模式"><a href="#责任链模式" class="headerlink" title="责任链模式"></a>责任链模式</h2><p>责任链模式：多个对象均有机会处理请求，从而解除发送者和接受者之间的耦合关系。这些对象连接成为链式结构，每个节点转发请求，直到有对象处理请求为止。</p>
<p>其核心就是：请求者不必知道是谁哪个节点对象处理的请求。如果当前不符合终止条件，那么把请求转发给下一个节点处理。</p>
<p>而当需求具有“传递”的性质时（代码中其中一种体现就是：多个if、else if、else if、else嵌套），就可以考虑将每个分支拆分成一个节点对象，拼接成为责任链。</p>
<h3 id="优点与代价"><a href="#优点与代价" class="headerlink" title="优点与代价"></a>优点与代价</h3><p>优点</p>
<blockquote>
<p>可以根据需求变动，任意向责任链中添加 / 删除节点对象<br>没有固定的“开始节点”，可以从任意节点开始</p>
</blockquote>
<p>代价</p>
<blockquote>
<p>责任链最大的代价就是每个节点带来的多余消耗。当责任链过长，很多节点只有传递的作用，而不是真正地处理逻辑。</p>
</blockquote>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>为了方便演示，模拟常见的“日志打印”场景。模拟了 3 种级别的日志输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LogHandler: 普通日志</span><br><span class="line">WarnHandler：警告日志</span><br><span class="line">ErrorHandler：错误日志</span><br></pre></td></tr></table></figure></p>
<p>首先我们会构造“责任链”：LogHandler -&gt; WarnHandler -&gt; ErrorHandler。LogHandler作为链的开始节点。</p>
<p>如果是普通日志，那么就由 LogHandler 处理，停止传播；如果是 Warn 级别的日志，那么 LogHandler 就会自动向下传递，WarnHandler 接收到并且处理，停止传播；Error 级别日志同理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.next = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setNext(handler) &#123;</span><br><span class="line">    <span class="keyword">this</span>.next = handler;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(...props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(...props);</span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">"log"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handle(level, msg) &#123;</span><br><span class="line">    <span class="keyword">if</span> (level === <span class="keyword">this</span>.name) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`LOG: <span class="subst">$&#123;msg&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.next &amp;&amp; <span class="keyword">this</span>.next.handle(...arguments);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WarnHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(...props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(...props);</span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">"warn"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handle(level, msg) &#123;</span><br><span class="line">    <span class="keyword">if</span> (level === <span class="keyword">this</span>.name) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`WARN: <span class="subst">$&#123;msg&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.next &amp;&amp; <span class="keyword">this</span>.next.handle(...arguments);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ErrorHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(...props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(...props);</span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">"error"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handle(level, msg) &#123;</span><br><span class="line">    <span class="keyword">if</span> (level === <span class="keyword">this</span>.name) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`ERROR: <span class="subst">$&#123;msg&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.next &amp;&amp; <span class="keyword">this</span>.next.handle(...arguments);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************以下是测试代码******************/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> logHandler = <span class="keyword">new</span> LogHandler();</span><br><span class="line"><span class="keyword">let</span> warnHandler = <span class="keyword">new</span> WarnHandler();</span><br><span class="line"><span class="keyword">let</span> errorHandler = <span class="keyword">new</span> ErrorHandler();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置下一个处理的节点</span></span><br><span class="line">logHandler.setNext(warnHandler);</span><br><span class="line">warnHandler.setNext(errorHandler);</span><br><span class="line"></span><br><span class="line">logHandler.handle(<span class="string">"error"</span>, <span class="string">"Some error occur"</span>);</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="享元模式"><a href="#享元模式" class="headerlink" title="享元模式"></a>享元模式</h2><p>享元模式：运用共享技术来减少创建对象的数量，从而减少内存占用、提高性能。</p>
<p>享元模式提醒我们将一个对象的属性划分为内部和外部状态。<br>内部状态：可以被对象集合共享，通常不会改变<br>外部状态：根据应用场景经常改变<br>享元模式是利用时间换取空间的优化模式。</p>
<h3 id="应用场景-1"><a href="#应用场景-1" class="headerlink" title="应用场景"></a>应用场景</h3><p>享元模式虽然名字听起来比较高深，但是实际使用非常容易：只要是需要大量创建重复的类的代码块，均可以使用享元模式抽离内部/外部状态，减少重复类的创建。</p>
<p>为了显示它的强大，下面的代码是简单地实现了大家耳熟能详的“对象池”，以彰显这种设计模式的魅力。</p>
<h3 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h3><p>这里利用javascript实现了一个“通用对象池”类–ObjectPool。这个类管理一个装载空闲对象的数组，如果外部需要一个对象，直接从对象池中获取，而不是通过new操作。</p>
<p>对象池可以大量减少重复创建相同的对象，从而节省了系统内存，提高运行效率。</p>
<p>为了形象说明“享元模式”在“对象池”实现和应用，特别准备了模拟了File类，并且模拟了“文件下载”操作。</p>
<p>通过阅读下方代码可以发现：对于File类，内部状态是pool属性和download方法；外部状态是name和src(文件名和文件链接)。借助对象池，实现了File类的复用。</p>
<blockquote>
<p>注：为了方便演示，Javascript实现的是并发操作。输出结果略有不同。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对象池</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectPool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>._pool = []; <span class="comment">//</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建对象</span></span><br><span class="line">  create(Obj) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._pool.length === <span class="number">0</span></span><br><span class="line">      ? <span class="keyword">new</span> Obj(<span class="keyword">this</span>) <span class="comment">// 对象池中没有空闲对象，则创建一个新的对象</span></span><br><span class="line">      : <span class="keyword">this</span>._pool.shift(); <span class="comment">// 对象池中有空闲对象，直接取出，无需再次创建</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 对象回收</span></span><br><span class="line">  recover(obj) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._pool.push(obj);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 对象池大小</span></span><br><span class="line">  size() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._pool.length;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模拟文件对象</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(pool) &#123;</span><br><span class="line">    <span class="keyword">this</span>.pool = pool;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 模拟下载操作</span></span><br><span class="line">  download() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`+ 从 <span class="subst">$&#123;<span class="keyword">this</span>.src&#125;</span> 开始下载 <span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>`</span>);</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`- <span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span> 下载完毕`</span>); <span class="comment">// 下载完毕后, 将对象重新放入对象池</span></span><br><span class="line">      <span class="keyword">this</span>.pool.recover(<span class="keyword">this</span>);</span><br><span class="line">    &#125;, <span class="number">100</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/****************** 以下是测试函数 **********************/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> objPool = <span class="keyword">new</span> ObjectPool();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> file1 = objPool.create(File);</span><br><span class="line">file1.name = <span class="string">"文件1"</span>;</span><br><span class="line">file1.src = <span class="string">"https://download1.com"</span>;</span><br><span class="line">file1.download();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> file2 = objPool.create(File);</span><br><span class="line">file2.name = <span class="string">"文件2"</span>;</span><br><span class="line">file2.src = <span class="string">"https://download2.com"</span>;</span><br><span class="line">file2.download();</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> file3 = objPool.create(File);</span><br><span class="line">  file3.name = <span class="string">"文件3"</span>;</span><br><span class="line">  file3.src = <span class="string">"https://download3.com"</span>;</span><br><span class="line">  file3.download();</span><br><span class="line">&#125;, <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">setTimeout(</span><br><span class="line">  () =&gt;</span><br><span class="line">    <span class="built_in">console</span>.log(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;<span class="string">"*"</span>.repeat(<span class="number">50</span>)&#125;</span>\n下载了3个文件，但其实只创建了<span class="subst">$&#123;objPool.size()&#125;</span>个对象`</span></span><br><span class="line">    ),</span><br><span class="line">  <span class="number">1000</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>输出结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+ 从 https://download1.com 开始下载 文件1</span><br><span class="line">+ 从 https://download2.com 开始下载 文件2</span><br><span class="line">- 文件1 下载完毕</span><br><span class="line">- 文件2 下载完毕</span><br><span class="line">+ 从 https://download3.com 开始下载 文件3</span><br><span class="line">- 文件3 下载完毕</span><br><span class="line">**************************************************</span><br><span class="line">下载了3个文件，但其实只创建了2个对象</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="组合模式"><a href="#组合模式" class="headerlink" title="组合模式"></a>组合模式</h2><p>组合模式，将对象组合成树形结构以表示“部分-整体”的层次结构。</p>
<p>用小的子对象构造更大的父对象，而这些子对象也由更小的子对象构成<br>单个对象和组合对象对于用户暴露的接口具有一致性，而同种接口不同表现形式亦体现了多态性</p>
<h3 id="应用场景-2"><a href="#应用场景-2" class="headerlink" title="应用场景"></a>应用场景</h3><p>组合模式可以在需要针对“树形结构”进行操作的应用中使用，例如扫描文件夹、渲染网站导航结构等等。</p>
<h3 id="代码实现-2"><a href="#代码实现-2" class="headerlink" title="代码实现"></a>代码实现</h3><p>这里用代码模拟文件扫描功能，封装了File和Folder两个类。在组合模式下，用户可以向Folder类嵌套File或者Folder来模拟真实的“文件目录”的树结构。</p>
<p>同时，两个类都对外提供了scan接口，File下的scan是扫描文件，Folder下的scan是调用子文件夹和子文件的scan方法。整个过程采用的是深度优先。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(name) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name || <span class="string">"File"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  add() &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"文件夹下面不能添加文件"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  scan() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"扫描文件: "</span> + <span class="keyword">this</span>.name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文件夹类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Folder</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(name) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name || <span class="string">"Folder"</span>;</span><br><span class="line">    <span class="keyword">this</span>.files = [];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  add(file) &#123;</span><br><span class="line">    <span class="keyword">this</span>.files.push(file);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  scan() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"扫描文件夹: "</span> + <span class="keyword">this</span>.name);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> file <span class="keyword">of</span> <span class="keyword">this</span>.files) &#123;</span><br><span class="line">      file.scan();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> home = <span class="keyword">new</span> Folder(<span class="string">"用户根目录"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> folder1 = <span class="keyword">new</span> Folder(<span class="string">"第一个文件夹"</span>),</span><br><span class="line">  folder2 = <span class="keyword">new</span> Folder(<span class="string">"第二个文件夹"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> file1 = <span class="keyword">new</span> File(<span class="string">"1号文件"</span>),</span><br><span class="line">  file2 = <span class="keyword">new</span> File(<span class="string">"2号文件"</span>),</span><br><span class="line">  file3 = <span class="keyword">new</span> File(<span class="string">"3号文件"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将文件添加到对应文件夹中</span></span><br><span class="line">folder1.add(file1);</span><br><span class="line"></span><br><span class="line">folder2.add(file2);</span><br><span class="line">folder2.add(file3);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将文件夹添加到更高级的目录文件夹中</span></span><br><span class="line">home.add(folder1);</span><br><span class="line">home.add(folder2);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描目录文件夹</span></span><br><span class="line">home.scan();</span><br></pre></td></tr></table></figure>
<p>执行<code>$ node main.js</code>，最终输出结果是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">扫描文件夹: 用户根目录</span><br><span class="line">扫描文件夹: 第一个文件夹</span><br><span class="line">扫描文件: 1号文件</span><br><span class="line">扫描文件夹: 第二个文件夹</span><br><span class="line">扫描文件: 2号文件</span><br><span class="line">扫描文件: 3号文件</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h2><p>命令模式是一种数据驱动的设计模式，它属于行为型模式。</p>
<p>请求以命令的形式包裹在对象中，并传给调用对象。<br>调用对象寻找可以处理该命令的合适的对象，并把该命令传给相应的对象。<br>该对象执行命令。<br>在这三步骤中，分别有3个不同的主体：发送者、传递者和执行者。在实现过程中，需要特别关注。</p>
<h3 id="应用场景-3"><a href="#应用场景-3" class="headerlink" title="应用场景"></a>应用场景</h3><p>有时候需要向某些对象发送请求，但是又不知道请求的接受者是谁，更不知道被请求的操作是什么。此时，命令模式就是以一种松耦合的方式来设计程序。</p>
<p>setCommand方法为按钮指定了命令对象，命令对象为调用者（按钮）找到了接收者（MenuBar），并且执行了相关操作。而按钮本身并不需要关心接收者和接受操作。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接受到命令，执行相关操作</span></span><br><span class="line"><span class="keyword">const</span> MenuBar = &#123;</span><br><span class="line">  refresh()&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"刷新菜单页面"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 命令对象，execute方法就是执行相关命令</span></span><br><span class="line"><span class="keyword">const</span> RefreshMenuBarCommand = <span class="function"><span class="params">receiver</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    execute()&#123;</span><br><span class="line">      receiver.refresh();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为按钮对象指定对应的 对象 </span></span><br><span class="line"><span class="keyword">const</span> setCommand = <span class="function">(<span class="params">button, command</span>) =&gt;</span> &#123;</span><br><span class="line">  button.onclick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    command.execute();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> refreshMenuBarCommand = RefreshMenuBarCommand(MenuBar);</span><br><span class="line"><span class="keyword">let</span> button = <span class="built_in">document</span>.querySelector(<span class="string">"button"</span>);</span><br><span class="line">setCommand(button, refreshMenuBarCommand);</span><br></pre></td></tr></table></figure>
<p>下面是同级目录的html代码，在谷歌浏览器中打开创建的index.html，并且打开控制台，即可看到效果。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>命令模式<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span>&gt;</span>按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./main.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="迭代器模式"><a href="#迭代器模式" class="headerlink" title="迭代器模式"></a>迭代器模式</h2><p>迭代器模式是指提供一种方法顺序访问一个集合对象的各个元素，使用者不需要了解集合对象的底层实现。</p>
<h3 id="内部迭代器和外部迭代器"><a href="#内部迭代器和外部迭代器" class="headerlink" title="内部迭代器和外部迭代器"></a>内部迭代器和外部迭代器</h3><p>内部迭代器：封装的方法完全接手迭代过程，外部只需要一次调用。</p>
<p>外部迭代器：用户必须显式地请求迭代下一元素。熟悉C++的朋友，可以类比C++内置对象的迭代器的 end()、next()等方法。</p>
<blockquote>
<p>这里实现的是一个外部迭代器。需要实现边界判断函数、元素获取函数和更新索引函数。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Iterator = <span class="function"><span class="params">obj</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> current = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> next = <span class="function"><span class="params">()</span> =&gt;</span> current += <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">let</span> end = <span class="function"><span class="params">()</span> =&gt;</span> current &gt;= obj.length;</span><br><span class="line">  <span class="keyword">let</span> get = <span class="function"><span class="params">()</span> =&gt;</span> obj[current];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    next,</span><br><span class="line">    end,</span><br><span class="line">    get</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myIter = Iterator([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="keyword">while</span>(!myIter.end()) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(myIter.get())</span><br><span class="line">  myIter.next();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h2><p>代理模式的定义：为一个对象提供一种代理以方便对它的访问。</p>
<p>代理模式可以解决避免对一些对象的直接访问，以此为基础，常见的有保护代理和虚拟代理。保护代理可以在代理中直接拒绝对对象的访问；虚拟代理可以延迟访问到真正需要的时候，以节省程序开销。</p>
<h3 id="代理模式优缺点"><a href="#代理模式优缺点" class="headerlink" title="代理模式优缺点"></a>代理模式优缺点</h3><p>代理模式有高度解耦、对象保护、易修改等优点。</p>
<p>同样地，因为是通过“代理”访问对象，因此开销会更大，时间也会更慢。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">const</span> myImg = &#123;</span><br><span class="line">  setSrc(imgNode, src) &#123;</span><br><span class="line">    imgNode.src = src;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 利用代理模式实现图片懒加载</span></span><br><span class="line"><span class="keyword">const</span> proxyImg = &#123;</span><br><span class="line">  setSrc(imgNode, src) &#123;</span><br><span class="line">    myImg.setSrc(imgNode, <span class="string">"./image.png"</span>); <span class="comment">// NO1. 加载占位图片并且将图片放入&lt;img&gt;元素</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> img = <span class="keyword">new</span> Image();</span><br><span class="line">    img.onload = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      myImg.setSrc(imgNode, src); <span class="comment">// NO3. 完成加载后, 更新 &lt;img&gt; 元素中的图片</span></span><br><span class="line">    &#125;;</span><br><span class="line">    img.src = src; <span class="comment">// NO2. 加载真正需要的图片</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> imgNode = <span class="built_in">document</span>.createElement(<span class="string">"img"</span>),</span><br><span class="line">  imgSrc =</span><br><span class="line">    <span class="string">"https://upload-images.jianshu.io/upload_images/5486602-5cab95ba00b272bd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp"</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.body.appendChild(imgNode);</span><br><span class="line"></span><br><span class="line">proxyImg.setSrc(imgNode, imgSrc);</span><br></pre></td></tr></table></figure></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- main.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>每天一个设计模式 · 代理模式<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./main.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="策略模式"><a href="#策略模式" class="headerlink" title="策略模式"></a>策略模式</h2><p>策略模式定义：就是能够把一系列“可互换的”算法封装起来，并根据用户需求来选择其中一种。</p>
<p>策略模式实现的核心就是：将算法的使用和算法的实现分离。算法的实现交给策略类。算法的使用交给环境类，环境类会根据不同的情况选择合适的算法。</p>
<h3 id="策略模式优缺点"><a href="#策略模式优缺点" class="headerlink" title="策略模式优缺点"></a>策略模式优缺点</h3><p>在使用策略模式的时候，需要了解所有的“策略”（strategy）之间的异同点，才能选择合适的“策略”进行调用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 策略类</span></span><br><span class="line"><span class="keyword">const</span> strategies = &#123;</span><br><span class="line">  A() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"This is stragegy A"</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  B() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"This is stragegy B"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 环境类</span></span><br><span class="line"><span class="keyword">const</span> context = <span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> strategies[name]();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用策略A</span></span><br><span class="line">context(<span class="string">"A"</span>);</span><br><span class="line"><span class="comment">// 调用策略B</span></span><br><span class="line">context(<span class="string">"B"</span>);</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h2><p>单例模式定义：保证一个类仅有一个实例，并提供访问此实例的全局访问点。</p>
<h3 id="单例模式用途"><a href="#单例模式用途" class="headerlink" title="单例模式用途"></a>单例模式用途</h3><p>如果一个类负责连接数据库的线程池、日志记录逻辑等等，此时需要单例模式来保证对象不被重复创建，以达到降低开销的目的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Singleton = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">Singleton.getInstance = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 由于es6没有静态类型,故闭包: 函数外部无法访问 instance</span></span><br><span class="line">  <span class="keyword">let</span> instance = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 检查是否存在实例</span></span><br><span class="line">    <span class="keyword">if</span> (!instance) &#123;</span><br><span class="line">      instance = <span class="keyword">new</span> Singleton();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> s1 = Singleton.getInstance();</span><br><span class="line"><span class="keyword">let</span> s2 = Singleton.getInstance();</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(s1 === s2);</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/02/JS实现多行溢出省略号思路/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/02/JS实现多行溢出省略号思路/" itemprop="url">JS实现多行溢出省略号思路</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-02T20:43:06+08:00">
                2019-01-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>说起多行溢出省略号,用CSS实现最简单<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.one-line</span> &#123;</span><br><span class="line">	<span class="attribute">display</span>: -webkit-box <span class="meta">!important</span>;</span><br><span class="line">	<span class="attribute">overflow</span>: hidden;</span><br><span class="line">	<span class="attribute">text-overflow</span>: ellipsis;</span><br><span class="line">	<span class="attribute">word-break</span>: break-all;</span><br><span class="line">	<span class="attribute">-webkit-box-orient</span>: vertical;</span><br><span class="line">	<span class="attribute">-webkit-line-clamp</span>: <span class="number">1</span>;</span><br><span class="line">	<span class="comment">/*clip  修剪文本。*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.more-line</span> &#123;</span><br><span class="line">	<span class="attribute">display</span>: -webkit-box <span class="meta">!important</span>;</span><br><span class="line">	<span class="attribute">overflow</span>: hidden;</span><br><span class="line">	<span class="attribute">text-overflow</span>: ellipsis;</span><br><span class="line">	<span class="attribute">word-break</span>: break-all;</span><br><span class="line">	<span class="attribute">-webkit-box-orient</span>: vertical;</span><br><span class="line">	<span class="attribute">-webkit-line-clamp</span>: <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong> 下面就摸索下用JS如何实现：</strong></p>
<h3 id="Github-DEMO"><a href="#Github-DEMO" class="headerlink" title="Github DEMO"></a><a href="https://libin1991.github.io/vue-text-clamp/demo/?lang=zh" target="_blank" rel="noopener"><font color="#ff0000">Github DEMO</font></a></h3><p><img src="/2019/01/02/JS实现多行溢出省略号思路/3.gif" alt=""></p>
<h3 id="先看两个API："><a href="#先看两个API：" class="headerlink" title="先看两个API："></a>先看两个API：</h3><p><strong> getClientRects </strong>获取元素占据页面的所有矩形区域 :</p>
<blockquote>
<p>getClientRects 返回一个TextRectangle集合，就是TextRectangleList对象。TextRectangle对象包含了, top left bottom right width height 六个属性TextRectangle对于文本对象，W3C提供了一个 TextRectangle 对象，这个对象是对文本区域的一个解释。这里的文本区域只针对inline<br> 元素，比如：a, span, em这类标签元素。浏览器差异getClientRects() 最先由MS IE提出，后被W3C引入并制订了标准。目前主流浏览器都支持该标准，而IE只支持TextRectangle的top left bottom right四个属性。IE下可以通过right-left来计算width、bottom-top来计算height。ie 和非ie浏览器在使用getClientRects还是有些差别的，ie获取TextRectangleList的范围很大。而非ie获取的范围比较小，<br> 只有display:inline的对象才能获取到TextRectangleList，例如em i span 等标签。应用场景getClientRects常用于获取鼠标的位置，如放大镜效果。微博的用户信息卡也是通过改方法获得的。<br>总结：<font color="#ff0000">只能用于行内元素,返回每一行的信息，返回信息和getBoundingClientRect返回类似。 </font></p>
</blockquote>
<p>DEMO：<br> <img src="/2019/01/02/JS实现多行溢出省略号思路/2.png" alt=""><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">			* &#123;</span></span><br><span class="line"><span class="undefined">				padding: 0px;</span></span><br><span class="line"><span class="undefined">				margin: 0px;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="undefined">			div &#123;</span></span><br><span class="line"><span class="undefined">				width: 80%;</span></span><br><span class="line"><span class="undefined">				height: 90px;</span></span><br><span class="line"><span class="undefined">				border: 1px solid red;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="css">			<span class="selector-id">#test</span>&#123;</span></span><br><span class="line"><span class="css">				<span class="selector-tag">width</span><span class="selector-pseudo">:400px</span>;</span></span><br><span class="line"><span class="undefined">				height: 10px;</span></span><br><span class="line"><span class="undefined">				background: red;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"main"</span>&gt;</span>返回值是ClientRect对象集合，该对象是与该元素相关的CSS边框。每个ClientRect对象包含一组描述该边框的只读属性——left、top、right和bottom，单位为像素，这些属性值是相对于视口的top-left的。即使当表格的标题在表格的边框外面，该标题仍会被计算在内。<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"test"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">		<span class="built_in">console</span>.log(<span class="built_in">document</span>.getElementById(<span class="string">"main"</span>).getClientRects());</span></span><br><span class="line"><span class="undefined">		 </span></span><br><span class="line"><span class="undefined">	</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><strong>getBoundingClientRect获取元素位置 </strong>getBoundingClientRect用于获得页面中某个元素的左，上，右和下分别相对浏览器视窗的位置。getBoundingClientRect是DOM元素到浏览器可视范围的距离（不包含文档卷起的部分）。该函数返回一个Object对象，该对象有6个属性：top,lef,right,bottom,width,height；这里的top、left和css中的理解很相似，width、height是元素自身的宽高，但是right，bottom和css中的理解有点不一样。right是指元素右边界距窗口最左边的距离，bottom是指元素下边界距窗口最上面的距离。</p>
<blockquote>
<p>getBoundingClientRect()最先是IE的私有属性，现在已经是一个W3C标准。所以你不用当心浏览器兼容问题，不过还是有区别的：IE只返回top,lef,right,bottom四个值，</p>
</blockquote>
<p>返回差异：</p>
<p><strong>getClientRects 和 getBoundingClientRect 的区别返回类型差异：
</strong>getClientRects 返回一个TextRectangle集合，就是TextRectangleList对象。getBoundingClientRect返回 一个TextRectangle对象，即使DOM里没有文本也能返回TextRectangle对象.浏览器差异:除了safari，firefox2.0外所有浏览器都支持getClientRects和getBoundingClientRect，firefox 3.1给TextRectangle增加了 width 和 height。ie 和非ie浏览器在使用getClientRects还是有些差别的，ie获取TextRectangleList的范围很大。而非ie获取的范围比较小， 只有display:inline的对象才能获取到TextRectangleList，例如em i span 等标签。通过测试，至少Chrome 2+\Safari 4\Firefox3.5\0pera 9.63+已经支持getBoundingClientRect方法。使用场景差异:出于浏览器兼容的考虑，现在用得最多的是getBoundingClientRect，经常用来获取一个element元素的viewport坐标。<br> <img src="/2019/01/02/JS实现多行溢出省略号思路/1.jpg" alt=""></p>
<h3 id="Vue多行溢出省略号"><a href="#Vue多行溢出省略号" class="headerlink" title="Vue多行溢出省略号"></a>Vue多行溢出省略号</h3><blockquote>
<p>监听DOM尺寸变化 </p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; addListener, removeListener &#125; <span class="keyword">from</span> <span class="string">'resize-detector'</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">this</span>.autoresize) &#123;</span><br><span class="line">    <span class="keyword">let</span> resizeCallback = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.update()</span><br><span class="line">    &#125;</span><br><span class="line">    addListener(<span class="keyword">this</span>.$el, resizeCallback)   <span class="comment">//监听</span></span><br><span class="line">    <span class="keyword">this</span>.unregisterResizeCallback = <span class="function"><span class="params">()</span> =&gt;</span> &#123;   <span class="comment">//移除</span></span><br><span class="line">      removeListener(<span class="keyword">this</span>.$el, resizeCallback)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>判断是否溢出</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">isOverflow () &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.maxLines &amp;&amp; !<span class="keyword">this</span>.maxHeight) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.maxLines) &#123;   </span><br><span class="line">      <span class="comment">//获取全部显示的行数</span></span><br><span class="line">      <span class="keyword">let</span> actualLines = <span class="keyword">this</span>.$refs.content.getClientRects().length</span><br><span class="line">      <span class="keyword">if</span> (actualLines &gt; <span class="keyword">this</span>.maxLines) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.maxHeight) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.$el.scrollHeight &gt; <span class="keyword">this</span>.$el.offsetHeight) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<blockquote>
<p>二分查找多行截取字符临界值</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">moveEdge (steps) &#123;</span><br><span class="line">  <span class="keyword">this</span>.clampAt(<span class="keyword">this</span>.offset + steps)</span><br><span class="line">&#125;,</span><br><span class="line">clampAt (offset) &#123;</span><br><span class="line">  <span class="keyword">this</span>.offset = offset</span><br><span class="line">  <span class="keyword">this</span>.applyChange()</span><br><span class="line">&#125;,</span><br><span class="line">applyChange () &#123;</span><br><span class="line">  <span class="keyword">this</span>.$refs.text.textContent = <span class="keyword">this</span>.realText</span><br><span class="line">&#125;,</span><br><span class="line">stepToFit () &#123;</span><br><span class="line">  <span class="keyword">this</span>.fill()</span><br><span class="line">  <span class="keyword">this</span>.clamp()</span><br><span class="line">&#125;,</span><br><span class="line">fill () &#123;</span><br><span class="line">  <span class="keyword">while</span> (!<span class="keyword">this</span>.isOverflow() &amp;&amp; <span class="keyword">this</span>.offset &lt; <span class="keyword">this</span>.text.length) &#123;</span><br><span class="line">    <span class="keyword">this</span>.moveEdge(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">clamp () &#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">this</span>.isOverflow() &amp;&amp; <span class="keyword">this</span>.offset &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.moveEdge(<span class="number">-1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">search (...range) &#123;</span><br><span class="line">  <span class="keyword">let</span> [<span class="keyword">from</span> = <span class="number">0</span>, to = <span class="keyword">this</span>.offset] = range</span><br><span class="line">  <span class="keyword">if</span> (to - <span class="keyword">from</span> &lt;= <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.stepToFit()</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> target = <span class="built_in">Math</span>.floor((to + <span class="keyword">from</span>) / <span class="number">2</span>)    <span class="comment">//从中间找临界值</span></span><br><span class="line">  <span class="keyword">this</span>.clampAt(target)</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.isOverflow()) &#123;</span><br><span class="line">    <span class="keyword">this</span>.search(<span class="keyword">from</span>, target)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.search(target, to)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="完整代码："><a href="#完整代码：" class="headerlink" title="完整代码："></a>完整代码：</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; addListener, removeListener &#125; <span class="keyword">from</span> <span class="string">'resize-detector'</span></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UPDATE_TRIGGERS = [<span class="string">'maxLines'</span>, <span class="string">'maxHeight'</span>, <span class="string">'ellipsis'</span>]</span><br><span class="line"><span class="keyword">const</span> INIT_TRIGGERS = [<span class="string">'tag'</span>, <span class="string">'text'</span>, <span class="string">'autoresize'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  name: <span class="string">'vue-clamper'</span>,</span><br><span class="line">  props: &#123;</span><br><span class="line">    tag: &#123;</span><br><span class="line">      type: <span class="built_in">String</span>,</span><br><span class="line">      <span class="keyword">default</span>: <span class="string">'div'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    autoresize: &#123;</span><br><span class="line">      type: <span class="built_in">Boolean</span>,</span><br><span class="line">      <span class="keyword">default</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    maxLines: <span class="built_in">Number</span>,</span><br><span class="line">    maxHeight: [<span class="built_in">String</span>, <span class="built_in">Number</span>],</span><br><span class="line">    ellipsis: &#123;</span><br><span class="line">      type: <span class="built_in">String</span>,</span><br><span class="line">      <span class="keyword">default</span>: <span class="string">'…'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    expanded: <span class="built_in">Boolean</span></span><br><span class="line">  &#125;,</span><br><span class="line">  data () &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      offset: <span class="literal">null</span>,</span><br><span class="line">      text: <span class="keyword">this</span>.getText(),</span><br><span class="line">      localExpanded: !!<span class="keyword">this</span>.expanded</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  computed: &#123;</span><br><span class="line">    clampedText () &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.text.slice(<span class="number">0</span>, <span class="keyword">this</span>.offset) + <span class="keyword">this</span>.ellipsis</span><br><span class="line">    &#125;,</span><br><span class="line">    isClamped () &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.text) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.offset !== <span class="keyword">this</span>.text.length</span><br><span class="line">    &#125;,</span><br><span class="line">    realText () &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.isClamped ? <span class="keyword">this</span>.clampedText : <span class="keyword">this</span>.text</span><br><span class="line">    &#125;,</span><br><span class="line">    realMaxHeight () &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.localExpanded) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> &#123; maxHeight &#125; = <span class="keyword">this</span></span><br><span class="line">      <span class="keyword">if</span> (!maxHeight) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">typeof</span> maxHeight === <span class="string">'number'</span> ? <span class="string">`<span class="subst">$&#123;maxHeight&#125;</span>px`</span> : maxHeight</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  watch: &#123;</span><br><span class="line">    expanded (val) &#123;</span><br><span class="line">      <span class="keyword">this</span>.localExpanded = val</span><br><span class="line">    &#125;,</span><br><span class="line">    localExpanded (val) &#123;</span><br><span class="line">      <span class="keyword">if</span> (val) &#123;</span><br><span class="line">        <span class="keyword">this</span>.clampAt(<span class="keyword">this</span>.text.length)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.update()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.expanded !== val) &#123;</span><br><span class="line">        <span class="keyword">this</span>.$emit(<span class="string">'update:expanded'</span>, val)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted () &#123;</span><br><span class="line">    <span class="keyword">this</span>.init()</span><br><span class="line"></span><br><span class="line">    INIT_TRIGGERS.forEach(<span class="function"><span class="params">prop</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.$watch(prop, <span class="keyword">this</span>.init)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    UPDATE_TRIGGERS.forEach(<span class="function"><span class="params">prop</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.$watch(prop, <span class="keyword">this</span>.update)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  updated () &#123;</span><br><span class="line">    <span class="keyword">this</span>.text = <span class="keyword">this</span>.getText()</span><br><span class="line">    <span class="keyword">this</span>.applyChange()</span><br><span class="line">  &#125;,</span><br><span class="line">  beforeDestroy () &#123;</span><br><span class="line">    <span class="keyword">this</span>.cleanUp()</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    init () &#123;</span><br><span class="line">      <span class="keyword">let</span> contents = <span class="keyword">this</span>.$slots.default</span><br><span class="line">      <span class="keyword">if</span> (!contents) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(contents) &amp;&amp; contents.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        Vue.util.warn(</span><br><span class="line">          <span class="string">'VueClamper only supports clamping plain text content.'</span>,</span><br><span class="line">          <span class="keyword">this</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> [content] = contents</span><br><span class="line">      <span class="keyword">if</span> (content &amp;&amp; content.tag) &#123;</span><br><span class="line">        Vue.util.warn(</span><br><span class="line">          <span class="string">'VueClamper only supports clamping plain text content.'</span>,</span><br><span class="line">          <span class="keyword">this</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.offset = <span class="keyword">this</span>.text.length</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.cleanUp()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.autoresize) &#123;</span><br><span class="line">        <span class="keyword">let</span> resizeCallback = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.update()</span><br><span class="line">        &#125;</span><br><span class="line">        addListener(<span class="keyword">this</span>.$el, resizeCallback)</span><br><span class="line">        <span class="keyword">this</span>.unregisterResizeCallback = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          removeListener(<span class="keyword">this</span>.$el, resizeCallback)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.update()</span><br><span class="line">    &#125;,</span><br><span class="line">    update () &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.localExpanded) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.applyChange()</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.isOverflow() || <span class="keyword">this</span>.isClamped) &#123;</span><br><span class="line">        <span class="keyword">this</span>.search()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    expand () &#123;</span><br><span class="line">      <span class="keyword">this</span>.localExpanded = <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    collapse () &#123;</span><br><span class="line">      <span class="keyword">this</span>.localExpanded = <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    toggle () &#123;</span><br><span class="line">      <span class="keyword">this</span>.localExpanded = !<span class="keyword">this</span>.localExpanded</span><br><span class="line">    &#125;,</span><br><span class="line">    isOverflow () &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.maxLines &amp;&amp; !<span class="keyword">this</span>.maxHeight) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.maxLines) &#123;</span><br><span class="line">        <span class="keyword">let</span> actualLines = <span class="keyword">this</span>.$refs.content.getClientRects().length</span><br><span class="line">        <span class="keyword">if</span> (actualLines &gt; <span class="keyword">this</span>.maxLines) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.maxHeight) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.$el.scrollHeight &gt; <span class="keyword">this</span>.$el.offsetHeight) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    getText () &#123;</span><br><span class="line">      <span class="keyword">let</span> [content] = <span class="keyword">this</span>.$slots.default || []</span><br><span class="line">      <span class="keyword">return</span> content ? content.text : <span class="string">''</span></span><br><span class="line">    &#125;,</span><br><span class="line">    moveEdge (steps) &#123;</span><br><span class="line">      <span class="keyword">this</span>.clampAt(<span class="keyword">this</span>.offset + steps)</span><br><span class="line">    &#125;,</span><br><span class="line">    clampAt (offset) &#123;</span><br><span class="line">      <span class="keyword">this</span>.offset = offset</span><br><span class="line">      <span class="keyword">this</span>.applyChange()</span><br><span class="line">    &#125;,</span><br><span class="line">    applyChange () &#123;</span><br><span class="line">      <span class="keyword">this</span>.$refs.text.textContent = <span class="keyword">this</span>.realText</span><br><span class="line">    &#125;,</span><br><span class="line">    stepToFit () &#123;</span><br><span class="line">      <span class="keyword">this</span>.fill()</span><br><span class="line">      <span class="keyword">this</span>.clamp()</span><br><span class="line">    &#125;,</span><br><span class="line">    fill () &#123;</span><br><span class="line">      <span class="keyword">while</span> (!<span class="keyword">this</span>.isOverflow() &amp;&amp; <span class="keyword">this</span>.offset &lt; <span class="keyword">this</span>.text.length) &#123;</span><br><span class="line">        <span class="keyword">this</span>.moveEdge(<span class="number">1</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    clamp () &#123;</span><br><span class="line">      <span class="keyword">while</span> (<span class="keyword">this</span>.isOverflow() &amp;&amp; <span class="keyword">this</span>.offset &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.moveEdge(<span class="number">-1</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    search (...range) &#123;</span><br><span class="line">      <span class="keyword">let</span> [<span class="keyword">from</span> = <span class="number">0</span>, to = <span class="keyword">this</span>.offset] = range</span><br><span class="line">      <span class="keyword">if</span> (to - <span class="keyword">from</span> &lt;= <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.stepToFit()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> target = <span class="built_in">Math</span>.floor((to + <span class="keyword">from</span>) / <span class="number">2</span>)</span><br><span class="line">      <span class="keyword">this</span>.clampAt(target)</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.isOverflow()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.search(<span class="keyword">from</span>, target)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.search(target, to)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    cleanUp () &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.unregisterResizeCallback) &#123;</span><br><span class="line">        <span class="keyword">this</span>.unregisterResizeCallback()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  render (h) &#123;</span><br><span class="line">    <span class="keyword">let</span> contents = [</span><br><span class="line">      h(</span><br><span class="line">        <span class="string">'span'</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          ref: <span class="string">'text'</span>,</span><br><span class="line">          attrs: &#123;</span><br><span class="line">            <span class="string">'aria-label'</span>: <span class="keyword">this</span>.text.trim()</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">this</span>.realText</span><br><span class="line">      )</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> &#123; expand, collapse, toggle &#125; = <span class="keyword">this</span></span><br><span class="line">    <span class="keyword">let</span> scope = &#123; expand, collapse, toggle &#125;</span><br><span class="line">    <span class="keyword">let</span> before = <span class="keyword">this</span>.$scopedSlots.before</span><br><span class="line">      ? <span class="keyword">this</span>.$scopedSlots.before(scope)</span><br><span class="line">      : <span class="keyword">this</span>.$slots.before</span><br><span class="line">    <span class="keyword">if</span> (before) &#123;</span><br><span class="line">      contents.unshift(...(<span class="built_in">Array</span>.isArray(before) ? before : [before]))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> after = <span class="keyword">this</span>.$scopedSlots.after</span><br><span class="line">      ? <span class="keyword">this</span>.$scopedSlots.after(scope)</span><br><span class="line">      : <span class="keyword">this</span>.$slots.after</span><br><span class="line">    <span class="keyword">if</span> (after) &#123;</span><br><span class="line">      contents.push(...(<span class="built_in">Array</span>.isArray(after) ? after : [after]))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> lines = [</span><br><span class="line">      h(</span><br><span class="line">        <span class="string">'span'</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          style: &#123;</span><br><span class="line">            boxShadow: <span class="string">'transparent 0 0'</span></span><br><span class="line">          &#125;,</span><br><span class="line">          ref: <span class="string">'content'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        contents</span><br><span class="line">      )</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">return</span> h(</span><br><span class="line">      <span class="keyword">this</span>.tag,</span><br><span class="line">      &#123;</span><br><span class="line">        style: &#123;</span><br><span class="line">          maxHeight: <span class="keyword">this</span>.realMaxHeight,</span><br><span class="line">          overflow: <span class="string">'hidden'</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      lines</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> VClamp <span class="keyword">from</span> <span class="string">'./components/Clamp.js'</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">v-clamp</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:class</span>=<span class="string">"&#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">    demo: true,</span></span></span><br><span class="line"><span class="tag"><span class="string">    hyphens: hyphens1</span></span></span><br><span class="line"><span class="tag"><span class="string">  &#125;"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:max-lines</span>=<span class="string">"lines"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">autoresize</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:style</span>=<span class="string">"&#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">    width: `$&#123;width1&#125;px`</span></span></span><br><span class="line"><span class="tag"><span class="string">  &#125;"</span></span></span><br><span class="line"><span class="tag">&gt;</span></span><br><span class="line">  &#123;&#123; zh ? textZh : text &#125;&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span></span></span><br><span class="line"><span class="tag">    <span class="attr">slot</span>=<span class="string">"after"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">slot-scope</span>=<span class="string">"&#123; toggle &#125;"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">class</span>=<span class="string">"toggle btn btn-sm"</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">click</span>=<span class="string">"toggle"</span></span></span><br><span class="line"><span class="tag">  &gt;</span></span><br><span class="line">    &#123;&#123; zh ? '切换' : 'Toggle' &#125;&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">v-clamp</span>&gt;</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/01/JS监听div元素的resize/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/01/JS监听div元素的resize/" itemprop="url">JS监听div元素的resize</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-01T20:21:48+08:00">
                2019-01-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在实现一个<strong>自定义滚动条</strong>需求的时候，需要监听到某个div元素的宽高变化，第一时间想到的是resize事件，但是很不幸运的是，resize事件只能加在window对象上，并不能监听具体某个DOM元素。</p>
<p>多方查阅之后，了解到<span style="border-bottom:2px solid red;"><strong>MutationObserver</strong></span>和<span style="border-bottom:2px solid red;"><strong>Resize Observer</strong></span>, <span style="border-bottom:2px solid red;"> <strong>DOMSubtreeModified </strong></span>,迫不及待的直接看直接看  <a href="#resize-detector实现方式"><font color="#00dd00"><strong> resize-detector实现方式  </strong></font></a> 可以用来监听整个DOM中任何变化的东西，可以把它理解为一个类，实例化之后调用类实例的几个简单接口即可完成监听，以下具体介绍：</p>
<h3 id="MutationObserver介绍"><a href="#MutationObserver介绍" class="headerlink" title="MutationObserver介绍"></a>MutationObserver介绍</h3><h4 id="构造函数为window-MutationObserver，参数为一个回调函数。"><a href="#构造函数为window-MutationObserver，参数为一个回调函数。" class="headerlink" title="构造函数为window.MutationObserver，参数为一个回调函数。"></a>构造函数为window.MutationObserver，参数为一个回调函数。</h4><p>监控到DOM中的改变并且等待一系列改变结束后就会触发回调函数。它与事件的不同之处在于，它在DOM变化时，会记录每一个DOM的变化（为一个MutationRecord对象），但是到DOM变化结束时触发回调。DOM变化可能是一系列的（比如元素的宽和高同时改变），那么这一系列的变化就会产生一个队列，这个队列会作为参数传递给回调函数。</p>
<p>由于浏览器差异的原因，一些版本的浏览器各自支持了构造函数，但是用法都是一样的，实例化一个观察者的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> MutationObserver = <span class="built_in">window</span>.MutationObserver ||</span><br><span class="line">                       <span class="built_in">window</span>.WebKitMutationObserver || </span><br><span class="line">                       <span class="built_in">window</span>.MozMutationObserver</span><br><span class="line">                       </span><br><span class="line"><span class="keyword">let</span> observer = <span class="keyword">new</span> MutationObserver(callback)</span><br></pre></td></tr></table></figure>
<h4 id="调用接口开始监控DOM。"><a href="#调用接口开始监控DOM。" class="headerlink" title="调用接口开始监控DOM。"></a>调用接口开始监控DOM。</h4><blockquote>
<p>常用的接口有三个：</p>
</blockquote>
<ul>
<li><p>observe(element, options)　配置<code>MutationObserver</code>在DOM更改匹配给定选项时，通过其回调函数开始接收通知。</p>
<p>element即要监听的DOM元素，options为监听选项对象，可选的选项如下：</p>
</li>
</ul>
<p><img src="/2019/01/01/JS监听div元素的resize/1.jpg" alt=""></p>
<p>　所以监听元素宽高变化，就是监听其style属性变化：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">observer.observe(element, &#123; </span><br><span class="line">        attributes: <span class="literal">true</span>, </span><br><span class="line">        attributeFilter: [<span class="string">'style'</span>], </span><br><span class="line">        attributeOldValue: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure></p>
<p>   这样当元素的style发生改变的时候，就会触发构造函数中传入的callback函数。</p>
<ul>
<li><p>disconnect()  <code>阻止 MutationObserver</code> 实例继续接收的通知，直到再次调用其observe方法，该观察者对象包含的回调函数都不会再被调用。</p>
</li>
<li><p>takeRecords() 从MutationObserver的通知队列中删除所有待处理的通知，并将它们返回到一个MutationRecord对象构成的新数组中。</p>
</li>
</ul>
<blockquote>
<p>示例</p>
</blockquote>
<p>这里以Vue中的一个组件作为实例，了解了以上所述内容后其实非常简单,代码如下:</p>
<p><img src="/2019/01/01/JS监听div元素的resize/2.webp" alt=""><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/vue.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">			html,body&#123;</span></span><br><span class="line"><span class="undefined">				width: 100%;</span></span><br><span class="line"><span class="undefined">				height: 100%;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="css">			<span class="selector-class">.container</span> &#123;</span></span><br><span class="line"><span class="undefined">				width: 100%;</span></span><br><span class="line"><span class="undefined">				height: 100%;</span></span><br><span class="line"><span class="undefined">				position: relative</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="css">			<span class="selector-class">.resize-element</span> &#123;</span></span><br><span class="line"><span class="undefined">				position: absolute;</span></span><br><span class="line"><span class="undefined">				top: 50%;</span></span><br><span class="line"><span class="undefined">				left: 50%;</span></span><br><span class="line"><span class="undefined">				height: 10rem;</span></span><br><span class="line"><span class="undefined">				width: 10rem;</span></span><br><span class="line"><span class="undefined">				transform: translate(-50%,-50%);</span></span><br><span class="line"><span class="undefined">				overflow: hidden;</span></span><br><span class="line"><span class="css">				<span class="selector-tag">resize</span>: <span class="selector-tag">both</span>;   <span class="comment">/*用户可以调节元素的宽度和高度*/</span></span></span><br><span class="line"><span class="undefined">				display: block;</span></span><br><span class="line"><span class="css">				<span class="selector-tag">box-shadow</span>: 0 0 1<span class="selector-tag">px</span> 1<span class="selector-tag">px</span> <span class="selector-id">#3361D8</span>;</span></span><br><span class="line"><span class="undefined">				border-radius: 2px;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span> <span class="attr">id</span>=<span class="string">"main"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"resize-element"</span>&gt;</span></span><br><span class="line">				改变大小试试</span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"resize-record"</span>&gt;</span></span><br><span class="line">				触发了&#123;&#123;firedNum&#125;&#125;次resize事件。</span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">				el: <span class="string">"#main"</span>,</span></span><br><span class="line"><span class="undefined">				data: &#123;</span></span><br><span class="line"><span class="javascript">					observer: <span class="literal">null</span>,</span></span><br><span class="line"><span class="undefined">					firedNum: 0,</span></span><br><span class="line"><span class="javascript">					recordOldValue: &#123; <span class="comment">// 记录下旧的宽高数据，避免重复触发回调函数</span></span></span><br><span class="line"><span class="javascript">						width: <span class="string">'0'</span>,</span></span><br><span class="line"><span class="javascript">						height: <span class="string">'0'</span></span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined">				&#125;,</span></span><br><span class="line"><span class="undefined">				mounted() &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">let</span> MutationObserver = <span class="built_in">window</span>.MutationObserver || <span class="built_in">window</span>.WebKitMutationObserver || <span class="built_in">window</span>.MozMutationObserver</span></span><br><span class="line"><span class="javascript">					<span class="keyword">let</span> element = <span class="built_in">document</span>.querySelector(<span class="string">'.resize-element'</span>)</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.observer = <span class="keyword">new</span> MutationObserver(<span class="function">(<span class="params">mutationList</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">for</span>(<span class="keyword">let</span> mutation <span class="keyword">of</span> mutationList) &#123;</span></span><br><span class="line"><span class="javascript">							<span class="built_in">console</span>.log(mutation)</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">let</span> width = getComputedStyle(element).getPropertyValue(<span class="string">'width'</span>)</span></span><br><span class="line"><span class="javascript">						<span class="keyword">let</span> height = getComputedStyle(element).getPropertyValue(<span class="string">'height'</span>)</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(width === <span class="keyword">this</span>.recordOldValue.width &amp;&amp; height === <span class="keyword">this</span>.recordOldValue.height) <span class="keyword">return</span></span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.recordOldValue = &#123;</span></span><br><span class="line"><span class="undefined">							width,</span></span><br><span class="line"><span class="undefined">							height</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.firedNum += <span class="number">1</span></span></span><br><span class="line"><span class="undefined">					&#125;)</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.observer.observe(element, &#123;</span></span><br><span class="line"><span class="javascript">						attributes: <span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">						attributeFilter: [<span class="string">'style'</span>],</span></span><br><span class="line"><span class="javascript">						attributeOldValue: <span class="literal">true</span></span></span><br><span class="line"><span class="undefined">					&#125;)</span></span><br><span class="line"><span class="undefined">				&#125;,</span></span><br><span class="line"><span class="undefined">				beforeDestroyed() &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="keyword">this</span>.observer) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.observer.disconnect()</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.observer.takeRecords()</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.observer = <span class="literal">null</span></span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">			&#125;)</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>这里记录了旧的宽高数据来避免重复触发回调函数，这样做的原因在于宽高数据改变时，不一定是整数，而MutationRecord.recordOldValue中记录的是取整后的数据，这样就会导致在拖动改变DOM元素的宽高时，数值一直在整数和小数之间跳动，会多次触发。</strong></p>
</blockquote>
<h3 id="MutationObserver实现Vue-nextTick"><a href="#MutationObserver实现Vue-nextTick" class="headerlink" title="MutationObserver实现Vue nextTick"></a>MutationObserver实现Vue nextTick</h3><p>Vue 倡导开发者尽量不直接操作DOM，但有的时候由于各种需求让开发者不得不这样做，于是 <strong>nextTick</strong> 的实现就是让开发者在修改数据后，能够在数据更新到DOM后才执行对应的函数，从而获取最新的 DON 数据。</p>
<p>那么如何实现 <strong>nextTick</strong>呢，我们首先可以想到的是利用 <strong>setTimeout</strong> 的异步回调来实现，不过由于各个浏览器的不同，setTimeout 的延迟很高，因此在 <strong>nextTick</strong> 中只作为最后的备胎，首选的方案则是 <strong>MutationObserver</strong>(在后面的内容中 MO 代表 MutationObserver)</p>
<h4 id="nextTick-的源码实现"><a href="#nextTick-的源码实现" class="headerlink" title="nextTick 的源码实现"></a>nextTick 的源码实现</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> nextTick = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> callbacks = []</span><br><span class="line">  <span class="keyword">var</span> pending = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">var</span> timerFunc</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">nextTickHandler</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    pending = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">var</span> copies = callbacks.slice(<span class="number">0</span>)</span><br><span class="line">    callbacks = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; copies.length; i++) &#123;</span><br><span class="line">      copies[i]()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> MutationObserver !== <span class="string">'undefined'</span>) &#123; <span class="comment">// 首选 MutationObserver </span></span><br><span class="line">    <span class="keyword">var</span> counter = <span class="number">1</span></span><br><span class="line">    <span class="keyword">var</span> observer = <span class="keyword">new</span> MutationObserver(nextTickHandler) <span class="comment">// 声明 MO 和回调函数</span></span><br><span class="line">    <span class="keyword">var</span> textNode = <span class="built_in">document</span>.createTextNode(counter)</span><br><span class="line">    observer.observe(textNode, &#123; <span class="comment">// 监听 textNode 这个文本节点</span></span><br><span class="line">      characterData: <span class="literal">true</span> <span class="comment">// 一旦文本改变则触发回调函数 nextTickHandler</span></span><br><span class="line">    &#125;)</span><br><span class="line">    timerFunc = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      counter = (counter + <span class="number">1</span>) % <span class="number">2</span> <span class="comment">// 每次执行 timeFunc 都会让文本在 1 和 0 间切换</span></span><br><span class="line">      textNode.data = counter</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    timerFunc = setTimeout <span class="comment">// 如果不支持 MutationObserver, 退选 setTimeout</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">cb, ctx</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> func = ctx</span><br><span class="line">      ? <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; cb.call(ctx) &#125;</span><br><span class="line">      : cb</span><br><span class="line">    callbacks.push(func)</span><br><span class="line">    <span class="keyword">if</span> (pending) <span class="keyword">return</span></span><br><span class="line">    pending = <span class="literal">true</span></span><br><span class="line">    timerFunc(nextTickHandler, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<h4 id="从Vue-2-5-开始，抽出来了一个单独的文件next-tick-js来执行它"><a href="#从Vue-2-5-开始，抽出来了一个单独的文件next-tick-js来执行它" class="headerlink" title="从Vue 2.5+开始，抽出来了一个单独的文件next-tick.js来执行它"></a>从Vue 2.5+开始，抽出来了一个单独的文件next-tick.js来执行它</h4><p><a href="https://libin1991.github.io/2017/10/21/%E9%9D%A2%E8%AF%95%E4%B9%8BVue-nextTick%E5%8E%9F%E7%90%86/" target="_blank" rel="noopener">面试之Vue.$nextTick原理</a><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">    延迟一个任务使其异步执行，在下一个tick时执行，一个立即执行函数，返回一个function</span></span><br><span class="line"><span class="comment">    这个函数的作用是在task或者microtask中推入一个timerFunc，</span></span><br><span class="line"><span class="comment">    在当前调用栈执行完以后以此执行直到执行到timerFunc</span></span><br><span class="line"><span class="comment">    目的是延迟到当前调用栈执行完以后执行</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/*存放异步执行的回调*/</span></span><br><span class="line"><span class="keyword">const</span> callbacks = []</span><br><span class="line"><span class="comment">/*一个标记位，如果已经有timerFunc被推送到任务队列中去则不需要重复推送*/</span></span><br><span class="line"><span class="keyword">let</span> pending = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*下一个tick时的回调*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushCallbacks</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">/*一个标记位，标记等待状态（即函数已经被推入任务队列或者主线程，已经在等待当前栈执行完毕去执行），这样就不需要在push多个回调到callbacks时将timerFunc多次推入任务队列或者主线程*/</span></span><br><span class="line">  pending = <span class="literal">false</span></span><br><span class="line">  <span class="comment">//复制callback</span></span><br><span class="line">  <span class="keyword">const</span> copies = callbacks.slice(<span class="number">0</span>)</span><br><span class="line">  <span class="comment">//清除callbacks</span></span><br><span class="line">  callbacks.length = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; copies.length; i++) &#123;</span><br><span class="line">  <span class="comment">//触发callback的回调函数</span></span><br><span class="line">    copies[i]()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Here we have async deferring wrappers using both microtasks and (macro) tasks.</span></span><br><span class="line"><span class="comment">// In &lt; 2.4 we used microtasks everywhere, but there are some scenarios where</span></span><br><span class="line"><span class="comment">// microtasks have too high a priority and fire in between supposedly</span></span><br><span class="line"><span class="comment">// sequential events (e.g. #4521, #6690) or even between bubbling of the same</span></span><br><span class="line"><span class="comment">// event (#6566). However, using (macro) tasks everywhere also has subtle problems</span></span><br><span class="line"><span class="comment">// when state is changed right before repaint (e.g. #6813, out-in transitions).</span></span><br><span class="line"><span class="comment">// Here we use microtask by default, but expose a way to force (macro) task when</span></span><br><span class="line"><span class="comment">// needed (e.g. in event handlers attached by v-on).</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">其大概的意思就是：在Vue2.4之前的版本中，nextTick几乎都是基于microTask实现的，</span></span><br><span class="line"><span class="comment">但是由于microTask的执行优先级非常高，在某些场景之下它甚至要比事件冒泡还要快，</span></span><br><span class="line"><span class="comment">就会导致一些诡异的问题；但是如果全部都改成macroTask，对一些有重绘和动画的场</span></span><br><span class="line"><span class="comment">景也会有性能的影响。所以最终nextTick采取的策略是默认走microTask，对于一些DOM</span></span><br><span class="line"><span class="comment">的交互事件，如v-on绑定的事件回调处理函数的处理，会强制走macroTask。</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> microTimerFunc</span><br><span class="line"><span class="keyword">let</span> macroTimerFunc</span><br><span class="line"><span class="keyword">let</span> useMacroTask = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Determine (macro) task defer implementation.</span></span><br><span class="line"><span class="comment">// Technically setImmediate should be the ideal choice, but it's only available</span></span><br><span class="line"><span class="comment">// in IE. The only polyfill that consistently queues the callback after all DOM</span></span><br><span class="line"><span class="comment">// events triggered in the same loop is by using MessageChannel.</span></span><br><span class="line"><span class="comment">/* istanbul ignore if */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">而对于macroTask的执行，Vue优先检测是否支持原生setImmediate（高版本IE和Edge支持），</span></span><br><span class="line"><span class="comment">不支持的话再去检测是否支持原生MessageChannel，如果还不支持的话为setTimeout(fn, 0)。</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> setImmediate !== <span class="string">'undefined'</span> &amp;&amp; isNative(setImmediate)) &#123;</span><br><span class="line">  macroTimerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setImmediate(flushCallbacks)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> MessageChannel !== <span class="string">'undefined'</span> &amp;&amp; ( </span><br><span class="line"><span class="comment">// MessageChannel与原先的MutationObserver异曲同工</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">在Vue 2.4版本以前使用的MutationObserver来模拟异步任务。</span></span><br><span class="line"><span class="comment">而Vue 2.5版本以后，由于兼容性弃用了MutationObserver。</span></span><br><span class="line"><span class="comment">Vue 2.5+版本使用了MessageChannel来模拟macroTask。</span></span><br><span class="line"><span class="comment">除了IE以外，messageChannel的兼容性还是比较可观的。</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">  isNative(MessageChannel) ||</span><br><span class="line">  <span class="comment">// PhantomJS</span></span><br><span class="line">  MessageChannel.toString() === <span class="string">'[object MessageChannelConstructor]'</span></span><br><span class="line">)) &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  可见，新建一个MessageChannel对象，该对象通过port1来检测信息，port2发送信息。</span></span><br><span class="line"><span class="comment">  通过port2的主动postMessage来触发port1的onmessage事件，</span></span><br><span class="line"><span class="comment">  进而把回调函数flushCallbacks作为macroTask参与事件循环。</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  <span class="keyword">const</span> channel = <span class="keyword">new</span> MessageChannel()</span><br><span class="line">  <span class="keyword">const</span> port = channel.port2</span><br><span class="line">  channel.port1.onmessage = flushCallbacks</span><br><span class="line">  macroTimerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    port.postMessage(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">/* istanbul ignore next */</span></span><br><span class="line">   <span class="comment">//上面两种都不支持，用setTimeout</span></span><br><span class="line">  macroTimerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(flushCallbacks, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Determine microtask defer implementation.</span></span><br><span class="line"><span class="comment">/* istanbul ignore next, $flow-disable-line */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">Promise</span> !== <span class="string">'undefined'</span> &amp;&amp; isNative(<span class="built_in">Promise</span>)) &#123;</span><br><span class="line"><span class="comment">/*使用Promise*/</span></span><br><span class="line">  <span class="keyword">const</span> p = <span class="built_in">Promise</span>.resolve()</span><br><span class="line">  microTimerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    p.then(flushCallbacks)</span><br><span class="line">    <span class="comment">// in problematic UIWebViews, Promise.then doesn't completely break, but</span></span><br><span class="line">    <span class="comment">// it can get stuck in a weird state where callbacks are pushed into the</span></span><br><span class="line">    <span class="comment">// microtask queue but the queue isn't being flushed, until the browser</span></span><br><span class="line">    <span class="comment">// needs to do some other work, e.g. handle a timer. Therefore we can</span></span><br><span class="line">    <span class="comment">// "force" the microtask queue to be flushed by adding an empty timer.</span></span><br><span class="line">    <span class="comment">//iOS的webview下，需要强制刷新队列，执行上面的回调函数</span></span><br><span class="line">    <span class="keyword">if</span> (isIOS) setTimeout(noop)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// fallback to macro</span></span><br><span class="line">  microTimerFunc = macroTimerFunc</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Wrap a function so that if any code inside triggers state change,</span></span><br><span class="line"><span class="comment"> * the changes are queued using a (macro) task instead of a microtask.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> 在Vue执行绑定的DOM事件时，默认会给回调的handler函数调用withMacroTask方法做一层包装，</span></span><br><span class="line"><span class="comment"> 它保证整个回调函数的执行过程中，遇到数据状态的改变，这些改变而导致的视图更新（DOM更新）</span></span><br><span class="line"><span class="comment"> 的任务都会被推到macroTask而不是microtask。</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">withMacroTask</span> (<span class="params">fn: Function</span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> fn._withTask || (fn._withTask = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    useMacroTask = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">const</span> res = fn.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>)</span><br><span class="line">    useMacroTask = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">    推送到队列中下一个tick时执行</span></span><br><span class="line"><span class="comment">    cb 回调函数</span></span><br><span class="line"><span class="comment">    ctx 上下文</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">nextTick</span> (<span class="params">cb?: Function, ctx?: Object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> _resolve</span><br><span class="line">   <span class="comment">/*cb存到callbacks中*/</span></span><br><span class="line">  callbacks.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cb) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        cb.call(ctx)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        handleError(e, ctx, <span class="string">'nextTick'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_resolve) &#123;</span><br><span class="line">      _resolve(ctx)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (!pending) &#123;</span><br><span class="line">    pending = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (useMacroTask) &#123;</span><br><span class="line">      macroTimerFunc()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      microTimerFunc()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// $flow-disable-line</span></span><br><span class="line">  <span class="keyword">if</span> (!cb &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">Promise</span> !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      _resolve = resolve</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>看了源码发现timerFunc会检测当前环境而不同实现，其实就是按照Promise，MutationObserver，setTimeout优先级，哪个存在使用哪个，最不济的环境下使用setTimeout</p>
<p><span style="border-bottom:2px solid red;">setTimeout是最后的一种备选方案，并且默认有4ms延时，setTimeout延时0不会老老实实立即执行：</span><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"我不是立即执行的,一般我会延时4ms,哈哈"</span>);</span><br><span class="line">&#125;,<span class="number">0</span>);</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>优先使用Promise，在Promise不存在的情况下使用MutationObserver，这两个方法的回调函数都会在microtask中执行，它们会比setTimeout更早执行，所以优先使用。<br>如果上述两种方法都不支持的环境则会使用setTimeout，在task尾部推入这个函数，等待调用执行。</p>
</blockquote>
<h4 id="Event-Loop"><a href="#Event-Loop" class="headerlink" title="Event Loop"></a>Event Loop</h4><p>当一个程序有：setTimeout， setInterval ，setImmediate， I/O， UI渲染，Promise ，process.nextTick， Object.observe， MutationObserver的时候：</p>
<ul>
<li>先执行 macrotasks：I/O -》 UI渲染</li>
<li>再执行 microtasks ：process.nextTick -》 Promise -》MutationObserver -&gt;Object.observe</li>
<li>再把setTimeout setInterval setImmediate 塞入一个新的macrotasks，依次： setTimeout ，setInterval –&gt; setImmediate</li>
</ul>
<p>综上，nextTick的目的就是产生一个回调函数加入task或者microtask中，当前栈执行完以后（可能中间还有别的排在前面的函数）调用该回调函数，起到了异步触发（即下一个tick时触发）的目的。</p>
<p>任务队列<br>异步任务分为task（宏任务，也可称为macroTask）和microtask（微任务）两类。<br>当满足执行条件时，task和microtask会被放入各自的队列中等待放入主线程执行，我们把这两个队列称为Task Queue(也叫Macrotask Queue)和Microtask Queue。</p>
<blockquote>
<font color="#dd0000"> <strong> macrotasks: </strong>   script中代码, setTimeout ，setInterval， setImmediate，requestAnimationFrame, I/O ，UI渲染  </font>
</blockquote>
<blockquote>
<font color="#dd0000"> <strong> microtasks: </strong>   Promise， process.nextTick， Object.observe， MutationObserver  </font>
</blockquote>
<p><table><tr><td bgcolor="#000"><font color="#fff"> microtask(微任务)一定比macroTask(宏任务)先执行吗：script中代码最先执行，但是script代码是macrotasks(宏任务) </font></td></tr></table></p>
<blockquote>
<p><strong>其实promise的then和catch才是microtask，本身的内部代码不是</strong></p>
</blockquote>
<h4 id="具体过程"><a href="#具体过程" class="headerlink" title="具体过程"></a>具体过程</h4><ul>
<li>执行完主执行线程中的任务</li>
<li>取出Microtask Queue中任务执行直到清空。</li>
<li>取出Macrotask Queue中一个任务执行。</li>
<li>取出Microtask Queue中任务执行直到清空。</li>
<li>重复3和4。</li>
</ul>
<p>即为同步完成，一个宏任务，所有微任务，一个宏任务，所有微任务……</p>
<p><img src="/2019/01/01/JS监听div元素的resize/7.jpg" alt=""><br><img src="/2019/01/01/JS监听div元素的resize/8.jpg" alt=""></p>
<hr>
<h3 id="MutationObserver-的功能和作用"><a href="#MutationObserver-的功能和作用" class="headerlink" title="MutationObserver 的功能和作用"></a>MutationObserver 的功能和作用</h3><blockquote>
<p>MO 给开发者提供了一种能在某个范围内的DOM数发生变化时作出适当反应的能力 </p>
</blockquote>
<p>用人话说是开发者能通过它创建一个观察者对象，这个对象会监听某个DOM元素，并在它的DOM树发生变化时执行我们提供的回调函数。</p>
<p>具体参考这个 <a href="https://jsfiddle.net/chenjsh36/1b5LL0b7/1/" target="_blank" rel="noopener">DEMO</a>点击预览</p>
<p>比较特别的是实例化的时候需要先传入回调函数：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observer = <span class="keyword">new</span> MutationObserver(<span class="function"><span class="keyword">function</span>(<span class="params">mutations</span>) </span>&#123;</span><br><span class="line">  mutations.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">mutation</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(mutation.type);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>然后才配置观察选项，包括观察节点和观察的属性：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 选择目标节点</span></span><br><span class="line"><span class="keyword">var</span> target = <span class="built_in">document</span>.querySelector(<span class="string">'#some-id'</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 配置观察选项:</span></span><br><span class="line"><span class="keyword">var</span> config = &#123; <span class="attr">attributes</span>: <span class="literal">true</span>, <span class="attr">childList</span>: <span class="literal">true</span>, <span class="attr">characterData</span>: <span class="literal">true</span> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 传入目标节点和观察选项</span></span><br><span class="line">observer.observe(target, config);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 随后,你还可以停止观察</span></span><br><span class="line">observer.disconnect();</span><br></pre></td></tr></table></figure>
<p>对于老版本的谷歌和火狐，则需要使用带前缀的 MO：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var MutationObserver = window.MutationObserver || </span><br><span class="line">                       window.WebKitMutationObserver || </span><br><span class="line">                       window.MozMutationObserver</span><br></pre></td></tr></table></figure>
<h3 id="MutationObserver-和-microtask"><a href="#MutationObserver-和-microtask" class="headerlink" title="MutationObserver 和 microtask"></a>MutationObserver 和 microtask</h3><p>那么为什么优选使用 MutationObserver呢？</p>
<p>一开始以为是 MO 就是用来监听 DOM 变化的，那么使用 textnode 模拟 DOM 变化再利用 MO 来监听触发从而实现 nextTick 不就很适合，直到了解看到了知乎上的<a href="https://www.zhihu.com/question/55364497" target="_blank" rel="noopener">问答</a>才知道是因为 MO 会比 setTimeout 早执行的缘故，</p>
<p>这里需要了解<strong>JS的运行运行机制</strong>（重新刷新了我的三观）, JS 的事件运行机制执行的时候会区分 <strong>task</strong> 和 <strong>microtask</strong>, 引擎在每个 <strong>task</strong> 执行完毕，并在从队列里取<strong>下一个task来执行之前</strong>， 执行完所有的 <strong>microtask</strong> 队列中的 microtask.</p>
<p><strong> setTimeout</strong> 回调会被分配到一个新的task中等待执行，而 Promise 的 resolver、MO 的 回调都会被分配到 microtask 的队列中，所以会比 setTimout 先执行.</p>
<p>除了比 setTimout 快之外，还有 <strong>渲染性能</strong> 的问题，根据<a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model" target="_blank" rel="noopener">HTML Standard</a>, <strong>每个 task 运行完以后， UI 都会重新渲染，那么在 microtask 中就完成数据更新， 当前 task 结束就可以得到最新的 UI， 反之如果新建一个 task 来做数据更新，那么渲染就会进行两次。</strong></p>
<p>所以性价比如此高的 MO 自然成为了首选</p>
<p>关于 microtask，具体可以阅读 Jake 写的 <a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/" target="_blank" rel="noopener">Tasks, microtasks, queues and schedules</a></p>
<h3 id="Vue-nextTick的版本迭代"><a href="#Vue-nextTick的版本迭代" class="headerlink" title="Vue nextTick的版本迭代"></a>Vue nextTick的版本迭代</h3><p>上面关于 <strong>nextTick</strong> 的源码实现属于 vue 最早的版本 v1.0.9，在深挖 mutationObserver 的时候发现 <strong>nextTick</strong> 在vue的版本迭代中也在不断的进化，同事也发生过退化，非常有趣：</p>
<p>先说说退化的事件，尤大（vue的作者）曾经使用 <code>window.postMessage</code> 来替代 MO 实现 nextTick，结果开发者使用后发现了问题，可以看看这两个 JSFiddle：<a href="https://jsfiddle.net/k6bgu2z6/4/" target="_blank" rel="noopener">jsfiddle1</a>点击预览 和 <a href="https://jsfiddle.net/v9q9L0hw/2/" target="_blank" rel="noopener">jsfiddle2</a>点击预览, 两个例子用了不同版本来实现元素的绝对定位，第一个使用的是 2.0.0-rc6，这个版本采用的是 MO，而后来因为 IOS 9.3 的 WebView 里 MO 有 bug，尤大便换成 window.postMessage来实现，即第二个实例版本为 2.0.0-rc7, 但是由于 postMessage 会将回调放到 macrotask 其实也就是 task 里面，导致可能执行了多次 UI 的task都没有执行 window.postMessage 的 task，也就延迟了更新DOM操作的时间。尤大在后续版本撤回了这一次修改，具体的讨论可以看<a href="https://github.com/vuejs/vue/issues/3771#issuecomment-249692588" target="_blank" rel="noopener">issue</a></p>
<p>关于进化，在后续的版本里，由于 es6 的新语法，nextTick 开始使用 Promise.then 和 MO 来做首选和次选，在前面的讨论中已经提到，Promise.then 也属于 microtask。</p>
<h3 id="Resize-Observer"><a href="#Resize-Observer" class="headerlink" title="Resize Observer"></a>Resize Observer</h3><blockquote>
<p>Resize Observer是一个新的JavaScript API，与Intersection Observer API、Mutation Observer等其他观察者API非常相似。<br>它允许在尺寸发生变化时通知元素。</p>
</blockquote>
<p>ResizeObserver的解释:开发过程当中经常遇到的一个问题就是如何监听一个 div 的尺寸变化。但众所周知，为了监听 div 的尺寸变化，都将侦听器附加到 window 中的 resize 事件。但这很容易导致性能问题，因为大量的触发事件。换句话说，使用 window.resize 通常是浪费的，因为它告诉我们每个视窗大小的变化，而不仅仅是当一个元素的大小发生变化。</p>
<p>使用 ResizeObserver 的API的另一个用例就是视窗 resize 事件不能帮助我们：当元素被动态地添加或删除时，会影响父元素的大小。这也是现代单页应用程序越来越频繁使用 ResizeObserver 原因之一。<br>通过 window.resize 事件的监听，可以调用一个回调函数。在这个回调函数中做我们需要做的事情。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// define a callback</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// something cool here</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// add resize listener to window object</span></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'resize'</span>, callback)</span><br></pre></td></tr></table></figure>
<p>比如说，你要调整一个元素的大小，那就需要在 resize 的回调函数 callback() 中调用 getBoundingClientRect 或 getComputerStyle 不过你要是不小心处理所有的读和写操作，就会导致布局混乱。比如下面这个小示例：</p>
<p>当你改变浏览器视窗大小的时候，就可以看到相应的变化：</p>
<p><img src="/2019/01/01/JS监听div元素的resize/3.gif" alt=""></p>
<p>这也就是为什么 ResizeObserver 是一个有用的API。它对所观察到的任何元素的大小的变化做出反应，而不依赖于所引起的变化。它还提供了对所观察元素的新大小的访问。那接下来让我们直接切入正题。</p>
<h4 id="简单总结一下："><a href="#简单总结一下：" class="headerlink" title="简单总结一下："></a>简单总结一下：</h4><p>ResizeObserver 允许我们观察DOM元素的内容矩形大小（宽度、高度）的变化，并做出相应的响应。它就像给元素添加 document.onresize() 或 window.resize() 事件（但在JavaScript中，只有 window 才有 resize 事件）。当元素改变大小而不调整视窗大小时，它是有用的。 下面描述一些调整观察者的行为：</p>
<ul>
<li>当观察到的元素被插入或从DOM中删除时，观察将会触发</li>
<li>当观察到的元素 display 值为 none 时，观察都会触发</li>
<li>观察不会对未替换的内联元素（non-replaced inline element）触发</li>
<li>观察不会由CSS的 transform 触发</li>
<li>如果元素有显示，而且元素大小不是 0,0 ，观察将会触发</li>
</ul>
<p>基本用法<br>使用Resize Observer非常简单，只需实例化一个新的ResizeObserver对象并传入一个回调函数，该函数接收观察到的条目</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myObserver = <span class="keyword">new</span> ResizeObserver(<span class="function"><span class="params">entries</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 遍历条目，做一些事情</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>然后，我们可以在实例上调用observe并传入一个元素来观察</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> someEl = <span class="built_in">document</span>.querySelector(<span class="string">'.some-element'</span>);</span><br><span class="line"><span class="keyword">const</span> someOtherEl = <span class="built_in">document</span>.querySelector(<span class="string">'.some-other-element'</span>);</span><br><span class="line"></span><br><span class="line">myObserver.observe(someEl);</span><br><span class="line">myObserver.observe(someOtherEl);</span><br></pre></td></tr></table></figure>
<p>对于每个entry，我们都会得到一个包含contentRect和一个target属性的对象。target是DOM元素本身，contentRect是具有以下属性的对象：width，height，x，y，top，right，bottom和left。</p>
<p>与元素的<strong>getBoundingClientRect</strong>不同，contentRect的width和height值不包含padding。contentRect.top是元素的顶部padding，contentRect.left是元素的左侧padding。</p>
<p>比如要打印出被监听元素寸尺变化时width和height的值，可以像下面这样做:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myObserver = <span class="keyword">new</span> ResizeObserver(<span class="function"><span class="params">entries</span> =&gt;</span> &#123;</span><br><span class="line">  entries.forEach(<span class="function"><span class="params">entry</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'width'</span>, entry.contentRect.width);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'height'</span>, entry.contentRect.height);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> someEl = <span class="built_in">document</span>.querySelector(<span class="string">'.some-element'</span>);</span><br><span class="line">myObserver.observe(someEl);</span><br></pre></td></tr></table></figure></p>
<p>上面的示例中，使用了forEach 循环来遍历观察者的回调中的 entries ，其实在 entries 上使用  for … of  可以得到相同的效果</p>
<h4 id="Resize-Observer-API-示例"><a href="#Resize-Observer-API-示例" class="headerlink" title="Resize Observer API 示例"></a>Resize Observer API 示例</h4><p>下面是一个简单的演示，以查看Resize Observer API的实际应用。<br>通过调整浏览器窗口的大小来尝试一下，注意渐变角度和文本内容仅在元素的大小受到影响时才发生变化：</p>
<p><img src="/2019/01/01/JS监听div元素的resize/4.webp" alt=""><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/vue.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">			html,</span></span><br><span class="line"><span class="undefined">			body &#123;</span></span><br><span class="line"><span class="undefined">				width: 100%;</span></span><br><span class="line"><span class="undefined">				height: 100%;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="css">			<span class="selector-class">.box</span> &#123;</span></span><br><span class="line"><span class="undefined">				text-align: center;</span></span><br><span class="line"><span class="undefined">				height: 20vh;</span></span><br><span class="line"><span class="undefined">				border-radius: 8px;</span></span><br><span class="line"><span class="undefined">				box-shadow: 0 0 4px var(--subtle);</span></span><br><span class="line"><span class="undefined">				display: flex;</span></span><br><span class="line"><span class="undefined">				justify-content: center;</span></span><br><span class="line"><span class="undefined">				align-items: center;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="css">			<span class="selector-class">.box</span> <span class="selector-tag">h3</span> &#123;</span></span><br><span class="line"><span class="css">				<span class="selector-tag">color</span>: <span class="selector-id">#fff</span>;</span></span><br><span class="line"><span class="undefined">				margin: 0;</span></span><br><span class="line"><span class="undefined">				font-size: 5vmin;</span></span><br><span class="line"><span class="css">				<span class="selector-tag">text-shadow</span>: 0 0 10<span class="selector-tag">px</span> <span class="selector-tag">rgba</span>(0, 0, 0, 0<span class="selector-class">.4</span>);</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="css">			<span class="selector-class">.box</span><span class="selector-class">.small</span> &#123;</span></span><br><span class="line"><span class="undefined">				max-width: 550px;</span></span><br><span class="line"><span class="undefined">				margin: 1rem auto;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"info"</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box small"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"info"</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">const</span> boxes = <span class="built_in">document</span>.querySelectorAll(<span class="string">'.box'</span>);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">const</span> myObserver = <span class="keyword">new</span> ResizeObserver(<span class="function"><span class="params">entries</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">for</span>(<span class="keyword">let</span> entry <span class="keyword">of</span> entries) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> infoEl = entry.target.querySelector(<span class="string">'.info'</span>);</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> width = <span class="built_in">Math</span>.floor(entry.contentRect.width);</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> height = <span class="built_in">Math</span>.floor(entry.contentRect.height);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> angle = <span class="built_in">Math</span>.floor(width / <span class="number">360</span> * <span class="number">100</span>);</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> gradient = <span class="string">`linear-gradient(<span class="subst">$&#123; angle &#125;</span>deg, rgba(0,143,104,1) 50%, rgba(250,224,66,1) 50%)`</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">					entry.target.style.background = gradient;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					infoEl.innerText = <span class="string">`I'm <span class="subst">$&#123; width &#125;</span>px and <span class="subst">$&#123; height &#125;</span>px tall`</span>;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			boxes.forEach(<span class="function"><span class="params">box</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">				myObserver.observe(box);</span></span><br><span class="line"><span class="undefined">			&#125;);</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="DOM变动事件的用法"><a href="#DOM变动事件的用法" class="headerlink" title="DOM变动事件的用法"></a>DOM变动事件的用法</h3><p>DOM2级的変动事件是为XML或html的DOM设计的，不特定于某种语言。 </p>
<h4 id="变动事件的分类有7种，最常用的浏览器支持最多的有3种"><a href="#变动事件的分类有7种，最常用的浏览器支持最多的有3种" class="headerlink" title="变动事件的分类有7种，最常用的浏览器支持最多的有3种:"></a>变动事件的分类有7种，最常用的浏览器支持最多的有3种:</h4><ol>
<li><strong>DOMSubtreeModified</strong>：在DOM结构中发生任何变化时触发； </li>
<li><strong>DOMNodeInserted</strong>：在一个节点作为子节点被插入到另一个节点中时触发； </li>
<li><strong>DOMNodeRemoved</strong>：在节点从其父节点中被移除时触发； </li>
<li>DOMNodeInsertedIntoDocument：在一个节点被直接插入文档中或者通过子树间接插入文档后触发。在DOMNodeInserted之后触发； </li>
<li>DOMNodeRemovedFromDocument：在一个节点被直接从文档中删除或通过子树间接从文档中移除之前触发。在DOMNodeRemoved之后触发。 </li>
<li>DOMAttrModified：在特性被修改之后触发； </li>
<li>DOMCharacterDataModified：在文本节点的值发生变化的时候触发。 </li>
</ol>
<h4 id="删除节点检测？"><a href="#删除节点检测？" class="headerlink" title="删除节点检测？"></a>删除节点检测？</h4><ul>
<li>首先触发的是DOMNodeRemoved事件，它对应的event对象中的target属性值是被删除的节点，relatedNode属性值是被删除节点的父节点，该事件会冒泡；</li>
<li>其次出发的是DOMNodeRemovedFromDocument事件，它对应的event对象中的target属性值为指定的被删除的子节点。只有绑定到它的子节点上才能被触发。</li>
<li>最后触发的是DOMSubtreeModified事件。这个事件对应event对象中的target属性是被移除节点的父节点。 </li>
</ul>
<p>(下面注释的序号为触发的顺序:)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">functiongetFirstChild(obj)&#123;// 获取第一子节点(找到第一个不为空的节点)var first = obj.firstChild;</span><br><span class="line">        while(first.nodeType != 1)&#123;</span><br><span class="line">            first = first.nextSibling;</span><br><span class="line">        &#125;</span><br><span class="line">        return first;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">EventUtil.addHandler(window,&quot;load&quot;,function(event)&#123;</span><br><span class="line">    varlist = document.getElementById(&apos;myList&apos;);</span><br><span class="line">    var btn = document.getElementById(&quot;mbtn&quot;);</span><br><span class="line"></span><br><span class="line">    EventUtil.addHandler(document,&quot;DOMNodeRemoved&quot;,function(event)&#123;</span><br><span class="line">        console.log(event.type);        //1:DOMNodeRemoved</span><br><span class="line">        console.log(event.target);      //2:ul节点,即被删除的节点</span><br><span class="line">        console.log(event.relatedNode); //3:body节点,即被删除节点的父节点</span><br><span class="line">    &#125;)</span><br><span class="line">    EventUtil.addHandler(getFirstChild(list),&quot;DOMNodeRemovedFromDocument&quot;,function(event)&#123;</span><br><span class="line">        console.log(event.type)         //4:DOMNodeRemovedFromDocument</span><br><span class="line">        console.log(event.target)       //5:li节点，即&lt;li&gt;item1&lt;/li&gt;</span><br><span class="line">    &#125;);</span><br><span class="line">    EventUtil.addHandler(document,&quot;DOMSubtreeModified&quot;,function(event)&#123;</span><br><span class="line">        console.log(event.type);        //6:DOMSubtreeModified</span><br><span class="line">        console.log(event.target);      //7:body节点，即被删除节点的父节点</span><br><span class="line">    &#125;)</span><br><span class="line">    EventUtil.addHandler(btn,&apos;click&apos;,function(event)&#123;</span><br><span class="line">        list.parentNode.removeChild(list);  //</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h4 id="插入节点检测？"><a href="#插入节点检测？" class="headerlink" title="插入节点检测？"></a>插入节点检测？</h4><p> 在使用appendChild()、replaceChild()或insertBefore()向DOM中插入节点的时候：</p>
<ul>
<li>首先触发DOMInserted事件，它对应的event对象中的target属性为添加的节点，relateNode属性对应被添加节点的父节点。（可冒泡）；</li>
<li>其次触发的是DOMNodeInsertedIntoDocument事件，它对应的event对象中的target属性是添加的节点，只有指定给一个子节点的事件处理程序才会被调用</li>
<li>最后出发的是DOMSubtreeModified事件，它对应的event对象长得target属性值是新节点的父节点。 </li>
</ul>
<blockquote>
<p>代码如下所示：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">functiongetFirstChild(obj)&#123;<span class="comment">// 获取第一子节点(找到第一个不为空的节点)var first = obj.firstChild;</span></span><br><span class="line">    <span class="keyword">while</span>(first.nodeType != <span class="number">1</span>)&#123;</span><br><span class="line">        first = first.nextSibling;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> first;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EventUtil.addHandler(<span class="built_in">window</span>,<span class="string">"load"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> list = <span class="built_in">document</span>.getElementById(<span class="string">'myList'</span>);</span><br><span class="line">    <span class="keyword">var</span> btn = <span class="built_in">document</span>.getElementById(<span class="string">"mbtn"</span>);</span><br><span class="line">    <span class="keyword">var</span> item4 = <span class="built_in">document</span>.createElement(<span class="string">'li'</span>);</span><br><span class="line">    <span class="keyword">var</span> item4Text = <span class="built_in">document</span>.createTextNode(<span class="string">'item4'</span>);</span><br><span class="line"></span><br><span class="line">    EventUtil.addHandler(<span class="built_in">document</span>,<span class="string">"DOMNodeInserted"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(event.type);        <span class="comment">//1:DOMNodeInserted</span></span><br><span class="line">        <span class="built_in">console</span>.log(event.target);      <span class="comment">//2:li节点，即被添加的节点</span></span><br><span class="line">        <span class="built_in">console</span>.log(event.relatedNode); <span class="comment">//3:ul节点，即被添加节点的父节点</span></span><br><span class="line">    &#125;);</span><br><span class="line">    EventUtil.addHandler(item4,<span class="string">"DOMNodeInsertedIntoDocument"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(event.type);        <span class="comment">//4:DOMNodeInsertedIntoDocument</span></span><br><span class="line">        <span class="built_in">console</span>.log(event.target);      <span class="comment">//5:li节点，即被添加的节点&lt;li&gt;item4&lt;/li&gt;</span></span><br><span class="line">    &#125;);</span><br><span class="line">    EventUtil.addHandler(<span class="built_in">document</span>,<span class="string">"DOMSubtreeModified"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(event.type);        <span class="comment">//6:DOMSubtreeModified</span></span><br><span class="line">        <span class="built_in">console</span>.log(event.target);      <span class="comment">//7:ul节点，即被触发节点的父节点</span></span><br><span class="line">    &#125;)</span><br><span class="line">    EventUtil.addHandler(btn,<span class="string">'click'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        item4.appendChild(item4Text);     getFirstChild</span><br><span class="line"></span><br><span class="line">        list.replaceChild(item4,getFirstChild(list));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="常用npm包"><a href="#常用npm包" class="headerlink" title="常用npm包"></a>常用npm包</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">element-resize-detector 【推荐】</span><br><span class="line">resize-detector</span><br><span class="line">size-sensor</span><br></pre></td></tr></table></figure>
<p><img src="/2019/01/01/JS监听div元素的resize/5.png" alt=""></p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><ul>
<li>Install</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm i --save size-sensor</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; bind, clear &#125; <span class="keyword">from</span> <span class="string">'size-sensor'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>bind&amp;unbind</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; bind, clear &#125; <span class="keyword">from</span> <span class="string">'size-sensor'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// bind the event on element, will get the `unbind` function</span></span><br><span class="line"><span class="keyword">const</span> unbind1 = bind(<span class="built_in">document</span>.querySelector(<span class="string">'.container'</span>), element =&gt; &#123;</span><br><span class="line">  <span class="comment">// do what you want to to.</span></span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> unbind2 = bind(<span class="built_in">document</span>.querySelector(<span class="string">'.container'</span>), element =&gt; &#123;</span><br><span class="line">  <span class="comment">// do what you want to to.</span></span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// if you want to cancel bind event.</span></span><br><span class="line">unbind1();</span><br></pre></td></tr></table></figure>
<ul>
<li>clear</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; bind, clear &#125; <span class="keyword">from</span> <span class="string">'size-sensor'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * // bind the resize event.</span></span><br><span class="line"><span class="comment"> * const unbind1 = bind(...);</span></span><br><span class="line"><span class="comment"> * const unbind2 = bind(...);</span></span><br><span class="line"><span class="comment"> * ...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// you can cancel all the event of element.</span></span><br><span class="line">clear(element);</span><br></pre></td></tr></table></figure>
<ul>
<li>实现方式：<br><img src="/2019/01/01/JS监听div元素的resize/6.webp" alt=""></li>
</ul>
<h3 id="resize-detector实现方式"><a href="#resize-detector实现方式" class="headerlink" title="resize-detector实现方式"></a>resize-detector实现方式</h3><h4 id="Github"><a href="#Github" class="headerlink" title="Github"></a><a href="https://github.com/libin1991/resize-detector" target="_blank" rel="noopener"><font color="#dd0000">Github</font></a></h4><blockquote>
<font color="#ff0000"><strong> 依次判断window.ResizeObserver,DOMSubtreeModified,window.MutationObserver </strong></font>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  createStyles,</span><br><span class="line">  createElement,</span><br><span class="line">  requestAnimationFrame,</span><br><span class="line">  cancelAnimationFrame,</span><br><span class="line">  getComputedStyle,</span><br><span class="line">  getRenderInfo</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'./util'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> triggerStyles <span class="keyword">from</span> <span class="string">'./triggers.css'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> total = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> style = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">addListener</span> (<span class="params">elem, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!elem.__resize_mutation_handler__) &#123;</span><br><span class="line">    elem.__resize_mutation_handler__ = handleMutation.bind(elem)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> listeners = elem.__resize_listeners__</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!listeners) &#123;</span><br><span class="line">    elem.__resize_listeners__ = []</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.ResizeObserver) &#123;</span><br><span class="line">      <span class="keyword">let</span> &#123; offsetWidth, offsetHeight &#125; = elem</span><br><span class="line">      <span class="keyword">let</span> ro = <span class="keyword">new</span> ResizeObserver(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!elem.__resize_observer_triggered__) &#123;</span><br><span class="line">          elem.__resize_observer_triggered__ = <span class="literal">true</span></span><br><span class="line">          <span class="keyword">if</span> (elem.offsetWidth === offsetWidth &amp;&amp; elem.offsetHeight === offsetHeight) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        runCallbacks(elem)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// initially display none won't trigger ResizeObserver callback</span></span><br><span class="line">      <span class="keyword">let</span> &#123; detached, rendered &#125; = getRenderInfo(elem)</span><br><span class="line">      elem.__resize_observer_triggered__ = detached === <span class="literal">false</span> &amp;&amp; rendered === <span class="literal">false</span></span><br><span class="line">      elem.__resize_observer__ = ro</span><br><span class="line">      ro.observe(elem)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (elem.attachEvent &amp;&amp; elem.addEventListener) &#123;</span><br><span class="line">      <span class="comment">// targeting IE9/10</span></span><br><span class="line">      elem.__resize_legacy_resize_handler__ = <span class="function"><span class="keyword">function</span> <span class="title">handleLegacyResize</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        runCallbacks(elem)</span><br><span class="line">      &#125;</span><br><span class="line">      elem.attachEvent(<span class="string">'onresize'</span>, elem.__resize_legacy_resize_handler__)</span><br><span class="line">      <span class="built_in">document</span>.addEventListener(<span class="string">'DOMSubtreeModified'</span>, elem.__resize_mutation_handler__)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!total) &#123;</span><br><span class="line">        style = createStyles(triggerStyles)</span><br><span class="line">      &#125;</span><br><span class="line">      initTriggers(elem)</span><br><span class="line"></span><br><span class="line">      elem.__resize_rendered__ = getRenderInfo(elem).rendered</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">window</span>.MutationObserver) &#123;</span><br><span class="line">        <span class="keyword">let</span> mo = <span class="keyword">new</span> MutationObserver(elem.__resize_mutation_handler__)</span><br><span class="line">        mo.observe(<span class="built_in">document</span>, &#123;</span><br><span class="line">          attributes: <span class="literal">true</span>,</span><br><span class="line">          childList: <span class="literal">true</span>,</span><br><span class="line">          characterData: <span class="literal">true</span>,</span><br><span class="line">          subtree: <span class="literal">true</span></span><br><span class="line">        &#125;)</span><br><span class="line">        elem.__resize_mutation_observer__ = mo</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  elem.__resize_listeners__.push(callback)</span><br><span class="line">  total++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">removeListener</span> (<span class="params">elem, callback</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// targeting IE9/10</span></span><br><span class="line">  <span class="keyword">if</span> (elem.detachEvent &amp;&amp; elem.removeEventListener) &#123;</span><br><span class="line">    elem.detachEvent(<span class="string">'onresize'</span>, elem.__resize_legacy_resize_handler__)</span><br><span class="line">    <span class="built_in">document</span>.removeEventListener(<span class="string">'DOMSubtreeModified'</span>, elem.__resize_mutation_handler__)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> listeners = elem.__resize_listeners__</span><br><span class="line">  <span class="keyword">if</span> (!listeners) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  listeners.splice(listeners.indexOf(callback), <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!listeners.length) &#123;</span><br><span class="line">    <span class="keyword">if</span> (elem.__resize_observer__) &#123;</span><br><span class="line">      elem.__resize_observer__.unobserve(elem)</span><br><span class="line">      elem.__resize_observer__.disconnect()</span><br><span class="line">      elem.__resize_observer__ = <span class="literal">null</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (elem.__resize_mutation_observer__) &#123;</span><br><span class="line">        elem.__resize_mutation_observer__.disconnect()</span><br><span class="line">        elem.__resize_mutation_observer__ = <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">      elem.removeEventListener(<span class="string">'scroll'</span>, handleScroll)</span><br><span class="line">      elem.removeChild(elem.__resize_triggers__.triggers)</span><br><span class="line">      elem.__resize_triggers__ = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    elem.__resize_listeners__ = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!--total &amp;&amp; style) &#123;</span><br><span class="line">    style.parentNode.removeChild(style)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUpdatedSize</span> (<span class="params">elem</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> &#123; width, height &#125; = elem.__resize_last__</span><br><span class="line">  <span class="keyword">let</span> &#123; offsetWidth, offsetHeight &#125; = elem</span><br><span class="line">  <span class="keyword">if</span> (offsetWidth !== width || offsetHeight !== height) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      width: offsetWidth,</span><br><span class="line">      height: offsetHeight</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleMutation</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// `this` denotes the scrolling element</span></span><br><span class="line">  <span class="keyword">let</span> &#123; rendered, detached &#125; = getRenderInfo(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">if</span> (rendered !== <span class="keyword">this</span>.__resize_rendered__) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!detached &amp;&amp; <span class="keyword">this</span>.__resize_triggers__) &#123;</span><br><span class="line">      resetTriggers(<span class="keyword">this</span>)</span><br><span class="line">      <span class="keyword">this</span>.addEventListener(<span class="string">'scroll'</span>, handleScroll, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.__resize_rendered__ = rendered</span><br><span class="line">    runCallbacks(<span class="keyword">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleScroll</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// `this` denotes the scrolling element</span></span><br><span class="line">  resetTriggers(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.__resize_raf__) &#123;</span><br><span class="line">    cancelAnimationFrame(<span class="keyword">this</span>.__resize_raf__)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.__resize_raf__ = requestAnimationFrame(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> updated = getUpdatedSize(<span class="keyword">this</span>)</span><br><span class="line">    <span class="keyword">if</span> (updated) &#123;</span><br><span class="line">      <span class="keyword">this</span>.__resize_last__ = updated</span><br><span class="line">      runCallbacks(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runCallbacks</span> (<span class="params">elem</span>) </span>&#123;</span><br><span class="line">  elem.__resize_listeners__.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">    callback.call(elem)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initTriggers</span> (<span class="params">elem</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> position = getComputedStyle(elem, <span class="string">'position'</span>)</span><br><span class="line">  <span class="keyword">if</span> (!position || position === <span class="string">'static'</span>) &#123;</span><br><span class="line">    elem.style.position = <span class="string">'relative'</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  elem.__resize_old_position__ = position</span><br><span class="line">  elem.__resize_last__ = &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> triggers = createElement(<span class="string">'div'</span>, &#123;</span><br><span class="line">    className: <span class="string">'resize-triggers'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">let</span> expand = createElement(<span class="string">'div'</span>, &#123;</span><br><span class="line">    className: <span class="string">'resize-expand-trigger'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">let</span> expandChild = createElement(<span class="string">'div'</span>)</span><br><span class="line">  <span class="keyword">let</span> contract = createElement(<span class="string">'div'</span>, &#123;</span><br><span class="line">    className: <span class="string">'resize-contract-trigger'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  expand.appendChild(expandChild)</span><br><span class="line">  triggers.appendChild(expand)</span><br><span class="line">  triggers.appendChild(contract)</span><br><span class="line">  elem.appendChild(triggers)</span><br><span class="line"></span><br><span class="line">  elem.__resize_triggers__ = &#123;</span><br><span class="line">    triggers,</span><br><span class="line">    expand,</span><br><span class="line">    expandChild,</span><br><span class="line">    contract</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resetTriggers(elem)</span><br><span class="line">  elem.addEventListener(<span class="string">'scroll'</span>, handleScroll, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">  elem.__resize_last__ = &#123;</span><br><span class="line">    width: elem.offsetWidth,</span><br><span class="line">    height: elem.offsetHeight</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resetTriggers</span> (<span class="params">elem</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> &#123; expand, expandChild, contract &#125; = elem.__resize_triggers__</span><br><span class="line"></span><br><span class="line">  <span class="comment">// batch read</span></span><br><span class="line">  <span class="keyword">let</span> &#123; <span class="attr">scrollWidth</span>: csw, <span class="attr">scrollHeight</span>: csh &#125; = contract</span><br><span class="line">  <span class="keyword">let</span> &#123; <span class="attr">offsetWidth</span>: eow, <span class="attr">offsetHeight</span>: eoh, <span class="attr">scrollWidth</span>: esw, <span class="attr">scrollHeight</span>: esh &#125; = expand</span><br><span class="line"></span><br><span class="line">  <span class="comment">// batch write</span></span><br><span class="line">  contract.scrollLeft = csw</span><br><span class="line">  contract.scrollTop = csh</span><br><span class="line">  expandChild.style.width = eow + <span class="number">1</span> + <span class="string">'px'</span></span><br><span class="line">  expandChild.style.height = eoh + <span class="number">1</span> + <span class="string">'px'</span></span><br><span class="line">  expand.scrollLeft = esw</span><br><span class="line">  expand.scrollTop = esh</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//util.js</span></span><br><span class="line"><span class="keyword">let</span> raf = <span class="literal">null</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">requestAnimationFrame</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!raf) &#123;</span><br><span class="line">    raf = (</span><br><span class="line">      <span class="built_in">window</span>.requestAnimationFrame ||</span><br><span class="line">      <span class="built_in">window</span>.webkitRequestAnimationFrame ||</span><br><span class="line">      <span class="built_in">window</span>.mozRequestAnimationFrame ||</span><br><span class="line">      <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> setTimeout(callback, <span class="number">16</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ).bind(<span class="built_in">window</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> raf(callback)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> caf = <span class="literal">null</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">cancelAnimationFrame</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!caf) &#123;</span><br><span class="line">    caf = (</span><br><span class="line">      <span class="built_in">window</span>.cancelAnimationFrame ||</span><br><span class="line">      <span class="built_in">window</span>.webkitCancelAnimationFrame ||</span><br><span class="line">      <span class="built_in">window</span>.mozCancelAnimationFrame ||</span><br><span class="line">      <span class="function"><span class="keyword">function</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">        clearTimeout(id)</span><br><span class="line">      &#125;</span><br><span class="line">    ).bind(<span class="built_in">window</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  caf(id)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createStyles</span> (<span class="params">styleText</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> style = <span class="built_in">document</span>.createElement(<span class="string">'style'</span>)</span><br><span class="line">  style.type = <span class="string">'text/css'</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (style.styleSheet) &#123;</span><br><span class="line">    style.styleSheet.cssText = styleText</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    style.appendChild(<span class="built_in">document</span>.createTextNode(styleText))</span><br><span class="line">  &#125;</span><br><span class="line">  (<span class="built_in">document</span>.querySelector(<span class="string">'head'</span>) || <span class="built_in">document</span>.body).appendChild(style)</span><br><span class="line">  <span class="keyword">return</span> style</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElement</span> (<span class="params">tagName, props = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> elem = <span class="built_in">document</span>.createElement(tagName)</span><br><span class="line">  <span class="built_in">Object</span>.keys(props).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    elem[key] = props[key]</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> elem</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getComputedStyle</span> (<span class="params">elem, prop, pseudo</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// for older versions of Firefox, `getComputedStyle` required</span></span><br><span class="line">  <span class="comment">// the second argument and may return `null` for some elements</span></span><br><span class="line">  <span class="comment">// when `display: none`</span></span><br><span class="line">  <span class="keyword">let</span> computedStyle = <span class="built_in">window</span>.getComputedStyle(elem, pseudo || <span class="literal">null</span>) || &#123;</span><br><span class="line">    display: <span class="string">'none'</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> computedStyle[prop]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getRenderInfo</span> (<span class="params">elem</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">document</span>.documentElement.contains(elem)) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      detached: <span class="literal">true</span>,</span><br><span class="line">      rendered: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> current = elem</span><br><span class="line">  <span class="keyword">while</span> (current !== <span class="built_in">document</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (getComputedStyle(current, <span class="string">'display'</span>) === <span class="string">'none'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        detached: <span class="literal">false</span>,</span><br><span class="line">        rendered: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    current = current.parentNode</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    detached: <span class="literal">false</span>,</span><br><span class="line">    rendered: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自适应滚动条"><a href="#自适应滚动条" class="headerlink" title="自适应滚动条"></a>自适应滚动条</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">"box"</span> <span class="attr">class</span>=<span class="string">"scrollbar_box"</span> </span></span><br><span class="line"><span class="tag">		@<span class="attr">wheel</span>=<span class="string">"scroll"</span> </span></span><br><span class="line"><span class="tag">		@<span class="attr">mouseenter</span>=<span class="string">"mouseenter($event)"</span></span></span><br><span class="line"><span class="tag">		@<span class="attr">mouseleave</span>=<span class="string">"mouseleave($event)"</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">"container"</span> <span class="attr">class</span>=<span class="string">"scrollbar_container"</span> </span></span><br><span class="line"><span class="tag">			<span class="attr">:style</span>=<span class="string">"&#123; transform : `translate(0px, $&#123;top*-1&#125;px)` &#125;"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">slot</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">"scrollbarPath"</span> <span class="attr">class</span>=<span class="string">"scrollbar_path"</span> </span></span><br><span class="line"><span class="tag">			<span class="attr">v-show</span>=<span class="string">"isVerticalBtn"</span> </span></span><br><span class="line"><span class="tag">			<span class="attr">:class</span>=<span class="string">"&#123;on: verticalCur&#125;"</span>&gt;</span></span><br><span class="line">			</span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">"verticalBtn"</span> </span></span><br><span class="line"><span class="tag">				<span class="attr">class</span>=<span class="string">"scrollbar_verticalBtn"</span> </span></span><br><span class="line"><span class="tag">				<span class="attr">:style</span>=<span class="string">"&#123; height: `$&#123;barHeight&#125;%`, top : `$&#123;barTop&#125;%` &#125;"</span> </span></span><br><span class="line"><span class="tag">				@<span class="attr">mousedown</span>=<span class="string">"startmoveV"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">	<span class="keyword">import</span> ElementResizeDetectorMaker <span class="keyword">from</span> <span class="string">'element-resize-detector'</span></span></span><br><span class="line"><span class="javascript">	<span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="undefined">		data() &#123;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">				top: <span class="number">0</span>, <span class="comment">//box偏移量px</span></span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				barHeight: <span class="number">0</span>, <span class="comment">//竖直滚动条高度</span></span></span><br><span class="line"><span class="javascript">				barTop: <span class="number">0</span>, <span class="comment">//竖直滚动条上下偏移量%</span></span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				isVerticalBtn: <span class="literal">false</span>, <span class="comment">//竖直滚动条是否显示</span></span></span><br><span class="line"><span class="javascript">				verticalCur: <span class="literal">false</span>,  <span class="comment">//鼠标悬浮滚动条显示</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				isStartmoveV: <span class="literal">false</span>, <span class="comment">//点击拖拽垂直标志位</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				point: &#123; <span class="comment">//相对拖快左上角的x,y坐标</span></span></span><br><span class="line"><span class="undefined">					y: 0</span></span><br><span class="line"><span class="undefined">				&#125;,</span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				boxPoint: &#123; <span class="comment">// 4个角容器的坐标</span></span></span><br><span class="line"><span class="undefined">					minY: 0</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="undefined">		props: &#123;</span></span><br><span class="line"><span class="javascript">			speed: &#123; <span class="comment">//鼠标滚轮速度</span></span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">Number</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="number">20</span></span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			changeTop: &#123; <span class="comment">//上下偏移量 px</span></span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">Number</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="number">0</span></span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="javascript">			containerH:&#123;  <span class="comment">//滚动区域高度</span></span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">Number</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="number">0</span></span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="undefined">		watch: &#123;</span></span><br><span class="line"><span class="javascript">			changeTop() &#123; <span class="comment">// 当外面传这个发送变化时就让到这个位置</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.setbarTop();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.setbarHeight();</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="undefined">		computed: &#123;&#125;,</span></span><br><span class="line"><span class="undefined">		methods: &#123;</span></span><br><span class="line"><span class="undefined">			mouseenter() &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.verticalCur = <span class="literal">true</span>;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			mouseleave() &#123;</span></span><br><span class="line"><span class="javascript">				setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.verticalCur = <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">				&#125;, 1000)</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="javascript">			<span class="comment">// 滚动</span></span></span><br><span class="line"><span class="undefined">			scroll(e) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.verticalCur = <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.isVerticalBtn) &#123;</span></span><br><span class="line"><span class="undefined">					e.preventDefault();</span></span><br><span class="line"><span class="undefined">					e.stopPropagation();</span></span><br><span class="line"><span class="javascript">				&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> speed = <span class="keyword">this</span>.speed;</span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				<span class="comment">//如果delta的值是负的，那么滚轮就是向下滚动，正的就是向上</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> scrollY = e.deltaY &gt; <span class="number">0</span> ? speed * <span class="number">1</span> : speed * <span class="number">-1</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> nextY = <span class="keyword">this</span>.top * <span class="number">1</span> + scrollY;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="comment">// 如果没有垂直的滚动条就滚动横向的</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.isVerticalBtn) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.setVerticalScroll(nextY)</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="javascript">			<span class="comment">//val是偏移量 滚动的 </span></span></span><br><span class="line"><span class="undefined">			setVerticalScroll(val) &#123; </span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> size = <span class="keyword">this</span>.getSize();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> topEnd = size.containerHeight - size.boxHeight;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(val &gt;= topEnd) &#123;</span></span><br><span class="line"><span class="undefined">					val = topEnd;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="keyword">this</span>.top == val) &#123; <span class="comment">// 已经到底部就不用继续执行了</span></span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.$emit(<span class="string">'bottom'</span>);</span></span><br><span class="line"><span class="undefined">				&#125;;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(val &lt;= <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="undefined">					val = 0;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="keyword">this</span>.top == val) &#123; <span class="comment">// 已经到顶部就不用继续执行了</span></span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.$emit(<span class="string">'top'</span>);</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.top = val;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.$emit(<span class="string">'update:changeTop'</span>, <span class="keyword">this</span>.top);</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.$emit(<span class="string">'update:containerH'</span>, size.containerHeight);</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.barTop = (val / size.containerHeight) * <span class="number">100</span>; <span class="comment">// 导航条的top的计算 </span></span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="javascript">			<span class="comment">// 垂直btn点击后的事件</span></span></span><br><span class="line"><span class="undefined">			startmoveV(e) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.verticalCur = <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">				e.preventDefault(); <span class="comment">//阻止默认事件，取消文字选中</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> verticalBtnReat=<span class="keyword">this</span>.$refs.verticalBtn.getBoundingClientRect()  <span class="comment">//获取滑块的坐标</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.point.y = e.clientY-verticalBtnReat.top</span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.isStartmoveV = <span class="literal">true</span> <span class="comment">//鼠标按下标志位</span></span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				<span class="built_in">document</span>.addEventListener(<span class="string">'mousemove'</span>, <span class="keyword">this</span>.fnMousemoveV, <span class="literal">false</span>);</span></span><br><span class="line"><span class="javascript">				<span class="built_in">document</span>.addEventListener(<span class="string">'mouseup'</span>, <span class="keyword">this</span>.fnMouseup, <span class="literal">false</span>);</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="javascript">			<span class="comment">// 垂直移动监听</span></span></span><br><span class="line"><span class="undefined">			fnMousemoveV(e) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.verticalCur = <span class="literal">true</span>;</span></span><br><span class="line"><span class="undefined">				e.preventDefault();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.isStartmoveV) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.setVerticalClick(e.clientY - <span class="keyword">this</span>.point.y);   <span class="comment">//鼠标移动位置</span></span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="javascript">			<span class="comment">// 点击拖拽设置</span></span></span><br><span class="line"><span class="undefined">			setVerticalClick(val) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.verticalCur = <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> size = <span class="keyword">this</span>.getSize();</span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				<span class="comment">//计算出拖快top值换算成百分比</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> barTop = ((val - <span class="keyword">this</span>.boxPoint.minY) / <span class="keyword">this</span>.$refs.box.clientHeight) * <span class="number">100</span>; </span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(barTop &lt;= <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="undefined">					barTop = 0;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="keyword">this</span>.barTop == barTop) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.$emit(<span class="string">'top'</span>);</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(barTop + <span class="keyword">this</span>.barHeight &gt;= <span class="number">100</span>) &#123;</span></span><br><span class="line"><span class="javascript">					barTop = <span class="number">100</span> - <span class="keyword">this</span>.barHeight;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="keyword">this</span>.barTop == barTop) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.$emit(<span class="string">'bottom'</span>);</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.barTop = barTop; <span class="comment">// 这里是百分比的需要转换</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.top = ((barTop / <span class="number">100</span>) * size.containerHeight).toFixed(<span class="number">2</span>) * <span class="number">1</span>; <span class="comment">//换算百分百</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.$emit(<span class="string">'update:changeTop'</span>, <span class="keyword">this</span>.top);</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.$emit(<span class="string">'update:containerH'</span>, size.containerHeight);</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="javascript">			<span class="comment">// 鼠标抬起监听</span></span></span><br><span class="line"><span class="undefined">			fnMouseup(e) &#123;</span></span><br><span class="line"><span class="undefined">				e.preventDefault();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.isStartmoveV = <span class="literal">false</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.clearMousemove();</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="javascript">			<span class="comment">// 清除监听</span></span></span><br><span class="line"><span class="undefined">			clearMousemove() &#123;</span></span><br><span class="line"><span class="javascript">				<span class="built_in">document</span>.removeEventListener(<span class="string">'mousemove'</span>, <span class="keyword">this</span>.fnMousemoveV, <span class="literal">false</span>);</span></span><br><span class="line"><span class="javascript">				<span class="built_in">document</span>.removeEventListener(<span class="string">'mouseup'</span>, <span class="keyword">this</span>.fnMouseup, <span class="literal">false</span>);</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="javascript">			<span class="comment">// 返回盒子尺寸</span></span></span><br><span class="line"><span class="undefined">			getSize() &#123; </span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> _container = <span class="keyword">this</span>.$refs.container;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> _box = <span class="keyword">this</span>.$refs.box;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">					containerHeight: _container.clientHeight, <span class="comment">//滚动内容的高度宽度</span></span></span><br><span class="line"><span class="undefined">					containerWidth: _container.clientWidth,</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					boxHeight: _box.clientHeight, <span class="comment">//最外面盒子的高度宽度</span></span></span><br><span class="line"><span class="undefined">					boxWidth: _box.clientWidth,</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="javascript">			setbarHeight() &#123; <span class="comment">//设置拖快高度</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> size = <span class="keyword">this</span>.getSize();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> boxPoint = <span class="keyword">this</span>.$refs.box.getBoundingClientRect(); <span class="comment">// container的极坐标</span></span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				<span class="comment">// 保存box窗口坐标</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.boxPoint.minY = boxPoint.top;</span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				<span class="comment">// 计算拖拽条的宽高</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.barHeight = (size.boxHeight / size.containerHeight) * <span class="number">100</span>; <span class="comment">//100是百分比，box的高度是100%,比例计算</span></span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				<span class="comment">// 是否显示拖拽条</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.isVerticalBtn = (<span class="keyword">this</span>.barHeight &gt;= <span class="number">100</span> &amp;&amp; !!<span class="keyword">this</span>.barHeight) ? <span class="literal">false</span> : <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(!<span class="keyword">this</span>.isVerticalBtn) &#123;  <span class="comment">//不显示滚动条清0 </span></span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.top = <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.barTop = <span class="number">0</span>;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			setbarTop() &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.top == <span class="keyword">this</span>.changeTop) <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> size = <span class="keyword">this</span>.getSize();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> topEnd = size.containerHeight - size.boxHeight;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.changeTop &lt; <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.top = <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">				&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.changeTop &gt;= topEnd) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.top = topEnd;</span></span><br><span class="line"><span class="javascript">				&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.top = <span class="keyword">this</span>.changeTop;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.barTop = ((<span class="keyword">this</span>.top * <span class="number">100</span>) / size.containerHeight) * <span class="number">1</span>;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			resizeListener() &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> elementResizeDetector = ElementResizeDetectorMaker(&#123;</span></span><br><span class="line"><span class="javascript">					strategy: <span class="string">'scroll'</span>,</span></span><br><span class="line"><span class="javascript">					callOnAdd: <span class="literal">false</span></span></span><br><span class="line"><span class="undefined">				&#125;)</span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				elementResizeDetector.listenTo(<span class="keyword">this</span>.$refs.container, () =&gt; &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> newcontainerH = <span class="keyword">this</span>.$slots.default[<span class="number">0</span>][<span class="string">'elm'</span>]</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="keyword">this</span>.top==<span class="number">0</span>)&#123;</span></span><br><span class="line"><span class="javascript">						<span class="built_in">console</span>.log(newcontainerH.clientHeight-<span class="keyword">this</span>.containerH)</span></span><br><span class="line"><span class="javascript">						<span class="keyword">var</span> top=newcontainerH.clientHeight-<span class="keyword">this</span>.containerH;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.$emit(<span class="string">'update:changeTop'</span>, top);</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined">					</span></span><br><span class="line"><span class="undefined">				&#125;)</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="undefined">		mounted() &#123;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">this</span>.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.setbarTop();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.setbarHeight();</span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.resizeListener();</span></span><br><span class="line"><span class="undefined">			&#125;);</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="javascript">		updated() &#123; <span class="comment">//由于数据更改导致的虚拟 DOM 重新渲染和打补丁，在这之后会调用该钩子</span></span></span><br><span class="line"><span class="javascript">			<span class="keyword">this</span>.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.setbarTop();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.setbarHeight();</span></span><br><span class="line"><span class="undefined">			&#125;);</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span> <span class="attr">lang</span>=<span class="string">"less"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">	<span class="selector-class">.scrollbar_box</span> &#123;</span></span><br><span class="line"><span class="undefined">		overflow: hidden;</span></span><br><span class="line"><span class="undefined">		position: relative;</span></span><br><span class="line"><span class="undefined">		height: 100%;</span></span><br><span class="line"><span class="undefined">		width: 100%;</span></span><br><span class="line"><span class="undefined">		transform: translateZ(0);</span></span><br><span class="line"><span class="undefined">		backface-visibility: hidden;</span></span><br><span class="line"><span class="undefined">		perspective: 1000;</span></span><br><span class="line"><span class="undefined">		transform: translate3d(0, 0, 0);</span></span><br><span class="line"><span class="css">		<span class="selector-class">.scrollbar_path</span> &#123;</span></span><br><span class="line"><span class="undefined">			position: absolute;</span></span><br><span class="line"><span class="undefined">			top: 0px;</span></span><br><span class="line"><span class="undefined">			right: 0px;</span></span><br><span class="line"><span class="undefined">			width: 6px;</span></span><br><span class="line"><span class="undefined">			height: 100%;</span></span><br><span class="line"><span class="undefined">			background-color: white;</span></span><br><span class="line"><span class="undefined">			opacity: 0;</span></span><br><span class="line"><span class="undefined">			transition: opacity 500ms;</span></span><br><span class="line"><span class="css">			&amp;<span class="selector-class">.on</span> &#123;</span></span><br><span class="line"><span class="undefined">				opacity: 1;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="css">			<span class="selector-class">.scrollbar_verticalBtn</span> &#123;</span></span><br><span class="line"><span class="undefined">				position: absolute;</span></span><br><span class="line"><span class="undefined">				top: 0px;</span></span><br><span class="line"><span class="undefined">				right: 0px;</span></span><br><span class="line"><span class="undefined">				width: 6px;</span></span><br><span class="line"><span class="undefined">				border-radius: 3px;</span></span><br><span class="line"><span class="css">				<span class="selector-tag">background-color</span>: <span class="selector-id">#51555e</span>;</span></span><br><span class="line"><span class="undefined">				cursor: pointer;</span></span><br><span class="line"><span class="undefined">				z-index: 50;</span></span><br><span class="line"><span class="css">				&amp;<span class="selector-pseudo">:hover</span> &#123;</span></span><br><span class="line"><span class="undefined">					background-color: green;</span></span><br><span class="line"><span class="undefined">					z-index: 51;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用方法</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"box"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">scrollbar</span> @<span class="attr">bottom</span>=<span class="string">"bottom"</span> @<span class="attr">top</span>=<span class="string">"top"</span> <span class="attr">:changeTop.sync</span>=<span class="string">"changeTop"</span> <span class="attr">:containerH.sync</span>=<span class="string">"containerH"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">				<span class="comment">&lt;!--&lt;p&gt;Vue自定义滚动条&lt;/p&gt;--&gt;</span></span><br><span class="line"> 				<span class="tag">&lt;<span class="name">div</span> <span class="attr">v-for</span>=<span class="string">"(str,index) in data"</span>&gt;</span> &#123;&#123;str&#125;&#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">scrollbar</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"loadingbox"</span> <span class="attr">v-show</span>=<span class="string">"isloading"</span>&gt;</span>loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">	<span class="keyword">import</span> scrollbar <span class="keyword">from</span> <span class="string">'./vue-scroll.vue'</span></span></span><br><span class="line"><span class="javascript">	<span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="undefined">		components: &#123;</span></span><br><span class="line"><span class="undefined">			scrollbar</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="undefined">		data() &#123;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="undefined">				data: [...Array(30).keys()],</span></span><br><span class="line"><span class="javascript">				isloading: <span class="literal">false</span>,</span></span><br><span class="line"><span class="undefined">				changeTop: 10000000,</span></span><br><span class="line"><span class="undefined">				containerH:0</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="undefined">		methods: &#123;</span></span><br><span class="line"><span class="undefined">			top() &#123;</span></span><br><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'顶部'</span>);</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.isloading = <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> newdata = [</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="undefined">				];</span></span><br><span class="line"><span class="javascript">				setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.data = [...newdata,...this.data];</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.isloading = <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">				&#125;, 1500);</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			bottom() &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">return</span></span></span><br><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'底部'</span>)</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.isloading = <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> newdata = [</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="undefined">				];</span></span><br><span class="line"><span class="javascript">				setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.data = [...this.data,...newdata];</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.isloading = <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">				&#125;, 1500);</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">	* &#123;</span></span><br><span class="line"><span class="undefined">		padding: 0px;</span></span><br><span class="line"><span class="undefined">		margin: 0px;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined">	</span></span><br><span class="line"><span class="css">	<span class="selector-id">#box</span> &#123;</span></span><br><span class="line"><span class="undefined">		margin: 50px auto;</span></span><br><span class="line"><span class="undefined">		text-align: center;</span></span><br><span class="line"><span class="undefined">		width: 500px;</span></span><br><span class="line"><span class="undefined">		height: 500px;</span></span><br><span class="line"><span class="undefined">		border: 1px solid red;</span></span><br><span class="line"><span class="undefined">		border-radius: 3px;</span></span><br><span class="line"><span class="undefined">		position: relative;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined">	</span></span><br><span class="line"><span class="css">	<span class="selector-id">#container</span> &#123;</span></span><br><span class="line"><span class="undefined">		width: 100%;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined">	</span></span><br><span class="line"><span class="css">	<span class="selector-id">#loadingbox</span> &#123;</span></span><br><span class="line"><span class="undefined">		width: 100%;</span></span><br><span class="line"><span class="css">		<span class="selector-tag">background</span>: <span class="selector-tag">rgba</span>(255, 255, 255, <span class="selector-class">.8</span>);</span></span><br><span class="line"><span class="undefined">		position: absolute;</span></span><br><span class="line"><span class="undefined">		left: 0;</span></span><br><span class="line"><span class="undefined">		bottom: 0;</span></span><br><span class="line"><span class="undefined">		text-align: center;</span></span><br><span class="line"><span class="undefined">		font-weight: bold;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="模拟windows的resize"><a href="#模拟windows的resize" class="headerlink" title="模拟windows的resize"></a>模拟windows的resize</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/vue.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">			html,body&#123;</span></span><br><span class="line"><span class="undefined">				width: 100%;</span></span><br><span class="line"><span class="undefined">				height: 100%;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="css">			<span class="selector-class">.container</span> &#123;</span></span><br><span class="line"><span class="undefined">				width: 100%;</span></span><br><span class="line"><span class="undefined">				height: 100%;</span></span><br><span class="line"><span class="undefined">				position: relative</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="css">			<span class="selector-class">.resize-element</span> &#123;</span></span><br><span class="line"><span class="undefined">				position: absolute;</span></span><br><span class="line"><span class="undefined">				top: 50%;</span></span><br><span class="line"><span class="undefined">				left: 50%;</span></span><br><span class="line"><span class="undefined">				height: 10rem;</span></span><br><span class="line"><span class="undefined">				width: 10rem;</span></span><br><span class="line"><span class="undefined">				transform: translate(-50%,-50%);</span></span><br><span class="line"><span class="undefined">				overflow: hidden;</span></span><br><span class="line"><span class="css">				<span class="selector-tag">resize</span>: <span class="selector-tag">both</span>;   <span class="comment">/*用户可以调节元素的宽度和高度*/</span></span></span><br><span class="line"><span class="undefined">				display: block;</span></span><br><span class="line"><span class="css">				<span class="selector-tag">box-shadow</span>: 0 0 1<span class="selector-tag">px</span> 1<span class="selector-tag">px</span> <span class="selector-id">#3361D8</span>;</span></span><br><span class="line"><span class="undefined">				border-radius: 2px;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span> <span class="attr">id</span>=<span class="string">"main"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"resize-element"</span>&gt;</span></span><br><span class="line">				改变大小试试</span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"resize-record"</span>&gt;</span></span><br><span class="line">				窗口触发了&#123;&#123;firedNum&#125;&#125;次resize事件。</span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">const</span> CSS = <span class="string">'position:absolute;left:0;top:-100%;width:100%;height:100%;margin:1px 0 0;border:none;opacity:0;visibility:hidden;pointer-events:none;'</span>;</span></span><br><span class="line"><span class="javascript">			<span class="function"><span class="keyword">function</span> <span class="title">observeResize</span>(<span class="params">element, handler</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> frame = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span></span><br><span class="line"><span class="undefined">				frame.style.cssText = CSS;</span></span><br><span class="line"><span class="javascript">				frame.onload = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">					frame.contentWindow.onresize = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">						handler(element);</span></span><br><span class="line"><span class="undefined">					&#125;;</span></span><br><span class="line"><span class="undefined">				&#125;;</span></span><br><span class="line"><span class="undefined">				element.appendChild(frame);</span></span><br><span class="line"><span class="javascript">				<span class="keyword">return</span> frame;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">let</span> element = <span class="built_in">document</span>.getElementById(<span class="string">'main'</span>);</span></span><br><span class="line"><span class="javascript">			<span class="comment">// listen for resize</span></span></span><br><span class="line"><span class="undefined">			observeResize(element, () =&gt; &#123;</span></span><br><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'new size: '</span>, &#123;</span></span><br><span class="line"><span class="undefined">					width: element.clientWidth,</span></span><br><span class="line"><span class="undefined">					height: element.clientHeight</span></span><br><span class="line"><span class="undefined">				&#125;);</span></span><br><span class="line"><span class="undefined">			&#125;);</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="实现一个简单的div-resize-Listener"><a href="#实现一个简单的div-resize-Listener" class="headerlink" title="实现一个简单的div resize Listener"></a>实现一个简单的div resize Listener</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span>Example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="function"><span class="keyword">function</span> <span class="title">ResizeSensor</span>(<span class="params">element, callback</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">				<span class="function"><span class="keyword">function</span> <span class="title">EventQueue</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.q = [];</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.add = <span class="function"><span class="keyword">function</span>(<span class="params">ev</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.q.push(ev);</span></span><br><span class="line"><span class="undefined">					&#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> i, j;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.call = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">for</span>(i = <span class="number">0</span>, j = <span class="keyword">this</span>.q.length; i &lt; j; i++) &#123;</span></span><br><span class="line"><span class="javascript">							<span class="keyword">this</span>.q[i].call();</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="undefined">					&#125;;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="function"><span class="keyword">function</span> <span class="title">getComputedStyle</span>(<span class="params">element, prop</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(element.currentStyle) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> element.currentStyle[prop];</span></span><br><span class="line"><span class="javascript">					&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">window</span>.getComputedStyle) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> <span class="built_in">window</span>.getComputedStyle(element, <span class="literal">null</span>).getPropertyValue(prop);</span></span><br><span class="line"><span class="javascript">					&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> element.style[prop];</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="function"><span class="keyword">function</span> <span class="title">attachResizeEvent</span>(<span class="params">element, resized</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(!element.resizedAttached) &#123;</span></span><br><span class="line"><span class="javascript">						element.resizedAttached = <span class="keyword">new</span> EventQueue();</span></span><br><span class="line"><span class="undefined">						element.resizedAttached.add(resized);</span></span><br><span class="line"><span class="javascript">					&#125; <span class="keyword">else</span> <span class="keyword">if</span>(element.resizedAttached) &#123;</span></span><br><span class="line"><span class="undefined">						element.resizedAttached.add(resized);</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span>;</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					element.resizeSensor = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span></span><br><span class="line"><span class="javascript">					element.resizeSensor.className = <span class="string">'resize-sensor'</span>;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> style = <span class="string">'position: absolute; left: 0; top: 0; right: 0; bottom: 0; overflow: scroll; z-index: -1; visibility: hidden;'</span>;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> styleChild = <span class="string">'position: absolute; left: 0; top: 0;'</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">					element.resizeSensor.style.cssText = style;</span></span><br><span class="line"><span class="undefined">					element.resizeSensor.innerHTML =</span></span><br><span class="line"><span class="xml">						'<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"resize-sensor-expand"</span> <span class="attr">style</span>=<span class="string">"' + style + '"</span>&gt;</span>' +</span></span><br><span class="line"><span class="xml">						'<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"' + styleChild + '"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>' +</span></span><br><span class="line"><span class="javascript">						<span class="string">'&lt;/div&gt;'</span> +</span></span><br><span class="line"><span class="xml">						'<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"resize-sensor-shrink"</span> <span class="attr">style</span>=<span class="string">"' + style + '"</span>&gt;</span>' +</span></span><br><span class="line"><span class="xml">						'<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"' + styleChild + ' width: 200%; height: 200%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>' +</span></span><br><span class="line"><span class="javascript">						<span class="string">'&lt;/div&gt;'</span>;</span></span><br><span class="line"><span class="undefined">					element.appendChild(element.resizeSensor);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(!&#123;</span></span><br><span class="line"><span class="undefined">							fixed: 1,</span></span><br><span class="line"><span class="undefined">							absolute: 1</span></span><br><span class="line"><span class="javascript">						&#125;[getComputedStyle(element, <span class="string">'position'</span>)]) &#123;</span></span><br><span class="line"><span class="javascript">						element.style.position = <span class="string">'relative'</span>;</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> expand = element.resizeSensor.childNodes[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> expandChild = expand.childNodes[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> shrink = element.resizeSensor.childNodes[<span class="number">1</span>];</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> shrinkChild = shrink.childNodes[<span class="number">0</span>];</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> lastWidth, lastHeight;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> reset = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						expandChild.style.width = expand.offsetWidth + <span class="number">10</span> + <span class="string">'px'</span>;</span></span><br><span class="line"><span class="javascript">						expandChild.style.height = expand.offsetHeight + <span class="number">10</span> + <span class="string">'px'</span>;</span></span><br><span class="line"><span class="undefined">						expand.scrollLeft = expand.scrollWidth;</span></span><br><span class="line"><span class="undefined">						expand.scrollTop = expand.scrollHeight;</span></span><br><span class="line"><span class="undefined">						shrink.scrollLeft = shrink.scrollWidth;</span></span><br><span class="line"><span class="undefined">						shrink.scrollTop = shrink.scrollHeight;</span></span><br><span class="line"><span class="undefined">						lastWidth = element.offsetWidth;</span></span><br><span class="line"><span class="undefined">						lastHeight = element.offsetHeight;</span></span><br><span class="line"><span class="undefined">					&#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">					reset();</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> changed = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(element.resizedAttached) &#123;</span></span><br><span class="line"><span class="undefined">							element.resizedAttached.call();</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="undefined">					&#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> addEvent = <span class="function"><span class="keyword">function</span>(<span class="params">el, name, cb</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(el.attachEvent) &#123;</span></span><br><span class="line"><span class="javascript">							el.attachEvent(<span class="string">'on'</span> + name, cb);</span></span><br><span class="line"><span class="javascript">						&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="undefined">							el.addEventListener(name, cb);</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="undefined">					&#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					addEvent(expand, <span class="string">'scroll'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(element.offsetWidth &gt; lastWidth || element.offsetHeight &gt; lastHeight) &#123;</span></span><br><span class="line"><span class="undefined">							changed();</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="undefined">						reset();</span></span><br><span class="line"><span class="undefined">					&#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					addEvent(shrink, <span class="string">'scroll'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(element.offsetWidth &lt; lastWidth || element.offsetHeight &lt; lastHeight) &#123;</span></span><br><span class="line"><span class="undefined">							changed();</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="undefined">						reset();</span></span><br><span class="line"><span class="undefined">					&#125;);</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="string">"[object Array]"</span> === <span class="built_in">Object</span>.prototype.toString.call(element) ||(<span class="string">'undefined'</span> !== <span class="keyword">typeof</span> jQuery &amp;&amp; element <span class="keyword">instanceof</span> jQuery) <span class="comment">//jquery</span></span></span><br><span class="line"><span class="javascript">					||(<span class="string">'undefined'</span> !== <span class="keyword">typeof</span> Elements &amp;&amp; element <span class="keyword">instanceof</span> Elements) <span class="comment">//mootools</span></span></span><br><span class="line"><span class="undefined">				) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> i = <span class="number">0</span>,</span></span><br><span class="line"><span class="undefined">						j = element.length;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">for</span>(; i &lt; j; i++) &#123;</span></span><br><span class="line"><span class="undefined">						attachResizeEvent(element[i], callback);</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="javascript">				&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="undefined">					attachResizeEvent(element, callback);</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.detach = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="undefined">					ResizeSensor.detach(element);</span></span><br><span class="line"><span class="undefined">				&#125;;</span></span><br><span class="line"><span class="undefined">			&#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			ResizeSensor.detach = <span class="function"><span class="keyword">function</span>(<span class="params">element</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(element.resizeSensor) &#123;</span></span><br><span class="line"><span class="undefined">					element.removeChild(element.resizeSensor);</span></span><br><span class="line"><span class="javascript">					<span class="keyword">delete</span> element.resizeSensor;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">delete</span> element.resizedAttached;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;;</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"width"</span>&gt;</span>100px wide<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"main"</span> <span class="attr">style</span>=<span class="string">"resize:both;width:100px;overflow:scroll;border:1px solid black;"</span> <span class="attr">id</span>=<span class="string">"resize"</span>&gt;</span>You can resize me!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">"textarea"</span>&gt;</span>You can focus me!<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">var</span> sensor = <span class="keyword">new</span> ResizeSensor(<span class="built_in">document</span>.getElementById(<span class="string">"main"</span>),<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">					<span class="built_in">console</span>.log(<span class="string">"anything inside of element caused my size to change"</span>);</span></span><br><span class="line"><span class="undefined">				&#125;)</span></span><br><span class="line"><span class="javascript">			<span class="keyword">var</span> sensor2 = <span class="keyword">new</span> ResizeSensor(<span class="built_in">document</span>.getElementById(<span class="string">"textarea"</span>),<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">					<span class="built_in">console</span>.log(<span class="string">"anything inside of element caused my size to change"</span>);</span></span><br><span class="line"><span class="undefined">				&#125;)</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/31/写一个webpack-loader-插件/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/31/写一个webpack-loader-插件/" itemprop="url">写一个webpack-loader-插件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-31T22:39:14+08:00">
                2018-12-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="DEMO-Code-地址"><a href="#DEMO-Code-地址" class="headerlink" title="DEMO Code 地址"></a><a href="https://github.com/libin1991/webpack4-vue-more-page-cli/tree/master/%E5%86%99%E4%B8%80%E4%B8%AAwebpack-loader-%E6%8F%92%E4%BB%B6" target="_blank" rel="noopener"><font color="#ff0000">DEMO Code 地址</font></a></h3><h3 id="Webpack-Loader"><a href="#Webpack-Loader" class="headerlink" title="Webpack Loader"></a>Webpack Loader</h3><p>loader 用于对模块的源代码进行转换。loader 可以使你在 import 或”加载”模块时预处理文件。因此，loader 类似于其他构建工具中“任务(task)”，并提供了处理前端构建步骤的强大方法。loader 可以将文件从不同的语言（如 TypeScript）转换为 JavaScript，或将内联图像转换为 data URL。</p>
<p>loader 是导出为一个函数的 node 模块。该函数在 loader 转换资源的时候调用。给定的函数将调用 loader API，并通过 this 上下文访问。</p>
<p>loader是一个node module,那么它的基本形式如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">module.exports = function(source) &#123;</span><br><span class="line">  return source;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>loader只能传入一个包含包含资源文件内容的字符串（source）<br>如果是同步loader,可以用 return 或者 this.callback(err, value…) 将代码返回<br>异步loader：在一个异步的模块中，回传时需要调用 Loader API 提供的回调方法 this.async 来获取 callback 函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">module.exports = function(content, map, meta) &#123;</span><br><span class="line">  var callback = this.async();</span><br><span class="line">  someAsyncOperation(content, function(err, result) &#123;</span><br><span class="line">    if (err) return callback(err);</span><br><span class="line">    callback(null, result, map, meta);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h4 id="txt-loader"><a href="#txt-loader" class="headerlink" title="txt-loader"></a>txt-loader</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">const &#123; getOptions &#125; = require(&apos;loader-utils&apos;);</span><br><span class="line">const validateOptions = require(&apos;schema-utils&apos;);</span><br><span class="line"></span><br><span class="line">const schema = require(&apos;./options&apos;);</span><br><span class="line"></span><br><span class="line">module.exports = function rawLoader(source) &#123;</span><br><span class="line">  const options = getOptions(this) || &#123;&#125;;</span><br><span class="line">   </span><br><span class="line">  validateOptions(schema, options, &apos;Raw Loader&apos;);</span><br><span class="line"></span><br><span class="line">  const json = JSON.stringify(source)</span><br><span class="line">    .replace(/\u2028/g, &apos;\\u2028&apos;)</span><br><span class="line">    .replace(/\u2029/g, &apos;\\u2029&apos;);</span><br><span class="line">  return `module.exports = $&#123;json&#125;`;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="webpack-config-js"><a href="#webpack-config-js" class="headerlink" title="webpack.config.js"></a>webpack.config.js</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">let path=require(&quot;path&quot;);</span><br><span class="line">let HtmlWebpackPlugin=require(&quot;html-webpack-plugin&quot;);</span><br><span class="line">let ExtractTextWebpackPlugin=require(&quot;extract-text-webpack-plugin&quot;);</span><br><span class="line">let CleanWebpackPlugin=require(&quot;clean-webpack-plugin&quot;);</span><br><span class="line">let webpack=require(&quot;webpack&quot;);</span><br><span class="line">let VueLoaderPlugin = require(&apos;vue-loader/lib/plugin&apos;);</span><br><span class="line"></span><br><span class="line">module.exports=&#123;</span><br><span class="line">    entry:&quot;./src/index.js&quot;,</span><br><span class="line">    output:&#123;</span><br><span class="line">        filename:&quot;bundle.[hash:4].js&quot;,</span><br><span class="line">        path:path.resolve(&quot;dist&quot;)</span><br><span class="line">    &#125;,</span><br><span class="line">    resolveLoader: &#123;</span><br><span class="line">        modules: [</span><br><span class="line">            path.resolve(__dirname, &apos;loaders&apos;),</span><br><span class="line">            &apos;node_modules&apos;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    module:&#123;</span><br><span class="line">        rules:[</span><br><span class="line">            &#123;</span><br><span class="line">                test:/\.css$/,</span><br><span class="line">                use:ExtractTextWebpackPlugin.extract(&#123;</span><br><span class="line">                    use:&quot;css-loader&quot;,</span><br><span class="line">                    publicPath:&quot;../&quot;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test:/\.less$/,</span><br><span class="line">                use:[</span><br><span class="line">                    &#123;loader:&quot;style-loader&quot;&#125;,</span><br><span class="line">                    &#123;loader:&quot;css-loader&quot;&#125;,</span><br><span class="line">                    &#123;loader:&quot;less-loader&quot;&#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test:/\.(jpe?g|png|gif)$/,</span><br><span class="line">                use:[</span><br><span class="line">                    &#123;</span><br><span class="line">                        loader:&quot;url-loader&quot;,</span><br><span class="line">                        options:&#123;</span><br><span class="line">                            limit:8192,</span><br><span class="line">                            outputPath:&quot;images/&quot;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test:/\.(htm|html)$/,</span><br><span class="line">                use:&quot;html-withimg-loader&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test:/\.(eot|ttf|woff|svg)$/,</span><br><span class="line">                use:&quot;file-loader&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test:/\.js$/,</span><br><span class="line">                include:/src/,</span><br><span class="line">                exclude:/node_modules/,</span><br><span class="line">                use:&#123;</span><br><span class="line">                    loader:&quot;babel-loader&quot;,</span><br><span class="line">                    options:&#123;</span><br><span class="line">                        presets:[&quot;@babel/preset-env&quot;]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test:/\.vue$/,</span><br><span class="line">                use:&quot;vue-loader&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">		        test: /\.txt$/,</span><br><span class="line">		        use: &#123;</span><br><span class="line">		            loader:&apos;txt-loader&apos;,</span><br><span class="line">		            options:&#123;</span><br><span class="line">                       </span><br><span class="line">                    &#125;</span><br><span class="line">		        &#125;</span><br><span class="line">		      &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins:[</span><br><span class="line">        new HtmlWebpackPlugin(&#123;</span><br><span class="line">            template:&quot;./src/index.html&quot;,</span><br><span class="line">            hash:true</span><br><span class="line">        &#125;),</span><br><span class="line">        new ExtractTextWebpackPlugin(&quot;css/style.css&quot;),</span><br><span class="line">        new CleanWebpackPlugin(&quot;dist&quot;),</span><br><span class="line">        new webpack.HotModuleReplacementPlugin(),</span><br><span class="line">        new VueLoaderPlugin()</span><br><span class="line">    ],</span><br><span class="line">    devServer:&#123;</span><br><span class="line">        contentBase:&quot;./dist&quot;,</span><br><span class="line">        host:&quot;localhost&quot;,</span><br><span class="line">        port:8888,</span><br><span class="line">        open:true,</span><br><span class="line">        hot:true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="file-txt"><a href="#file-txt" class="headerlink" title="file.txt"></a>file.txt</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//file.txt</span><br><span class="line"></span><br><span class="line">123456</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import txt from &apos;./file.txt&apos;;</span><br><span class="line">console.log(txt)   //123456</span><br></pre></td></tr></table></figure>
<h3 id="写一个webpack插件："><a href="#写一个webpack插件：" class="headerlink" title="写一个webpack插件："></a>写一个webpack插件：</h3><p>主要的步骤如下:</p>
<ul>
<li>编写一个JavaScript命名函数。</li>
<li>在它的原型上定义一个apply方法。</li>
<li>指定挂载的webpack事件钩子。</li>
<li>处理webpack内部实例的特定数据。<br>  功能完成后调用webpack提供的回调。<br>  编写插件之前要理解compiler和compilation两个对象，以及webpack生命周期的各个阶段和钩子，plugin比loader强大，通过plugin你可以访问compliler和compilation过程，通过钩子拦截webpack的执行。</li>
</ul>
<p>比如我们可以在构建读取txt文件内容生成到文件名到out.txt的文件中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&apos;fs&apos;);</span><br><span class="line">var RawSource = require(&apos;webpack-core/lib/RawSource&apos;);</span><br><span class="line"></span><br><span class="line">module.exports = TestPlugin;</span><br><span class="line"></span><br><span class="line">function TestPlugin() &#123;</span><br><span class="line">	this.imports = [];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TestPlugin.prototype.apply = function(compiler) &#123;</span><br><span class="line">	var imports = this.imports;</span><br><span class="line"></span><br><span class="line">	compiler.plugin(&apos;this-compilation&apos;, function(compilation) &#123;</span><br><span class="line">		compilation.plugin(&apos;normal-module-loader&apos;, function(loaderContext, module) &#123;</span><br><span class="line">			loaderContext[__dirname] = function(file) &#123;</span><br><span class="line">				if(imports.indexOf(file) === -1) &#123;</span><br><span class="line">					imports.push(file);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	compiler.plugin(&apos;after-compile&apos;, function(compilation, callback) &#123;</span><br><span class="line">		var filename = &apos;out.txt&apos;;</span><br><span class="line">		var content = imports.map(function(file) &#123;</span><br><span class="line">			return fs.readFileSync(file);</span><br><span class="line">		&#125;).join(&apos;\n&apos;);</span><br><span class="line">		console.log(content);</span><br><span class="line">		compilation.assets[filename] = new RawSource(content);</span><br><span class="line">		callback();</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="webpack-config-js-1"><a href="#webpack-config-js-1" class="headerlink" title="webpack.config.js"></a>webpack.config.js</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">var MyPlugin = require(&apos;./plugin&apos;);</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">	entry: &apos;./index.js&apos;,</span><br><span class="line">	output: &#123;</span><br><span class="line">		filename: &apos;out.js&apos;</span><br><span class="line">	&#125;,</span><br><span class="line">	module: &#123;</span><br><span class="line">		loaders: [</span><br><span class="line">			&#123;</span><br><span class="line">				test: /\.txt$/,</span><br><span class="line">				loader: &apos;./loader&apos;,</span><br><span class="line">			&#125;</span><br><span class="line">		]</span><br><span class="line">	&#125;,</span><br><span class="line">	plugins: [</span><br><span class="line">		new MyPlugin()</span><br><span class="line">	]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="index-js"><a href="#index-js" class="headerlink" title="index.js"></a>index.js</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">require(&apos;./sample.txt&apos;);</span><br><span class="line">require(&apos;./sample2.txt&apos;);</span><br><span class="line">require(&apos;./sample3.txt&apos;);</span><br></pre></td></tr></table></figure>
<h3 id="webpack-loader—自己写一个按需加载插件"><a href="#webpack-loader—自己写一个按需加载插件" class="headerlink" title="webpack loader—自己写一个按需加载插件"></a><a href="https://juejin.im/post/5b8e3162f265da432f655639#heading-5" target="_blank" rel="noopener">webpack loader—自己写一个按需加载插件</a></h3><h3 id="webpack-之-loader-和-plugin-简介"><a href="#webpack-之-loader-和-plugin-简介" class="headerlink" title="webpack 之 loader 和 plugin 简介"></a><a href="https://juejin.im/post/5980752ef265da3e2e56e82e#heading-0" target="_blank" rel="noopener">webpack 之 loader 和 plugin 简介</a></h3><h3 id="webpack-doc"><a href="#webpack-doc" class="headerlink" title="webpack doc"></a><a href="https://webpack.js.org/contribute/writing-a-loader/" target="_blank" rel="noopener">webpack doc</a></h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/22/vue-user组件/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/22/vue-user组件/" itemprop="url">vue@user组件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-22T23:19:42+08:00">
                2018-12-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一个-user的Vue组件-仿微博聊天-user"><a href="#一个-user的Vue组件-仿微博聊天-user" class="headerlink" title="一个@user的Vue组件,仿微博聊天@user"></a>一个@user的Vue组件,仿微博聊天@user</h3><h3 id="Web聊天工具的富文本输入框"><a href="#Web聊天工具的富文本输入框" class="headerlink" title="Web聊天工具的富文本输入框"></a><a href="https://juejin.im/post/5c79f249e51d457ab52e67e1" target="_blank" rel="noopener">Web聊天工具的富文本输入框</a></h3><p><img src="/2018/12/22/vue-user组件/12.gif" alt=""></p>
<h4 id="Github地址"><a href="#Github地址" class="headerlink" title="Github地址"></a><strong><a href="https://github.com/libin1991/vue-atuser" target="_blank" rel="noopener"><font color="#dd0000">Github地址</font></a></strong></h4><blockquote>
<p>难点：</p>
<ul>
<li>获取位置，在合适的地方插入@列表</li>
<li>文本插入，找到对应的位置插入选中的文本</li>
</ul>
</blockquote>
<p><img src="/2018/12/22/vue-user组件/atuser.gif" alt=""></p>
<h4 id="Github"><a href="#Github" class="headerlink" title="Github "></a><strong><a href="https://github.com/libin1991/webpack4-vue-more-page-cli/tree/e8f64516561da1c2f00fe67716216246ba7f169f/Vue%40user%E7%BB%84%E4%BB%B6" target="_blank" rel="noopener">Github</a> </strong></h4><h3 id="获取键盘码【键盘ASCII码】"><a href="#获取键盘码【键盘ASCII码】" class="headerlink" title="获取键盘码【键盘ASCII码】"></a>获取键盘码【键盘ASCII码】</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://libs.baidu.com/jquery/2.0.0/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">				$(<span class="built_in">document</span>).keydown(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">					$(<span class="string">'span'</span>).html(e.which);</span></span><br><span class="line"><span class="undefined">				&#125;)</span></span><br><span class="line"><span class="undefined">			&#125;);</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="获取textarea输入的坐标位置-距离textarea左上角"><a href="#获取textarea输入的坐标位置-距离textarea左上角" class="headerlink" title="获取textarea输入的坐标位置,距离textarea左上角"></a>获取textarea输入的坐标位置,距离textarea左上角</h3><p><img src="/2018/12/22/vue-user组件/2.png" alt=""><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">		&lt;title&gt;<span class="xml"><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line">		&lt;script src=<span class="string">"http://libs.baidu.com/jquery/2.0.0/jquery.min.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">		&lt;style type=<span class="string">"text/css"</span>&gt;</span><br><span class="line">			* &#123;</span><br><span class="line">				padding: <span class="number">0</span>px;</span><br><span class="line">				margin: <span class="number">0</span>px;</span><br><span class="line">			&#125;</span><br><span class="line">			#main&#123;</span><br><span class="line">				width: <span class="number">200</span>px;</span><br><span class="line">				height: <span class="number">150</span>px;</span><br><span class="line">				position: relative;</span><br><span class="line">			&#125;</span><br><span class="line">			textarea &#123;</span><br><span class="line">				width: <span class="number">200</span>px;</span><br><span class="line">				height: <span class="number">150</span>px;</span><br><span class="line">				resize: none;</span><br><span class="line">				position: absolute;</span><br><span class="line">				left: <span class="number">0</span>px;</span><br><span class="line">				top: <span class="number">0</span>px;</span><br><span class="line">			&#125;</span><br><span class="line">			.test&#123;</span><br><span class="line">				width: <span class="number">5</span>px;</span><br><span class="line">				height: <span class="number">5</span>px;</span><br><span class="line">				position: absolute;</span><br><span class="line">				left: <span class="number">0</span>px;</span><br><span class="line">				top: <span class="number">0</span>px;</span><br><span class="line">				background: red;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&lt;<span class="regexp">/style&gt;</span></span><br><span class="line"><span class="regexp">		&lt;script type="text/</span>javascript<span class="string">"&gt;</span></span><br><span class="line"><span class="string">			(function() &#123;</span></span><br><span class="line"><span class="string">				var properties = [</span></span><br><span class="line"><span class="string">					'direction', // RTL support</span></span><br><span class="line"><span class="string">					'boxSizing',</span></span><br><span class="line"><span class="string">					'width', // on Chrome and IE, exclude the scrollbar, so the mirror div wraps exactly as the textarea does</span></span><br><span class="line"><span class="string">					'height',</span></span><br><span class="line"><span class="string">					'overflowX',</span></span><br><span class="line"><span class="string">					'overflowY', // copy the scrollbar for IE</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">					'borderTopWidth',</span></span><br><span class="line"><span class="string">					'borderRightWidth',</span></span><br><span class="line"><span class="string">					'borderBottomWidth',</span></span><br><span class="line"><span class="string">					'borderLeftWidth',</span></span><br><span class="line"><span class="string">					'borderStyle',</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">					'paddingTop',</span></span><br><span class="line"><span class="string">					'paddingRight',</span></span><br><span class="line"><span class="string">					'paddingBottom',</span></span><br><span class="line"><span class="string">					'paddingLeft',</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">					// https://developer.mozilla.org/en-US/docs/Web/CSS/font</span></span><br><span class="line"><span class="string">					'fontStyle',</span></span><br><span class="line"><span class="string">					'fontVariant',</span></span><br><span class="line"><span class="string">					'fontWeight',</span></span><br><span class="line"><span class="string">					'fontStretch',</span></span><br><span class="line"><span class="string">					'fontSize',</span></span><br><span class="line"><span class="string">					'fontSizeAdjust',</span></span><br><span class="line"><span class="string">					'lineHeight',</span></span><br><span class="line"><span class="string">					'fontFamily',</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">					'textAlign',</span></span><br><span class="line"><span class="string">					'textTransform',</span></span><br><span class="line"><span class="string">					'textIndent',</span></span><br><span class="line"><span class="string">					'textDecoration', // might not make a difference, but better be safe</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">					'letterSpacing',</span></span><br><span class="line"><span class="string">					'wordSpacing',</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">					'tabSize',</span></span><br><span class="line"><span class="string">					'MozTabSize'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">				];</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">				var isBrowser = (typeof window !== 'undefined');</span></span><br><span class="line"><span class="string">				var isFirefox = (isBrowser &amp;&amp; window.mozInnerScreenX != null);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">				function getCaretCoordinates(element, position, options) &#123;</span></span><br><span class="line"><span class="string">					if(!isBrowser) &#123;</span></span><br><span class="line"><span class="string">						throw new Error('textarea-caret-position#getCaretCoordinates should only be called in a browser');</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">					var debug = options &amp;&amp; options.debug || false;</span></span><br><span class="line"><span class="string">					if(debug) &#123;</span></span><br><span class="line"><span class="string">						var el = document.querySelector('#input-textarea-caret-position-mirror-div');</span></span><br><span class="line"><span class="string">						if(el) el.parentNode.removeChild(el);</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">					var div = document.createElement('div');</span></span><br><span class="line"><span class="string">					div.id = 'input-textarea-caret-position-mirror-div';</span></span><br><span class="line"><span class="string">					document.body.appendChild(div);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">					var style = div.style;</span></span><br><span class="line"><span class="string">					var computed = window.getComputedStyle ? window.getComputedStyle(element) : element.currentStyle; // currentStyle for IE &lt; 9</span></span><br><span class="line"><span class="string">					var isInput = element.nodeName === 'INPUT';</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">					style.whiteSpace = 'pre-wrap';</span></span><br><span class="line"><span class="string">					if(!isInput)</span></span><br><span class="line"><span class="string">						style.wordWrap = 'break-word'; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">					style.position = 'absolute'; </span></span><br><span class="line"><span class="string">					if(!debug)</span></span><br><span class="line"><span class="string">						style.visibility = 'hidden'; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">					properties.forEach(function(prop) &#123;</span></span><br><span class="line"><span class="string">						if(isInput &amp;&amp; prop === 'lineHeight') &#123;</span></span><br><span class="line"><span class="string">							if(computed.boxSizing === "</span>border-box<span class="string">") &#123;</span></span><br><span class="line"><span class="string">								var height = parseInt(computed.height);</span></span><br><span class="line"><span class="string">								var outerHeight =</span></span><br><span class="line"><span class="string">									parseInt(computed.paddingTop) +</span></span><br><span class="line"><span class="string">									parseInt(computed.paddingBottom) +</span></span><br><span class="line"><span class="string">									parseInt(computed.borderTopWidth) +</span></span><br><span class="line"><span class="string">									parseInt(computed.borderBottomWidth);</span></span><br><span class="line"><span class="string">								var targetHeight = outerHeight + parseInt(computed.lineHeight);</span></span><br><span class="line"><span class="string">								if(height &gt; targetHeight) &#123;</span></span><br><span class="line"><span class="string">									style.lineHeight = height - outerHeight + "</span>px<span class="string">";</span></span><br><span class="line"><span class="string">								&#125; else if(height === targetHeight) &#123;</span></span><br><span class="line"><span class="string">									style.lineHeight = computed.lineHeight;</span></span><br><span class="line"><span class="string">								&#125; else &#123;</span></span><br><span class="line"><span class="string">									style.lineHeight = 0;</span></span><br><span class="line"><span class="string">								&#125;</span></span><br><span class="line"><span class="string">							&#125; else &#123;</span></span><br><span class="line"><span class="string">								style.lineHeight = computed.height;</span></span><br><span class="line"><span class="string">							&#125;</span></span><br><span class="line"><span class="string">						&#125; else &#123;</span></span><br><span class="line"><span class="string">							style[prop] = computed[prop];</span></span><br><span class="line"><span class="string">						&#125;</span></span><br><span class="line"><span class="string">					&#125;);</span></span><br><span class="line"><span class="string">					if(isFirefox) &#123;</span></span><br><span class="line"><span class="string">						if(element.scrollHeight &gt; parseInt(computed.height))</span></span><br><span class="line"><span class="string">							style.overflowY = 'scroll';</span></span><br><span class="line"><span class="string">					&#125; else &#123;</span></span><br><span class="line"><span class="string">						style.overflow = 'hidden'; </span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string">					div.textContent = element.value.substring(0, position);</span></span><br><span class="line"><span class="string">					if(isInput)</span></span><br><span class="line"><span class="string">						div.textContent = div.textContent.replace(/\s/g, '\u00a0');</span></span><br><span class="line"><span class="string">					var span = document.createElement('span');</span></span><br><span class="line"><span class="string">					span.textContent = element.value.substring(position) || '.';</span></span><br><span class="line"><span class="string">					div.appendChild(span);</span></span><br><span class="line"><span class="string">					var coordinates = &#123;</span></span><br><span class="line"><span class="string">						top: span.offsetTop + parseInt(computed['borderTopWidth']),</span></span><br><span class="line"><span class="string">						left: span.offsetLeft + parseInt(computed['borderLeftWidth']),</span></span><br><span class="line"><span class="string">						height: parseInt(computed['lineHeight'])</span></span><br><span class="line"><span class="string">					&#125;;</span></span><br><span class="line"><span class="string">					if(debug) &#123;</span></span><br><span class="line"><span class="string">						span.style.backgroundColor = '#aaa';</span></span><br><span class="line"><span class="string">					&#125; else &#123;</span></span><br><span class="line"><span class="string">						document.body.removeChild(div);</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string">					return coordinates;</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">				if(typeof module != 'undefined' &amp;&amp; typeof module.exports != 'undefined') &#123;</span></span><br><span class="line"><span class="string">					module.exports = getCaretCoordinates;</span></span><br><span class="line"><span class="string">				&#125; else if(isBrowser) &#123;</span></span><br><span class="line"><span class="string">					window.getCaretCoordinates = getCaretCoordinates;</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;());</span></span><br><span class="line"><span class="string">		&lt;/script&gt;</span></span><br><span class="line"><span class="string">	&lt;/head&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	&lt;body&gt;</span></span><br><span class="line"><span class="string">		&lt;div id="</span>main<span class="string">"&gt;</span></span><br><span class="line"><span class="string">		   &lt;textarea cols="</span><span class="number">30</span><span class="string">" rows="</span><span class="number">10</span><span class="string">" wrap="</span>hard<span class="string">"&gt;&lt;/textarea&gt;</span></span><br><span class="line"><span class="string">			</span></span><br><span class="line"><span class="string">		   &lt;div class="</span>test<span class="string">"&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">		&lt;/div&gt;</span></span><br><span class="line"><span class="string">	&lt;/body&gt;</span></span><br><span class="line"><span class="string">	&lt;script type="</span>text/javascript<span class="string">"&gt;</span></span><br><span class="line"><span class="string">		document.querySelector('textarea').addEventListener('input', function(e) &#123;</span></span><br><span class="line"><span class="string">			console.log( e.keyCode)</span></span><br><span class="line"><span class="string">			var caret = getCaretCoordinates(this, this.selectionEnd);</span></span><br><span class="line"><span class="string">			$("</span>.test<span class="string">").css(&#123;</span></span><br><span class="line"><span class="string">				left: caret.left+'px',</span></span><br><span class="line"><span class="string">				top: caret.top+'px'</span></span><br><span class="line"><span class="string">			&#125;)</span></span><br><span class="line"><span class="string">			console.log('(top, left, height) = (%s, %s, %s)', caret.top, caret.left, caret.height);</span></span><br><span class="line"><span class="string">		&#125;)</span></span><br><span class="line"><span class="string">	&lt;/script&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="获取textarea鼠标在字符串的位置"><a href="#获取textarea鼠标在字符串的位置" class="headerlink" title="获取textarea鼠标在字符串的位置"></a>获取textarea鼠标在字符串的位置</h3><p><img src="/2018/12/22/vue-user组件/3.jpg" alt=""><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span>JS设置及获取Textarea的光标位置<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">var</span> isIE = !(!<span class="built_in">document</span>.all);  <span class="comment">//是不是IE</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="function"><span class="keyword">function</span> <span class="title">posCursor</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> start = <span class="number">0</span>,</span></span><br><span class="line"><span class="undefined">					end = 0;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> oTextarea = <span class="built_in">document</span>.getElementById(<span class="string">"textarea"</span>);</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(isIE) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="comment">//selection 当前激活选中区，即高亮文本块，和/或文当中用户可执行某些操作的其它元素。  </span></span></span><br><span class="line"><span class="javascript">					<span class="comment">//createRange 从当前文本选中区中创建 TextRange 对象，  </span></span></span><br><span class="line"><span class="javascript">					<span class="comment">//或从控件选中区中创建 controlRange 集合。  </span></span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> sTextRange = <span class="built_in">document</span>.selection.createRange();</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="comment">//判断选中的是不是textarea对象  </span></span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(sTextRange.parentElement() == oTextarea) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="comment">//创建一个TextRange对象  </span></span></span><br><span class="line"><span class="javascript">						<span class="keyword">var</span> oTextRange = <span class="built_in">document</span>.body.createTextRange();</span></span><br><span class="line"><span class="javascript">						<span class="comment">//移动文本范围以便范围的开始和结束位置能够完全包含给定元素的文本。  </span></span></span><br><span class="line"><span class="undefined">						oTextRange.moveToElementText(oTextarea);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">						<span class="comment">//此时得到两个 TextRange  </span></span></span><br><span class="line"><span class="javascript">						<span class="comment">//oTextRange文本域(textarea)中文本的TextRange对象  </span></span></span><br><span class="line"><span class="javascript">						<span class="comment">//sTextRange是选中区域文本的TextRange对象  </span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">						<span class="comment">//compareEndPoints方法介绍，compareEndPoints方法用于比较两个TextRange对象的位置  </span></span></span><br><span class="line"><span class="javascript">						<span class="comment">//StartToEnd  比较TextRange开头与参数TextRange的末尾。  </span></span></span><br><span class="line"><span class="javascript">						<span class="comment">//StartToStart比较TextRange开头与参数TextRange的开头。  </span></span></span><br><span class="line"><span class="javascript">						<span class="comment">//EndToStart  比较TextRange末尾与参数TextRange的开头。  </span></span></span><br><span class="line"><span class="javascript">						<span class="comment">//EndToEnd    比较TextRange末尾与参数TextRange的末尾。  </span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">						<span class="comment">//moveStart方法介绍，更改范围的开始位置  </span></span></span><br><span class="line"><span class="javascript">						<span class="comment">//character 按字符移动  </span></span></span><br><span class="line"><span class="javascript">						<span class="comment">//word       按单词移动  </span></span></span><br><span class="line"><span class="javascript">						<span class="comment">//sentence  按句子移动  </span></span></span><br><span class="line"><span class="javascript">						<span class="comment">//textedit  启动编辑动作  </span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">						<span class="comment">//这里我们比较oTextRange和sTextRange的开头，的到选中区域的开头位置  </span></span></span><br><span class="line"><span class="javascript">						<span class="keyword">for</span>(start = <span class="number">0</span>; oTextRange.compareEndPoints(<span class="string">"StartToStart"</span>, sTextRange) &lt; <span class="number">0</span>; start++) &#123;</span></span><br><span class="line"><span class="javascript">							oTextRange.moveStart(<span class="string">'character'</span>, <span class="number">1</span>);</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="javascript">						<span class="comment">//需要计算一下\n的数目(按字符移动的方式不计\n,所以这里加上)   </span></span></span><br><span class="line"><span class="javascript">						<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;= start; i++) &#123;</span></span><br><span class="line"><span class="javascript">							<span class="keyword">if</span>(oTextarea.value.charAt(i) == <span class="string">'\n'</span>) &#123;</span></span><br><span class="line"><span class="undefined">								start++;</span></span><br><span class="line"><span class="undefined">							&#125;</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">						<span class="comment">//再计算一次结束的位置  </span></span></span><br><span class="line"><span class="undefined">						oTextRange.moveToElementText(oTextarea);</span></span><br><span class="line"><span class="javascript">						<span class="keyword">for</span>(end = <span class="number">0</span>; oTextRange.compareEndPoints(<span class="string">'StartToEnd'</span>, sTextRange) &lt; <span class="number">0</span>; end++) &#123;</span></span><br><span class="line"><span class="javascript">							oTextRange.moveStart(<span class="string">'character'</span>, <span class="number">1</span>);</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;= end; i++) &#123;</span></span><br><span class="line"><span class="javascript">							<span class="keyword">if</span>(oTextarea.value.charAt(i) == <span class="string">'\n'</span>) &#123;</span></span><br><span class="line"><span class="undefined">								end++;</span></span><br><span class="line"><span class="undefined">							&#125;</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="javascript">				&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="undefined">					start = oTextarea.selectionStart;</span></span><br><span class="line"><span class="undefined">					end = oTextarea.selectionEnd;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="built_in">document</span>.getElementById(<span class="string">"start"</span>).value = start;</span></span><br><span class="line"><span class="javascript">				<span class="built_in">document</span>.getElementById(<span class="string">"end"</span>).value = end;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="function"><span class="keyword">function</span> <span class="title">moveCursor</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> oTextarea = <span class="built_in">document</span>.getElementById(<span class="string">"textarea"</span>);</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> start = <span class="built_in">parseInt</span>(<span class="built_in">document</span>.getElementById(<span class="string">"start"</span>).value);</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> end = <span class="built_in">parseInt</span>(<span class="built_in">document</span>.getElementById(<span class="string">"end"</span>).value);</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="built_in">isNaN</span>(start) || <span class="built_in">isNaN</span>(end)) &#123;</span></span><br><span class="line"><span class="javascript">					alert(<span class="string">"位置输入错误"</span>);</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(isIE) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> oTextRange = oTextarea.createTextRange();</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> LStart = start;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> LEnd = end;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> start = <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> end = <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> value = oTextarea.value;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; value.length &amp;&amp; i &lt; LStart; i++) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">var</span> c = value.charAt(i);</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(c != <span class="string">'\n'</span>) &#123;</span></span><br><span class="line"><span class="undefined">							start++;</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">for</span>(<span class="keyword">var</span> i = value.length - <span class="number">1</span>; i &gt;= LEnd &amp;&amp; i &gt;= <span class="number">0</span>; i--) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">var</span> c = value.charAt(i);</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(c != <span class="string">'\n'</span>) &#123;</span></span><br><span class="line"><span class="undefined">							end++;</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="javascript">					oTextRange.moveStart(<span class="string">'character'</span>, start);</span></span><br><span class="line"><span class="javascript">					oTextRange.moveEnd(<span class="string">'character'</span>, -end);</span></span><br><span class="line"><span class="javascript">					<span class="comment">//oTextRange.collapse(true);  </span></span></span><br><span class="line"><span class="undefined">					oTextRange.select();</span></span><br><span class="line"><span class="undefined">					oTextarea.focus();</span></span><br><span class="line"><span class="javascript">				&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="undefined">					oTextarea.select();</span></span><br><span class="line"><span class="undefined">					oTextarea.selectionStart = start;</span></span><br><span class="line"><span class="undefined">					oTextarea.selectionEnd = end;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">"1"</span> <span class="attr">cellspacing</span>=<span class="string">"0"</span> <span class="attr">cellpadding</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">td</span>&gt;</span>start: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"start"</span> <span class="attr">size</span>=<span class="string">"3"</span> <span class="attr">value</span>=<span class="string">"0"</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">td</span>&gt;</span>end: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"end"</span> <span class="attr">size</span>=<span class="string">"3"</span> <span class="attr">value</span>=<span class="string">"0"</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">"2"</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">"textarea"</span> </span></span><br><span class="line"><span class="tag">							<span class="attr">onKeydown</span>=<span class="string">"posCursor()"</span> </span></span><br><span class="line"><span class="tag">							<span class="attr">onKeyup</span>=<span class="string">"posCursor()"</span> </span></span><br><span class="line"><span class="tag">							<span class="attr">onmousedown</span>=<span class="string">"posCursor()"</span> </span></span><br><span class="line"><span class="tag">							<span class="attr">onmouseup</span>=<span class="string">"posCursor()"</span> </span></span><br><span class="line"><span class="tag">							<span class="attr">onfocus</span>=<span class="string">"posCursor()"</span> </span></span><br><span class="line"><span class="tag">							<span class="attr">rows</span>=<span class="string">"14"</span> </span></span><br><span class="line"><span class="tag">							<span class="attr">cols</span>=<span class="string">"50"</span>&gt;</span>虞美人  </span><br><span class="line">							春花秋月何时了，往事知多少。  </span><br><span class="line">							小楼昨夜又东风，故国不堪回首月明中！  </span><br><span class="line">							雕l栏玉砌应犹在，只是朱颜改。  </span><br><span class="line">							问君能有几多愁？恰似一江春水向东流。</span><br><span class="line">						<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onClick</span>=<span class="string">"moveCursor()"</span> <span class="attr">value</span>=<span class="string">"设置光标位置"</span> /&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><blockquote>
<p>App.js 入口文件</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">at</span> <span class="attr">:members</span>=<span class="string">"members"</span> <span class="attr">name-key</span>=<span class="string">"name"</span> <span class="attr">v-model</span>=<span class="string">"html"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">&lt;!--&lt;template slot="item" scope="s"&gt;</span></span><br><span class="line"><span class="comment">				&lt;span v-text="s.item.name"&gt;&lt;/span&gt;   </span></span><br><span class="line"><span class="comment">			&lt;/template&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">			<span class="tag">&lt;<span class="name">template</span> <span class="attr">slot</span>=<span class="string">"embeddedItem"</span> <span class="attr">slot-scope</span>=<span class="string">"s"</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">a</span> <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">:href</span>=<span class="string">"s.current.avatar"</span> <span class="attr">class</span>=<span class="string">"tag"</span>&gt;</span>@&#123;&#123; s.current.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line">			<span class="tag">&lt;<span class="name">template</span> <span class="attr">slot</span>=<span class="string">"item"</span> <span class="attr">slot-scope</span>=<span class="string">"s"</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">span</span> <span class="attr">v-text</span>=<span class="string">"s.item.name"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"editor"</span> <span class="attr">contenteditable</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">at</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">	<span class="keyword">import</span> At <span class="keyword">from</span> <span class="string">'./At.vue'</span></span></span><br><span class="line"><span class="javascript">	<span class="keyword">let</span> members = [<span class="string">"小明"</span>, <span class="string">"小花"</span>, <span class="string">"小浩"</span>, <span class="string">"小刚"</span>, <span class="string">"小龙"</span>, <span class="string">"小木"</span>, <span class="string">"小三"</span>];</span></span><br><span class="line"><span class="javascript">	members = members.map(<span class="function">(<span class="params">v, i</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">		<span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">			avatar: <span class="string">'https://weibo.com'</span>,</span></span><br><span class="line"><span class="undefined">			name: v</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="undefined">	&#125;)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">	<span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="undefined">		components: &#123;</span></span><br><span class="line"><span class="undefined">			At</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="javascript">		name: <span class="string">'app'</span>,</span></span><br><span class="line"><span class="undefined">		data() &#123;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="undefined">				members,</span></span><br><span class="line"><span class="xml">				html: ''//`<span class="tag">&lt;<span class="name">div</span>&gt;</span>深度学习模型训练的过程本质是对weight（即参数W）进行更新，这需要每个参数有相应的初始值。<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span>对一些简单的机器学习模型，或当optimization function是convex function时. <span class="tag">&lt;/<span class="name">div</span>&gt;</span>`</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">	* &#123;</span></span><br><span class="line"><span class="undefined">		padding: 0px;</span></span><br><span class="line"><span class="undefined">		margin: 0px;</span></span><br><span class="line"><span class="undefined">		border: 0px;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined">	</span></span><br><span class="line"><span class="undefined">	li &#123;</span></span><br><span class="line"><span class="undefined">		list-style: none;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined">	</span></span><br><span class="line"><span class="undefined">	ul,</span></span><br><span class="line"><span class="undefined">	ol &#123;</span></span><br><span class="line"><span class="undefined">		list-style-type: none;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined">	</span></span><br><span class="line"><span class="undefined">	select,</span></span><br><span class="line"><span class="undefined">	input,</span></span><br><span class="line"><span class="undefined">	img,</span></span><br><span class="line"><span class="undefined">	select &#123;</span></span><br><span class="line"><span class="undefined">		vertical-align: middle;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined">	</span></span><br><span class="line"><span class="undefined">	img &#123;</span></span><br><span class="line"><span class="undefined">		border: none;</span></span><br><span class="line"><span class="undefined">		display: inline-block</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined">	</span></span><br><span class="line"><span class="undefined">	i &#123;</span></span><br><span class="line"><span class="undefined">		font-style: normal</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined">	</span></span><br><span class="line"><span class="undefined">	a &#123;</span></span><br><span class="line"><span class="undefined">		text-decoration: none;</span></span><br><span class="line"><span class="undefined">		-webkit-appearance: none;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="css">	 <span class="selector-id">#app</span>&#123;</span></span><br><span class="line"><span class="undefined">	 	margin-top: 0px;</span></span><br><span class="line"><span class="undefined">	 &#125;</span></span><br><span class="line"><span class="css">	<span class="selector-class">.editor</span> &#123;</span></span><br><span class="line"><span class="undefined">		</span></span><br><span class="line"><span class="undefined">		width: 400px;</span></span><br><span class="line"><span class="undefined">		height: 200px;</span></span><br><span class="line"><span class="undefined">		overflow: auto;</span></span><br><span class="line"><span class="undefined">		</span></span><br><span class="line"><span class="undefined">		white-space: pre-wrap;</span></span><br><span class="line"><span class="css">		<span class="selector-tag">border</span>: <span class="selector-tag">solid</span> 1<span class="selector-tag">px</span> <span class="selector-tag">rgba</span>(0, 0, 0, <span class="selector-class">.5</span>);</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>At.vue</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">"wrap"</span> <span class="attr">class</span>=<span class="string">"atwho-wrap"</span> @<span class="attr">input</span>=<span class="string">"handleInput()"</span> @<span class="attr">keydown</span>=<span class="string">"handleKeyDown"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"atwho"</span> <span class="attr">class</span>=<span class="string">"atwho-panel"</span> <span class="attr">:style</span>=<span class="string">"style"</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"atwho-view atwho-ul"</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">"(item, index) in atwho.list"</span> </span></span><br><span class="line"><span class="tag">							<span class="attr">class</span>=<span class="string">"atwho-li"</span> </span></span><br><span class="line"><span class="tag">							<span class="attr">:key</span>=<span class="string">"index"</span> </span></span><br><span class="line"><span class="tag">							<span class="attr">:class</span>=<span class="string">"isCur(index) &amp;&amp; 'atwho-cur'"</span> </span></span><br><span class="line"><span class="tag">							<span class="attr">:ref</span>=<span class="string">"isCur(index) &amp;&amp; 'cur'"</span> </span></span><br><span class="line"><span class="tag">							<span class="attr">:data-index</span>=<span class="string">"index"</span> </span></span><br><span class="line"><span class="tag">							@<span class="attr">mouseenter</span>=<span class="string">"handleItemHover"</span> </span></span><br><span class="line"><span class="tag">							@<span class="attr">click</span>=<span class="string">"handleItemClick"</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">slot</span> <span class="attr">name</span>=<span class="string">"item"</span> <span class="attr">:item</span>=<span class="string">"item"</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">span</span> <span class="attr">v-text</span>=<span class="string">"itemName(item)"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">span</span>&gt;</span>展开更多群成员<span class="tag">&lt;/<span class="name">span</span>&gt;</span> </span><br><span class="line">							<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTQ1NDgyNjY3NzY4IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEwODYiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTMzNi43MzMgMTE5LjY2N2wtNTYuMjc4IDU1LjcyIDMzNC44NTcgMzM3LjE1NC0zMzcuNjczIDMzNC4zMTUgNTUuODAyIDU2LjE4NCAzOTMuOTQ0LTM5MC4wNDB6IiBwLWlkPSIxMDg3Ij48L3BhdGg+PC9zdmc+"</span>/&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">span</span> <span class="attr">v-show</span>=<span class="string">"false"</span> <span class="attr">ref</span>=<span class="string">"embeddedItem"</span>&gt;</span></span><br><span class="line">		    <span class="tag">&lt;<span class="name">slot</span> <span class="attr">name</span>=<span class="string">"embeddedItem"</span> <span class="attr">:current</span>=<span class="string">"currentItem"</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">slot</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">	<span class="keyword">import</span> &#123;</span></span><br><span class="line"><span class="undefined">		closest,</span></span><br><span class="line"><span class="undefined">		getOffset,</span></span><br><span class="line"><span class="undefined">		getPrecedingRange,</span></span><br><span class="line"><span class="undefined">		getRange,</span></span><br><span class="line"><span class="undefined">		applyRange,</span></span><br><span class="line"><span class="undefined">		scrollIntoView,</span></span><br><span class="line"><span class="undefined">		getAtAndIndex</span></span><br><span class="line"><span class="javascript">	&#125; <span class="keyword">from</span> <span class="string">'./util'</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">	<span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="undefined">		props: &#123;</span></span><br><span class="line"><span class="undefined">			value: &#123;</span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">String</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="literal">null</span></span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			at: &#123;</span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">String</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="literal">null</span></span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			ats: &#123;</span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">Array</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="function"><span class="params">()</span> =&gt;</span> [<span class="string">'@'</span>]</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="javascript">			suffix: &#123; <span class="comment">//插入字符链接</span></span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">String</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="string">' '</span></span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			loop: &#123;</span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">Boolean</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="literal">true</span></span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			allowSpaces: &#123;</span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">Boolean</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="literal">true</span></span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			tabSelect: &#123;</span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">Boolean</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="literal">false</span></span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			avoidEmail: &#123;</span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">Boolean</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="literal">true</span></span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			hoverSelect: &#123;</span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">Boolean</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="literal">true</span></span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			members: &#123;</span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">Array</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="function"><span class="params">()</span> =&gt;</span> []</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			nameKey: &#123;</span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">String</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="string">''</span></span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			filterMatch: &#123;</span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">Function</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="function">(<span class="params">name, chunk, at</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">return</span> name.toLowerCase()</span></span><br><span class="line"><span class="undefined">						.indexOf(chunk.toLowerCase()) &gt; -1</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			deleteMatch: &#123;</span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">Function</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="function">(<span class="params">name, chunk, suffix</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">return</span> chunk === name + suffix</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">		data() &#123;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">				bindsValue: <span class="keyword">this</span>.value != <span class="literal">null</span>,</span></span><br><span class="line"><span class="javascript">				customsEmbedded: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">				atwho: <span class="literal">null</span></span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="undefined">		computed: &#123;</span></span><br><span class="line"><span class="undefined">			atItems() &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">return</span> <span class="keyword">this</span>.at ? [<span class="keyword">this</span>.at] : <span class="keyword">this</span>.ats</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">			currentItem() &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.atwho) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">return</span> <span class="keyword">this</span>.atwho.list[<span class="keyword">this</span>.atwho.cur];</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">return</span> <span class="string">''</span>;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">			style() &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.atwho) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> &#123;</span></span><br><span class="line"><span class="undefined">						list,</span></span><br><span class="line"><span class="undefined">						cur,</span></span><br><span class="line"><span class="undefined">						x,</span></span><br><span class="line"><span class="undefined">						y</span></span><br><span class="line"><span class="javascript">					&#125; = <span class="keyword">this</span>.atwho</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> &#123;</span></span><br><span class="line"><span class="undefined">						wrap</span></span><br><span class="line"><span class="javascript">					&#125; = <span class="keyword">this</span>.$refs</span></span><br><span class="line"><span class="undefined">             </span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(wrap) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">const</span> offset = getOffset(wrap)</span></span><br><span class="line"><span class="javascript">						<span class="keyword">const</span> left = x + <span class="string">'px'</span></span></span><br><span class="line"><span class="javascript">						<span class="keyword">const</span> top = y + <span class="number">25</span>+ <span class="string">'px'</span>   <span class="comment">//25是行高</span></span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="undefined">							left,</span></span><br><span class="line"><span class="undefined">							top</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">return</span> <span class="literal">null</span></span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="undefined">		watch: &#123;</span></span><br><span class="line"><span class="javascript">			<span class="string">'atwho.cur'</span> (index) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(index != <span class="literal">null</span>) &#123; <span class="comment">// cur index exists</span></span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.scrollToCur()</span></span><br><span class="line"><span class="undefined">					&#125;)</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			members() &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.handleInput(<span class="literal">true</span>)</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			value(value, oldValue) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.bindsValue) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.handleValueUpdate(value)</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="undefined">		mounted() &#123;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">if</span>(<span class="keyword">this</span>.$scopedSlots.embeddedItem) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.customsEmbedded = <span class="literal">true</span></span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">if</span>(<span class="keyword">this</span>.bindsValue) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.handleValueUpdate(<span class="keyword">this</span>.value)</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;,</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">		methods: &#123;</span></span><br><span class="line"><span class="undefined">			itemName(v) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> &#123;</span></span><br><span class="line"><span class="undefined">					nameKey</span></span><br><span class="line"><span class="javascript">				&#125; = <span class="keyword">this</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">return</span> nameKey ? v[nameKey] : v</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			isCur(index) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">return</span> index === <span class="keyword">this</span>.atwho.cur</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			handleValueUpdate(value) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> el = <span class="keyword">this</span>.$el.querySelector(<span class="string">'[contenteditable]'</span>)</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(value !== el.innerHTML) &#123;</span></span><br><span class="line"><span class="undefined">					el.innerHTML = value</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">			handleItemHover(e) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.hoverSelect) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.selectByMouse(e)</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			handleItemClick(e) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.selectByMouse(e)</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.insertItem()</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			handleDelete(e) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> range = getPrecedingRange()</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(range) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="keyword">this</span>.customsEmbedded &amp;&amp; range.endOffset &gt;= <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">let</span> a = range.endContainer.childNodes[range.endOffset] ||</span></span><br><span class="line"><span class="undefined">							range.endContainer.childNodes[range.endOffset - 1]</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(!a || a.nodeType === Node.TEXT_NODE &amp;&amp; !<span class="regexp">/^\s?$/</span>.test(a.data)) &#123;</span></span><br><span class="line"><span class="javascript">							<span class="keyword">return</span></span></span><br><span class="line"><span class="javascript">						&#125; <span class="keyword">else</span> <span class="keyword">if</span>(a.nodeType === Node.TEXT_NODE) &#123;</span></span><br><span class="line"><span class="javascript">							<span class="keyword">if</span>(a.previousSibling) a = a.previousSibling</span></span><br><span class="line"><span class="javascript">						&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">							<span class="keyword">if</span>(a.previousElementSibling) a = a.previousElementSibling</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">let</span> ch = [].slice.call(a.childNodes)</span></span><br><span class="line"><span class="undefined">						ch = [].reverse.call(ch)</span></span><br><span class="line"><span class="undefined">						ch.unshift(a)</span></span><br><span class="line"><span class="javascript">						<span class="keyword">let</span> last;</span></span><br><span class="line"><span class="undefined">						[].some.call(ch, c =&gt; &#123;</span></span><br><span class="line"><span class="javascript">							<span class="keyword">if</span>(c.getAttribute &amp;&amp; c.getAttribute(<span class="string">'data-at-embedded'</span>) != <span class="literal">null</span>) &#123;</span></span><br><span class="line"><span class="undefined">								last = c</span></span><br><span class="line"><span class="javascript">								<span class="keyword">return</span> <span class="literal">true</span></span></span><br><span class="line"><span class="undefined">							&#125;</span></span><br><span class="line"><span class="undefined">						&#125;)</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(last) &#123;</span></span><br><span class="line"><span class="undefined">							e.preventDefault()</span></span><br><span class="line"><span class="undefined">							e.stopPropagation()</span></span><br><span class="line"><span class="javascript">							<span class="keyword">const</span> r = getRange()</span></span><br><span class="line"><span class="javascript">							<span class="keyword">if</span>(r) &#123;</span></span><br><span class="line"><span class="undefined">								r.setStartBefore(last)</span></span><br><span class="line"><span class="undefined">								r.deleteContents()</span></span><br><span class="line"><span class="undefined">								applyRange(r)</span></span><br><span class="line"><span class="javascript">								<span class="keyword">this</span>.handleInput()</span></span><br><span class="line"><span class="undefined">							&#125;</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span></span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> &#123;</span></span><br><span class="line"><span class="undefined">						atItems,</span></span><br><span class="line"><span class="undefined">						members,</span></span><br><span class="line"><span class="undefined">						suffix,</span></span><br><span class="line"><span class="undefined">						deleteMatch,</span></span><br><span class="line"><span class="undefined">						itemName</span></span><br><span class="line"><span class="javascript">					&#125; = <span class="keyword">this</span></span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> text = range.toString()</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> &#123;</span></span><br><span class="line"><span class="undefined">						at,</span></span><br><span class="line"><span class="undefined">						index</span></span><br><span class="line"><span class="undefined">					&#125; = getAtAndIndex(text, atItems)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(index &gt; <span class="number">-1</span>) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">const</span> chunk = text.slice(index + at.length)</span></span><br><span class="line"><span class="javascript">						<span class="keyword">const</span> has = members.some(<span class="function"><span class="params">v</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">							<span class="keyword">const</span> name = itemName(v)</span></span><br><span class="line"><span class="javascript">							<span class="keyword">return</span> deleteMatch(name, chunk, suffix)</span></span><br><span class="line"><span class="undefined">						&#125;)</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(has) &#123;</span></span><br><span class="line"><span class="undefined">							e.preventDefault()</span></span><br><span class="line"><span class="undefined">							e.stopPropagation()</span></span><br><span class="line"><span class="javascript">							<span class="keyword">const</span> r = getRange()</span></span><br><span class="line"><span class="javascript">							<span class="keyword">if</span>(r) &#123;</span></span><br><span class="line"><span class="undefined">								r.setStart(r.endContainer, index)</span></span><br><span class="line"><span class="undefined">								r.deleteContents()</span></span><br><span class="line"><span class="undefined">								applyRange(r)</span></span><br><span class="line"><span class="javascript">								<span class="keyword">this</span>.handleInput()</span></span><br><span class="line"><span class="undefined">							&#125;</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			handleKeyDown(e) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> &#123;</span></span><br><span class="line"><span class="undefined">					atwho</span></span><br><span class="line"><span class="javascript">				&#125; = <span class="keyword">this</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(atwho) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(e.keyCode === <span class="number">38</span> || e.keyCode === <span class="number">40</span>) &#123; <span class="comment">// ↑/↓</span></span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(!(e.metaKey || e.ctrlKey)) &#123;</span></span><br><span class="line"><span class="undefined">							e.preventDefault()</span></span><br><span class="line"><span class="undefined">							e.stopPropagation()</span></span><br><span class="line"><span class="javascript">							<span class="keyword">this</span>.selectByKeyboard(e)</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span></span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(e.keyCode === <span class="number">13</span> || (<span class="keyword">this</span>.tabSelect &amp;&amp; e.keyCode === <span class="number">9</span>)) &#123; <span class="comment">// enter or tab</span></span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.insertItem()</span></span><br><span class="line"><span class="undefined">						e.preventDefault()</span></span><br><span class="line"><span class="undefined">						e.stopPropagation()</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span></span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(e.keyCode === <span class="number">27</span>) &#123; <span class="comment">// esc</span></span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.closePanel()</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span></span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="comment">// 为了兼容ie ie9~11 editable无input事件 只能靠keydown触发 textarea正常</span></span></span><br><span class="line"><span class="javascript">				<span class="comment">// 另 ie9 textarea的delete不触发input</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> isValid = e.keyCode &gt;= <span class="number">48</span> &amp;&amp; e.keyCode &lt;= <span class="number">90</span> || e.keyCode === <span class="number">8</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(isValid) &#123;</span></span><br><span class="line"><span class="javascript">					setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.handleInput()</span></span><br><span class="line"><span class="undefined">					&#125;, 50)</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(e.keyCode === <span class="number">8</span>) &#123; <span class="comment">//删除</span></span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.handleDelete(e)</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">			handleInput(keep) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> el = <span class="keyword">this</span>.$el.querySelector(<span class="string">'[contenteditable]'</span>)</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.$emit(<span class="string">'input'</span>, el.innerHTML)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> range = getPrecedingRange()</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(range) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> &#123;</span></span><br><span class="line"><span class="undefined">						atItems,</span></span><br><span class="line"><span class="undefined">						avoidEmail,</span></span><br><span class="line"><span class="undefined">						allowSpaces</span></span><br><span class="line"><span class="javascript">					&#125; = <span class="keyword">this</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">let</span> show = <span class="literal">true</span></span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> text = range.toString()</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> &#123;</span></span><br><span class="line"><span class="undefined">						at,</span></span><br><span class="line"><span class="undefined">						index</span></span><br><span class="line"><span class="undefined">					&#125; = getAtAndIndex(text, atItems)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(index &lt; <span class="number">0</span>) show = <span class="literal">false</span></span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> prev = text[index - <span class="number">1</span>]</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> chunk = text.slice(index + at.length, text.length)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(avoidEmail) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="comment">// 上一个字符不能为字母数字 避免与邮箱冲突</span></span></span><br><span class="line"><span class="javascript">						<span class="comment">// 微信则是避免 所有字母数字及半角符号</span></span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(<span class="regexp">/^[a-z0-9]$/i</span>.test(prev)) show = <span class="literal">false</span></span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(!allowSpaces &amp;&amp; <span class="regexp">/\s/</span>.test(chunk)) &#123;</span></span><br><span class="line"><span class="javascript">						show = <span class="literal">false</span></span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="comment">// chunk以空白字符开头不匹配 避免`@ `也匹配</span></span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="regexp">/^\s/</span>.test(chunk)) show = <span class="literal">false</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(!show) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.closePanel()</span></span><br><span class="line"><span class="javascript">					&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">const</span> &#123;</span></span><br><span class="line"><span class="undefined">							members,</span></span><br><span class="line"><span class="undefined">							filterMatch,</span></span><br><span class="line"><span class="undefined">							itemName</span></span><br><span class="line"><span class="javascript">						&#125; = <span class="keyword">this</span></span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(!keep &amp;&amp; chunk) &#123; <span class="comment">// fixme: should be consistent with AtTextarea.vue</span></span></span><br><span class="line"><span class="javascript">							<span class="keyword">this</span>.$emit(<span class="string">'at'</span>, chunk)</span></span><br><span class="line"><span class="javascript">							<span class="built_in">console</span>.log(<span class="string">'at'</span>,chunk);</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">const</span> matched = members.filter(<span class="function"><span class="params">v</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">							<span class="keyword">const</span> name = itemName(v)</span></span><br><span class="line"><span class="javascript">							<span class="keyword">return</span> filterMatch(name, chunk, at)</span></span><br><span class="line"><span class="undefined">						&#125;)</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(matched.length) &#123;</span></span><br><span class="line"><span class="javascript">							<span class="keyword">this</span>.openPanel(matched, range, index, at)</span></span><br><span class="line"><span class="javascript">						&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">							<span class="keyword">this</span>.closePanel()</span></span><br><span class="line"><span class="undefined">						&#125;</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">			closePanel() &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.atwho) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.atwho = <span class="literal">null</span></span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			openPanel(list, range, offset, at) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> fn = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> r = range.cloneRange()</span></span><br><span class="line"><span class="javascript">					r.setStart(r.endContainer, offset + at.length) <span class="comment">// 从@后第一位开始</span></span></span><br><span class="line"><span class="javascript">					<span class="comment">// todo: 根据窗口空间 判断向上或是向下展开</span></span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> rect = r.getClientRects()[<span class="number">0</span>]</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.atwho = &#123;</span></span><br><span class="line"><span class="undefined">						range,</span></span><br><span class="line"><span class="undefined">						offset,</span></span><br><span class="line"><span class="undefined">						list,</span></span><br><span class="line"><span class="undefined">						x: rect.left,</span></span><br><span class="line"><span class="undefined">						y: rect.top-5,</span></span><br><span class="line"><span class="javascript">						cur: <span class="number">0</span> <span class="comment">// todo: 尽可能记录</span></span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.atwho) &#123;</span></span><br><span class="line"><span class="undefined">					fn()</span></span><br><span class="line"><span class="javascript">				&#125; <span class="keyword">else</span> &#123; <span class="comment">// 焦点超出了显示区域 需要提供延时以移动指针 再计算位置</span></span></span><br><span class="line"><span class="undefined">					setTimeout(fn, 10)</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">			scrollToCur() &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> curEl = <span class="keyword">this</span>.$refs.cur[<span class="number">0</span>]</span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> scrollParent = curEl.parentElement.parentElement</span></span><br><span class="line"><span class="undefined">				scrollIntoView(curEl, scrollParent)</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			selectByMouse(e) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> el = closest(e.target, d =&gt; &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">return</span> d.getAttribute(<span class="string">'data-index'</span>)</span></span><br><span class="line"><span class="undefined">				&#125;)</span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> cur = +el.getAttribute(<span class="string">'data-index'</span>)</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.atwho = &#123;</span></span><br><span class="line"><span class="undefined">					...this.atwho,</span></span><br><span class="line"><span class="undefined">					cur</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			selectByKeyboard(e) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> offset = e.keyCode === <span class="number">38</span> ? <span class="number">-1</span> : <span class="number">1</span>  </span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> &#123;</span></span><br><span class="line"><span class="undefined">					cur,</span></span><br><span class="line"><span class="undefined">					list</span></span><br><span class="line"><span class="javascript">				&#125; = <span class="keyword">this</span>.atwho</span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> nextCur = <span class="keyword">this</span>.loop ?</span></span><br><span class="line"><span class="undefined">					(cur + offset + list.length) % list.length :</span></span><br><span class="line"><span class="javascript">					<span class="built_in">Math</span>.max(<span class="number">0</span>, <span class="built_in">Math</span>.min(cur + offset, list.length - <span class="number">1</span>))</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.atwho = &#123;</span></span><br><span class="line"><span class="undefined">					...this.atwho,</span></span><br><span class="line"><span class="undefined">					cur: nextCur</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="comment">// todo: 抽离成库并测试</span></span></span><br><span class="line"><span class="undefined">			insertText(text, r) &#123;</span></span><br><span class="line"><span class="undefined">				r.deleteContents()</span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> node = r.endContainer</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(node.nodeType === Node.TEXT_NODE) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> cut = r.endOffset</span></span><br><span class="line"><span class="undefined">					node.data = node.data.slice(0, cut) +</span></span><br><span class="line"><span class="undefined">						text + node.data.slice(cut)</span></span><br><span class="line"><span class="undefined">					r.setEnd(node, cut + text.length)</span></span><br><span class="line"><span class="javascript">				&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> t = <span class="built_in">document</span>.createTextNode(text)</span></span><br><span class="line"><span class="undefined">					r.insertNode(t)</span></span><br><span class="line"><span class="undefined">					r.setEndAfter(t)</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				r.collapse(<span class="literal">false</span>) <span class="comment">// 参数在IE下必传</span></span></span><br><span class="line"><span class="undefined">				applyRange(r)</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">			insertHtml(html, r) &#123;</span></span><br><span class="line"><span class="undefined">				r.deleteContents()</span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> node = r.endContainer</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> newElement = <span class="built_in">document</span>.createElement(<span class="string">'span'</span>)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				newElement.appendChild(<span class="built_in">document</span>.createTextNode(<span class="string">' '</span>))</span></span><br><span class="line"><span class="javascript">				newElement.appendChild(<span class="keyword">this</span>.htmlToElement(html))</span></span><br><span class="line"><span class="javascript">				newElement.appendChild(<span class="built_in">document</span>.createTextNode(<span class="string">' '</span>))</span></span><br><span class="line"><span class="javascript">				newElement.setAttribute(<span class="string">'data-at-embedded'</span>, <span class="string">''</span>)</span></span><br><span class="line"><span class="javascript">				newElement.setAttribute(<span class="string">"contenteditable"</span>, <span class="literal">false</span>)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(node.nodeType === Node.TEXT_NODE) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> cut = r.endOffset</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> secondPart = node.splitText(cut);</span></span><br><span class="line"><span class="undefined">					node.parentNode.insertBefore(newElement, secondPart);</span></span><br><span class="line"><span class="undefined">					r.setEndBefore(secondPart)</span></span><br><span class="line"><span class="javascript">				&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> t = <span class="built_in">document</span>.createTextNode(suffix)</span></span><br><span class="line"><span class="undefined">					r.insertNode(newElement)</span></span><br><span class="line"><span class="undefined">					r.setEndAfter(newElement)</span></span><br><span class="line"><span class="undefined">					r.insertNode(t)</span></span><br><span class="line"><span class="undefined">					r.setEndAfter(t)</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				r.collapse(<span class="literal">false</span>) <span class="comment">// 参数在IE下必传</span></span></span><br><span class="line"><span class="undefined">				applyRange(r)</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">			insertItem() &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> &#123;</span></span><br><span class="line"><span class="undefined">					range,</span></span><br><span class="line"><span class="undefined">					offset,</span></span><br><span class="line"><span class="undefined">					list,</span></span><br><span class="line"><span class="undefined">					cur</span></span><br><span class="line"><span class="javascript">				&#125; = <span class="keyword">this</span>.atwho</span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> &#123;</span></span><br><span class="line"><span class="undefined">					suffix,</span></span><br><span class="line"><span class="undefined">					atItems,</span></span><br><span class="line"><span class="undefined">					itemName,</span></span><br><span class="line"><span class="undefined">					customsEmbedded</span></span><br><span class="line"><span class="javascript">				&#125; = <span class="keyword">this</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> r = range.cloneRange()</span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> text = range.toString()</span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> &#123;</span></span><br><span class="line"><span class="undefined">					at,</span></span><br><span class="line"><span class="undefined">					index</span></span><br><span class="line"><span class="undefined">				&#125; = getAtAndIndex(text, atItems)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> start = customsEmbedded ? index : index + at.length</span></span><br><span class="line"><span class="undefined">				r.setStart(r.endContainer, start)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="comment">// hack: 连续两次 可以确保click后 focus回来 range真正生效</span></span></span><br><span class="line"><span class="undefined">				applyRange(r)</span></span><br><span class="line"><span class="undefined">				applyRange(r)</span></span><br><span class="line"><span class="javascript">				<span class="keyword">const</span> curItem = list[cur]</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(customsEmbedded) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> html = <span class="keyword">this</span>.$refs.embeddedItem.innerHTML</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.insertHtml(html, r);</span></span><br><span class="line"><span class="javascript">				&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> t = itemName(curItem) + suffix</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.insertText(t, r);</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.$emit(<span class="string">'insert'</span>, curItem)</span></span><br><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'insert'</span>, curItem);</span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.handleInput()</span></span><br><span class="line"><span class="undefined">			&#125;,</span></span><br><span class="line"><span class="undefined">			htmlToElement(html) &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> template = <span class="built_in">document</span>.createElement(<span class="string">'template'</span>);</span></span><br><span class="line"><span class="javascript">				html = html.trim(); <span class="comment">// Never return a text node of whitespace as the result</span></span></span><br><span class="line"><span class="undefined">				template.innerHTML = html;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">return</span> template.content.firstChild;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">"less"</span> <span class="attr">scoped</span>=<span class="string">"scoped"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">	<span class="selector-class">.atwho-wrap</span> &#123;</span></span><br><span class="line"><span class="undefined">		font-size: 12px;</span></span><br><span class="line"><span class="css">		<span class="selector-tag">color</span>: <span class="selector-id">#333</span>;</span></span><br><span class="line"><span class="undefined">		position: relative;</span></span><br><span class="line"><span class="css">		<span class="selector-class">.atwho-panel</span> &#123;</span></span><br><span class="line"><span class="undefined">			position: absolute;</span></span><br><span class="line"><span class="css">			&amp;<span class="selector-class">.test</span>&#123;</span></span><br><span class="line"><span class="undefined">				width: 2px;</span></span><br><span class="line"><span class="undefined">				height: 2px;</span></span><br><span class="line"><span class="undefined">				background: red;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="css">			<span class="selector-class">.atwho-inner</span> &#123;</span></span><br><span class="line"><span class="undefined">				position: relative;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="css">		<span class="selector-class">.atwho-view</span> &#123;</span></span><br><span class="line"><span class="undefined">			color: black;</span></span><br><span class="line"><span class="undefined">			z-index: 11110 !important;</span></span><br><span class="line"><span class="undefined">			border-radius: 2px;</span></span><br><span class="line"><span class="css">			<span class="selector-tag">box-shadow</span>: 0 0 10<span class="selector-tag">px</span> 0 <span class="selector-tag">rgba</span>(101, 111, 122, <span class="selector-class">.5</span>);</span></span><br><span class="line"><span class="undefined">			position: absolute;</span></span><br><span class="line"><span class="undefined">			cursor: pointer;</span></span><br><span class="line"><span class="css">			<span class="selector-tag">background-color</span>: <span class="selector-tag">rgba</span>(255, 255, 255, <span class="selector-class">.94</span>);</span></span><br><span class="line"><span class="undefined">			width: 170px;</span></span><br><span class="line"><span class="undefined">			max-height: 312px;</span></span><br><span class="line"><span class="css">			&amp;<span class="selector-pseudo">::-webkit-scrollbar</span> &#123;</span></span><br><span class="line"><span class="undefined">				width: 11px;</span></span><br><span class="line"><span class="undefined">				height: 11px;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="css">			&amp;<span class="selector-pseudo">::-webkit-scrollbar-track</span> &#123;</span></span><br><span class="line"><span class="css">				<span class="selector-tag">background-color</span>: <span class="selector-id">#F5F5F5</span>;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="css">			&amp;<span class="selector-pseudo">::-webkit-scrollbar-thumb</span> &#123;</span></span><br><span class="line"><span class="undefined">				min-height: 36px;</span></span><br><span class="line"><span class="undefined">				border: 2px solid transparent;</span></span><br><span class="line"><span class="undefined">				border-top: 3px solid transparent;</span></span><br><span class="line"><span class="undefined">				border-bottom: 3px solid transparent;</span></span><br><span class="line"><span class="undefined">				background-clip: padding-box;</span></span><br><span class="line"><span class="undefined">				border-radius: 7px;</span></span><br><span class="line"><span class="css">				<span class="selector-tag">background-color</span>: <span class="selector-id">#C4C4C4</span>;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="css">		<span class="selector-class">.atwho-ul</span> &#123;</span></span><br><span class="line"><span class="undefined">			list-style: none;</span></span><br><span class="line"><span class="undefined">			padding: 0;</span></span><br><span class="line"><span class="undefined">			margin: 0;</span></span><br><span class="line"><span class="undefined">			li &#123;</span></span><br><span class="line"><span class="undefined">				box-sizing: border-box;</span></span><br><span class="line"><span class="undefined">				display: block;</span></span><br><span class="line"><span class="undefined">				height: 25px;</span></span><br><span class="line"><span class="undefined">				padding: 2px 10px;</span></span><br><span class="line"><span class="undefined">				white-space: nowrap;</span></span><br><span class="line"><span class="undefined">				display: flex;</span></span><br><span class="line"><span class="undefined">				align-items: center;</span></span><br><span class="line"><span class="undefined">				justify-content: space-between;</span></span><br><span class="line"><span class="css">				&amp;<span class="selector-class">.atwho-cur</span> &#123;</span></span><br><span class="line"><span class="css">					<span class="selector-tag">background</span>: <span class="selector-id">#f2f2f5</span>;</span></span><br><span class="line"><span class="css">					<span class="selector-tag">color</span>: <span class="selector-id">#eb7350</span>;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">				span &#123;</span></span><br><span class="line"><span class="undefined">					overflow: hidden;</span></span><br><span class="line"><span class="undefined">					text-overflow: ellipsis;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">				img &#123;</span></span><br><span class="line"><span class="undefined">					height: 13px;</span></span><br><span class="line"><span class="undefined">					width: 13px;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>util.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">scrollIntoView</span>(<span class="params">el, scrollParent</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(el.scrollIntoViewIfNeeded) &#123;</span><br><span class="line">		el.scrollIntoViewIfNeeded(<span class="literal">false</span>) <span class="comment">// alignToCenter=false</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">const</span> diff = el.offsetTop - scrollParent.scrollTop</span><br><span class="line">		<span class="keyword">if</span>(diff &lt; <span class="number">0</span> || diff &gt; scrollParent.offsetHeight - el.offsetHeight) &#123;</span><br><span class="line">			scrollParent = scrollParent || el.parentElement</span><br><span class="line">			scrollParent.scrollTop = el.offsetTop</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">applyRange</span>(<span class="params">range</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">const</span> selection = <span class="built_in">window</span>.getSelection()</span><br><span class="line">	<span class="keyword">if</span>(selection) &#123; <span class="comment">// 容错</span></span><br><span class="line">		selection.removeAllRanges()</span><br><span class="line">		selection.addRange(range)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getRange</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">const</span> selection = <span class="built_in">window</span>.getSelection()</span><br><span class="line">	<span class="keyword">if</span>(selection &amp;&amp; selection.rangeCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> selection.getRangeAt(<span class="number">0</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getAtAndIndex</span>(<span class="params">text, ats</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> ats.map(<span class="function">(<span class="params">at</span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &#123;</span><br><span class="line">			at,</span><br><span class="line">			index: text.lastIndexOf(at)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;).reduce(<span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> a.index &gt; b.index ? a : b</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getOffset</span>(<span class="params">element, target</span>) </span>&#123;</span><br><span class="line">	target = target || <span class="built_in">window</span></span><br><span class="line">	<span class="keyword">var</span> offset = &#123;</span><br><span class="line">			top: element.offsetTop,</span><br><span class="line">			left: element.offsetLeft</span><br><span class="line">		&#125;,</span><br><span class="line">		parent = element.offsetParent;</span><br><span class="line">	<span class="keyword">while</span>(parent != <span class="literal">null</span> &amp;&amp; parent != target) &#123;</span><br><span class="line">		offset.left += parent.offsetLeft;</span><br><span class="line">		offset.top += parent.offsetTop;</span><br><span class="line">		parent = parent.offsetParent;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> offset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">closest</span>(<span class="params">el, predicate</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">		<span class="keyword">if</span>(predicate(el)) <span class="keyword">return</span> el;</span><br><span class="line">	<span class="keyword">while</span> (el = el &amp;&amp; el.parentNode);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// http://stackoverflow.com/questions/15157435/get-last-character-before-caret-position-in-javascript</span></span><br><span class="line"><span class="comment">// 修复 "空格+表情+空格+@" range报错 应设(endContainer, 0)</span></span><br><span class="line"><span class="comment">// stackoverflow上的这段代码有bug</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getPrecedingRange</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">const</span> r = getRange()</span><br><span class="line">	<span class="keyword">if</span>(r) &#123;</span><br><span class="line">		<span class="keyword">const</span> range = r.cloneRange()</span><br><span class="line">		range.collapse(<span class="literal">true</span>)</span><br><span class="line">		range.setStart(range.endContainer, <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> range</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="js获取光标位置"><a href="#js获取光标位置" class="headerlink" title="js获取光标位置"></a><a href="https://blog.csdn.net/mafan121/article/details/78519348" target="_blank" rel="noopener">js获取光标位置</a></h3><h3 id="获取光标位置-设置光标位置"><a href="#获取光标位置-设置光标位置" class="headerlink" title="获取光标位置,设置光标位置"></a>获取光标位置,设置光标位置</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取光标位置</span></span><br><span class="line"><span class="comment"> * @param &#123;DOMElement&#125; element 输入框的dom节点</span></span><br><span class="line"><span class="comment"> * @return &#123;Number&#125; 光标位置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getCursorPosition = <span class="function">(<span class="params">element</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> caretOffset = <span class="number">0</span></span><br><span class="line">  <span class="keyword">const</span> doc = element.ownerDocument || element.document</span><br><span class="line">  <span class="keyword">const</span> win = doc.defaultView || doc.parentWindow</span><br><span class="line">  <span class="keyword">const</span> sel = win.getSelection()</span><br><span class="line">  <span class="keyword">if</span> (sel.rangeCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> range = win.getSelection().getRangeAt(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> preCaretRange = range.cloneRange()</span><br><span class="line">    preCaretRange.selectNodeContents(element)</span><br><span class="line">    preCaretRange.setEnd(range.endContainer, range.endOffset)</span><br><span class="line">    caretOffset = preCaretRange.toString().length</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> caretOffset</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置光标位置</span></span><br><span class="line"><span class="comment"> * @param &#123;DOMElement&#125; element 输入框的dom节点</span></span><br><span class="line"><span class="comment"> * @param &#123;Number&#125; cursorPosition 光标位置的值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> setCursorPosition = <span class="function">(<span class="params">element, cursorPosition</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> range = <span class="built_in">document</span>.createRange()</span><br><span class="line">  range.setStart(element.firstChild, cursorPosition)</span><br><span class="line">  range.setEnd(element.firstChild, cursorPosition)</span><br><span class="line">  <span class="keyword">const</span> sel = <span class="built_in">window</span>.getSelection()</span><br><span class="line">  sel.removeAllRanges()</span><br><span class="line">  sel.addRange(range)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="JS获取文本框焦点光标位置、选中起始位置、终止位置、选择内容"><a href="#JS获取文本框焦点光标位置、选中起始位置、终止位置、选择内容" class="headerlink" title="JS获取文本框焦点光标位置、选中起始位置、终止位置、选择内容"></a><a href="https://blog.csdn.net/itdragons/article/details/52186058" target="_blank" rel="noopener">JS获取文本框焦点光标位置、选中起始位置、终止位置、选择内容</a></h3><h3 id="扩展知识"><a href="#扩展知识" class="headerlink" title="扩展知识"></a>扩展知识</h3><h4 id="js获取光标位置-1"><a href="#js获取光标位置-1" class="headerlink" title="js获取光标位置"></a>js获取光标位置</h4><h5 id="1-概念和原理"><a href="#1-概念和原理" class="headerlink" title="1.概念和原理"></a>1.概念和原理</h5><p>DOM中并没有直接获取光标位置的方法，那么我们只能间接来获取光标位置。DOM支持获取光标选中的范围，我们可以以此为切入点，来获取或定位光标的位置。当选取范围起始点和结束点一样时，就是光标插入的位置。</p>
<h3 id="1-1-术语"><a href="#1-1-术语" class="headerlink" title="1.1 术语"></a>1.1 术语</h3><p><code>anchor(瞄点)</code>：选区起点。</p>
<p><code>focus(焦点)</code>：选区终点。</p>
<p><code>range(范围)</code>：选区范围，包含整个节点或节点的一部分。</p>
<h3 id="1-2-Selection"><a href="#1-2-Selection" class="headerlink" title="1.2 Selection"></a>1.2 Selection</h3><p><code>Selection</code>:<code>Selection对象</code>表示用户选择的文本范围或插入符号的位置。</p>
<blockquote>
<p>经过实验发现Selection选取的节点范围都是块级节点。input和texteare并不能作为Selection的节点</p>
</blockquote>
<p><code>Selection</code>对象存在于<code>window</code>对象上，可以通过<code>window.getSelection()</code>获取示例。</p>
<p><strong>属性：</strong></p>
<p><code>anchorNode</code>:选区起点的节点。</p>
<p><code>anchorOffset</code>:选区的起点位置。</p>
<p><code>focusNode</code>:选区终点的节点。</p>
<p><code>focusOffset</code>:选区的终点位置。</p>
<p><code>isCollapsed</code>:起点和终点是否重叠。</p>
<p><code>rangeCount</code>:选区包含的range数目。</p>
<p><strong>方法</strong></p>
<p><code>getRangeAt(index)</code>:获取指定的选取范围。</p>
<p><code>addRange(range)</code>:将一个范围添加到Selection对象中。</p>
<p><code>removeRange()</code>:移出指定的范围。</p>
<p><code>removeAllRanges()</code>:移出所有range对象。</p>
<p><code>collapse(parentNode,offset)</code>:将光标移动到parentNode节点的offset位置。</p>
<p><code>collapseToStart()</code>:取消当前选区，并把光标定位在原选区的最开始处，如果此时光标所处的位置是可编辑的，且它获得了焦点，则光标会在原地闪烁。</p>
<p><code>collapseToEnd()</code>:取消当前选区，并将光标定位到原选取的最末位。如果此时光标所处的位置是可编辑的，且它获得了焦点，则光标会在原地闪烁。</p>
<p><code>extend(node,offset)</code>:将终点位置移动到node节点的offset位置。</p>
<p><code>modify(alter,direction,granularity)</code>:通过<code>alter方式(move/extend)</code>来改变光标位置，移动方向为<code>direction(left/right)</code>，移动单位为<code>granularity</code>。</p>
<p><code>containsNode(aNode,aPartlyContained)</code>:判断aNode是否包含在Selection中。aPartlyContained为false表示全包含，为true表示只要部分包含即可。</p>
<p><code>toString()</code>:放回当前Selection对象的字符串。</p>
<h3 id="1-3-Range"><a href="#1-3-Range" class="headerlink" title="1.3 Range"></a>1.3 Range</h3><p><code>Range</code>对象表示一个<code>Selection</code>的选择范围，一个<code>Selection</code>可以包含多个<code>Range</code>。</p>
<p><strong>获取对象</strong></p>
<p><code>document.createRange()</code>:创建一个Range。</p>
<p><code>selection.getRangeAt(index)</code>:获取指定的Range。</p>
<p><strong>属性</strong></p>
<p><code>collapsed</code>:判断起始位置是否重合。</p>
<p><code>endContaniner</code>:range终点节点。</p>
<p><code>endOffset</code>:range的终点位置。</p>
<p><code>startContaniner</code>:ranstartge起点节点。</p>
<p><code>startOffset</code>:range的起点位置。</p>
<p><code>commonAncestorContainer</code>:包含起始点的节点。</p>
<p><strong>方法</strong></p>
<p><code>setStart(startNode,startOffset)</code>:设置范围在startNode的起始位置为startOffset。</p>
<p><code>setEnd(endNode,endOffset)</code>:设置范围在endNode的起始位置为endOffset。</p>
<p><code>selectNode(referenceNode)</code>:设置range的节点为referenceNode。</p>
<p><code>selectNodeContents(referenceNode)</code>:设置range的内容为referenceNode。</p>
<p><code>collapse(toStart)</code>:向边界点折叠range，即是设置光标位置，toStart默认为false，表示光标定位在节点末尾。true表示光标定位在节点起点。</p>
<p><code>cloneContents()</code>:克隆一个range的内容片段。</p>
<p><code>deleteContents()</code>:删除range的内容片段。</p>
<p><code>extractContents()</code>:将range的内容从文档树移动到文档片段中。</p>
<p><code>insertNode(newNode)</code>:在range的其实位置插入新的节点。</p>
<p><code>surroundContents(newNode)</code>:将range对象的内容移动到新的节点中。</p>
<p><code>cloneRange()</code>:克隆一个range对象。</p>
<p><code>detach()</code>:释放当前range。</p>
<h3 id="1-4-input-textarea"><a href="#1-4-input-textarea" class="headerlink" title="1.4 input/textarea"></a>1.4 input/textarea</h3><p>在html5中，可输入性表单元素（input/textarea）都存在以下属性。不支持IE6/7。</p>
<ul>
<li><code>selectionDirection</code>:forward | backward | none,选区方向</li>
<li><code>selectionEnd</code>:选区终点位置</li>
<li><code>selectionStart</code>:选区起点位置</li>
</ul>
<p><code>setSelectionRange(selectionStart, selectionEnd, [selectionDirection])</code>:设置获取焦点的输入性元素的选区范围。</p>
<h3 id="2-获取光标位置"><a href="#2-获取光标位置" class="headerlink" title="2.获取光标位置"></a>2.获取光标位置</h3><h3 id="2-1-可编辑div获取光标位置"><a href="#2-1-可编辑div获取光标位置" class="headerlink" title="2.1 可编辑div获取光标位置"></a>2.1 可编辑div获取光标位置</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取当前光标位置</span></span><br><span class="line"><span class="keyword">const</span> getCursortPosition = <span class="function"><span class="keyword">function</span> (<span class="params">element</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> caretOffset = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> doc = element.ownerDocument || element.document;</span><br><span class="line">  <span class="keyword">var</span> win = doc.defaultView || doc.parentWindow;</span><br><span class="line">  <span class="keyword">var</span> sel;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> win.getSelection != <span class="string">"undefined"</span>) &#123;<span class="comment">//谷歌、火狐</span></span><br><span class="line">    sel = win.getSelection();</span><br><span class="line">    <span class="keyword">if</span> (sel.rangeCount &gt; <span class="number">0</span>) &#123;<span class="comment">//选中的区域</span></span><br><span class="line">      <span class="keyword">var</span> range = win.getSelection().getRangeAt(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">var</span> preCaretRange = range.cloneRange();<span class="comment">//克隆一个选中区域</span></span><br><span class="line">      preCaretRange.selectNodeContents(element);<span class="comment">//设置选中区域的节点内容为当前节点</span></span><br><span class="line">      preCaretRange.setEnd(range.endContainer, range.endOffset);  <span class="comment">//重置选中区域的结束位置</span></span><br><span class="line">      caretOffset = preCaretRange.toString().length;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((sel = doc.selection) &amp;&amp; sel.type != <span class="string">"Control"</span>) &#123;<span class="comment">//IE</span></span><br><span class="line">    <span class="keyword">var</span> textRange = sel.createRange();</span><br><span class="line">    <span class="keyword">var</span> preCaretTextRange = doc.body.createTextRange();</span><br><span class="line">    preCaretTextRange.moveToElementText(element);</span><br><span class="line">    preCaretTextRange.setEndPoint(<span class="string">"EndToEnd"</span>, textRange);</span><br><span class="line">    caretOffset = preCaretTextRange.text.length;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> caretOffset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>获取光标的位置是先通过获取鼠标的选取范围，然后克隆该选取范围，修改克隆范围的结束位置，这样克隆的范围就只剩下起点到结束点的内容，光标之后的内容被截取扔掉了。所以可以通过剩余内容的长度来确定光标位置。之所以要克隆一个选取范围出来，是为了避免修改光标结束位置时影响到原先内容。</p>
</blockquote>
<h3 id="2-2-input-textarea获取光标位置"><a href="#2-2-input-textarea获取光标位置" class="headerlink" title="2.2 input/textarea获取光标位置"></a>2.2 input/textarea获取光标位置</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//输入框获取光标</span></span><br><span class="line"><span class="keyword">const</span> getPosition = <span class="function"><span class="keyword">function</span> (<span class="params">element</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> cursorPos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">document</span>.selection) &#123;<span class="comment">//IE</span></span><br><span class="line">        <span class="keyword">var</span> selectRange = <span class="built_in">document</span>.selection.createRange();</span><br><span class="line">        selectRange.moveStart(<span class="string">'character'</span>, -element.value.length);</span><br><span class="line">        cursorPos = selectRange.text.length;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (element.selectionStart || element.selectionStart == <span class="string">'0'</span>) &#123;</span><br><span class="line">        cursorPos = element.selectionStart;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cursorPos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-设置光标位置"><a href="#3-设置光标位置" class="headerlink" title="3.设置光标位置"></a>3.设置光标位置</h3><h3 id="3-1-可编辑div设置光标位置"><a href="#3-1-可编辑div设置光标位置" class="headerlink" title="3.1 可编辑div设置光标位置"></a>3.1 可编辑div设置光标位置</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置光标位置</span></span><br><span class="line"><span class="keyword">const</span> setCaretPosition = <span class="function"><span class="keyword">function</span> (<span class="params">element, pos</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> range, selection;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">document</span>.createRange)<span class="comment">//Firefox, Chrome, Opera, Safari, IE 9+</span></span><br><span class="line">  &#123;</span><br><span class="line">    range = <span class="built_in">document</span>.createRange();<span class="comment">//创建一个选中区域</span></span><br><span class="line">    range.selectNodeContents(element);<span class="comment">//选中节点的内容</span></span><br><span class="line">    <span class="keyword">if</span>(element.innerHTML.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      range.setStart(element.childNodes[<span class="number">0</span>], pos); <span class="comment">//设置光标起始为指定位置</span></span><br><span class="line">    &#125;</span><br><span class="line">    range.collapse(<span class="literal">true</span>);       <span class="comment">//设置选中区域为一个点</span></span><br><span class="line">    selection = <span class="built_in">window</span>.getSelection();<span class="comment">//获取当前选中区域</span></span><br><span class="line">    selection.removeAllRanges();<span class="comment">//移出所有的选中范围</span></span><br><span class="line">    selection.addRange(range);<span class="comment">//添加新建的范围</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">document</span>.selection)<span class="comment">//IE 8 and lower</span></span><br><span class="line">  &#123;</span><br><span class="line">    range = <span class="built_in">document</span>.body.createTextRange();<span class="comment">//Create a range (a range is a like the selection but invisible)</span></span><br><span class="line">    range.moveToElementText(element);<span class="comment">//Select the entire contents of the element with the range</span></span><br><span class="line">    range.collapse(<span class="literal">false</span>);<span class="comment">//collapse the range to the end point. false means collapse to end rather than the start</span></span><br><span class="line">    range.select();<span class="comment">//Select the range (make it the visible selection</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-input-textarea获取光标位置"><a href="#3-2-input-textarea获取光标位置" class="headerlink" title="3.2  input/textarea获取光标位置"></a>3.2  input/textarea获取光标位置</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置光标位置</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setCaretPosition</span>(<span class="params">textDom, pos</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(textDom.setSelectionRange) &#123;</span><br><span class="line">        <span class="comment">// IE Support</span></span><br><span class="line">        textDom.focus();</span><br><span class="line">        textDom.setSelectionRange(pos, pos);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (textDom.createTextRange) &#123;</span><br><span class="line">        <span class="comment">// Firefox support</span></span><br><span class="line">        <span class="keyword">var</span> range = textDom.createTextRange();</span><br><span class="line">        range.collapse(<span class="literal">true</span>);</span><br><span class="line">        range.moveEnd(<span class="string">'character'</span>, pos);</span><br><span class="line">        range.moveStart(<span class="string">'character'</span>, pos);</span><br><span class="line">        range.select();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-示例"><a href="#4-示例" class="headerlink" title="4.示例"></a>4.示例</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>光标测试<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    p &#123;</span></span><br><span class="line"><span class="undefined">      display: flex;</span></span><br><span class="line"><span class="undefined">      flex-direction: row;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.btn</span> &#123;</span></span><br><span class="line"><span class="undefined">      height: 24px;</span></span><br><span class="line"><span class="undefined">      margin: 0 10px;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.edit-div</span> &#123;</span></span><br><span class="line"><span class="undefined">      display: inline-block;</span></span><br><span class="line"><span class="undefined">      width: 225px;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">border</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#decdcd</span>;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">getCursortPosition</span>(<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">var</span> eleP = e.target.parentNode; <span class="comment">//获取父级元素</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">var</span> pos = <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span> (e.target.nodeName == <span class="string">"DIV"</span>) &#123;</span></span><br><span class="line"><span class="undefined">        pos = getDivPosition(e.target);</span></span><br><span class="line"><span class="javascript">      &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="undefined">        pos = getPosition(e.target);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">      <span class="keyword">var</span> spanEle = (eleP.childNodes)[<span class="number">7</span>];</span></span><br><span class="line"><span class="undefined">      spanEle.innerText = pos;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">//可编辑div获取坐标</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> getDivPosition = <span class="function"><span class="keyword">function</span> (<span class="params">element</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">var</span> caretOffset = <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">var</span> doc = element.ownerDocument || element.document;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">var</span> win = doc.defaultView || doc.parentWindow;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">var</span> sel;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span> (<span class="keyword">typeof</span> win.getSelection != <span class="string">"undefined"</span>) &#123;<span class="comment">//谷歌、火狐</span></span></span><br><span class="line"><span class="undefined">        sel = win.getSelection();</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (sel.rangeCount &gt; <span class="number">0</span>) &#123;<span class="comment">//选中的区域</span></span></span><br><span class="line"><span class="javascript">          <span class="keyword">var</span> range = win.getSelection().getRangeAt(<span class="number">0</span>);</span></span><br><span class="line"><span class="javascript">          <span class="keyword">var</span> preCaretRange = range.cloneRange();<span class="comment">//克隆一个选中区域</span></span></span><br><span class="line"><span class="javascript">          preCaretRange.selectNodeContents(element);<span class="comment">//设置选中区域的节点内容为当前节点</span></span></span><br><span class="line"><span class="javascript">          preCaretRange.setEnd(range.endContainer, range.endOffset);  <span class="comment">//重置选中区域的结束位置</span></span></span><br><span class="line"><span class="undefined">          caretOffset = preCaretRange.toString().length;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((sel = doc.selection) &amp;&amp; sel.type != <span class="string">"Control"</span>) &#123;<span class="comment">//IE</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> textRange = sel.createRange();</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> preCaretTextRange = doc.body.createTextRange();</span></span><br><span class="line"><span class="undefined">        preCaretTextRange.moveToElementText(element);</span></span><br><span class="line"><span class="javascript">        preCaretTextRange.setEndPoint(<span class="string">"EndToEnd"</span>, textRange);</span></span><br><span class="line"><span class="undefined">        caretOffset = preCaretTextRange.text.length;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> caretOffset;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="comment">//输入框获取光标</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> getPosition = <span class="function"><span class="keyword">function</span> (<span class="params">element</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> cursorPos = <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span> (<span class="built_in">document</span>.selection) &#123;<span class="comment">//IE</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> selectRange = <span class="built_in">document</span>.selection.createRange();</span></span><br><span class="line"><span class="javascript">        selectRange.moveStart(<span class="string">'character'</span>, -element.value.length);</span></span><br><span class="line"><span class="undefined">        cursorPos = selectRange.text.length;</span></span><br><span class="line"><span class="javascript">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (element.selectionStart || element.selectionStart == <span class="string">'0'</span>) &#123;</span></span><br><span class="line"><span class="undefined">        cursorPos = element.selectionStart;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> cursorPos;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>输入框测试:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">style</span>=<span class="string">"width:220px"</span> <span class="attr">onclick</span>=<span class="string">"getCursortPosition(event);"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>光标位置:<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>文本框测试:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">rows</span>=<span class="string">"5"</span> <span class="attr">style</span>=<span class="string">"width:220px"</span> <span class="attr">onclick</span>=<span class="string">"getCursortPosition(event);"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>光标位置:<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>可编辑div:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">contenteditable</span>=<span class="string">"true"</span> <span class="attr">class</span>=<span class="string">"edit-div"</span> <span class="attr">onclick</span>=<span class="string">"getCursortPosition(event);"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>光标位置:<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>效果图：</p>
<p><img src="/2018/12/22/vue-user组件/4.jpg" alt=""></p>
<hr>
<h3 id="JS获取文本框焦点光标位置、选中起始位置、终止位置、选择内容-1"><a href="#JS获取文本框焦点光标位置、选中起始位置、终止位置、选择内容-1" class="headerlink" title="JS获取文本框焦点光标位置、选中起始位置、终止位置、选择内容"></a><a href="https://blog.csdn.net/itdragons/article/details/52186058" target="_blank" rel="noopener">JS获取文本框焦点光标位置、选中起始位置、终止位置、选择内容</a></h3><p><img src="/2018/12/22/vue-user组件/5.jpg" alt=""><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">		&lt;title&gt;<span class="xml"><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line">	&lt;<span class="regexp">/head&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">	&lt;body&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">		&lt;script&gt;</span></span><br><span class="line"><span class="regexp">			function getSelectPosition(oTxt) &#123;</span></span><br><span class="line"><span class="regexp">				var nullvalue = -1;</span></span><br><span class="line"><span class="regexp">				var selectStart; /</span><span class="regexp">/选中开始位置</span></span><br><span class="line"><span class="regexp">				var selectEnd; /</span><span class="regexp">/选中结束位置</span></span><br><span class="line"><span class="regexp">				var position; /</span><span class="regexp">/焦点位置</span></span><br><span class="line"><span class="regexp">				var selectText; /</span><span class="regexp">/选中内容</span></span><br><span class="line"><span class="regexp">				if(oTxt.setSelectionRange) &#123; /</span><span class="regexp">/非IE浏览器</span></span><br><span class="line"><span class="regexp">					selectStart = oTxt.selectionStart;</span></span><br><span class="line"><span class="regexp">					selectEnd = oTxt.selectionEnd;</span></span><br><span class="line"><span class="regexp">					if(selectStart == selectEnd) &#123;</span></span><br><span class="line"><span class="regexp">						position = oTxt.selectionStart;</span></span><br><span class="line"><span class="regexp">						selectStart = nullvalue;</span></span><br><span class="line"><span class="regexp">						selectEnd = nullvalue;</span></span><br><span class="line"><span class="regexp">					&#125; else &#123;</span></span><br><span class="line"><span class="regexp">						position = nullvalue;</span></span><br><span class="line"><span class="regexp">					&#125;</span></span><br><span class="line"><span class="regexp">					selectText = oTxt.value.substring(selectStart, selectEnd);</span></span><br><span class="line"><span class="regexp">				&#125; else &#123; /</span><span class="regexp">/IE</span></span><br><span class="line"><span class="regexp">					var range = document.selection.createRange();</span></span><br><span class="line"><span class="regexp">					selectText = range.text;</span></span><br><span class="line"><span class="regexp">					range.moveStart("character", -oTxt.value.length);</span></span><br><span class="line"><span class="regexp">					position = range.text.length;</span></span><br><span class="line"><span class="regexp">					selectStart = position - (selectText.length);</span></span><br><span class="line"><span class="regexp">					selectEnd = selectStart + (selectText.length);</span></span><br><span class="line"><span class="regexp">					if(selectStart != selectEnd) &#123;</span></span><br><span class="line"><span class="regexp">						position = nullvalue;</span></span><br><span class="line"><span class="regexp">					&#125; else &#123;</span></span><br><span class="line"><span class="regexp">						selectStart = nullvalue;</span></span><br><span class="line"><span class="regexp">						selectEnd = nullvalue;</span></span><br><span class="line"><span class="regexp">					&#125;</span></span><br><span class="line"><span class="regexp">				&#125;</span></span><br><span class="line"><span class="regexp">				document.getElementById("txt1").value = position;</span></span><br><span class="line"><span class="regexp">				document.getElementById("txt2").value = selectStart;</span></span><br><span class="line"><span class="regexp">				document.getElementById("txt3").value = selectEnd;</span></span><br><span class="line"><span class="regexp">				document.getElementById("txt4").value = selectText;</span></span><br><span class="line"><span class="regexp">			&#125;</span></span><br><span class="line"><span class="regexp">		&lt;/</span>script&gt;</span><br><span class="line">		&lt;input type=<span class="string">"text"</span> id=<span class="string">"txt"</span> value=<span class="string">"abcdefghijklmn"</span> </span><br><span class="line">			onclick=<span class="string">"getSelectPosition(this);"</span>&gt;</span><br><span class="line">			点击文本框内容触发事件&lt;br/&gt; </span><br><span class="line">			</span><br><span class="line">			焦点位置：&lt;input type=<span class="string">"text"</span> id=<span class="string">"txt1"</span> value=<span class="string">""</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line">		        选中起始位置：&lt;input type=<span class="string">"text"</span> id=<span class="string">"txt2"</span> value=<span class="string">""</span>&gt; </span><br><span class="line">		        选中结束位置&lt;input type=<span class="string">"text"</span> id=<span class="string">"txt3"</span> value=<span class="string">""</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span> </span><br><span class="line">		        选中内容: <span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"txt4"</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&lt;<span class="regexp">/html&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="enter键发送，ctrl-enter换行"><a href="#enter键发送，ctrl-enter换行" class="headerlink" title="enter键发送，ctrl+enter换行"></a><a href="https://blog.csdn.net/Smile_ping/article/details/79331852" target="_blank" rel="noopener">enter键发送，ctrl+enter换行</a></h3><p><img src="/2018/12/22/vue-user组件/6.png" alt=""><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> keyEnter = <span class="built_in">document</span>.querySelector(<span class="string">'.rongcloud-text'</span>);</span><br><span class="line">    <span class="comment">// 监听事件 键盘按下触发</span></span><br><span class="line">    keyEnter.addEventListener(<span class="string">'keydown'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">        e = e || <span class="built_in">window</span>.event;</span><br><span class="line">        <span class="comment">// console.log($(".rongcloud-text").val());</span></span><br><span class="line">        <span class="keyword">var</span> keyCode = e.keyCode || e.which || e.charCode;</span><br><span class="line">        <span class="keyword">var</span> ctrlKey = e.ctrlKey || e.metaKey;</span><br><span class="line">        <span class="comment">// 判断 ctrl+enter 换行</span></span><br><span class="line">        <span class="keyword">if</span> (ctrlKey &amp;&amp; keyCode == <span class="number">13</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> str = $(<span class="string">".rongcloud-text"</span>).val();</span><br><span class="line">            $(<span class="string">".rongcloud-text"</span>).val(str + <span class="string">"\n"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (keyCode == <span class="number">13</span>) &#123;</span><br><span class="line">            <span class="comment">// 阻止提交自动换行</span></span><br><span class="line">            e.preventDefault();</span><br><span class="line">            <span class="comment">// 获取发送按钮id，调用 发送按钮事件</span></span><br><span class="line">            <span class="built_in">document</span>.getElementById(<span class="string">"rong-sendBtn"</span>).click();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 文本域 并清空空格</span></span><br><span class="line">    <span class="keyword">var</span> $textarea = $(<span class="string">".rongcloud-text"</span>).val().replace(<span class="regexp">/[ ]/g</span>, <span class="string">""</span>);</span><br><span class="line">     <span class="comment">// 获取 发送按钮</span></span><br><span class="line">    <span class="keyword">var</span> $sendBtn = $(<span class="string">"#rong-sendBtn"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断当 文本域length == 0，设置按钮颜色</span></span><br><span class="line">    <span class="keyword">if</span> ($textarea.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// #0099ff</span></span><br><span class="line">        $sendBtn.css(<span class="string">'background'</span>, <span class="string">'red'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当 文本域输入信息 弹起时  给 发送按钮 设置背景颜色（提醒用户进入编辑状态）</span></span><br><span class="line">    $(<span class="string">".rongcloud-text"</span>).keyup(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> currentText = $(<span class="keyword">this</span>).val().replace(<span class="regexp">/[ ]/g</span>, <span class="string">""</span>);</span><br><span class="line">        <span class="comment">//console.log(key);</span></span><br><span class="line">        <span class="keyword">if</span> (currentText.length &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">            $sendBtn.css(<span class="string">'background'</span>, <span class="string">'orange'</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $sendBtn.css(<span class="string">'background'</span>, <span class="string">'blue'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* 点击 发送按钮  注册单击事件 */</span></span><br><span class="line">    $(<span class="string">'body'</span>).on(<span class="string">'click'</span>, <span class="string">"#rong-sendBtn"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 获取 文本域 输入内容</span></span><br><span class="line">        <span class="keyword">var</span> contentVal = $(<span class="string">'.rongcloud-text'</span>).val();</span><br><span class="line">        <span class="comment">// 当信息为空时，不能发空白信息</span></span><br><span class="line">        <span class="keyword">if</span> (contentVal == <span class="string">""</span>) &#123;</span><br><span class="line">            alert(<span class="string">"不能发送空白信息"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 长度  小于 return </span></span><br><span class="line">        <span class="keyword">if</span> (contentVal.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用 发送函数</span></span><br><span class="line">        sendMssage(targetId, contentVal, doctorName, doctorId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 清空文本域的值</span></span><br><span class="line">        $(<span class="string">".rongcloud-text"</span>).val(<span class="string">""</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 右边聊天窗口 部分 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"rcs-main"</span> <span class="attr">class</span>=<span class="string">"rongcloud-kefuListBox rongcloud-container clearfix"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 左边 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-kefuList rongcloud-imList"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-rong-header rongcloud-blueBg"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-toolBar rongcloud-headBtn"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-voice"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-sprite rongcloud-people"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"rongcloud-recent"</span>&gt;</span>最近联系人<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-sprite rongcloud-arrow-down cursor-pointer"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-content"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-netStatus"</span> <span class="attr">style</span>=<span class="string">"display:none"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-sprite"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span>&gt;</span>连接断开,请刷新重连<span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rcs-conversation-list"</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 会话列表每一个会话class="rong-conversation"会话列表中的每一个会话此类名不能被修改--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rong-conversation"</span> <span class="attr">_cid</span>=<span class="string">"bb"</span> <span class="attr">_mcount</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-ext"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"rongcloud-attr"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"rongcloud-sprite rongcloud-no-remind"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-photo"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"rongcloud-img"</span> <span class="attr">src</span>=<span class="string">"http://7xo1cb.com1.z0.glb.clouddn.com/rongcloudkefu2.png"</span> <span class="attr">alt</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-info"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"rongcloud-nickname"</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"rongcloud-nickname_text"</span>&gt;</span>用户：小轩轩<span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rong-conversation"</span> <span class="attr">_cid</span>=<span class="string">"2"</span> <span class="attr">_mcount</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-ext"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"rongcloud-attr"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"rongcloud-sprite rongcloud-no-remind"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-photo"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"rongcloud-img"</span> <span class="attr">src</span>=<span class="string">"http://7xo1cb.com1.z0.glb.clouddn.com/rongcloudkefu2.png"</span> <span class="attr">alt</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-info"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"rongcloud-nickname"</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"rongcloud-nickname_text"</span>&gt;</span>用户：小机智<span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 右边 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rcs-chat-wrapper rcs-chat-im-wrapper"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-kefuChat"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"header"</span> <span class="attr">class</span>=<span class="string">"rongcloud-rong-header rongcloud-blueBg rongcloud-online"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-infoBar rongcloud-pull-left"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-infoBarTit"</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"rongcloud-kefuName"</span>&gt;</span>用户：小轩轩<span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-toolBar rongcloud-headBtn rongcloud-pull-right"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-voice"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"rongcloud-kefuChatBoxHide rongcloud-sprite"</span> <span class="attr">title</span>=<span class="string">"隐藏"</span> <span class="attr">onclick</span>=<span class="string">"minimize()"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"rongcloud-kefuChatBoxClose rongcloud-sprite"</span> <span class="attr">title</span>=<span class="string">"结束对话"</span> <span class="attr">onclick</span>=<span class="string">"endConversation()"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- style="display:none;" --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-outlineBox rcs-connect-status"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-sprite"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span>&gt;</span>连接断开,请刷新重连<span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"rcs-message-list"</span> <span class="attr">class</span>=<span class="string">"rcs-message-box"</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- message: 消息list的页面 --&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-Messages-history"</span> <span class="attr">style</span>=<span class="string">"display: block;"</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>查看历史消息<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"historyBox"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rong-message-list"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-Messages-history"</span> <span class="attr">style</span>=<span class="string">"display: block;"</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>查看历史消息<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-Messages-date"</span>&gt;</span> <span class="tag">&lt;<span class="name">b</span>&gt;</span>14:42<span class="tag">&lt;/<span class="name">b</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 我 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-Message rongcloud-clearfix  rongcloud-Message-send "</span> <span class="attr">id</span>=<span class="string">"rcs-templte-message-text"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-Message-header"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"rongcloud-img rongcloud-Message-avatar rongcloud-avatar"</span> <span class="attr">src</span>=<span class="string">"http://7xo1cb.com1.z0.glb.clouddn.com/rongcloudkefu2.png"</span></span></span><br><span class="line"><span class="tag">                                <span class="attr">alt</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-Message-author rongcloud-clearfix"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"rongcloud-author"</span>&gt;</span> 我 <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-Message-body"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-Message-text"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">pre</span> <span class="attr">class</span>=<span class="string">"rongcloud-Message-entry"</span>&gt;</span>新年快乐<span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">&lt;!-- 用户 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-Message rongcloud-clearfix "</span> <span class="attr">id</span>=<span class="string">"rcs-templte-message-text"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-Message-header"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"rongcloud-img rongcloud-Message-avatar rongcloud-avatar"</span> <span class="attr">src</span>=<span class="string">"http://7xo1cb.com1.z0.glb.clouddn.com/rongcloudkefu2.png"</span></span></span><br><span class="line"><span class="tag">                                <span class="attr">alt</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-Message-author rongcloud-clearfix"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"rongcloud-author"</span>&gt;</span> 用户：小轩轩 <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-Message-body"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-Message-text"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">pre</span> <span class="attr">class</span>=<span class="string">"rongcloud-Message-entry"</span>&gt;</span>你好<span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-emptyBox"</span>&gt;</span>暂时没有新消息<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"rcs-chat-box"</span> <span class="attr">class</span>=<span class="string">"rongcloud-rong-footer"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-footer-con"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 请输入文字  发送 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-footer-input"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"rongcloud-footer-textarea"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">class</span>=<span class="string">"rongcloud-text rongcloud-grey"</span> <span class="attr">placeholder</span>=<span class="string">"请输入文字..."</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">style</span>=<span class="string">"background-color: #0099ff;"</span> <span class="attr">class</span>=<span class="string">"rongcloud-rong-btn rongcloud-rong-send-btn"</span> <span class="attr">id</span>=<span class="string">"rong-sendBtn"</span>&gt;</span>发送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="增加动态文本插入-enter发送-ctrl-enter换行"><a href="#增加动态文本插入-enter发送-ctrl-enter换行" class="headerlink" title="增加动态文本插入,enter发送,ctrl+enter换行"></a>增加动态文本插入,enter发送,ctrl+enter换行</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div ref=<span class="string">"wrap"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"atwho-wrap"</span> @input=<span class="string">"handleInput"</span> @keydown=<span class="string">"handleKeyDown"</span>&gt;</span><br><span class="line">		&lt;div v-<span class="keyword">if</span>=<span class="string">"atwho"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"atwho-panel"</span> :style=<span class="string">"style"</span>&gt;</span><br><span class="line">			&lt;ul <span class="class"><span class="keyword">class</span></span>=<span class="string">"atwho-view atwho-ul"</span>&gt;</span><br><span class="line">				&lt;li v-<span class="keyword">for</span>=<span class="string">"(item, index) in atwho.list"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"atwho-li"</span> :key=<span class="string">"index"</span> :<span class="class"><span class="keyword">class</span></span>=<span class="string">"isCur(index) &amp;&amp; 'atwho-cur'"</span> :ref=<span class="string">"isCur(index) &amp;&amp; 'cur'"</span> :data-index=<span class="string">"index"</span> @mouseenter=<span class="string">"handleItemHover"</span> @click=<span class="string">"handleItemClick"</span>&gt;</span><br><span class="line">					&lt;span v-text=<span class="string">"item"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">				&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">				&lt;li&gt;</span></span><br><span class="line"><span class="regexp">					&lt;span&gt;展开更多群成员&lt;/</span>span&gt;</span><br><span class="line">					&lt;img src=<span class="string">"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNTQ1NDgyNjY3NzY4IiBjbGFzcz0iaWNvbiIgc3R5bGU9IiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEwODYiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PC9zdHlsZT48L2RlZnM+PHBhdGggZD0iTTMzNi43MzMgMTE5LjY2N2wtNTYuMjc4IDU1LjcyIDMzNC44NTcgMzM3LjE1NC0zMzcuNjczIDMzNC4zMTUgNTUuODAyIDU2LjE4NCAzOTMuOTQ0LTM5MC4wNDB6IiBwLWlkPSIxMDg3Ij48L3BhdGg+PC9zdmc+"</span> /&gt;</span><br><span class="line">				&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">			&lt;/u</span>l&gt;</span><br><span class="line">		&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">		&lt;textarea ref="textarea" class="editor textarea-content" @keyup="getCursorRect($event)" @keydown="getCursorRect($event)" @mousedown="getCursorRect($event)" @mouseup="getCursorRect($event)" @focus="getCursorRect($event)" placeholder="按下Enter发送内容/</span> Command+Enter换行<span class="string">"&gt;&lt;/textarea&gt;</span></span><br><span class="line"><span class="string">	&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/template&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">	import getCaretCoordinates from 'textarea-caret'</span></span><br><span class="line"><span class="string">	export default &#123;</span></span><br><span class="line"><span class="string">		props: &#123;</span></span><br><span class="line"><span class="string">			value: &#123; //输入框初始值</span></span><br><span class="line"><span class="string">				type: String,</span></span><br><span class="line"><span class="string">				default: ''</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			suffix: &#123; //插入字符链接</span></span><br><span class="line"><span class="string">				type: String,</span></span><br><span class="line"><span class="string">				default: ' '</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			loop: &#123; //上下箭头循环</span></span><br><span class="line"><span class="string">				type: Boolean,</span></span><br><span class="line"><span class="string">				default: true</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			avoidEmail: &#123; //@前不能是字符</span></span><br><span class="line"><span class="string">				type: Boolean,</span></span><br><span class="line"><span class="string">				default: true</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			hoverSelect: &#123; //悬浮选中</span></span><br><span class="line"><span class="string">				type: Boolean,</span></span><br><span class="line"><span class="string">				default: true</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			members: &#123; //选择框选项列表</span></span><br><span class="line"><span class="string">				type: Array,</span></span><br><span class="line"><span class="string">				default: () =&gt; []</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			nameKey: &#123;</span></span><br><span class="line"><span class="string">				type: String,</span></span><br><span class="line"><span class="string">				default: ''</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">		data() &#123;</span></span><br><span class="line"><span class="string">			return &#123;</span></span><br><span class="line"><span class="string">				atItems: ['@'],</span></span><br><span class="line"><span class="string">				bindsValue: this.value != null,</span></span><br><span class="line"><span class="string">				atwho: null</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		computed: &#123;</span></span><br><span class="line"><span class="string">			style() &#123;</span></span><br><span class="line"><span class="string">				if(this.atwho) &#123;</span></span><br><span class="line"><span class="string">					const &#123;</span></span><br><span class="line"><span class="string">						list,</span></span><br><span class="line"><span class="string">						cur,</span></span><br><span class="line"><span class="string">						x,</span></span><br><span class="line"><span class="string">						y</span></span><br><span class="line"><span class="string">					&#125; = this.atwho</span></span><br><span class="line"><span class="string">					const &#123;</span></span><br><span class="line"><span class="string">						wrap</span></span><br><span class="line"><span class="string">					&#125; = this.$refs</span></span><br><span class="line"><span class="string">					const el = this.$el.querySelector('textarea')</span></span><br><span class="line"><span class="string">					if(wrap) &#123;</span></span><br><span class="line"><span class="string">						const left = x + el.offsetLeft - el.scrollLeft + 'px'</span></span><br><span class="line"><span class="string">						const top = y + el.offsetTop - el.scrollTop + 25 + 'px'</span></span><br><span class="line"><span class="string">						return &#123;</span></span><br><span class="line"><span class="string">							left,</span></span><br><span class="line"><span class="string">							top</span></span><br><span class="line"><span class="string">						&#125;</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">				return null</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		watch: &#123;</span></span><br><span class="line"><span class="string">			members() &#123;</span></span><br><span class="line"><span class="string">				this.handleInput(true)</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			value(value, oldValue) &#123;</span></span><br><span class="line"><span class="string">				this.handleValueUpdate(value)</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		mounted() &#123;</span></span><br><span class="line"><span class="string">			this.handleValueUpdate(this.value)</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		methods: &#123;</span></span><br><span class="line"><span class="string">			getAtAndIndex(text, ats) &#123;</span></span><br><span class="line"><span class="string">				return ats.map((at) =&gt; &#123;</span></span><br><span class="line"><span class="string">					return &#123;</span></span><br><span class="line"><span class="string">						at,</span></span><br><span class="line"><span class="string">						index: text.lastIndexOf(at)</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string">				&#125;).reduce((a, b) =&gt; &#123;</span></span><br><span class="line"><span class="string">					return a.index &gt; b.index ? a : b</span></span><br><span class="line"><span class="string">				&#125;)</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			isCur(index) &#123;</span></span><br><span class="line"><span class="string">				return index === this.atwho.cur</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			handleValueUpdate(value) &#123; //更新textarea的值</span></span><br><span class="line"><span class="string">				const el = this.$el.querySelector('textarea')</span></span><br><span class="line"><span class="string">				if(value !== el.value) &#123;</span></span><br><span class="line"><span class="string">					el.value = value</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			handleItemHover(e) &#123;</span></span><br><span class="line"><span class="string">				if(this.hoverSelect) &#123;</span></span><br><span class="line"><span class="string">					this.selectByMouse(e)</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			handleItemClick(e) &#123;</span></span><br><span class="line"><span class="string">				this.selectByMouse(e)</span></span><br><span class="line"><span class="string">				this.insertItem()</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			handleKeyDown(e) &#123;</span></span><br><span class="line"><span class="string">				const &#123;</span></span><br><span class="line"><span class="string">					atwho</span></span><br><span class="line"><span class="string">				&#125; = this;</span></span><br><span class="line"><span class="string">				if(atwho) &#123;</span></span><br><span class="line"><span class="string">					if(e.keyCode === 38 || e.keyCode === 40) &#123; // ↑/↓</span></span><br><span class="line"><span class="string">						if(!(e.metaKey || e.ctrlKey)) &#123;</span></span><br><span class="line"><span class="string">							e.preventDefault()</span></span><br><span class="line"><span class="string">							e.stopPropagation()</span></span><br><span class="line"><span class="string">							this.selectByKeyboard(e)</span></span><br><span class="line"><span class="string">						&#125;</span></span><br><span class="line"><span class="string">						return</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string">					if(e.keyCode === 13) &#123; // enter</span></span><br><span class="line"><span class="string">						this.insertItem()</span></span><br><span class="line"><span class="string">						e.preventDefault()</span></span><br><span class="line"><span class="string">						e.stopPropagation()</span></span><br><span class="line"><span class="string">						return</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string">					if(e.keyCode === 27) &#123; // esc</span></span><br><span class="line"><span class="string">						this.closePanel()</span></span><br><span class="line"><span class="string">						return</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">				// 为了兼容ie ie9~11 editable无input事件 只能靠keydown触发 textarea正常</span></span><br><span class="line"><span class="string">				// 另 ie9 textarea的delete不触发input</span></span><br><span class="line"><span class="string">				const isValid = e.keyCode &gt;= 48 &amp;&amp; e.keyCode &lt;= 90 || e.keyCode === 8</span></span><br><span class="line"><span class="string">				if(isValid) &#123;</span></span><br><span class="line"><span class="string">					setTimeout(() =&gt; &#123;</span></span><br><span class="line"><span class="string">						this.handleInput()</span></span><br><span class="line"><span class="string">					&#125;, 50)</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">				if(e.keyCode === 8) &#123; //删除del键</span></span><br><span class="line"><span class="string">					//this.handleDelete(e)</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">				if((e.keyCode === 13)) &#123; //回车</span></span><br><span class="line"><span class="string">					if(/macintosh|mac os x/i.test(navigator.userAgent)) &#123; //是不mac</span></span><br><span class="line"><span class="string">						if(!e.metaKey) &#123; //Mac没有按command</span></span><br><span class="line"><span class="string">							this.$emit("</span>enterSend<span class="string">", e)</span></span><br><span class="line"><span class="string">							return</span></span><br><span class="line"><span class="string">						&#125;</span></span><br><span class="line"><span class="string">					&#125; else &#123;</span></span><br><span class="line"><span class="string">                        if(!e.ctrlKey) &#123; //win没有按command</span></span><br><span class="line"><span class="string">							this.$emit("</span>enterSend<span class="string">", e)</span></span><br><span class="line"><span class="string">							return</span></span><br><span class="line"><span class="string">						&#125;</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string">					</span></span><br><span class="line"><span class="string">					const el = this.$el.querySelector('textarea')  //按下command</span></span><br><span class="line"><span class="string">					if(!el.value.replace(/(^\s*)|(\s*$)/g, "</span><span class="string">").length) &#123;</span></span><br><span class="line"><span class="string">						console.log('没有输入有效字符不可换行');</span></span><br><span class="line"><span class="string">						return;</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string">					this.$emit('input', el.value + '\n')</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">			handleInput(event) &#123;</span></span><br><span class="line"><span class="string">				const el = this.$el.querySelector('textarea')</span></span><br><span class="line"><span class="string">				this.$emit('input', el.value) //更新父组件</span></span><br><span class="line"><span class="string">				const text = el.value.slice(0, el.selectionEnd)</span></span><br><span class="line"><span class="string">				if(text) &#123;</span></span><br><span class="line"><span class="string">					const &#123;</span></span><br><span class="line"><span class="string">						atItems,</span></span><br><span class="line"><span class="string">						avoidEmail</span></span><br><span class="line"><span class="string">					&#125; = this</span></span><br><span class="line"><span class="string">					let show = true</span></span><br><span class="line"><span class="string">					const &#123;</span></span><br><span class="line"><span class="string">						at,</span></span><br><span class="line"><span class="string">						index</span></span><br><span class="line"><span class="string">					&#125; = this.getAtAndIndex(text, atItems)</span></span><br><span class="line"><span class="string">					if(index &lt; 0) show = false</span></span><br><span class="line"><span class="string">					const prev = text[index - 1] //上一个字符</span></span><br><span class="line"><span class="string">					const chunk = text.slice(index + at.length, text.length)</span></span><br><span class="line"><span class="string">					if(avoidEmail) &#123; //上一个字符不能为字母数字 避免与邮箱冲突，微信则是避免 所有字母数字及半角符号</span></span><br><span class="line"><span class="string">						if(/^[a-z0-9]$/i.test(prev)) show = false</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">					if(/^\s/.test(chunk)) show = false //chunk以空白字符开头不匹配 避免`@ `也匹配</span></span><br><span class="line"><span class="string">					if(!show) &#123;</span></span><br><span class="line"><span class="string">						this.closePanel()</span></span><br><span class="line"><span class="string">					&#125; else &#123;</span></span><br><span class="line"><span class="string">						const &#123;</span></span><br><span class="line"><span class="string">							members,</span></span><br><span class="line"><span class="string">							filterMatch</span></span><br><span class="line"><span class="string">						&#125; = this</span></span><br><span class="line"><span class="string">						if(!event) &#123; // fixme: should be consistent with At.vue</span></span><br><span class="line"><span class="string">							this.$emit('at', chunk)</span></span><br><span class="line"><span class="string">						&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">						const matched = members.filter(v =&gt; &#123;</span></span><br><span class="line"><span class="string">							return v.toString().indexOf(chunk) &gt; -1</span></span><br><span class="line"><span class="string">						&#125;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">						if(matched.length) &#123;</span></span><br><span class="line"><span class="string">							this.openPanel(matched, chunk, index, at)</span></span><br><span class="line"><span class="string">						&#125; else &#123;</span></span><br><span class="line"><span class="string">							this.closePanel()</span></span><br><span class="line"><span class="string">						&#125;</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string">				&#125; else &#123;</span></span><br><span class="line"><span class="string">					this.closePanel()</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">			closePanel() &#123;</span></span><br><span class="line"><span class="string">				if(this.atwho) &#123;</span></span><br><span class="line"><span class="string">					this.atwho = null</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			openPanel(list, chunk, offset, at) &#123; //打开Atuser列表  matched, chunk, index, at  过滤数组，匹配项，匹配项index，'@'</span></span><br><span class="line"><span class="string">				const fn = () =&gt; &#123;</span></span><br><span class="line"><span class="string">					const el = this.$el.querySelector('textarea')</span></span><br><span class="line"><span class="string">					const atEnd = offset + at.length // 从@后第一位开始</span></span><br><span class="line"><span class="string">					const rect = getCaretCoordinates(el, atEnd)</span></span><br><span class="line"><span class="string">					this.atwho = &#123;</span></span><br><span class="line"><span class="string">						chunk,</span></span><br><span class="line"><span class="string">						offset,</span></span><br><span class="line"><span class="string">						list,</span></span><br><span class="line"><span class="string">						atEnd,</span></span><br><span class="line"><span class="string">						x: rect.left,</span></span><br><span class="line"><span class="string">						y: rect.top - 4,</span></span><br><span class="line"><span class="string">						cur: 0, // todo: 尽可能记录</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">				if(this.atwho) &#123;</span></span><br><span class="line"><span class="string">					fn()</span></span><br><span class="line"><span class="string">				&#125; else &#123; // 焦点超出了显示区域 需要提供延时以移动指针 再计算位置</span></span><br><span class="line"><span class="string">					setTimeout(fn, 10)</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">			selectByMouse(e) &#123;</span></span><br><span class="line"><span class="string">				function closest(el, predicate) &#123; //遍历直到有data-index为止</span></span><br><span class="line"><span class="string">					do &#123;</span></span><br><span class="line"><span class="string">						if(predicate(el)) return el;</span></span><br><span class="line"><span class="string">					&#125; while (el = el &amp;&amp; el.parentNode);</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">				const el = closest(e.target, d =&gt; &#123;</span></span><br><span class="line"><span class="string">					return d.getAttribute('data-index')</span></span><br><span class="line"><span class="string">				&#125;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">				const cur = +el.getAttribute('data-index')</span></span><br><span class="line"><span class="string">				this.atwho = &#123;</span></span><br><span class="line"><span class="string">					...this.atwho,</span></span><br><span class="line"><span class="string">					cur</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			selectByKeyboard(e) &#123;</span></span><br><span class="line"><span class="string">				const offset = e.keyCode === 38 ? -1 : 1</span></span><br><span class="line"><span class="string">				const &#123;</span></span><br><span class="line"><span class="string">					cur,</span></span><br><span class="line"><span class="string">					list</span></span><br><span class="line"><span class="string">				&#125; = this.atwho</span></span><br><span class="line"><span class="string">				const nextCur = this.loop ?</span></span><br><span class="line"><span class="string">					(cur + offset + list.length) % list.length :</span></span><br><span class="line"><span class="string">					Math.max(0, Math.min(cur + offset, list.length - 1))</span></span><br><span class="line"><span class="string">				this.atwho = &#123;</span></span><br><span class="line"><span class="string">					...this.atwho,</span></span><br><span class="line"><span class="string">					cur: nextCur</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">			// todo: 抽离成库并测试</span></span><br><span class="line"><span class="string">			insertText(text, el) &#123;</span></span><br><span class="line"><span class="string">				const start = el.selectionStart</span></span><br><span class="line"><span class="string">				const end = el.selectionEnd</span></span><br><span class="line"><span class="string">				el.value = el.value.slice(0, start) +</span></span><br><span class="line"><span class="string">					text + el.value.slice(end)</span></span><br><span class="line"><span class="string">				const newEnd = start + text.length</span></span><br><span class="line"><span class="string">				el.selectionStart = newEnd</span></span><br><span class="line"><span class="string">				el.selectionEnd = newEnd</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			insertItem() &#123;</span></span><br><span class="line"><span class="string">				const &#123;</span></span><br><span class="line"><span class="string">					chunk,</span></span><br><span class="line"><span class="string">					offset,</span></span><br><span class="line"><span class="string">					list,</span></span><br><span class="line"><span class="string">					cur,</span></span><br><span class="line"><span class="string">					atEnd</span></span><br><span class="line"><span class="string">				&#125; = this.atwho</span></span><br><span class="line"><span class="string">				const &#123;</span></span><br><span class="line"><span class="string">					suffix,</span></span><br><span class="line"><span class="string">					atItems</span></span><br><span class="line"><span class="string">				&#125; = this</span></span><br><span class="line"><span class="string">				const el = this.$el.querySelector('textarea')</span></span><br><span class="line"><span class="string">				const text = el.value.slice(0, atEnd)</span></span><br><span class="line"><span class="string">				const &#123;</span></span><br><span class="line"><span class="string">					at,</span></span><br><span class="line"><span class="string">					index</span></span><br><span class="line"><span class="string">				&#125; = this.getAtAndIndex(text, atItems)</span></span><br><span class="line"><span class="string">				const start = index + at.length // 从@后第一位开始</span></span><br><span class="line"><span class="string">				el.selectionStart = start</span></span><br><span class="line"><span class="string">				el.focus() // textarea必须focus回来</span></span><br><span class="line"><span class="string">				const curItem = list[cur]</span></span><br><span class="line"><span class="string">				const t = '' + curItem + suffix</span></span><br><span class="line"><span class="string">				this.insertText(t, el)</span></span><br><span class="line"><span class="string">				this.$emit('insert', curItem) //插入字符</span></span><br><span class="line"><span class="string">				this.handleInput()</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			getCursorRect(e) &#123;</span></span><br><span class="line"><span class="string">				console.log(e.type)</span></span><br><span class="line"><span class="string">				var isIE = !(!document.all); //是不是IE</span></span><br><span class="line"><span class="string">				var start = 0,</span></span><br><span class="line"><span class="string">					end = 0;</span></span><br><span class="line"><span class="string">				var oTextarea = this.$el.querySelector("</span>textarea<span class="string">");</span></span><br><span class="line"><span class="string">				if(isIE) &#123;</span></span><br><span class="line"><span class="string">					var sTextRange = document.selection.createRange();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">					//判断选中的是不是textarea对象  </span></span><br><span class="line"><span class="string">					if(sTextRange.parentElement() == oTextarea) &#123;</span></span><br><span class="line"><span class="string">						//创建一个TextRange对象  </span></span><br><span class="line"><span class="string">						var oTextRange = document.body.createTextRange();</span></span><br><span class="line"><span class="string">						//移动文本范围以便范围的开始和结束位置能够完全包含给定元素的文本。  </span></span><br><span class="line"><span class="string">						oTextRange.moveToElementText(oTextarea);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">						//此时得到两个 TextRange  </span></span><br><span class="line"><span class="string">						//oTextRange文本域(textarea)中文本的TextRange对象  </span></span><br><span class="line"><span class="string">						//sTextRange是选中区域文本的TextRange对象  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">						//compareEndPoints方法介绍，compareEndPoints方法用于比较两个TextRange对象的位置  </span></span><br><span class="line"><span class="string">						//StartToEnd  比较TextRange开头与参数TextRange的末尾。  </span></span><br><span class="line"><span class="string">						//StartToStart比较TextRange开头与参数TextRange的开头。  </span></span><br><span class="line"><span class="string">						//EndToStart  比较TextRange末尾与参数TextRange的开头。  </span></span><br><span class="line"><span class="string">						//EndToEnd    比较TextRange末尾与参数TextRange的末尾。  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">						//moveStart方法介绍，更改范围的开始位置  </span></span><br><span class="line"><span class="string">						//character 按字符移动  </span></span><br><span class="line"><span class="string">						//word       按单词移动  </span></span><br><span class="line"><span class="string">						//sentence  按句子移动  </span></span><br><span class="line"><span class="string">						//textedit  启动编辑动作  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">						//这里我们比较oTextRange和sTextRange的开头，的到选中区域的开头位置  </span></span><br><span class="line"><span class="string">						for(start = 0; oTextRange.compareEndPoints("</span>StartToStart<span class="string">", sTextRange) &lt; 0; start++) &#123;</span></span><br><span class="line"><span class="string">							oTextRange.moveStart('character', 1);</span></span><br><span class="line"><span class="string">						&#125;</span></span><br><span class="line"><span class="string">						//需要计算一下\n的数目(按字符移动的方式不计\n,所以这里加上)   </span></span><br><span class="line"><span class="string">						for(var i = 0; i &lt;= start; i++) &#123;</span></span><br><span class="line"><span class="string">							if(oTextarea.value.charAt(i) == '\n') &#123;</span></span><br><span class="line"><span class="string">								start++;</span></span><br><span class="line"><span class="string">							&#125;</span></span><br><span class="line"><span class="string">						&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">						//再计算一次结束的位置  </span></span><br><span class="line"><span class="string">						oTextRange.moveToElementText(oTextarea);</span></span><br><span class="line"><span class="string">						for(end = 0; oTextRange.compareEndPoints('StartToEnd', sTextRange) &lt; 0; end++) &#123;</span></span><br><span class="line"><span class="string">							oTextRange.moveStart('character', 1);</span></span><br><span class="line"><span class="string">						&#125;</span></span><br><span class="line"><span class="string">						for(var i = 0; i &lt;= end; i++) &#123;</span></span><br><span class="line"><span class="string">							if(oTextarea.value.charAt(i) == '\n') &#123;</span></span><br><span class="line"><span class="string">								end++;</span></span><br><span class="line"><span class="string">							&#125;</span></span><br><span class="line"><span class="string">						&#125;</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string">				&#125; else &#123;</span></span><br><span class="line"><span class="string">					start = oTextarea.selectionStart;</span></span><br><span class="line"><span class="string">					end = oTextarea.selectionEnd;</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">				this.$emit("</span>cursorRect<span class="string">", &#123;</span></span><br><span class="line"><span class="string">					start,</span></span><br><span class="line"><span class="string">					end</span></span><br><span class="line"><span class="string">				&#125;); //获取鼠标当前在字符串位置</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;style lang="</span>less<span class="string">" scoped="</span>scoped<span class="string">"&gt;</span></span><br><span class="line"><span class="string">	.atwho-wrap &#123;</span></span><br><span class="line"><span class="string">		width: 100%;</span></span><br><span class="line"><span class="string">		font-size: 12px;</span></span><br><span class="line"><span class="string">		color: #333;</span></span><br><span class="line"><span class="string">		position: relative;</span></span><br><span class="line"><span class="string">		.atwho-panel &#123;</span></span><br><span class="line"><span class="string">			position: absolute;</span></span><br><span class="line"><span class="string">			&amp;.test &#123;</span></span><br><span class="line"><span class="string">				width: 2px;</span></span><br><span class="line"><span class="string">				height: 2px;</span></span><br><span class="line"><span class="string">				background: red;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">			.atwho-inner &#123;</span></span><br><span class="line"><span class="string">				position: relative;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">		.atwho-view &#123;</span></span><br><span class="line"><span class="string">			color: black;</span></span><br><span class="line"><span class="string">			z-index: 11110 !important;</span></span><br><span class="line"><span class="string">			border-radius: 2px;</span></span><br><span class="line"><span class="string">			box-shadow: 0 0 10px 0 rgba(101, 111, 122, .5);</span></span><br><span class="line"><span class="string">			position: absolute;</span></span><br><span class="line"><span class="string">			cursor: pointer;</span></span><br><span class="line"><span class="string">			background-color: rgba(255, 255, 255, .94);</span></span><br><span class="line"><span class="string">			width: 170px;</span></span><br><span class="line"><span class="string">			max-height: 312px;</span></span><br><span class="line"><span class="string">			&amp;::-webkit-scrollbar &#123;</span></span><br><span class="line"><span class="string">				width: 11px;</span></span><br><span class="line"><span class="string">				height: 11px;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">			&amp;::-webkit-scrollbar-track &#123;</span></span><br><span class="line"><span class="string">				background-color: #F5F5F5;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">			&amp;::-webkit-scrollbar-thumb &#123;</span></span><br><span class="line"><span class="string">				min-height: 36px;</span></span><br><span class="line"><span class="string">				border: 2px solid transparent;</span></span><br><span class="line"><span class="string">				border-top: 3px solid transparent;</span></span><br><span class="line"><span class="string">				border-bottom: 3px solid transparent;</span></span><br><span class="line"><span class="string">				background-clip: padding-box;</span></span><br><span class="line"><span class="string">				border-radius: 7px;</span></span><br><span class="line"><span class="string">				background-color: #C4C4C4;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">		.atwho-ul &#123;</span></span><br><span class="line"><span class="string">			list-style: none;</span></span><br><span class="line"><span class="string">			padding: 0;</span></span><br><span class="line"><span class="string">			margin: 0;</span></span><br><span class="line"><span class="string">			li &#123;</span></span><br><span class="line"><span class="string">				box-sizing: border-box;</span></span><br><span class="line"><span class="string">				display: block;</span></span><br><span class="line"><span class="string">				height: 25px;</span></span><br><span class="line"><span class="string">				padding: 2px 10px;</span></span><br><span class="line"><span class="string">				white-space: nowrap;</span></span><br><span class="line"><span class="string">				display: flex;</span></span><br><span class="line"><span class="string">				align-items: center;</span></span><br><span class="line"><span class="string">				justify-content: space-between;</span></span><br><span class="line"><span class="string">				&amp;.atwho-cur &#123;</span></span><br><span class="line"><span class="string">					background: #f2f2f5;</span></span><br><span class="line"><span class="string">					color: #eb7350;</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">				span &#123;</span></span><br><span class="line"><span class="string">					overflow: hidden;</span></span><br><span class="line"><span class="string">					text-overflow: ellipsis;</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">				img &#123;</span></span><br><span class="line"><span class="string">					height: 13px;</span></span><br><span class="line"><span class="string">					width: 13px;</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">		.editor &#123;</span></span><br><span class="line"><span class="string">			width: 100%;</span></span><br><span class="line"><span class="string">			color: blue;</span></span><br><span class="line"><span class="string">			height: 160px;</span></span><br><span class="line"><span class="string">			display: block;</span></span><br><span class="line"><span class="string">			box-sizing: border-box;</span></span><br><span class="line"><span class="string">			padding: 8px;</span></span><br><span class="line"><span class="string">			font-size: 14px;</span></span><br><span class="line"><span class="string">			background: white;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"atuser"</span>&gt;</span><br><span class="line">		&lt;at :members=<span class="string">"members"</span> @enterSend=<span class="string">"send"</span> v-model=<span class="string">"inputcontent"</span> @cursorRect=<span class="string">"cursorRect"</span>&gt;</span><br><span class="line">		&lt;<span class="regexp">/at&gt;</span></span><br><span class="line"><span class="regexp">	&lt;/</span>div&gt;</span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">	import at from './</span>atuser.vue<span class="string">'</span></span><br><span class="line"><span class="string">	export default &#123;</span></span><br><span class="line"><span class="string">		data() &#123;</span></span><br><span class="line"><span class="string">			return &#123;</span></span><br><span class="line"><span class="string">				members: [123, 12, 1234, 12345, "小花", "小花华", "小三"],</span></span><br><span class="line"><span class="string">				inputcontent: "" //用户输入内容初始值</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">			&#125;;</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		components: &#123;</span></span><br><span class="line"><span class="string">			at,</span></span><br><span class="line"><span class="string">		&#125;,</span></span><br><span class="line"><span class="string">		methods: &#123;</span></span><br><span class="line"><span class="string">			send(e) &#123; //回车发送</span></span><br><span class="line"><span class="string">				console.log(e)</span></span><br><span class="line"><span class="string">			&#125;,</span></span><br><span class="line"><span class="string">			cursorRect(val)&#123;</span></span><br><span class="line"><span class="string">				console.log("当前光标点击位置：")</span></span><br><span class="line"><span class="string">				console.log(val)</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;style scoped="scoped" lang="less"&gt;</span></span><br><span class="line"><span class="string">	.atuser &#123;</span></span><br><span class="line"><span class="string">		width: 700px;</span></span><br><span class="line"><span class="string">		height: 160px;</span></span><br><span class="line"><span class="string">		border: 1px solid red;</span></span><br><span class="line"><span class="string">		.editor&#123;</span></span><br><span class="line"><span class="string">			width: 700px;</span></span><br><span class="line"><span class="string">			height: 160px;</span></span><br><span class="line"><span class="string">			overflow: hidden;</span></span><br><span class="line"><span class="string">			border: 0px;</span></span><br><span class="line"><span class="string">			outline: none;</span></span><br><span class="line"><span class="string">			resize: none;</span></span><br><span class="line"><span class="string">	       -webkit-appearance: none;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/15/Blob进行文件上传/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/15/Blob进行文件上传/" itemprop="url">Blob进行文件上传</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-15T15:42:38+08:00">
                2018-12-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="BLOB-binary-large-object"><a href="#BLOB-binary-large-object" class="headerlink" title="BLOB (binary large object)"></a>BLOB (binary large object)</h2><blockquote>
<p>二进制大对象，是一个可以存储二进制文件的容器。</p>
</blockquote>
<p>Blob，Binary Large Object的缩写，二进制类型的大对象，代表不可改变的原始数据<br>在计算机中，BLOB常常是数据库中用来存储二进制文件的字段类型。</p>
<ul>
<li>Blob基本用法</li>
<li>Blob对象</li>
</ul>
<p>Blob对象指的是字节序列，并且具有size属性，是字节序列中的字节总数，和一个type属性，它是小写的ASCII编码的字符串表示的媒体类型字节序列。</p>
<ul>
<li>size:以字节数返回字节序列的大小。获取时，符合要求的用户代理必须返回一个FileReader或一个FileReaderSync对象可以读取的总字节数，如果Blob没有要读取的字节，则返回0 。</li>
<li>type:小写的ASCII编码字符串表示媒体类型Blob。在获取时，用户代理必须Blob以小写形式返回a类型的ASCII编码字符串，这样当它转换为字节序列时，它是可解析的MIME类型，或者是空字符串（0字节）如果是类型无法确定。<br>构造函数<br>创建blob对象本质上和创建一个其他对象的方式是一样的，都是使用Blob() 的构造函数来进行创建。 构造函数接受两个参数：</li>
</ul>
<p>第一个参数为一个数据序列，格式可以是ArrayBuffer, ArrayBufferView, Blob, DOMString<br>第二个参数是一个包含以下两个属性的对象</p>
<ul>
<li>type: MIME的类型,</li>
<li>endings: 决定第一个参数的数据格式。默认值为”transparent”，用于指定包含行结束符n的字符串如何被写入。 它是以下两个值中的一个： “native”，表示行结束符会被更改为适合宿主操作系统文件系统的换行符； “transparent”，表示会保持blob中保存的结束符不变。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data1 = <span class="string">"a"</span>;</span><br><span class="line"><span class="keyword">var</span> blob1 = <span class="keyword">new</span> Blob([data1]);</span><br><span class="line"><span class="built_in">console</span>.log(blob1); <span class="comment">//输出：Blob &#123;size: 1, type: ""&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> debug = &#123;<span class="attr">hello</span>: <span class="string">"world"</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> blob = <span class="keyword">new</span> Blob([<span class="built_in">JSON</span>.stringify(debug, <span class="literal">null</span>, <span class="number">2</span>)],&#123;<span class="attr">type</span> : <span class="string">'application/json'</span>&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(blob) <span class="comment">// 输出 Blob(22) &#123;size: 22, type: "application/json"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个8字节的ArrayBuffer，在其上创建一个每个数组元素为2字节的“视图”</span></span><br><span class="line"><span class="keyword">var</span> abf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>)</span><br><span class="line"><span class="keyword">var</span> abv = <span class="keyword">new</span> <span class="built_in">Int16Array</span>(abf)</span><br><span class="line"><span class="keyword">var</span> bolb_ArrayBuffer = <span class="keyword">new</span> Blob(abv, &#123;<span class="attr">type</span> : <span class="string">'text/plain'</span>&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(bolb_ArrayBuffer) <span class="comment">//输出 Blob(4) &#123;size: 4, type: "text/plain"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//window.atob 对用base-64编码过的字符串进行解码 。你可以使用 window.btoa() 方法来编码一个可能在传输过程中出现问题的数据，并且在接受数据之后，使用 atob() 方法再将数据解码。</span></span><br><span class="line"><span class="keyword">let</span> encodedData = <span class="built_in">window</span>.btoa(<span class="string">"Hello, world"</span>); <span class="comment">// 编码 "SGVsbG8sIHdvcmxk"</span></span><br><span class="line"><span class="keyword">let</span> decodedData = <span class="built_in">window</span>.atob(encodedData); <span class="comment">// 解码 "Hello, world"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> blob = <span class="keyword">new</span> Blob([<span class="string">"Hello World!"</span>],&#123;<span class="attr">type</span>:<span class="string">"text/plain"</span>&#125;);  <span class="comment">//Blob(12) &#123;size: 12, type: "text/plain"&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * dataURL to blob</span></span><br><span class="line"><span class="comment"> * @param dataURI</span></span><br><span class="line"><span class="comment"> * @returns &#123;Blob&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dataURItoBlob</span>(<span class="params">dataURI</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> byteString = atob(dataURI.split(<span class="string">','</span>)[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">var</span> mimeString = dataURI.split(<span class="string">','</span>)[<span class="number">0</span>].split(<span class="string">':'</span>)[<span class="number">1</span>].split(<span class="string">';'</span>)[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">var</span> ab = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(byteString.length);</span><br><span class="line">    <span class="keyword">var</span> ia = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(ab);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; byteString.length; i++) &#123;</span><br><span class="line">        ia[i] = byteString.charCodeAt(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Blob([ab], &#123;<span class="attr">type</span>: mimeString&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// atob() 将base64解码</span></span><br><span class="line"><span class="comment">// btoa() 将字符串转码为base64</span></span><br><span class="line"><span class="keyword">var</span> str = <span class="string">'javascript'</span>;</span><br><span class="line"><span class="built_in">window</span>.btoa(str)</span><br><span class="line"><span class="comment">//转码结果 "amF2YXNjcmlwdA=="</span></span><br><span class="line"><span class="built_in">window</span>.atob(<span class="string">"amF2YXNjcmlwdA=="</span>)</span><br><span class="line"><span class="comment">//解码结果 "javascript"</span></span><br></pre></td></tr></table></figure>
<h2 id="Blob-URL和Data-URL的区别"><a href="#Blob-URL和Data-URL的区别" class="headerlink" title="Blob URL和Data URL的区别"></a>Blob URL和Data URL的区别</h2><blockquote>
<p>Blob URL</p>
</blockquote>
<p><img src="/2018/12/15/Blob进行文件上传/2.png" alt=""></p>
<blockquote>
<p>Data URL</p>
</blockquote>
<p><img src="/2018/12/15/Blob进行文件上传/3.png" alt=""></p>
<p>Blob URL的长度一般比较短，但Data URL因为直接存储图片base64编码后的数据，往往很长，如上图所示，浏览器在显示Data URL时使用了省略号（…）。当显式大图片时，使用Blob URL能获取更好的可能性。<br>Blob URL可以方便的使用XMLHttpRequest获取源数据,比如设置XMLHttpRequest返回的数据类型为blob<br>Blob URL 只能在当前应用内部使用，把Blob URL复制到浏览器的地址栏中，是无法获取数据的。Data URL相比之下，就有很好的移植性，可以在任意浏览器中使用。</p>
<h2 id="Blob上传文件预览"><a href="#Blob上传文件预览" class="headerlink" title="Blob上传文件预览"></a>Blob上传文件预览</h2><p><img src="/2018/12/15/Blob进行文件上传/1.png" alt=""><br><img src="/2018/12/15/Blob进行文件上传/4.png" alt=""><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">			body &#123;</span></span><br><span class="line"><span class="undefined">				background:palegreen;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			div&#123;</span></span><br><span class="line"><span class="undefined">				float: left;</span></span><br><span class="line"><span class="undefined">				margin-left: 50px;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">h3</span>&gt;</span>默认<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"sample1"</span> <span class="attr">img2blob</span>=<span class="string">"img/1.png"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">h3</span>&gt;</span>加水印<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"sample2"</span> <span class="attr">img2blob</span>=<span class="string">"img/2.jpg"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="function"><span class="keyword">function</span> <span class="title">img2blob</span>(<span class="params">imgUrl, obj = &#123;&#125;</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> b = &#123;</span></span><br><span class="line"><span class="javascript">					watermark: <span class="string">''</span>,</span></span><br><span class="line"><span class="javascript">					fontStyle: <span class="string">'Arial'</span>,</span></span><br><span class="line"><span class="javascript">					fontSize: <span class="string">'30'</span>,</span></span><br><span class="line"><span class="javascript">					fontColor: <span class="string">'black'</span>,</span></span><br><span class="line"><span class="undefined">					fontX: 10,</span></span><br><span class="line"><span class="undefined">					fontY: 50</span></span><br><span class="line"><span class="undefined">				&#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> d = imgUrl.getAttribute(<span class="string">'img2blob'</span>),</span></span><br><span class="line"><span class="javascript">					a = <span class="built_in">Object</span>.assign(b, obj),</span></span><br><span class="line"><span class="javascript">					f = <span class="keyword">new</span> Image();</span></span><br><span class="line"><span class="undefined">				f.src = d;</span></span><br><span class="line"><span class="javascript">				f.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> g = <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>);</span></span><br><span class="line"><span class="undefined">					g.width = f.naturalWidth;</span></span><br><span class="line"><span class="undefined">					g.height = f.naturalHeight;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> h = g.getContext(<span class="string">'2d'</span>);</span></span><br><span class="line"><span class="undefined">					h.drawImage(f, 0, 0);</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(a.watermark != <span class="string">''</span>) &#123;</span></span><br><span class="line"><span class="javascript">						h.font = a.fontSize + <span class="string">'px '</span> + a.fontStyle;</span></span><br><span class="line"><span class="undefined">						h.fillStyle = a.fontColor;</span></span><br><span class="line"><span class="undefined">						h.fillText(a.watermark, a.fontX, a.fontY);</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> j = g.toDataURL(<span class="string">'image/png'</span>),</span></span><br><span class="line"><span class="undefined">						k = DataUriToBinary(j),</span></span><br><span class="line"><span class="javascript">						l = <span class="keyword">new</span> Blob([k], &#123;</span></span><br><span class="line"><span class="javascript">							type: <span class="string">'image/png'</span></span></span><br><span class="line"><span class="undefined">						&#125;),</span></span><br><span class="line"><span class="javascript">						m = <span class="built_in">window</span>.URL.createObjectURL(l);</span></span><br><span class="line"><span class="javascript">					imgUrl.setAttribute(<span class="string">'src'</span>, m)</span></span><br><span class="line"><span class="javascript">					<span class="built_in">console</span>.log(m)</span></span><br><span class="line"><span class="undefined">				&#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="function"><span class="keyword">function</span> <span class="title">DataUriToBinary</span>(<span class="params">n</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> o = <span class="string">';base64,'</span>,</span></span><br><span class="line"><span class="undefined">					p = n.indexOf(o) + o.length,</span></span><br><span class="line"><span class="undefined">					q = n.substring(p),</span></span><br><span class="line"><span class="javascript">					r = <span class="built_in">window</span>.atob(q),</span></span><br><span class="line"><span class="undefined">					s = r.length,</span></span><br><span class="line"><span class="javascript">					t = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(<span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(s));</span></span><br><span class="line"><span class="javascript">				<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; s; i++) &#123;</span></span><br><span class="line"><span class="undefined">					t[i] = r.charCodeAt(i);</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">return</span> t;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			img2blob(<span class="built_in">document</span>.querySelector(<span class="string">".sample1"</span>))</span></span><br><span class="line"><span class="javascript">			img2blob(<span class="built_in">document</span>.querySelector(<span class="string">".sample2"</span>), &#123;</span></span><br><span class="line"><span class="javascript">				watermark: <span class="string">'@Blob测试'</span>,</span></span><br><span class="line"><span class="javascript">				fontStyle: <span class="string">'Arial'</span>,</span></span><br><span class="line"><span class="javascript">				fontSize: <span class="string">'30'</span>, <span class="comment">// px</span></span></span><br><span class="line"><span class="javascript">				fontColor: <span class="string">'#ff0000'</span>, <span class="comment">// default 'black'</span></span></span><br><span class="line"><span class="javascript">				fontX: <span class="number">30</span>, <span class="comment">// The x coordinate where to start painting the text</span></span></span><br><span class="line"><span class="javascript">				fontY: <span class="number">50</span> <span class="comment">// The y coordinate where to start painting the text</span></span></span><br><span class="line"><span class="undefined">			&#125;)</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="DataURI（base64）对象转blob对象（二进制）"><a href="#DataURI（base64）对象转blob对象（二进制）" class="headerlink" title="DataURI（base64）对象转blob对象（二进制）"></a>DataURI（base64）对象转blob对象（二进制）</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 工具方法：dataURL(base64字符串)转换为Blob对象（二进制大对象） */</span></span><br><span class="line"><span class="comment">//data:image/png;base64,iVBORw0KGgoAAAANSUhEUg......</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dataURLtoBlob</span>(<span class="params">dataurl</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> arr = dataurl.split(<span class="string">','</span>);</span><br><span class="line">    <span class="keyword">var</span> mime = arr[<span class="number">0</span>].match(<span class="regexp">/:(.*?);/</span>)[<span class="number">1</span>];<span class="comment">// 结果：   image/png</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"arr[0]===="</span> + <span class="built_in">JSON</span>.stringify(arr[<span class="number">0</span>]));<span class="comment">//   "data:image/png;base64"</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"arr[0].match(/:(.*?);/)===="</span> + arr[<span class="number">0</span>].match(<span class="regexp">/:(.*?);/</span>));<span class="comment">// :image/png;,image/png</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"arr[0].match(/:(.*?);/)[1]===="</span> + arr[<span class="number">0</span>].match(<span class="regexp">/:(.*?);/</span>)[<span class="number">1</span>]);<span class="comment">//   image/png</span></span><br><span class="line">    <span class="keyword">var</span> bstr = atob(arr[<span class="number">1</span>].replace(<span class="regexp">/\s/g</span>, <span class="string">''</span>));</span><br><span class="line">    <span class="keyword">var</span> n = bstr.length;</span><br><span class="line">    <span class="keyword">var</span> u8arr = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(n);</span><br><span class="line">    <span class="keyword">while</span> (n--) &#123;</span><br><span class="line">        u8arr[n] = bstr.charCodeAt(n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Blob([u8arr], &#123;<span class="attr">type</span>: mime&#125;);   <span class="comment">//值，类型</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">DataUriToBinary</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> o = <span class="string">';base64,'</span>,</span><br><span class="line">		p = n.indexOf(o) + o.length,</span><br><span class="line">		q = n.substring(p),</span><br><span class="line">		r = <span class="built_in">window</span>.atob(q),</span><br><span class="line">		s = r.length,</span><br><span class="line">		t = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(<span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(s));</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; s; i++) &#123;</span><br><span class="line">		t[i] = r.charCodeAt(i);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/05/ES6模拟call-apply-bind/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/05/ES6模拟call-apply-bind/" itemprop="url">ES6模拟call,apply,bind</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-05T20:06:26+08:00">
                2018-12-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="ES6自己实现"><a href="#ES6自己实现" class="headerlink" title="ES6自己实现"></a>ES6自己实现</h3><blockquote>
<p>call</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.call2 = <span class="function"><span class="keyword">function</span>(<span class="params">context,...list</span>) </span>&#123;</span><br><span class="line">	context = context || <span class="built_in">window</span>;</span><br><span class="line">	context.fn = <span class="keyword">this</span>;			 </span><br><span class="line">	<span class="keyword">let</span> result = context.fn(...list);</span><br><span class="line">	<span class="keyword">delete</span> context.fn</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> value = <span class="string">"JS"</span>;</span><br><span class="line"><span class="keyword">var</span> foo = &#123;</span><br><span class="line">	value: <span class="string">"Node"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params">...list</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="keyword">this</span>.value);</span><br><span class="line">	<span class="built_in">console</span>.log(list)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bar.call2(foo,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line">bar.call2(<span class="literal">null</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>);</span><br><span class="line">bar.call2(<span class="literal">undefined</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>apply</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.apply2 = <span class="function"><span class="keyword">function</span>(<span class="params">context,arr</span>) </span>&#123;</span><br><span class="line">	context = context || <span class="built_in">window</span>;</span><br><span class="line">	context.fn = <span class="keyword">this</span>;			 </span><br><span class="line">	<span class="keyword">let</span> result = context.fn(...arr);</span><br><span class="line">	<span class="keyword">delete</span> context.fn</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> value = <span class="string">"JS"</span>;</span><br><span class="line"><span class="keyword">var</span> foo = &#123;</span><br><span class="line">	value: <span class="string">"Node"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params">...list</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="keyword">this</span>.value);</span><br><span class="line">	<span class="built_in">console</span>.log(list)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bar.apply2(foo,[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]);</span><br><span class="line">bar.apply2(<span class="literal">null</span>,[<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>]);</span><br><span class="line">bar.apply2(<span class="literal">undefined</span>,[<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>]);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>bind1</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.bind1 = <span class="function"><span class="keyword">function</span>(<span class="params">context, ...arr1</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> func = <span class="keyword">this</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">...arr2</span>) </span>&#123;</span><br><span class="line">	</span><br><span class="line">		<span class="comment">//func.apply(context, [...arr1, ...arr2]);</span></span><br><span class="line">		</span><br><span class="line">		func.call(context, ...arr1, ...arr2);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> value = <span class="string">"JS"</span>;</span><br><span class="line"><span class="keyword">var</span> foo = &#123;</span><br><span class="line">	value: <span class="string">"Node"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params">...list</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="keyword">this</span>.value);</span><br><span class="line">	<span class="built_in">console</span>.log(list)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bar.bind1(foo, <span class="number">1</span>, <span class="number">2</span>)(<span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line">bar.bind1(<span class="literal">null</span>, <span class="number">5</span>, <span class="number">6</span>)(<span class="number">7</span>, <span class="number">8</span>);</span><br><span class="line">bar.bind1(<span class="literal">null</span>)(<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>);</span><br><span class="line">bar.bind1(<span class="literal">undefined</span>)(<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>bind2</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.bind2 = <span class="function"><span class="keyword">function</span>(<span class="params">context, ...arr1</span>) </span>&#123;</span><br><span class="line">	context = context || <span class="built_in">window</span>;</span><br><span class="line">	context.fn = <span class="keyword">this</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">...arr2</span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> context.fn(...arr1, ...arr2);</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> value = <span class="string">"JS"</span>;</span><br><span class="line"><span class="keyword">var</span> foo = &#123;</span><br><span class="line">	value: <span class="string">"Node"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params">...list</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="keyword">this</span>.value);</span><br><span class="line">	<span class="built_in">console</span>.log(list)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bar.bind2(foo, <span class="number">1</span>, <span class="number">2</span>)(<span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line">bar.bind2(<span class="literal">null</span>, <span class="number">5</span>, <span class="number">6</span>)(<span class="number">7</span>, <span class="number">8</span>);</span><br><span class="line">bar.bind2(<span class="literal">null</span>)(<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>);</span><br><span class="line">bar.bind2(<span class="literal">undefined</span>)(<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>);</span><br></pre></td></tr></table></figure>
<h3 id="有什么问题？"><a href="#有什么问题？" class="headerlink" title="有什么问题？"></a>有什么问题？</h3><p>前面我们用的 eval 方式可以用 ES6 的解决还存在的一些问题，有没有注意到，这段代码是有问题的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.fn = this;</span><br></pre></td></tr></table></figure></p>
<p><strong> 假如对象在被 call 调用前，已经有 fn 属性怎么办？ </strong></p>
<p>ES6 中提供了一种新的基本数据类型，Symbol，表示独一无二的值，另外，Symbol 作为属性的时候，不能使用点运算符。所以再加上 ES 的 rest 剩余参数替代 arguments 遍历的工作就有：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.newCall = <span class="function"><span class="keyword">function</span> (<span class="params">context,...params</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> context === <span class="string">'object'</span>) &#123;</span><br><span class="line">        context = context || <span class="built_in">window</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        context = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> fn = <span class="built_in">Symbol</span>();</span><br><span class="line">    context[fn] = thisvar result = context[fn](...params);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> context.fn;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">    name: <span class="string">"jayChou"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">functionsay(age, sex) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`name: <span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>,age: <span class="subst">$&#123;age&#125;</span>, sex: <span class="subst">$&#123;sex&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> age + sex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> check = say.newCall(person, <span class="number">18</span>, <span class="string">'男'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(check); <span class="comment">// 18男</span></span><br></pre></td></tr></table></figure>
<p>apply 和 call 的实现原理，基本类似，区别在于 apply 的参数是以数组的形式传入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.newApply = <span class="function"><span class="keyword">function</span>(<span class="params">context, parameter</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> context === <span class="string">'object'</span>) &#123;</span><br><span class="line">    context = context || <span class="built_in">window</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    context = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> fn = <span class="built_in">Symbol</span>()</span><br><span class="line">  context[fn] = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">var</span> result = context[fn](...parameter);</span><br><span class="line">  <span class="keyword">delete</span> context[fn];</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/01/JS尾递归/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/01/JS尾递归/" itemprop="url">JS尾递归</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-01T19:11:17+08:00">
                2018-12-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="源于前端群里面的一道社招笔试题"><a href="#源于前端群里面的一道社招笔试题" class="headerlink" title="源于前端群里面的一道社招笔试题"></a>源于前端群里面的一道社招笔试题</h3><blockquote>
<p>实现一个斐波拉契数列， 已知第一项为0，第二项为1，第三项为1，后一项是前两项之和,如下，即<code>f(n) = f(n - 1) + f(n -2)</code>。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0, 1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610, 987, ...</span><br></pre></td></tr></table></figure>
<p>拿到这个题目，二话没想就写了,扔到群里<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function f(n) &#123;</span><br><span class="line">    if(n === 0) return0;</span><br><span class="line">    if(n === 1) return1;</span><br><span class="line">    return f(n - 1) + f(n -2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>群里有大神提醒这个题放到社招题里面明显没这么简单，每次递归调用都会呈指数往调用栈里增加记录<code>调用帧</code>，这样做，当项比较多，就会出现<code>栈溢出</code>的！！！</p>
<p>也就是，以上Code只能说刚刚及格，正确姿势应该用<strong>尾递归优化</strong>，<code>调用帧</code>保持只有一个。</p>
<blockquote>
<p>正解就是：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function f(n, prev, next) &#123;</span><br><span class="line">    if(n &lt;= 1) &#123;</span><br><span class="line">        return next;</span><br><span class="line">    &#125;</span><br><span class="line">    return f(n - 1, next, prev + next);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面来复习一下知识点：尾调用和尾递归。</p>
<h3 id="尾调优化"><a href="#尾调优化" class="headerlink" title="尾调优化"></a>尾调优化</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// 尾递归方式</span><br><span class="line">function factorial1(n,total) &#123;</span><br><span class="line">    if (n === 1) &#123;</span><br><span class="line">        return total;</span><br><span class="line">    &#125;</span><br><span class="line">    return factorial1(n - 1, n * total);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 普通递归方式</span><br><span class="line">function factorial2(n) &#123;</span><br><span class="line">    if (n === 1) &#123;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line">    return n * factorial2(n - 1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">console.log(factorial1(25,1)); // 1.5511210043330984e+25 </span><br><span class="line">console.log(factorial2(25)); // 1.5511210043330986e+25</span><br></pre></td></tr></table></figure>
<p>在知道尾递归之前，我们要直到什么是尾调用优化，因为尾调用优化是尾递归的基础。<br><strong>尾调用就是：在函数的最后一步调用另一个函数。</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function f() &#123;</span><br><span class="line">  return g()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>最后一步必须是调用另一函数，而不能是一个常量或是一个表达式，如 <code>return y</code>或 <code>return g() + 1</code></strong></p>
</blockquote>
<h4 id="尾调用优化的原理是什么？"><a href="#尾调用优化的原理是什么？" class="headerlink" title="尾调用优化的原理是什么？"></a>尾调用优化的原理是什么？</h4><p>按照<a href="http://es6.ruanyifeng.com/#docs/function#%E5%B0%BE%E8%B0%83%E7%94%A8%E4%BC%98%E5%8C%96" target="_blank" rel="noopener">阮一峰老师在es6的函数扩展</a>中的解释就是：</p>
<p>尾调用之所以与其他调用不同，就在于它的特殊的调用位置。</p>
<p><span style="border-bottom:2px solid red;">我们知道，函数调用会在内存形成一个“调用记录”，又称“调用帧”（call frame），保存调用位置和内部变量等信息。如果在函数A的内部调用函数B，那么在A的调用帧上方，还会形成一个B的调用帧。等到B运行结束，将结果返回到A，B的调用帧才会消失。如果函数B内部还调用函数C，那就还有一个C的调用帧，以此类推。所有的调用帧，就形成一个“调用栈”（call stack）。</span></p>
<p><font color="#dd0000"><strong> 尾调用由于是函数的最后一步操作，所以不需要保留外层函数的调用帧，因为调用位置、内部变量等信息都不会再用到了，只要直接用内层函数的调用帧，取代外层函数的调用帧就可以了。</strong></font><br> </p>
<p>这里的“调用帧”和“调用栈”，说的应该就是“执行环境”和“作用域链”。因为尾调用时函数的最后一部操作，所以不再需要保留外层的调用帧，而是直接取代外层的调用帧，所以可以起到一个优化的作用。</p>
<h3 id="尾调用"><a href="#尾调用" class="headerlink" title="尾调用"></a>尾调用</h3><p>尾调用是指某个函数的最后一步是调用另一个函数。  </p>
<p>尾调用之所以与其他调用不同，就在于它的特殊的调用位置。</p>
<p>以下三种情况都不是尾调用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// 情况一</span><br><span class="line">function f(x) &#123;</span><br><span class="line">    let y = g(x);</span><br><span class="line">    return y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 情况二</span><br><span class="line">function f(x) &#123;</span><br><span class="line">    return g(x) + 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 情况三</span><br><span class="line">function f(x) &#123;</span><br><span class="line">    g(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>情况一是调用函数<code>g</code>之后，还有赋值操作，所以不属于尾调用，即使语义完全一样。情况二也是属于调用后还有操作。情况三等同于：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">g(x);</span><br><span class="line">return undefined;</span><br></pre></td></tr></table></figure></p>
<p>函数调用会在内存形成一个“调用记录”，又称“调用帧”，保存调用位置和内存变量等信息。如果在函数<code>A</code>的内部调用函数<code>B</code>，那么在<code>A</code>的调用帧上方，还会形成一个<code>B</code>的调用帧。等到<code>B</code>运行结束，将结果返回到<code>A</code>，<code>B</code>的调用帧才会消失。如果函数<code>B</code>内部还调用函数<code>C</code>，那就还有一个<code>C</code>的调用帧，依次类推。所有的调用帧，就形成一个“调用栈”。</p>
<p>尾调用由于是函数的最后一步操作，所有不需要保留外层函数的调用帧，因为调用位置、内部变量等信息都不会再用到了，只要直接用内层函数的调用帧，取代外层函数的调用帧就可以了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function f() &#123;</span><br><span class="line">    let m = 1;</span><br><span class="line">    let n = 2;</span><br><span class="line">    return g(m + n);</span><br><span class="line">&#125;</span><br><span class="line">f();</span><br><span class="line"></span><br><span class="line">// 等同于</span><br><span class="line">function f() &#123;</span><br><span class="line">    return g(3);</span><br><span class="line">&#125;</span><br><span class="line">f();</span><br><span class="line"></span><br><span class="line">// 等同于</span><br><span class="line">g(3);</span><br></pre></td></tr></table></figure></p>
<p>上面代码中，如果函数g不是尾调用，函数f就需要保存内部变量m和n的值、g的调用位置等信息。但由于调用g之后，函数f就结束了，所以执行到最后一步，完全可以删除f(x)的调用帧，只保留g(3)的调用帧。</p>
<p>这就叫做“尾调用优化”（Tail call optimization），即只保留内层函数的调用帧。如果所有函数都是尾调用，那么完全可以做到每次执行时，调用帧只有一项，这将大大节省内存。这就是“尾调用优化”的意义。</p>
<p>如果所有函数都是尾调用，那么完全可以做到每次执行时，调用帧只有一项，这将大大节省内存。这就是“尾调用优化”。</p>
<p><strong>注意</strong>:只有不再用到外层函数的内部变量，内层函数的调用帧才会取代外层函数的调用帧，否则就无法进行“尾调用优化”。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function addOne(a) &#123;</span><br><span class="line">    var one = 1;</span><br><span class="line">    function inner(b) &#123;</span><br><span class="line">        return b + one;</span><br><span class="line">    &#125;</span><br><span class="line">    return inner(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<table><tr><td bgcolor="#C0FF3E"><font color="#dd0000"> 上面的函数不会进行尾调用优化，因为内层函数inner用到了外层函数addOne的内部变量one。这一是闭包常驻内存的原因！！！</font></td></tr></table>

<h3 id="尾递归"><a href="#尾递归" class="headerlink" title="尾递归"></a>尾递归</h3><p><span style="border-bottom:2px solid red;">函数调用自身，称为递归。如果尾调用自身，就称为尾递归。</span></p>
<p><span style="border-bottom:2px solid red;">递归非常耗费内存，因为需要同时保存成百上千调用帧，很容易发生“栈溢出”错误。但对于尾递归来说，由于只存在一个调用帧，所以永远不会发生“栈溢出”错误。</span><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function factorial(n) &#123;</span><br><span class="line">    if (n === 1) return1;</span><br><span class="line">    return n * factorial(n - 1);</span><br><span class="line">&#125;</span><br><span class="line">console.log(factorial(5)); // 120</span><br></pre></td></tr></table></figure></p>
<p>上面最多保存<code>n</code>个调用记录，复杂度是<code>O(n)</code>。</p>
<p>如果改成尾递归，只保留一个调用记录，复杂度<code>O(1)</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function factorial(n, total) &#123;</span><br><span class="line">    if (n === 0) return total;</span><br><span class="line">    return factorial(n - 1, n * total);</span><br><span class="line">&#125;</span><br><span class="line">console.log(factorial(5, 1)); // 120</span><br></pre></td></tr></table></figure></p>
<p>下面回到我们的主题，计算Fibonacci数列。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function fibonacci(n) &#123;</span><br><span class="line">    if(n &lt;= 1) return 1;</span><br><span class="line">    return fibonacci(n -1) + fibonacci(n -2);</span><br><span class="line">&#125;</span><br><span class="line">console.log(fibonacci(10)); // 89</span><br><span class="line">console.log(fibonacci(50)); // stack overflow</span><br></pre></td></tr></table></figure></p>
<p>上面不使用尾递归，项数稍大点就发生”栈溢出“了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function fibonacci(n, prev, next) &#123;</span><br><span class="line">    if(n &lt;= 1) return next;</span><br><span class="line">    return fibonacci(n-1, next, prev + next);</span><br><span class="line">&#125;</span><br><span class="line">console.log(fibonacci(10, 1, 1)); // 89</span><br><span class="line">console.log(fibonacci(100, 1, 1)); // 573147844013817200000</span><br><span class="line">console.log(fibonacci(1000, 1, 1)); // 7.0330367711422765e+208</span><br></pre></td></tr></table></figure></p>
<p>上面项数再大都状态良好。</p>
<h3 id="柯理化改写"><a href="#柯理化改写" class="headerlink" title="柯理化改写"></a>柯理化改写</h3><p>尾递归的实现，往往需要改写递归函数，确保最后一步只调用自身。做到这一点的方法，就是把所有用到的内部变量改写成函数的参数。但是这样的话就会增加初始入参，比如<code>fibonacci(10, 1, 1)</code>，后面的两个参数<code>1</code>和<code>1</code>意思不明确，直接用<code>fibonacci(100)</code>才是习惯用法。所以需要在中间预先设置好初始入参，将多个入参转化成单个入参的形式，叫做函数柯理化。通用方式为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function curry(fn) &#123;</span><br><span class="line">    var args = Array.prototype.slice.call(arguments, 1);</span><br><span class="line">    return function() &#123;</span><br><span class="line">        var innerArgs = Array.prototype.slice.call(arguments);</span><br><span class="line">        var finalArgs = innerArgs.concat(args);</span><br><span class="line">        return fn.apply(null, finalArgs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>用函数柯理化改写阶乘<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function tailFactorial(n, total) &#123;</span><br><span class="line">    if(n === 1) return total;</span><br><span class="line">    return tailFactorial(n - 1, n * total);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var factorial = curry(tailFactorial, 1); </span><br><span class="line">console.log(factorial(5)); // 120</span><br></pre></td></tr></table></figure></p>
<p>同样改写斐波拉契数列<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function tailFibonacci(n, prev, next) &#123;</span><br><span class="line">    if(n &lt;= 1) return next;</span><br><span class="line">    return tailFibonacci(n - 1, next, prev + next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var fibonacci = curry(fibonacci, 1, 1);</span><br><span class="line">console.log(fibonacci(10)); // 89</span><br><span class="line">console.log(fibonacci(100)); // 573147844013817200000</span><br><span class="line">console.log(fibonacci(1000)); // 7.0330367711422765e+208</span><br></pre></td></tr></table></figure></p>
<h3 id="ES6改写"><a href="#ES6改写" class="headerlink" title="ES6改写"></a>ES6改写</h3><p>柯理化的过程其实是初始化一些参数的过程，在ES6中，是可以直接函数参数默认赋值的。</p>
<p>用ES6改写阶乘<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const factorial = (n, total = 1) =&gt; &#123;</span><br><span class="line">    if(n === 1) return total;</span><br><span class="line">    return factorial(n - 1, n * total);</span><br><span class="line">&#125;</span><br><span class="line">console.log(factorial(5)); // 120</span><br></pre></td></tr></table></figure></p>
<p>用ES6改写斐波拉契数列<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const fibonacci = (n, prev = 1, next = 1) =&gt; &#123;</span><br><span class="line">    if(n &lt;= 1) return next;</span><br><span class="line">    return fibonacci(n - 1, next, prev + next);</span><br><span class="line">&#125;</span><br><span class="line">console.log(fibonacci(10)); // 89</span><br><span class="line">console.log(fibonacci(100)); // 573147844013817200000 </span><br><span class="line">console.log(fibonacci(1000)); // 7.0330367711422765e+208</span><br></pre></td></tr></table></figure></p>
<p>用ES6极大方便了算法运用！</p>
<h3 id="严格模式"><a href="#严格模式" class="headerlink" title="严格模式"></a>严格模式</h3><p>ES6 的尾调用优化只在严格模式下开启，正常模式是无效的。</p>
<p>这是因为在正常模式下，函数内部有两个变量，可以跟踪函数的调用栈。</p>
<ul>
<li>func.arguments：返回调用时函数的参数。</li>
<li>func.caller：返回调用当前函数的那个函数。</li>
</ul>
<p>尾调用优化发生时，函数的调用栈会改写，因此上面两个变量就会失真。严格模式禁用这两个变量，所以尾调用模式仅在严格模式下生效。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function restricted() &#123;</span><br><span class="line">  &apos;use strict&apos;;</span><br><span class="line">  restricted.caller;    // 报错</span><br><span class="line">  restricted.arguments; // 报错</span><br><span class="line">&#125;</span><br><span class="line">restricted();</span><br></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>综上，这个问题解决的思路是：</p>
<ol>
<li>尾递归+函数柯理化；</li>
<li>尾递归+ES6默认赋值；</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/30/new原理及模拟实现/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/30/new原理及模拟实现/" itemprop="url">new原理及模拟实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-30T20:28:26+08:00">
                2018-11-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/new" target="_blank" rel="noopener">new 运算符</a>创建一个用户定义的对象类型的实例或具有构造函数的内置对象的实例。</p>
</blockquote>
<p>举个栗子<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Car</span>(<span class="params">color</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.color = color;</span><br><span class="line">&#125;</span><br><span class="line">Car.prototype.start = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.color + <span class="string">" car start"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> car = <span class="keyword">new</span> Car(<span class="string">"black"</span>);</span><br><span class="line">car.color; <span class="comment">// 访问构造函数里的属性</span></span><br><span class="line"><span class="comment">// black</span></span><br><span class="line"></span><br><span class="line">car.start(); <span class="comment">// 访问原型里的属性</span></span><br><span class="line"><span class="comment">// black car start</span></span><br></pre></td></tr></table></figure></p>
<p>可以看出 new 创建的实例有以下 2 个特性</p>
<ul>
<li><p>访问到构造函数里的属性</p>
</li>
<li><p>访问到原型里的属性</p>
</li>
</ul>
<p>注意点</p>
<blockquote>
<p>ES6新增 symbol 类型，不可以使用 new Symbol()，因为 symbol 是基本数据类型，每个从Symbol()返回的 symbol 值都是唯一的。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Number</span>(<span class="string">"123"</span>); <span class="comment">// 123</span></span><br><span class="line"><span class="built_in">String</span>(<span class="number">123</span>); <span class="comment">// "123"</span></span><br><span class="line"><span class="built_in">Boolean</span>(<span class="number">123</span>); <span class="comment">// true</span></span><br><span class="line"><span class="built_in">Symbol</span>(<span class="number">123</span>); <span class="comment">// Symbol(123)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Number</span>(<span class="string">"123"</span>); <span class="comment">// Number &#123;123&#125;</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">String</span>(<span class="number">123</span>); <span class="comment">// String &#123;"123"&#125;</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Boolean</span>(<span class="literal">true</span>); <span class="comment">// Boolean &#123;true&#125;</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Symbol</span>(<span class="number">123</span>); <span class="comment">// Symbol is not a constructor</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>new操作符的工作原理</p>
</blockquote>
<ul>
<li>一个新对象被创建，它继承自func.prototype。</li>
<li>构造函数func 被执行，执行的时候，相应的参数会被传入，同时上下文（this） 会被指定为这个新实例。</li>
<li>如果构造函数返回了一个新对象，那么这个对象会取代整个new出来的结果，如果构造函数没有返回对象，<br>那么new出来的结果为步骤1创建的对象。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">废话不多说，直接上代码</span><br><span class="line"><span class="keyword">var</span> newObj = <span class="function"><span class="keyword">function</span>(<span class="params">func</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> t = &#123;&#125;</span><br><span class="line">    t.prototype = func.prototype</span><br><span class="line">    <span class="keyword">var</span> o = t</span><br><span class="line">    <span class="keyword">var</span> k =func.call(o);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> k === <span class="string">'object'</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> k;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> parent1 = newObj(Parent) <span class="comment">//等价于new操作</span></span><br></pre></td></tr></table></figure>
<p>DEMO:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * new2 new关键字的代码实现演示</span></span><br><span class="line"><span class="comment"> * @param &#123;function&#125; func 被new的类 (构造函数)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">new2</span>(<span class="params">func</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 创建了一个实例对象 o，并且这个对象__proto__指向func这个类的原型对象 </span></span><br><span class="line">    <span class="keyword">let</span> o = <span class="built_in">Object</span>.create(func.prototype); </span><br><span class="line">    <span class="comment">// (在构造函数中this指向当前实例)让这个类作为普通函数值行 并且里面this为实例对象 </span></span><br><span class="line">    <span class="keyword">let</span> k = func.call(o);</span><br><span class="line">    <span class="comment">// 最后再将实例对象返回 如果你在类中显示指定返回值k，</span></span><br><span class="line">    <span class="comment">// 注意如果返回的是引用类型则将默认返回的实例对象o替代掉</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">typeof</span> k === <span class="string">'object'</span> ? k : o;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实验</span></span><br><span class="line">functionM() &#123; <span class="comment">// 即将被new的类</span></span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">'liwenli'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> m = new2(M); <span class="comment">// 等价于 new M 这里只是模拟</span></span><br><span class="line"><span class="built_in">console</span>.log(m <span class="keyword">instanceof</span> M); <span class="comment">// instanceof 检测实例</span></span><br><span class="line"><span class="built_in">console</span>.log(m <span class="keyword">instanceof</span> <span class="built_in">Object</span>);</span><br><span class="line"><span class="built_in">console</span>.log(m.__proto__.constructor === M);</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>Object.create 兼容实现</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj1 = &#123;<span class="attr">id</span>: <span class="number">1</span>&#125;;</span><br><span class="line"><span class="built_in">Object</span>._create = <span class="function">(<span class="params">o</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> Fn = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;; <span class="comment">// 临时的构造函数</span></span><br><span class="line">    Fn.prototype = o;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Fn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj2 = <span class="built_in">Object</span>._create(obj1);</span><br><span class="line"><span class="built_in">console</span>.log(obj2.__proto__ === obj1); <span class="comment">// true</span></span><br><span class="line"><span class="built_in">console</span>.log(obj2.id); <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原生的Object.create</span></span><br><span class="line"><span class="keyword">let</span> obj3 = <span class="built_in">Object</span>.create(obj1);</span><br><span class="line"><span class="built_in">console</span>.log(obj3.__proto__ === obj1); <span class="comment">// true</span></span><br><span class="line"><span class="built_in">console</span>.log(obj3.id); <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>
<p>完整代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">new2</span>(<span class="params">MyFun, ...list</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> o = <span class="built_in">Object</span>.create(MyFun.prototype);</span><br><span class="line">	<span class="keyword">let</span> k = MyFun.call(o, ...list);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">typeof</span> k === <span class="string">'object'</span> ? k : o;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Car</span>(<span class="params">color, name</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.color = color;</span><br><span class="line">	<span class="keyword">this</span>.name = name;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"new car"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Car.prototype.fun=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="keyword">this</span>.color,<span class="keyword">this</span>.name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj=new2(Car,<span class="number">123</span>,<span class="string">'小花'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(obj)</span><br><span class="line"><span class="built_in">console</span>.log(obj.__proto__===Car.prototype);</span><br><span class="line"><span class="built_in">console</span>.log(Car.prototype.isPrototypeOf(obj))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.prototype.isPrototypeOf(obj))</span><br><span class="line"><span class="built_in">console</span>.log(obj <span class="keyword">instanceof</span> Car)</span><br><span class="line"><span class="built_in">console</span>.log(obj.constructor===Car)</span><br></pre></td></tr></table></figure></p>
<p><img src="/2018/11/30/new原理及模拟实现/1.webp" alt=""></p>
<blockquote>
<p><strong>有什么问题？</strong></p>
</blockquote>
<ul>
<li><code>typeof k === &#39;object&#39;</code> 如果k为null怎么办？</li>
<li>MyFun传null，undefined怎么办？</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">new2</span>(<span class="params">MyFun, ...list</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!MyFun)  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"第一个参数必须是函数"</span>);</span><br><span class="line">	<span class="keyword">let</span> o = <span class="built_in">Object</span>.create(MyFun.prototype);</span><br><span class="line">	<span class="keyword">let</span> k = MyFun.call(o, ...list);</span><br><span class="line">	<span class="keyword">return</span> k&amp;&amp;(<span class="keyword">typeof</span> k === <span class="string">'object'</span>) ? k : o;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Car</span>(<span class="params">color, name</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.color = color;</span><br><span class="line">	<span class="keyword">this</span>.name = name;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Car.prototype.fun=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="keyword">this</span>.color,<span class="keyword">this</span>.name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj=new2(Car,<span class="number">123</span>,<span class="string">'小花'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(obj)</span><br><span class="line"><span class="built_in">console</span>.log(obj.__proto__===Car.prototype);</span><br><span class="line"><span class="built_in">console</span>.log(Car.prototype.isPrototypeOf(obj))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.prototype.isPrototypeOf(obj))</span><br><span class="line"><span class="built_in">console</span>.log(obj <span class="keyword">instanceof</span> Car)</span><br><span class="line"><span class="built_in">console</span>.log(obj.constructor===Car);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj=new2(<span class="literal">null</span>,<span class="number">123</span>,<span class="string">'小花'</span>);</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/tx.jpg" alt="李斌">
            
              <p class="site-author-name" itemprop="name">李斌</p>
              <p class="site-description motion-element" itemprop="description">想要飞得高，那就把地平线忘掉</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">148</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/libin1991" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://juejin.im/user/57e737f6c4c971005f6bcd8d" target="_blank" title="juejin">
                      
                        <i class="fa fa-fw fa-spinner"></i>juejin</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李斌</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
<script type="text/javascript" src="/js/src/clicklove.js"></script>

