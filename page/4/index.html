<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="舞动乾坤">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="舞动乾坤">
<meta property="og:description" content="Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="舞动乾坤">
<meta name="twitter:description" content="Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/4/">





  <title>舞动乾坤 - 星光不问赶路人 岁月不负有心人</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband">
    	<div class="eevee"><div class="body"><div class="head"><div class="ears"><div class="ear"><div class="lobe"></div></div><div class="ear"><div class="lobe"></div></div></div><div class="face"><div class="eyes"><div class="eye"><div class="eyelid"></div></div><div class="eye"><div class="eyelid"></div></div></div><div class="nose"></div><div class="mouth"></div></div></div><div class="chest"><div class="fur"><div class="patch"></div></div><div class="fur"><div class="patch"></div></div><div class="fur"><div class="patch"></div></div></div><div class="legs"><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div></div><div class="tail"><div class="tail"><div class="tail"><div class="tail"><div class="tail"><div class="tail -end"></div></div></div></div></div></div></div></div>
    </div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
    	<div id="sky">
				<div id="background" class="container">
			<!-- svg file -->
			<svg id="svgout" height="100%" width="100%" viewbox="0 0 550 400">
				<defs>
					<g id="bottomShadow">
						<path fill="#000000" stroke="none" d="
		M 270.5 225.95
		L 127.35 316.65 266.8 400 409.6 309.25 270.5 225.95 Z"/>
					</g>
					<g id="Layer52_0_FILL">
						<path class="topGrass" fill="#B9D668" stroke="none" d="
	M 397.85 229.3
	L 397.85 225.6 269.85 152 135.75 228.6 135.75 233.65 262.1 306.55 397.85 229.3 Z"/>
					</g>
					<g id="Layer51_0_FILL">
						<path class="leftSideGrass" fill="#6E9E4F" stroke="none" d="
	M 135.1 229.95
	L 135.1 256.85 262.1 328.4 262.1 301.85 135.1 229.95 Z"/>
					</g>
					<g id="Layer50_0_FILL">
						<path class="rightGrassTop" fill="#8CB154" stroke="none" d="
	M 397.85 225.95
	L 395.8 225.95 261.75 301.55 261.75 328.4 397.85 251.15 397.85 225.95 Z"/>
					</g>
					<g id="Layer48_0_FILL">
						<path class="crustLeftTop" fill="#955541" stroke="none" d="
	M 135.45 282.4
	L 135.75 298.15 262.1 372.1 261.75 355.65 135.45 282.4 Z"/>
					</g>
					<g id="Layer47_0_FILL">
						<path class="middleLeftCrust" fill="#C77E61" stroke="none" d="
	M 135.1 270.3
	L 135.1 283.05 275.9 364.35 271.85 348.9 135.1 270.3 Z"/>
					</g>
					<g id="Layer46_0_FILL">
						<path class="crustLeftTop" fill="#955541" stroke="none" d="
	M 135.1 255.15
	L 135.1 270.3 262.1 343.55 262.1 328.05 135.1 255.15 Z"/>
					</g>
					<g id="Layer45_0_FILL">
						<path class="topRightCrust" fill="#A47237" stroke="none" d="
	M 397.5 294.5
	L 397.5 277 261.75 355.3 261.75 372.75 397.5 294.5 Z"/>
					</g>
					<g id="Layer44_0_FILL">
						<path class="middleRightCrust" fill="#C89451" stroke="none" d="
	M 397.5 269.95
	L 397.15 266.6 262.1 343.2 262.1 355.95 397.5 279.7 397.5 269.95 Z"/>
					</g>
					<g id="Layer43_0_FILL">
						<path class="topRightCrust" fill="#A47237" stroke="none" d="
	M 397.5 266.6
	L 397.5 250.45 261.75 328.4 261.75 343.85 397.5 266.6 Z"/>
					</g>
					<g id="Layer41_0_FILL">
						<path class="greyRoad" fill="#B2B2B1" stroke="none" d="
	M 295.05 283.05
	Q 299.05 280.35 308.45 275.3 317.85 269.95 323.6 266.9
	L 268.8 233.65 338.05 191.35 309.15 174.55 177.75 254.5
	Q 191.55 262.2 198.25 266.25 204.65 269.95 209.7 271.95
	L 241.6 250.45 295.05 283.05 Z"/>
					</g>
					<g id="Layer40_0_FILL">
						<path fill="#FFFFFF" stroke="none" d="
	M 199.95 256.85
	Q 194.55 261.2 191.9 262.2
	L 194.9 263.9 200.95 259.2 199.95 256.85
	M 225.8 243.75
	L 224.8 241.75 211.05 250.8 212.05 252.8 225.8 243.75
	M 308.15 275.65
	L 296.7 266.6 295.35 268.6 306.8 277.7 308.15 275.65
	M 275.9 253.5
	L 274.55 255.5 285.95 264.55 287.3 262.55 275.9 253.5
	M 251.7 227.3
	L 250.7 225.25 236.9 234.35 237.9 236.35 251.7 227.3
	M 257.05 240.7
	L 254.05 240.7 268.8 249.8 269.5 247.75 257.05 240.7
	M 277.2 207.8
	L 263.45 216.85 264.45 218.9 278.25 209.8 277.2 207.8
	M 305.1 192.65
	L 304.1 190.65 290.3 199.75 291.35 201.75 305.1 192.65 Z"/>
					</g>
					<g id="Layer38_0_FILL">
						<path class="frontFascia" fill="#ECB27B" stroke="none" d="
	M 359.25 187.95
	L 346.4 174.95 333.85 202.9 359.25 187.95 Z"/>
					</g>
					<g id="Layer37_0_FILL">
						<path class="frontWall" fill="#EFA258" stroke="none" d="
	M 334 201.05
	L 334.35 232 359.2 217.55 359.25 187.95 334 201.05 Z"/>
					</g>
					<g id="Layer36_0_FILL">
						<path class="leftWall" fill="#C57F42" stroke="none" d="
	M 334.35 232.3
	L 334.35 205.1 305.1 191.35 305.1 216.85 334.35 232.3 Z"/>
					</g>
					<g id="Layer35_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 329.7 167.9
	L 331.05 167.9 344.55 176.7 347.85 176.7 363 192.25 363.15 189.55 350.65 176.7 350.55 176.7 334.25 167.5 334.25 159.1 329.7 159.1 329.7 164.9 322.65 160.95 322.3 162.15 329.7 167 329.7 167.9 Z"/>
					</g>
					<g id="Layer34_0_FILL">
						<path class="leftRoof" fill="#F2563B" stroke="none" d="
	M 334.05 207.05
	L 350.65 176.7 322.1 160.45 302.1 192.05 334.05 207.05 Z"/>
					</g>
					<g id="Layer30_0_FILL">
						<path id="windowFour" class="windows" stroke="none" fill="#975A42" d="
	M 341.35 203.3
	Q 340.9 203.45 340.5 203.8 340.1 204.2 339.85 204.75 339.7 205 339.7 205.3 339.6 205.75 339.7 206.1 339.7 206.15 339.7 206.2 339.8 206.5 340 206.8 340.55 207.4 341.45 207.4 342.35 207.4 343 206.8 343.4 206.5 343.65 206.1 343.85 205.75 343.95 205.3 344.05 204.4 343.55 203.8 343.3 203.45 343 203.3 342.65 203.15 342.2 203.15 341.8 203.15 341.35 203.3
	M 355.85 198.45
	Q 355.8 198.2 355.6 198 355.1 197.4 354.2 197.4 353.35 197.4 352.6 198 351.85 198.65 351.7 199.55 351.7 199.7 351.7 199.85 351.6 200.5 352 201.05 352.55 201.65 353.45 201.65 354.3 201.65 355.05 201.05 355.45 200.7 355.7 200.25 355.8 200.05 355.9 199.85 355.95 199.7 355.95 199.55 356.05 198.95 355.85 198.45 Z"/>
						<path class="door" fill="#B65041" stroke="none" d="
	M 351.95 211.2
	L 351.8 211.2 346.05 215.1 346.05 225.2 351.95 221.6 351.95 211.2
	M 351.2 211.2
	L 351.35 211.2 351.35 211.1 351.2 211.2 Z"/>
					</g>
					<g>
						<path id="Layer30_0_FILL" fill="#000000" fill-opacity="1" stroke="none" d="
	M 183.7 215.3
	L 183.7 215.6
	Q 187.25 231.75 212.25 234.35
	L 183.7 215.3 Z"/>
					</g>
					<g id="Layer29_0_FILL">
						<path fill="#000000" fill-opacity="0.4" stroke="none" d="
	M 305.1 216.85
	L 305.15 217.2
	Q 309.45 233.2 334.35 232.3
	L 305.1 216.85 Z"/>
					</g>
					<g id="Layer27_0_FILL">
						<path class="vegetation" fill="#78A950" stroke="none" d="
	M 177.45 231.65
	Q 175.75 235.35 181.8 239.35 185.5 235.7 185.15 231.3 182.8 230.65 181.45 234 179.45 231.3 177.45 231.65
	M 236.9 266.6
	Q 235.2 270.3 241.25 274.3 244.95 270.6 244.65 266.25 242.3 265.6 240.95 268.95 238.9 266.25 236.9 266.6
	M 254.7 277
	Q 253.05 280.7 259.1 284.75 262.75 281.05 262.45 276.65 260.1 276 258.75 279.35 256.7 276.65 254.7 277
	M 315.5 245.75
	Q 313.5 243.05 311.5 243.4 309.8 247.1 315.85 251.15 319.55 247.45 319.2 243.05 316.85 242.4 315.5 245.75
	M 295.35 232.65
	Q 293.7 236.35 299.75 240.4 303.45 236.7 303.1 232.3 300.75 231.65 299.4 235 297.4 232.3 295.35 232.65
	M 277.2 171.85
	Q 275.55 175.55 281.6 179.55 285.3 175.85 284.95 171.5 282.6 170.85 281.25 174.2 279.25 171.5 277.2 171.85 Z"/>
					</g>
					<g id="Layer26_0_FILL">
						<path class="treeWood" fill="#AE663D" stroke="none" d="
	M 175.1 177.55
	L 172.05 177.55 172.05 191.1 159.3 172.85
	Q 154.6 171.5 172.05 195.7
	L 172.05 212.5 175.1 212.5 175.1 177.55
	M 252.7 151.35
	L 249 151.35 249 176.9 252.7 176.9 252.7 151.35 Z"/>
					</g>
					<g id="Layer25_0_FILL">
						<path class="vegetation" fill="#77A951" stroke="none" d="
	M 192.55 179.55
	Q 200.95 173.5 200.95 165.1 200.95 156.4 192.55 150 184.15 144.3 172.05 144.3 160.3 144.3 151.9 150 143.15 156.4 143.15 165.1 143.15 173.5 151.9 179.55 160.3 185.95 172.05 185.95 184.15 185.95 192.55 179.55
	M 236.25 106.65
	Q 230.2 116.05 230.2 129.15 230.2 142.25 236.25 151.35 242.3 160.75 250.7 160.75 258.75 160.75 264.8 151.35 270.85 142.25 270.85 129.15 270.85 116.05 264.8 106.65 258.75 97.6 250.7 97.6 242.3 97.6 236.25 106.65 Z"/>
					</g>
					<g id="Layer24_0_FILL">
						<path class="vegetation" fill="#77A951" stroke="none" d="
	M 158.3 221.9
	Q 160.65 221.9 161.95 220.2 163 219.55 163.3 218.55 164.65 218.9 166.35 218.9 170.05 218.9 172.4 216.2 175.1 213.85 175.1 210.15 175.1 206.45 172.4 203.75 170.05 201.4 166.35 201.4 162.65 201.4 159.95 203.75 157.6 206.45 157.6 210.15 157.6 210.8 157.6 211.15 155.95 211.5 154.6 212.5 152.9 214.15 152.9 216.55 152.9 218.9 154.6 220.2 156.25 221.9 158.3 221.9
	M 338.35 240.05
	Q 341.05 237.7 341.05 234 341.05 230.3 338.35 227.6 336 225.25 332.3 225.25 328.65 225.25 325.95 227.6 323.6 230.3 323.6 234 323.6 237.7 325.95 240.05 328.65 242.75 332.3 242.75 336 242.75 338.35 240.05 Z"/>
					</g>
					<g id="Layer22_0_FILL">
						<path class="rightRoof" fill="#D05041" stroke="none" d="
	M 220 173.85
	L 236.8 186.7 264.35 171.15 244.5 159.55 220 173.85 Z"/>
					</g>
					<g id="Layer21_0_FILL">
						<path class="leftWall" fill="#C57F42" stroke="none" d="
	M 212.25 191.35
	L 183.35 172.3 183.7 215.3 212.25 234.35 212.25 191.35 Z"/>
					</g>
					<g id="Layer20_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 192.1 149.85
	L 236.45 174.8 243.1 171.4
	Q 220.05 150.55 196.3 139.95
	L 192.1 149.85 Z"/>
					</g>
					<g id="Layer19_0_FILL">
						<path class="frontFascia" fill="#EBB17B" stroke="none" d="
	M 226.85 160.95
	L 212 190.6 229.75 192.6 239.75 172.85 226.85 160.95 Z"/>
					</g>
					<g id="Layer18_0_FILL">
						<path class="frontWall" fill="#EFA258" stroke="none" d="
	M 240.15 172.65
	L 211.9 191.6 212.25 233.65 264.35 201.7 264.35 170.8 240.8 184.45 240.15 172.65 Z"/>
					</g>
					<g id="Layer17_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 210.9 142.2
	L 205.9 142.2 205.9 152.65 210.9 152.65 210.9 142.2 Z"/>
					</g>
					<g>
						<path id="Layer16_0_FILL" class="leftRoof" fill="#F2563B" stroke="none" d="
	M 210.25 195.5
	L 227.4 160.95 195.45 141.35 177.65 175.85 210.25 195.5 Z"/>
					</g>
					<g>
						<path id="sun" fill="#E3BD0E" stroke="none" d="
	M 257.05 15.95
	Q 251.7 15.95 248 19.65 244.3 23.35 244.3 28.7 244.3 34.1 248 37.8 251.7 41.5 257.05 41.5 262.45 41.5 266.15 37.8 269.85 34.1 269.85 28.7 269.85 23.35 266.15 19.65 262.45 15.95 257.05 15.95 Z"/>
					</g>
					<g id="Layer8_0_FILL">
						<path fill="#975A42" stroke="none" d="
	M 238.45 189.65
	Q 238.295703125 189.362109375 238.05 189.1 237.35 188.3 236.2 188.3 235.05 188.3 234.15 189.1 233.3 189.9 233.2 191.05 233.1 192.2 233.8 193 234.55 193.8 235.7 193.8 236.85 193.8 237.7 193 238.1970703125 192.558203125 238.45 192 238.6552734375 191.56484375 238.7 191.05 238.7671875 190.276953125 238.45 189.65
	M 220.55 197.55
	Q 220 197.55 219.5 197.75 218.95 197.95 218.5 198.35 217.933203125 198.8833984375 217.7 199.55 217.5833984375 199.916796875 217.55 200.3 217.4923828125 200.96171875 217.7 201.5 217.852734375 201.9103515625 218.15 202.25 218.95 203.05 220.1 203.05 221.25 203.05 222.05 202.25 222.95 201.45 223.05 200.3 223.15 199.15 222.4 198.35 222.05 197.95 221.65 197.75 221.15 197.55 220.55 197.55 Z"/>
					</g>
					<g id="Layer7_0_FILL">
						<path class="door" fill="#B65041" stroke="none" d="
	M 233.55 206.75
	L 225.9 211.95 226.25 225.5 233.95 220.35 233.55 206.75 Z"/>
					</g>
					<g>
						<path id="windowOne" class="windows" fill="#975A42" stroke="none" d="
	M 188.65 198.4
	L 188.8 204.1 198.65 210.45 198.55 204.75 188.65 198.4
	M 208.45 216.8
	L 208.35 211.1 198.55 204.75 198.65 210.45 208.45 216.8
	M 188.8 204.1
	L 188.95 209.8 198.8 216.15 198.65 210.45 188.8 204.1
	M 208.6 222.5
	L 208.45 216.8 198.65 210.45 198.8 216.15 208.6 222.5 Z"/>
					</g>
					<g>
						<path id="windowThree" class="windows" fill="#975A42" stroke="none" d="
	M 311.7 214.1
	L 318.55 217.55 318.45 211.9 311.6 208.45 311.7 214.1
	M 325.4 221
	L 325.25 215.35 318.45 211.9 318.55 217.55 325.4 221
	M 318.4 206.2
	L 311.5 202.75 311.6 208.45 318.45 211.9 318.4 206.2
	M 325.25 215.35
	L 325.2 209.7 318.4 206.2 318.45 211.9 325.25 215.35 Z"/>
					</g>
					<g id="Layer2_0_FILL">
						<path class="door" fill="#B65041" stroke="none" d="
	M 259.7 183.25
	L 244.6 191.9 244.6 213.8 259.7 204.55 259.7 183.25 Z"/>
					</g>
					<path id="windowTwo" fill="#975A42" class="windows" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" d="
	M 223.05 200.3
	Q 222.95 201.45 222.05 202.25 221.25 203.05 220.1 203.05 218.95 203.05 218.15 202.25 217.852734375 201.9103515625 217.7 201.5 217.4923828125 200.96171875 217.55 200.3 217.5833984375 199.916796875 217.7 199.575 217.933203125 198.8833984375 218.5 198.35 218.95 197.95 219.5 197.75 220 197.55 220.55 197.55 221.15 197.55 221.65 197.75 222.05 197.95 222.4 198.35 223.15 199.15 223.05 200.3 Z
	M 238.7 191.05
	Q 238.6552734375 191.56484375 238.45 192 238.1970703125 192.558203125 237.7 193 236.85 193.8 235.7 193.8 234.55 193.8 233.8 193 233.1 192.2 233.2 191.05 233.3 189.9 234.15 189.1 235.05 188.3 236.2 188.3 237.35 188.3 238.05 189.1 238.295703125 189.362109375 238.45 189.65 238.7671875 190.276953125 238.7 191.05 Z"/>
					<path fill="#F2563B" stroke="none" d=" M 351.95 211.2 L 351.8 211.2 346.05 215.1 346.05 225.2 351.95 221.6 351.95 211.2 Z"/>
					<path id="Layer6_0_1_STROKES" class="windowRims" stroke="#AE663D" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" fill="none" d="
	M 198.55 204.75
	L 208.35 211.1 208.45 216.8 208.6 222.5 198.8 216.15 188.95 209.8 188.8 204.1 188.65 198.4 198.55 204.75 198.65 210.45 208.45 216.8
	M 198.8 216.15
	L 198.65 210.45 188.8 204.1"/>
					<path id="Layer5_0_1_STROKES" class="windowRims" stroke="#AE663D" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" fill="none" d="
	M 325.25 215.35
	L 325.4 221 318.55 217.55 311.7 214.1 311.6 208.45 311.5 202.75 318.4 206.2 325.2 209.7 325.25 215.35 318.45 211.9 318.55 217.55
	M 318.4 206.2
	L 318.45 211.9 311.6 208.45"/>
				</defs>
				<g id="shadow">
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use xlink:href="#bottomShadow"/>
					</g>
				</g>
				<g transform="matrix( 1, 0, 0, 1, 0,0) ">
					<use xlink:href="#sun"/>
				</g>
				<g id="earth">
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer52_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer51_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer50_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer48_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer47_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer46_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer45_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer44_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer43_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer41_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer40_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer38_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer37_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer36_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer35_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer34_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowFour"/>
						<use class="element" xlink:href="#Layer32_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer30_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer27_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer26_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer25_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer24_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer22_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer21_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer20_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer19_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer18_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer17_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer16_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer8_0_FILL"/>
						<use class="element" xlink:href="#windowTwo"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer7_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowOne"/>
						<use class="element" xlink:href="#Layer6_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowThree"/>
						<use class="element" xlink:href="#Layer5_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer2_0_FILL"/>
					</g>
				</g>
			</svg>
			<! -- End of SVG file -->
			<! -- Moon/Sun Toggle -->
			<div id="toggleButton" class="day-toggle">
				<div class="sun-icon"></div>
				<label class="switch">
            <input id="toggleCheckbox" type="checkbox">
            <div class="slider"></div>
        </label>
				<div class="cloud-icon"></div>
			</div>
			<! -- Moon/Sun Toggle -->
			<! -- End of Container -->
		</div>
			</div>
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">舞动乾坤</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">星光不问赶路人 岁月不负有心人</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/08/基于IntersectionObserver的图片懒加载实现/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/08/基于IntersectionObserver的图片懒加载实现/" itemprop="url">基于IntersectionObserver的图片懒加载实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-08T21:54:27+08:00">
                2018-10-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class="line">  &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot;&gt;</span><br><span class="line">  &lt;title&gt;图片懒加载&lt;/title&gt;</span><br><span class="line">  &lt;link href=&quot;./css/style.css&quot; rel=&quot;stylesheet&quot;/&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div id=&quot;view&quot;&gt;</span><br><span class="line">    &lt;img data-src=&quot;http://img.pconline.com.cn/images/upload/upc/tx/wallpaper/1301/05/c0/17135331_1357355776882.jpg&quot; class=&quot;lazy-image&quot;/&gt;</span><br><span class="line">    &lt;img data-src=&quot;http://f.hiphotos.baidu.com/zhidao/pic/item/eac4b74543a982267a3d54978a82b9014b90eb86.jpg&quot; class=&quot;lazy-image&quot;/&gt;</span><br><span class="line">    &lt;img data-src=&quot;http://pic1.win4000.com/wallpaper/2/58b61f7dc6c1d.jpg&quot; class=&quot;lazy-image&quot;/&gt;</span><br><span class="line">    &lt;img data-src=&quot;http://file03.16sucai.com/2017/1100/16sucai_p20161106032_0c2.JPG&quot; class=&quot;lazy-image&quot;/&gt;</span><br><span class="line">    &lt;img data-src=&quot;http://imgsrc.baidu.com/image/c0%3Dpixel_huitu%2C0%2C0%2C294%2C40/sign=5a7938d38acb39dbd5cd6f16b96e6c48/aec379310a55b3196c79de4c48a98226cffc1702.jpg&quot; class=&quot;lazy-image&quot;/&gt;</span><br><span class="line">    &lt;img data-src=&quot;http://c.hiphotos.baidu.com/zhidao/pic/item/8d5494eef01f3a2987a8062f9f25bc315d607ceb.jpg&quot; class=&quot;lazy-image&quot;/&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;link href=&quot;./css/style.css&quot; rel=&quot;stylesheet&quot;/&gt;</span><br><span class="line">&lt;script src=&quot;js/lazy-image.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  console.log(document.documentElement.clientHeight)</span><br><span class="line">  new LazyImage(&apos;.lazy-image&apos;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">class LazyImage &#123;</span><br><span class="line">    constructor(selector) &#123;</span><br><span class="line">      // 懒记载图片列表，将伪数组转为数组，以便可以使用数组的api</span><br><span class="line">      this.lazyImages = Array.prototype.slice.call(document.querySelectorAll(selector))</span><br><span class="line">      this.init()</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    inViewShow() &#123;</span><br><span class="line">      // 不支持IntersectionObserver api的情况下判断图片是否出现在可视区域内</span><br><span class="line">      let len = this.lazyImages.length</span><br><span class="line">      for(let i = 0; i &lt; len; i++) &#123;</span><br><span class="line">        let lazyImage = this.lazyImages[i]</span><br><span class="line">        const rect = lazyImage.getBoundingClientRect()</span><br><span class="line">        // 出现在视野的时候加载图片</span><br><span class="line">        if(rect.top &lt; document.documentElement.clientHeight) &#123;</span><br><span class="line">          lazyImage.src = lazyImage.dataset.src</span><br><span class="line">          // 移除掉已经显示的</span><br><span class="line">          this.lazyImages.splice(i, 1)</span><br><span class="line">          len--</span><br><span class="line">          i--</span><br><span class="line">          if(this.lazyImages.length === 0) &#123;</span><br><span class="line">            // 如果全部都加载完 则去掉滚动事件监听</span><br><span class="line">            document.removeEventListener(&apos;scroll&apos;, this._throttleFn)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    throttle(fn, delay = 15, mustRun = 30) &#123;</span><br><span class="line">      let t_start = null</span><br><span class="line">      let timer = null</span><br><span class="line">      let context = this</span><br><span class="line">      return function() &#123;</span><br><span class="line">        let t_current = +(new Date())</span><br><span class="line">        let args = Array.prototype.slice.call(arguments)</span><br><span class="line">        clearTimeout(timer)</span><br><span class="line">        if(!t_start) &#123;</span><br><span class="line">          t_start = t_current</span><br><span class="line">        &#125;</span><br><span class="line">        if(t_current - t_start &gt; mustRun) &#123;</span><br><span class="line">          fn.apply(context, args)</span><br><span class="line">          t_start = t_current</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          timer = setTimeout(() =&gt; &#123;</span><br><span class="line">            fn.apply(context, args)</span><br><span class="line">          &#125;, delay)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    init() &#123;</span><br><span class="line">      // 通过IntersectionObserver api判断图片是否出现在可视区域内，不需要监听Scroll来判断</span><br><span class="line">      if (&quot;IntersectionObserver&quot; in window) &#123;</span><br><span class="line">        let lazyImageObserver = new IntersectionObserver((entries, observer) =&gt; &#123;</span><br><span class="line">          entries.forEach((entry, index) =&gt; &#123;</span><br><span class="line">            // 如果元素可见</span><br><span class="line">            if (entry.isIntersecting) &#123;</span><br><span class="line">              let lazyImage = entry.target</span><br><span class="line">              lazyImage.src = lazyImage.dataset.src</span><br><span class="line">              lazyImageObserver.unobserve(lazyImage)</span><br><span class="line">              // this.lazyImages.splice(index, 1)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">        this.lazyImages.forEach(function(lazyImage) &#123;</span><br><span class="line">          lazyImageObserver.observe(lazyImage);</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        this.inViewShow()</span><br><span class="line">        this._throttleFn = this.throttle(this.inViewShow)</span><br><span class="line">        document.addEventListener(&apos;scroll&apos;, this._throttleFn)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">html,body &#123;</span><br><span class="line">  height: 100%;</span><br><span class="line">  width: 100%;</span><br><span class="line">  margin: 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#view &#123;</span><br><span class="line">  color: red;</span><br><span class="line">  width: 200px;</span><br><span class="line">  height: 300px</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.lazy-image &#123;</span><br><span class="line">  background: url(&apos;../img/loading.gif&apos;) no-repeat center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">img&#123;</span><br><span class="line">  margin-top: 100px;</span><br><span class="line">  background-size: cover;</span><br><span class="line">  background-position: center;</span><br><span class="line">  width: 490px;</span><br><span class="line">  height: 242px;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/05/Babel-将-Generator-编译成了什么/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/05/Babel-将-Generator-编译成了什么/" itemprop="url">Babel 将 Generator 编译成了什么</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-05T21:36:19+08:00">
                2018-10-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文就是简单介绍下 Generator 语法编译后的代码。</p>
<h2 id="Generator"><a href="#Generator" class="headerlink" title="Generator"></a>Generator</h2><pre><code>function* helloWorldGenerator() {
  yield&apos;hello&apos;;
  yield&apos;world&apos;;
  return&apos;ending&apos;;
}
</code></pre><p>我们打印下执行的结果：</p>
<pre><code>var hw = helloWorldGenerator();

console.log(hw.next()); // {value: &quot;hello&quot;, done: false}console.log(hw.next()); // {value: &quot;world&quot;, done: false}console.log(hw.next()); // {value: &quot;ending&quot;, done: true}console.log(hw.next()); // {value: undefined, done: true}
</code></pre><h2 id="Babel"><a href="#Babel" class="headerlink" title="Babel"></a>Babel</h2><p>具体的执行过程就不说了，我们直接在 Babel 官网的 <a href="https://babeljs.io/repl" target="_blank" rel="noopener">Try it out</a> 粘贴上述代码，然后查看代码被编译成了什么样子：</p>
<pre><code>/**
 * 我们就称呼这个版本为简单编译版本吧
 */var _marked = /*#__PURE__*/ regeneratorRuntime.mark(helloWorldGenerator);

functionhelloWorldGenerator() {
  return regeneratorRuntime.wrap(
    functionhelloWorldGenerator$(_context) {
      while (1) {
        switch ((_context.prev = _context.next)) {
          case0:
            _context.next = 2;
            return&quot;hello&quot;;

          case2:
            _context.next = 4;
            return&quot;world&quot;;

          case4:
            return _context.abrupt(&quot;return&quot;, &quot;ending&quot;);

          case5:
          case&quot;end&quot;:
            return _context.stop();
        }
      }
    },
    _marked,
    this
  );
}
</code></pre><p>猛一看，好像编译后的代码还蛮少的，但是细细一看，编译后的代码肯定是不能用的呀，<code>regeneratorRuntime</code> 是个什么鬼？哪里有声明呀？<code>mark</code> 和 <code>wrap</code> 方法又都做了什么？</p>
<p>难道就不能编译一个完整可用的代码吗？</p>
<h2 id="regenerator"><a href="#regenerator" class="headerlink" title="regenerator"></a>regenerator</h2><p>如果你想看到完整可用的代码，你可以使用 <a href="https://github.com/facebook/regenerator" target="_blank" rel="noopener">regenerator</a>，这是 facebook 下的一个工具，用于编译 ES6 的 generator 函数。</p>
<p>我们先安装一下 regenerator：</p>
<pre><code>npm install -g regenerator
</code></pre><p>然后新建一个 generator.js 文件，里面的代码就是文章最一开始的代码，我们执行命令：</p>
<pre><code>regenerator --include-runtime generator.js &gt; generator-es5.js
</code></pre><p>我们就可以在 generator-es5.js 文件看到编译后的完整可用的代码。</p>
<p>而这一编译就编译了 700 多行…… 编译后的代码可以查看 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Copyright (c) 2014-present, Facebook, Inc.</span><br><span class="line"> *</span><br><span class="line"> * This source code is licensed under the MIT license found in the</span><br><span class="line"> * LICENSE file in the root directory of this source tree.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">!(function(global) &#123;</span><br><span class="line">  &quot;use strict&quot;;</span><br><span class="line"></span><br><span class="line">  var Op = Object.prototype;</span><br><span class="line">  var hasOwn = Op.hasOwnProperty;</span><br><span class="line">  var undefined; // More compressible than void 0.</span><br><span class="line">  var $Symbol = typeof Symbol === &quot;function&quot; ? Symbol : &#123;&#125;;</span><br><span class="line">  var iteratorSymbol = $Symbol.iterator || &quot;@@iterator&quot;;</span><br><span class="line">  var asyncIteratorSymbol = $Symbol.asyncIterator || &quot;@@asyncIterator&quot;;</span><br><span class="line">  var toStringTagSymbol = $Symbol.toStringTag || &quot;@@toStringTag&quot;;</span><br><span class="line"></span><br><span class="line">  var inModule = typeof module === &quot;object&quot;;</span><br><span class="line">  var runtime = global.regeneratorRuntime;</span><br><span class="line">  if (runtime) &#123;</span><br><span class="line">    if (inModule) &#123;</span><br><span class="line">      // If regeneratorRuntime is defined globally and we&apos;re in a module,</span><br><span class="line">      // make the exports object identical to regeneratorRuntime.</span><br><span class="line">      module.exports = runtime;</span><br><span class="line">    &#125;</span><br><span class="line">    // Don&apos;t bother evaluating the rest of this file if the runtime was</span><br><span class="line">    // already defined globally.</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Define the runtime globally (as expected by generated code) as either</span><br><span class="line">  // module.exports (if we&apos;re in a module) or a new, empty object.</span><br><span class="line">  runtime = global.regeneratorRuntime = inModule ? module.exports : &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  function wrap(innerFn, outerFn, self, tryLocsList) &#123;</span><br><span class="line">    // If outerFn provided and outerFn.prototype is a Generator, then outerFn.prototype instanceof Generator.</span><br><span class="line">    var protoGenerator = outerFn &amp;&amp; outerFn.prototype instanceof Generator ? outerFn : Generator;</span><br><span class="line">    var generator = Object.create(protoGenerator.prototype);</span><br><span class="line">    var context = new Context(tryLocsList || []);</span><br><span class="line"></span><br><span class="line">    // The ._invoke method unifies the implementations of the .next,</span><br><span class="line">    // .throw, and .return methods.</span><br><span class="line">    generator._invoke = makeInvokeMethod(innerFn, self, context);</span><br><span class="line"></span><br><span class="line">    return generator;</span><br><span class="line">  &#125;</span><br><span class="line">  runtime.wrap = wrap;</span><br><span class="line"></span><br><span class="line">  // Try/catch helper to minimize deoptimizations. Returns a completion</span><br><span class="line">  // record like context.tryEntries[i].completion. This interface could</span><br><span class="line">  // have been (and was previously) designed to take a closure to be</span><br><span class="line">  // invoked without arguments, but in all the cases we care about we</span><br><span class="line">  // already have an existing method we want to call, so there&apos;s no need</span><br><span class="line">  // to create a new function object. We can even get away with assuming</span><br><span class="line">  // the method takes exactly one argument, since that happens to be true</span><br><span class="line">  // in every case, so we don&apos;t have to touch the arguments object. The</span><br><span class="line">  // only additional allocation required is the completion record, which</span><br><span class="line">  // has a stable shape and so hopefully should be cheap to allocate.</span><br><span class="line">  function tryCatch(fn, obj, arg) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      return &#123; type: &quot;normal&quot;, arg: fn.call(obj, arg) &#125;;</span><br><span class="line">    &#125; catch (err) &#123;</span><br><span class="line">      return &#123; type: &quot;throw&quot;, arg: err &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  var GenStateSuspendedStart = &quot;suspendedStart&quot;;</span><br><span class="line">  var GenStateSuspendedYield = &quot;suspendedYield&quot;;</span><br><span class="line">  var GenStateExecuting = &quot;executing&quot;;</span><br><span class="line">  var GenStateCompleted = &quot;completed&quot;;</span><br><span class="line"></span><br><span class="line">  // Returning this object from the innerFn has the same effect as</span><br><span class="line">  // breaking out of the dispatch switch statement.</span><br><span class="line">  var ContinueSentinel = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  // Dummy constructor functions that we use as the .constructor and</span><br><span class="line">  // .constructor.prototype properties for functions that return Generator</span><br><span class="line">  // objects. For full spec compliance, you may wish to configure your</span><br><span class="line">  // minifier not to mangle the names of these two functions.</span><br><span class="line">  function Generator() &#123;&#125;</span><br><span class="line">  function GeneratorFunction() &#123;&#125;</span><br><span class="line">  function GeneratorFunctionPrototype() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  // This is a polyfill for %IteratorPrototype% for environments that</span><br><span class="line">  // don&apos;t natively support it.</span><br><span class="line">  var IteratorPrototype = &#123;&#125;;</span><br><span class="line">  IteratorPrototype[iteratorSymbol] = function () &#123;</span><br><span class="line">    return this;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  var getProto = Object.getPrototypeOf;</span><br><span class="line">  var NativeIteratorPrototype = getProto &amp;&amp; getProto(getProto(values([])));</span><br><span class="line">  if (NativeIteratorPrototype &amp;&amp;</span><br><span class="line">      NativeIteratorPrototype !== Op &amp;&amp;</span><br><span class="line">      hasOwn.call(NativeIteratorPrototype, iteratorSymbol)) &#123;</span><br><span class="line">    // This environment has a native %IteratorPrototype%; use it instead</span><br><span class="line">    // of the polyfill.</span><br><span class="line">    IteratorPrototype = NativeIteratorPrototype;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  var Gp = GeneratorFunctionPrototype.prototype =</span><br><span class="line">    Generator.prototype = Object.create(IteratorPrototype);</span><br><span class="line">  GeneratorFunction.prototype = Gp.constructor = GeneratorFunctionPrototype;</span><br><span class="line">  GeneratorFunctionPrototype.constructor = GeneratorFunction;</span><br><span class="line">  GeneratorFunctionPrototype[toStringTagSymbol] =</span><br><span class="line">    GeneratorFunction.displayName = &quot;GeneratorFunction&quot;;</span><br><span class="line"></span><br><span class="line">  // Helper for defining the .next, .throw, and .return methods of the</span><br><span class="line">  // Iterator interface in terms of a single ._invoke method.</span><br><span class="line">  function defineIteratorMethods(prototype) &#123;</span><br><span class="line">    [&quot;next&quot;, &quot;throw&quot;, &quot;return&quot;].forEach(function(method) &#123;</span><br><span class="line">      prototype[method] = function(arg) &#123;</span><br><span class="line">        return this._invoke(method, arg);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  runtime.isGeneratorFunction = function(genFun) &#123;</span><br><span class="line">    var ctor = typeof genFun === &quot;function&quot; &amp;&amp; genFun.constructor;</span><br><span class="line">    return ctor</span><br><span class="line">      ? ctor === GeneratorFunction ||</span><br><span class="line">        // For the native GeneratorFunction constructor, the best we can</span><br><span class="line">        // do is to check its .name property.</span><br><span class="line">        (ctor.displayName || ctor.name) === &quot;GeneratorFunction&quot;</span><br><span class="line">      : false;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  runtime.mark = function(genFun) &#123;</span><br><span class="line">    if (Object.setPrototypeOf) &#123;</span><br><span class="line">      Object.setPrototypeOf(genFun, GeneratorFunctionPrototype);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      genFun.__proto__ = GeneratorFunctionPrototype;</span><br><span class="line">      if (!(toStringTagSymbol in genFun)) &#123;</span><br><span class="line">        genFun[toStringTagSymbol] = &quot;GeneratorFunction&quot;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    genFun.prototype = Object.create(Gp);</span><br><span class="line">    return genFun;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  // Within the body of any async function, `await x` is transformed to</span><br><span class="line">  // `yield regeneratorRuntime.awrap(x)`, so that the runtime can test</span><br><span class="line">  // `hasOwn.call(value, &quot;__await&quot;)` to determine if the yielded value is</span><br><span class="line">  // meant to be awaited.</span><br><span class="line">  runtime.awrap = function(arg) &#123;</span><br><span class="line">    return &#123; __await: arg &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  function AsyncIterator(generator) &#123;</span><br><span class="line">    function invoke(method, arg, resolve, reject) &#123;</span><br><span class="line">      var record = tryCatch(generator[method], generator, arg);</span><br><span class="line">      if (record.type === &quot;throw&quot;) &#123;</span><br><span class="line">        reject(record.arg);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        var result = record.arg;</span><br><span class="line">        var value = result.value;</span><br><span class="line">        if (value &amp;&amp;</span><br><span class="line">            typeof value === &quot;object&quot; &amp;&amp;</span><br><span class="line">            hasOwn.call(value, &quot;__await&quot;)) &#123;</span><br><span class="line">          return Promise.resolve(value.__await).then(function(value) &#123;</span><br><span class="line">            invoke(&quot;next&quot;, value, resolve, reject);</span><br><span class="line">          &#125;, function(err) &#123;</span><br><span class="line">            invoke(&quot;throw&quot;, err, resolve, reject);</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return Promise.resolve(value).then(function(unwrapped) &#123;</span><br><span class="line">          // When a yielded Promise is resolved, its final value becomes</span><br><span class="line">          // the .value of the Promise&lt;&#123;value,done&#125;&gt; result for the</span><br><span class="line">          // current iteration.</span><br><span class="line">          result.value = unwrapped;</span><br><span class="line">          resolve(result);</span><br><span class="line">        &#125;, function(error) &#123;</span><br><span class="line">          // If a rejected Promise was yielded, throw the rejection back</span><br><span class="line">          // into the async generator function so it can be handled there.</span><br><span class="line">          return invoke(&quot;throw&quot;, error, resolve, reject);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var previousPromise;</span><br><span class="line"></span><br><span class="line">    function enqueue(method, arg) &#123;</span><br><span class="line">      function callInvokeWithMethodAndArg() &#123;</span><br><span class="line">        return new Promise(function(resolve, reject) &#123;</span><br><span class="line">          invoke(method, arg, resolve, reject);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return previousPromise =</span><br><span class="line">        // If enqueue has been called before, then we want to wait until</span><br><span class="line">        // all previous Promises have been resolved before calling invoke,</span><br><span class="line">        // so that results are always delivered in the correct order. If</span><br><span class="line">        // enqueue has not been called before, then it is important to</span><br><span class="line">        // call invoke immediately, without waiting on a callback to fire,</span><br><span class="line">        // so that the async generator function has the opportunity to do</span><br><span class="line">        // any necessary setup in a predictable way. This predictability</span><br><span class="line">        // is why the Promise constructor synchronously invokes its</span><br><span class="line">        // executor callback, and why async functions synchronously</span><br><span class="line">        // execute code before the first await. Since we implement simple</span><br><span class="line">        // async functions in terms of async generators, it is especially</span><br><span class="line">        // important to get this right, even though it requires care.</span><br><span class="line">        previousPromise ? previousPromise.then(</span><br><span class="line">          callInvokeWithMethodAndArg,</span><br><span class="line">          // Avoid propagating failures to Promises returned by later</span><br><span class="line">          // invocations of the iterator.</span><br><span class="line">          callInvokeWithMethodAndArg</span><br><span class="line">        ) : callInvokeWithMethodAndArg();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Define the unified helper method that is used to implement .next,</span><br><span class="line">    // .throw, and .return (see defineIteratorMethods).</span><br><span class="line">    this._invoke = enqueue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  defineIteratorMethods(AsyncIterator.prototype);</span><br><span class="line">  AsyncIterator.prototype[asyncIteratorSymbol] = function () &#123;</span><br><span class="line">    return this;</span><br><span class="line">  &#125;;</span><br><span class="line">  runtime.AsyncIterator = AsyncIterator;</span><br><span class="line"></span><br><span class="line">  // Note that simple async functions are implemented on top of</span><br><span class="line">  // AsyncIterator objects; they just return a Promise for the value of</span><br><span class="line">  // the final result produced by the iterator.</span><br><span class="line">  runtime.async = function(innerFn, outerFn, self, tryLocsList) &#123;</span><br><span class="line">    var iter = new AsyncIterator(</span><br><span class="line">      wrap(innerFn, outerFn, self, tryLocsList)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    return runtime.isGeneratorFunction(outerFn)</span><br><span class="line">      ? iter // If outerFn is a generator, return the full iterator.</span><br><span class="line">      : iter.next().then(function(result) &#123;</span><br><span class="line">          return result.done ? result.value : iter.next();</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  function makeInvokeMethod(innerFn, self, context) &#123;</span><br><span class="line">    var state = GenStateSuspendedStart;</span><br><span class="line"></span><br><span class="line">    return function invoke(method, arg) &#123;</span><br><span class="line">      if (state === GenStateExecuting) &#123;</span><br><span class="line">        throw new Error(&quot;Generator is already running&quot;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (state === GenStateCompleted) &#123;</span><br><span class="line">        if (method === &quot;throw&quot;) &#123;</span><br><span class="line">          throw arg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Be forgiving, per 25.3.3.3.3 of the spec:</span><br><span class="line">        // https://people.mozilla.org/~jorendorff/es6-draft.html#sec-generatorresume</span><br><span class="line">        return doneResult();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      context.method = method;</span><br><span class="line">      context.arg = arg;</span><br><span class="line"></span><br><span class="line">      while (true) &#123;</span><br><span class="line">        var delegate = context.delegate;</span><br><span class="line">        if (delegate) &#123;</span><br><span class="line">          var delegateResult = maybeInvokeDelegate(delegate, context);</span><br><span class="line">          if (delegateResult) &#123;</span><br><span class="line">            if (delegateResult === ContinueSentinel) continue;</span><br><span class="line">            return delegateResult;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (context.method === &quot;next&quot;) &#123;</span><br><span class="line">          // Setting context._sent for legacy support of Babel&apos;s</span><br><span class="line">          // function.sent implementation.</span><br><span class="line">          context.sent = context._sent = context.arg;</span><br><span class="line"></span><br><span class="line">        &#125; else if (context.method === &quot;throw&quot;) &#123;</span><br><span class="line">          if (state === GenStateSuspendedStart) &#123;</span><br><span class="line">            state = GenStateCompleted;</span><br><span class="line">            throw context.arg;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          context.dispatchException(context.arg);</span><br><span class="line"></span><br><span class="line">        &#125; else if (context.method === &quot;return&quot;) &#123;</span><br><span class="line">          context.abrupt(&quot;return&quot;, context.arg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        state = GenStateExecuting;</span><br><span class="line"></span><br><span class="line">        var record = tryCatch(innerFn, self, context);</span><br><span class="line">        if (record.type === &quot;normal&quot;) &#123;</span><br><span class="line">          // If an exception is thrown from innerFn, we leave state ===</span><br><span class="line">          // GenStateExecuting and loop back for another invocation.</span><br><span class="line">          state = context.done</span><br><span class="line">            ? GenStateCompleted</span><br><span class="line">            : GenStateSuspendedYield;</span><br><span class="line"></span><br><span class="line">          if (record.arg === ContinueSentinel) &#123;</span><br><span class="line">            continue;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          return &#123;</span><br><span class="line">            value: record.arg,</span><br><span class="line">            done: context.done</span><br><span class="line">          &#125;;</span><br><span class="line"></span><br><span class="line">        &#125; else if (record.type === &quot;throw&quot;) &#123;</span><br><span class="line">          state = GenStateCompleted;</span><br><span class="line">          // Dispatch the exception by looping back around to the</span><br><span class="line">          // context.dispatchException(context.arg) call above.</span><br><span class="line">          context.method = &quot;throw&quot;;</span><br><span class="line">          context.arg = record.arg;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Call delegate.iterator[context.method](context.arg) and handle the</span><br><span class="line">  // result, either by returning a &#123; value, done &#125; result from the</span><br><span class="line">  // delegate iterator, or by modifying context.method and context.arg,</span><br><span class="line">  // setting context.delegate to null, and returning the ContinueSentinel.</span><br><span class="line">  function maybeInvokeDelegate(delegate, context) &#123;</span><br><span class="line">    var method = delegate.iterator[context.method];</span><br><span class="line">    if (method === undefined) &#123;</span><br><span class="line">      // A .throw or .return when the delegate iterator has no .throw</span><br><span class="line">      // method always terminates the yield* loop.</span><br><span class="line">      context.delegate = null;</span><br><span class="line"></span><br><span class="line">      if (context.method === &quot;throw&quot;) &#123;</span><br><span class="line">        if (delegate.iterator.return) &#123;</span><br><span class="line">          // If the delegate iterator has a return method, give it a</span><br><span class="line">          // chance to clean up.</span><br><span class="line">          context.method = &quot;return&quot;;</span><br><span class="line">          context.arg = undefined;</span><br><span class="line">          maybeInvokeDelegate(delegate, context);</span><br><span class="line"></span><br><span class="line">          if (context.method === &quot;throw&quot;) &#123;</span><br><span class="line">            // If maybeInvokeDelegate(context) changed context.method from</span><br><span class="line">            // &quot;return&quot; to &quot;throw&quot;, let that override the TypeError below.</span><br><span class="line">            return ContinueSentinel;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        context.method = &quot;throw&quot;;</span><br><span class="line">        context.arg = new TypeError(</span><br><span class="line">          &quot;The iterator does not provide a &apos;throw&apos; method&quot;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return ContinueSentinel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var record = tryCatch(method, delegate.iterator, context.arg);</span><br><span class="line"></span><br><span class="line">    if (record.type === &quot;throw&quot;) &#123;</span><br><span class="line">      context.method = &quot;throw&quot;;</span><br><span class="line">      context.arg = record.arg;</span><br><span class="line">      context.delegate = null;</span><br><span class="line">      return ContinueSentinel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var info = record.arg;</span><br><span class="line"></span><br><span class="line">    if (! info) &#123;</span><br><span class="line">      context.method = &quot;throw&quot;;</span><br><span class="line">      context.arg = new TypeError(&quot;iterator result is not an object&quot;);</span><br><span class="line">      context.delegate = null;</span><br><span class="line">      return ContinueSentinel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (info.done) &#123;</span><br><span class="line">      // Assign the result of the finished delegate to the temporary</span><br><span class="line">      // variable specified by delegate.resultName (see delegateYield).</span><br><span class="line">      context[delegate.resultName] = info.value;</span><br><span class="line"></span><br><span class="line">      // Resume execution at the desired location (see delegateYield).</span><br><span class="line">      context.next = delegate.nextLoc;</span><br><span class="line"></span><br><span class="line">      // If context.method was &quot;throw&quot; but the delegate handled the</span><br><span class="line">      // exception, let the outer generator proceed normally. If</span><br><span class="line">      // context.method was &quot;next&quot;, forget context.arg since it has been</span><br><span class="line">      // &quot;consumed&quot; by the delegate iterator. If context.method was</span><br><span class="line">      // &quot;return&quot;, allow the original .return call to continue in the</span><br><span class="line">      // outer generator.</span><br><span class="line">      if (context.method !== &quot;return&quot;) &#123;</span><br><span class="line">        context.method = &quot;next&quot;;</span><br><span class="line">        context.arg = undefined;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      // Re-yield the result returned by the delegate method.</span><br><span class="line">      return info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // The delegate iterator is finished, so forget it and continue with</span><br><span class="line">    // the outer generator.</span><br><span class="line">    context.delegate = null;</span><br><span class="line">    return ContinueSentinel;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Define Generator.prototype.&#123;next,throw,return&#125; in terms of the</span><br><span class="line">  // unified ._invoke helper method.</span><br><span class="line">  defineIteratorMethods(Gp);</span><br><span class="line"></span><br><span class="line">  Gp[toStringTagSymbol] = &quot;Generator&quot;;</span><br><span class="line"></span><br><span class="line">  // A Generator should always return itself as the iterator object when the</span><br><span class="line">  // @@iterator function is called on it. Some browsers&apos; implementations of the</span><br><span class="line">  // iterator prototype chain incorrectly implement this, causing the Generator</span><br><span class="line">  // object to not be returned from this call. This ensures that doesn&apos;t happen.</span><br><span class="line">  // See https://github.com/facebook/regenerator/issues/274 for more details.</span><br><span class="line">  Gp[iteratorSymbol] = function() &#123;</span><br><span class="line">    return this;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Gp.toString = function() &#123;</span><br><span class="line">    return &quot;[object Generator]&quot;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  function pushTryEntry(locs) &#123;</span><br><span class="line">    var entry = &#123; tryLoc: locs[0] &#125;;</span><br><span class="line"></span><br><span class="line">    if (1 in locs) &#123;</span><br><span class="line">      entry.catchLoc = locs[1];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (2 in locs) &#123;</span><br><span class="line">      entry.finallyLoc = locs[2];</span><br><span class="line">      entry.afterLoc = locs[3];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this.tryEntries.push(entry);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function resetTryEntry(entry) &#123;</span><br><span class="line">    var record = entry.completion || &#123;&#125;;</span><br><span class="line">    record.type = &quot;normal&quot;;</span><br><span class="line">    delete record.arg;</span><br><span class="line">    entry.completion = record;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function Context(tryLocsList) &#123;</span><br><span class="line">    // The root entry object (effectively a try statement without a catch</span><br><span class="line">    // or a finally block) gives us a place to store values thrown from</span><br><span class="line">    // locations where there is no enclosing try statement.</span><br><span class="line">    this.tryEntries = [&#123; tryLoc: &quot;root&quot; &#125;];</span><br><span class="line">    tryLocsList.forEach(pushTryEntry, this);</span><br><span class="line">    this.reset(true);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  runtime.keys = function(object) &#123;</span><br><span class="line">    var keys = [];</span><br><span class="line">    for (var key in object) &#123;</span><br><span class="line">      keys.push(key);</span><br><span class="line">    &#125;</span><br><span class="line">    keys.reverse();</span><br><span class="line"></span><br><span class="line">    // Rather than returning an object with a next method, we keep</span><br><span class="line">    // things simple and return the next function itself.</span><br><span class="line">    return function next() &#123;</span><br><span class="line">      while (keys.length) &#123;</span><br><span class="line">        var key = keys.pop();</span><br><span class="line">        if (key in object) &#123;</span><br><span class="line">          next.value = key;</span><br><span class="line">          next.done = false;</span><br><span class="line">          return next;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // To avoid creating an additional object, we just hang the .value</span><br><span class="line">      // and .done properties off the next function object itself. This</span><br><span class="line">      // also ensures that the minifier will not anonymize the function.</span><br><span class="line">      next.done = true;</span><br><span class="line">      return next;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  function values(iterable) &#123;</span><br><span class="line">    if (iterable) &#123;</span><br><span class="line">      var iteratorMethod = iterable[iteratorSymbol];</span><br><span class="line">      if (iteratorMethod) &#123;</span><br><span class="line">        return iteratorMethod.call(iterable);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (typeof iterable.next === &quot;function&quot;) &#123;</span><br><span class="line">        return iterable;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (!isNaN(iterable.length)) &#123;</span><br><span class="line">        var i = -1, next = function next() &#123;</span><br><span class="line">          while (++i &lt; iterable.length) &#123;</span><br><span class="line">            if (hasOwn.call(iterable, i)) &#123;</span><br><span class="line">              next.value = iterable[i];</span><br><span class="line">              next.done = false;</span><br><span class="line">              return next;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          next.value = undefined;</span><br><span class="line">          next.done = true;</span><br><span class="line"></span><br><span class="line">          return next;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        return next.next = next;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Return an iterator with no values.</span><br><span class="line">    return &#123; next: doneResult &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  runtime.values = values;</span><br><span class="line"></span><br><span class="line">  function doneResult() &#123;</span><br><span class="line">    return &#123; value: undefined, done: true &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Context.prototype = &#123;</span><br><span class="line">    constructor: Context,</span><br><span class="line"></span><br><span class="line">    reset: function(skipTempReset) &#123;</span><br><span class="line">      this.prev = 0;</span><br><span class="line">      this.next = 0;</span><br><span class="line">      // Resetting context._sent for legacy support of Babel&apos;s</span><br><span class="line">      // function.sent implementation.</span><br><span class="line">      this.sent = this._sent = undefined;</span><br><span class="line">      this.done = false;</span><br><span class="line">      this.delegate = null;</span><br><span class="line"></span><br><span class="line">      this.method = &quot;next&quot;;</span><br><span class="line">      this.arg = undefined;</span><br><span class="line"></span><br><span class="line">      this.tryEntries.forEach(resetTryEntry);</span><br><span class="line"></span><br><span class="line">      if (!skipTempReset) &#123;</span><br><span class="line">        for (var name in this) &#123;</span><br><span class="line">          // Not sure about the optimal order of these conditions:</span><br><span class="line">          if (name.charAt(0) === &quot;t&quot; &amp;&amp;</span><br><span class="line">              hasOwn.call(this, name) &amp;&amp;</span><br><span class="line">              !isNaN(+name.slice(1))) &#123;</span><br><span class="line">            this[name] = undefined;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    stop: function() &#123;</span><br><span class="line">      this.done = true;</span><br><span class="line"></span><br><span class="line">      var rootEntry = this.tryEntries[0];</span><br><span class="line">      var rootRecord = rootEntry.completion;</span><br><span class="line">      if (rootRecord.type === &quot;throw&quot;) &#123;</span><br><span class="line">        throw rootRecord.arg;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return this.rval;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    dispatchException: function(exception) &#123;</span><br><span class="line">      if (this.done) &#123;</span><br><span class="line">        throw exception;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      var context = this;</span><br><span class="line">      function handle(loc, caught) &#123;</span><br><span class="line">        record.type = &quot;throw&quot;;</span><br><span class="line">        record.arg = exception;</span><br><span class="line">        context.next = loc;</span><br><span class="line"></span><br><span class="line">        if (caught) &#123;</span><br><span class="line">          // If the dispatched exception was caught by a catch block,</span><br><span class="line">          // then let that catch block handle the exception normally.</span><br><span class="line">          context.method = &quot;next&quot;;</span><br><span class="line">          context.arg = undefined;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return !! caught;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      for (var i = this.tryEntries.length - 1; i &gt;= 0; --i) &#123;</span><br><span class="line">        var entry = this.tryEntries[i];</span><br><span class="line">        var record = entry.completion;</span><br><span class="line"></span><br><span class="line">        if (entry.tryLoc === &quot;root&quot;) &#123;</span><br><span class="line">          // Exception thrown outside of any try block that could handle</span><br><span class="line">          // it, so set the completion value of the entire function to</span><br><span class="line">          // throw the exception.</span><br><span class="line">          return handle(&quot;end&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (entry.tryLoc &lt;= this.prev) &#123;</span><br><span class="line">          var hasCatch = hasOwn.call(entry, &quot;catchLoc&quot;);</span><br><span class="line">          var hasFinally = hasOwn.call(entry, &quot;finallyLoc&quot;);</span><br><span class="line"></span><br><span class="line">          if (hasCatch &amp;&amp; hasFinally) &#123;</span><br><span class="line">            if (this.prev &lt; entry.catchLoc) &#123;</span><br><span class="line">              return handle(entry.catchLoc, true);</span><br><span class="line">            &#125; else if (this.prev &lt; entry.finallyLoc) &#123;</span><br><span class="line">              return handle(entry.finallyLoc);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125; else if (hasCatch) &#123;</span><br><span class="line">            if (this.prev &lt; entry.catchLoc) &#123;</span><br><span class="line">              return handle(entry.catchLoc, true);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125; else if (hasFinally) &#123;</span><br><span class="line">            if (this.prev &lt; entry.finallyLoc) &#123;</span><br><span class="line">              return handle(entry.finallyLoc);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            throw new Error(&quot;try statement without catch or finally&quot;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    abrupt: function(type, arg) &#123;</span><br><span class="line">      for (var i = this.tryEntries.length - 1; i &gt;= 0; --i) &#123;</span><br><span class="line">        var entry = this.tryEntries[i];</span><br><span class="line">        if (entry.tryLoc &lt;= this.prev &amp;&amp;</span><br><span class="line">            hasOwn.call(entry, &quot;finallyLoc&quot;) &amp;&amp;</span><br><span class="line">            this.prev &lt; entry.finallyLoc) &#123;</span><br><span class="line">          var finallyEntry = entry;</span><br><span class="line">          break;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (finallyEntry &amp;&amp;</span><br><span class="line">          (type === &quot;break&quot; ||</span><br><span class="line">           type === &quot;continue&quot;) &amp;&amp;</span><br><span class="line">          finallyEntry.tryLoc &lt;= arg &amp;&amp;</span><br><span class="line">          arg &lt;= finallyEntry.finallyLoc) &#123;</span><br><span class="line">        // Ignore the finally entry if control is not jumping to a</span><br><span class="line">        // location outside the try/catch block.</span><br><span class="line">        finallyEntry = null;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      var record = finallyEntry ? finallyEntry.completion : &#123;&#125;;</span><br><span class="line">      record.type = type;</span><br><span class="line">      record.arg = arg;</span><br><span class="line"></span><br><span class="line">      if (finallyEntry) &#123;</span><br><span class="line">        this.method = &quot;next&quot;;</span><br><span class="line">        this.next = finallyEntry.finallyLoc;</span><br><span class="line">        return ContinueSentinel;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return this.complete(record);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    complete: function(record, afterLoc) &#123;</span><br><span class="line">      if (record.type === &quot;throw&quot;) &#123;</span><br><span class="line">        throw record.arg;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (record.type === &quot;break&quot; ||</span><br><span class="line">          record.type === &quot;continue&quot;) &#123;</span><br><span class="line">        this.next = record.arg;</span><br><span class="line">      &#125; else if (record.type === &quot;return&quot;) &#123;</span><br><span class="line">        this.rval = this.arg = record.arg;</span><br><span class="line">        this.method = &quot;return&quot;;</span><br><span class="line">        this.next = &quot;end&quot;;</span><br><span class="line">      &#125; else if (record.type === &quot;normal&quot; &amp;&amp; afterLoc) &#123;</span><br><span class="line">        this.next = afterLoc;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return ContinueSentinel;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    finish: function(finallyLoc) &#123;</span><br><span class="line">      for (var i = this.tryEntries.length - 1; i &gt;= 0; --i) &#123;</span><br><span class="line">        var entry = this.tryEntries[i];</span><br><span class="line">        if (entry.finallyLoc === finallyLoc) &#123;</span><br><span class="line">          this.complete(entry.completion, entry.afterLoc);</span><br><span class="line">          resetTryEntry(entry);</span><br><span class="line">          return ContinueSentinel;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    &quot;catch&quot;: function(tryLoc) &#123;</span><br><span class="line">      for (var i = this.tryEntries.length - 1; i &gt;= 0; --i) &#123;</span><br><span class="line">        var entry = this.tryEntries[i];</span><br><span class="line">        if (entry.tryLoc === tryLoc) &#123;</span><br><span class="line">          var record = entry.completion;</span><br><span class="line">          if (record.type === &quot;throw&quot;) &#123;</span><br><span class="line">            var thrown = record.arg;</span><br><span class="line">            resetTryEntry(entry);</span><br><span class="line">          &#125;</span><br><span class="line">          return thrown;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // The context.catch method must only be called with a location</span><br><span class="line">      // argument that corresponds to a known catch block.</span><br><span class="line">      throw new Error(&quot;illegal catch attempt&quot;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    delegateYield: function(iterable, resultName, nextLoc) &#123;</span><br><span class="line">      this.delegate = &#123;</span><br><span class="line">        iterator: values(iterable),</span><br><span class="line">        resultName: resultName,</span><br><span class="line">        nextLoc: nextLoc</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      if (this.method === &quot;next&quot;) &#123;</span><br><span class="line">        // Deliberately forget the last sent value so that we don&apos;t</span><br><span class="line">        // accidentally pass it on to the delegate.</span><br><span class="line">        this.arg = undefined;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return ContinueSentinel;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)(</span><br><span class="line">  // In sloppy mode, unbound `this` refers to the global object, fallback to</span><br><span class="line">  // Function constructor if we&apos;re in global strict mode. That is sadly a form</span><br><span class="line">  // of indirect eval which violates Content Security Policy.</span><br><span class="line">  (function() &#123;</span><br><span class="line">    return this || (typeof self === &quot;object&quot; &amp;&amp; self);</span><br><span class="line">  &#125;)() || Function(&quot;return this&quot;)()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">var _marked =</span><br><span class="line">/*#__PURE__*/</span><br><span class="line">regeneratorRuntime.mark(helloWorldGenerator);</span><br><span class="line"></span><br><span class="line">function helloWorldGenerator() &#123;</span><br><span class="line">  return regeneratorRuntime.wrap(function helloWorldGenerator$(_context) &#123;</span><br><span class="line">    while (1) &#123;</span><br><span class="line">      switch (_context.prev = _context.next) &#123;</span><br><span class="line">        case 0:</span><br><span class="line">          _context.next = 2;</span><br><span class="line">          return &apos;hello&apos;;</span><br><span class="line"></span><br><span class="line">        case 2:</span><br><span class="line">          _context.next = 4;</span><br><span class="line">          return &apos;world&apos;;</span><br><span class="line"></span><br><span class="line">        case 4:</span><br><span class="line">          return _context.abrupt(&quot;return&quot;, &apos;ending&apos;);</span><br><span class="line"></span><br><span class="line">        case 5:</span><br><span class="line">        case &quot;end&quot;:</span><br><span class="line">          return _context.stop();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, _marked, this);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var hw = helloWorldGenerator();</span><br><span class="line">console.log(hw.next()); // &#123;value: &quot;hello&quot;, done: false&#125;</span><br><span class="line"></span><br><span class="line">console.log(hw.next()); // &#123;value: &quot;world&quot;, done: false&#125;</span><br><span class="line"></span><br><span class="line">console.log(hw.next()); // &#123;value: &quot;ending&quot;, done: true&#125;</span><br><span class="line"></span><br><span class="line">console.log(hw.next()); // &#123;value: undefined, done: true&#125;</span><br></pre></td></tr></table></figure>
<p>总之编译后的代码还蛮复杂，我们可以从中抽离出大致的逻辑，至少让简单编译的那段代码能够跑起来。</p>
<h2 id="mark-函数"><a href="#mark-函数" class="headerlink" title="mark 函数"></a>mark 函数</h2><p>简单编译后的代码第一段是这样的：</p>
<pre><code>var _marked = /*#__PURE__*/ regeneratorRuntime.mark(helloWorldGenerator);
</code></pre><p>我们查看完整编译版本中 mark 函数的源码：</p>
<pre><code>runtime.mark = function(genFun) {
  genFun.__proto__ = GeneratorFunctionPrototype;
  genFun.prototype = Object.create(Gp);
  return genFun;
};
</code></pre><p>这其中又涉及了 GeneratorFunctionPrototype 和 Gp 变量，我们也查看下对应的代码：</p>
<pre><code>functionGenerator() {}
functionGeneratorFunction() {}
functionGeneratorFunctionPrototype() {}

...

var Gp = GeneratorFunctionPrototype.prototype =
  Generator.prototype = Object.create(IteratorPrototype);

GeneratorFunction.prototype = Gp.constructor = GeneratorFunctionPrototype;

GeneratorFunctionPrototype.constructor = GeneratorFunction;

GeneratorFunctionPrototype[toStringTagSymbol] =
  GeneratorFunction.displayName = &quot;GeneratorFunction&quot;;
</code></pre><p>这段代码构建了一堆看起来很复杂的关系链，其实这是参照着 <a href="https://link.juejin.im?target=https%3A%2F%2Fwww.ecma-international.org%2Fecma-262%2F6.0%2F%23sec-generatorfunction-constructor" target="_blank" rel="noopener">ES6 规范</a>构建的关系链:<br><img src="/2018/10/05/Babel-将-Generator-编译成了什么/166c52b4064a3c92.webp" alt="regenerator"><br>图中 <code>+@@toStringTag:s = &#39;Generator&#39;</code> 的就是 Gp，<code>+@@toStringTag:s = &#39;GeneratorFunction&#39;</code> 的就是 GeneratorFunctionPrototype。</p>
<p>构建关系链的目的在于判断关系的时候能够跟原生的保持一致，就比如：</p>
<pre><code>function* f() {}
var g = f();
console.log(g.__proto__ === f.prototype); // trueconsole.log(g.__proto__.__proto__ === f.__proto__.prototype); // true
</code></pre><p>为了简化起见，我们可以把 Gp 先设置为一个空对象，不过正如你在上图中看到的，next()、 throw()、return() 函数都是挂载在 Gp 对象上，实际上，在完整的编译代码中，确实有为 Gp 添加这三个函数的方法：</p>
<pre><code>// 117 行functiondefineIteratorMethods(prototype) {
  [&quot;next&quot;, &quot;throw&quot;, &quot;return&quot;].forEach(function(method) {
    prototype[method] = function(arg) {
      returnthis._invoke(method, arg);
    };
  });
}

// 406 行
defineIteratorMethods(Gp);
</code></pre><p>为了简单起见，我们将整个 mark 函数简化为：</p>
<pre><code>runtime.mark = function(genFun) {
  var generator = Object.create({
    next: function(arg) {
      returnthis._invoke(&apos;next&apos;, arg)
    }
  });
  genFun.prototype = generator;
  return genFun;
};
</code></pre><h2 id="wrap-函数"><a href="#wrap-函数" class="headerlink" title="wrap 函数"></a>wrap 函数</h2><p>除了设置关系链之外，mark 函数的返回值 genFun 还作为了 wrap 函数的第二个参数传入：</p>
<pre><code>functionhelloWorldGenerator() {
  return regeneratorRuntime.wrap(
    functionhelloWorldGenerator$(_context) {
      ...
    },
    _marked,
    this
  );
}
</code></pre><p>我们再看下 wrap 函数：</p>
<pre><code>functionwrap(innerFn, outerFn, self) {
  var generator = Object.create(outerFn.prototype);
  var context = new Context([]);
  generator._invoke = makeInvokeMethod(innerFn, self, context);

  return generator;
}
</code></pre><p>所以当执行 <code>var hw = helloWorldGenerator();</code> 的时候，其实执行的是 wrap 函数，wrap 函数返回了 generator，generator 是一个对象，原型是 <code>outerFn.prototype</code>, <code>outerFn.prototype</code> 其实就是 <code>genFun.prototype</code>， <code>genFun.prototype</code> 是一个空对象，原型上有 next() 方法。</p>
<p>所以当你执行 <code>hw.next()</code> 的时候，执行的其实是 hw 原型的原型上的 next 函数，next 函数执行的又是 hw 的 _invoke 函数：</p>
<pre><code>generator._invoke = makeInvokeMethod(innerFn, self, context);
</code></pre><p>innerFn 就是 wrap 包裹的那个函数，其实就是 helloWordGenerato$ 函数，呐，就是这个函数：</p>
<pre><code>functionhelloWorldGenerator$(_context) {
  while (1) {
    switch ((_context.prev = _context.next)) {
      case0:
        _context.next = 2;
        return&quot;hello&quot;;

      case2:
        _context.next = 4;
        return&quot;world&quot;;

      case4:
        return _context.abrupt(&quot;return&quot;, &quot;ending&quot;);

      case5:
      case&quot;end&quot;:
        return _context.stop();
    }
  }
}
</code></pre><p>而 context 你可以直接理解为这样一个全局对象：</p>
<pre><code>var ContinueSentinel = {};

var context = {
  done: false,
  method: &quot;next&quot;,
  next: 0,
  prev: 0,
  abrupt: function(type, arg) {
    var record = {};
    record.type = type;
    record.arg = arg;

    returnthis.complete(record);
  },
  complete: function(record, afterLoc) {
    if (record.type === &quot;return&quot;) {
      this.rval = this.arg = record.arg;
      this.method = &quot;return&quot;;
      this.next = &quot;end&quot;;
    }

    return ContinueSentinel;
  },
  stop: function() {
    this.done = true;
    returnthis.rval;
  }
};
</code></pre><p>每次 <code>hw.next</code> 的时候，就会修改 next 和 prev 属性的值，当在 generator 函数中 return 的时候会执行 abrupt，abrupt 中又会执行 complete，执行完 complete，因为 <code>this.next = end</code> 的缘故，再执行就会执行 stop 函数。</p>
<p>我们来看下 makeInvokeMethod 函数：</p>
<pre><code>var ContinueSentinel = {};

functionmakeInvokeMethod(innerFn, self, context) {
  var state = &apos;start&apos;;

  returnfunctioninvoke(method, arg) {

    if (state === &apos;completed&apos;) {
      return { value: undefined, done: true };
    }

    context.method = method;
    context.arg = arg;

    while (true) {

      state = &apos;executing&apos;;

      var record = {
        type: &apos;normal&apos;,
        arg: innerFn.call(self, context)
      };
      if (record.type === &quot;normal&quot;) {

        state = context.done
          ? &apos;completed&apos;
          : &apos;yield&apos;;

        if (record.arg === ContinueSentinel) {
          continue;
        }

        return {
          value: record.arg,
          done: context.done
        };

      }
    }
  };
}
</code></pre><p>基本的执行过程就不分析了，我们重点看第三次执行 <code>hw.next()</code> 的时候:</p>
<p>第三次执行 <code>hw.next()</code> 的时候，其实执行了</p>
<pre><code>this._invoke(&quot;next&quot;, undefined);
</code></pre><p>我们在 invoke 函数中构建了一个 record 对象：</p>
<pre><code>var record = {
  type: &quot;normal&quot;,
  arg: innerFn.call(self, context)
};
</code></pre><p>而在 <code>innerFn.call(self, context)</code> 中，因为 _context.next 为 4 的缘故，其实执行了:</p>
<pre><code>_context.abrupt(&quot;return&quot;, &apos;ending&apos;);
</code></pre><p>而在 abrupt 中，我们又构建了一个 record 对象：</p>
<pre><code>var record = {};
record.type = &apos;return&apos;;
record.arg = &apos;ending&apos;;
</code></pre><p>然后执行了 <code>this.complete(record)</code>，</p>
<p>在 complete 中，因为 <code>record.type === &quot;return&quot;</code></p>
<pre><code>this.rval = &apos;ending&apos;;
this.method = &quot;return&quot;;
this.next = &quot;end&quot;;
</code></pre><p>然后返回了全局对象 ContinueSentinel，其实就是一个全局空对象。</p>
<p>然后在 invoke 函数中，因为 <code>record.arg === ContinueSentinel</code> 的缘故，没有执行后面的 return 语句，就直接进入下一个循环。</p>
<p>于是又执行了一遍 <code>innerFn.call(self, context)</code>，此时 <code>_context.next</code> 为 end, 执行了 <code>_context.stop()</code>, 在 stop 函数中：</p>
<pre><code>this.done = true;
returnthis.rval; // this.rval 其实就是 `ending`
</code></pre><p>所以最终返回的值为:</p>
<pre><code>{
  value: &apos;ending&apos;,
  done: true
};
</code></pre><p>之后，我们再执行 hw.next() 的时候，因为 state 已经是 ‘completed’ 的缘故，直接就返回 <code>{ value: undefined, done: true}</code></p>
<h2 id="不完整但可用的源码"><a href="#不完整但可用的源码" class="headerlink" title="不完整但可用的源码"></a>不完整但可用的源码</h2><p>当然这个过程，看文字理解起来可能有些难度，不完整但可用的代码如下，你可以断点调试查看具体的过程：</p>
<pre><code>(function() {
  var ContinueSentinel = {};

  var mark = function(genFun) {
    var generator = Object.create({
      next: function(arg) {
        returnthis._invoke(&quot;next&quot;, arg);
      }
    });
    genFun.prototype = generator;
    return genFun;
  };

  functionwrap(innerFn, outerFn, self) {
    var generator = Object.create(outerFn.prototype);

    var context = {
      done: false,
      method: &quot;next&quot;,
      next: 0,
      prev: 0,
      abrupt: function(type, arg) {
        var record = {};
        record.type = type;
        record.arg = arg;

        returnthis.complete(record);
      },
      complete: function(record, afterLoc) {
        if (record.type === &quot;return&quot;) {
          this.rval = this.arg = record.arg;
          this.method = &quot;return&quot;;
          this.next = &quot;end&quot;;
        }

        return ContinueSentinel;
      },
      stop: function() {
        this.done = true;
        returnthis.rval;
      }
    };

    generator._invoke = makeInvokeMethod(innerFn, context);

    return generator;
  }

  functionmakeInvokeMethod(innerFn, context) {
    var state = &quot;start&quot;;

    returnfunctioninvoke(method, arg) {
      if (state === &quot;completed&quot;) {
        return { value: undefined, done: true };
      }

      context.method = method;
      context.arg = arg;

      while (true) {
        state = &quot;executing&quot;;

        var record = {
          type: &quot;normal&quot;,
          arg: innerFn.call(self, context)
        };

        if (record.type === &quot;normal&quot;) {
          state = context.done ? &quot;completed&quot; : &quot;yield&quot;;

          if (record.arg === ContinueSentinel) {
            continue;
          }

          return {
            value: record.arg,
            done: context.done
          };
        }
      }
    };
  }

  window.regeneratorRuntime = {};

  regeneratorRuntime.wrap = wrap;
  regeneratorRuntime.mark = mark;
})();

var _marked = regeneratorRuntime.mark(helloWorldGenerator);

functionhelloWorldGenerator() {
  return regeneratorRuntime.wrap(
    functionhelloWorldGenerator$(_context) {
      while (1) {
        switch ((_context.prev = _context.next)) {
          case0:
            _context.next = 2;
            return&quot;hello&quot;;

          case2:
            _context.next = 4;
            return&quot;world&quot;;

          case4:
            return _context.abrupt(&quot;return&quot;, &quot;ending&quot;);

          case5:
          case&quot;end&quot;:
            return _context.stop();
        }
      }
    },
    _marked,
    this
  );
}

var hw = helloWorldGenerator();

console.log(hw.next());
console.log(hw.next());
console.log(hw.next());
console.log(hw.next());
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/04/简单理解async、await语法实现原理/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/04/简单理解async、await语法实现原理/" itemprop="url">简单理解async、await语法实现原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-04T23:57:27+08:00">
                2018-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>现在最新的前端框架生态都开始用上了Generator和yield，<br>有的甚至已经开始使用最新的async、await语法了，<br><strong>这两样都是基于Generator自动执行的原理。</strong></p>
<h2 id="阮一峰-async-函数的实现原理"><a href="#阮一峰-async-函数的实现原理" class="headerlink" title="阮一峰 async-函数的实现原理"></a>阮一峰 <a href="https://link.juejin.im?target=http%3A%2F%2Fes6.ruanyifeng.com%2F%23docs%2Fasync%23async-%25E5%2587%25BD%25E6%2595%25B0%25E7%259A%2584%25E5%25AE%259E%25E7%258E%25B0%25E5%258E%259F%25E7%2590%2586" target="_blank" rel="noopener">async-函数的实现原理</a></h2><h4 id="async-函数的实现原理，就是将-Generator-函数和自动执行器，包装在一个函数里。"><a href="#async-函数的实现原理，就是将-Generator-函数和自动执行器，包装在一个函数里。" class="headerlink" title="async 函数的实现原理，就是将 Generator 函数和自动执行器，包装在一个函数里。"></a>async 函数的实现原理，就是将 Generator 函数和自动执行器，包装在一个函数里。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">async function fn(args) &#123;</span><br><span class="line">  // ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 等同于</span><br><span class="line">function fn(args) &#123;</span><br><span class="line">  return spawn(function* () &#123;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有的async函数都可以写成上面的第二种形式，其中的spawn函数就是自动执行器。</p>
<p>下面给出spawn函数的实现，基本就是前文自动执行器的翻版。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">function spawn(genF) &#123;</span><br><span class="line">  return new Promise(function(resolve, reject) &#123;</span><br><span class="line">    const gen = genF();</span><br><span class="line">    function step(nextF) &#123;</span><br><span class="line">      let next;</span><br><span class="line">      try &#123;</span><br><span class="line">        next = nextF();</span><br><span class="line">      &#125; catch(e) &#123;</span><br><span class="line">        return reject(e);</span><br><span class="line">      &#125;</span><br><span class="line">      if(next.done) &#123;</span><br><span class="line">        return resolve(next.value);</span><br><span class="line">      &#125;</span><br><span class="line">      Promise.resolve(next.value).then(function(v) &#123;</span><br><span class="line">        step(function() &#123; return gen.next(v); &#125;);</span><br><span class="line">      &#125;, function(e) &#123;</span><br><span class="line">        step(function() &#123; return gen.throw(e); &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    step(function() &#123; return gen.next(undefined); &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">		&lt;title&gt;&lt;/title&gt;</span><br><span class="line">		&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">			function timeout(ms) &#123;</span><br><span class="line">				return &#123;</span><br><span class="line">					text: &apos;done&apos;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			function* start() &#123;</span><br><span class="line">				const res = yield timeout(1000);</span><br><span class="line">				return res;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">		 </span><br><span class="line">             </span><br><span class="line"></span><br><span class="line">			function fn(args) &#123;</span><br><span class="line">				return spawn(start);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			function spawn(genF) &#123;</span><br><span class="line">				return new Promise(function(resolve, reject) &#123;</span><br><span class="line">					const gen = genF();</span><br><span class="line">					function step(nextF) &#123;</span><br><span class="line">						let next;</span><br><span class="line">						try &#123;</span><br><span class="line">							next = nextF();</span><br><span class="line">						&#125; catch(e) &#123;</span><br><span class="line">							return reject(e);</span><br><span class="line">						&#125;</span><br><span class="line">						if(next.done) &#123;</span><br><span class="line">							return resolve(next.value);</span><br><span class="line">						&#125;</span><br><span class="line">						</span><br><span class="line">					</span><br><span class="line">						Promise.resolve(next.value).then(function(v) &#123;</span><br><span class="line">							step(function() &#123;</span><br><span class="line">								return gen.next(v);</span><br><span class="line">							&#125;);</span><br><span class="line">						&#125;, function(e) &#123;</span><br><span class="line">							step(function() &#123;</span><br><span class="line">								return gen.throw(e);</span><br><span class="line">							&#125;);</span><br><span class="line">						&#125;);</span><br><span class="line">					&#125;</span><br><span class="line">					step(function() &#123;</span><br><span class="line">						return gen.next();</span><br><span class="line">					&#125;);</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			 fn().then((data)=&gt;&#123;</span><br><span class="line">				console.log(data)</span><br><span class="line">			&#125;)</span><br><span class="line">		&lt;/script&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">	&lt;body&gt;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h3 id="看下babel转换后的"><a href="#看下babel转换后的" class="headerlink" title="看下babel转换后的"></a>看下babel转换后的</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">async function fns(args) &#123;</span><br><span class="line">				const res = await fetch(&apos;google.com&apos;);</span><br><span class="line">				return res.text();</span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&apos;use strict&apos;;</span><br><span class="line">    </span><br><span class="line">		var fns = function() &#123;</span><br><span class="line">			var _ref = _asyncToGenerator(regeneratorRuntime.mark(function _callee(args) &#123;</span><br><span class="line">				var res;</span><br><span class="line">				return regeneratorRuntime.wrap(function _callee$(_context) &#123;</span><br><span class="line">					while(1) &#123;</span><br><span class="line">						switch(_context.prev = _context.next) &#123;</span><br><span class="line">							case 0:</span><br><span class="line">								_context.next = 2;</span><br><span class="line">								return fetch(&apos;google.com&apos;);</span><br><span class="line">    </span><br><span class="line">							case 2:</span><br><span class="line">								res = _context.sent;</span><br><span class="line">								return _context.abrupt(&apos;return&apos;, res.text());</span><br><span class="line">    </span><br><span class="line">							case 4:</span><br><span class="line">							case&apos;end&apos;:</span><br><span class="line">								return _context.stop();</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;, _callee, this);</span><br><span class="line">			&#125;));</span><br><span class="line">    </span><br><span class="line">			returnfunction fns(_x) &#123;</span><br><span class="line">				return _ref.apply(this, arguments);</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;();</span><br><span class="line">    </span><br><span class="line">		function _asyncToGenerator(fn) &#123;  //Generator函数自动执行</span><br><span class="line">			returnfunction() &#123;</span><br><span class="line">				var gen = fn.apply(this, arguments);</span><br><span class="line">				return new Promise(function(resolve, reject) &#123;</span><br><span class="line">					function step(key, arg) &#123;</span><br><span class="line">						try &#123;</span><br><span class="line">							var info = gen[key](arg);</span><br><span class="line">							var value = info.value;</span><br><span class="line">						&#125; catch(error) &#123;</span><br><span class="line">							reject(error);</span><br><span class="line">							return;</span><br><span class="line">						&#125;</span><br><span class="line">						if(info.done) &#123;</span><br><span class="line">							resolve(value);</span><br><span class="line">						&#125; else &#123;</span><br><span class="line">							return Promise.resolve(value).then(function(value) &#123;</span><br><span class="line">								step(&quot;next&quot;, value);</span><br><span class="line">							&#125;, function(err) &#123;</span><br><span class="line">								step(&quot;throw&quot;, err);</span><br><span class="line">							&#125;);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					return step(&quot;next&quot;);</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>一、thunk函数<br>thunk函数指的是能将执行结果传入回调函数，并将该回调函数返回的函数。<br>是不是有点抽象，举个例子:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var readFile = function (fileName) &#123;</span><br><span class="line">    returnfunction (callback) &#123;</span><br><span class="line">        return fs.readFile(fileName, callback)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面我们来看下thunk函数怎样执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">readFile(&apos;./package.json&apos;)((err, str) =&gt; &#123;</span><br><span class="line">    console.log(str.toString())</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>问: thunk的执行比普通函数要麻烦不少，那么它有什么优势呢？</p>
<h3 id="thunk函数的优势在于它能将异步操作返回结果的获取权交给thunk函数的返回值，"><a href="#thunk函数的优势在于它能将异步操作返回结果的获取权交给thunk函数的返回值，" class="headerlink" title="thunk函数的优势在于它能将异步操作返回结果的获取权交给thunk函数的返回值，"></a>thunk函数的优势在于它能将异步操作返回结果的获取权交给thunk函数的返回值，</h3><p>而不是将异步操作结果传入thunk函数本身的作用域内，这点很重要，<br>因为它能结合Generator语法让Generator函数自动执行</p>
<p>二、Generator<br>es6的Generator函数，具体语法这里就不介绍了，</p>
<p>我们来编写一个基于thunk函数的Generator：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">let gen = function* () &#123;</span><br><span class="line">    let r1 = yield readFile(&apos;./package.json&apos;)</span><br><span class="line">    console.log(r1.toString())</span><br><span class="line">    let r2 = yield readFile(&apos;./index.js&apos;)</span><br><span class="line">    console.log(r2.toString())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们来手动执行一下这个Generator:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">let g = gen()</span><br><span class="line">let r1 = g.next()</span><br><span class="line">r1.value(function (err, data) &#123;</span><br><span class="line">    if (err) &#123;</span><br><span class="line">        throw err</span><br><span class="line">    &#125;</span><br><span class="line">    let r2 = g.next(data)</span><br><span class="line">    r2.value(function (err, data) &#123;</span><br><span class="line">        if (err) &#123;</span><br><span class="line">            throw err</span><br><span class="line">        &#125;</span><br><span class="line">        g.next(data)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>可以注意到，在我们手动执行基于thunk函数的Generator时，<br>有很多代码是可以复用的，<br>没错，所谓的Generator自动执行就是把这些可复用的部分封装成函数，<br>然后让它们递归执行，直到执行完所有的yield。</p>
<p>三、Generator自动执行器<br>下面就是Generator自动执行的核心代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function run(fn) &#123;</span><br><span class="line">    let gen = fn()</span><br><span class="line">    function next(err, data) &#123;</span><br><span class="line">        let result = gen.next(data)</span><br><span class="line">        if (result.done) &#123;</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        result.value(next)</span><br><span class="line">    &#125;</span><br><span class="line">    next()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到无非就是把可复用的部分封装成next函数，然后让其<strong>递归</strong>执行，<br>直到执行完所有的yield</p>
<p>其调用代码为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run(gen)</span><br></pre></td></tr></table></figure></p>
<p>这样就将原本繁杂的异步操作封装的十分简单了</p>
<p>基于Promise的Generator的自动执行<br>上面的例子是基于thunk函数的，而即将出现的es7的async、await语法是基于Promise的</p>
<p>这里再上一个基于Promise的Generator的自动执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">//包装返回Promise对象的函数</span><br><span class="line">functionreadFile(fileName) &#123;</span><br><span class="line">    return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">        fs.readFile(fileName, (error, data) =&gt; &#123;</span><br><span class="line">            if (error) &#123;</span><br><span class="line">                reject(error)</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                resolve(data)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">// 编写Generator</span><br><span class="line">let gen = function* () &#123;</span><br><span class="line">    let r1 = yield readFile(&apos;./package.json&apos;)</span><br><span class="line">    console.log(r1.toString())</span><br><span class="line">    let r2 = yield readFile(&apos;./index.js&apos;)</span><br><span class="line">    console.log(r2.toString())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 编写Generator执行器</span><br><span class="line">function run(gen) &#123;</span><br><span class="line">    let g = gen()</span><br><span class="line">    function next(data) &#123;</span><br><span class="line">        let result = g.next(data)</span><br><span class="line">        if (result.done) &#123;</span><br><span class="line">            return result.value</span><br><span class="line">        &#125;</span><br><span class="line">        result.value.then((data) =&gt; next(data))</span><br><span class="line">    &#125;</span><br><span class="line">    next()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//用Generator执行器自动执行</span><br><span class="line">run(gen)</span><br></pre></td></tr></table></figure></p>
<p>这个和基于thunk函数的大同小异，只是把函数返回值的获取权以Promise的方式交出</p>
<h4 id="参考-简单理解Generator自执行及async、await语法原理"><a href="#参考-简单理解Generator自执行及async、await语法原理" class="headerlink" title="参考 简单理解Generator自执行及async、await语法原理"></a>参考 <a href="https://link.juejin.im?target=https%3A%2F%2Fsegmentfault.com%2Fa%2F1190000008254704" target="_blank" rel="noopener">简单理解Generator自执行及async、await语法原理</a></h4>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/04/ES6之-Generator-的惰性执行/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/04/ES6之-Generator-的惰性执行/" itemprop="url">ES6之 Generator 的惰性执行</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-04T23:56:27+08:00">
                2018-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="单个异步任务"><a href="#单个异步任务" class="headerlink" title="单个异步任务"></a>单个异步任务</h2><pre><code>var fetch = require(&apos;node-fetch&apos;);

function* gen(){
    var url = &apos;https://api.github.com/users/github&apos;;
    var result = yield fetch(url);
    console.log(result.bio);
}
</code></pre><p>为了获得最终的执行结果，你需要这样做：</p>
<pre><code>var g = gen();
var result = g.next();

result.value.then(function(data){
    return data.json();
}).then(function(data){
    g.next(data);
});
</code></pre><p>首先执行 Generator 函数，获取遍历器对象。</p>
<p>然后使用 next 方法，执行异步任务的第一阶段，即 fetch(url)。</p>
<p>注意，由于 fetch(url) 会返回一个 Promise 对象，所以 result 的值为：</p>
<pre><code>{ value: Promise { &lt;pending&gt; }, done: false }
</code></pre><p>最后我们为这个 Promise 对象添加一个 then 方法，先将其返回的数据格式化(<code>data.json()</code>)，再调用 g.next，将获得的数据传进去，由此可以执行异步任务的第二阶段，代码执行完毕。</p>
<h2 id="多个异步任务"><a href="#多个异步任务" class="headerlink" title="多个异步任务"></a>多个异步任务</h2><p>上节我们只调用了一个接口，那如果我们调用了多个接口，使用了多个 yield，我们岂不是要在 then 函数中不断的嵌套下去……</p>
<p>所以我们来看看执行多个异步任务的情况：</p>
<pre><code>var fetch = require(&apos;node-fetch&apos;);

function* gen() {
    var r1 = yield fetch(&apos;https://api.github.com/users/github&apos;);
    var r2 = yield fetch(&apos;https://api.github.com/users/github/followers&apos;);
    var r3 = yield fetch(&apos;https://api.github.com/users/github/repos&apos;);

    console.log([r1.bio, r2[0].login, r3[0].full_name].join(&apos;\n&apos;));
}
</code></pre><p>为了获得最终的执行结果，你可能要写成：</p>
<pre><code>var g = gen();
var result1 = g.next();

result1.value.then(function(data){
    return data.json();
})
.then(function(data){
    return g.next(data).value;
})
.then(function(data){
    return data.json();
})
.then(function(data){
    return g.next(data).value
})
.then(function(data){
    return data.json();
})
.then(function(data){
    g.next(data)
});
</code></pre><p>但我知道你肯定不想写成这样……</p>
<p>其实，利用递归，我们可以这样写：</p>
<pre><code>functionrun(gen) {
    var g = gen();

    function next(data) {
        var result = g.next(data);

        if (result.done) return;

        result.value.then(function(data) {
            return data.json();
        }).then(function(data) {
            next(data);
        });

    }

    next();
}

run(gen);
</code></pre><p>其中的关键就是 yield 的时候返回一个 Promise 对象，给这个 Promise 对象添加 then 方法，当异步操作成功时执行 then 中的 onFullfilled 函数，onFullfilled 函数中又去执行 g.next，从而让 Generator 继续执行，然后再返回一个 Promise，再在成功时执行 g.next，然后再返回……</p>
<h2 id="启动器函数"><a href="#启动器函数" class="headerlink" title="启动器函数"></a>启动器函数</h2><p>在 run 这个启动器函数中，我们在 then 函数中将数据格式化 <code>data.json()</code>，但在更广泛的情况下，比如 yield 直接跟一个 Promise，而非一个 fetch 函数返回的 Promise，因为没有 json 方法，代码就会报错。所以为了更具备通用性，连同这个例子和启动器，我们修改为：</p>
<pre><code>var fetch = require(&apos;node-fetch&apos;);

function* gen() {
    var r1 = yield fetch(&apos;https://api.github.com/users/github&apos;);
    var json1 = yield r1.json();
    var r2 = yield fetch(&apos;https://api.github.com/users/github/followers&apos;);
    var json2 = yield r2.json();
    var r3 = yield fetch(&apos;https://api.github.com/users/github/repos&apos;);
    var json3 = yield r3.json();

    console.log([json1.bio, json2[0].login, json3[0].full_name].join(&apos;\n&apos;));
}

function run(gen) {
    var g = gen();

    functionnext(data) {
        var result = g.next(data);

        if (result.done) return;

        result.value.then(function(data) {
            next(data);
        });

    }

    next();
}

run(gen);
</code></pre><p>只要 yield 后跟着一个 Promise 对象，我们就可以利用这个 run 函数将 Generator 函数自动执行。</p>
<h2 id="回调函数"><a href="#回调函数" class="headerlink" title="回调函数"></a>回调函数</h2><p>yield 后一定要跟着一个 Promise 对象才能保证 Generator 的自动执行吗？如果只是一个回调函数呢？我们来看个例子：</p>
<p>首先我们来模拟一个普通的异步请求：</p>
<pre><code>function fetchData(url, cb) {
    setTimeout(function(){
        cb({status: 200, data: url})
    }, 1000)
}
</code></pre><p>我们将这种函数改造成：</p>
<pre><code>function fetchData(url) {
    returnfunction(cb){
        setTimeout(function(){
            cb({status: 200, data: url})
        }, 1000)
    }
}
</code></pre><p>对于这样的 Generator 函数：</p>
<pre><code>function* gen() {
    var r1 = yield fetchData(&apos;https://api.github.com/users/github&apos;);
    var r2 = yield fetchData(&apos;https://api.github.com/users/github/followers&apos;);

    console.log([r1.data, r2.data].join(&apos;\n&apos;));
}
</code></pre><p>如果要获得最终的结果：</p>
<pre><code>var g = gen();

var r1 = g.next();

r1.value(function(data) {
    var r2 = g.next(data);
    r2.value(function(data) {
        g.next(data);
    });
});
</code></pre><p>如果写成这样的话，我们会面临跟第一节同样的问题，那就是当使用多个 yield 时，代码会循环嵌套起来……</p>
<p>同样利用递归，所以我们可以将其改造为：</p>
<pre><code>functionrun(gen) {
    var g = gen();

    functionnext(data) {
        var result = g.next(data);

        if (result.done) return;

        result.value(next);
    }

    next();
}

run(gen);
</code></pre><h2 id="run"><a href="#run" class="headerlink" title="run"></a>run</h2><p>由此可以看到 Generator 函数的自动执行需要一种机制，即当异步操作有了结果，能够自动交回执行权。</p>
<p>而两种方法可以做到这一点。</p>
<p>（1）回调函数。将异步操作进行包装，暴露出回调函数，在回调函数里面交回执行权。</p>
<p>（2）Promise 对象。将异步操作包装成 Promise 对象，用 then 方法交回执行权。</p>
<p>在两种方法中，我们各写了一个 run 启动器函数，那我们能不能将这两种方式结合在一些，写一个通用的 run 函数呢？我们尝试一下：</p>
<pre><code>// 第一版functionrun(gen) {
    var gen = gen();

    functionnext(data) {
        var result = gen.next(data);
        if (result.done) return;

        if (isPromise(result.value)) {
            result.value.then(function(data) {
                next(data);
            });
        } else {
            result.value(next)
        }
    }

    next()
}

functionisPromise(obj) {
    return&apos;function&apos; == typeof obj.then;
}

module.exports = run;
</code></pre><p>其实实现的很简单，判断 result.value 是否是 Promise，是就添加 then 函数，不是就直接执行。</p>
<h2 id="return-Promise"><a href="#return-Promise" class="headerlink" title="return Promise"></a>return Promise</h2><p>我们已经写了一个不错的启动器函数，支持 yield 后跟回调函数或者 Promise 对象。</p>
<p>现在有一个问题需要思考，就是我们如何获得 Generator 函数的返回值呢？又如果 Generator 函数中出现了错误，就比如 fetch 了一个不存在的接口，这个错误该如何捕获呢？</p>
<p>这很容易让人想到 Promise，如果这个启动器函数返回一个 Promise，我们就可以给这个 Promise 对象添加 then 函数，当所有的异步操作执行成功后，我们执行 onFullfilled 函数，如果有任何失败，就执行 onRejected 函数。</p>
<p>我们写一版：</p>
<pre><code>// 第二版functionrun(gen) {
    var gen = gen();

    returnnewPromise(function(resolve, reject) {

        functionnext(data) {
            try {
                var result = gen.next(data);
            } catch (e) {
                return reject(e);
            }

            if (result.done) {
                return resolve(result.value)
            };

            var value = toPromise(result.value);

            value.then(function(data) {
                next(data);
            }, function(e) {
                reject(e)
            });
        }

        next()
    })

}

functionisPromise(obj) {
    return&apos;function&apos; == typeof obj.then;
}

functiontoPromise(obj) {
    if (isPromise(obj)) return obj;
    if (&apos;function&apos; == typeof obj) return thunkToPromise(obj);
    return obj;
}

functionthunkToPromise(fn) {
    returnnewPromise(function(resolve, reject) {
        fn(function(err, res) {
            if (err) return reject(err);
            resolve(res);
        });
    });
}

module.exports = run;
</code></pre><p>与第一版有很大的不同：</p>
<p>首先，我们返回了一个 Promise，当 <code>result.done</code> 为 true 的时候，我们将该值 <code>resolve(result.value)</code>，如果执行的过程中出现错误，被 catch 住，我们会将原因 <code>reject(e)</code>。</p>
<p>其次，我们会使用 <code>thunkToPromise</code> 将回调函数包装成一个 Promise，然后统一的添加 then 函数。在这里值得注意的是，在 <code>thunkToPromise</code> 函数中，我们遵循了 error first 的原则，这意味着当我们处理回调函数的情况时：</p>
<pre><code>// 模拟数据请求functionfetchData(url) {
    returnfunction(cb) {
        setTimeout(function() {
            cb(null, { status: 200, data: url })
        }, 1000)
    }
}
</code></pre><p>在成功时，第一个参数应该返回 null，表示没有错误原因。</p>
<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>我们在第二版的基础上将代码写的更加简洁优雅一点，最终的代码如下：</p>
<pre><code>// 第三版functionrun(gen) {

    returnnewPromise(function(resolve, reject) {
        if (typeof gen == &apos;function&apos;) gen = gen();

        // 如果 gen 不是一个迭代器if (!gen || typeof gen.next !== &apos;function&apos;) return resolve(gen)

        onFulfilled();

        functiononFulfilled(res) {
            var ret;
            try {
                ret = gen.next(res);
            } catch (e) {
                return reject(e);
            }
            next(ret);
        }

        functiononRejected(err) {
            var ret;
            try {
                ret = gen.throw(err);
            } catch (e) {
                return reject(e);
            }
            next(ret);
        }

        functionnext(ret) {
            if (ret.done) return resolve(ret.value);
            var value = toPromise(ret.value);
            if (value &amp;&amp; isPromise(value)) return value.then(onFulfilled, onRejected);
            return onRejected(newTypeError(&apos;You may only yield a function, promise &apos; +
                &apos;but the following object was passed: &quot;&apos; + String(ret.value) + &apos;&quot;&apos;));
        }
    })
}

functionisPromise(obj) {
    return&apos;function&apos; == typeof obj.then;
}

functiontoPromise(obj) {
    if (isPromise(obj)) return obj;
    if (&apos;function&apos; == typeof obj) return thunkToPromise(obj);
    return obj;
}

functionthunkToPromise(fn) {
    returnnewPromise(function(resolve, reject) {
        fn(function(err, res) {
            if (err) return reject(err);
            resolve(res);
        });
    });
}

module.exports = run;
</code></pre><h2 id="co"><a href="#co" class="headerlink" title="co"></a>co</h2><p>如果我们再将这个启动器函数写的完善一些，我们就相当于写了一个 co，实际上，上面的代码确实是来自于 co……</p>
<p>而 co 是什么？ co 是大神 TJ Holowaychuk 于 2013 年 6 月发布的一个小模块，用于 Generator 函数的自动执行。</p>
<p>如果直接使用 co 模块，这两种不同的例子可以简写为：</p>
<pre><code>// yield 后是一个 Promisevar fetch = require(&apos;node-fetch&apos;);
var co = require(&apos;co&apos;);

function* gen() {
    var r1 = yield fetch(&apos;https://api.github.com/users/github&apos;);
    var json1 = yield r1.json();
    var r2 = yield fetch(&apos;https://api.github.com/users/github/followers&apos;);
    var json2 = yield r2.json();
    var r3 = yield fetch(&apos;https://api.github.com/users/github/repos&apos;);
    var json3 = yield r3.json();

    console.log([json1.bio, json2[0].login, json3[0].full_name].join(&apos;\n&apos;));
}

co(gen);


// yield 后是一个回调函数var co = require(&apos;co&apos;);

functionfetchData(url) {
    returnfunction(cb) {
        setTimeout(function() {
            cb(null, { status: 200, data: url })
        }, 1000)
    }
}

function* gen() {
    var r1 = yield fetchData(&apos;https://api.github.com/users/github&apos;);
    var r2 = yield fetchData(&apos;https://api.github.com/users/github/followers&apos;);

    console.log([r1.data, r2.data].join(&apos;\n&apos;));
}

co(gen);
</code></pre><p>是不是特别的好用？</p>
<h2 id="ES6-系列"><a href="#ES6-系列" class="headerlink" title="ES6 系列"></a>ES6 系列</h2><p>ES6 系列预计写二十篇左右，旨在加深 ES6 部分知识点的理解，重点讲解块级作用域、标签模板、箭头函数、Symbol、Set、Map 以及 Promise 的模拟实现、模块加载方案、异步处理等内容。</p>
<p>如果有错误或者不严谨的地方，请务必给予指正，十分感谢。如果喜欢或者有所启发，欢迎 star，对作者也是一种鼓励。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/03/Vue权限控制addRoutes/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/03/Vue权限控制addRoutes/" itemprop="url">Vue权限控制addRoutes</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-03T12:50:52+08:00">
                2018-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="说到Vue权限控制，你可能会第一个想到"><a href="#说到Vue权限控制，你可能会第一个想到" class="headerlink" title="说到Vue权限控制，你可能会第一个想到"></a>说到Vue权限控制，你可能会第一个想到</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Created by superman on 17/2/16.</span><br><span class="line"> * http配置</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">import axios from &apos;axios&apos;</span><br><span class="line">import store from &apos;./store/store&apos;</span><br><span class="line">import * as types from &apos;./store/types&apos;</span><br><span class="line">import router from &apos;./router&apos;</span><br><span class="line"></span><br><span class="line">// axios 配置</span><br><span class="line">axios.defaults.timeout = 5000;</span><br><span class="line">axios.defaults.baseURL = &apos;https://api.github.com&apos;;</span><br><span class="line"></span><br><span class="line">// http request 拦截器</span><br><span class="line">axios.interceptors.request.use(</span><br><span class="line">    config =&gt; &#123;</span><br><span class="line">        if (store.state.token) &#123;</span><br><span class="line">            config.headers.Authorization = `token $&#123;store.state.token&#125;`;</span><br><span class="line">        &#125;</span><br><span class="line">        return config;</span><br><span class="line">    &#125;,</span><br><span class="line">    err =&gt; &#123;</span><br><span class="line">        return Promise.reject(err);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">// http response 拦截器</span><br><span class="line">axios.interceptors.response.use(</span><br><span class="line">    response =&gt; &#123;</span><br><span class="line">        return response;</span><br><span class="line">    &#125;,</span><br><span class="line">    error =&gt; &#123;</span><br><span class="line">        if (error.response) &#123;</span><br><span class="line">            switch (error.response.status) &#123;</span><br><span class="line">                case 401:</span><br><span class="line">                    // 401 清除token信息并跳转到登录页面</span><br><span class="line">                    store.commit(types.LOGOUT);</span><br><span class="line">                    router.replace(&#123;</span><br><span class="line">                        path: &apos;login&apos;,</span><br><span class="line">                        query: &#123;redirect: router.currentRoute.fullPath&#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // console.log(JSON.stringify(error));//console : Error: Request failed with status code 402</span><br><span class="line">        return Promise.reject(error.response.data)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">export default axios;</span><br></pre></td></tr></table></figure>
<h3 id="VueRouter"><a href="#VueRouter" class="headerlink" title="VueRouter"></a>VueRouter</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const router = new VueRouter(&#123;</span><br><span class="line">    routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.beforeEach((to, from, next) =&gt; &#123;</span><br><span class="line">    if (to.path == &apos;/login&apos;) &#123;</span><br><span class="line">         //清除token</span><br><span class="line">         ...</span><br><span class="line">    &#125;</span><br><span class="line">    let token = get(&apos;token&apos;);   //获取token</span><br><span class="line">    if (!token &amp;&amp; to.path != &apos;/login&apos;) &#123;</span><br><span class="line">        next(&#123; path: &apos;/login&apos; &#125;)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        next()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="但上面的只能对登录拦截-跳转拦截，不能控制user权限，最好的方式是动态注入路由addRoutes"><a href="#但上面的只能对登录拦截-跳转拦截，不能控制user权限，最好的方式是动态注入路由addRoutes" class="headerlink" title="但上面的只能对登录拦截,跳转拦截，不能控制user权限，最好的方式是动态注入路由addRoutes"></a>但上面的只能对登录拦截,跳转拦截，不能控制user权限，最好的方式是动态注入路由<strong><font color="#dd0000">addRoutes</font></strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import router from &apos;./router&apos;</span><br><span class="line">router.addRoutes(routes)</span><br><span class="line">或者</span><br><span class="line">this.$router.addRoutes(routers)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/30/compose-串联中间件实现-洋葱模型/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/30/compose-串联中间件实现-洋葱模型/" itemprop="url">Koa2 compose-串联中间件实现(洋葱模型)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-30T12:41:27+08:00">
                2018-09-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="koa2-一网打尽（基本使用，洋葱圈，中间件机制和模拟，源码分析，核心点，生态）"><a href="#koa2-一网打尽（基本使用，洋葱圈，中间件机制和模拟，源码分析，核心点，生态）" class="headerlink" title="koa2 一网打尽（基本使用，洋葱圈，中间件机制和模拟，源码分析，核心点，生态）"></a><a href="https://github.com/HCThink/h-blog/blob/master/source/koa2/readme.md" target="_blank" rel="noopener">koa2 一网打尽（基本使用，洋葱圈，中间件机制和模拟，源码分析，核心点，生态）</a></h2><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><code>Koa</code> 是当下主流 NodeJS 框架，以轻量见长，而它中间件机制与相对传统的 <code>Express</code> 支持了异步，所以编码时经常使用 <code>async/await</code>，提高了可读性，使代码变得更优雅，上一篇文章 <a href="https://link.juejin.im?target=https%3A%2F%2Fwww.pandashen.com%2F2018%2F09%2F02%2F20180902141819%2F" target="_blank" rel="noopener">NodeJS 进阶 —— Koa 源码分析</a>，也对 “洋葱模型” 和实现它的 <code>compose</code> 进行分析，由于个人觉得 <code>compose</code> 的编程思想比较重要，应用广泛，所以本篇借着 “洋葱模型” 的话题，打算用四种方式来实现 <code>compose</code>。</p>
<h2 id="洋葱模型案例"><a href="#洋葱模型案例" class="headerlink" title="洋葱模型案例"></a>洋葱模型案例</h2><p>如果你已经使用 <code>Koa</code> 对 “洋葱模型” 这个词一定不陌生，它就是 <code>Koa</code> 中间件的一种串行机制，并且是支持异步的，下面是一个表达 “洋葱模型” 的经典案例。</p>
<pre><code>const Koa = require(&quot;koa&quot;);

const app = new Koa();

app.use(asycn (ctx, next) =&gt; {
    console.log(1);
    await next();
    console.log(2);
});

app.use(asycn (ctx, next) =&gt; {
    console.log(3);
    await next();
    console.log(4);
});

app.use(asycn (ctx, next) =&gt; {
    console.log(5);
    await next();
    console.log(6);
});

app.listen(3000);

// 1
// 3
// 5
// 6
// 4
// 2
</code></pre><p>上面的写法我们按照官方推荐，使用了 <code>async/await</code>，但如果是同步代码不使用也没有关系，这里简单的分析一下执行机制，第一个中间件函数中如果执行了 <code>next</code>，则下一个中间件会被执行，依次类推，就有了我们上面的结果，而在 <code>Koa</code> 源码中，这一功能是靠一个 <code>compose</code> 方法实现的，我们本文四种实现 <code>compose</code> 的方式中实现同步和异步，并附带对应的案例来验证。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>在真正创建 <code>compose</code> 方法之前应该先做些准备工作，比如创建一个 <code>app</code> 对象来顶替 <code>Koa</code> 创建出的实例对象，并添加 <code>use</code> 方法和管理中间件的数组 <code>middlewares</code>。</p>
<p>文件：app.js</p>
<pre><code>// 模拟 Koa 创建的实例
const app = {
    middlewares: []
};

// 创建 use 方法
app.use = function(fn) {
    app.middlewares.push(fn);
};

// app.compose.....

module.exports = app;
</code></pre><p>上面的模块中导出了 <code>app</code> 对象，并创建了存储中间件函数的 <code>middlewares</code> 和添加中间件的 <code>use</code> 方法，因为无论用哪种方式实现 <code>compose</code> 这些都是需要的，只是 <code>compose</code> 逻辑的不同，所以后面的代码块中会只写 <code>compose</code> 方法。</p>
<h2 id="Koa-中-compose-的实现方式"><a href="#Koa-中-compose-的实现方式" class="headerlink" title="Koa 中 compose 的实现方式"></a>Koa 中 compose 的实现方式</h2><p>首先介绍的是 <code>Koa</code> 源码中的实现方式，在 <code>Koa</code> 源码中其实是通过 <code>koa-compose</code> 中间件来实现的，我们在这里将这个模块的核心逻辑抽取出来，用我们自己的方式实现，由于重点在于分析 <code>compose</code> 的原理，所以 <code>ctx</code> 参数就被去掉了，因为我们不会使用它，重点是 <code>next</code> 参数。</p>
<h3 id="1、同步的实现"><a href="#1、同步的实现" class="headerlink" title="1、同步的实现"></a>1、同步的实现</h3><p>文件：app.js</p>
<pre><code>app.compose = function() {
    // 递归函数
    function dispatch(index) {
        // 如果所有中间件都执行完跳出
        if (index === app.middlewares.length) return;

        // 取出第 index 个中间件并执行
        const route = app.middlewares[index];
        return route(() =&gt; dispatch(index + 1));
    }

    // 取出第一个中间件函数执行
    dispatch(0);
};
</code></pre><p>上面是同步的实现，通过递归函数 <code>dispatch</code> 的执行取出了数组中的第一个中间件函数并执行，在执行时传入了一个函数，并递归执行了 <code>dispatch</code>，传入的参数 <code>+1</code>，这样就执行了下一个中间件函数，依次类推，直到所有中间件都执行完毕，不满足中间件执行条件时，会跳出，这样就按照上面案例中 <code>1 3 5 6 4 2</code> 的情况执行，测试例子如下（同步上、异步下）。</p>
<p>文件：sync-test.js</p>
<pre><code>const app = require(&quot;./app&quot;);

app.use(next =&gt; {
    console.log(1);
    next();
    console.log(2);
});

app.use(next =&gt; {
    console.log(3);
    next();
    console.log(4);
});

app.use(next =&gt; {
    console.log(5);
    next();
    console.log(6);
});

app.compose();
// 1
// 3
// 5
// 6
// 4
// 2
</code></pre><p>文件：async-test.js</p>
<pre><code>const app = require(&quot;./app&quot;);

// 异步函数
functionfn() {
    return new Promise((resolve, reject) =&gt; {
        setTimeout(() =&gt; {
            resolve();
            console.log(&quot;hello&quot;);
        }, 3000);
    });
}

app.use(async next =&gt; {
    console.log(1);
    await next();
    console.log(2);
});

app.use(async next =&gt; {
    console.log(3);
    await fn(); // 调用异步函数
    await next();
    console.log(4);
});

app.use(async next =&gt; {
    console.log(5);
    await next();
    console.log(6);
});

app.compose();
</code></pre><p>我们发现如果案例中按照 <code>Koa</code> 的推荐写法，即使用 <code>async</code> 函数，都会通过，但是在给 <code>use</code> 传参时可能会传入普通函数或 <code>async</code> 函数，我们要将所有中间件的返回值都包装成 Promise 来兼容两种情况，其实在 <code>Koa</code> 中 <code>compose</code> 最后返回的也是 Promise，是为了后续的逻辑的编写，但是现在并不支持，下面来解决这两个问题。</p>
<p>注意：后面 <code>compose</code> 的其他实现方式中，都是使用 <code>sync-test.js</code> 和 <code>async-test.js</code> 验证，所以后面就不再重复了。</p>
<h3 id="2、升级为支持异步"><a href="#2、升级为支持异步" class="headerlink" title="2、升级为支持异步"></a>2、升级为支持异步</h3><p>文件：app.js</p>
<pre><code>app.compose = function() {
    // 递归函数
    function dispatch(index) {
        // 如果所有中间件都执行完跳出，并返回一个 Promise
        if (index === app.middlewares.length) return Promise.resolve();

        // 取出第 index 个中间件并执行
        const route = app.middlewares[index];

        // 执行后返回成功态的 Promise
        return Promise.resolve(route(() =&gt; dispatch(index + 1)));
    }

    // 取出第一个中间件函数执行
    dispatch(0);
};
</code></pre><p>我们知道 <code>async</code> 函数中 <code>await</code> 后面执行的异步代码要实现等待，带异步执行后继续向下执行，需要等待 Promise，所以我们将每一个中间件函数在调用时最后都返回了一个成功态的 Promise，使用 <code>async-test.js</code>进行测试，发现结果为 <code>1 3 hello(3s后) 5 6 4 2</code>。</p>
<h2 id="Redux-旧版本-compose-的实现方式"><a href="#Redux-旧版本-compose-的实现方式" class="headerlink" title="Redux 旧版本 compose 的实现方式"></a>Redux 旧版本 compose 的实现方式</h2><h3 id="1、同步的实现-1"><a href="#1、同步的实现-1" class="headerlink" title="1、同步的实现"></a>1、同步的实现</h3><p>文件：app.js</p>
<pre><code>app.compose = function() {
    return app.middlewares.reduceRight((a, b) =&gt; () =&gt; b(a), () =&gt; {})();
};
</code></pre><p>上面的代码看起来不太好理解，我们不妨根据案例把这段代码拆解开，假设 <code>middlewares</code> 中存储的三个中间件函数分别为 <code>fn1</code>、<code>fn2</code> 和 <code>fn3</code>，由于使用的是 <code>reduceRight</code> 方法，所以是逆序归并，第一次 <code>a</code> 代表初始值（空函数），<code>b</code> 代表 <code>fn3</code>，而执行 <code>fn3</code> 返回了一个函数，这个函数再作为下一次归并的 <code>a</code>，而 <code>fn2</code> 作为 <code>b</code>，依次类推，过程如下。</p>
<pre><code>// 第 1 次 reduceRight 的返回值，下一次将作为 a
() =&gt; fn3(() =&gt; {});

// 第 2 次 reduceRight 的返回值，下一次将作为 a
() =&gt; fn2(() =&gt; fn3(() =&gt; {}));

// 第 3 次 reduceRight 的返回值，下一次将作为 a
() =&gt; fn1(() =&gt; fn2(() =&gt; fn3(() =&gt; {})));
</code></pre><p>由上面的拆解过程可以看出，如果我们调用了这个函数会先执行 <code>fn1</code>，如果调用 <code>next</code> 则会执行 <code>fn2</code>，如果同样调用 <code>next</code> 则会执行 <code>fn3</code>，<code>fn3</code> 已经是最后一个中间件函数了，再次调 <code>next</code> 会执行我们最初传入的空函数，这也是为什么要将 <code>reduceRight</code> 的初始值设置成一个空函数，就是防止最后一个中间件调用 <code>next</code> 而报错。</p>
<p>经过测试上面的代码不会出现顺序错乱的情况，但是在 <code>compose</code> 执行后，我们希望进行一些后续的操作，所以希望返回的是 Promise，而我们又希望传入给 <code>use</code> 的中间件函数既可以是普通函数，又可以是 <code>async</code> 函数，这就要我们的 <code>compose</code> 完全支持异步。</p>
<h3 id="2、升级为支持异步-1"><a href="#2、升级为支持异步-1" class="headerlink" title="2、升级为支持异步"></a>2、升级为支持异步</h3><p>文件：app.js</p>
<pre><code>app.compose = function() {
    return Promise.resolve(
        app.middlewares.reduceRight(
            (a, b) =&gt; () =&gt; Promise.resolve(b(a)),
            () =&gt; Promise.resolve();
        )()
    );
};
</code></pre><p>参考同步的分析过程，由于最后一个中间件执行后执行的空函数内一定没有任何逻辑，但为遇到异步代码可以继续执行（比如执行 <code>next</code> 后又调用了 <code>then</code>），都处理成了 Promise，保证了 <code>reduceRight</code> 每一次归并的时候返回的函数内都返回了一个 Promise，这样就完全兼容了 <code>async</code> 和普通函数，当所有中间件执行完毕，也返回了一个 Promise，这样 <code>compose</code> 就可以调用 <code>then</code> 方法执行后续逻辑。</p>
<h2 id="Redux-新版本-compose-的实现方式"><a href="#Redux-新版本-compose-的实现方式" class="headerlink" title="Redux 新版本 compose 的实现方式"></a>Redux 新版本 compose 的实现方式</h2><h3 id="1、同步的实现-2"><a href="#1、同步的实现-2" class="headerlink" title="1、同步的实现"></a>1、同步的实现</h3><p>文件：app.js</p>
<pre><code>app.compose = function() {
    return app.middlewares.reduce((a, b) =&gt; arg =&gt; a(() =&gt; b(arg)))(() =&gt; {});
};
</code></pre><p><code>Redux</code> 新版本中将 <code>compose</code> 的逻辑做了些改动，将原本的 <code>reduceRight</code> 换成 <code>reduce</code>，也就是说将逆序归并改为了正序，我们不一定和 <code>Redux</code> 源码完全相同，是根据相同的思路来实现串行中间件的需求。</p>
<p>个人觉得改成正序归并后更难理解，所以还是将上面代码结合案例进行拆分，中间件依然是 <code>fn1</code>、<code>fn2</code> 和 <code>fn3</code>，由于 <code>reduce</code> 并没有传入初始值，所以此时 <code>a</code> 为 <code>fn1</code>，<code>b</code> 为 <code>fn2</code>。</p>
<pre><code>// 第 1 次 reduce 的返回值，下一次将作为 a
arg =&gt; fn1(() =&gt; fn2(arg));

// 第 2 次 reduce 的返回值，下一次将作为 a
arg =&gt; (arg =&gt; fn1(() =&gt; fn2(arg)))(() =&gt; fn3(arg));

// 等价于...
arg =&gt; fn1(() =&gt; fn2(() =&gt; fn3(arg)));

// 执行最后返回的函数连接中间件，返回值等价于...
fn1(() =&gt; fn2(() =&gt; fn3(() =&gt; {})));
</code></pre><p>所以在调用 <code>reduce</code> 最后返回的函数时，传入了一个空函数作为参数，其实这个参数最后传递给了 <code>fn3</code>，也就是第三个中间件，这样保证了在最后一个中间件调用 <code>next</code> 时不会报错。</p>
<h3 id="2、升级为支持异步-2"><a href="#2、升级为支持异步-2" class="headerlink" title="2、升级为支持异步"></a>2、升级为支持异步</h3><p>下面有个更艰巨的任务，就是将上面的代码更改为支持异步，实现如下。</p>
<p>文件：app.js</p>
<pre><code>app.compose = function() {
    return Promise.resolve(
        app.middlewares.reduce((a, b) =&gt; arg =&gt;
            Promise.resolve(a(() =&gt; b(arg)))
        )(() =&gt; Promise.resolve())
    );
};
</code></pre><p>实现异步其实与逆序归并是一个套路，就是让每一个中间件函数的返回值都是 Promise，并让 <code>compose</code> 也返回 Promise。</p>
<h3 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">		&lt;title&gt;&lt;/title&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">			function originDispatch(...args) &#123;</span><br><span class="line">				console.log(...args)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			function middleware1(dispatch) &#123;</span><br><span class="line">				return (...args) =&gt; &#123;</span><br><span class="line">					console.log(&apos;middleware1 before dispatch&apos;)</span><br><span class="line">					dispatch(...args)</span><br><span class="line">					console.log(&apos;middleware1 after dispatch&apos;)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			function middleware2(dispatch) &#123;</span><br><span class="line">				return (...args) =&gt; &#123;</span><br><span class="line">					console.log(&apos;middleware2 before dispatch&apos;)</span><br><span class="line">					dispatch(...args)</span><br><span class="line">					console.log(&apos;middleware2 after dispatch&apos;)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			function middleware3(dispatch) &#123;</span><br><span class="line">				return (...args) =&gt; &#123;</span><br><span class="line">					console.log(&apos;middleware3 before dispatch&apos;)</span><br><span class="line">					dispatch(...args)</span><br><span class="line">					console.log(&apos;middleware3 after dispatch&apos;)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			//			originDispatch = middleware2(middleware1(originDispatch))</span><br><span class="line">			//			originDispatch(&apos;redux&apos;, &apos;is&apos;, &apos;cool&apos;);</span><br><span class="line"></span><br><span class="line">			function compose(...funcs) &#123;</span><br><span class="line">				return funcs.reduce((a, b) =&gt; (args) =&gt; a(b(args)))</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">            //console.log(compose(middleware2, middleware1))</span><br><span class="line">               //(args) =&gt; middleware2(middleware1(args))  </span><br><span class="line">               //(originDispatch)=&gt;middleware2(middleware1(originDispatch))  </span><br><span class="line">               </span><br><span class="line">			compose(middleware2, middleware1)(originDispatch)(&apos;redux&apos;, &apos;is&apos;, &apos;cool&apos;);</span><br><span class="line">			</span><br><span class="line">		&lt;/script&gt;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h2 id="使用-async-函数实现"><a href="#使用-async-函数实现" class="headerlink" title="使用 async 函数实现"></a>使用 async 函数实现</h2><p>这个版本是我在之前在学习 <code>Koa</code> 源码时偶然在一位大佬的一篇分析 <code>Koa</code> 原理的文章中看到的（翻了半天实在没找到链接），在这里也拿出来和大家分享一下，由于是利用 <code>async</code> 函数实现的，所以默认就是支持异步的，因为 <code>async</code> 函数会返回一个 Promise。</p>
<p>文件：app.js</p>
<pre><code>app.compose = function() {
    // 自执行 async 函数返回 Promise
    return (async function () {
        // 定义默认的 next，最后一个中间件内执行的 next
        let next = async () =&gt; Promise.resolve();

        // middleware 为每一个中间件函数，oldNext 为每个中间件函数中的 next
        // 函数返回一个 async 作为新的 next，async 执行返回 Promise，解决异步问题
        function createNext(middleware, oldNext) {
            return async () =&gt; {
                await middleware(oldNext);
            }
        }

        // 反向遍历中间件数组，先把 next 传给最后一个中间件函数
        // 将新的中间件函数存入 next 变量
        // 调用下一个中间件函数，将新生成的 next 传入
        for (let i = app.middlewares.length - 1; i &gt;= 0; i--) {
            next = createNext(app.middlewares[i], next);
        }

        await next();
    })();
};
</code></pre><p>上面代码中的 <code>next</code> 是一个只返回成功态 Promise 的函数，可以理解为其他实现方式中最后一个中间件调用的 <code>next</code>，而数组 <code>middlewares</code> 刚好是反向遍历的，取到的第一个值就是最后一个中间件，而调用 <code>createNext</code>作用是返回一个新的可以执行数组中最后一个中间件的 <code>async</code> 函数，并传入了初始的 <code>next</code>，这个返回的 <code>async</code> 函数作为新的 <code>next</code>，再取到倒数第二个中间件，调用 <code>createNext</code>，又返回了一个 <code>async</code> 函数，函数内依然是倒数第二个中间件的执行，传入的 <code>next</code> 就是上次新生成的 <code>next</code>，这样依次类推到第一个中间件。</p>
<p>因此执行第一个中间件返回的 <code>next</code> 则会执行传入的上一个生成的 <code>next</code> 函数，就会执行第二个中间件，就会执行第二个中间件中的 <code>next</code>，就这样直到执行完最初定义的的 <code>next</code>，通过案例的验证，执行结果与洋葱模型完全相同。</p>
<p>至于异步的问题，每次执行的 <code>next</code> 都是 <code>async</code> 函数，执行后返回的都是 Promise，而最外层的自执行 <code>async</code> 函数返回的也是 Promise，也就是说 <code>compose</code> 最后返回的是 Promise，因此完全支持异步。</p>
<p>这个方式之所放在最后，是因为个人觉得不好理解，我是按照自己对这几种方式理解的难易程度由上至下排序的。</p>
<h2 id="Koa第一版"><a href="#Koa第一版" class="headerlink" title="Koa第一版"></a>Koa第一版</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">		&lt;title&gt;&lt;/title&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">			// 模拟 Koa 创建的实例</span><br><span class="line">			const app = &#123;</span><br><span class="line">				middlewares: []</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			// 创建 use 方法</span><br><span class="line">			app.use = function(fn) &#123;</span><br><span class="line">				app.middlewares.push(fn);</span><br><span class="line">			&#125;;</span><br><span class="line">			app.use(next =&gt; &#123;</span><br><span class="line">				console.log(1);</span><br><span class="line">				next();</span><br><span class="line">				console.log(2);</span><br><span class="line">			&#125;);</span><br><span class="line"></span><br><span class="line">			app.use(next =&gt; &#123;</span><br><span class="line">				console.log(3);</span><br><span class="line">				next();</span><br><span class="line">				console.log(4);</span><br><span class="line">			&#125;);</span><br><span class="line"></span><br><span class="line">			app.use(next =&gt; &#123;</span><br><span class="line">				console.log(5);</span><br><span class="line">				next();</span><br><span class="line">				console.log(6);</span><br><span class="line">			&#125;);</span><br><span class="line"></span><br><span class="line">			app.compose = function() &#123;</span><br><span class="line">				// 递归函数</span><br><span class="line">				function dispatch(index) &#123;</span><br><span class="line">					// 如果所有中间件都执行完跳出</span><br><span class="line">					if(index === app.middlewares.length) return;</span><br><span class="line"></span><br><span class="line">					// 取出第 index 个中间件并执行</span><br><span class="line">					const route = app.middlewares[index];</span><br><span class="line">					return route(() =&gt; dispatch(index + 1));</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				// 取出第一个中间件函数执行</span><br><span class="line">				dispatch(0);</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			app.compose();</span><br><span class="line">		&lt;/script&gt;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Koa第二版"><a href="#Koa第二版" class="headerlink" title="Koa第二版"></a>Koa第二版</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">		&lt;title&gt;&lt;/title&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">			// 模拟 Koa 创建的实例</span><br><span class="line">			const app = &#123;</span><br><span class="line">				middlewares: []</span><br><span class="line">			&#125;;</span><br><span class="line">			// 异步函数</span><br><span class="line">			function fn() &#123;</span><br><span class="line">				return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">					setTimeout(() =&gt; &#123;</span><br><span class="line">						resolve();</span><br><span class="line">						console.log(&quot;hello&quot;);</span><br><span class="line">					&#125;, 3000);</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;</span><br><span class="line">			// 创建 use 方法</span><br><span class="line">			app.use = function(fn) &#123;</span><br><span class="line">				app.middlewares.push(fn);</span><br><span class="line">			&#125;;</span><br><span class="line">			app.use(async next =&gt; &#123;</span><br><span class="line">				console.log(1);</span><br><span class="line">				await next();</span><br><span class="line">				console.log(2);</span><br><span class="line">			&#125;);</span><br><span class="line"></span><br><span class="line">			app.use(async next =&gt; &#123;</span><br><span class="line">				console.log(3);</span><br><span class="line">				await fn(); // 调用异步函数</span><br><span class="line">				await next();</span><br><span class="line">				console.log(4);</span><br><span class="line">			&#125;);</span><br><span class="line"></span><br><span class="line">			app.use(async next =&gt; &#123;</span><br><span class="line">				console.log(5);</span><br><span class="line">				await next();</span><br><span class="line">				console.log(6);</span><br><span class="line">			&#125;);</span><br><span class="line"></span><br><span class="line">			app.compose = function() &#123;</span><br><span class="line">				// 递归函数</span><br><span class="line">				function dispatch(index) &#123;</span><br><span class="line">					// 如果所有中间件都执行完跳出，并返回一个 Promise</span><br><span class="line">					if(index === app.middlewares.length) return Promise.resolve();</span><br><span class="line"></span><br><span class="line">					// 取出第 index 个中间件并执行</span><br><span class="line">					const route = app.middlewares[index];</span><br><span class="line"></span><br><span class="line">					// 执行后返回成功态的 Promise</span><br><span class="line">					return Promise.resolve(route(() =&gt; dispatch(index + 1)));</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				// 取出第一个中间件函数执行</span><br><span class="line">				dispatch(0);</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			app.compose();</span><br><span class="line">		&lt;/script&gt;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Koa第三版"><a href="#Koa第三版" class="headerlink" title="Koa第三版"></a>Koa第三版</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">		&lt;title&gt;&lt;/title&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">			// 模拟 Koa 创建的实例</span><br><span class="line">			const app = &#123;</span><br><span class="line">				middlewares: []</span><br><span class="line">			&#125;;</span><br><span class="line">			// 异步函数</span><br><span class="line">			function fn() &#123;</span><br><span class="line">				return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">					setTimeout(() =&gt; &#123;</span><br><span class="line">						resolve();</span><br><span class="line">						console.log(&quot;hello&quot;);</span><br><span class="line">					&#125;, 3000);</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;</span><br><span class="line">			// 创建 use 方法</span><br><span class="line">			app.use = function(fn) &#123;</span><br><span class="line">				app.middlewares.push(fn);</span><br><span class="line">			&#125;;</span><br><span class="line">			app.use(async next =&gt; &#123;</span><br><span class="line">				console.log(1);</span><br><span class="line">				await next();</span><br><span class="line">				console.log(2);</span><br><span class="line">			&#125;);</span><br><span class="line"></span><br><span class="line">			app.use(async next =&gt; &#123;</span><br><span class="line">				console.log(3);</span><br><span class="line">				await fn(); // 调用异步函数</span><br><span class="line">				await next();</span><br><span class="line">				console.log(4);</span><br><span class="line">			&#125;);</span><br><span class="line"></span><br><span class="line">			app.use(async next =&gt; &#123;</span><br><span class="line">				console.log(5);</span><br><span class="line">				await next();</span><br><span class="line">				console.log(6);</span><br><span class="line">			&#125;);</span><br><span class="line"></span><br><span class="line">			app.compose = function() &#123;</span><br><span class="line">				// 自执行 async 函数返回 Promise</span><br><span class="line">				return(async function() &#123;</span><br><span class="line">					// 定义默认的 next，最后一个中间件内执行的 next</span><br><span class="line">					let next = async() =&gt; Promise.resolve();</span><br><span class="line"></span><br><span class="line">					// middleware 为每一个中间件函数，oldNext 为每个中间件函数中的 next</span><br><span class="line">					// 函数返回一个 async 作为新的 next，async 执行返回 Promise，解决异步问题</span><br><span class="line">					function createNext(middleware, oldNext) &#123;</span><br><span class="line">						return async() =&gt; &#123;</span><br><span class="line">							await middleware(oldNext);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					// 反向遍历中间件数组，先把 next 传给最后一个中间件函数</span><br><span class="line">					// 将新的中间件函数存入 next 变量</span><br><span class="line">					// 调用下一个中间件函数，将新生成的 next 传入</span><br><span class="line">					for(let i = app.middlewares.length - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">						next = createNext(app.middlewares[i], next);</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					await next();</span><br><span class="line">				&#125;)();</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			app.compose();</span><br><span class="line">		&lt;/script&gt;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Log中间件"><a href="#Log中间件" class="headerlink" title="Log中间件"></a>Log中间件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function log(ctx) &#123;</span><br><span class="line">    console.log(ctx.method, ctx.header.host + ctx.url)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module.exports = function() &#123;</span><br><span class="line">	return async function(ctx, next) &#123;</span><br><span class="line">		log(ctx);</span><br><span class="line">		await next()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&apos;koa&apos;) // koa v2</span><br><span class="line">const loggerAsync = require(&apos;./log&apos;)</span><br><span class="line">const app = new Koa()</span><br><span class="line"></span><br><span class="line">app.use(loggerAsync())</span><br><span class="line"></span><br><span class="line">app.use(async(ctx) =&gt; &#123;</span><br><span class="line">	let url = ctx.url</span><br><span class="line">	// 从上下文的request对象中获取</span><br><span class="line">	let request = ctx.request</span><br><span class="line">	let req_query = request.query</span><br><span class="line">	let req_querystring = request.querystring</span><br><span class="line"></span><br><span class="line">	// 从上下文中直接获取</span><br><span class="line">	let ctx_query = ctx.query</span><br><span class="line">	let ctx_querystring = ctx.querystring</span><br><span class="line"></span><br><span class="line">	ctx.body = &#123;</span><br><span class="line">		url,</span><br><span class="line">		req_query,</span><br><span class="line">		req_querystring,</span><br><span class="line">		ctx_query,</span><br><span class="line">		ctx_querystring</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(3000)</span><br><span class="line">console.log(&apos;the server is starting at port 3000&apos;)</span><br></pre></td></tr></table></figure>
<h2 id="精简版-koa-简单封装"><a href="#精简版-koa-简单封装" class="headerlink" title="精简版 koa 简单封装"></a>精简版 koa 简单封装</h2><h3 id="Application-模块的简单封装"><a href="#Application-模块的简单封装" class="headerlink" title="Application 模块的简单封装"></a>Application 模块的简单封装</h3><blockquote>
<p>首先我们先简单封装一个模块 Application 保证服务的正常运行；</p>
</blockquote>
<ul>
<li>初始化一个项目</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm init -y</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<ul>
<li>创建文件 application.js 并并编写如下代码;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">const http = require(&apos;http&apos;);</span><br><span class="line"></span><br><span class="line">classApplication&#123;</span><br><span class="line">  // 初始化constructor()&#123;</span><br><span class="line">    this.callback = () =&gt; &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 设置回调函数</span><br><span class="line">  use(callback)&#123;</span><br><span class="line">    this.callback = callback;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // listen 创建服务并对服务进行监听</span><br><span class="line">  listen(...args)&#123;</span><br><span class="line">    const server = http.createServer((req, res) =&gt; &#123;</span><br><span class="line">      this.callback(req, res);</span><br><span class="line">    &#125;);</span><br><span class="line">    server.listen(...args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">module.exports = Application;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建 server.js 文件，调用 Application 模块起一个服务：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">const Application = require(&apos;./application.js&apos;);</span><br><span class="line"></span><br><span class="line">const app = new Application();</span><br><span class="line"></span><br><span class="line">app.use((req, res) =&gt; &#123;</span><br><span class="line">  res.writeHead(200);</span><br><span class="line">  res.end(&apos;hello world&apos;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(3000, () =&gt; &#123;</span><br><span class="line">  console.log(&apos;监听端口：3000&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Application-模块挂载-context"><a href="#Application-模块挂载-context" class="headerlink" title="Application 模块挂载 context"></a>Application 模块挂载 context</h3><blockquote>
<p>首先我们假设我们的 context 是这么一个数据结构:</p>
</blockquote>
<ul>
<li>context 中挂载了 request response req res, 同时还有抽离的额外属性 url body</li>
<li>request 中挂载了 req, 同时还有抽离的额外属性 url</li>
<li>response 中挂载了 res, 同时还有抽离的额外属性 body</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">context: &#123;</span><br><span class="line">  url: String,</span><br><span class="line">  body: String,</span><br><span class="line">  request: &#123;</span><br><span class="line">    url: String,</span><br><span class="line">    req: Object</span><br><span class="line">  &#125;,</span><br><span class="line">  response: &#123;</span><br><span class="line">    body: String,</span><br><span class="line">    res: Object</span><br><span class="line">  &#125;,</span><br><span class="line">  req: Object,</span><br><span class="line">  res: Object</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>改写  Application</p>
</blockquote>
<ul>
<li>设计 context request response 原型数据结构；</li>
<li>将 context request response 原型数据结构挂载到 Application</li>
<li>编写函数创建 context</li>
<li>改写回调函数的调用方式；</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">const http = require(&apos;http&apos;);</span><br><span class="line">// [1]构建数据结构（作为原型使用）</span><br><span class="line">const request = &#123;</span><br><span class="line">  // 因为后期 request 将会挂载上 req 所以存在 this.req</span><br><span class="line">  get url()&#123;</span><br><span class="line">    returnthis.req.url;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">const response = &#123;</span><br><span class="line">  get body()&#123;</span><br><span class="line">    returnthis._body;</span><br><span class="line">  &#125;,</span><br><span class="line">  set body(val)&#123;</span><br><span class="line">    this._body = val;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">const context = &#123;</span><br><span class="line">  // 因为后期 context 将会挂载上 request response 所以存在 this.request 和  this.response</span><br><span class="line">  get url()&#123;</span><br><span class="line">    returnthis.request.url;</span><br><span class="line">  &#125;,</span><br><span class="line">  get body()&#123;</span><br><span class="line">    returnthis.response.body;</span><br><span class="line">  &#125;,</span><br><span class="line">  set body(val)&#123;</span><br><span class="line">    this.response.body = val; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">classApplication&#123;</span><br><span class="line">  constructor()&#123;</span><br><span class="line">    this.callback = () =&gt; &#123;&#125;,</span><br><span class="line">    // [2]将原型挂载到 Application</span><br><span class="line">    this.context = context;</span><br><span class="line">    this.request = request;</span><br><span class="line">    this.response = response;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  use(callback)&#123;</span><br><span class="line">    this.callback = callback;</span><br><span class="line">  &#125;</span><br><span class="line">  // [3]创建 context 函数，挂载上 request response req res </span><br><span class="line">  createCtx(req, res)&#123;</span><br><span class="line">    const ctx = Object.create(this.context);</span><br><span class="line">    ctx.request = Object.create(this.request);</span><br><span class="line">    ctx.response = Object.create(this.response);</span><br><span class="line">    ctx.req = ctx.request = req;</span><br><span class="line">    ctx.res = ctx.response = res;</span><br><span class="line">    return ctx;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  listen(...args)&#123;</span><br><span class="line">    const server = http.createServer((req, res) =&gt; &#123;</span><br><span class="line">      // [4]创建 context, 并进行简单修改</span><br><span class="line">      const ctx = this.createCtx(req, res);</span><br><span class="line">      this.callback(ctx);</span><br><span class="line">      ctx.res.end(ctx.body);</span><br><span class="line">    &#125;);</span><br><span class="line">    server.listen(...args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">module.exports = Application;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>修改 server.js 中 Application 的引用</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const Application = require(&apos;./application.js&apos;);</span><br><span class="line"></span><br><span class="line">const app = new Application();</span><br><span class="line"></span><br><span class="line">app.use( ctx =&gt; &#123;</span><br><span class="line">  ctx.body = &apos;hello world&apos;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(3000, () =&gt; &#123;</span><br><span class="line">  console.log(&apos;监听端口：3000&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="中间件的实现"><a href="#中间件的实现" class="headerlink" title="中间件的实现"></a>中间件的实现</h3><h4 id="洋葱模型实现"><a href="#洋葱模型实现" class="headerlink" title="洋葱模型实现"></a>洋葱模型实现</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">// 场景模拟// 异步 promise 模拟</span><br><span class="line">const delay = async () =&gt; &#123;</span><br><span class="line">  returnnewPromise((resolve, reject) =&gt; &#123;</span><br><span class="line">    setTimeout(() =&gt; &#123;</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;, 2000);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line">// 中间间模拟const fn1 = async (ctx, next) =&gt; &#123;</span><br><span class="line">  console.log(1);</span><br><span class="line">  await next();</span><br><span class="line">  console.log(2);</span><br><span class="line">&#125;</span><br><span class="line">const fn2 = async (ctx, next) =&gt; &#123;</span><br><span class="line">  console.log(3);</span><br><span class="line">  await delay();</span><br><span class="line">  await next();</span><br><span class="line">  console.log(4);</span><br><span class="line">&#125;</span><br><span class="line">const fn3 = async (ctx, next) =&gt; &#123;</span><br><span class="line">  console.log(5);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const middlewares = [fn1, fn2, fn3];</span><br><span class="line"></span><br><span class="line">// compose 实现洋葱模型</span><br><span class="line">const compose = (middlewares, ctx) =&gt; &#123;</span><br><span class="line">  const dispatch = (i) =&gt; &#123;</span><br><span class="line">    let fn = middlewares[i];</span><br><span class="line">    if(!fn)&#123; return Promise.resolve() &#125;</span><br><span class="line">    return Promise.resolve(fn(ctx, () =&gt; &#123;</span><br><span class="line">      return dispatch(i+1);</span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">  return dispatch(0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">compose(middlewares, 1);</span><br></pre></td></tr></table></figure>
<h4 id="compose-函数在-Application-模块中的使用："><a href="#compose-函数在-Application-模块中的使用：" class="headerlink" title="compose 函数在 Application 模块中的使用："></a>compose 函数在 Application 模块中的使用：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">const http = require(&apos;http&apos;);</span><br><span class="line"></span><br><span class="line">const request = &#123;</span><br><span class="line">  get url()&#123;</span><br><span class="line">    returnthis.req.url;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">const response = &#123;</span><br><span class="line">  get body()&#123;</span><br><span class="line">    returnthis._body;</span><br><span class="line">  &#125;,</span><br><span class="line">  set body(val)&#123;</span><br><span class="line">    this._body = val;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">const context = &#123;</span><br><span class="line">  get url()&#123;</span><br><span class="line">    returnthis.request.url;</span><br><span class="line">  &#125;,</span><br><span class="line">  get body()&#123;</span><br><span class="line">    returnthis.response.body;</span><br><span class="line">  &#125;,</span><br><span class="line">  set body(val)&#123;</span><br><span class="line">    this.response.body = val; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Application&#123;</span><br><span class="line">  constructor()&#123;</span><br><span class="line">    this.context = context;</span><br><span class="line">    this.request = request;</span><br><span class="line">    this.response = response;</span><br><span class="line">    // 初始化中间件数组</span><br><span class="line">    this.middlewares = [];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 通过push的方式进行添加中间件</span><br><span class="line">  use(middleware)&#123;</span><br><span class="line">    this.middlewares.push(middleware);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  create Ctx(req, res)&#123;</span><br><span class="line">    const ctx = Object.create(this.context);</span><br><span class="line">    ctx.request = Object.create(this.request);</span><br><span class="line">    ctx.response = Object.create(this.response);</span><br><span class="line">    ctx.req = ctx.request = req;</span><br><span class="line">    ctx.res = ctx.response = res;</span><br><span class="line">    return ctx;</span><br><span class="line">  &#125;</span><br><span class="line">  // compose 函数</span><br><span class="line">  compose(middlewares, ctx)&#123;</span><br><span class="line">    const dispatch = (i) =&gt; &#123;</span><br><span class="line">      const fn = middlewares[i];</span><br><span class="line">      if(!fn)&#123;</span><br><span class="line">        return Promise.resolve();</span><br><span class="line">      &#125;else&#123;</span><br><span class="line">        return Promise.resolve(fn(ctx, () =&gt; &#123;</span><br><span class="line">          dispatch(i +1 );</span><br><span class="line">        &#125;));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return dispatch(0);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  listen(...args)&#123;</span><br><span class="line">    // 改用 async await 并调用 compose</span><br><span class="line">    const server = http.createServer(async (req, res) =&gt; &#123;</span><br><span class="line">      const ctx = this.createCtx(req, res);</span><br><span class="line">      await this.compose(this.middlewares, ctx);</span><br><span class="line">      ctx.res.end(ctx.body);</span><br><span class="line">    &#125;);</span><br><span class="line">    server.listen(...args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">module.exports = Application;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>或许你看完这几种方式会觉得，还是 <code>Koa</code> 对于 <code>compose</code> 的实现方式最容易理解，你也可能和我一样在感慨 <code>Redux</code> 的两种实现方式和 <code>async</code> 函数实现方式是如此的巧妙，恰恰 JavaScript 在被别人诟病 “弱类型”、“不严谨” 的同时，就是如此的具有灵活性和创造性，我们无法判断这是优点还是缺点（仁者见仁，智者见智），但有一点是肯定的，学习 JavaScript 不要被强类型语言的 “墨守成规” 所束缚（个人观点，强类型语言开发者勿喷），就是要吸收这样巧妙的编程思想，写出 <code>compose</code> 这种优雅又高逼格的代码，路漫漫其修远兮，愿你在技术的路上 “一去不复返”。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/24/vue超简洁双日历组件/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/24/vue超简洁双日历组件/" itemprop="url">vue超简洁双日历组件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-24T19:55:51+08:00">
                2018-09-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="看了那么多的日历组件，没有一个满意的"><a href="#看了那么多的日历组件，没有一个满意的" class="headerlink" title=" 看了那么多的日历组件，没有一个满意的"></a><center> 看了那么多的日历组件，没有一个满意的</center></h3><p><img src="https://raw.githubusercontent.com/libin1991/my-calendar/master/1.jpg" alt="vue超简洁双日历组件"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div&gt;</span><br><span class="line">		&lt;!--&lt;div class=&quot;hide&quot;&gt;</span><br><span class="line">			&lt;mcalendar :child=&quot;date0&quot;&gt;&lt;/mcalendar&gt;</span><br><span class="line">			&lt;mcalendar :child=&quot;date1&quot;&gt;&lt;/mcalendar&gt;</span><br><span class="line">		&lt;/div&gt;--&gt;</span><br><span class="line">		&lt;div&gt;</span><br><span class="line">			&lt;mdatapick :child=&apos;mdatapickdata&apos; @cllback=&quot;callback&quot;&gt;&lt;/mdatapick&gt;</span><br><span class="line">		&lt;/div&gt;</span><br><span class="line">	&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">	import &apos;@/assets/css/reset.less&apos;</span><br><span class="line">	import mcalendar from &apos;./mdata&apos;</span><br><span class="line">	import mdatapick from &apos;./mdatapick&apos;</span><br><span class="line">	export default &#123;</span><br><span class="line">		data() &#123;</span><br><span class="line">			return &#123;</span><br><span class="line">				//				date0: &#123;</span><br><span class="line">				//					now: &quot;2018-09-05&quot;,</span><br><span class="line">				//					end: &quot;2018-09-28&quot;,</span><br><span class="line">				//					callback: function(d) &#123;</span><br><span class="line">				//						console.log(d);</span><br><span class="line">				//					&#125;</span><br><span class="line">				//				&#125;,</span><br><span class="line">				//				date1: &#123;</span><br><span class="line">				//					now: &quot;2018-11-25&quot;,</span><br><span class="line">				//					start: &quot;2018-11-05&quot;,</span><br><span class="line">				//					callback: function(d) &#123;</span><br><span class="line">				//						console.log(d);</span><br><span class="line">				//					&#125;</span><br><span class="line">				//				&#125;,</span><br><span class="line">				mdatapickdata: &#123;</span><br><span class="line">					start: &quot;2018-09-29&quot;,</span><br><span class="line">					end: &quot;2018-10-18&quot;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		methods: &#123;</span><br><span class="line">			callback(startDate, endDate) &#123;</span><br><span class="line">				this.mdatapickdata.start=startDate;</span><br><span class="line">				this.mdatapickdata.end=endDate;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		components: &#123;</span><br><span class="line">			mcalendar,</span><br><span class="line">			mdatapick</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div class=&quot;m_calender&quot;&gt;</span><br><span class="line">		&lt;input type=&quot;text&quot; class=&quot;date_input&quot; readonly=&quot;readonly&quot; v-model=&quot;dataMsg&quot; @click=&quot;toggleShow&quot;&gt;</span><br><span class="line"></span><br><span class="line">		&lt;div class=&quot;datamain&quot; v-if=&quot;open&quot;&gt;</span><br><span class="line">			&lt;div class=&quot;datacon&quot;&gt;</span><br><span class="line">				&lt;div class=&quot;con&quot;&gt;</span><br><span class="line">					&lt;div class=&quot;date_main&quot;&gt;</span><br><span class="line">						&lt;div class=&quot;title&quot;&gt;</span><br><span class="line">							&lt;div class=&quot;time&quot;&gt;开始日期&lt;/div&gt;</span><br><span class="line">							&lt;div class=&quot;timenum&quot;&gt;&#123;&#123;start&#125;&#125;&lt;/div&gt;</span><br><span class="line">						&lt;/div&gt;</span><br><span class="line">						&lt;div class=&quot;date_top&quot;&gt;</span><br><span class="line">							&lt;em class=&quot;prev_month hoverhands&quot; @click=&quot;prev(&apos;start&apos;)&quot;&gt;&lt;/em&gt;</span><br><span class="line">							&lt;p&gt;</span><br><span class="line">								&lt;span class=&quot;top_month&quot;&gt;&#123;&#123;getMonthText(startMonth)&#125;&#125;&lt;/span&gt;</span><br><span class="line">								&lt;span class=&quot;top_year&quot;&gt;&#123;&#123;startYear&#125;&#125;&lt;/span&gt;</span><br><span class="line">							&lt;/p&gt;</span><br><span class="line">							&lt;em v-if=&quot;startNext&quot; class=&quot;next_month hoverhands&quot; @click=&quot;next(&apos;start&apos;)&quot;&gt;&lt;/em&gt;</span><br><span class="line">						&lt;/div&gt;</span><br><span class="line">						&lt;div class=&quot;date_week&quot;&gt;</span><br><span class="line">							&lt;em&gt;周日&lt;/em&gt;</span><br><span class="line">							&lt;em&gt;周一&lt;/em&gt;</span><br><span class="line">							&lt;em&gt;周二&lt;/em&gt;</span><br><span class="line">							&lt;em&gt;周三&lt;/em&gt;</span><br><span class="line">							&lt;em&gt;周四&lt;/em&gt;</span><br><span class="line">							&lt;em&gt;周五&lt;/em&gt;</span><br><span class="line">							&lt;em&gt;周六&lt;/em&gt;</span><br><span class="line">						&lt;/div&gt;</span><br><span class="line">						&lt;div class=&quot;date_day&quot;&gt;</span><br><span class="line">							&lt;em v-for=&quot;s in startlist&quot; :class=&quot;s.className&quot; @click=&quot;clickDate(s,&apos;start&apos;)&quot;&gt;&#123;&#123; s.num &#125;&#125;&lt;/em&gt;</span><br><span class="line">						&lt;/div&gt;</span><br><span class="line">					&lt;/div&gt;</span><br><span class="line">				&lt;/div&gt;</span><br><span class="line">				&lt;div class=&quot;con&quot;&gt;</span><br><span class="line">					&lt;div class=&quot;date_main&quot;&gt;</span><br><span class="line">						&lt;div class=&quot;title&quot;&gt;</span><br><span class="line">							&lt;div class=&quot;time&quot;&gt;结束日期&lt;/div&gt;</span><br><span class="line">							&lt;div class=&quot;timenum&quot;&gt;&#123;&#123;end&#125;&#125;&lt;/div&gt;</span><br><span class="line">						&lt;/div&gt;</span><br><span class="line">						&lt;div class=&quot;date_top&quot;&gt;</span><br><span class="line">							&lt;em v-if=&quot;endPrev&quot; class=&quot;prev_month hoverhands&quot; @click=&quot;prev(&apos;end&apos;)&quot;&gt;&lt;/em&gt;</span><br><span class="line">							&lt;p&gt;</span><br><span class="line">								&lt;span class=&quot;top_month&quot;&gt;&#123;&#123;getMonthText(endMonth)&#125;&#125;&lt;/span&gt;</span><br><span class="line">								&lt;span class=&quot;top_year&quot;&gt;&#123;&#123;endYear&#125;&#125;&lt;/span&gt;</span><br><span class="line">							&lt;/p&gt;</span><br><span class="line">							&lt;em class=&quot;next_month hoverhands&quot; @click=&quot;next(&apos;end&apos;)&quot;&gt;&lt;/em&gt;</span><br><span class="line">						&lt;/div&gt;</span><br><span class="line">						&lt;div class=&quot;date_week&quot;&gt;</span><br><span class="line">							&lt;em&gt;周日&lt;/em&gt;</span><br><span class="line">							&lt;em&gt;周一&lt;/em&gt;</span><br><span class="line">							&lt;em&gt;周二&lt;/em&gt;</span><br><span class="line">							&lt;em&gt;周三&lt;/em&gt;</span><br><span class="line">							&lt;em&gt;周四&lt;/em&gt;</span><br><span class="line">							&lt;em&gt;周五&lt;/em&gt;</span><br><span class="line">							&lt;em&gt;周六&lt;/em&gt;</span><br><span class="line">						&lt;/div&gt;</span><br><span class="line">						&lt;div class=&quot;date_day&quot;&gt;</span><br><span class="line">							&lt;em v-for=&quot;s in endlist&quot; :class=&quot;s.className&quot; @click=&quot;clickDate(s,&apos;end&apos;)&quot;&gt;&#123;&#123; s.num &#125;&#125;&lt;/em&gt;</span><br><span class="line">						&lt;/div&gt;</span><br><span class="line">					&lt;/div&gt;</span><br><span class="line">				&lt;/div&gt;</span><br><span class="line">			&lt;/div&gt;</span><br><span class="line">			&lt;div class=&quot;databtn&quot;&gt;</span><br><span class="line">				&lt;div class=&quot;btn hoverhands&quot; @click=&quot;toggleShow&quot;&gt;取消&lt;/div&gt;</span><br><span class="line">				&lt;div class=&quot;btn active hoverhands&quot; @click=&quot;Determine&quot;&gt;确定&lt;/div&gt;</span><br><span class="line">			&lt;/div&gt;</span><br><span class="line">		&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">	&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">	export default &#123;</span><br><span class="line">		props: [&quot;child&quot;],</span><br><span class="line">		data: function() &#123;</span><br><span class="line">			return &#123;</span><br><span class="line">				open: false,</span><br><span class="line">				start: this.child.start,</span><br><span class="line">				startYear: &apos;&apos;,</span><br><span class="line">				startMonth: &apos;&apos;,</span><br><span class="line">				startFirstWeek: &apos;&apos;,</span><br><span class="line">				startDaySum: &apos;&apos;,</span><br><span class="line">				startlist: [],</span><br><span class="line">				startNext:true,</span><br><span class="line">				end: this.child.end,</span><br><span class="line">				endYear: &apos;&apos;,</span><br><span class="line">				endMonth: &apos;&apos;,</span><br><span class="line">				endFirstWeek: &apos;&apos;,</span><br><span class="line">				endDaySum: &apos;&apos;,</span><br><span class="line">				endlist: [],</span><br><span class="line">				endPrev:true</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		computed: &#123;</span><br><span class="line">			activeStartData() &#123;</span><br><span class="line">				return new Date(this.start).getTime();</span><br><span class="line">			&#125;,</span><br><span class="line">			activeEndData() &#123;</span><br><span class="line">				return new Date(this.end).getTime();</span><br><span class="line">			&#125;,</span><br><span class="line">			dataMsg() &#123;</span><br><span class="line">				if(this.child) &#123;</span><br><span class="line">					return `$&#123;this.child.start&#125; ~ $&#123;this.child.end&#125;`</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			check(tag) &#123;</span><br><span class="line">				var startTime = new Date(`$&#123;this.startYear&#125;-$&#123;this.checkVal(this.startMonth)&#125;-01`).getTime();</span><br><span class="line">				var endTime = new Date(`$&#123;this.endYear&#125;-$&#123;this.checkVal(this.endMonth)&#125;-01`).getTime();</span><br><span class="line">				if(endTime &lt;= startTime) &#123;</span><br><span class="line">					return false;</span><br><span class="line">				&#125;</span><br><span class="line">				return true;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		mounted() &#123;</span><br><span class="line">			var startDate = new Date(this.start);</span><br><span class="line">			this.startYear = startDate.getFullYear();</span><br><span class="line">			this.startMonth = startDate.getMonth() + 1;</span><br><span class="line">			var endDate = new Date(this.end);</span><br><span class="line">			this.endYear = endDate.getFullYear();</span><br><span class="line">			this.endMonth = endDate.getMonth() + 1;</span><br><span class="line">			this.init();</span><br><span class="line">		&#125;,</span><br><span class="line">		methods: &#123;</span><br><span class="line">			toggleShow() &#123;</span><br><span class="line">				this.open = !this.open;</span><br><span class="line">			&#125;,</span><br><span class="line">			init() &#123;</span><br><span class="line">				this.startFirstWeek = new Date(`$&#123;this.startYear&#125;-$&#123;this.checkVal(this.startMonth)&#125;-01`).getDay();</span><br><span class="line">				this.startDaySum = this.getMonthDaySum(`$&#123;this.startYear&#125;-$&#123;this.checkVal(this.startMonth)&#125;-01`);</span><br><span class="line">				this.startlist = this.initDate(this.startFirstWeek, this.startDaySum, this.startYear, this.startMonth, this.activeStartData);</span><br><span class="line">				this.endFirstWeek = new Date(`$&#123;this.endYear&#125;-$&#123;this.checkVal(this.endMonth)&#125;-01`).getDay();</span><br><span class="line">				this.endDaySum = this.getMonthDaySum(`$&#123;this.endYear&#125;-$&#123;this.checkVal(this.endMonth)&#125;-1`);</span><br><span class="line">				this.endlist = this.initDate(this.endFirstWeek, this.endDaySum, this.endYear, this.endMonth, this.activeEndData)</span><br><span class="line">			&#125;,</span><br><span class="line">			prev(tag) &#123;</span><br><span class="line">				if(tag == &apos;end&apos;) &#123;</span><br><span class="line">					if(!this.check) &#123;</span><br><span class="line">						return false;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				this[tag + &apos;Month&apos;]--;</span><br><span class="line">				if(!this[tag + &apos;Month&apos;]) &#123;</span><br><span class="line">					this[tag + &apos;Month&apos;] = 12;</span><br><span class="line">					this[tag + &apos;Year&apos;]--;</span><br><span class="line">				&#125;</span><br><span class="line">				this.$nextTick(() =&gt; &#123;</span><br><span class="line">					this.init();</span><br><span class="line">				&#125;)</span><br><span class="line">			&#125;,</span><br><span class="line">			next(tag) &#123;</span><br><span class="line">				if(tag == &apos;start&apos;) &#123;</span><br><span class="line">					if(!this.check) &#123;</span><br><span class="line">						return false;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				this[tag + &apos;Month&apos;]++;</span><br><span class="line">				if(this[tag + &apos;Month&apos;] &gt; 12) &#123;</span><br><span class="line">					this[tag + &apos;Month&apos;] = 1;</span><br><span class="line">					this[tag + &apos;Year&apos;]++;</span><br><span class="line">				&#125;</span><br><span class="line">				this.$nextTick(() =&gt; &#123;</span><br><span class="line">					this.init();</span><br><span class="line">				&#125;)</span><br><span class="line">			&#125;,</span><br><span class="line">			getMonthDaySum(val) &#123; //获取当前月有多少天</span><br><span class="line">				var curDate = new Date(val);</span><br><span class="line">				var curMonth = curDate.getMonth();</span><br><span class="line">				curDate.setMonth(curMonth + 1);</span><br><span class="line">				curDate.setDate(0);</span><br><span class="line">				return curDate.getDate();</span><br><span class="line">			&#125;,</span><br><span class="line">			initDate(FirstWeek, DaySum, Year, Month, activeData) &#123;</span><br><span class="line">				var list = [];</span><br><span class="line">				for(var i = 1; i &lt;= FirstWeek; i++) &#123;</span><br><span class="line">					var Dates = new Date(`$&#123;Year&#125;-$&#123;this.checkVal(Month)&#125;-01`);</span><br><span class="line">					Dates.setDate(i - FirstWeek);</span><br><span class="line">					list.push(&#123;</span><br><span class="line">						&quot;className&quot;: &quot;disabled&quot;,</span><br><span class="line">						&quot;num&quot;: Dates.getDate(),</span><br><span class="line">						&quot;date&quot;: `$&#123;Year&#125;-$&#123;this.checkVal(Month-1)&#125;-$&#123;Dates.getDate()&#125;`</span><br><span class="line">					&#125;)</span><br><span class="line">				&#125;</span><br><span class="line">				for(var i = 1; i &lt;= DaySum; i++) &#123;</span><br><span class="line">					var isActive = new Date(`$&#123;Year&#125;-$&#123;this.checkVal(Month)&#125;-$&#123;this.checkVal(i)&#125;`).getTime() == activeData;</span><br><span class="line">					list.push(&#123;</span><br><span class="line">						&quot;className&quot;: isActive ? &apos;on&apos; : &apos;&apos;,</span><br><span class="line">						&quot;num&quot;: i,</span><br><span class="line">						&quot;date&quot;: `$&#123;Year&#125;-$&#123;this.checkVal(Month)&#125;-$&#123;this.checkVal(i)&#125;`</span><br><span class="line">					&#125;)</span><br><span class="line">				&#125;</span><br><span class="line">				var nextData = new Date(`$&#123;Year&#125;-$&#123;this.checkVal(Month)&#125;-$&#123;DaySum&#125;`).getDay();</span><br><span class="line">				for(var i = 1; i &lt;= 6 - nextData; i++) &#123;</span><br><span class="line">					list.push(&#123;</span><br><span class="line">						&quot;className&quot;: &quot;disabled&quot;,</span><br><span class="line">						&quot;num&quot;: i,</span><br><span class="line">						&quot;date&quot;: `$&#123;Year&#125;-$&#123;this.checkVal(Month+1)&#125;-$&#123;this.checkVal(i)&#125;`</span><br><span class="line">					&#125;)</span><br><span class="line">				&#125;</span><br><span class="line">				return list;</span><br><span class="line">			&#125;,</span><br><span class="line">			checkVal(num) &#123;</span><br><span class="line">				num = +num;</span><br><span class="line">				return +num &lt; 10 ? &quot;0&quot; + num : &apos;&apos; + num;</span><br><span class="line">			&#125;,</span><br><span class="line">			clickDate(val, tag) &#123;</span><br><span class="line">				if(val.className !== &apos;disabled&apos;) &#123;</span><br><span class="line">					this[tag] = val.date;</span><br><span class="line">					this.$nextTick(() =&gt; &#123;</span><br><span class="line">						this.init();</span><br><span class="line">					&#125;)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			Determine() &#123;</span><br><span class="line">				this.toggleShow();</span><br><span class="line">				this.$emit(&quot;cllback&quot;, this.start, this.end)</span><br><span class="line">			&#125;,</span><br><span class="line">			getMonthText(m) &#123;</span><br><span class="line">				return [&apos;&apos;, &apos;一月&apos;, &apos;二月&apos;, &apos;三月&apos;, &apos;四月&apos;, &apos;五月&apos;, &apos;六月&apos;, &apos;七月&apos;, &apos;八月&apos;, &apos;九月&apos;, &apos;十月&apos;, &apos;十一月&apos;, &apos;十二月&apos;][m]</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;style lang=&quot;less&quot; scoped&gt;</span><br><span class="line">	.m_calender &#123;</span><br><span class="line">		position: relative;</span><br><span class="line">		display: block;</span><br><span class="line">		margin: 0 auto;</span><br><span class="line">		.date_input &#123;</span><br><span class="line">			margin: 0 auto;</span><br><span class="line">			width: 200px;</span><br><span class="line">			border: 1px solid red;</span><br><span class="line">			text-align: center;</span><br><span class="line">			height: 20px;</span><br><span class="line">			line-height: 20px;</span><br><span class="line">			cursor: pointer;</span><br><span class="line">			display: block;</span><br><span class="line">			color: #484848;</span><br><span class="line">			font-size: 12px;</span><br><span class="line">		&#125;</span><br><span class="line">		.datamain &#123;</span><br><span class="line">			border: 1px solid #E6E6E6;</span><br><span class="line">			position: absolute;</span><br><span class="line">			left: 50%;</span><br><span class="line">			top: 30px;</span><br><span class="line">			transform: translateX(-50%);</span><br><span class="line">			&amp;::before &#123;</span><br><span class="line">				content: &apos;&apos;;</span><br><span class="line">				position: absolute;</span><br><span class="line">				left: 50%;</span><br><span class="line">				transform: translateX(-50%);</span><br><span class="line">				top: -18px;</span><br><span class="line">				width: 0;</span><br><span class="line">				height: 0;</span><br><span class="line">				border-top: 9px solid rgba(0, 0, 0, 0);</span><br><span class="line">				border-right: 9px solid rgba(0, 0, 0, 0);</span><br><span class="line">				border-bottom: 9px solid #E6E6E6;</span><br><span class="line">				border-left: 9px solid rgba(0, 0, 0, 0);</span><br><span class="line">			&#125;</span><br><span class="line">			&amp;::after &#123;</span><br><span class="line">				content: &apos;&apos;;</span><br><span class="line">				position: absolute;</span><br><span class="line">				left: 50%;</span><br><span class="line">				transform: translateX(-50%);</span><br><span class="line">				top: -15px;</span><br><span class="line">				width: 0;</span><br><span class="line">				height: 0;</span><br><span class="line">				border-top: 8px solid rgba(0, 0, 0, 0);</span><br><span class="line">				border-right: 8px solid rgba(0, 0, 0, 0);</span><br><span class="line">				border-bottom: 8px solid white;</span><br><span class="line">				border-left: 8px solid rgba(0, 0, 0, 0);</span><br><span class="line">			&#125;</span><br><span class="line">			.datacon &#123;</span><br><span class="line">				display: flex;</span><br><span class="line">				.con &#123;</span><br><span class="line">					margin: 5px 10px;</span><br><span class="line">					.date_main &#123;</span><br><span class="line">						width: 232px;</span><br><span class="line">						background: #FFFFFF;</span><br><span class="line">						z-index: 20;</span><br><span class="line">						.title &#123;</span><br><span class="line">							padding: 8px 4px;</span><br><span class="line">							display: flex;</span><br><span class="line">							justify-content: space-between;</span><br><span class="line">							align-items: center;</span><br><span class="line">							font-size: 14px;</span><br><span class="line">							.time &#123;</span><br><span class="line">								color: #939393;</span><br><span class="line">							&#125;</span><br><span class="line">							.timenum &#123;</span><br><span class="line">								color: #333333;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">						.date_top &#123;</span><br><span class="line">							height: 28px;</span><br><span class="line">							line-height: 28px;</span><br><span class="line">							padding: 0 6px;</span><br><span class="line">							display: flex;</span><br><span class="line">							justify-content: space-around;</span><br><span class="line">							align-items: center;</span><br><span class="line">							em &#123;</span><br><span class="line">								width: 14px;</span><br><span class="line">								font-style: normal;</span><br><span class="line">								margin: 9px 4px;</span><br><span class="line">								&amp;.prev_month &#123;</span><br><span class="line">									width: 0px;</span><br><span class="line">									height: 0px;</span><br><span class="line">									border-top: 7px solid rgba(0, 0, 0, 0);</span><br><span class="line">									border-bottom: 7px solid rgba(0, 0, 0, 0);</span><br><span class="line">									border-right: 7px solid #A1A1A1;</span><br><span class="line">									border-left: 7px solid rgba(0, 0, 0, 0);</span><br><span class="line">								&#125;</span><br><span class="line">								&amp;.next_month &#123;</span><br><span class="line">									width: 0px;</span><br><span class="line">									height: 0px;</span><br><span class="line">									border-top: 7px solid rgba(0, 0, 0, 0);</span><br><span class="line">									border-bottom: 7px solid rgba(0, 0, 0, 0);</span><br><span class="line">									border-left: 7px solid #A1A1A1;</span><br><span class="line">									border-right: 7px solid rgba(0, 0, 0, 0);</span><br><span class="line">								&#125;</span><br><span class="line">							&#125;</span><br><span class="line">							p &#123;</span><br><span class="line">								width: 100px;</span><br><span class="line">								flex: 1;</span><br><span class="line">								font-size: 12px;</span><br><span class="line">								font-weight: 700;</span><br><span class="line">								text-align: center;</span><br><span class="line">								span &#123;</span><br><span class="line">									width: 40px;</span><br><span class="line">									display: inline-block;</span><br><span class="line">									text-align: center;</span><br><span class="line">								&#125;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">						.date_week &#123;</span><br><span class="line">							height: 24px;</span><br><span class="line">							em &#123;</span><br><span class="line">								box-sizing: border-box;</span><br><span class="line">								font-style: normal;</span><br><span class="line">								width: 33px;</span><br><span class="line">								height: 24px;</span><br><span class="line">								line-height: 24px;</span><br><span class="line">								display: block;</span><br><span class="line">								float: left;</span><br><span class="line">								color: #484848;</span><br><span class="line">								font-size: 12px;</span><br><span class="line">								text-align: center;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">						.date_day &#123;</span><br><span class="line">							overflow: hidden;</span><br><span class="line">							border: 1px solid #E6E6E6;</span><br><span class="line">							em &#123;</span><br><span class="line">								font-style: normal;</span><br><span class="line">								width: 32px;</span><br><span class="line">								height: 20px;</span><br><span class="line">								line-height: 20px;</span><br><span class="line">								display: block;</span><br><span class="line">								float: left;</span><br><span class="line">								color: #484848;</span><br><span class="line">								font-size: 12px;</span><br><span class="line">								text-align: center;</span><br><span class="line">								border-right: 1px solid #E6E6E6;</span><br><span class="line">								cursor: pointer;</span><br><span class="line">								&amp;:nth-child(7n) &#123;</span><br><span class="line">									border-right: 0px solid #E6E6E6;</span><br><span class="line">								&#125;</span><br><span class="line">								&amp;.on &#123;</span><br><span class="line">									color: #FFFFFF;</span><br><span class="line">									background-color: #E76E00;</span><br><span class="line">								&#125;</span><br><span class="line">								&amp;.disabled &#123;</span><br><span class="line">									color: #CCCCCC;</span><br><span class="line">									background-color: #FFFFFF;</span><br><span class="line">									cursor: default;</span><br><span class="line">								&#125;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			.databtn &#123;</span><br><span class="line">				text-align: right;</span><br><span class="line">				display: flex;</span><br><span class="line">				justify-content: flex-end;</span><br><span class="line">				align-items: center;</span><br><span class="line">				padding: 5px 0px 11px;</span><br><span class="line">				.btn &#123;</span><br><span class="line">					display: flex;</span><br><span class="line">					justify-content: center;</span><br><span class="line">					align-items: center;</span><br><span class="line">					box-sizing: border-box;</span><br><span class="line">					width: 56px;</span><br><span class="line">					height: 24px;</span><br><span class="line">					border: 1px solid red;</span><br><span class="line">					font-size: 12px;</span><br><span class="line">					border: 1px solid #E6E6E6;</span><br><span class="line">					border-radius: 2px;</span><br><span class="line">					&amp;.active &#123;</span><br><span class="line">						color: wheat;</span><br><span class="line">						margin: 0px 8px;</span><br><span class="line">						background: #EE6E25;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/11/Server-Sent-Events-服务器推送事件-使用长链接进行通讯/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/11/Server-Sent-Events-服务器推送事件-使用长链接进行通讯/" itemprop="url">Server-Sent Events:服务器推送事件,使用长链接进行通讯</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-11T21:26:04+08:00">
                2018-09-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>传统的网页都是浏览器向服务器“查询”数据，但是很多场合，最有效的方式是服务器向浏览器“发送”数据。比如，webpack的HRM，每当收到新的电子邮件，服务器就向浏览器发送一个“通知”，这要比浏览器按时向服务器查询（polling）更有效率。</p>
<p>服务器发送事件（Server-Sent Events，简称SSE）就是为了解决这个问题，而提出的一种新API，部署在EventSource对象上。目前，除了IE，其他主流浏览器都支持。</p>
<p>简单说，所谓SSE，就是浏览器向服务器发送一个HTTP请求，然后服务器不断单向地向浏览器推送“信息”（message）。这种信息在格式上很简单，就是“信息”加上前缀“data: ”，然后以“\n\n”结尾。</p>
<pre><code>$ curl http://example.com/dates
data: 1394572346452

data: 1394572347457

data: 1394572348463
</code></pre><p>SSE与WebSocket有相似功能，都是用来建立浏览器与服务器之间的通信渠道。两者的区别在于：</p>
<ul>
<li><p>WebSocket是全双工通道，可以双向通信，功能更强；SSE是单向通道，只能服务器向浏览器端发送。</p>
</li>
<li><p>WebSocket是一个新的协议，需要服务器端支持；SSE则是部署在HTTP协议之上的，现有的服务器软件都支持。</p>
</li>
<li><p>SSE是一个轻量级协议，相对简单；WebSocket是一种较重的协议，相对复杂。</p>
</li>
<li><p>SSE默认支持断线重连，WebSocket则需要额外部署。</p>
</li>
<li><p>SSE支持自定义发送的数据类型。</p>
</li>
</ul>
<p>从上面的比较可以看出，两者各有特点，适合不同的场合。</p>
<h2 id="客户端代码"><a href="#客户端代码" class="headerlink" title="客户端代码"></a>客户端代码</h2><h3 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h3><p>首先，使用下面的代码，检测浏览器是否支持SSE。</p>
<pre><code>if (!!window.EventSource) {
  // ...
}
</code></pre><p>然后，部署SSE大概如下。</p>
<pre><code>var source = new EventSource(&apos;/dates&apos;);

source.onmessage = function(e){
  console.log(e.data);
};

// 或者

source.addEventListener(&apos;message&apos;, function(e){})
</code></pre><h3 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h3><p>首先，浏览器向服务器发起连接，生成一个EventSource的实例对象。</p>
<pre><code>var source = new EventSource(url);
</code></pre><p>参数url就是服务器网址，必须与当前网页的网址在同一个网域（domain），而且协议和端口都必须相同。</p>
<p>下面是一个建立连接的实例。</p>
<pre><code>if (!!window.EventSource) {
  var source = new EventSource(&apos;http://127.0.0.1/sses/&apos;);
}
</code></pre><p>新生成的EventSource实例对象，有一个readyState属性，表明连接所处的状态。</p>
<pre><code>source.readyState
</code></pre><p>它可以取以下值：</p>
<blockquote>
<p>0，相当于常量EventSource.CONNECTING，表示连接还未建立，或者连接断线。</p>
</blockquote>
<blockquote>
<p>1，相当于常量EventSource.OPEN，表示连接已经建立，可以接受数据。</p>
</blockquote>
<blockquote>
<p>2，相当于常量EventSource.CLOSED，表示连接已断，且不会重连。</p>
</blockquote>
<h3 id="open事件"><a href="#open事件" class="headerlink" title="open事件"></a>open事件</h3><p>连接一旦建立，就会触发open事件，可以定义相应的回调函数。</p>
<pre><code>source.onopen = function(event) {
  // handle open event
};

// 或者

source.addEventListener(&quot;open&quot;, function(event) {
  // handle open event
}, false);
</code></pre><h3 id="message事件"><a href="#message事件" class="headerlink" title="message事件"></a>message事件</h3><p>收到数据就会触发message事件。</p>
<pre><code>source.onmessage = function(event) {
  var data = event.data;
  var origin = event.origin;
  var lastEventId = event.lastEventId;
  // handle message
};

// 或者

source.addEventListener(&quot;message&quot;, function(event) {
  var data = event.data;
  var origin = event.origin;
  var lastEventId = event.lastEventId;
  // handle message
}, false);
</code></pre><p>参数对象event有如下属性：</p>
<ul>
<li><p>data：服务器端传回的数据（文本格式）。</p>
</li>
<li><p>origin： 服务器端URL的域名部分，即协议、域名和端口。</p>
</li>
<li><p>lastEventId：数据的编号，由服务器端发送。如果没有编号，这个属性为空。</p>
</li>
</ul>
<h3 id="error事件"><a href="#error事件" class="headerlink" title="error事件"></a>error事件</h3><p>如果发生通信错误（比如连接中断），就会触发error事件。</p>
<pre><code>source.onerror = function(event) {
  // handle error event
};

// 或者

source.addEventListener(&quot;error&quot;, function(event) {
  // handle error event
}, false);
</code></pre><h3 id="自定义事件"><a href="#自定义事件" class="headerlink" title="自定义事件"></a>自定义事件</h3><p>服务器可以与浏览器约定自定义事件。这种情况下，发送回来的数据不会触发message事件。</p>
<pre><code>source.addEventListener(&quot;foo&quot;, function(event) {
  var data = event.data;
  var origin = event.origin;
  var lastEventId = event.lastEventId;
  // handle message
}, false);
</code></pre><p>上面代码表示，浏览器对foo事件进行监听。</p>
<h3 id="close方法"><a href="#close方法" class="headerlink" title="close方法"></a>close方法</h3><p>close方法用于关闭连接。</p>
<pre><code>source.close();
</code></pre><h2 id="数据格式"><a href="#数据格式" class="headerlink" title="数据格式"></a>数据格式</h2><h3 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h3><p>服务器端发送的数据的HTTP头信息如下：</p>
<pre><code>Content-Type: text/event-stream
Cache-Control: no-cache
Connection: keep-alive
</code></pre><p>后面的行都是如下格式：</p>
<pre><code>field: value\n
</code></pre><p>field可以取四个值：“data”, “event”, “id”, or “retry”，也就是说有四类头信息。每次HTTP通信可以包含这四类头信息中的一类或多类。\n代表换行符。</p>
<p>以冒号开头的行，表示注释。通常，服务器每隔一段时间就会向浏览器发送一个注释，保持连接不中断。</p>
<pre><code>: This is a comment
</code></pre><p>下面是一些例子。</p>
<pre><code>: this is a test stream\n\n

data: some text\n\n

data: another message\n
data: with two lines \n\n
</code></pre><h3 id="data：数据栏"><a href="#data：数据栏" class="headerlink" title="data：数据栏"></a>data：数据栏</h3><p>数据内容用data表示，可以占用一行或多行。如果数据只有一行，则像下面这样，以“\n\n”结尾。</p>
<pre><code>data:  message\n\n
</code></pre><p>如果数据有多行，则最后一行用“\n\n”结尾，前面行都用“\n”结尾。</p>
<pre><code>data: begin message\n
data: continue message\n\n
</code></pre><p>总之，最后一行的data，结尾要用两个换行符号，表示数据结束。</p>
<p>以发送JSON格式的数据为例。</p>
<pre><code>data: {\n
data: &quot;foo&quot;: &quot;bar&quot;,\n
data: &quot;baz&quot;, 555\n
data: }\n\n
</code></pre><h3 id="id：数据标识符"><a href="#id：数据标识符" class="headerlink" title="id：数据标识符"></a>id：数据标识符</h3><p>数据标识符用id表示，相当于每一条数据的编号。</p>
<pre><code>id: msg1\n
data: message\n\n
</code></pre><p>浏览器用lastEventId属性读取这个值。一旦连接断线，浏览器会发送一个HTTP头，里面包含一个特殊的“Last-Event-ID”头信息，将这个值发送回来，用来帮助服务器端重建连接。因此，这个头信息可以被视为一种同步机制。</p>
<h3 id="event栏：自定义信息类型"><a href="#event栏：自定义信息类型" class="headerlink" title="event栏：自定义信息类型"></a>event栏：自定义信息类型</h3><p>event头信息表示自定义的数据类型，或者说数据的名字。</p>
<pre><code>event: foo\n
data: a foo event\n\n

data: an unnamed event\n\n

event: bar\n
data: a bar event\n\n
</code></pre><p>上面的代码创造了三条信息。第一条是foo，触发浏览器端的foo事件；第二条未取名，表示默认类型，触发浏览器端的message事件；第三条是bar，触发浏览器端的bar事件。</p>
<h3 id="retry：最大间隔时间"><a href="#retry：最大间隔时间" class="headerlink" title="retry：最大间隔时间"></a>retry：最大间隔时间</h3><p>浏览器默认的是，如果服务器端三秒内没有发送任何信息，则开始重连。服务器端可以用retry头信息，指定通信的最大间隔时间。</p>
<pre><code>retry: 10000\n
</code></pre><h2 id="服务器代码"><a href="#服务器代码" class="headerlink" title="服务器代码"></a>服务器代码</h2><p>服务器端发送事件，要求服务器与浏览器保持连接。对于不同的服务器软件来说，所消耗的资源是不一样的。Apache服务器，每个连接就是一个线程，如果要维持大量连接，势必要消耗大量资源。Node.js则是所有连接都使用同一个线程，因此消耗的资源会小得多，但是这要求每个连接不能包含很耗时的操作，比如磁盘的IO读写。</p>
<p>下面是Node.js的服务器发送事件的<a href="http://cjihrig.com/blog/server-sent-events-in-node-js/" target="_blank" rel="noopener">代码实例</a>。</p>
<pre><code>var http = require(&quot;http&quot;);

http.createServer(function (req, res) {

    var fileName = &quot;.&quot; + req.url;

    if (fileName === &quot;./stream&quot;) {
        res.writeHead(200, {&quot;Content-Type&quot;:&quot;text/event-stream&quot;, 
                            &quot;Cache-Control&quot;:&quot;no-cache&quot;, 
                            &quot;Connection&quot;:&quot;keep-alive&quot;});
        res.write(&quot;retry: 10000\n&quot;);
        res.write(&quot;event: connecttime\n&quot;);
        res.write(&quot;data: &quot; + (new Date()) + &quot;\n\n&quot;);
        res.write(&quot;data: &quot; + (new Date()) + &quot;\n\n&quot;);

        interval = setInterval(function() {
            res.write(&quot;data: &quot; + (new Date()) + &quot;\n\n&quot;);
        }, 1000);

        req.connection.addListener(&quot;close&quot;, function () {
            clearInterval(interval);
        }, false);
  }
}).listen(80, &quot;127.0.0.1&quot;);
</code></pre><hr>
<h2 id="利用WebSocket和EventSource实现服务端推送"><a href="#利用WebSocket和EventSource实现服务端推送" class="headerlink" title="利用WebSocket和EventSource实现服务端推送"></a><a href="https://juejin.im/post/5c121c77f265da614a3a5e07" target="_blank" rel="noopener">利用WebSocket和EventSource实现服务端推送</a></h2><p>可能有很多的同学有用 setInterval 控制 ajax 不断向服务端请求最新数据的经历(轮询)看下面的代码：</p>
<pre><code>setInterval(function() {
    $.get(&apos;/get/data-list&apos;, function(data, status) {
        console.log(data)
    })
}, 5000)
</code></pre><p>这样每隔5秒前端会向后台请求一次数据，实现上看起来很简单但是有个很重要的问题，就是我们没办法控制网速的稳定，不能保证在下次发请求的时候上一次的请求结果已经顺利返回，这样势必会有隐患，有聪明的同学马上会想到用 setTimeout 配合递归看下面的代码：</p>
<pre><code>functionpoll() {
    setTimeout(function() {
        $.get(&apos;/get/data-list&apos;, function(data, status) {
            console.log(data)
            poll()
        })
    }, 5000)
}
</code></pre><p>当结果返回之后再延时触发下一次的请求，这样虽然没办法保证两次请求之间的间隔时间完全一致但是至少可以保证数据返回的节奏是稳定的，看似已经实现了需求但是这么搞我们先不去管他的性能就代码结构也算不上优雅，为了解决这个问题可以让服务端长时间和客户端保持连接进行数据互通h5新增了 WebSocket 和 EventSource 用来实现长轮询，下面我们来分析一下这两者的特点以及使用场景。</p>
<h2 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h2><p><strong>是什么：</strong> WebSocket是一种通讯手段，基于TCP协议，默认端口也是80和443，协议标识符是ws（加密为wss），它实现了浏览器与服务器的全双工通信，扩展了浏览器与服务端的通信功能，使服务端也能主动向客户端发送数据，不受跨域的限制。</p>
<p><strong>有什么用：</strong> WebSocket用来解决http不能持久连接的问题，因为可以双向通信所以可以用来实现聊天室，以及其他由服务端主动推送的功能例如 实时天气、股票报价、余票显示、消息通知等。</p>
<h2 id="EventSource"><a href="#EventSource" class="headerlink" title="EventSource"></a>EventSource</h2><p><strong>是什么：</strong> EventSource的官方名称应该是 Server-sent events（缩写SSE）服务端派发事件，EventSource 基于http协议只是简单的单项通信，实现了服务端推的过程客户端无法通过EventSource向服务端发送数据。喜闻乐见的是ie并没有良好的兼容当然也有解决的办法比如 <code>npm install event-source-polyfill</code>。虽然不能实现双向通信但是在功能设计上他也有一些优点比如可以自动重连接,event IDs,以及发送随机事件的能力（WebSocket要借助第三方库比如socket.io可以实现重连。）</p>
<p><strong>有什么用：</strong> 因为受单项通信的限制EventSource只能用来实现像股票报价、新闻推送、实时天气这些只需要服务器发送消息给客户端场景中。EventSource的使用更加便捷这也是他的优点。</p>
<h2 id="WebSocket-amp-EventSource-的区别"><a href="#WebSocket-amp-EventSource-的区别" class="headerlink" title="WebSocket &amp; EventSource 的区别"></a>WebSocket &amp; EventSource 的区别</h2><ol>
<li>WebSocket基于TCP协议，EventSource基于http协议。</li>
<li>EventSource是单向通信，而websocket是双向通信。</li>
<li>EventSource只能发送文本，而websocket支持发送二进制数据。</li>
<li>在实现上EventSource比websocket更简单。</li>
<li>EventSource有自动重连接（不借助第三方）以及发送随机事件的能力。</li>
<li>websocket的资源占用过大EventSource更轻量。</li>
<li>websocket可以跨域，EventSource基于http跨域需要服务端设置请求头。</li>
</ol>
<h2 id="EventSource的实现案例"><a href="#EventSource的实现案例" class="headerlink" title="EventSource的实现案例"></a>EventSource的实现案例</h2><p>客户端代码</p>
<pre><code>// 实例化 EventSource 参数是服务端监听的路由
var source = new EventSource(&apos;/EventSource-test&apos;)
source.onopen = function (event) { // 与服务器连接成功回调
  console.log(&apos;成功与服务器连接&apos;)
}
// 监听从服务器发送来的所有没有指定事件类型的消息(没有event字段的消息)
source.onmessage = function (event) { // 监听未命名事件
  console.log(&apos;未命名事件&apos;, event.data)
}
source.onerror = function (error) { // 监听错误
  console.log(&apos;错误&apos;)
}
// 监听指定类型的事件（可以监听多个）
source.addEventListener(&quot;myEve&quot;, function (event) {
  console.log(&quot;myEve&quot;, event.data)
})
</code></pre><p>服务端代码（node.js）</p>
<pre><code>const fs = require(&apos;fs&apos;)
const express = require(&apos;express&apos;) // npm install express
const app = express()

// 启动一个简易的本地server返回index.html
app.get(&apos;/&apos;, (req, res) =&gt; {
  fs.stat(&apos;./index.html&apos;, (err, stats) =&gt; {
    if (!err &amp;&amp; stats.isFile()) {
      res.writeHead(200)
      fs.createReadStream(&apos;./index.html&apos;).pipe(res)
    } else {
      res.writeHead(404)
      res.end(&apos;404 Not Found&apos;)
    }
  })
})

// 监听EventSource-test路由服务端返回事件流
app.get(&apos;/EventSource-test&apos;, (ewq, res) =&gt; {
  // 根据 EventSource 规范设置报头
  res.writeHead(200, {
    &quot;Content-Type&quot;: &quot;text/event-stream&quot;, // 规定把报头设置为 text/event-stream
    &quot;Cache-Control&quot;: &quot;no-cache&quot; // 设置不对页面进行缓存
  })
  // 用write返回事件流，事件流仅仅是一个简单的文本数据流，每条消息以一个空行(\n)作为分割。
  res.write(&apos;:注释&apos; + &apos;\n\n&apos;)  // 注释行
  res.write(&apos;data:&apos; + &apos;消息内容1&apos; + &apos;\n\n&apos;) // 未命名事件

  res.write(  // 命名事件
    &apos;event: myEve&apos; + &apos;\n&apos; +
    &apos;data:&apos; + &apos;消息内容2&apos; + &apos;\n&apos; +
    &apos;retry:&apos; + &apos;2000&apos; + &apos;\n&apos; +
    &apos;id:&apos; + &apos;12345&apos; + &apos;\n\n&apos;
  )

  setInterval(() =&gt; { // 定时事件
    res.write(&apos;data:&apos; + &apos;定时消息&apos; + &apos;\n\n&apos;)
  }, 2000)
})

// 监听 6788
app.listen(6788, () =&gt; {
  console.log(`server runing on port 6788 ...`)
})
</code></pre><p>客户端访问 <code>http://127.0.0.1:6788/</code> 会看到如下的输出：</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/12/13/167a6bf535ecd347?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt=""><br>来总结一下相关的api，客户端的api很简单都在注释里了，服务端有一些要注意的地方：</p>
<h4 id="事件流格式？"><a href="#事件流格式？" class="headerlink" title="事件流格式？"></a>事件流格式？</h4><p>事件流仅仅是一个简单的文本数据流，文本应该使用UTF-8格式的编码。每条消息后面都由一个空行作为分隔符。以冒号开头的行为注释行，会被忽略。</p>
<h4 id="注释有何用？"><a href="#注释有何用？" class="headerlink" title="注释有何用？"></a>注释有何用？</h4><p>注释行可以用来防止连接超时，服务器可以定期发送一条消息注释行，以保持连接不断。</p>
<h4 id="EventSource规范中规定了那些字段？"><a href="#EventSource规范中规定了那些字段？" class="headerlink" title="EventSource规范中规定了那些字段？"></a>EventSource规范中规定了那些字段？</h4><p><code>event：</code> 事件类型，如果指定了该字段，则在客户端接收到该条消息时，会在当前的EventSource对象上触发一个事件，事件类型就是该字段的字段值，你可以使用addEventListener()方法在当前EventSource对象上监听任意类型的命名事件，如果该条消息没有event字段，则会触发onmessage属性上的事件处理函数。<br><code>data：</code> 消息的数据字段，如果该条消息包含多个data字段,则客户端会用换行符把它们连接成一个字符串来作为字段值。<br><code>id：</code> 事件ID，会成为当前EventSource对象的内部属性”最后一个事件ID”的属性值。<br><code>retry：</code> 一个整数值，指定了重新连接的时间(单位为毫秒)，如果该字段值不是整数，则会被忽略。</p>
<h4 id="重连是干什么的？"><a href="#重连是干什么的？" class="headerlink" title="重连是干什么的？"></a>重连是干什么的？</h4><p>上文提过retry字段是用来指定重连时间的，那为什么要重连呢，我们拿node来说，大家知道node的特点是单线程异步io，单线程就意味着如果server端报错那么服务就会停掉，当然在node开发的过程中会处理这些异常，但是一旦服务停掉了这时就需要用pm2之类的工具去做重启操作，这时候server虽然正常了，但是客户端的EventSource链接还是断开的这时候就用到了重连。</p>
<h4 id="为什么案例中消息要用-n结尾？"><a href="#为什么案例中消息要用-n结尾？" class="headerlink" title="为什么案例中消息要用\n结尾？"></a>为什么案例中消息要用\n结尾？</h4><p>\n是换行的转义字符，EventSource规范规定每条消息后面都由一个空行作为分隔符，结尾加一个\n表示一个字段结束，加两个\n表示一条消息结束。(两个\n表示换行之后又加了一个空行)</p>
<p><em>注: 如果一行文本中不包含冒号，则整行文本会被解析成为字段名，其字段值为空。</em></p>
<h2 id="WebSocket的实现案例"><a href="#WebSocket的实现案例" class="headerlink" title="WebSocket的实现案例"></a>WebSocket的实现案例</h2><h4 id="WebSocket的客户端原生api"><a href="#WebSocket的客户端原生api" class="headerlink" title="WebSocket的客户端原生api"></a>WebSocket的客户端原生api</h4><p><code>var ws = new WebSocket(&#39;ws://localhost:8080&#39;)</code><br>WebSocket 对象作为一个构造函数，用于新建 WebSocket 实例。</p>
<p><code>ws.onopen = function(){}</code><br>用于指定连接成功后的回调函数。</p>
<p><code>ws.onclose = function(){}</code><br>用于指定连接关闭后的回调函数</p>
<p><code>ws.onmessage = function(){}</code><br>用于指定收到服务器数据后的回调函数</p>
<p><code>ws.send(&#39;data&#39;)</code><br>实例对象的send()方法用于向服务器发送数据</p>
<p><code>socket.onerror = function(){}</code><br>用于指定报错时的回调函数</p>
<h4 id="服务端的WebSocket如何实现"><a href="#服务端的WebSocket如何实现" class="headerlink" title="服务端的WebSocket如何实现"></a>服务端的WebSocket如何实现</h4><p>npm上有很多包对websocket做了实现比如 <a href="https://link.juejin.im?target=http%3A%2F%2Fsocket.io" target="_blank" rel="noopener">socket.io</a>、WebSocket-Node、ws、还有很多，本文只对 socket.io以及ws 做简单的分析，细节还请查看官方文档。</p>
<h4 id="socket-io和ws有什么不同"><a href="#socket-io和ws有什么不同" class="headerlink" title="socket.io和ws有什么不同"></a>socket.io和ws有什么不同</h4><p><code>Socket.io：</code> Socket.io是一个WebSocket库，包括了客户端的js和服务器端的nodejs，它会自动根据浏览器从WebSocket、AJAX长轮询、Iframe流等等各种方式中选择最佳的方式来实现网络实时应用（不支持WebSocket的情况会降级到AJAX轮询），非常方便和人性化，兼容性非常好，支持的浏览器最低达IE5.5。屏蔽了细节差异和兼容性问题，实现了跨浏览器/跨设备进行双向数据通信。</p>
<p><code>ws：</code> 不像 <a href="https://link.juejin.im?target=http%3A%2F%2Fsocket.io" target="_blank" rel="noopener">socket.io</a> 模块， ws 是一个单纯的websocket模块，不提供向上兼容，不需要在客户端挂额外的js文件。在客户端不需要使用二次封装的api使用浏览器的原生Websocket API即可通信。</p>
<h4 id="基于socket-io实现WebSocket双向通信"><a href="#基于socket-io实现WebSocket双向通信" class="headerlink" title="基于socket.io实现WebSocket双向通信"></a>基于socket.io实现WebSocket双向通信</h4><p>客户端代码</p>
<pre><code>&lt;button id=&quot;closeSocket&quot;&gt;断开连接&lt;/button&gt;
&lt;button id=&quot;openSocket&quot;&gt;恢复连接&lt;/button&gt;
&lt;script src=&quot;/socket.io/socket.io.js&quot;&gt;&lt;/script&gt;
&lt;script&gt;
// 建立连接 默认指向 window.location
let socket = io(&apos;http://127.0.0.1:6788&apos;)

openSocket.onclick = () =&gt; {
  socket.open()  // 手动打开socket 也可以重新连接
}
closeSocket.onclick = () =&gt; {
  socket.close() // 手动关闭客户端对服务器的链接
}

socket.on(&apos;connect&apos;, () =&gt; { // 连接成功
  // socket.id是唯一标识，在客户端连接到服务器后被设置。
  console.log(socket.id)
})

socket.on(&apos;connect_error&apos;, (error) =&gt; {
  console.log(&apos;连接错误&apos;)
})
socket.on(&apos;disconnect&apos;, (timeout) =&gt; {
  console.log(&apos;断开连接&apos;)
})
socket.on(&apos;reconnect&apos;, (timeout) =&gt; {
  console.log(&apos;成功重连&apos;)
})
socket.on(&apos;reconnecting&apos;, (timeout) =&gt; {
  console.log(&apos;开始重连&apos;)
})
socket.on(&apos;reconnect_error&apos;, (timeout) =&gt; {
  console.log(&apos;重连错误&apos;)
})

// 监听服务端返回事件
socket.on(&apos;serverEve&apos;, (data) =&gt; {
  console.log(&apos;serverEve&apos;, data)
})

let num = 0
setInterval(() =&gt; {
  // 向服务端发送事件
  socket.emit(&apos;feEve&apos;, ++num)
}, 1000)
</code></pre><p>服务端代码（node.js）</p>
<pre><code>const app = require(&apos;express&apos;)()
const server = require(&apos;http&apos;).Server(app)
const io = require(&apos;socket.io&apos;)(server, {})

// 启动一个简易的本地server返回index.html
app.get(&apos;/&apos;, (req, res) =&gt; {
  res.sendfile(__dirname + &apos;/index.html&apos;)
})

// 监听 6788
server.listen(6788, () =&gt; {
  console.log(`server runing on port 6788 ...`)
})

// 服务器监听所有客户端 并返回该新连接对象
// 每个客户端socket连接时都会触发 connection 事件
let num = 0
io.on(&apos;connection&apos;, (socket) =&gt; {

  socket.on(&apos;disconnect&apos;, (reason) =&gt; {
    console.log(&apos;断开连接&apos;)
  })
  socket.on(&apos;error&apos;, (error) =&gt; {
    console.log(&apos;发生错误&apos;)
  })
  socket.on(&apos;disconnecting&apos;, (reason) =&gt; {
    console.log(&apos;客户端断开连接但尚未离开&apos;)
  })

  console.log(socket.id) // 获取当前连接进入的客户端的id
  io.clients((error, ids) =&gt; {
    console.log(ids)  // 获取已连接的全部客户机的ID
  })

  // 监听客户端发送的事件
  socket.on(&apos;feEve&apos;, (data) =&gt; {
    console.log(&apos;feEve&apos;, data)
  })
  // 给客户端发送事件
  setInterval(() =&gt; {
    socket.emit(&apos;serverEve&apos;, ++num)
  }, 1000)
})

/*
  io.close()  // 关闭所有连接
*/
</code></pre><p><code>const io = require(&#39;socket.io&#39;)(server, {})</code> 第二个参数是配置项，可以传入如下参数：</p>
<ul>
<li>path: ‘/socket.io’   捕获路径的名称</li>
<li>serveClient: false   是否提供客户端文件</li>
<li>pingInterval: 10000  发送消息的时间间隔</li>
<li>pingTimeout: 5000    在该时间下没有数据传输连接断开</li>
<li>origins: ‘*’         允许跨域</li>
<li>…</li>
</ul>
<p>上面基于socket.io的实现中 <code>express</code> 做为socket通信的依赖服务基础<br><code>socket.io</code> 作为socket通信模块，实现了双向数据传输。最后，需要注意的是，在服务器端 <code>emit</code> 区分以下三种情况：</p>
<ul>
<li><code>socket.emit()</code> ：向建立该连接的客户端发送</li>
<li><code>socket.broadcast.emit()</code> ：向除去建立该连接的客户端的所有客户端发送</li>
<li><code>io.sockets.emit()</code> ：向所有客户端发送 等同于上面两个的和</li>
<li><code>io.to(id).emit()</code> :  向指定id的客户端发送事件</li>
</ul>
<h4 id="基于ws实现WebSocket双向通信"><a href="#基于ws实现WebSocket双向通信" class="headerlink" title="基于ws实现WebSocket双向通信"></a>基于ws实现WebSocket双向通信</h4><p>客户端代码</p>
<pre><code>let num = 0
let ws = new WebSocket(&apos;ws://127.0.0.1:6788&apos;)
ws.onopen = (evt) =&gt; {
  console.log(&apos;连接成功&apos;)
  setInterval(() =&gt; {
    ws.send(++ num)  // 向服务器发送数据
  }, 1000)
}
ws.onmessage = (evt) =&gt; {
  console.log(&apos;收到服务端数据&apos;, evt.data)
}
ws.onclose = (evt) =&gt; {
  console.log(&apos;关闭&apos;)
}
ws.onerror = (evt) =&gt; {
  console.log(&apos;错误&apos;)
}
closeSocket.onclick = () =&gt; {
  ws.close()  // 断开连接
}
</code></pre><p>服务端代码（node.js）</p>
<pre><code>const fs = require(&apos;fs&apos;)
const express = require(&apos;express&apos;)
const app = express()

// 启动一个简易的本地server返回index.html
const httpServer = app.get(&apos;/&apos;, (req, res) =&gt; {
  res.writeHead(200)
  fs.createReadStream(&apos;./index.html&apos;).pipe(res)
}).listen(6788, () =&gt; {
  console.log(`server runing on port 6788 ...`)
})

// ws
const WebSocketServer = require(&apos;ws&apos;).Server
const wssOptions = {  
  server: httpServer,
  // port: 6789,
  // path: &apos;/test&apos;
}
const wss = new WebSocketServer(wssOptions, () =&gt; {
  console.log(`server runing on port ws 6789 ...`)
})

let num = 1
wss.on(&apos;connection&apos;, (wsocket) =&gt; {
  console.log(&apos;连接成功&apos;)

  wsocket.on(&apos;message&apos;, (message) =&gt; {
    console.log(&apos;收到消息&apos;, message)
  })
  wsocket.on(&apos;close&apos;, (message) =&gt; {
    console.log(&apos;断开了&apos;)
  })
  wsocket.on(&apos;error&apos;, (message) =&gt; {
    console.log(&apos;发生错误&apos;)
  })
  wsocket.on(&apos;open&apos;, (message) =&gt; {
    console.log(&apos;建立连接&apos;)
  })

  setInterval(() =&gt; {
    wsocket.send( ++num )
  }, 1000)
})
</code></pre><h3 id="上面代码中在-new-WebSocketServer-的时候传入了-server-httpServer-目的是统一端口，虽然-WebSocketServer-可以使用别的端口，但是统一端口还是更优的选择，其实express并没有直接占用6788端口而是express调用了内置http模块创建了http-Server监听了6788。express只是把响应函数注册到该http-Server里面。类似的，WebSocketServer也可以把自己的响应函数注册到-http-Server中，这样同一个端口，根据协议，可以分别由express和ws处理。我们拿到express创建的http-Server的引用，再配置到-wssOptions-server-里让WebSocketServer根据我们传入的http服务来启动，就实现了统一端口的目的。"><a href="#上面代码中在-new-WebSocketServer-的时候传入了-server-httpServer-目的是统一端口，虽然-WebSocketServer-可以使用别的端口，但是统一端口还是更优的选择，其实express并没有直接占用6788端口而是express调用了内置http模块创建了http-Server监听了6788。express只是把响应函数注册到该http-Server里面。类似的，WebSocketServer也可以把自己的响应函数注册到-http-Server中，这样同一个端口，根据协议，可以分别由express和ws处理。我们拿到express创建的http-Server的引用，再配置到-wssOptions-server-里让WebSocketServer根据我们传入的http服务来启动，就实现了统一端口的目的。" class="headerlink" title="上面代码中在 new WebSocketServer 的时候传入了 server: httpServer 目的是统一端口，虽然 WebSocketServer 可以使用别的端口，但是统一端口还是更优的选择，其实express并没有直接占用6788端口而是express调用了内置http模块创建了http.Server监听了6788。express只是把响应函数注册到该http.Server里面。类似的，WebSocketServer也可以把自己的响应函数注册到 http.Server中，这样同一个端口，根据协议，可以分别由express和ws处理。我们拿到express创建的http.Server的引用，再配置到 wssOptions.server 里让WebSocketServer根据我们传入的http服务来启动，就实现了统一端口的目的。"></a>上面代码中在 <code>new WebSocketServer</code> 的时候传入了 <code>server: httpServer</code> 目的是统一端口，虽然 WebSocketServer 可以使用别的端口，但是统一端口还是更优的选择，其实express并没有直接占用6788端口而是express调用了内置http模块创建了http.Server监听了6788。express只是把响应函数注册到该http.Server里面。类似的，WebSocketServer也可以把自己的响应函数注册到 http.Server中，这样同一个端口，根据协议，可以分别由express和ws处理。我们拿到express创建的http.Server的引用，再配置到 wssOptions.server 里让WebSocketServer根据我们传入的http服务来启动，就实现了统一端口的目的。</h3><h3 id="要始终注意，浏览器创建WebSocket时发送的仍然是标准的HTTP请求。无论是WebSocket请求，还是普通HTTP请求，都会被http-Server处理。具体的处理方式则是由express和WebSocketServer注入的回调函数实现的。WebSocketServer会首先判断请求是不是WS请求，如果是，它将处理该请求，如果不是，该请求仍由express处理。所以，WS请求会直接由WebSocketServer处理，它根本不会经过express。"><a href="#要始终注意，浏览器创建WebSocket时发送的仍然是标准的HTTP请求。无论是WebSocket请求，还是普通HTTP请求，都会被http-Server处理。具体的处理方式则是由express和WebSocketServer注入的回调函数实现的。WebSocketServer会首先判断请求是不是WS请求，如果是，它将处理该请求，如果不是，该请求仍由express处理。所以，WS请求会直接由WebSocketServer处理，它根本不会经过express。" class="headerlink" title="要始终注意，浏览器创建WebSocket时发送的仍然是标准的HTTP请求。无论是WebSocket请求，还是普通HTTP请求，都会被http.Server处理。具体的处理方式则是由express和WebSocketServer注入的回调函数实现的。WebSocketServer会首先判断请求是不是WS请求，如果是，它将处理该请求，如果不是，该请求仍由express处理。所以，WS请求会直接由WebSocketServer处理，它根本不会经过express。"></a>要始终注意，浏览器创建WebSocket时发送的仍然是标准的HTTP请求。无论是WebSocket请求，还是普通HTTP请求，都会被http.Server处理。具体的处理方式则是由express和WebSocketServer注入的回调函数实现的。WebSocketServer会首先判断请求是不是WS请求，如果是，它将处理该请求，如果不是，该请求仍由express处理。所以，WS请求会直接由WebSocketServer处理，它根本不会经过express。</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/03/Vue手势库/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/03/Vue手势库/" itemprop="url">Vue手势库</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-03T12:48:23+08:00">
                2018-09-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">function vueTouch(el, binding, type) &#123;</span><br><span class="line">	var _this = this;</span><br><span class="line">	this.obj = el;</span><br><span class="line">	this.binding = binding;</span><br><span class="line">	this.touchType = type;</span><br><span class="line">	this.vueTouches = &#123;</span><br><span class="line">		x: 0,</span><br><span class="line">		y: 0</span><br><span class="line">	&#125;;</span><br><span class="line">	this.vueMoves = true;</span><br><span class="line">	this.vueLeave = true;</span><br><span class="line">	this.longTouch = true;</span><br><span class="line"></span><br><span class="line">	this.vueCallBack = typeof(binding.value) == &quot;object&quot; ? binding.value.fn : binding.value;</span><br><span class="line"></span><br><span class="line">	this.obj.addEventListener(&quot;touchstart&quot;, function(e) &#123;</span><br><span class="line">		_this.start(e);</span><br><span class="line">	&#125;, false);</span><br><span class="line"></span><br><span class="line">	this.obj.addEventListener(&quot;touchmove&quot;, function(e) &#123;</span><br><span class="line">		_this.move(e);</span><br><span class="line">	&#125;, false);</span><br><span class="line"></span><br><span class="line">	this.obj.addEventListener(&quot;touchend&quot;, function(e) &#123;</span><br><span class="line">		_this.end(e);</span><br><span class="line">	&#125;, false);</span><br><span class="line">&#125;;</span><br><span class="line">vueTouch.prototype = &#123;</span><br><span class="line">	start(e) &#123;</span><br><span class="line">		this.vueMoves = true;</span><br><span class="line">		this.vueLeave = true;</span><br><span class="line">		this.longTouch = true;</span><br><span class="line">		this.vueTouches = &#123;</span><br><span class="line">			x: e.changedTouches[0].pageX,</span><br><span class="line">			y: e.changedTouches[0].pageY</span><br><span class="line">		&#125;;</span><br><span class="line">		this.time = setTimeout(function() &#123;</span><br><span class="line">			if(this.vueLeave &amp;&amp; this.vueMoves) &#123;</span><br><span class="line">				this.touchType == &quot;longtap&quot; &amp;&amp; this.vueCallBack(this.binding.value, e);</span><br><span class="line">				this.longTouch = false;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;.bind(this), 1000);</span><br><span class="line">	&#125;,</span><br><span class="line">	end(e) &#123;</span><br><span class="line">		var disX = e.changedTouches[0].pageX - this.vueTouches.x;</span><br><span class="line">		var disY = e.changedTouches[0].pageY - this.vueTouches.y;</span><br><span class="line">		clearTimeout(this.time);</span><br><span class="line">		if(Math.abs(disX) &gt; 10 || Math.abs(disY) &gt; 100) &#123;</span><br><span class="line">			this.touchType == &quot;swipe&quot; &amp;&amp; this.vueCallBack(this.binding.value, e);</span><br><span class="line">			if(Math.abs(disX) &gt; Math.abs(disY)) &#123;</span><br><span class="line">				if(disX &gt; 10) &#123;</span><br><span class="line">					this.touchType == &quot;swiperight&quot; &amp;&amp; this.vueCallBack(this.binding.value, e);</span><br><span class="line">				&#125;;</span><br><span class="line">				if(disX &lt; -10) &#123;</span><br><span class="line">					this.touchType == &quot;swipeleft&quot; &amp;&amp; this.vueCallBack(this.binding.value, e);</span><br><span class="line">				&#125;;</span><br><span class="line">			&#125; else &#123;</span><br><span class="line">				if(disY &gt; 10) &#123;</span><br><span class="line">					this.touchType == &quot;swipedown&quot; &amp;&amp; this.vueCallBack(this.binding.value, e);</span><br><span class="line">				&#125;;</span><br><span class="line">				if(disY &lt; -10) &#123;</span><br><span class="line">					this.touchType == &quot;swipeup&quot; &amp;&amp; this.vueCallBack(this.binding.value, e);</span><br><span class="line">				&#125;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			if(this.longTouch &amp;&amp; this.vueMoves) &#123;</span><br><span class="line">				this.touchType == &quot;tap&quot; &amp;&amp; this.vueCallBack(this.binding.value, e);</span><br><span class="line">				this.vueLeave = false</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;,</span><br><span class="line">	move(e) &#123;</span><br><span class="line">		this.vueMoves = false;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Vue.directive(&quot;tap&quot;, &#123;</span><br><span class="line">	bind: function(el, binding) &#123;</span><br><span class="line">		new vueTouch(el, binding, &quot;tap&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line">Vue.directive(&quot;swipe&quot;, &#123;</span><br><span class="line">	bind: function(el, binding) &#123;</span><br><span class="line">		new vueTouch(el, binding, &quot;swipe&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line">Vue.directive(&quot;swipeleft&quot;, &#123;</span><br><span class="line">	bind: function(el, binding) &#123;</span><br><span class="line">		new vueTouch(el, binding, &quot;swipeleft&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line">Vue.directive(&quot;swiperight&quot;, &#123;</span><br><span class="line">	bind: function(el, binding) &#123;</span><br><span class="line">		new vueTouch(el, binding, &quot;swiperight&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line">Vue.directive(&quot;swipedown&quot;, &#123;</span><br><span class="line">	bind: function(el, binding) &#123;</span><br><span class="line">		new vueTouch(el, binding, &quot;swipedown&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line">Vue.directive(&quot;swipeup&quot;, &#123;</span><br><span class="line">	bind: function(el, binding) &#123;</span><br><span class="line">		new vueTouch(el, binding, &quot;swipeup&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line">Vue.directive(&quot;longtap&quot;, &#123;</span><br><span class="line">	bind: function(el, binding) &#123;</span><br><span class="line">		new vueTouch(el, binding, &quot;longtap&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html id=&quot;html&quot;&gt;</span><br><span class="line"></span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;</span><br><span class="line">		&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no&quot; /&gt;</span><br><span class="line">		&lt;title&gt;&lt;/title&gt;</span><br><span class="line">		&lt;style&gt;</span><br><span class="line">			.box &#123;</span><br><span class="line">				width: 250px;</span><br><span class="line">				height: 250px;</span><br><span class="line">				background-color: red;</span><br><span class="line">				color: #FFFFFF;</span><br><span class="line">				text-align: center;</span><br><span class="line">				line-height: 250px;</span><br><span class="line">				font-size: 30px;</span><br><span class="line">				position: absolute;</span><br><span class="line">				margin: auto;</span><br><span class="line">				left: 0;</span><br><span class="line">				right: 0;</span><br><span class="line">				top: 0;</span><br><span class="line">				bottom: 0;</span><br><span class="line">			&#125;</span><br><span class="line">		&lt;/style&gt;</span><br><span class="line">		&lt;script src=&quot;js/vue.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">		&lt;script type=&quot;text/javascript&quot; src=&quot;js/vue-touch.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		&lt;div id=&quot;app&quot; class=&quot;box&quot; v-tap=&quot;&#123;fn:vuetap,name:&apos;点击&apos;&#125;&quot; v-longtap=&quot;&#123;fn:vuetap,name:&apos;长按&apos;&#125;&quot; v-swipeleft=&quot;&#123;fn:vuetap,name:&apos;左滑&apos;&#125;&quot; v-swiperight=&quot;&#123;fn:vuetap,name:&apos;右滑&apos;&#125;&quot; v-swipeup=&quot;&#123;fn:vuetap,name:&apos;上滑&apos;&#125;&quot; v-swipedown=&quot;&#123;fn:vuetap,name:&apos;下滑&apos;&#125;&quot;&gt;</span><br><span class="line">			&#123;&#123; name &#125;&#125;</span><br><span class="line">		&lt;/div&gt;</span><br><span class="line">		&lt;!--</span><br><span class="line">	vuetouch为函数名，如没有参数，可直接写函数名,比如：v-tap=&quot;vuetap&quot;</span><br><span class="line">	如果有参数以对象形式传，fn 为函数名</span><br><span class="line">--&gt;</span><br><span class="line">		&lt;script&gt;</span><br><span class="line">			kim = new Vue(&#123;</span><br><span class="line">				el: &quot;#app&quot;,</span><br><span class="line">				data: &#123;</span><br><span class="line">					name: &quot;开始&quot;</span><br><span class="line">				&#125;,</span><br><span class="line">				methods: &#123;</span><br><span class="line">					vuetap: function(s, e) &#123;</span><br><span class="line">						console.log(e)</span><br><span class="line">						this.name = s.name;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">		&lt;/script&gt;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/02/理解-HTTPS/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/02/理解-HTTPS/" itemprop="url">理解 HTTPS</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-02T17:33:47+08:00">
                2018-09-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="HTTP2"><a href="#HTTP2" class="headerlink" title="HTTP2"></a>HTTP2</h3><h4 id="关于TLS-SSL协议"><a href="#关于TLS-SSL协议" class="headerlink" title="关于TLS/SSL协议"></a><a href="https://juejin.im/post/5c1a02a06fb9a049db7313c9" target="_blank" rel="noopener">关于TLS/SSL协议</a></h4><h4 id="面试官问：你了解HTTP2-0吗？"><a href="#面试官问：你了解HTTP2-0吗？" class="headerlink" title="面试官问：你了解HTTP2.0吗？"></a><a href="https://juejin.im/post/5c0ce870f265da61171c8c66" target="_blank" rel="noopener">面试官问：你了解HTTP2.0吗？</a></h4><blockquote>
<p>SSL，是利用数据加密技术，用以保障在Internet上数据传输安全的协议，ssl证书就是遵守SSL协议的一种数字证书，验证网站主体身份和数据传输加密。<br>TLS，安全传输层协议，用于在两个通信应用程序之间提供保密性和数据完整性。TLS加密于TLS加密区别在于，加密算法不同。现在还是SSL加密比较多，GDCA的SSL证书比较常见！</p>
</blockquote>
<p><img src="/2018/09/02/理解-HTTPS/1.webp" alt=""><br>http2 的前身是由 google 领导开发的 SPDY，后来 google 把整个成果交给 IETF，IETF 把 SPDY 标准化之后变成 http2。google 也很大方的废弃掉 SPDY，转向支持 http2。http2 是完全兼容 http/1.x 的，在此基础上添加了 4 个主要新特性：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">二进制分帧</span><br><span class="line">头部压缩</span><br><span class="line">服务端推送</span><br><span class="line">多路复用</span><br><span class="line">优化手段</span><br></pre></td></tr></table></figure></p>
<p><a href="https://juejin.im/post/5aaccf8f51882555784dbabc" target="_blank" rel="noopener">http2 简介</a></p>
<h3 id="存在即合理"><a href="#存在即合理" class="headerlink" title="存在即合理"></a>存在即合理</h3><p><font color="#ff0000">http是非常常见的应用层协议，是超文本传输协议的简称，其传输的内容都是明文的。</font> 在这个混乱的世界，明文传输信息想想就可怕，网络“小混混”的手段远比我们这些凡人高明得多，他们有一万种方式劫持，篡改我们的数据。对于一个网站或者服务，如果你给你的用户两个选择：</p>
<ul>
<li>通讯数据明文传输，速度快；</li>
<li>通讯数据加密传输，但是速度可能会稍微慢一点.<br>我想，只要脑袋没有长歪的用户都宁愿牺牲一点速度去换取数据传输的安全。</li>
</ul>
<p>这样，https的存在就具备了合理性，https中的s表示SSL或者TLS，就是在原http的基础上加上一层用于<font color="#ff0000">数据加密、解密、身份认证</font>的安全层。</p>
<h3 id="HTTP协议的缺点"><a href="#HTTP协议的缺点" class="headerlink" title="HTTP协议的缺点"></a>HTTP协议的缺点</h3><ul>
<li>通信使用明文；</li>
<li>不验证通信方的身份；</li>
<li>无法验证报文的完整性；</li>
</ul>
<p><strong>通信使用明文:</strong> 通信使用明文意味着安全性大大降低，当通信过程被窃听后，无需花费额外的投入就可看到传输的数据。例如使用抓包工具，无需任何配置就可查看任何使用HTTP协议的通信数据；<br><strong>不验证通信方身份 :</strong>不验证通信方的身份，将导致通信过程被窃听后，可能会遭遇伪装，例如使用抓包工具抓取数据后，就可按照数据包的格式构造HTTP请求；<br><strong>无法验证报文的完整性:</strong>不验证报文的完整性，数据在传输过程中就可能被篡改，本来想看喜洋洋呢，结果数据在传输过程中被换成了光头强。</p>
<p>为解决了HTTP的以上问题，HTTPS协议就诞生了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Https = Http + 加密 + 认证 + 完整性验证</span><br><span class="line">        ||</span><br><span class="line">Https = Http + SSL</span><br><span class="line">        ||</span><br><span class="line">HTTPS=数据加密+网站认证+完整性验证+HTTP</span><br></pre></td></tr></table></figure></p>
<h3 id="HTTP-与-HTTPS-的区别"><a href="#HTTP-与-HTTPS-的区别" class="headerlink" title="HTTP 与 HTTPS 的区别"></a>HTTP 与 HTTPS 的区别</h3><ul>
<li>HTTP 是明文传输，HTTPS 通过 SSL\TLS 进行了加密</li>
<li>HTTP 的端口号是 80，HTTPS 是 443</li>
<li>HTTPS 需要到 CA 申请证书，一般免费证书很少，需要交费</li>
<li>HTTPS 的连接很简单，是无状态的；HTTPS 协议是由 SSL+HTTP 协议构建的可进行加密传输、身份认证的网络协议，比 HTTP 协议安全。</li>
</ul>
<h3 id="HTTPS主要缺点："><a href="#HTTPS主要缺点：" class="headerlink" title="HTTPS主要缺点："></a>HTTPS主要缺点：</h3><ul>
<li>网络耗时（比HTTP多了交互次数）。</li>
<li>加解密耗时。</li>
<li>比HTTP慢几百毫秒以上，页面加载时间增加了50%，增加10%到20%的耗电</li>
</ul>
<h3 id="HTTPS工作流程："><a href="#HTTPS工作流程：" class="headerlink" title="HTTPS工作流程："></a>HTTPS工作流程：</h3><p><img src="/2018/09/02/理解-HTTPS/20170113193549689.png" alt=""><br>1.客户端向服务器发送请求，并告诉服务器支持的算法列表；<br>2.服务器选择一种算法，并将自己的证书返回给客户端，证书包含服务器域名和公钥等信息；<br>3.客户端得到证书后进行验证，验证通过的话就生成一个随机值，并用证书中的公钥进行加密<br>4.传递加密信息，目的就是让服务器得到这个随机值，以后客户端与服务器的通信就可以通过这个随机值来进行加密解密；<br>5.服务器用自己的私钥解密客户端传过来的随机值，然后把内容进行对称加密，即将信息和私钥通过加密算法混在一起，这样除非知道私钥，不然无法获取到内容，而客户端与服务器都知道这个私钥，所以只要加密算法够强大，私钥够复杂，数据就很安全了；<br>6.将加密后的信息发给客户端，客户端还原信息<br>7.客户端用之前生成的私钥解密服务器发过来的信息，便获取到了解密后的内容；</p>
<p>那么加密的信息通道又加密了哪些信息呢？</p>
<p>签发证书的 CA 中心会发布一种权威性的电子文档——数字证书，它可以通过加密技术（对称加密与非对称加密）对我们在网上传输的信息进行加密，比如我在 Pornhub 上输入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">账号：cbssfaw</span><br><span class="line">密码：123djaosid</span><br></pre></td></tr></table></figure></p>
<p>可是这个数据被黑客拦截盗窃了，那么加密后，黑客得到的数据可能就是这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">账号：çµø…≤¥ƒ∂ø†®∂˙∆¬</span><br><span class="line">密码：∆ø¥§®†ƒ©®†©˚¬</span><br></pre></td></tr></table></figure></p>
<hr>
<p>想要理解 HTTPS 加密。需要理解几个概念：</p>
<ul>
<li>对称加密算法</li>
<li>非对称加密算法</li>
<li>CA(Certificate Authority)</li>
<li>数字证书</li>
<li>摘要算法</li>
</ul>
<blockquote>
<p>常用的加密方式分为两种：</p>
</blockquote>
<ul>
<li>对称加密：<strong> <font color="#dd0000">加密和解密使用的是相同的密钥。</font></strong></li>
<li>非对称加密：<strong> <font color="#dd0000">加密和解密使用的不是相同的密钥，而是一对密钥对，分别称为公钥和私钥。 </font></strong></li>
</ul>
<blockquote>
<p>HTTPS 用了哪种加密方法？</p>
</blockquote>
<p>在 HTTPS 中，对称加密和非对称加密都用到了。非对称加密可以在不安全的信道上传递秘密内容，但是由于通常使用的非对称加密方法相较于对称加密算法慢很多，因此在 HTTPS 中仅使用非对称加密算法交换对称密钥，交换密钥之后的通信内容均使用对称加密算法加密和解密，这样既可以保证密钥的安全也可以保证内容的加解密速度，这对于移动端设备来说至关重要。</p>
<p>现在的问题是，如何在实现 HTTP 协议的情况下，对传输的信息进行加密解密？最开始使用到的是最简单的对称加密算法。 </p>
<h3 id="对称加密算法"><a href="#对称加密算法" class="headerlink" title="对称加密算法"></a>对称加密算法</h3><p>对称加密算法非常简单，只要加密方和解密方都拥有同一密钥（可为128，192，256 bit 大小的密钥，密钥越长，加密解密时间越长，解密难度也越高），即可完成加密解密过程，且假设无法强制对加密过的明文进行解密。</p>
<p><strong> 问题：对于需要传递加密信息的双方而言，对称加密算法用于加密解密没有什么问题，但是密钥的传输就成了另外一个问题。因为密钥也需要传输才能使双方通信，密钥明文传输出去，被人轻易截取，就能利用密钥破解加密的密文。 </strong></p>
<p>所以引出了下面的非对称加密算法来传输密钥。</p>
<h3 id="公开密钥加密-Public-Key-Cryptography-的非对称加密算法"><a href="#公开密钥加密-Public-Key-Cryptography-的非对称加密算法" class="headerlink" title="公开密钥加密(Public-Key Cryptography)的非对称加密算法"></a>公开密钥加密(Public-Key Cryptography)的非对称加密算法</h3><p>对于使用最广泛的非对称加密算法——RSA，RSA 算法基于一个简单的数论理论：将两个大素数相乘十分容易，但是想要对其乘积进行因式分解却极其困难，因此可以将乘积公开作为加密密钥。</p>
<p>RSA 算法得出了下面的规则：通讯两方 A, B 分别都有各自的一套公钥和私钥。同一套公钥私钥当中，公钥的加密需要私钥才能解密，私钥的加密需要公钥才能解密。</p>
<p>假设 A 把自己的公钥公开出去，B 得到了 A 的公钥，然后 B 用 A 的公钥加密了明文，传给 A，A 用私钥解密，即可获得明文。所以，过程中公开的信息任何第三方得到都不可以破解 A 和 B 要传递的信息。有了这个算法之后，对称加密算法所用到的密钥传输安全性就没问题了。但是因为加密解密过程时间比较长，非对称加密算法不适合应用于数据量大的信息传递，只适用于密钥的传递。（这个问题解释了对于数字签名的摘要算法的必要性）</p>
<h4 id="问题：虽然-RSA-算法也没有什么问题，但是却有人想出更绝的方法破解加解密的过程。这个方法就是中间人攻击。"><a href="#问题：虽然-RSA-算法也没有什么问题，但是却有人想出更绝的方法破解加解密的过程。这个方法就是中间人攻击。" class="headerlink" title="问题：虽然 RSA 算法也没有什么问题，但是却有人想出更绝的方法破解加解密的过程。这个方法就是中间人攻击。"></a>问题：虽然 RSA 算法也没有什么问题，但是却有人想出更绝的方法破解加解密的过程。这个方法就是<strong>中间人攻击</strong>。</h4><p>在用非对称加密算法传递密钥的过程中，因为公钥都是公开的，并没有任何东西可以认证这个公钥是 A 的还是 B 的。现在出现了中间人 M，M 采取某种手段在 A 和 B 的通讯过程成为中间人。在 B 想要得到 A 的公钥的时候，M 向 B 谎称自己的这个公钥是 A 的公钥，B 拿到用 M 的公钥加密信息后，传出 M 手中，然后 M 拿加密过的信息，然后用自己的私钥把这个信息解密，得到明文。既然已经知道了明文，还是用 A 的公钥加密这个信息，继续给 A，这样 A 还是以为这个信息是安全的，继续用私钥解开。而在这个过程中，M 既获得了信息，又没有让 A，B 双方知道。至于这个 M 是怎么欺骗 A，B 的，又是另外一个安全的问题。总之，假如 M 只要让 B 相信这个公钥是 A 的，就可以作中间人攻击。</p>
<p>假如上面的 A 是服务器，B 是用户，那么中间人就很容易获取和修改 A，B 需要传输的信息。所以为了让 M 不再得逞，出现一个具有公信力的第三方——CA。</p>
<h3 id="CA-Certificate-Authority-第三方认证机构"><a href="#CA-Certificate-Authority-第三方认证机构" class="headerlink" title="CA(Certificate Authority) 第三方认证机构"></a>CA(Certificate Authority) 第三方认证机构</h3><p>简单来说，CA 要做的就是，让 B 相信拿到的 A 的公钥真正属于 A，而不是其他中间人 M 伪造。</p>
<p>而在 CA 在做这件事的过程中如何才能让 B 认证这个公钥是 A 的呢？</p>
<p>这里需要另外一个概念：数字证书。</p>
<p>普通证书产生的过程就是：将个人提交的信息进行第三方具有权威性部门的认证，然后第三方权威部门确认个人信息<strong>合法无误</strong>后在自己的系统中登记，再把认证证书盖章签名给到个人手上，然后个人就可以用证书从事各类证明活动。现实世界中的做法是在个人提交的信息上盖章，例如4，6级的证书认证。假设你的成绩申请无误而合法，教育局就会将你的成绩记录，然后给你一张盖过章的证书。</p>
<p>数字证书同理。不过，与现实不一样，在互联网上完成一个完整的验证过程，需要兼顾到很多过程中的纰漏。</p>
<p>例如：</p>
<h4 id="问题：证书上的章是一个不可信任的机构的，该如何认证哪些机构才是可信任机构？"><a href="#问题：证书上的章是一个不可信任的机构的，该如何认证哪些机构才是可信任机构？" class="headerlink" title="问题：证书上的章是一个不可信任的机构的，该如何认证哪些机构才是可信任机构？"></a>问题：证书上的章是一个不可信任的机构的，该如何认证哪些机构才是可信任机构？</h4><p>现实中就是向政府部门认证哪些是登记过的可信任的部门，像4，6级证书颁发的部门——全国大学英语四六级考试委员会，是全国的教育局的下级和内部部门，是认证过的。而在互联网中，就需要顶级的最具有公信力的 CA，这个 CA 颁发的证书是最受信任的，这个就是<strong>根证书</strong>。为了不让所有鸡蛋都放在一个篮子里，其他的 CA 机构可以向上一级的 CA 机构申请成为中间 CA，获取自己的<strong>中间证书</strong>，最终个人像 A 向某一个中间 CA 申请的证书就是最终的<strong>终端普通数字证书</strong>。这个过程的签发关系就是<strong>证书链</strong>。当 B 得到 A 的数字证书之后，会在证书的信息中找到 A 申请的 CA，而这个 CA 则会根据自己中间证书找到的自己申请的 CA，就这样沿着证书链找证书，假如某个中间证书或者根证书在本机中安装有，则认证的时候会将 A 的证书设置为可被信任的。</p>
<p>如何识别可信任机构的这个问题就解决了。</p>
<h4 id="问题：可以轻易做到用与政府同样的章在证书上盖章伪造，该如何认证这个证书不是个人盖章签名伪造的？"><a href="#问题：可以轻易做到用与政府同样的章在证书上盖章伪造，该如何认证这个证书不是个人盖章签名伪造的？" class="headerlink" title="问题：可以轻易做到用与政府同样的章在证书上盖章伪造，该如何认证这个证书不是个人盖章签名伪造的？"></a>问题：可以轻易做到用与政府同样的章在证书上盖章伪造，该如何认证这个证书不是个人盖章签名伪造的？</h4><p>现实中可以在这个已经被认证的第三方机构系统中查询，像4，6级，可以到教育局的网上公开系统中查询。而在互联网中，则需要一个类似的查询验证过程——数字签名。为了对这个证书的验证，确保这个签名是来自可信任的 CA，而不是其他不可信的 CA。CA 在给 A 的数字证书中有一个数字签名。该签名是 CA 用自己的私钥对 A 的个人信息进行非对称加密得到的加密信息。当 B 得到 A 提供的数字证书，会拿到其中的数字签名和 A 的个人信息，然后用 CA 的公钥对这个数字签名进行非对称解密，得出的信息假如和 A 的数字证书中 A 的个人信息一样的话，就相信这个数字证书确实是 CA 认证过的。</p>
<p>如何认证这个签名是不是伪造的这个问题也解决了。但是这个问题又引出了另外一个问题：数字证书中 A 的个人信息数据比较大，而非对成加密算法的加密解密速度非常慢，使得认证过程中对个人信息的非对称加密解密非常耗占时间。所以需要用到另外一种算法来加快这个验证过程，这个算法就是摘要算法。（一直很疑惑为什么需要到摘要算法，总算找到了一个原因）</p>
<p>摘要算法可以将任意大小的原文消息加密并摘要成固定长度的简短密文。对于不同的原文消息，用同一种摘要算法，都可以得到不同但是固定长度的密文，而相同的原文消息，用同一种摘要算法，则可以得到相同固定长度的密文。这就解决了数字签名过程中，对数据大的个人信息文件的非对称加密解密的时间慢的问题。CA 用 A 个人信息进行摘要算法的处理，然后继续用私钥加密，作为数字证书的数字签名给到 A。B 拿到 A 提供的数字签名和 A 的个人信息，然后用 CA 的公钥解密 A 的数字签名，得到 A 个人信息的摘要。再用同一种摘要算法对 A 的个人信息进行处理，得到 A 个人信息的摘要，再与解密得到的 A 个人信息摘要对比，就可以确认改数字签名和个人信息是匹配的。 </p>
<p>到这一步，中间人攻击已经很难可以发生了，假设 M 想要在 A 和 B 之间充当中间人，有三种手段：</p>
<ul>
<li>需要从 A 服务器中直接获取域名数字证书；</li>
<li>得到 A 的域名管理，向 CA 申请证书</li>
<li>自己签发证书，然后要求 B 安装自己的证书。</li>
</ul>
<p>对于第一第二个问题的防范，在服务器端，只要要保护好私钥和服务器和域名的安全，就不会出现大问题。</p>
<p>对于第三个问题，在客户端，有一个很好的例子：12306。12306 的证书就是中铁局自己搞的认证机构颁发的。当你浏览 12306 的时候，虽然请求是带 HTTPS，但是浏览器检查的时候发现这个中铁局的认证机构没有在证书链当中，会提示“可能会被攻击”，当然 12306 会要求你直接安装他们的证书。这就要求你自己的明察秋毫了，你是选择相信 ZF 的证书，然后可能以后 ZF 的某些网站可能会在中铁局的认证机构认证证书，然后假装是 HTTPS，并且可能会伪装窃取你的个人信息。所以在客户端，安装证书需要谨慎，不要随意安装不信任的证书。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/tx.jpg" alt="李斌">
            
              <p class="site-author-name" itemprop="name">李斌</p>
              <p class="site-description motion-element" itemprop="description">想要飞得高，那就把地平线忘掉</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">147</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">106</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/libin1991" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://juejin.im/user/57e737f6c4c971005f6bcd8d" target="_blank" title="juejin">
                      
                        <i class="fa fa-fw fa-spinner"></i>juejin</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李斌</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
<script type="text/javascript" src="/js/src/clicklove.js"></script>

