<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="武动乾坤">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="武动乾坤">
<meta property="og:description" content="Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="武动乾坤">
<meta name="twitter:description" content="Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/">





  <title>武动乾坤 - 星光不问赶路人 岁月不负有心人</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband">
    	<div class="eevee"><div class="body"><div class="head"><div class="ears"><div class="ear"><div class="lobe"></div></div><div class="ear"><div class="lobe"></div></div></div><div class="face"><div class="eyes"><div class="eye"><div class="eyelid"></div></div><div class="eye"><div class="eyelid"></div></div></div><div class="nose"></div><div class="mouth"></div></div></div><div class="chest"><div class="fur"><div class="patch"></div></div><div class="fur"><div class="patch"></div></div><div class="fur"><div class="patch"></div></div></div><div class="legs"><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div></div><div class="tail"><div class="tail"><div class="tail"><div class="tail"><div class="tail"><div class="tail -end"></div></div></div></div></div></div></div></div>
    </div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
    	<div id="sky">
				<div id="background" class="container">
			<!-- svg file -->
			<svg id="svgout" height="100%" width="100%" viewbox="0 0 550 400">
				<defs>
					<g id="bottomShadow">
						<path fill="#000000" stroke="none" d="
		M 270.5 225.95
		L 127.35 316.65 266.8 400 409.6 309.25 270.5 225.95 Z"/>
					</g>
					<g id="Layer52_0_FILL">
						<path class="topGrass" fill="#B9D668" stroke="none" d="
	M 397.85 229.3
	L 397.85 225.6 269.85 152 135.75 228.6 135.75 233.65 262.1 306.55 397.85 229.3 Z"/>
					</g>
					<g id="Layer51_0_FILL">
						<path class="leftSideGrass" fill="#6E9E4F" stroke="none" d="
	M 135.1 229.95
	L 135.1 256.85 262.1 328.4 262.1 301.85 135.1 229.95 Z"/>
					</g>
					<g id="Layer50_0_FILL">
						<path class="rightGrassTop" fill="#8CB154" stroke="none" d="
	M 397.85 225.95
	L 395.8 225.95 261.75 301.55 261.75 328.4 397.85 251.15 397.85 225.95 Z"/>
					</g>
					<g id="Layer48_0_FILL">
						<path class="crustLeftTop" fill="#955541" stroke="none" d="
	M 135.45 282.4
	L 135.75 298.15 262.1 372.1 261.75 355.65 135.45 282.4 Z"/>
					</g>
					<g id="Layer47_0_FILL">
						<path class="middleLeftCrust" fill="#C77E61" stroke="none" d="
	M 135.1 270.3
	L 135.1 283.05 275.9 364.35 271.85 348.9 135.1 270.3 Z"/>
					</g>
					<g id="Layer46_0_FILL">
						<path class="crustLeftTop" fill="#955541" stroke="none" d="
	M 135.1 255.15
	L 135.1 270.3 262.1 343.55 262.1 328.05 135.1 255.15 Z"/>
					</g>
					<g id="Layer45_0_FILL">
						<path class="topRightCrust" fill="#A47237" stroke="none" d="
	M 397.5 294.5
	L 397.5 277 261.75 355.3 261.75 372.75 397.5 294.5 Z"/>
					</g>
					<g id="Layer44_0_FILL">
						<path class="middleRightCrust" fill="#C89451" stroke="none" d="
	M 397.5 269.95
	L 397.15 266.6 262.1 343.2 262.1 355.95 397.5 279.7 397.5 269.95 Z"/>
					</g>
					<g id="Layer43_0_FILL">
						<path class="topRightCrust" fill="#A47237" stroke="none" d="
	M 397.5 266.6
	L 397.5 250.45 261.75 328.4 261.75 343.85 397.5 266.6 Z"/>
					</g>
					<g id="Layer41_0_FILL">
						<path class="greyRoad" fill="#B2B2B1" stroke="none" d="
	M 295.05 283.05
	Q 299.05 280.35 308.45 275.3 317.85 269.95 323.6 266.9
	L 268.8 233.65 338.05 191.35 309.15 174.55 177.75 254.5
	Q 191.55 262.2 198.25 266.25 204.65 269.95 209.7 271.95
	L 241.6 250.45 295.05 283.05 Z"/>
					</g>
					<g id="Layer40_0_FILL">
						<path fill="#FFFFFF" stroke="none" d="
	M 199.95 256.85
	Q 194.55 261.2 191.9 262.2
	L 194.9 263.9 200.95 259.2 199.95 256.85
	M 225.8 243.75
	L 224.8 241.75 211.05 250.8 212.05 252.8 225.8 243.75
	M 308.15 275.65
	L 296.7 266.6 295.35 268.6 306.8 277.7 308.15 275.65
	M 275.9 253.5
	L 274.55 255.5 285.95 264.55 287.3 262.55 275.9 253.5
	M 251.7 227.3
	L 250.7 225.25 236.9 234.35 237.9 236.35 251.7 227.3
	M 257.05 240.7
	L 254.05 240.7 268.8 249.8 269.5 247.75 257.05 240.7
	M 277.2 207.8
	L 263.45 216.85 264.45 218.9 278.25 209.8 277.2 207.8
	M 305.1 192.65
	L 304.1 190.65 290.3 199.75 291.35 201.75 305.1 192.65 Z"/>
					</g>
					<g id="Layer38_0_FILL">
						<path class="frontFascia" fill="#ECB27B" stroke="none" d="
	M 359.25 187.95
	L 346.4 174.95 333.85 202.9 359.25 187.95 Z"/>
					</g>
					<g id="Layer37_0_FILL">
						<path class="frontWall" fill="#EFA258" stroke="none" d="
	M 334 201.05
	L 334.35 232 359.2 217.55 359.25 187.95 334 201.05 Z"/>
					</g>
					<g id="Layer36_0_FILL">
						<path class="leftWall" fill="#C57F42" stroke="none" d="
	M 334.35 232.3
	L 334.35 205.1 305.1 191.35 305.1 216.85 334.35 232.3 Z"/>
					</g>
					<g id="Layer35_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 329.7 167.9
	L 331.05 167.9 344.55 176.7 347.85 176.7 363 192.25 363.15 189.55 350.65 176.7 350.55 176.7 334.25 167.5 334.25 159.1 329.7 159.1 329.7 164.9 322.65 160.95 322.3 162.15 329.7 167 329.7 167.9 Z"/>
					</g>
					<g id="Layer34_0_FILL">
						<path class="leftRoof" fill="#F2563B" stroke="none" d="
	M 334.05 207.05
	L 350.65 176.7 322.1 160.45 302.1 192.05 334.05 207.05 Z"/>
					</g>
					<g id="Layer30_0_FILL">
						<path id="windowFour" class="windows" stroke="none" fill="#975A42" d="
	M 341.35 203.3
	Q 340.9 203.45 340.5 203.8 340.1 204.2 339.85 204.75 339.7 205 339.7 205.3 339.6 205.75 339.7 206.1 339.7 206.15 339.7 206.2 339.8 206.5 340 206.8 340.55 207.4 341.45 207.4 342.35 207.4 343 206.8 343.4 206.5 343.65 206.1 343.85 205.75 343.95 205.3 344.05 204.4 343.55 203.8 343.3 203.45 343 203.3 342.65 203.15 342.2 203.15 341.8 203.15 341.35 203.3
	M 355.85 198.45
	Q 355.8 198.2 355.6 198 355.1 197.4 354.2 197.4 353.35 197.4 352.6 198 351.85 198.65 351.7 199.55 351.7 199.7 351.7 199.85 351.6 200.5 352 201.05 352.55 201.65 353.45 201.65 354.3 201.65 355.05 201.05 355.45 200.7 355.7 200.25 355.8 200.05 355.9 199.85 355.95 199.7 355.95 199.55 356.05 198.95 355.85 198.45 Z"/>
						<path class="door" fill="#B65041" stroke="none" d="
	M 351.95 211.2
	L 351.8 211.2 346.05 215.1 346.05 225.2 351.95 221.6 351.95 211.2
	M 351.2 211.2
	L 351.35 211.2 351.35 211.1 351.2 211.2 Z"/>
					</g>
					<g>
						<path id="Layer30_0_FILL" fill="#000000" fill-opacity="1" stroke="none" d="
	M 183.7 215.3
	L 183.7 215.6
	Q 187.25 231.75 212.25 234.35
	L 183.7 215.3 Z"/>
					</g>
					<g id="Layer29_0_FILL">
						<path fill="#000000" fill-opacity="0.4" stroke="none" d="
	M 305.1 216.85
	L 305.15 217.2
	Q 309.45 233.2 334.35 232.3
	L 305.1 216.85 Z"/>
					</g>
					<g id="Layer27_0_FILL">
						<path class="vegetation" fill="#78A950" stroke="none" d="
	M 177.45 231.65
	Q 175.75 235.35 181.8 239.35 185.5 235.7 185.15 231.3 182.8 230.65 181.45 234 179.45 231.3 177.45 231.65
	M 236.9 266.6
	Q 235.2 270.3 241.25 274.3 244.95 270.6 244.65 266.25 242.3 265.6 240.95 268.95 238.9 266.25 236.9 266.6
	M 254.7 277
	Q 253.05 280.7 259.1 284.75 262.75 281.05 262.45 276.65 260.1 276 258.75 279.35 256.7 276.65 254.7 277
	M 315.5 245.75
	Q 313.5 243.05 311.5 243.4 309.8 247.1 315.85 251.15 319.55 247.45 319.2 243.05 316.85 242.4 315.5 245.75
	M 295.35 232.65
	Q 293.7 236.35 299.75 240.4 303.45 236.7 303.1 232.3 300.75 231.65 299.4 235 297.4 232.3 295.35 232.65
	M 277.2 171.85
	Q 275.55 175.55 281.6 179.55 285.3 175.85 284.95 171.5 282.6 170.85 281.25 174.2 279.25 171.5 277.2 171.85 Z"/>
					</g>
					<g id="Layer26_0_FILL">
						<path class="treeWood" fill="#AE663D" stroke="none" d="
	M 175.1 177.55
	L 172.05 177.55 172.05 191.1 159.3 172.85
	Q 154.6 171.5 172.05 195.7
	L 172.05 212.5 175.1 212.5 175.1 177.55
	M 252.7 151.35
	L 249 151.35 249 176.9 252.7 176.9 252.7 151.35 Z"/>
					</g>
					<g id="Layer25_0_FILL">
						<path class="vegetation" fill="#77A951" stroke="none" d="
	M 192.55 179.55
	Q 200.95 173.5 200.95 165.1 200.95 156.4 192.55 150 184.15 144.3 172.05 144.3 160.3 144.3 151.9 150 143.15 156.4 143.15 165.1 143.15 173.5 151.9 179.55 160.3 185.95 172.05 185.95 184.15 185.95 192.55 179.55
	M 236.25 106.65
	Q 230.2 116.05 230.2 129.15 230.2 142.25 236.25 151.35 242.3 160.75 250.7 160.75 258.75 160.75 264.8 151.35 270.85 142.25 270.85 129.15 270.85 116.05 264.8 106.65 258.75 97.6 250.7 97.6 242.3 97.6 236.25 106.65 Z"/>
					</g>
					<g id="Layer24_0_FILL">
						<path class="vegetation" fill="#77A951" stroke="none" d="
	M 158.3 221.9
	Q 160.65 221.9 161.95 220.2 163 219.55 163.3 218.55 164.65 218.9 166.35 218.9 170.05 218.9 172.4 216.2 175.1 213.85 175.1 210.15 175.1 206.45 172.4 203.75 170.05 201.4 166.35 201.4 162.65 201.4 159.95 203.75 157.6 206.45 157.6 210.15 157.6 210.8 157.6 211.15 155.95 211.5 154.6 212.5 152.9 214.15 152.9 216.55 152.9 218.9 154.6 220.2 156.25 221.9 158.3 221.9
	M 338.35 240.05
	Q 341.05 237.7 341.05 234 341.05 230.3 338.35 227.6 336 225.25 332.3 225.25 328.65 225.25 325.95 227.6 323.6 230.3 323.6 234 323.6 237.7 325.95 240.05 328.65 242.75 332.3 242.75 336 242.75 338.35 240.05 Z"/>
					</g>
					<g id="Layer22_0_FILL">
						<path class="rightRoof" fill="#D05041" stroke="none" d="
	M 220 173.85
	L 236.8 186.7 264.35 171.15 244.5 159.55 220 173.85 Z"/>
					</g>
					<g id="Layer21_0_FILL">
						<path class="leftWall" fill="#C57F42" stroke="none" d="
	M 212.25 191.35
	L 183.35 172.3 183.7 215.3 212.25 234.35 212.25 191.35 Z"/>
					</g>
					<g id="Layer20_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 192.1 149.85
	L 236.45 174.8 243.1 171.4
	Q 220.05 150.55 196.3 139.95
	L 192.1 149.85 Z"/>
					</g>
					<g id="Layer19_0_FILL">
						<path class="frontFascia" fill="#EBB17B" stroke="none" d="
	M 226.85 160.95
	L 212 190.6 229.75 192.6 239.75 172.85 226.85 160.95 Z"/>
					</g>
					<g id="Layer18_0_FILL">
						<path class="frontWall" fill="#EFA258" stroke="none" d="
	M 240.15 172.65
	L 211.9 191.6 212.25 233.65 264.35 201.7 264.35 170.8 240.8 184.45 240.15 172.65 Z"/>
					</g>
					<g id="Layer17_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 210.9 142.2
	L 205.9 142.2 205.9 152.65 210.9 152.65 210.9 142.2 Z"/>
					</g>
					<g>
						<path id="Layer16_0_FILL" class="leftRoof" fill="#F2563B" stroke="none" d="
	M 210.25 195.5
	L 227.4 160.95 195.45 141.35 177.65 175.85 210.25 195.5 Z"/>
					</g>
					<g>
						<path id="sun" fill="#E3BD0E" stroke="none" d="
	M 257.05 15.95
	Q 251.7 15.95 248 19.65 244.3 23.35 244.3 28.7 244.3 34.1 248 37.8 251.7 41.5 257.05 41.5 262.45 41.5 266.15 37.8 269.85 34.1 269.85 28.7 269.85 23.35 266.15 19.65 262.45 15.95 257.05 15.95 Z"/>
					</g>
					<g id="Layer8_0_FILL">
						<path fill="#975A42" stroke="none" d="
	M 238.45 189.65
	Q 238.295703125 189.362109375 238.05 189.1 237.35 188.3 236.2 188.3 235.05 188.3 234.15 189.1 233.3 189.9 233.2 191.05 233.1 192.2 233.8 193 234.55 193.8 235.7 193.8 236.85 193.8 237.7 193 238.1970703125 192.558203125 238.45 192 238.6552734375 191.56484375 238.7 191.05 238.7671875 190.276953125 238.45 189.65
	M 220.55 197.55
	Q 220 197.55 219.5 197.75 218.95 197.95 218.5 198.35 217.933203125 198.8833984375 217.7 199.55 217.5833984375 199.916796875 217.55 200.3 217.4923828125 200.96171875 217.7 201.5 217.852734375 201.9103515625 218.15 202.25 218.95 203.05 220.1 203.05 221.25 203.05 222.05 202.25 222.95 201.45 223.05 200.3 223.15 199.15 222.4 198.35 222.05 197.95 221.65 197.75 221.15 197.55 220.55 197.55 Z"/>
					</g>
					<g id="Layer7_0_FILL">
						<path class="door" fill="#B65041" stroke="none" d="
	M 233.55 206.75
	L 225.9 211.95 226.25 225.5 233.95 220.35 233.55 206.75 Z"/>
					</g>
					<g>
						<path id="windowOne" class="windows" fill="#975A42" stroke="none" d="
	M 188.65 198.4
	L 188.8 204.1 198.65 210.45 198.55 204.75 188.65 198.4
	M 208.45 216.8
	L 208.35 211.1 198.55 204.75 198.65 210.45 208.45 216.8
	M 188.8 204.1
	L 188.95 209.8 198.8 216.15 198.65 210.45 188.8 204.1
	M 208.6 222.5
	L 208.45 216.8 198.65 210.45 198.8 216.15 208.6 222.5 Z"/>
					</g>
					<g>
						<path id="windowThree" class="windows" fill="#975A42" stroke="none" d="
	M 311.7 214.1
	L 318.55 217.55 318.45 211.9 311.6 208.45 311.7 214.1
	M 325.4 221
	L 325.25 215.35 318.45 211.9 318.55 217.55 325.4 221
	M 318.4 206.2
	L 311.5 202.75 311.6 208.45 318.45 211.9 318.4 206.2
	M 325.25 215.35
	L 325.2 209.7 318.4 206.2 318.45 211.9 325.25 215.35 Z"/>
					</g>
					<g id="Layer2_0_FILL">
						<path class="door" fill="#B65041" stroke="none" d="
	M 259.7 183.25
	L 244.6 191.9 244.6 213.8 259.7 204.55 259.7 183.25 Z"/>
					</g>
					<path id="windowTwo" fill="#975A42" class="windows" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" d="
	M 223.05 200.3
	Q 222.95 201.45 222.05 202.25 221.25 203.05 220.1 203.05 218.95 203.05 218.15 202.25 217.852734375 201.9103515625 217.7 201.5 217.4923828125 200.96171875 217.55 200.3 217.5833984375 199.916796875 217.7 199.575 217.933203125 198.8833984375 218.5 198.35 218.95 197.95 219.5 197.75 220 197.55 220.55 197.55 221.15 197.55 221.65 197.75 222.05 197.95 222.4 198.35 223.15 199.15 223.05 200.3 Z
	M 238.7 191.05
	Q 238.6552734375 191.56484375 238.45 192 238.1970703125 192.558203125 237.7 193 236.85 193.8 235.7 193.8 234.55 193.8 233.8 193 233.1 192.2 233.2 191.05 233.3 189.9 234.15 189.1 235.05 188.3 236.2 188.3 237.35 188.3 238.05 189.1 238.295703125 189.362109375 238.45 189.65 238.7671875 190.276953125 238.7 191.05 Z"/>
					<path fill="#F2563B" stroke="none" d=" M 351.95 211.2 L 351.8 211.2 346.05 215.1 346.05 225.2 351.95 221.6 351.95 211.2 Z"/>
					<path id="Layer6_0_1_STROKES" class="windowRims" stroke="#AE663D" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" fill="none" d="
	M 198.55 204.75
	L 208.35 211.1 208.45 216.8 208.6 222.5 198.8 216.15 188.95 209.8 188.8 204.1 188.65 198.4 198.55 204.75 198.65 210.45 208.45 216.8
	M 198.8 216.15
	L 198.65 210.45 188.8 204.1"/>
					<path id="Layer5_0_1_STROKES" class="windowRims" stroke="#AE663D" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" fill="none" d="
	M 325.25 215.35
	L 325.4 221 318.55 217.55 311.7 214.1 311.6 208.45 311.5 202.75 318.4 206.2 325.2 209.7 325.25 215.35 318.45 211.9 318.55 217.55
	M 318.4 206.2
	L 318.45 211.9 311.6 208.45"/>
				</defs>
				<g id="shadow">
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use xlink:href="#bottomShadow"/>
					</g>
				</g>
				<g transform="matrix( 1, 0, 0, 1, 0,0) ">
					<use xlink:href="#sun"/>
				</g>
				<g id="earth">
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer52_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer51_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer50_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer48_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer47_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer46_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer45_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer44_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer43_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer41_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer40_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer38_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer37_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer36_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer35_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer34_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowFour"/>
						<use class="element" xlink:href="#Layer32_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer30_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer27_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer26_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer25_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer24_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer22_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer21_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer20_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer19_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer18_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer17_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer16_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer8_0_FILL"/>
						<use class="element" xlink:href="#windowTwo"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer7_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowOne"/>
						<use class="element" xlink:href="#Layer6_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowThree"/>
						<use class="element" xlink:href="#Layer5_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer2_0_FILL"/>
					</g>
				</g>
			</svg>
			<! -- End of SVG file -->
			<! -- Moon/Sun Toggle -->
			<div id="toggleButton" class="day-toggle">
				<div class="sun-icon"></div>
				<label class="switch">
            <input id="toggleCheckbox" type="checkbox">
            <div class="slider"></div>
        </label>
				<div class="cloud-icon"></div>
			</div>
			<! -- Moon/Sun Toggle -->
			<! -- End of Container -->
		</div>
			</div>
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">武动乾坤</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">星光不问赶路人 岁月不负有心人</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/05/Redux源码分析/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="武动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/05/Redux源码分析/" itemprop="url">Redux源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-05T20:24:30+08:00">
                2018-11-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>抛开React不谈，Redux其实就只是一个管理状态的数据中心，然而作为一个数据中心它的特色在于我们不能够直接修改数据中心里面的数据，我们需要自行定义操作逻辑<code>reducer</code>，以及操作类型<code>action</code>,通过分发不同的<code>action</code>来匹配<code>reducer</code>里面对应的操作，才能达到修改数据的目的。</p>
<p>一般来说我们会通过以下方式来创建一个数据中心<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import &#123; createStore &#125; from&apos;redux&apos;</span><br><span class="line">const store = createStore(...blablabla)</span><br></pre></td></tr></table></figure></p>
<p>这里最为关键的就是<code>createStore</code>这个函数，接下来我想详细地对它做个分析。</p>
<h2 id="createStore方法剖析"><a href="#createStore方法剖析" class="headerlink" title="createStore方法剖析"></a>createStore方法剖析</h2><p>createStore.js这个文件纯代码的部分大概有100多行，如果把他们全部贴出来再一一分析并非明智之举，我认为只对关键的部分进行分析是更恰当的做法。<br><strong>要分析一个方法我觉得比较有意义的是看它接收了什么，以及返回了什么。</strong></p>
<h3 id="接收的参数"><a href="#接收的参数" class="headerlink" title="接收的参数"></a>接收的参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export default function createStore(reducer, preloadedState, enhancer) &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法接受三个参数，分别是<code>reducer</code>, <code>preloadedState</code>, <code>enhancer</code>。以上都分别可以由开发者进行定义，<code>reducer</code>就是由开发者定义的一个操作方法，它会以旧的状态作为参数，处理过后返回一个新的状态。<code>preloadedState</code>则可以理解成数据中心的初始状态，它是个可选值。</p>
<p>最后的<code>enhancer</code>又是什么呢？从字面上理解它是一个增强器，用于增强<code>createStore</code>。从源码看它的工作方式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">export default function createStore(reducer, preloadedState, enhancer) &#123;</span><br><span class="line">  .....</span><br><span class="line">  if (typeof preloadedState === &apos;function&apos; &amp;&amp; typeof enhancer === &apos;undefined&apos;) &#123; // 参数归一</span><br><span class="line">    enhancer = preloadedState</span><br><span class="line">    preloadedState = undefined</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (typeof enhancer !== &apos;undefined&apos;) &#123;</span><br><span class="line">    if (typeof enhancer !== &apos;function&apos;) &#123;</span><br><span class="line">      throw new Error(&apos;Expected the enhancer to be a function.&apos;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return enhancer(createStore)(reducer, preloadedState) // 直接返回一个增强后的`createStore</span><br><span class="line">  &#125;</span><br><span class="line">  .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可见，它接收了原来的<code>createStore</code>作为参数，并且返回了一个增强了的方法，最后用增强过的方法来调用原来传入的参数。了解原理之后我们可以很容易地写出一个<code>状态打印增强器</code>，用于打印<code>dispatch</code>前后的状态信息。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.....</span><br><span class="line">function enhancer(createStore) &#123;</span><br><span class="line">  return (reducer, initialState, enhancer) =&gt; &#123;</span><br><span class="line">    const store = createStore(reducer, initialState, enhancer)</span><br><span class="line"></span><br><span class="line">    function dispatch(action) &#123;</span><br><span class="line">      console.log(&apos;old&apos;, store.getState())</span><br><span class="line">      const res = store.dispatch(action);</span><br><span class="line">      console.log(&apos;new&apos;, store.getState())</span><br><span class="line">      return res</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 用心的dispatch方法来替换原有的dispatch方法</span><br><span class="line">    return &#123;</span><br><span class="line">      ...store,</span><br><span class="line">      dispatch</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const store = createStore(reducers, undefined, enhancer)</span><br></pre></td></tr></table></figure></p>
<p>另外，从Redux的源码可以看到<code>createStore</code>做了一种叫做参数归一的处理，在许多JS库中都会采用这种方式兼容不同情况下的参数传入。当我们不需要传入初始状态，而只需要使用<code>enhancer</code>增强器的时候，我们还可以把代码写成这样<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const store = createStore(reducers, enhancer)</span><br></pre></td></tr></table></figure></p>
<h3 id="2-返回值"><a href="#2-返回值" class="headerlink" title="2) 返回值"></a>2) 返回值</h3><p>接下来我们看看返回值。<code>createStore</code>最终会返回一个对象，包含的东西如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import $$observable from &apos;symbol-observable&apos;</span><br><span class="line"></span><br><span class="line">export default function createStore(reducer, preloadedState, enhancer) &#123;</span><br><span class="line">  .....</span><br><span class="line">  return &#123;</span><br><span class="line">    dispatch,</span><br><span class="line">    subscribe,</span><br><span class="line">    getState,</span><br><span class="line">    replaceReducer,</span><br><span class="line">    [$$observable]: observable</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这些便是我们数据中心为外部提供的全部接口了。最后一个看起来有点奇怪，其他的从字面上应该都比较容易理解，容许许我一一分析。</p>
<h4 id="a-getState–返回当前状态"><a href="#a-getState–返回当前状态" class="headerlink" title="a. getState–返回当前状态"></a>a. getState–返回当前状态</h4><p>Redux的核心理念之一就是不支持直接修改状态，它是通过闭包来实现这一点。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export default function createStore(reducer, preloadedState, enhancer) &#123;</span><br><span class="line">  let currentState = preloadedState</span><br><span class="line"></span><br><span class="line">  function getState() &#123;</span><br><span class="line">    .....</span><br><span class="line">    return currentState</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>它先是定义了一个内部的变量<code>currentState</code>，然后通过一个名为<code>getState</code>的方法来返回它的值。这就造成了<code>currentState</code>这个状态对我们而言是只读的，我们没办法直接修改它的值。在代码里面我们可以通过<code>getState</code>这个方法来返回当前状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console.log(store.getState())</span><br></pre></td></tr></table></figure></p>
<h4 id="b-subscribe–构造监听者队列"><a href="#b-subscribe–构造监听者队列" class="headerlink" title="b. subscribe–构造监听者队列"></a>b. subscribe–构造监听者队列</h4><p>每个<code>store</code>本身会维护一个监听者队列，我们可以把它想象成一个方法的队列，在每次分发<code>action</code>的时候都会依次调用监听者队列中所有方法。通过这个<code>subscribe</code>方法可以手动地把一些回调函数添加到监听者队列中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">export default function createStore(reducer, preloadedState, enhancer) &#123;</span><br><span class="line">  ....</span><br><span class="line"></span><br><span class="line">  let currentListeners = []</span><br><span class="line">  let nextListeners = currentListeners</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  function ensureCanMutateNextListeners() &#123;</span><br><span class="line">    if (nextListeners === currentListeners) &#123;</span><br><span class="line">      nextListeners = currentListeners.slice()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  function subscribe(listener) &#123;</span><br><span class="line">    .....</span><br><span class="line"></span><br><span class="line">    let isSubscribed = true</span><br><span class="line"></span><br><span class="line">    ensureCanMutateNextListeners()</span><br><span class="line">    nextListeners.push(listener)</span><br><span class="line"></span><br><span class="line">    return function unsubscribe() &#123;</span><br><span class="line">      if (!isSubscribed) &#123;</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      ....</span><br><span class="line"></span><br><span class="line">      isSubscribed = false</span><br><span class="line"></span><br><span class="line">      ensureCanMutateNextListeners()</span><br><span class="line">      const index = nextListeners.indexOf(listener)</span><br><span class="line">      nextListeners.splice(index, 1)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>逻辑其实很简单，为了减少篇幅我把一些类型检查的代码去掉了。每次调用<code>subscribe</code>的时候传入一个回调函数，<code>subscribe</code>会把它放到一个监听者队列中去，并返回一个<code>unsubscribe</code>的方法。这个<code>unsubscribe</code>方法是让开发者可以方便地从列表中删除对应的回调函数，此外该方法还维护着一个<code>isSubscribed</code>标识订阅状态。</p>
<p>这里面有一个比较有意思的<code>ensureCanMutateNextListeners</code>的方法，按照代码的逻辑，它是要保证监听者的添加与删除并不在<code>currentListeners</code>这个原始的队列里面进行直接操作，我们操作的只是它的一个副本。直到我们调用<code>dispatch</code>方法进行分发的时候，<code>currentListeners</code>与<code>nextListeners</code>才会再一次指向同一个对象，这个在后面的代码里面会看到。</p>
<h4 id="c-dispatch–低调的action分发者"><a href="#c-dispatch–低调的action分发者" class="headerlink" title="c. dispatch–低调的action分发者"></a>c. dispatch–低调的action分发者</h4><p><code>dispatch</code>方法是用来分发<code>action</code>的，可以把它理解成用于触发数据更新的方法。它的核心实现也比较简单</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">export default function createStore(reducer, preloadedState, enhancer) &#123;</span><br><span class="line">  ...</span><br><span class="line">  function dispatch(action) &#123;</span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">    // 调用reducer</span><br><span class="line">    try &#123;</span><br><span class="line">      isDispatching = true</span><br><span class="line">      currentState = currentReducer(currentState, action)</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      isDispatching = false</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 调用监听者</span><br><span class="line">    const listeners = (currentListeners = nextListeners)</span><br><span class="line">    for (let i = 0; i &lt; listeners.length; i++) &#123;</span><br><span class="line">      const listener = listeners[i]</span><br><span class="line">      listener()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return action</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我依旧把一些类型检查的代码去掉，首先<code>dispatch</code>方法会以当前的状态<code>currentState</code>以及我们定义的动作<code>action</code>作为参数来调用当前的<code>reducer</code>方法。另外它使用<code>isDispatching</code>变量来记录分发的状态，正在分发则设置为<code>true</code>。这里需要注意的是我们的<code>reducer</code>方法将会被设置成一个<strong>纯函数</strong>–它不会产生副作用，并且对于同样的输入它会返回同样的输出。换句话说它不会直接在原来状态的基础上进行修改，而是会直接返回一个新的状态，并对原有状态进行替换。</p>
<p>完成了上面这些之后我们会依次遍历所有的监听者，并且手动调用所有的回调函数。这里需要注意的是之前有讲过的，订阅/取消订阅的时候我们会生成一个<code>currentLIsteners</code>的副本<code>nextListeners</code>并在它上面添加/删除回调函数。然而到了<code>dispatch</code>这一步他们会做一次同步，这样他们就又会指向同一个对象了。</p>
<h4 id="d-replaceReducer–替换当前的reducer"><a href="#d-replaceReducer–替换当前的reducer" class="headerlink" title="d. replaceReducer–替换当前的reducer"></a>d. replaceReducer–替换当前的reducer</h4><p><code>replaceReducer</code>这个方法做的事情其实很简单，它可以用新的<code>reducer</code>替换掉当前的<code>reducer</code>，并且分发一个替换的<code>action</code>，下面是源代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">export default function createStore(reducer, preloadedState, enhancer) &#123;</span><br><span class="line">  .....</span><br><span class="line">  function replaceReducer(nextReducer) &#123;</span><br><span class="line">    .....</span><br><span class="line"></span><br><span class="line">    currentReducer = nextReducer</span><br><span class="line">    dispatch(&#123; type: ActionTypes.REPLACE &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>据说这种方式在调试环境下会用得比较多。在正式环境下一般都不会在中途更替<code>reducer</code>，以免得增加维护成本。</p>
<h4 id="e-observable–观察者"><a href="#e-observable–观察者" class="headerlink" title="e. observable–观察者"></a>e. observable–观察者</h4><p>这个是比较让我费解的一个功能了，然而Redux的数据中心居然把它作为api开放出来，咱门先贴源码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">export default function createStore(reducer, preloadedState, enhancer) &#123;</span><br><span class="line">  ....</span><br><span class="line">  function observable() &#123;</span><br><span class="line">    const outerSubscribe = subscribe</span><br><span class="line">    return &#123;</span><br><span class="line">      ...</span><br><span class="line">      subscribe(observer) &#123;</span><br><span class="line">        ....</span><br><span class="line">        function observeState() &#123;</span><br><span class="line">          if (observer.next) &#123;</span><br><span class="line">            observer.next(getState())</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        observeState()</span><br><span class="line">        const unsubscribe = outerSubscribe(observeState)</span><br><span class="line">        return &#123; unsubscribe &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      [$$observable]() &#123;</span><br><span class="line">        return this</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果直接调用这个接口，它会返回一个对象，而对象里面包含了<code>subscribe</code>方法，并且我们可以把一个包含<code>next</code>字段(它是一个函数)的对象作为<code>subscribe</code>方法的参数，就可以在每次数据变动的时候以<strong>当前状态<code>getState()</code></strong>作为参数调用<code>next</code>所携带的函数。</p>
<p>这么说有点拗口，可能给个例子会比较直观</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import $$observable from &apos;symbol-observable&apos;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">const store = createStore(reducer)</span><br><span class="line"></span><br><span class="line">const subObject = store[$$observable]()</span><br><span class="line">subObject.subscribe(&#123;</span><br><span class="line">  next: (a) =&gt; &#123;</span><br><span class="line">    console.log(a)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这样就可以做到每次动作被分发的时候都会调用<code>next</code>所携带的方法，并打印出<code>getState()</code>的值。这种观察者模式的写法有什么特殊的意义我也还没有时间去深究，似乎是<a href="https://link.juejin.im?target=https%3A%2F%2Fgithub.com%2Ftc39%2Fproposal-observable" target="_blank" rel="noopener">草案</a>的一部分，估计目前用的也不多，先不深入探究了。</p>
<hr>
<h2 id="1-中间件"><a href="#1-中间件" class="headerlink" title="1. 中间件"></a>1. 中间件</h2><p><img src="/2018/11/05/Redux源码分析/1.jpg" alt=""><br>中间件这个概念存在于许多流行的Web框架中，可以把它想象成是请求/响应分发的中间层，用于对请求/响应做进一步的处理，而无需改变原有的代码逻辑。在<code>node.js</code>社区的<a href="https://link.juejin.im?target=https%3A%2F%2Fgithub.com%2Fkoajs%2Fkoa" target="_blank" rel="noopener">KOA</a>轻量级框架很出色地体现了这一点(当然它肯定不是第一个这样干的人)。koa本身只提供了最基础的请求/响应功能，如果想要更强大的功能(比如说日志，时间记录等功能)则需要自己添加相应的中间件。</p>
<p>Redux继承了这一理念，它把中间件应用到了<code>dispatch</code>方法的扩展中，让我们可以优雅地扩展<code>dispatch</code>方法，而不需要重写原有的<code>dispatch</code>方法，接下来我们好好体会一下它的精妙之处。</p>
<h2 id="2-中间件在Redux中的应用"><a href="#2-中间件在Redux中的应用" class="headerlink" title="2. 中间件在Redux中的应用"></a>2. 中间件在Redux中的应用</h2><p>在分析源码之前先来看看在Redux里面如何使用中间件，最关键的是<code>applyMiddleware</code>这个方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import &#123; createStore, applyMiddleware &#125; from &apos;redux&apos;</span><br><span class="line">// Add thunk</span><br><span class="line">import thunk from &apos;redux-thunk&apos;</span><br><span class="line">import logger from &apos;redux-logger&apos;</span><br><span class="line"></span><br><span class="line">const reducer = (state) =&gt; state</span><br><span class="line"></span><br><span class="line">let newCreateStore = applyMiddleware(</span><br><span class="line">  logger,</span><br><span class="line">  thunk</span><br><span class="line">)(createStore)</span><br><span class="line"></span><br><span class="line">// 创建store，数据中心</span><br><span class="line">let store = newCreateStore(reducer)</span><br></pre></td></tr></table></figure></p>
<p>其中<code>thunk</code>跟<code>logger</code>就是我们提到的中间件，依次把它们传入<code>applyMiddleware</code>函数中，就会返回一个新的函数，然后再用这个函数处理原始的<code>createStore</code>方法就会返回一个增强过的<code>createStore</code>方法。</p>
<p>另外，还记得<code>createStore</code>函数可以接收<code>enhancer</code>这个参数不？其实<code>applyMiddleware</code>这个方法经过调用后所得到的就是一个增强器。为此我们还可以这样调用<code>createStore</code>，并生成<code>store</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">....</span><br><span class="line">let enhancer = applyMiddleware(</span><br><span class="line">  logger,</span><br><span class="line">  thunk</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">let store = createStore(reducer, enhancer)</span><br></pre></td></tr></table></figure></p>
<p>这种做法跟前面的扩展效果是一样的。</p>
<h2 id="3-源码分析"><a href="#3-源码分析" class="headerlink" title="3. 源码分析"></a>3. 源码分析</h2><h3 id="1-中间件原理"><a href="#1-中间件原理" class="headerlink" title="1) 中间件原理"></a>1) 中间件原理</h3><p>在源码分析之前，先举个例子来看看一个简单的<code>中间件</code>内部应该是什么样子的，我分别定义<code>middleware1</code>，<code>middleware2</code>两个中间件(他们本质是高阶函数)，并用来扩展<code>originDispatch</code>函数</p>
<pre><code>let originDispatch = (...args) =&gt; {
  console.log(...args)
}

const middleware1 = (dispatch) =&gt; {
  return(...args) =&gt; {
    console.log(&apos;middleware1 before dispatch&apos;)
    dispatch(...args)
    console.log(&apos;middleware1 after dispatch&apos;)
  }
}

const middleware2 = (dispatch) =&gt; {
  return(...args) =&gt; {
    console.log(&apos;middleware2 before dispatch&apos;)
    dispatch(...args)
    console.log(&apos;middleware2 before dispatch&apos;)
  }
}

originDispatch = middleware2(middleware1(originDispatch))
originDispatch(&apos;ruby&apos;, &apos;cool&apos;, &apos;language&apos;)
</code></pre><p>结果如下</p>
<pre><code>middleware2 before dispatch
middleware1 before dispatch
ruby cool language
middleware1 after dispatch
middleware2 before dispatch
</code></pre><p>是不是运行过程是不是有点像洋葱？我们可以使用中间件来对原有的方法进行增强，并返回一个增强了的方法，然后再用另一个中间件来对这个已经增强过的方法再进一步增强，模型示意图如下<br><img src="/2018/11/05/Redux源码分析/164250984dffa839.webp" alt=""></p>
<h3 id="2-compose–方法封链辅助函数"><a href="#2-compose–方法封链辅助函数" class="headerlink" title="2) compose–方法封链辅助函数"></a>2) compose–方法封链辅助函数</h3><p>从上面的洋葱模型可以看出我们如果要增强一个方法，它的步骤如下</p>
<pre><code>newFunc = f1(f2(func))
</code></pre><p>可以简单地把<code>f1</code>,<code>f2</code>理解成我们需要各自定义的中间件函数，然而如果我们每次都要手动调用这些方法的话似乎并不太优雅，这个时候可以使用<a href="https://link.juejin.im?target=https%3A%2F%2Fgithub.com%2Freduxjs%2Fredux%2Fblob%2Fmaster%2Fsrc%2Fcompose.js" target="_blank" rel="noopener">compose</a>函数来完成这种事情。</p>
<p><code>compose</code>在中文里面是组合的意思，Redux所定义的<code>compose</code>函数可以把函数的参数列表构造成依次调用的形式，并返回一个新的函数。它的源码如下</p>
<pre><code>export default functioncompose(...funcs) {
  ...
  // 以上都是判断
  return funcs.reduce((a, b) =&gt; (...args) =&gt; a(b(...args)))
}
</code></pre><p>文字解释可能还不如流程图来得直观，下面简单地分析一下<code>compose(f1, f2, f3, f4)</code>的调用过程</p>
<pre><code>a: f1, b: f2, return: (...args) =&gt; f1(f2(...args))
a: (...args) =&gt; f1(f2(...args)), b: f3, return: (...args) =&gt; f1(f2(f3(...args)))
a: (...args) =&gt; f1(f2(f3(...args))), b: f4, return: (...args) =&gt; f1(f2(f3(f4(...args))))
</code></pre><p>把这个方法应用在最初的例子中</p>
<pre><code>&gt; newfunc = compose(middleware2, middleware1)(originDispatch)
[Function]
&gt; newfunc(&apos;node&apos;, &apos;good&apos;, &apos;languate&apos;)

middleware2 before dispatch
middleware1 before dispatch
node good languate
middleware1 after dispatch
middleware2 before dispatch
</code></pre><p>结果是一样的。而且从这个例子还可以看出在<code>compose</code>函数的参数列表中越靠后的函数，在构造完成之后，距离原始函数就越近。</p>
<h3 id="3-applyMiddleware–收集中间件，扩展createStore"><a href="#3-applyMiddleware–收集中间件，扩展createStore" class="headerlink" title="3) applyMiddleware–收集中间件，扩展createStore"></a>3) applyMiddleware–收集中间件，扩展createStore</h3><p>applyMiddleware.js这个文件里面就包含着它的源码</p>
<pre><code>export default function applyMiddleware(...middlewares) {
  return createStore =&gt; (...args) =&gt; {
    const store = createStore(...args)
    let dispatch = () =&gt; {
      throw new Error(
        `Dispatching while constructing your middleware is not allowed. ` +
          `Other middleware would not be applied to this dispatch.`
      )
    }

    const middlewareAPI = {
      getState: store.getState,
      dispatch: (...args) =&gt; dispatch(...args)
    }

    // #1 中间件应该接收store
    const chain = middlewares.map(middleware =&gt; middleware(middlewareAPI))

    // #2 返回的函数用于处理dispatch函数
    dispatch = compose(...chain)(store.dispatch)

    // #3 替换dispatchreturn {
      ...store,
      dispatch
    }
  }
}
</code></pre><p>代码片段<code>#2</code>中我们传入<code>compose</code>函数里的所有函数都是用于扩展<code>dispatch</code>的，这些函数会被定义为这种形式</p>
<pre><code>(dispatch) =&gt; {
  return function(...args) {
    // do something before
    dispatch(...args)
    // do something after
  }
}
</code></pre><p>这些函数会接收一个<code>dispatch</code>方法为参数，并返回一个增强的<code>dispatch</code>方法。然而我们需要编写的中间件却不仅如此，接下来再看看代码片段<code>#1</code>，以及相关的上下文逻辑</p>
<pre><code>export default function applyMiddleware(...middlewares) {
  ....
  const middlewareAPI = {
    getState: store.getState,
    dispatch: (...args) =&gt; dispatch(...args)
  }

  // #1 中间件应该接收store
  const chain = middlewares.map(middleware =&gt; middleware(middlewareAPI))

  // #2 返回的函数用于处理dispatch函数
  dispatch = compose(...chain)(store.dispatch)
  ...
}
</code></pre><p>我们通过<code>map</code>方法来处理<code>applyMiddleware</code>所接收的所有中间件，让他们分别以<code>middlewareAPI</code>这个对象作为参数调用过后会返回一个新的函数列表，而这个函数列表才是真正用来增强<code>dispatch</code>的。</p>
<p><code>middlewareAPI</code>是仅仅包含了<code>getState</code>与<code>dispatch</code>这两个字段的对象，可以把它看成是一个精简版的<code>store</code>。因此我们需要编写的中间件应该是以<code>store</code>作为参数，并且返回一个用于增强<code>dispatch</code>方法的函数，而这个<code>store</code>我们只能够使用<code>getState</code>，<code>dispatch</code>这两个接口。听起来有点拗口，下面我们自行编写一个用于打印状态日志的中间件。</p>
<pre><code>const Logger = (store) =&gt; (dispatch) =&gt; {
  return function(...args) {
    const wrappedDispatch = store.dispatch
    const getState = store.getState

    console.log(&apos;before dispatch&apos;, getState())
    dispatch(...args)
    console.log(&apos;after dispatch&apos;, getState())

    console.info(dispatch)
    console.info(wrappedDispatch)
  }
}
</code></pre><p>其中<code>dispatch</code>与<code>wrappedDispatch</code>所指代的分发方法是不一样的。</p>
<p><code>dispatch</code>是从参数中传入，如果当前中间件是第一个对<code>dispatch</code>方法进行增强的中间件，则当前的<code>dispatch</code>所指向的就是Redux原生定义的<code>dispatch</code>方法。如果当前中间件前面已经有若干中间件的调用，则当前<code>dispatch</code>所指代的是经过前面中间件加强过的新的<code>dispatch</code>方法。我们可以来验证一下</p>
<pre><code>let enhancer = applyMiddleware(
  Logger, // 我们自己编写的Logger
  thunk
)
</code></pre><p><code>dispatch</code>的打印结果如下</p>
<pre><code>ƒ(action) {
  if (typeof action === &apos;function&apos;) {
    return action(dispatch, getState, extraArgument);
  }

  return next(action);
}
</code></pre><p>可见，这是一个经过<code>thunk</code>中间件处理后返回的方法。</p>
<p><code>wrappedDispatch</code>因为匿名函数<code>(...args) =&gt; dispatch(...args)</code>的关系，在<code>applyMiddleware</code>函数运行完成并返回之后，匿名函数内部的<code>dispatch</code>会始终指向经过我们增强的<code>dispatch</code>方法。也就是说在中间件里面执行<code>store.dispatch</code>就会始终运行最外层的被增强过的<code>dispatch</code>方法。模型如下<br><img src="/2018/11/05/Redux源码分析/2.webp" alt=""><br><code>wrappedDispatch</code>打印结果虽然看不出什么，但我也顺手贴一下吧</p>
<pre><code>ƒ dispatch() {
  return _dispatch.apply(undefined, arguments);
}
</code></pre><p>接下来，我们看<code>applyMiddleware</code>的返回值，它会返回一个新的函数，该函数会以<code>createStore</code>作为参数，处理过后返回一个新的<code>createStore</code>方法，它的模式大概是这样子</p>
<pre><code>(createStore) =&gt; (...args) =&gt; {

  // createStore方法用来创建store
  return {
    ...
    getState: ...
    dispatch: ...
  }
}
</code></pre><p>而在<code>applyMiddleware</code>中实际上我们只需要增强<code>dispatch</code>方法，为此我们只需要用新的<code>dispatch</code>方法来替换原来的便可。代码片段<code>#3</code>就是用新的<code>dispatch</code>方法取代原来<code>store</code>中的<code>dispatch</code>方法。</p>
<pre><code>....
    return {
      ...store,
      dispatch
    }
....
</code></pre><hr>
<h2 id="1-模块化reducer"><a href="#1-模块化reducer" class="headerlink" title="1. 模块化reducer"></a>1. 模块化reducer</h2><p>我们写代码的时候也有这种情况<strong>当一个文件包含的代码太多的时候我们会考虑按逻辑把它们拆分成几个模块，而当我们遇到一些细粒度同类模块的集合时，则会考虑把他们汇总为一个的模块。</strong>至于什么时候该拆，什么时候该合，可能不同的领域自有它的权衡方式。</p>
<p>今天主要谈谈Redux里面如何模块化管理多个reducer函数。在Redux应用里reducer函数可以理解成一个处理状态的函数，它接受一个状态，以及一个动作，处理之后返回一个更新后的状态。一个简单的reducer函数大概如下</p>
<pre><code>function reducerExample(state={}, action) {
  switch (action.type) {
    case&apos;INCREMENT&apos;:
      return Object.assign({}, state, {counter: state.counter + 1})
    case&apos;DECREMENT&apos;:
      return Object.assign({}, state, {counter: state.counter - 1})
    default:
      return state
  }
}
</code></pre><p>然而这个函数所包含的逻辑仅仅是对状态的<code>counter</code>字段进行加一以及减一操作。Redux是数据中心，它所管理的状态可能会包含很多个字段，当字段相当多的时候，我们需要在<code>reducerExample</code>函数中定义的操作也会渐渐多起来</p>
<pre><code>function reducerExample(state={}, action) {
  switch (action.type) {
    case&apos;INCREMENT&apos;:
      return Object.assign({}, state, {counter: state.counter + 1})
    case&apos;DECREMENT&apos;:
      return Object.assign({}, state, {counter: state.counter - 1})
    case&apos;MULTI&apos;:
      return Object.assign({}, state, {otherCounter: state.otherCounter * 2})
    ....
    // 此处省略100行代码
    ....
    default:
      return state
  }
}
</code></pre><p>随着状态越来越多，操作函数也将会越来越复杂，单一的reducer函数并非长久之计。这也是Redux为何提供<code>combineReducers</code>的原因，它使得我们可以以模块的方式来管理多个reducer函数。</p>
<p>简单讲解该函数的使用，假设Redux管理的应用状态如下</p>
<pre><code>{
  counter: 0,
  article: {
    title: &quot;&quot;,
    content: &quot;&quot;
  }
}
</code></pre><p>则我们可以分别定义两个reducer函数<code>counterReducer</code>与<code>articleReducer</code></p>
<pre><code>function counterReducer(counter=0, action) {
  ...
}


function articleReducer(article={}, action) {
  ...
}
</code></pre><p>在<code>counterReducer</code>里面只定义与<code>counter</code>字段有关的数据操作，而在<code>articleReducer</code>里面只定义与<code>article</code>字段有关的数据操作，最后通过<code>combineReducers</code>来合并两个reducer函数，并生成新的函数<code>reducer</code>，我们只需要把这个新的函数<code>reducer</code>与系统进行集成即可。</p>
<pre><code>const reducer = combineReducers({
  counter: counterReducer,
  article: articleReducer
})
</code></pre><p>我们甚至可以把<code>counterReducer</code>与<code>articleReducer</code>两个函数放在不同的文件中，然后在同一个地方汇总(通过<code>combineReducers</code>)。当我们分发指定的动作之后只有定义了该动作的函数会改变它所对应字段的状态信息。</p>
<h2 id="2-源码分析"><a href="#2-源码分析" class="headerlink" title="2. 源码分析"></a>2. 源码分析</h2><p>接下来分析一下<code>combineReducers</code>函数的工作原理。<a href="https://link.juejin.im?target=https%3A%2F%2Fgithub.com%2Freduxjs%2Fredux%2Fblob%2Fmaster%2Fsrc%2FcombineReducers.js" target="_blank" rel="noopener">combineReducers.js</a>这个文件代码加注释大概100多行，然而我们真正需要了解的核心就仅仅是该脚本中需要导出的<code>combineReducers</code>这个函数，其他代码大多是用于断言，暂且略过不谈。</p>
<h3 id="1-收集reducers"><a href="#1-收集reducers" class="headerlink" title="1) 收集reducers"></a>1) 收集reducers</h3><p>我们都知道函数接收对象的每个键所对应的值都应该是一个可以用于改变状态的reducer函数，为此我们会先遍历<code>combineReducers</code>函数所接收的对象，排除其中不是函数的字段。</p>
<pre><code>export default function combineReducers(reducers) {
  const reducerKeys = Object.keys(reducers)
  const finalReducers = {}
  for (let i = 0; i &lt; reducerKeys.length; i++) { // #1
    const key = reducerKeys[i]

    ....

    if (typeof reducers[key] === &apos;function&apos;) { // #2
      finalReducers[key] = reducers[key]
    }
  }

  ......
}
</code></pre><p>代码片段<code>#1</code>遍历函数接收的对象的所有键，代码片段<code>#2</code>判断该键在原对象中指向的内容是否是一个函数。如果是函数的话，则把该函数以同样的键存储到<code>finalReducers</code>这个对象中，等循环结束以后<code>finalReducers</code>对象的每一个键所对应的值则都是一个函数了。</p>
<h3 id="2-返回一个新的reducer函数"><a href="#2-返回一个新的reducer函数" class="headerlink" title="2) 返回一个新的reducer函数"></a>2) 返回一个新的reducer函数</h3><p><code>combineReducers</code>其实是一个reducer函数的工厂，在收集不同模块的reducer函数之后，它的责任就是返回一个新的reducer，而这个新的reducer函数能够调度先前收集的所有reducer。我把后续源码中的断言都去掉之后就剩下下列代码</p>
<pre><code>export default function combineReducers(reducers) {
  ...

  const finalReducerKeys = Object.keys(finalReducers) // # 1
    return function combination(state = {}, action) {
    .....

    let hasChanged = false
    const nextState = {}
    for (let i = 0; i &lt; finalReducerKeys.length; i++) {
      const key = finalReducerKeys[i]
      const reducer = finalReducers[key] // #2
      const previousStateForKey = state[key] // #3
      const nextStateForKey = reducer(previousStateForKey, action) // #4
      ....
      nextState[key] = nextStateForKey
      hasChanged = hasChanged || nextStateForKey !== previousStateForKey
    }
    return hasChanged ? nextState : state
  }
}
</code></pre><p>首先会在代码片段<code>#1</code>获取先前过滤好的<code>finalReducers</code>对象的所有键，并存储到<code>finalReducerKeys</code>中。然后当前函数会返回一个新的reducer函数，这个函数能够访问<code>finalReducers</code>形成一个闭包。</p>
<p>当调用这个新的reducer函数的时，它会遍历<code>finalReducerKeys</code>这个数组中的每一个键，在代码<code>#2</code>处获取当前键所对应的reducer函数并存储到常量<code>reducer</code>，然后在代码<code>#3</code>处获取当前键所对应的状态<code>previousStateForKey</code>。</p>
<p>接下来在代码<code>#4</code>处以当前状态<code>previousStateForKey</code>以及<code>action</code>作为参数来调用<code>reducer</code>函数，返回该键所对应的新状态<code>nextStateForKey</code>。在每次迭代中都会把当前键<code>key</code>作为字段，把新的状态存储到<code>nextState</code>这个对象中去，循环结束之后，我们就能够保证<code>action</code>被充分调度了。</p>
<p>另外，还记得咱门编写reducer函数的时候会经常使用这种语法吗？</p>
<pre><code>Object.assign({}, state, {counter: state.counter + 1})
</code></pre><p>这表明了我们不会在原来的<code>state</code>基础上进行修改操作，而是生成了一个新的<code>state</code>，原理大概如下</p>
<pre><code>&gt; a = {}
{}
&gt; b = Object.assign(a, {counter: 1})
{ counter: 1 }
&gt; c = Object.assign({}, a, {counter: 1})
{ counter: 1 }
&gt; a === b
true
&gt; a === c
false
</code></pre><p>而在Redux中，正常情况下如果reducer方法被调用后并没有产生新的对象，而只是在原有的对象中进行操作的话，则在绑定组件的时候，状态的修改将有可能不会引起组件的更新。reducer函数的定位是纯函数，不应该造成任何副作用，为此，reducer函数都应该要生成新的对象。</p>
<p>在<code>combineReducers</code>这个函数里也会有相应的处理，这里需要着重关注<code>hasChanged</code>这个变量</p>
<pre><code>...
  return hasChanged ? nextState : state
...
</code></pre><p>当且仅当，这个变量为真值的时候我们才会返回新的状态，不然的话依旧返回原有的状态。这个<code>hasChanged</code>是由以下代码控制的</p>
<pre><code>...
for (let i = 0; i &lt; finalReducerKeys.length; i++) {
  ....
  hasChanged = hasChanged || nextStateForKey !== previousStateForKey
}
</code></pre><p>也就是说在所有的迭代中至少有一次迭代符合<code>nextStateForKey !== previousStateForKey</code>这个条件的时候(所对应的reducer返回了新的对象)<code>hasChanged</code>才会为真，新的reducer函数才会返回新的状态对象<code>nextState</code>。否则将返回原有的状态对象<code>state</code>，这样在绑定React组件的时候则有可能会出现状态数据更新了，组件却没有响应的情况。</p>
<h2 id="为什么Redux-需要-reducers是纯函数？"><a href="#为什么Redux-需要-reducers是纯函数？" class="headerlink" title="为什么Redux 需要 reducers是纯函数？"></a><a href="http://localhost:4000/2018/07/31/%E4%B8%BA%E4%BB%80%E4%B9%88Redux-%E9%9C%80%E8%A6%81-reducers%E6%98%AF%E7%BA%AF%E5%87%BD%E6%95%B0%EF%BC%9F/" target="_blank" rel="noopener">为什么Redux 需要 reducers是纯函数？</a></h2><h2 id="1-ActionCreator创建动作"><a href="#1-ActionCreator创建动作" class="headerlink" title="1. ActionCreator创建动作"></a>1. ActionCreator创建动作</h2><p>在深入分析源码之前我们先来聊聊<code>ActionCreator</code>。从字面上理解，它是一个动作的创造者，或者说是动作的工厂。如果我们想根据不同的参数来生成不同步长的计数器动作，则可以把工厂函数声明为</p>
<pre><code>const counterIncActionCreator = function(step) {
  return {
    type: &apos;INCREMENT&apos;,
    step: step || 1
  }
}
</code></pre><p>随着业务逻辑越来越复杂，我们可以通过定义更加复杂的工厂函数来生成更多样化的动作类型。</p>
<h2 id="2-bindActionCreator高阶函数"><a href="#2-bindActionCreator高阶函数" class="headerlink" title="2. bindActionCreator高阶函数"></a>2. bindActionCreator高阶函数</h2><p>从上述的例子出发，如果我们想生产出不同步长的计数器动作，并分发他们，则需要把代码写成下面这样子</p>
<pre><code>// 为了简化代码我把dispatch函数定义为只有打印功能的函数
const dispatch = function(action) {
  console.log(action)
}

const action1 = counterIncActionCreator()
dispatch(action1) // { type: &apos;INCREMENT&apos;, step: 1 }

const action2 = counterIncActionCreator(2)
dispatch(action2) // { type: &apos;INCREMENT&apos;, step: 2 }

const action3 = counterIncActionCreator(3)
dispatch(action3) // { type: &apos;INCREMENT&apos;, step: 3 }
</code></pre><p>可见每次分发动作之前我们都得手动调用<code>counterIncActionCreator</code>来生产相应的动作，这种方式并不是那么的优雅。这个时候我们就可以采用<a href="https://link.juejin.im?target=https%3A%2F%2Fgithub.com%2Freduxjs%2Fredux%2Fblob%2Fmaster%2Fsrc%2FbindActionCreators.js" target="_blank" rel="noopener">bindActionCreators</a>这个文件里面的<code>bindActionCreator</code>工具函数来优化代码了，该函数的源码如下</p>
<pre><code>function bindActionCreator(actionCreator, dispatch) {
  return function() {
    return dispatch(actionCreator.apply(this, arguments))
  }
}
</code></pre><p><code>bindActionCreator</code>将会返回一个新函数，这个函数会用自身所接收的参数来调用<code>actionCreator</code>并生成对应动作，并且这个生成的动作将会作为<code>dispatch</code>函数的参数。也就是说我们把</p>
<ol>
<li>生成动作</li>
<li>调度动作</li>
</ol>
<p>这两个步骤都封装到一个函数里面了，于是便得到了更为优雅的调度过程</p>
<pre><code>...
const increment = bindActionCreator(counterIncActionCreator, dispatch)

increment() // { type: &apos;INCREMENT&apos;, step: 1 }

increment(2) // { type: &apos;INCREMENT&apos;, step: 2 }

increment(3) // { type: &apos;INCREMENT&apos;, step: 3 }
</code></pre><h2 id="3-bindActionCreators"><a href="#3-bindActionCreators" class="headerlink" title="3. bindActionCreators"></a>3. bindActionCreators</h2><p>接下来看看<code>bindActionCreators</code>这个函数，它是<code>bindActionCreator</code>函数的加强版。删掉一些断言语句之后源码如下</p>
<pre><code>export default functionbindActionCreators(actionCreators, dispatch) {
  if (typeof actionCreators === &apos;function&apos;) { // #1
     return bindActionCreator(actionCreators, dispatch) // #2
  }

  ....

  const keys = Object.keys(actionCreators)
  const boundActionCreators = {}
  for (let i = 0; i &lt; keys.length; i++) {
    const key = keys[i]
    const actionCreator = actionCreators[key]
    if (typeof actionCreator === &apos;function&apos;) { // #3
      boundActionCreators[key] = bindActionCreator(actionCreator, dispatch)
    }
  }
  return boundActionCreators
}
</code></pre><p>代码<code>#1</code>的判断语句是为了做兼容处理，当接收的参数<code>actionCreators</code>为一个函数的时候，则认为它是单一的动作工厂，便在代码<code>#2</code>处直接调用<code>bindActionCreator</code>工具函数来封装调度过程。</p>
<p>另一情况是当<code>actionCreators</code>参数是一个对象的时候，则遍历这个对象。代码<code>#3</code>会判断每个键在原始对象中的值是否是个函数，如果是一个函数则认为它是一个动作工厂，并使用<code>bindActionCreator</code>函数来封装调度过程，最后把生成的新函数以同样的键<code>key</code>存储到<code>boundActionCreators</code>对象中。在函数的末尾会返回<code>boundActionCreators</code>对象。</p>
<p>举个简单应用例子，首先使用一个对象来存储两个事件工厂</p>
<pre><code>const MyActionCreators = {
  increment: function(step) {
    return {
      type: &apos;INCREMENT&apos;,
      step: step || 1
    }
  },

  decrement: function(step) {
    return {
      type: &apos;DECREMENT&apos;,
      step: - (step || 1)
    }
  }
}
</code></pre><p>然后通过<code>bindActionCreators</code>来封装调度过程，并返回一个新的对象</p>
<pre><code>const dispatch = function(action) {
  console.log(action)
}

const MyNewActionCreators = bindActionCreators(MyActionCreators, dispatch)
</code></pre><p>最后我们便可以用新的对象来主导调度过程了</p>
<pre><code>MyNewActionCreators.increment() // { type: &apos;INCREMENT&apos;, step: 1 }
MyNewActionCreators.increment(2) // { type: &apos;INCREMENT&apos;, step: 2 }
MyNewActionCreators.increment(3) // { type: &apos;INCREMENT&apos;, step: 3 }
MyNewActionCreators.decrement() // { type: &apos;DECREMENT&apos;, step: -1 }
MyNewActionCreators.decrement(2) // { type: &apos;DECREMENT&apos;, step: -2 }
MyNewActionCreators.decrement(3) // { type: &apos;DECREMENT&apos;, step: -3 }
</code></pre><p>这种调度方式显然比原始的依次调用的方式更为优雅</p>
<pre><code>// 原始的调度方式
dispatch(MyActionCreators.increment()) // { type: &apos;INCREMENT&apos;, step: 1 }
dispatch(MyActionCreators.increment(2)) // { type: &apos;INCREMENT&apos;, step: 2 }
dispatch(MyActionCreators.increment(3)) // { type: &apos;INCREMENT&apos;, step: 3 }
dispatch(MyActionCreators.decrement()) // { type: &apos;DECREMENT&apos;, step: -1 }
dispatch(MyActionCreators.decrement(2)) // { type: &apos;DECREMENT&apos;, step: -2 }
dispatch(MyActionCreators.decrement(3)) // { type: &apos;DECREMENT&apos;, step: -3 }
</code></pre><hr>
<h2 id="重点说说redux-middleware"><a href="#重点说说redux-middleware" class="headerlink" title="重点说说redux middleware"></a>重点说说redux middleware</h2><h3 id="middleware-的由来"><a href="#middleware-的由来" class="headerlink" title="middleware 的由来"></a>middleware 的由来</h3><p>在业务中需要打印每一个 action 信息来调试，又或者希望 dispatch 或 reducer 拥有异步请求的功能。面对这些场景时，一个个修改 dispatch 或 reducer 代码有些乏力，我们需要一个可组合的、自由增减的插件机制，Redux 借鉴了 Koa 中 middleware 的思想，利用它我们可以在前端应用中便捷地实现如日志打印、异步请求等功能。<br><img src="/2018/11/05/Redux源码分析/3.webp" alt=""></p>
<p>比如在项目中，进行了如下调用后，redux 就集成了 thunk 函数调用以及打印日志的功能。</p>
<pre><code>import thunk from&apos;redux-thunk&apos;
import logger from&apos;../middleware/logger&apos;
const enhancer = applyMiddleware(thunk, logger),  // 以 redux-thunk、logger 中间件为例介绍中间件的使用
const store = createStore(rootReducer, enhancer)
</code></pre><p>下面追本溯源，来分析下源码。</p>
<h3 id="applyMiddleware-调用入口"><a href="#applyMiddleware-调用入口" class="headerlink" title="applyMiddleware 调用入口"></a>applyMiddleware 调用入口</h3><pre><code>export default function createStore(reducer, preloadedState, enhancer) {
  // 通过下面代码可以发现，如果 createStore 传入 2 个参数，第二个参数相当于就是 enhancer
  if (typeof preloadedState === &apos;function&apos; &amp;&amp; typeof enhancer === &apos;undefined&apos;) {
    enhancer = preloadedState
    preloadedState = undefined
  }
  if (typeof enhancer !== &apos;undefined&apos;) {
    return enhancer(createStore)(reducer, preloadedState)
  }
  ...
}
</code></pre><p>由上述 createStore 发现，applyMiddleware 会进行 <code>applyMiddleware(thunk, logger)(createStore)(reducer, preloadedState)</code> 的调用。</p>
<p>applyMiddleware 源码  如下</p>
<pre><code>export default function applyMiddleware(...middlewares) {
  return createStore =&gt; (...args) =&gt; {
    const store = createStore(...args)
    let dispatch = store.dispatch
    let chain = []

    const middlewareAPI = {
      getState: store.getState,                // 调用 redux 原生方法，获取状态
      dispatch: (...args) =&gt; dispatch(...args) // 调用 redux 原生 dispatch 方法
    }
    // 串行 middleware
    chain = middlewares.map(middleware =&gt; middleware(middlewareAPI))
    dispatch = compose(...chain)(store.dispatch)

    return {
      ...store,
      dispatch // 返回加工过的 dispatch
    }
  }
}
</code></pre><p>可以发现 applyMiddleware 的作用其实就是返回加工过的 dispatch，下面会着重分析 middlewares 是如何串行起来的以及 dispatch 是如何被加工的。</p>
<h3 id="串行-middleware"><a href="#串行-middleware" class="headerlink" title="串行 middleware"></a>串行 middleware</h3><pre><code>const middlewareAPI = {
  getState: store.getState,
  dispatch: (...args) =&gt; dispatch(...args)
}
chain = middlewares.map(middleware =&gt; middleware(middlewareAPI))
dispatch = compose(...chain)(store.dispatch)
</code></pre><p>观察上述代码后发现每个 middleware 都会传入参数 middlewareAPI，来看下中间件 <a href="https://link.juejin.im?target=https%3A%2F%2Fgithub.com%2FMuYunyun%2FreactSPA%2Fblob%2F274c00870853638fb0f77df8497f911eb560b617%2Fsrc%2Fclient%2Fmiddleware%2Flogger.js%23L1" target="_blank" rel="noopener">logger 的源码</a> 以及 <a href="https://link.juejin.im?target=https%3A%2F%2Fgithub.com%2Fgaearon%2Fredux-thunk%2Fblob%2Fmaster%2Fsrc%2Findex.js" target="_blank" rel="noopener">redux-thunk 的源码</a>, 发现中间件接受的第一个参数正是 ({ dispatch, getState })</p>
<pre><code>// logger 源码
export default ({ dispatch, getState }) =&gt; next =&gt; action =&gt; {
  console.log(action)
  return next(action) // 经 compose 源码分析，此处 next 为 Store.dispatch
}


// redux-thunk 源码
export default ({ dispatch, getState }) =&gt; next =&gt; action =&gt; {
  if (typeof action === &apos;function&apos;) {
    return action(dispatch,getState);
  }
  //这里可以理解为dispatch(action),本质上就是调用 middleware 链中下一个 middleware 的 dispatch。
  return next(action) // 此处 next 为 logger 中间件返回的 (action） =&gt; {} 函数
}

//使用redux-thunk
const store = createStore(  
  reducer,
  applyMiddleware(thunk)
);

//然后我们实现一个thunkActionCreator
//过一秒加1
export function thunkActionCreator(payload){
    return function(dispatch,getState){
        setTimeout(function(){
            dispatch({type:types.INCREMENT,payload:payload});
        },1000);
    }
},

//最后，在组件中dispatch thunk
this.dispatch(thunkActionCreator(payload));


DEMO:
export const getNav = () =&gt; async (dispatch, getState) =&gt; {
    try {
        let response = await instance.get(`book/navigation`)
        await dispatch(receiveNav(response.data))
    } catch (error) {
        console.log(&apos;error: &apos;, error)
    }
  }
</code></pre><h3 id="dispatch-是如何被加工的"><a href="#dispatch-是如何被加工的" class="headerlink" title="dispatch 是如何被加工的"></a>dispatch 是如何被加工的</h3><p>接着上个小节，在 <code>dispatch = compose(...chain)(store.dispatch)</code> 中发现了 compose 函数，来看下 compose 的源码 </p>
<pre><code>export default function compose(...funcs) {
  // ...
  return funcs.reduce((a, b) =&gt; (...args) =&gt; a(b(...args)))
}
</code></pre><p>compose 源码中的 <code>funcs.reduce((a, b) =&gt; (...args) =&gt; a(b(...args)))</code> 算是比较重要的一句，它的作用是返回组合参数后的函数，比如 compose(f, g, h) 等价于 (…args) =&gt; f(g(h(…args)))，效果图如下所示，调用 this.props.dispatch() 后，会调用相应的中间件，最终会调用 redux 原生的 store.dispatch()，并且可以看到中间件调用的形式类似数据结构中的栈(先进后出)。<br><img src="/2018/11/05/Redux源码分析/4.webp" alt=""><br>拿上个小节提到的 logger、redux-thunk 中间件为例，其 middleware 的内部串行调用方式如下，从而完成了 dispatch 功能的增强(支持如 <code>this.props.dispatch(func)</code> 的调用以及日志功能)。具体可以看 <a href="https://link.juejin.im?target=https%3A%2F%2Fgithub.com%2FMuYunyun%2FreactSPA%2Fblob%2F274c00870853638fb0f77df8497f911eb560b617%2Fsrc%2Fcommon%2Fpages%2Fmusic%2Findex.js%23L35" target="_blank" rel="noopener">项目中的运用</a></p>
<pre><code>action =&gt; {
  if (typeof action === &apos;function&apos;) {
    return action(dispatch)
  }
  return (action =&gt; {
    console.log(action)
    return store.dispatch(action)
  })(action)
}
</code></pre><h3 id="redux-promise"><a href="#redux-promise" class="headerlink" title="redux-promise"></a>redux-promise</h3><p>redux-promise也是延迟执行的表达式，它是解决异步的另外一种方案。</p>
<p>redux-thunk和核心思想是把action变成thunk，而redux-promise的核心思想是让action返回一个promise对象。</p>
<p>这个中间件使得store.dispatch方法可以接收Promise对象作为参数。这时 ，action 有两种写法:</p>
<p>写法一、返回值是一个Promise对象。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function promiseIncrement(payload)&#123;</span><br><span class="line"> //  return &#123;type:types.INCREMENT,payload:payload&#125;  以前是这种写法</span><br><span class="line">    return new Promise(function(resolve,reject)&#123;</span><br><span class="line">      setTimeout(function()&#123;</span><br><span class="line">        resolve(&#123;type:types.INCREMENT,payload:payload&#125;);</span><br><span class="line">      &#125;,1000);</span><br><span class="line">    &#125;);</span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure></p>
<p>写法二，action 对象的payload属性是一个Promise对象，这需要从<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">function payloadIncrement()&#123;</span><br><span class="line">    return &#123;</span><br><span class="line">        type:types.INCREMENT,</span><br><span class="line">        payload: new Promise(function(resolve,reject)&#123;</span><br><span class="line">            setTimeout(function()&#123;</span><br><span class="line">                if(Math.random()&gt;.5)&#123;</span><br><span class="line">                    resolve(100);</span><br><span class="line">                &#125;else&#123;</span><br><span class="line">                    reject(-100);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,1000)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面我们来看看 redux-promise是怎么实现的，就会明白它内部是怎么操作的.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">let promise = (&#123;dispatch,getState&#125;)=&gt;next=&gt;action=&gt;&#123;</span><br><span class="line">    if(action.then &amp;&amp; typeof action.then == &apos;function&apos;)&#123;</span><br><span class="line">        action.then(dispatch);</span><br><span class="line">        // 这里的dispatch就是一个函数，dispatch(action)&#123;state:reducer(state,action)&#125;;</span><br><span class="line">    &#125;else if(action.payload&amp;&amp; action.payload.then&amp;&amp; typeof action.payload.then == &apos;function&apos;)&#123;</span><br><span class="line">        action.payload.then(payload=&gt;dispatch(&#123;...action,payload&#125;),payload=&gt;dispatch(&#123;...action,payload&#125;));</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        next(action);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的代码可以看出，如果Action本身就是一个Promise，它resolve以后的值应该是一个Action对象，会被dispatch方法送出action.then(dispatch)；如果Action对象的 payload属性是一个Promise对象，那么无论resolve和reject,dispatch 方法都会发出Action。</p>
<h2 id="理解-funcs-reduce-a-b-gt-args-gt-a-b-args"><a href="#理解-funcs-reduce-a-b-gt-args-gt-a-b-args" class="headerlink" title="理解 funcs.reduce((a, b) =&gt; (args) =&gt; a(b(args)))"></a>理解 funcs.reduce((a, b) =&gt; (args) =&gt; a(b(args)))</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">		&lt;title&gt;&lt;/title&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">			function originDispatch(...args) &#123;</span><br><span class="line">				console.log(...args)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			function middleware1(dispatch) &#123;</span><br><span class="line">				return (...args) =&gt; &#123;</span><br><span class="line">					console.log(&apos;middleware1 before dispatch&apos;)</span><br><span class="line">					dispatch(...args)</span><br><span class="line">					console.log(&apos;middleware1 after dispatch&apos;)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			function middleware2(dispatch) &#123;</span><br><span class="line">				return (...args) =&gt; &#123;</span><br><span class="line">					console.log(&apos;middleware2 before dispatch&apos;)</span><br><span class="line">					dispatch(...args)</span><br><span class="line">					console.log(&apos;middleware2 after dispatch&apos;)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			function middleware3(dispatch) &#123;</span><br><span class="line">				return (...args) =&gt; &#123;</span><br><span class="line">					console.log(&apos;middleware3 before dispatch&apos;)</span><br><span class="line">					dispatch(...args)</span><br><span class="line">					console.log(&apos;middleware3 after dispatch&apos;)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			//			originDispatch = middleware2(middleware1(originDispatch))</span><br><span class="line">			//			originDispatch(&apos;redux&apos;, &apos;is&apos;, &apos;cool&apos;);</span><br><span class="line"></span><br><span class="line">			function compose(...funcs) &#123;</span><br><span class="line">				return funcs.reduce((a, b) =&gt; (args) =&gt; a(b(args)))</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">            //console.log(compose(middleware2, middleware1))</span><br><span class="line">               //(args) =&gt; middleware2(middleware1(args))  </span><br><span class="line">               //(originDispatch)=&gt;middleware2(middleware1(originDispatch))  </span><br><span class="line">               </span><br><span class="line">			compose(middleware2, middleware1)(originDispatch)(&apos;redux&apos;, &apos;is&apos;, &apos;cool&apos;);</span><br><span class="line">			</span><br><span class="line">		&lt;/script&gt;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>compose(middleware2, middleware1)</code>返回<code>(args) =&gt; middleware2(middleware1(args))</code>;</li>
<li><code>compose(middleware2, middleware1)(originDispatch)</code> 返回<code>middleware2(middleware1(originDispatch))</code></li>
<li>将<code>middleware1(originDispatch)</code>当做一个整体,<code>middleware2(middleware1(originDispatch))</code>中的<code>middleware2</code>返回一个函数，等着接受<code>...args</code>;当<code>compose(middleware2, middleware1)(originDispatch)(&#39;redux&#39;, &#39;is&#39;, &#39;cool&#39;)</code>,<code>...args</code>为<code>(&#39;redux&#39;, &#39;is&#39;, &#39;cool&#39;)</code>。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/02/JWT入门与实战/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="武动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/02/JWT入门与实战/" itemprop="url">JWT入门与实战</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-02T22:38:10+08:00">
                2018-11-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前面的话"><a href="#前面的话" class="headerlink" title="前面的话"></a>前面的话</h3><p>实现用户登录认证的方式常见的有两种：一种是基于 cookie 的认证，另外一种是基于 token 的认证 。本文以基于cookie的认证为参照，详细介绍JWT标准，并实现基于该标签的用户认证接口</p>
<h4 id="cookie认证"><a href="#cookie认证" class="headerlink" title="cookie认证"></a>cookie认证</h4><blockquote>
<p>传统的基于 cookie 的认证方式基本有下面几个步骤：</p>
</blockquote>
<p>　　1、用户输入用户名和密码，发送给服务器</p>
<p>　　2、服务器验证用户名和密码，正确的话就创建一个会话（ session ），同时会把这个会话的 ID 保存到客户端浏览器中，因为保存的地方是浏览器的 cookie ，所以这种认证方式叫做基于 cookie 的认证方式</p>
<p>　　3、后续的请求中，浏览器会发送会话 ID 到服务器，服务器上如果能找到对应 ID 的会话，那么服务器就会返回需要的数据给浏览器</p>
<p>　　4、当用户退出登录，会话会同时在客户端和服务器端被销毁</p>
<blockquote>
<p>这种认证方式的不足之处有两点</p>
</blockquote>
<p>　　1、服务器端要为每个用户保留 session信息，连接用户多了，服务器内存压力巨大</p>
<p>　　2、适合单一域名，不适合第三方请求cookie认证的后端典型代码如下所示:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</span><br><span class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>)</span><br><span class="line"><span class="keyword">const</span> pug = <span class="built_in">require</span>(<span class="string">'pug'</span>);</span><br><span class="line"></span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'pug'</span>);</span><br><span class="line"></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">  secret: <span class="string">'keyboard cat'</span>,</span><br><span class="line">  resave: <span class="literal">false</span>,</span><br><span class="line">  saveUninitialized: <span class="literal">true</span></span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> currentUser = req.session.username;</span><br><span class="line">  res.render(<span class="string">'index'</span>, &#123;currentUser&#125;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">  res.sendFile(<span class="string">'login.html'</span>, &#123;<span class="attr">root</span>: <span class="string">'public'</span>&#125;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> username = req.body.username;</span><br><span class="line">  req.session.username = username;</span><br><span class="line">  res.redirect(<span class="string">'/'</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/logout'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">  req.session.destroy();</span><br><span class="line">  res.redirect(<span class="string">'/'</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3006</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'running on port 3006...'</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h4 id="token认证"><a href="#token认证" class="headerlink" title="token认证"></a>token认证</h4><p>下面来介绍token认证。详细认证过程如下</p>
<p>　　1、用户输入用户名密码，发送给服务器</p>
<p>　　2、服务器验证用户名和密码，正确的话就返回一个签名过的 token（ token 可以认为就是个长长的字符串），客户端浏览器拿到这个 token</p>
<p>　　3、后续每次请求中，浏览器会把 token 作为 http header 发送给服务器，服务器可以验证一下签名是否有效，如果有效那么认证就成功了，可以返回客户端需要的数据</p>
<p>　　4、一旦用户退出登录，只需要客户端销毁一下 token 即可，服务器端不需要有任何操作</p>
<p>　　这种方式的特点就是客户端的 token 中自己保留有大量信息，服务器没有存储这些信息，而只负责验证，不必进行数据库查询，执行效率大大提高.
　　</p>
<h4 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h4><ul>
<li>传统的 session 流程<ul>
<li>浏览器发起请求登陆</li>
<li>服务端验证身份，生成身份验证信息，存储在服务端，并且告诉浏览器写入 Cookie</li>
<li>浏览器发起请求获取用户资料，此时 Cookie 内容也跟随这发送到服务器</li>
<li>服务器发现 Cookie 中有身份信息，验明正身</li>
<li>服务器返回该用户的用户资料</li>
</ul>
</li>
<li><p>JWT 流程</p>
<ul>
<li>浏览器发起请求登陆</li>
<li>服务端验证身份，根据算法，将用户标识符打包生成 token, 并且返回给浏览器</li>
<li>浏览器发起请求获取用户资料，把刚刚拿到的 token 一起发送给服务器</li>
<li>服务器发现数据中有 token，验明正身</li>
<li>服务器返回该用户的用户资料</li>
</ul>
</li>
<li><p>session 存储在服务端占用服务器资源，而 JWT 存储在客户端</p>
</li>
<li>session 存储在 Cookie 中，存在伪造跨站请求伪造攻击的风险</li>
<li>session 只存在一台服务器上，那么下次请求就必须请求这台服务器，不利于分布式应用</li>
<li>存储在客户端的 JWT 比存储在服务端的 session 更具有扩展性</li>
</ul>
<h4 id="如果加强-JWT-的安全性？"><a href="#如果加强-JWT-的安全性？" class="headerlink" title="如果加强 JWT 的安全性？"></a>如果加强 JWT 的安全性？</h4><ul>
<li>缩短 token 有效时间</li>
<li>使用安全系数高的加密算法</li>
<li>token 不要放在 Cookie 中，有 CSRF 风险</li>
<li>使用 HTTPS 加密协议</li>
<li>对标准字段 iss、sub、aud、nbf、exp 进行校验</li>
<li>使用成熟的开源库，不要手贱造轮子</li>
<li>特殊场景下可以把用户的 UA、IP 放进 payload 进行校验(不推荐)</li>
</ul>
<h3 id="JWT-简述"><a href="#JWT-简述" class="headerlink" title="JWT 简述"></a>JWT 简述</h3><blockquote>
<p>JWT（json web token）是为了在网络应用环境之间传递声明而基于 json 的开放标准，JWT 的声明一般被采用在身份提供者和服务器提供者间传递被认证的身份信息，以便于从资源服务器获取资源。</p>
</blockquote>
<h4 id="JWT-的应用场景"><a href="#JWT-的应用场景" class="headerlink" title="JWT 的应用场景"></a>JWT 的应用场景</h4><p>JWT 一般用于用户登录上，身份认证在这种场景下，一旦用户登录完成，在接下来的每个涉及用户权限的请求中都包含 JWT，可以对用户身份、路由、服务和资源的访问权限进行验证。</p>
<p>举一个例子，假如一个电商网站，在用户登录以后，需要验证用户的地方其实有很多，比如购物车，订单页，个人中心等等，访问这些页面正常的逻辑是先验证用户权限和登录状态，如果验证通过，则进入访问的页面，否则重定向到登录页。</p>
<p>而在 JWT 之前，这样的验证我们大多都是通过 cookie 和 session 去实现的，我们接下来就来对比以下这两种方式的不同。</p>
<h4 id="JWT-特点"><a href="#JWT-特点" class="headerlink" title="JWT 特点"></a>JWT 特点</h4><ul>
<li>体积小，因而传输速度快</li>
<li>传输方式多样，可以通过URL/POST参数/HTTP头部等方式传输</li>
<li>严格的结构化。它自身（在 payload 中）就包含了所有与用户相关的验证消息，如用户可访问路由、访问有效期等信息，服务器无需再去连接数据库验证信息的有效性，并且 payload 支持为你的应用而定制化。</li>
<li>支持跨域验证，可以应用于单点登录。</li>
</ul>
<h3 id="JWT-对比-cookie-session"><a href="#JWT-对比-cookie-session" class="headerlink" title="JWT 对比 cookie/session"></a>JWT 对比 cookie/session</h3><h4 id="cookie-session-的过程："><a href="#cookie-session-的过程：" class="headerlink" title="cookie/session 的过程："></a>cookie/session 的过程：</h4><p>由于浏览器的请求是无状态的，cookie 的存在就是为了带给服务器一些状态信息，服务器在接收到请求时会对其进行验证（其实是在登录时，服务器发给浏览器的），如果验证通过则正常返回结果，如果验证不通过则重定向到登录页，而服务器是根据 session 中存储的结果和收到的信息进行对比决定是否验证通过，当然这里只是简述过程。</p>
<h4 id="cookie-session-的问题："><a href="#cookie-session-的问题：" class="headerlink" title="cookie/session 的问题："></a>cookie/session 的问题：</h4><p>从上面可以看出服务器种植 cookie 后每次请求都会带上 cookie，浪费带宽，而且 cookie 不支持跨域，不方便与其他的系统之间进行跨域访问，而服务器会用 session 来存储这些用户验证的信息，这样浪费了服务器的内存，当多个服务器想要共享 session 需要都拷贝过去。</p>
<h3 id="JWT-的过程："><a href="#JWT-的过程：" class="headerlink" title="JWT 的过程："></a>JWT 的过程：</h3><p>当用户发送请求，将用户信息带给服务器的时候，服务器不再像过去一样存储在 session 中，而是将浏览器发来的内容通过内部的密钥加上这些信息，使用 sha256 和 RSA 等加密算法生成一个 token 令牌和用户信息一起返回给浏览器，当涉及验证用户的所有请求只需要将这个 token 和用户信息发送给服务器，而服务器将用户信息和自己的密钥通过既定好的算法进行签名，然后将发来的签名和生成的签名比较，严格相等则说明用户信息没被篡改和伪造，验证通过。</p>
<p>JWT 的过程中，服务器不再需要额外的内存存储用户信息，和多个服务器之间只需要共享密钥就可以让多个服务器都有验证能力，同时也解决了 cookie 不能跨域的问题。</p>
<h3 id="JWT-的结构-https-jwt-io"><a href="#JWT-的结构-https-jwt-io" class="headerlink" title="JWT 的结构 https://jwt.io/"></a>JWT 的结构 <a href="https://jwt.io/" target="_blank" rel="noopener">https://jwt.io/</a></h3><p><img src="/2018/11/02/JWT入门与实战/1.webp" alt=""><br>JWT 之所以能被作为一种声明传递的标准是因为它有自己的结构，并不是随便的发个 token 就可以的，JWT 用于生成 token 的结构有三个部分，使用 . 隔开。</p>
<p>1、Header [头部]</p>
<p>Header 头部中主要包含两部分，token 类型和加密算法，如<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"alg"</span>: <span class="string">"HS256"</span>,</span><br><span class="line">  <span class="string">"typ"</span>: <span class="string">"JWT"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>jwt的头部包含两部分信息：</p>
<ul>
<li>声明类型，这里是jwt</li>
<li>声明加密的算法 通常直接使用 HMAC SHA256</li>
</ul>
<p>然后将头部进行base64加密（该加密是可以对称解密的)，构成了第一部分。<br>HS256 就是指 sha256 算法，会将这个对象转成 base64。</p>
<p>2、Payload（载荷）</p>
<p><strong>由于这里用的是可逆的base64 编码，所以第二部分的数据实际上是明文的。我们应该避免在这里存放不能公开的隐私信息。</strong></p>
<p>Payload 负载就是存放有效信息的地方，有效信息被分为标准中注册的声明、公共的声明和私有的声明.</p>
<p>载荷就是存放有效信息的地方。这些有效信息包含三个部分：</p>
<p>标准中注册声明</p>
<ul>
<li>公共的声名</li>
<li>私有的声明</li>
<li>公共的声明 ： 公共的声明可以添加任何的信息，一般添加用户的相关信息或其他业务需要的必要信息.但不建议添加敏感信息，因为该部分在客户端可解密。</li>
<li>私有的声明 ： 私有声明是提供者和消费者所共同定义的声明，一般不建议存放敏感信息，因为base64是对称解密的，意味着该部分信息可以归类为明文信息。</li>
</ul>
<p>下面是一个例子<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"username"</span>: <span class="string">"libin"</span>,</span><br><span class="line">  <span class="string">"id"</span>: <span class="string">"5c170dfb5966f9060d290fe8"</span>,</span><br><span class="line">  <span class="string">"iat"</span>: <span class="number">1545014835</span>,</span><br><span class="line">  <span class="string">"exp"</span>: <span class="number">1545101235</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>(1) 标准中注册的声明<br>下面是标准中注册的声明，建议但不强制使用。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 包括需要传递的用户信息</span></span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line">  <span class="string">"iss"</span>: <span class="string">"Online JWT TEST"</span>, </span><br><span class="line">  <span class="string">"iat"</span>: <span class="number">1416797419</span>, </span><br><span class="line">  <span class="string">"exp"</span>: <span class="number">1448333419</span>, </span><br><span class="line">  <span class="string">"aud"</span>: <span class="string">"www.jwt.io"</span>, </span><br><span class="line">  <span class="string">"sub"</span>: <span class="string">"uid"</span>, </span><br><span class="line">  <span class="string">"nickname"</span>: <span class="string">"jwttest"</span>, </span><br><span class="line">  <span class="string">"username"</span>: <span class="string">"jwttest"</span>, </span><br><span class="line">  <span class="string">"scopes"</span>: [ <span class="string">"admin"</span>, <span class="string">"user"</span> ] </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>iss：jwt 签发者；</li>
<li>sub：jwt 所面向的用户；</li>
<li>aud：接收 jwt 的一方；</li>
<li>exp：jwt 的过期时间，这个过期时间必须要大于签发时间，这是一个秒数；</li>
<li>nbf：定义在什么时间之前，该 jwt 都是不可用的；</li>
<li>iat：jwt 的签发时间。<br>上面的标准中注册的声明中常用的有 exp 和 nbf。</li>
</ul>
<p>其他还有：</p>
<ul>
<li>nbf (Not Before)：如果当前时间在nbf里的时间之前，则Token不被接受；一般都会留一些余地，比如几分钟；，是否使用是可选的；</li>
<li>jti: jwt的唯一身份标识，主要用来作为一次性token，从而回避重放攻击。</li>
</ul>
<p>(2) 公共声明</p>
<p>公共的声明可以添加任何的信息，一般添加用户的相关信息或其他业务需要的必要信息，但不建议添加敏感信息，因为该部分在客户端可解密，如 {“id”, username: “panda”, adress: “Beijing”}，会将这个对象转成 base64。</p>
<p>(3) 私有声明</p>
<p>私有声明是提供者和消费者所共同定义的声明，一般不建议存放敏感信息，因为 base64 是对称解密的，意味着该部分信息可以归类为明文信息。</p>
<p>3、Signature [签名]<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据alg算法与私有秘钥进行加密得到的签名字串；</span></span><br><span class="line"><span class="comment">// 这一段是最重要的敏感信息，只能在服务端解密；</span></span><br><span class="line"></span><br><span class="line">HMACSHA256(  </span><br><span class="line">    base64UrlEncode(header) + <span class="string">"."</span> +</span><br><span class="line">    base64UrlEncode(payload),</span><br><span class="line">    your<span class="number">-256</span>-bit-secret</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>jwt的第三部分是一个签证信息，这个签证信息由三部分组成：</p>
<ul>
<li>header (base64后的)</li>
<li>payload (base64后的)</li>
<li>secret</li>
</ul>
<p>Signature 这一部分指将 Header 和 Payload 通过密钥 secret 和加盐算法进行加密后生成的签名，secret，密钥保存在服务端，不会发送给任何人，所以 JWT 的传输方式是很安全的。</p>
<p>最后将三部分使用 . 连接成字符串，就是要返回给浏览器的 token 浏览器一般会将这个 token 存储在 localStorge 以备其他需要验证用户的请求使用。</p>
<p>将上面的编码后的字符串都用句号.连接在一起（头部在前），就形成了:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImxpYmluIiwiaWQiOiI1YzE3MGRmYjU5NjZmOTA2MGQyOTBmZTgiLCJpYXQiOjE1NDUwMTQ4MzUsImV4cCI6MTU0NTEwMTIzNX0.FDWkBfas2b-jvXWuzedlNlhZmT4vQBey1w9q8vu2B8Q</span><br></pre></td></tr></table></figure></p>
<p><img src="/2018/11/02/JWT入门与实战/2.webp" alt=""></p>
<h3 id="JWT-使用场景"><a href="#JWT-使用场景" class="headerlink" title="JWT 使用场景"></a>JWT 使用场景</h3><p>JWT的主要优势在于使用无状态、可扩展的方式处理应用中的用户会话。服务端可以通过内嵌的声明信息，很容易地获取用户的会话信息，而不需要去访问用户或会话的数据库。在一个分布式的面向服务的框架中，这一点非常有用。</p>
<p>但是，如果系统中需要使用黑名单实现长期有效的token刷新机制，这种无状态的优势就不明显了。</p>
<blockquote>
<p>优点:快速开发，json格式简单，不需要cookie JSON在移动端的广泛应用 不依赖于社交登录 相对简单的概念理解，同session相比，性能更好一些，省去了处理分布session的问题；</p>
</blockquote>
<ul>
<li>支持跨域访问: Cookie是不允许垮域访问的，这一点对Token机制是不存在的，前提是传输的用户认证信息通过HTTP头传输.</li>
<li>无状态(也称：服务端可扩展行):Token机制在服务端不需要存储session信息，因为Token 自身包含了所有登录用户的信息，只需要在客户端的cookie或本地介质存储状态信息.</li>
<li>更适用CDN: 可以通过内容分发网络请求你服务端的所有资料（如：javascript，HTML,图片等），而你的服务端只要提供API即可.</li>
<li>去耦: 不需要绑定到一个特定的身份验证方案。Token可以在任何地方生成，只要在你的API被调用的时候，你可以进行Token生成调用即可.</li>
<li>更适用于移动应用: 当你的客户端是一个原生平台（iOS, Android，Windows 8等）时，Cookie是不被支持的（你需要通过Cookie容器进行处理），这时采用Token认证机制就会简单得多。</li>
<li>CSRF:因为不再依赖于Cookie，所以你就不需要考虑对CSRF（跨站请求伪造）的防范。- 性能: 一次网络往返时间（通过数据库查询session信息）总比做一次HMACSHA256计算 的Token验证和解析要费时得多.</li>
<li>不需要为登录页面做特殊处理: 如果你使用Protractor 做功能测试的时候，不再需要为登录页面做特殊处理.</li>
<li>基于标准化:你的API可以采用标准化的 JSON Web Token (JWT). 这个标准已经存在多个后端库（.NET, Ruby, Java,Python, PHP）和多家公司的支持（如：Firebase,Google, Microsoft）.</li>
</ul>
<blockquote>
<p>缺点:Token有长度限制 Token不能撤销 需要token有失效时间限制(exp)</p>
</blockquote>
<p>经过上面对 JWT 的叙述可能还是没有完全的理解什么是 JWT，具体怎么操作的，我们接下来实现一个小的案例，为了方便，服务端使用 express 框架，数据库使用 mongo 来存储用户信息，前端使用 Vue 来实现，做一个登录页登录后进入订单页验证 token 的功能。</p>
<h3 id="Vue-Koa2-JWT-完整代码"><a href="#Vue-Koa2-JWT-完整代码" class="headerlink" title="Vue+Koa2+JWT 完整代码"></a>Vue+Koa2+JWT <a href="https://github.com/libin1991/webpack4-vue-more-page-cli/tree/master/vue%2Bkoa2%2Bjwt%E5%AE%9E%E7%8E%B0%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%20%2B%20todolist%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5" target="_blank" rel="noopener">完整代码</a></h3><p><img src="/2018/11/02/JWT入门与实战/3.webp" alt=""></p>
<h4 id="jsonwebtoken"><a href="#jsonwebtoken" class="headerlink" title="jsonwebtoken"></a>jsonwebtoken</h4><h5 id="jwt-sign-payload-secretOrPrivateKey-options-callback"><a href="#jwt-sign-payload-secretOrPrivateKey-options-callback" class="headerlink" title="jwt.sign(payload, secretOrPrivateKey, [options, callback])"></a>jwt.sign(payload, secretOrPrivateKey, [options, callback])</h5><ul>
<li>（异步）如果提供回调，则使用err或JWT 调用回调。</li>
<li>（同步）将JsonWebToken返回为字符串。</li>
</ul>
<p>payload必须是一个object, buffer或者string。请注意， exp只有当payload是object字面量时才可以设置。<br>secretOrPrivateKey 是包含HMAC算法的密钥或RSA和ECDSA的PEM编码私钥的string或buffer。</p>
<p>options:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">algorithm：加密算法（默认值：HS256）</span><br><span class="line">expiresIn：以秒表示或描述时间跨度zeit / ms的字符串。如60，&quot;2 days&quot;，&quot;10h&quot;，&quot;7d&quot;，Expiration time，过期时间</span><br><span class="line">notBefore：以秒表示或描述时间跨度zeit / ms的字符串。如：60，&quot;2days&quot;，&quot;10h&quot;，&quot;7d&quot;</span><br><span class="line">audience：Audience，观众</span><br><span class="line">issuer：Issuer，发行者</span><br><span class="line">jwtid：JWT ID</span><br><span class="line">subject：Subject，主题</span><br><span class="line">noTimestamp</span><br><span class="line">header</span><br></pre></td></tr></table></figure></p>
<p>如果payload不是buffer或string，它将被强制转换为使用的字符串JSON.stringify()。<br>在expiresIn，notBefore，audience，subject，issuer没有默认值时。也可以直接在payload中用exp，nbf，aud，sub和iss分别表示，但是你不能在这两个地方同时设置。<br>请记住exp，nbf，iat是NumericDate类型。<br>生成的jwts通常会包含一个iat值除非指定了noTimestamp。如果iat插入payload中，则将使用它来代替实际的时间戳来计算其他事情，诸如options.expiresIn给定一个exp这样的时间间隔。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sign with default (HMAC SHA256)</span></span><br><span class="line"><span class="keyword">var</span> jwt = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>);</span><br><span class="line"><span class="keyword">var</span> token = jwt.sign(&#123; <span class="attr">foo</span>: <span class="string">'bar'</span> &#125;, <span class="string">'shhhhh'</span>);</span><br><span class="line"><span class="comment">//backdate a jwt 30 seconds</span></span><br><span class="line"><span class="keyword">var</span> older_token = jwt.sign(&#123; <span class="attr">foo</span>: <span class="string">'bar'</span>, <span class="attr">iat</span>: <span class="built_in">Math</span>.floor(<span class="built_in">Date</span>.now() / <span class="number">1000</span>) - <span class="number">30</span> &#125;, <span class="string">'shhhhh'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// sign with RSA SHA256</span></span><br><span class="line"><span class="keyword">var</span> cert = fs.readFileSync(<span class="string">'private.key'</span>);  <span class="comment">// get private key</span></span><br><span class="line"><span class="keyword">var</span> token = jwt.sign(&#123; <span class="attr">foo</span>: <span class="string">'bar'</span> &#125;, cert, &#123; <span class="attr">algorithm</span>: <span class="string">'RS256'</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// sign asynchronously</span></span><br><span class="line">jwt.sign(&#123; <span class="attr">foo</span>: <span class="string">'bar'</span> &#125;, cert, &#123; <span class="attr">algorithm</span>: <span class="string">'RS256'</span> &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, token</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(token);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//签署1小时期限的token:</span></span><br><span class="line">jwt.sign(&#123;</span><br><span class="line">  exp: <span class="built_in">Math</span>.floor(<span class="built_in">Date</span>.now() / <span class="number">1000</span>) + (<span class="number">60</span> * <span class="number">60</span>),</span><br><span class="line">  data: <span class="string">'foobar'</span></span><br><span class="line">&#125;, <span class="string">'secret'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用此库生成令牌的另一种方法是:</span></span><br><span class="line">jwt.sign(&#123;</span><br><span class="line">  data: <span class="string">'foobar'</span></span><br><span class="line">&#125;, <span class="string">'secret'</span>, &#123; <span class="attr">expiresIn</span>: <span class="number">60</span> * <span class="number">60</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//or even better:</span></span><br><span class="line"></span><br><span class="line">jwt.sign(&#123;</span><br><span class="line">  data: <span class="string">'foobar'</span></span><br><span class="line">&#125;, <span class="string">'secret'</span>, &#123; <span class="attr">expiresIn</span>: <span class="string">'1h'</span> &#125;);</span><br></pre></td></tr></table></figure></p>
<h5 id="jwt-verify（token，secretOrPublicKey，-options，callback-）"><a href="#jwt-verify（token，secretOrPublicKey，-options，callback-）" class="headerlink" title="jwt.verify（token，secretOrPublicKey，[options，callback]）"></a>jwt.verify（token，secretOrPublicKey，[options，callback]）</h5><p>验证token的合法性</p>
<h5 id="wt-decode（token-，options-）"><a href="#wt-decode（token-，options-）" class="headerlink" title="wt.decode（token [，options]）"></a>wt.decode（token [，options]）</h5><p>（同步）返回解码没有验证签名是否有效的payload。<br>警告：这不会验证签名是否有效。你应该不为不可信的消息使用此。你最有可能要使用jwt.verify()。</p>
<h4 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = <span class="built_in">require</span>(<span class="string">'../models/UserModels'</span>)</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>)</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'../config/config'</span>)</span><br><span class="line"><span class="keyword">const</span> md5 = <span class="built_in">require</span>(<span class="string">'md5'</span>)</span><br><span class="line"><span class="comment">// 密码使用md5加密存储</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//注册</span></span><br><span class="line"><span class="keyword">let</span> addUser =  <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> &#123;username, password&#125; = ctx.request.body</span><br><span class="line">  password = md5(password) <span class="comment">// md5加密处理</span></span><br><span class="line">  <span class="keyword">await</span> user.addUser(username,password) <span class="comment">// 异步处理,因为ctx.body不支持异步回调</span></span><br><span class="line">  .then(<span class="function">(<span class="params">data</span>)=&gt;</span> &#123;</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">      data,</span><br><span class="line">      type: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function">(<span class="params">data</span>)=&gt;</span> &#123;</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">      data,</span><br><span class="line">      type: <span class="number">0</span> <span class="comment">// 有毛病 type字段我定于或者不定义 都是type:1 莫名其妙</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//登录</span></span><br><span class="line"><span class="keyword">let</span> verifyUser = <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> &#123;username, password&#125; = ctx.request.body</span><br><span class="line">  password = md5(password)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">await</span> user.verifyUser(username, password)</span><br><span class="line">  .then(<span class="function">(<span class="params">data</span>)=&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123;text, id&#125; = data</span><br><span class="line">    <span class="comment">// 处理token  </span></span><br><span class="line">    <span class="keyword">let</span> token = jwt.sign(&#123;</span><br><span class="line">      username,</span><br><span class="line">      id</span><br><span class="line">    &#125;, config.secretOrPublicKey, &#123;</span><br><span class="line">      expiresIn: <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> <span class="comment">// 24小时过期</span></span><br><span class="line">    &#125;)</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">      text,</span><br><span class="line">      token,</span><br><span class="line">      type: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">      data,</span><br><span class="line">      type: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证</span></span><br><span class="line"><span class="keyword">let</span> verification = <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> &#123; token &#125; = ctx.request.body</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> jwt.verify(token, config.secretOrPublicKey, (err, decoded)=&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        ctx.body = &#123;</span><br><span class="line">          data: <span class="string">'登录信息失效'</span>,</span><br><span class="line">          type: <span class="number">0</span> </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (decoded) &#123;</span><br><span class="line">        ctx.body = &#123;</span><br><span class="line">          type: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">      data: <span class="string">'登录信息出错'</span>,</span><br><span class="line">      type: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  addUser,</span><br><span class="line">  verifyUser,</span><br><span class="line">  verification</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成Token<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">jwt.sign(&#123;</span><br><span class="line">      username,</span><br><span class="line">      id</span><br><span class="line">    &#125;, config.secretOrPublicKey, &#123;</span><br><span class="line">      expiresIn: <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> <span class="comment">// 24小时过期</span></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure></p>
<p>解析Token<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">jwt.verify(token, config.secretOrPublicKey, (err, decoded)=&gt; &#123;</span><br><span class="line">      if (err) &#123;</span><br><span class="line">        ctx.body = &#123;</span><br><span class="line">          data: &apos;登录信息失效&apos;,</span><br><span class="line">          type: 0 </span><br><span class="line">        &#125;</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line">      if (decoded) &#123;</span><br><span class="line">        ctx.body = &#123;</span><br><span class="line">          type: 1</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure></p>
<h4 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">router.beforeEach(<span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> token = localStorage.getItem(<span class="string">'token'</span>) <span class="comment">// 获取token</span></span><br><span class="line">  <span class="keyword">if</span> (to.name !== <span class="string">'login'</span> &amp;&amp; to.name !== <span class="string">'todoList'</span>) &#123;</span><br><span class="line">    next()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (to.name == <span class="string">'login'</span>) &#123; <span class="comment">// 假如登录 判断token是不是存在 存在让他跳转到主页面</span></span><br><span class="line">    verification(token, next)</span><br><span class="line">    .then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (data.data.type) &#123; <span class="comment">// type 为1 直接跳过登录</span></span><br><span class="line">        Message(&#123;</span><br><span class="line">          showClose: <span class="literal">true</span>,</span><br><span class="line">          message: <span class="string">'欢迎回来'</span></span><br><span class="line">        &#125;);</span><br><span class="line">        next(<span class="string">'/todolist'</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        next()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (to.name == <span class="string">'todoList'</span>) &#123;</span><br><span class="line">    verification(token, next)</span><br><span class="line">    .then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (data.data.type) &#123;</span><br><span class="line">        <span class="comment">// type 为1说明token没有失效</span></span><br><span class="line">        <span class="comment">// 跳转到主页面</span></span><br><span class="line">        next()</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// token失效 强制定位到登录页面</span></span><br><span class="line">        <span class="keyword">if</span> (token === <span class="literal">null</span>) &#123; <span class="comment">// 说明从来没有登陆过</span></span><br><span class="line">          Message(&#123;</span><br><span class="line">            showClose: <span class="literal">true</span>,</span><br><span class="line">            message: <span class="string">'您还没有登录'</span>,</span><br><span class="line">            type: <span class="string">'warning'</span></span><br><span class="line">          &#125;)</span><br><span class="line">          next(<span class="string">'/login'</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          Message.error(<span class="string">'登录信息失效'</span>)</span><br><span class="line">          next(<span class="string">'/login'</span>)</span><br><span class="line">          localStorage.removeItem(<span class="string">'token'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(data);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (to.meta.title) &#123;</span><br><span class="line">    <span class="built_in">document</span>.title = to.meta.title</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证</span></span><br><span class="line"><span class="keyword">let</span> verification = <span class="function">(<span class="params">token, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> axios.post(<span class="string">'/api/verification'</span>, &#123; token &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>前端解析Token<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt <span class="keyword">from</span> <span class="string">'jsonwebtoken'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    <span class="keyword">let</span> token = localStorage.getItem(<span class="string">'token'</span>)</span><br><span class="line">    <span class="keyword">let</span> Payload = jwt.decode(token)</span><br><span class="line">    <span class="keyword">this</span>.username = Payload.username <span class="comment">// 解密用户名</span></span><br><span class="line">    <span class="keyword">this</span>._id = Payload.id</span><br><span class="line">    <span class="keyword">this</span>.getData() <span class="comment">// 获取待完成时间</span></span><br><span class="line">    <span class="keyword">this</span>.getfulfilData()</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/01/Koa2对MongoDB连接的单例模式的封装/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="武动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/01/Koa2对MongoDB连接的单例模式的封装/" itemprop="url">Koa2对MongoDB连接的单例模式的封装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-01T10:08:41+08:00">
                2018-11-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>单例模式是最常用到的设计模式之一，熟悉设计模式的朋友对单例模式都不会陌生。一般介绍单例模式的书籍都会提到 饿汉式 和 懒汉式 这两种实现方式。但是除了这两种方式，本文还会介绍其他几种实现单例的方式，让我们来一起看看吧。</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>单例模式是一种常用的软件设计模式，其定义是单例对象的类只能允许一个实例存在。</p>
<p>许多时候整个系统只需要拥有一个的全局对象，这样有利于我们协调系统整体的行为。比如在某个服务器程序中，该服务器的配置信息存放在一个文件中，这些配置数据由一个单例对象统一读取，然后服务进程中的其他对象再通过这个单例对象获取这些配置信息。这种方式简化了在复杂环境下的配置管理。</p>
<h2 id="基本的实现思路"><a href="#基本的实现思路" class="headerlink" title="基本的实现思路"></a>基本的实现思路</h2><p>单例模式要求类能够有返回对象一个引用(永远是同一个)和一个获得该实例的方法（必须是静态方法，通常使用<code>ES6 class static</code>这个关键字）。</p>
<p>单例的实现主要是通过以下两个步骤：</p>
<blockquote>
<p>将该类的构造方法定义为私有方法，这样其他处的代码就无法通过调用该类的构造方法来实例化该类的对象，只有通过该类提供的静态方法来得到该类的唯一实例；</p>
</blockquote>
<blockquote>
<p>在该类内提供一个静态方法，当我们调用这个方法时，如果类持有的引用不为空就返回这个引用，如果类保持的引用为空就创建该类的实例并将实例的引用赋予该类保持的引用。</p>
</blockquote>
<h2 id="单例模式特点："><a href="#单例模式特点：" class="headerlink" title="单例模式特点："></a>单例模式特点：</h2><p>1、单例类只能有一个实例。<br>2、单例类必须自己创建自己的唯一实例。<br>3、单例类必须给所有其他对象提供这一实例。</p>
<p>单例模式保证了全局对象的唯一性，比如系统启动读取配置文件就需要单例保证配置的一致性。</p>
<h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h2><p>系统内存中该类只存在一个对象，节省了系统资源，对于一些需要频繁创建销毁的对象，使用单例模式可以提高系统性能。</p>
<h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h2><p>当想实例化一个单例类的时候，必须要记住使用相应的获取对象的方法，而不是使用new，可能会给其他开发人员造成困扰，特别是看不到源码的时候。</p>
<h2 id="适用场合"><a href="#适用场合" class="headerlink" title="适用场合"></a>适用场合</h2><ul>
<li>需要频繁的进行创建和销毁的对象；</li>
<li>创建对象时耗时过多或耗费资源过多，但又经常用到的对象；</li>
<li>工具类对象；</li>
<li>频繁访问数据库或文件的对象。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"></span><br><span class="line"> * http://mongodb.github.io/node-mongodb-native</span><br><span class="line"></span><br><span class="line"> * http://mongodb.github.io/node-mongodb-native/3.0/api/</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">//DB库</span><br><span class="line">var MongoDB=require(&apos;mongodb&apos;);</span><br><span class="line">var MongoClient =MongoDB.MongoClient;</span><br><span class="line">const ObjectID = MongoDB.ObjectID;</span><br><span class="line"></span><br><span class="line">var Config=require(&apos;./config.js&apos;);</span><br><span class="line"></span><br><span class="line">class Db&#123;</span><br><span class="line"></span><br><span class="line">    static getInstance()&#123;   /*1、单例  多次实例化实例不共享的问题*/</span><br><span class="line"></span><br><span class="line">        if(!Db.instance)&#123;</span><br><span class="line">            Db.instance=new Db();</span><br><span class="line">        &#125;</span><br><span class="line">        return  Db.instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor()&#123;</span><br><span class="line"></span><br><span class="line">        this.dbClient=&apos;&apos;; /*属性 放db对象*/</span><br><span class="line">        this.connect();   /*实例化的时候就连接数据库*/</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    connect()&#123;  /*连接数据库*/</span><br><span class="line">      let _that=this;</span><br><span class="line">      return new Promise((resolve,reject)=&gt;&#123;</span><br><span class="line">          if(!_that.dbClient)&#123;         /*1、解决数据库多次连接的问题*/</span><br><span class="line">              MongoClient.connect(Config.dbUrl,(err,client)=&gt;&#123;</span><br><span class="line"></span><br><span class="line">                  if(err)&#123;</span><br><span class="line">                      reject(err)</span><br><span class="line"></span><br><span class="line">                  &#125;else&#123;</span><br><span class="line"></span><br><span class="line">                      _that.dbClient=client.db(Config.dbName);</span><br><span class="line">                      resolve(_that.dbClient)</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;)</span><br><span class="line"></span><br><span class="line">          &#125;else&#123;</span><br><span class="line">              resolve(_that.dbClient);</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    find(collectionName,json)&#123;</span><br><span class="line"></span><br><span class="line">       return new Promise((resolve,reject)=&gt;&#123;</span><br><span class="line"></span><br><span class="line">            this.connect().then((db)=&gt;&#123;</span><br><span class="line"></span><br><span class="line">                var result=db.collection(collectionName).find(json);</span><br><span class="line"></span><br><span class="line">                result.toArray(function(err,docs)&#123;</span><br><span class="line"></span><br><span class="line">                    if(err)&#123;</span><br><span class="line">                        reject(err);</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line">                    resolve(docs);</span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    update(collectionName,json1,json2)&#123;</span><br><span class="line">        return new Promise((resolve,reject)=&gt;&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                this.connect().then((db)=&gt;&#123;</span><br><span class="line"></span><br><span class="line">                    //db.user.update(&#123;&#125;,&#123;$set:&#123;&#125;&#125;)</span><br><span class="line">                    db.collection(collectionName).updateOne(json1,&#123;</span><br><span class="line">                        $set:json2</span><br><span class="line">                    &#125;,(err,result)=&gt;&#123;</span><br><span class="line">                        if(err)&#123;</span><br><span class="line">                            reject(err);</span><br><span class="line">                        &#125;else&#123;</span><br><span class="line">                            resolve(result);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line"></span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    insert(collectionName,json)&#123;</span><br><span class="line">        return new  Promise((resolve,reject)=&gt;&#123;</span><br><span class="line">            this.connect().then((db)=&gt;&#123;</span><br><span class="line"></span><br><span class="line">                db.collection(collectionName).insertOne(json,function(err,result)&#123;</span><br><span class="line">                    if(err)&#123;</span><br><span class="line">                        reject(err);</span><br><span class="line">                    &#125;else&#123;</span><br><span class="line"></span><br><span class="line">                        resolve(result);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    remove(collectionName,json)&#123;</span><br><span class="line"></span><br><span class="line">        return new  Promise((resolve,reject)=&gt;&#123;</span><br><span class="line">            this.connect().then((db)=&gt;&#123;</span><br><span class="line"></span><br><span class="line">                db.collection(collectionName).removeOne(json,function(err,result)&#123;</span><br><span class="line">                    if(err)&#123;</span><br><span class="line">                        reject(err);</span><br><span class="line">                    &#125;else&#123;</span><br><span class="line"></span><br><span class="line">                        resolve(result);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    getObjectId(id)&#123;    /*mongodb里面查询 _id 把字符串转换成对象*/</span><br><span class="line"></span><br><span class="line">        return new ObjectID(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">module.exports=Db.getInstance();</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/29/Vue-cli3通用多页面脚手架/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="武动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/29/Vue-cli3通用多页面脚手架/" itemprop="url">Vue-cli3通用多页面脚手架</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-29T12:17:19+08:00">
                2018-10-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>目前 vue-cli3 生成的配置是做单页面的，然而，我们有时也会有多页面的需求 。比如我们最常见的一个项目跑多个独立的小型的H5页面，这些页面不可能每一次都开一个新项目.但是在实际的项目中，我们需要这样的脚手架，参考了很多大牛的脚手架，这里提供了一种我的单页面脚手架转换为多页面脚手架的方案，供大家参考。</p>
<h3 id="要求："><a href="#要求：" class="headerlink" title="要求："></a>要求：</h3><ul>
<li>1.首页显示项目所有的H5链接列表；</li>
<li>2.支持小型本地收据mock,方便本地测试接口【我个人不推荐，建议mock和项目分离】</li>
</ul>
<h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>使用vue-cli生成一个你需要的单页面项目脚手架，然后我们就可以为所欲为了，目录我就不说明了，默认大家都知道。</p>
<p><img src="/2018/10/29/Vue-cli3通用多页面脚手架/1.webp" alt=""></p>
<blockquote>
<p>每一次新开的页面都在pages里面起一个文件夹,<strong>文件夹名字就是H5页面名字,入口文件是文件夹的index.html和index.js</strong>。</p>
</blockquote>
<p>修改vue.config.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">let path = require(&apos;path&apos;)</span><br><span class="line">let glob = require(&apos;glob&apos;)</span><br><span class="line">let mock = require(&apos;./src/mock/index.json&apos;);</span><br><span class="line">var BundleAnalyzerPlugin = require(&apos;webpack-bundle-analyzer&apos;).BundleAnalyzerPlugin;</span><br><span class="line">//配置pages多页面获取当前文件夹下的html和js</span><br><span class="line">function getEntry(globPath) &#123;</span><br><span class="line">	let entries = &#123;&#125;;</span><br><span class="line">	glob.sync(globPath).forEach(function(entry) &#123;</span><br><span class="line">		var tmp = entry.split(&apos;/&apos;).splice(-3);</span><br><span class="line">		entries[tmp[1]] = &#123;</span><br><span class="line">			entry: &apos;src/&apos; + tmp[0] + &apos;/&apos; + tmp[1] + &apos;/&apos; + &apos;index.js&apos;,</span><br><span class="line">			template: &apos;src/&apos; + tmp[0] + &apos;/&apos; + tmp[1] + &apos;/&apos; + &apos;index.html&apos;,</span><br><span class="line">			filename: tmp[1]</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;);</span><br><span class="line">	return entries;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let pages = getEntry(&apos;./src/pages/**?/*.html&apos;);</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">	lintOnSave: false, </span><br><span class="line">	baseUrl: process.env.NODE_ENV === &quot;production&quot; ? &apos;https://www.baidu.com/&apos; : &apos;/&apos;,</span><br><span class="line">	productionSourceMap: false,</span><br><span class="line">	pages,</span><br><span class="line">	devServer: &#123;</span><br><span class="line">		index: &apos;/&apos;, </span><br><span class="line">		open: process.platform === &apos;darwin&apos;,</span><br><span class="line">		host: &apos;&apos;,</span><br><span class="line">		port: 9527,</span><br><span class="line">		https: false,</span><br><span class="line">		hotOnly: false,</span><br><span class="line">		proxy: &#123;</span><br><span class="line">			&apos;/xrf/&apos;: &#123;</span><br><span class="line">				target: &apos;http://reg.tool.hexun.com/&apos;,</span><br><span class="line">				changeOrigin: true,</span><br><span class="line">				pathRewrite: &#123;</span><br><span class="line">					&apos;^/xrf&apos;: &apos;&apos;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;, // 设置代理</span><br><span class="line">		before: app =&gt; &#123;     </span><br><span class="line">			app.get(&apos;/&apos;, (req, res, next) =&gt; &#123;</span><br><span class="line">				for(let i in pages)&#123;</span><br><span class="line">					res.write(`&lt;a target=&quot;_self&quot; href=&quot;/$&#123;i&#125;&quot;&gt;/$&#123;i&#125;&lt;/a&gt;&lt;/br&gt;`);</span><br><span class="line">				&#125;</span><br><span class="line">				res.end()</span><br><span class="line">			&#125;);</span><br><span class="line">			app.get(&apos;/goods/list&apos;, (req, res, next) =&gt; &#123;  //mock数据</span><br><span class="line">				res.status(299).json(mock)</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	chainWebpack: config =&gt; &#123;</span><br><span class="line">		config.module</span><br><span class="line">			.rule(&apos;images&apos;)</span><br><span class="line">			.use(&apos;url-loader&apos;)</span><br><span class="line">			.loader(&apos;url-loader&apos;)</span><br><span class="line">			.tap(options =&gt; &#123;</span><br><span class="line">				// 修改它的选项...</span><br><span class="line">				options.limit = 100</span><br><span class="line">				return options</span><br><span class="line">			&#125;)</span><br><span class="line">		Object.keys(pages).forEach(entryName =&gt; &#123;</span><br><span class="line">			config.plugins.delete(`prefetch-$&#123;entryName&#125;`);</span><br><span class="line">		&#125;);</span><br><span class="line">		if(process.env.NODE_ENV === &quot;production&quot;) &#123;</span><br><span class="line">			config.plugin(&quot;extract-css&quot;).tap(() =&gt; [&#123;</span><br><span class="line">				path: path.join(__dirname, &quot;./dist&quot;),</span><br><span class="line">				filename: &quot;css/[name].[contenthash:8].css&quot;</span><br><span class="line">			&#125;]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	configureWebpack: config =&gt; &#123;</span><br><span class="line">		//		if(process.env.NODE_ENV === &quot;production&quot;) &#123;</span><br><span class="line">		//			config.output = &#123;</span><br><span class="line">		//				path: path.join(__dirname, &quot;./dist&quot;),</span><br><span class="line">		//				filename: &quot;js/[name].[contenthash:8].js&quot;			</span><br><span class="line">		//			&#125;;</span><br><span class="line">		//		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>启动项目，显示项目所有H5连接</p>
<p><img src="/2018/10/29/Vue-cli3通用多页面脚手架/2.webp" alt=""></p>
<p>最主要的是修改：</p>
<blockquote>
<p><strong> before第一个参数express实例。</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">before: app =&gt; &#123;     </span><br><span class="line">		app.get(&apos;/&apos;, (req, res, next) =&gt; &#123;</span><br><span class="line">			for(let i in pages)&#123;    //遍历项目链接</span><br><span class="line">				res.write(`&lt;a target=&quot;_self&quot; href=&quot;/$&#123;i&#125;&quot;&gt;/$&#123;i&#125;&lt;/a&gt;&lt;/br&gt;`);</span><br><span class="line">			&#125;</span><br><span class="line">			res.end()</span><br><span class="line">		&#125;);</span><br><span class="line">		app.get(&apos;/goods/list&apos;, (req, res, next) =&gt; &#123;  //mock数据</span><br><span class="line">			res.status(299).json(mock)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h3 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h3><p><a href="https://juejin.im/post/5c403bcaf265da61587765c9" target="_blank" rel="noopener">【vue-cli3升级】老项目提速50%（二）</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">import store from &apos;@/store&apos;</span><br><span class="line">import axios from &apos;axios&apos;</span><br><span class="line">import &#123; Toast &#125; from &apos;vant&apos;</span><br><span class="line">import util from &apos;@/libs/util&apos;</span><br><span class="line"></span><br><span class="line">// 创建一个错误</span><br><span class="line">const errorCreate = msg =&gt; &#123;</span><br><span class="line">  const err = new Error(msg)</span><br><span class="line">  errorLog(err)</span><br><span class="line">  throw err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 记录和显示错误</span><br><span class="line">const errorLog = err =&gt; &#123;</span><br><span class="line">  // 添加到日志</span><br><span class="line">  store.dispatch(&apos;xxx/log/add&apos;, &#123;</span><br><span class="line">    type: &apos;error&apos;,</span><br><span class="line">    err,</span><br><span class="line">    info: &apos;数据请求异常&apos;</span><br><span class="line">  &#125;)</span><br><span class="line">  // 打印到控制台</span><br><span class="line">  if (process.env.NODE_ENV === &apos;development&apos;) &#123;</span><br><span class="line">    util.log.danger(&apos;&gt;&gt;&gt;&gt;&gt;&gt; Error &gt;&gt;&gt;&gt;&gt;&gt;&apos;)</span><br><span class="line">    console.log(err)</span><br><span class="line">  &#125;</span><br><span class="line">  // 显示提示</span><br><span class="line">  Toast(&#123;</span><br><span class="line">    message: err.message,</span><br><span class="line">    type: &apos;error&apos;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 创建一个 axios 实例</span><br><span class="line">const service = axios.create(&#123;</span><br><span class="line">  baseURL: process.env.VUE_APP_BASE_API,</span><br><span class="line">  timeout: 5000 // 请求超时时间</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 请求拦截器</span><br><span class="line">service.interceptors.request.use(</span><br><span class="line">  config =&gt; &#123;</span><br><span class="line">    // 在请求发送之前做一些处理</span><br><span class="line">    const token = util.cookies.get(&apos;token&apos;)</span><br><span class="line">    config.headers[&apos;X-Token&apos;] = token</span><br><span class="line">    // 处理mock</span><br><span class="line">    if (process.env.VUE_APP_MOCK &amp;&amp; config.isMock) &#123;</span><br><span class="line">      config.url = `$&#123;process.env.VUE_APP_MOCK_BASE_URL&#125;/$&#123;config.url&#125;`</span><br><span class="line">    &#125;</span><br><span class="line">    return config</span><br><span class="line">  &#125;,</span><br><span class="line">  error =&gt; &#123;</span><br><span class="line">    // 发送失败</span><br><span class="line">    console.log(error)</span><br><span class="line">    Promise.reject(error)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">// 响应拦截器</span><br><span class="line">service.interceptors.response.use(</span><br><span class="line">  response =&gt; &#123;</span><br><span class="line">    const dataAxios = response.data</span><br><span class="line">    const &#123; code &#125; = dataAxios</span><br><span class="line">    if (!code) return dataAxios</span><br><span class="line">    switch (code) &#123;</span><br><span class="line">      case 0:</span><br><span class="line">      case 10000:</span><br><span class="line">        // 成功</span><br><span class="line">        return dataAxios.data</span><br><span class="line">      case &apos;xxx&apos;:</span><br><span class="line">        errorCreate(`[ code: xxx ] $&#123;dataAxios.msg&#125;: $&#123;response.config.url&#125;`)</span><br><span class="line">        break</span><br><span class="line">      default:</span><br><span class="line">        // 不是正确的 code</span><br><span class="line">        errorCreate(`$&#123;dataAxios.msg&#125;: $&#123;response.config.url&#125;`)</span><br><span class="line">        break</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  error =&gt; &#123;</span><br><span class="line">    if (error &amp;&amp; error.response) &#123;</span><br><span class="line">      switch (error.response.status) &#123;</span><br><span class="line">        case 400: error.message = &apos;请求错误&apos;; break</span><br><span class="line">        case 401: error.message = &apos;未授权，请登录&apos;; break</span><br><span class="line">        case 403: error.message = &apos;拒绝访问&apos;; break</span><br><span class="line">        case 404: error.message = `请求地址出错: $&#123;error.response.config.url&#125;`; break</span><br><span class="line">        case 408: error.message = &apos;请求超时&apos;; break</span><br><span class="line">        case 500: error.message = &apos;服务器内部错误&apos;; break</span><br><span class="line">        case 501: error.message = &apos;服务未实现&apos;; break</span><br><span class="line">        case 502: error.message = &apos;网关错误&apos;; break</span><br><span class="line">        case 503: error.message = &apos;服务不可用&apos;; break</span><br><span class="line">        case 504: error.message = &apos;网关超时&apos;; break</span><br><span class="line">        case 505: error.message = &apos;HTTP版本不受支持&apos;; break</span><br><span class="line">        default: break</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    errorLog(error)</span><br><span class="line">    return Promise.reject(error)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line">export default service</span><br></pre></td></tr></table></figure></p>
<hr>
<h3 id="vue-cli3-全面配置-持续更新"><a href="#vue-cli3-全面配置-持续更新" class="headerlink" title="vue-cli3 全面配置(持续更新)"></a>vue-cli3 全面配置(持续更新)</h3><p><span id="top">目录</span></p>
<ul>
<li><a href="#env">√ 配置多环境变量</a></li>
<li><a href="#base">√ 配置基础 vue.config.js</a></li>
<li><a href="#proxy">√ 配置 proxy 跨域</a></li>
<li><a href="#hmr">√ 修复 HMR(热更新)失效</a></li>
<li><a href="#lazyloading">√ 修复 Lazy loading routes Error： Cyclic dependency</a></li>
<li><a href="#alias">√ 添加别名</a></li>
<li><a href="#removecss">√ 去除多余无效的 css</a></li>
<li><a href="#analyze">√ 添加打包分析</a></li>
<li><a href="#externals">√ 配置 externals</a></li>
<li><a href="#log">√ 去掉 console.log</a></li>
<li><a href="#gzip">√ 开启 gzip 压缩</a></li>
<li><a href="#globalscss">√ 为 sass 提供全局样式，以及全局变量</a></li>
<li><a href="#ie">√ 添加 IE 兼容</a></li>
<li><a href="#alioss">√ 文件上传 ali oss</a></li>
<li><a href="#allconfig">√ 完整依赖</a></li>
</ul>
<h3 id="☞-配置多环境变量"><a href="#☞-配置多环境变量" class="headerlink" title="☞ 配置多环境变量"></a><span id="env">☞ 配置多环境变量</span></h3><p>&emsp;&emsp;通过在 package.json 里的 scripts 配置项中添加–mode xxx 来选择不同环境</p>
<p>&emsp;&emsp;在项目根目录中新建.env, .env.production, .env.analyz 等文件</p>
<p>&emsp;&emsp;只有以 VUE<em>APP</em> 开头的变量会被 webpack.DefinePlugin 静态嵌入到客户端侧的包中，代码中可以通过 process.env.VUE_APP_BASE_API 访问</p>
<p>&emsp;&emsp;NODE_ENV 和 BASE_URL 是两个特殊变量，在代码中始终可用</p>
<h5 id="env-serve-默认的环境变量"><a href="#env-serve-默认的环境变量" class="headerlink" title=".env serve 默认的环境变量"></a>.env serve 默认的环境变量</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NODE_ENV = &apos;development&apos;</span><br><span class="line">VUE_APP_BASE_API = &apos;https://demo.cn/api&apos;</span><br></pre></td></tr></table></figure>
<h5 id="env-production-build-默认的环境变量"><a href="#env-production-build-默认的环境变量" class="headerlink" title=".env.production build 默认的环境变量"></a>.env.production build 默认的环境变量</h5><p>&emsp;&emsp;如果开启 ali oss,VUE_APP_SRC 配置为 ali oss 资源 url 前缀，如：’<a href="https://staven.oss-cn-hangzhou.aliyuncs.com/demo&#39;" target="_blank" rel="noopener">https://staven.oss-cn-hangzhou.aliyuncs.com/demo&#39;</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">NODE_ENV = &apos;production&apos;</span><br><span class="line"></span><br><span class="line">VUE_APP_BASE_API = &apos;https://demo.com/api&apos;</span><br><span class="line">VUE_APP_SRC = &apos;/&apos;</span><br><span class="line"></span><br><span class="line">ACCESS_KEY_ID = &apos;&apos;</span><br><span class="line">ACCESS_KEY_SECRET = &apos;&apos;</span><br><span class="line">REGION = &apos;oss-cn-hangzhou&apos;</span><br><span class="line">BUCKET = &apos;staven&apos;</span><br><span class="line">PREFIX = &apos;demo&apos;</span><br></pre></td></tr></table></figure>
<h5 id="env-analyz-用于-webpack-bundle-analyzer-打包分析"><a href="#env-analyz-用于-webpack-bundle-analyzer-打包分析" class="headerlink" title=".env.analyz 用于 webpack-bundle-analyzer 打包分析"></a>.env.analyz 用于 webpack-bundle-analyzer 打包分析</h5><p>&emsp;&emsp;如果开启 ali oss,VUE_APP_SRC 配置为 ali oss 资源 url 前缀，如：’<a href="https://staven.oss-cn-hangzhou.aliyuncs.com/demo&#39;" target="_blank" rel="noopener">https://staven.oss-cn-hangzhou.aliyuncs.com/demo&#39;</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">NODE_ENV = &apos;production&apos;</span><br><span class="line">IS_ANALYZ = &apos;analyz&apos;</span><br><span class="line"></span><br><span class="line">VUE_APP_BASE_API = &apos;https://demo.com/api&apos;</span><br><span class="line">VUE_APP_SRC = &apos;/&apos;</span><br><span class="line"></span><br><span class="line">ACCESS_KEY_ID = &apos;&apos;</span><br><span class="line">ACCESS_KEY_SECRET = &apos;&apos;</span><br><span class="line">REGION = &apos;oss-cn-hangzhou&apos;</span><br><span class="line">BUCKET = &apos;staven&apos;</span><br><span class="line">PREFIX = &apos;demo&apos;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;修改 package.json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">  &quot;serve&quot;: &quot;vue-cli-service serve&quot;,</span><br><span class="line">  &quot;build&quot;: &quot;vue-cli-service build&quot;,</span><br><span class="line">  &quot;analyz&quot;: &quot;vue-cli-service build --mode analyz&quot;,</span><br><span class="line">  &quot;lint&quot;: &quot;vue-cli-service lint&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="#top">▲ 回顶部</a></p>
<h3 id="☞-配置基础-vue-config-js"><a href="#☞-配置基础-vue-config-js" class="headerlink" title="☞ 配置基础 vue.config.js"></a><span id="base">☞ 配置基础 vue.config.js</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">const IS_PROD = [&apos;production&apos;, &apos;prod&apos;].includes(process.env.NODE_ENV);</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">  baseUrl: &apos;./&apos;, // 默认&apos;/&apos;，部署应用包时的基本 URL</span><br><span class="line">  outputDir: process.env.outputDir || &apos;dist&apos;, // &apos;dist&apos;, 生产环境构建文件的目录</span><br><span class="line">  assetsDir: &apos;&apos;,  // 相对于outputDir的静态资源(js、css、img、fonts)目录</span><br><span class="line">  lintOnSave: false,</span><br><span class="line">  runtimeCompiler: true, // 是否使用包含运行时编译器的 Vue 构建版本</span><br><span class="line">  productionSourceMap: false,  // 生产环境的 source map</span><br><span class="line">  parallel: require(&apos;os&apos;).cpus().length &gt; 1,</span><br><span class="line">  pwa: &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><a href="#top">▲ 回顶部</a></p>
<h3 id="☞-配置-proxy-跨域"><a href="#☞-配置-proxy-跨域" class="headerlink" title="☞ 配置 proxy 跨域"></a><span id="proxy">☞ 配置 proxy 跨域</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">const IS_PROD = [&apos;production&apos;, &apos;prod&apos;].includes(process.env.NODE_ENV);</span><br><span class="line">module.exports = &#123;</span><br><span class="line">    devServer: &#123;</span><br><span class="line">        // overlay: &#123;</span><br><span class="line">        //   warnings: true,</span><br><span class="line">        //   errors: true</span><br><span class="line">        // &#125;,</span><br><span class="line">        open: IS_PROD,</span><br><span class="line">        host: &apos;0.0.0.0&apos;,</span><br><span class="line">        port: 8000,</span><br><span class="line">        https: false,</span><br><span class="line">        hotOnly: false,</span><br><span class="line">        proxy: &#123;</span><br><span class="line">          &apos;/api&apos;: &#123;</span><br><span class="line">            target: process.env.VUE_APP_BASE_API || &apos;http://127.0.0.1:8080&apos;,</span><br><span class="line">            changeOrigin: true</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="#top">▲ 回顶部</a></p>
<h3 id="☞-修复-HMR-热更新-失效"><a href="#☞-修复-HMR-热更新-失效" class="headerlink" title="☞ 修复 HMR(热更新)失效"></a><span id="hmr">☞ 修复 HMR(热更新)失效</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">    chainWebpack: config =&gt; &#123;</span><br><span class="line">        // 修复HMR</span><br><span class="line">        config.resolve.symlinks(true);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="#top">▲ 回顶部</a></p>
<h3 id="☞-修复-Lazy-loading-routes-Error：-Cyclic-dependency-https-github-com-vuejs-vue-cli-issues-1669"><a href="#☞-修复-Lazy-loading-routes-Error：-Cyclic-dependency-https-github-com-vuejs-vue-cli-issues-1669" class="headerlink" title="☞ 修复 Lazy loading routes Error： Cyclic dependency https://github.com/vuejs/vue-cli/issues/1669"></a><span id="lazyloading">☞ 修复 Lazy loading routes Error： Cyclic dependency</span> <a href="https://github.com/vuejs/vue-cli/issues/1669" target="_blank" rel="noopener">https://github.com/vuejs/vue-cli/issues/1669</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">    chainWebpack: config =&gt; &#123;</span><br><span class="line">        config.plugin(&apos;html&apos;).tap(args =&gt; &#123;</span><br><span class="line">            args[0].chunksSortMode = &apos;none&apos;;</span><br><span class="line">            return args;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="#top">▲ 回顶部</a></p>
<h3 id="☞-添加别名"><a href="#☞-添加别名" class="headerlink" title="☞ 添加别名"></a><span id="alias">☞ 添加别名</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const path =  require(&apos;path&apos;);</span><br><span class="line">const resolve = (dir) =&gt; path.join(__dirname, dir);</span><br><span class="line">const IS_PROD = [&apos;production&apos;, &apos;prod&apos;].includes(process.env.NODE_ENV);</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">    chainWebpack: config =&gt; &#123;</span><br><span class="line">        // 添加别名</span><br><span class="line">        config.resolve.alias</span><br><span class="line">          .set(&apos;@&apos;, resolve(&apos;src&apos;))</span><br><span class="line">          .set(&apos;assets&apos;, resolve(&apos;src/assets&apos;))</span><br><span class="line">          .set(&apos;components&apos;, resolve(&apos;src/components&apos;))</span><br><span class="line">          .set(&apos;layout&apos;, resolve(&apos;src/layout&apos;))</span><br><span class="line">          .set(&apos;base&apos;, resolve(&apos;src/base&apos;))</span><br><span class="line">          .set(&apos;static&apos;, resolve(&apos;src/static&apos;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="#top">▲ 回顶部</a></p>
<h3 id="☞-去除多余无效的-css"><a href="#☞-去除多余无效的-css" class="headerlink" title="☞ 去除多余无效的 css"></a><span id="removecss">☞ 去除多余无效的 css</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i --save-dev glob-all purgecss-webpack-plugin</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">const PurgecssPlugin = require(&apos;purgecss-webpack-plugin&apos;);</span><br><span class="line">const glob = require(&apos;glob-all&apos;);</span><br><span class="line">const path = require(&apos;path&apos;)</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">    configureWebpack: config =&gt; &#123;</span><br><span class="line">        if (IS_PROD) &#123;</span><br><span class="line">            const plugins = [];</span><br><span class="line">            plugins.push(</span><br><span class="line">                new PurgecssPlugin(&#123;</span><br><span class="line">                    paths: glob.sync([</span><br><span class="line">                    path.join(__dirname, &apos;./src/index.html&apos;),</span><br><span class="line">                    path.join(__dirname, &apos;./**/*.vue&apos;),</span><br><span class="line">                    path.join(__dirname, &apos;./src/**/*.js&apos;)</span><br><span class="line">                    ])</span><br><span class="line">                &#125;)</span><br><span class="line">            );</span><br><span class="line">            config.plugins = [</span><br><span class="line">                ...config.plugins,</span><br><span class="line">                ...plugins</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="#top">▲ 回顶部</a></p>
<h3 id="☞-添加打包分析"><a href="#☞-添加打包分析" class="headerlink" title="☞ 添加打包分析"></a><span id="analyze">☞ 添加打包分析</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">const BundleAnalyzerPlugin = require(&apos;webpack-bundle-analyzer&apos;).BundleAnalyzerPlugin;</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">    chainWebpack: config =&gt; &#123;</span><br><span class="line">        // 打包分析</span><br><span class="line">        if (process.env.IS_ANALYZ) &#123;</span><br><span class="line">          config.plugin(&apos;webpack-report&apos;)</span><br><span class="line">            .use(BundleAnalyzerPlugin, [&#123;</span><br><span class="line">              analyzerMode: &apos;static&apos;,</span><br><span class="line">            &#125;]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="#top">▲ 回顶部</a></p>
<h3 id="☞-配置-externals"><a href="#☞-配置-externals" class="headerlink" title="☞ 配置 externals"></a><span id="externals">☞ 配置 externals</span></h3><p>&emsp;&emsp;防止将某些 import 的包(package)打包到 bundle 中，而是在运行时(runtime)再去从外部获取这些扩展依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">    configureWebpack: config =&gt; &#123;</span><br><span class="line">        config.externals = &#123;</span><br><span class="line">          &apos;vue&apos;: &apos;Vue&apos;,</span><br><span class="line">          &apos;element-ui&apos;: &apos;ELEMENT&apos;,</span><br><span class="line">          &apos;vue-router&apos;: &apos;VueRouter&apos;,</span><br><span class="line">          &apos;vuex&apos;: &apos;Vuex&apos;,</span><br><span class="line">          &apos;axios&apos;: &apos;axios&apos;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="#top">▲ 回顶部</a></p>
<h3 id="☞-去掉-console-log"><a href="#☞-去掉-console-log" class="headerlink" title="☞ 去掉 console.log"></a><span id="log">☞ 去掉 console.log</span></h3><h5 id="方法一："><a href="#方法一：" class="headerlink" title="方法一："></a>方法一：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">const UglifyJsPlugin = require(&apos;uglifyjs-webpack-plugin&apos;);</span><br><span class="line">module.exports = &#123;</span><br><span class="line">    configureWebpack: config =&gt; &#123;</span><br><span class="line">        if (IS_PROD) &#123;</span><br><span class="line">            const plugins = [];</span><br><span class="line">            plugins.push(</span><br><span class="line">                new UglifyJsPlugin(&#123;</span><br><span class="line">                    uglifyOptions: &#123;</span><br><span class="line">                        compress: &#123;</span><br><span class="line">                            warnings: false,</span><br><span class="line">                            drop_console: true,</span><br><span class="line">                            drop_debugger: false,</span><br><span class="line">                            pure_funcs: [&apos;console.log&apos;]//移除console</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    sourceMap: false,</span><br><span class="line">                    parallel: true</span><br><span class="line">                &#125;)</span><br><span class="line">            );</span><br><span class="line">            config.plugins = [</span><br><span class="line">                ...config.plugins,</span><br><span class="line">                ...plugins</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="方法二：使用-babel-plugin-transform-remove-console-插件"><a href="#方法二：使用-babel-plugin-transform-remove-console-插件" class="headerlink" title="方法二：使用 babel-plugin-transform-remove-console 插件"></a>方法二：使用 babel-plugin-transform-remove-console 插件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i --save-dev babel-plugin-transform-remove-console</span><br></pre></td></tr></table></figure>
<p>在 babel.config.js 中配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const plugins = [];</span><br><span class="line">if([&apos;production&apos;, &apos;prod&apos;].includes(process.env.NODE_ENV)) &#123;</span><br><span class="line">  plugins.push(&quot;transform-remove-console&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">  presets: [[&quot;@vue/app&quot;,&#123;&quot;useBuiltIns&quot;: &quot;entry&quot;&#125;]],</span><br><span class="line">  plugins: plugins</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><a href="#top">▲ 回顶部</a></p>
<h3 id="☞-开启-gzip-压缩"><a href="#☞-开启-gzip-压缩" class="headerlink" title="☞ 开启 gzip 压缩"></a><span id="gzip">☞ 开启 gzip 压缩</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i --save-dev compression-webpack-plugin</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">const CompressionWebpackPlugin = require(&apos;compression-webpack-plugin&apos;);</span><br><span class="line">const productionGzipExtensions = /\.(js|css|json|txt|html|ico|svg)(\?.*)?$/i;</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">    configureWebpack: config =&gt; &#123;</span><br><span class="line">        if (IS_PROD) &#123;</span><br><span class="line">            const plugins = [];</span><br><span class="line">            plugins.push(</span><br><span class="line">                new CompressionWebpackPlugin(&#123;</span><br><span class="line">                    filename: &apos;[path].gz[query]&apos;,</span><br><span class="line">                    algorithm: &apos;gzip&apos;,</span><br><span class="line">                    test: productionGzipExtensions,</span><br><span class="line">                    threshold: 10240,</span><br><span class="line">                    minRatio: 0.8</span><br><span class="line">                &#125;)</span><br><span class="line">            );</span><br><span class="line">            config.plugins = [</span><br><span class="line">                ...config.plugins,</span><br><span class="line">                ...plugins</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;还可以开启比 gzip 体验更好的 Zopfli 压缩详见<a href="https://webpack.js.org/plugins/compression-webpack-plugin" target="_blank" rel="noopener">https://webpack.js.org/plugins/compression-webpack-plugin</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i --save-dev @gfx/zopfli brotli-webpack-plugin</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">const CompressionWebpackPlugin = require(&apos;compression-webpack-plugin&apos;);</span><br><span class="line">const zopfli = require(&quot;@gfx/zopfli&quot;);</span><br><span class="line">const BrotliPlugin = require(&quot;brotli-webpack-plugin&quot;);</span><br><span class="line">const productionGzipExtensions = /\.(js|css|json|txt|html|ico|svg)(\?.*)?$/i;</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">    configureWebpack: config =&gt; &#123;</span><br><span class="line">        if (IS_PROD) &#123;</span><br><span class="line">            const plugins = [];</span><br><span class="line">            plugins.push(</span><br><span class="line">                new CompressionWebpackPlugin(&#123;</span><br><span class="line">                    algorithm(input, compressionOptions, callback) &#123;</span><br><span class="line">                      return zopfli.gzip(input, compressionOptions, callback);</span><br><span class="line">                    &#125;,</span><br><span class="line">                    compressionOptions: &#123;</span><br><span class="line">                      numiterations: 15</span><br><span class="line">                    &#125;,</span><br><span class="line">                    minRatio: 0.99,</span><br><span class="line">                    test: productionGzipExtensions</span><br><span class="line">                &#125;)</span><br><span class="line">            );</span><br><span class="line">            plugins.push(</span><br><span class="line">                new BrotliPlugin(&#123;</span><br><span class="line">                    test: productionGzipExtensions,</span><br><span class="line">                    minRatio: 0.99</span><br><span class="line">                &#125;)</span><br><span class="line">            );</span><br><span class="line">            config.plugins = [</span><br><span class="line">                ...config.plugins,</span><br><span class="line">                ...plugins</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="#top">▲ 回顶部</a></p>
<h3 id="☞-为-sass-提供全局样式，以及全局变量"><a href="#☞-为-sass-提供全局样式，以及全局变量" class="headerlink" title="☞ 为 sass 提供全局样式，以及全局变量"></a><span id="globalscss">☞ 为 sass 提供全局样式，以及全局变量</span></h3><p>&emsp;&emsp;可以通过在 main.js 中 Vue.prototype.$src = process.env.VUE_APP_SRC;挂载环境变量中的配置信息，然后在js中使用$src 访问。</p>
<p>&emsp;&emsp;css 中可以使用注入 sass 变量访问环境变量中的配置信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">    css: &#123;</span><br><span class="line">        modules: false,</span><br><span class="line">        extract: IS_PROD,</span><br><span class="line">        sourceMap: false,</span><br><span class="line">        loaderOptions: &#123;</span><br><span class="line">          sass: &#123;</span><br><span class="line">            // 向全局sass样式传入共享的全局变量</span><br><span class="line">            data: `@import &quot;~assets/scss/variables.scss&quot;;$src: &quot;$&#123;process.env.VUE_APP_SRC&#125;&quot;;`</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 scss 中引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.home &#123;</span><br><span class="line">    background: url($src + &apos;/images/500.png&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="#top">▲ 回顶部</a></p>
<h3 id="☞-添加-IE-兼容"><a href="#☞-添加-IE-兼容" class="headerlink" title="☞ 添加 IE 兼容"></a><span id="ie">☞ 添加 IE 兼容</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i --save @babel/polyfill</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;在 main.js 中添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &apos;@babel/polyfill&apos;;</span><br></pre></td></tr></table></figure>
<p>配置 babel.config.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const plugins = [];</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">  presets: [[&quot;@vue/app&quot;,&#123;&quot;useBuiltIns&quot;: &quot;entry&quot;&#125;]],</span><br><span class="line">  plugins: plugins</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><a href="#top">▲ 回顶部</a></p>
<h3 id="☞-文件上传-ali-oss"><a href="#☞-文件上传-ali-oss" class="headerlink" title="☞ 文件上传 ali oss"></a><span id="alioss">☞ 文件上传 ali oss</span></h3><p>&emsp;&emsp;开启文件上传 ali oss，需要将 baseUrl 改成 ali oss 资源 url 前缀,也就是修改 VUE_APP_SRC</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i --save-dev webpack-oss</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">const AliOssPlugin = require(&apos;webpack-oss&apos;);</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">    configureWebpack: config =&gt; &#123;</span><br><span class="line">        if (IS_PROD) &#123;</span><br><span class="line">            const plugins = [];</span><br><span class="line">            // 上传文件到oss</span><br><span class="line">            if (process.env.ACCESS_KEY_ID || process.env.ACCESS_KEY_SECRET || process.env.REGION || process.env.BUCKET || process.env.PREFIX) &#123;</span><br><span class="line">                plugins.push(</span><br><span class="line">                    new AliOssPlugin(&#123;</span><br><span class="line">                        accessKeyId: process.env.ACCESS_KEY_ID,</span><br><span class="line">                        accessKeySecret: process.env.ACCESS_KEY_SECRET,</span><br><span class="line">                        region: process.env.REGION,</span><br><span class="line">                        bucket: process.env.BUCKET,</span><br><span class="line">                        prefix: process.env.PREFIX,</span><br><span class="line">                        exclude: /.*\.html$/,</span><br><span class="line">                        deleteAll: false</span><br><span class="line">                    &#125;)</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">            config.plugins = [</span><br><span class="line">                ...config.plugins,</span><br><span class="line">                ...plugins</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="#top">▲ 回顶部</a></p>
<h3 id="☞-完整配置"><a href="#☞-完整配置" class="headerlink" title="☞ 完整配置"></a><span id="allconfig">☞ 完整配置</span></h3><ul>
<li>安装依赖</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i --save-dev compression-webpack-plugin babel-plugin-transform-remove-console  glob-all purgecss-webpack-plugin</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;其他依赖(@gfx/zopfli、brotli-webpack-plugin、webpack-oss)根据需求选择安装</p>
<ul>
<li>环境配置</li>
</ul>
<p>.env</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NODE_ENV = &apos;development&apos;</span><br><span class="line">VUE_APP_BASE_API = &apos;https://demo.cn/api&apos;</span><br></pre></td></tr></table></figure>
<p>.env.production</p>
<p>&emsp;&emsp;如果开启 ali oss,VUE_APP_SRC 配置为 ali oss 资源 url 前缀，如：’<a href="https://staven.oss-cn-hangzhou.aliyuncs.com/demo&#39;" target="_blank" rel="noopener">https://staven.oss-cn-hangzhou.aliyuncs.com/demo&#39;</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">NODE_ENV = &apos;production&apos;</span><br><span class="line"></span><br><span class="line">VUE_APP_BASE_API = &apos;https://demo.com/api&apos;</span><br><span class="line">VUE_APP_SRC = &apos;/&apos;</span><br><span class="line"></span><br><span class="line">ACCESS_KEY_ID = &apos;&apos;</span><br><span class="line">ACCESS_KEY_SECRET = &apos;&apos;</span><br><span class="line">REGION = &apos;oss-cn-hangzhou&apos;</span><br><span class="line">BUCKET = &apos;staven&apos;</span><br><span class="line">PREFIX = &apos;demo&apos;</span><br></pre></td></tr></table></figure>
<p>.env.analyz</p>
<p>&emsp;&emsp;如果开启 ali oss,VUE_APP_SRC 配置为 ali oss 资源 url 前缀，如：’<a href="https://staven.oss-cn-hangzhou.aliyuncs.com/demo&#39;" target="_blank" rel="noopener">https://staven.oss-cn-hangzhou.aliyuncs.com/demo&#39;</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">NODE_ENV = &apos;production&apos;</span><br><span class="line">IS_ANALYZ = &apos;analyz&apos;</span><br><span class="line"></span><br><span class="line">VUE_APP_BASE_API = &apos;https://demo.com/api&apos;</span><br><span class="line">VUE_APP_SRC = VUE_APP_SRC = &apos;/&apos;</span><br><span class="line"></span><br><span class="line">ACCESS_KEY_ID = &apos;&apos;</span><br><span class="line">ACCESS_KEY_SECRET = &apos;&apos;</span><br><span class="line">REGION = &apos;oss-cn-hangzhou&apos;</span><br><span class="line">BUCKET = &apos;staven&apos;</span><br><span class="line">PREFIX = &apos;demo&apos;</span><br></pre></td></tr></table></figure>
<ul>
<li>package.json</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;serve&quot;: &quot;vue-cli-service serve&quot;,</span><br><span class="line">    &quot;build&quot;: &quot;vue-cli-service build&quot;,</span><br><span class="line">    &quot;analyz&quot;: &quot;vue-cli-service build --mode analyz&quot;,</span><br><span class="line">    &quot;lint&quot;: &quot;vue-cli-service lint&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>babel.config.js</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const plugins = [];</span><br><span class="line">// if([&apos;production&apos;, &apos;prod&apos;].includes(process.env.NODE_ENV)) &#123;</span><br><span class="line">//   plugins.push(&quot;transform-remove-console&quot;)</span><br><span class="line">// &#125;</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">  presets: [[&quot;@vue/app&quot;,&#123;&quot;useBuiltIns&quot;: &quot;entry&quot;&#125;]],</span><br><span class="line">  plugins: plugins</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>vue.config.js</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line">const BundleAnalyzerPlugin = require(&quot;webpack-bundle-analyzer&quot;)</span><br><span class="line">  .BundleAnalyzerPlugin;</span><br><span class="line">const UglifyJsPlugin = require(&quot;uglifyjs-webpack-plugin&quot;);</span><br><span class="line">const CompressionWebpackPlugin = require(&quot;compression-webpack-plugin&quot;);</span><br><span class="line">// const zopfli = require(&quot;@gfx/zopfli&quot;);</span><br><span class="line">// const BrotliPlugin = require(&quot;brotli-webpack-plugin&quot;);</span><br><span class="line">const AliOssPlugin = require(&quot;webpack-oss&quot;);</span><br><span class="line"></span><br><span class="line">const path = require(&quot;path&quot;);</span><br><span class="line">const PurgecssPlugin = require(&quot;purgecss-webpack-plugin&quot;);</span><br><span class="line">const glob = require(&quot;glob-all&quot;);</span><br><span class="line"></span><br><span class="line">const resolve = dir =&gt; path.join(__dirname, dir);</span><br><span class="line">const IS_PROD = [&quot;production&quot;, &quot;prod&quot;].includes(process.env.NODE_ENV);</span><br><span class="line">const productionGzipExtensions = /\.(js|css|json|txt|html|ico|svg)(\?.*)?$/i;</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">  baseUrl: IS_PROD ? process.env.VUE_APP_SRC || &quot;/&quot; : &quot;./&quot;, // 默认&apos;/&apos;，部署应用包时的基本 URL</span><br><span class="line">  outputDir: process.env.outputDir || &quot;dist&quot;, // &apos;dist&apos;, 生产环境构建文件的目录</span><br><span class="line">  assetsDir: &quot;&quot;, // 相对于outputDir的静态资源(js、css、img、fonts)目录</span><br><span class="line">  lintOnSave: false,</span><br><span class="line">  runtimeCompiler: true, // 是否使用包含运行时编译器的 Vue 构建版本</span><br><span class="line">  productionSourceMap: false, // 生产环境的 source map</span><br><span class="line"></span><br><span class="line">  configureWebpack: config =&gt; &#123;</span><br><span class="line">    // cdn引用时配置externals</span><br><span class="line">    // config.externals = &#123;</span><br><span class="line">    //     &apos;vue&apos;: &apos;Vue&apos;,</span><br><span class="line">    //     &apos;element-ui&apos;: &apos;ELEMENT&apos;,</span><br><span class="line">    //     &apos;vue-router&apos;: &apos;VueRouter&apos;,</span><br><span class="line">    //     &apos;vuex&apos;: &apos;Vuex&apos;,</span><br><span class="line">    //     &apos;axios&apos;: &apos;axios&apos;</span><br><span class="line">    // &#125;</span><br><span class="line"></span><br><span class="line">    if (IS_PROD) &#123;</span><br><span class="line">      const plugins = [];</span><br><span class="line"></span><br><span class="line">      plugins.push(</span><br><span class="line">        new PurgecssPlugin(&#123;</span><br><span class="line">          paths: glob.sync([</span><br><span class="line">            path.join(__dirname, &quot;./src/index.html&quot;),</span><br><span class="line">            path.join(__dirname, &quot;./**/*.vue&quot;),</span><br><span class="line">            path.join(__dirname, &quot;./src/**/*.js&quot;)</span><br><span class="line">          ])</span><br><span class="line">        &#125;)</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      plugins.push(</span><br><span class="line">        new UglifyJsPlugin(&#123;</span><br><span class="line">          uglifyOptions: &#123;</span><br><span class="line">            compress: &#123;</span><br><span class="line">              warnings: false,</span><br><span class="line">              drop_console: true,</span><br><span class="line">              drop_debugger: false,</span><br><span class="line">              pure_funcs: [&quot;console.log&quot;] //移除console</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          sourceMap: false,</span><br><span class="line">          parallel: true</span><br><span class="line">        &#125;)</span><br><span class="line">      );</span><br><span class="line">      plugins.push(</span><br><span class="line">        new CompressionWebpackPlugin(&#123;</span><br><span class="line">          filename: &quot;[path].gz[query]&quot;,</span><br><span class="line">          algorithm: &quot;gzip&quot;,</span><br><span class="line">          test: productionGzipExtensions,</span><br><span class="line">          threshold: 10240,</span><br><span class="line">          minRatio: 0.8</span><br><span class="line">        &#125;)</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      // 上传文件到oss</span><br><span class="line">      //if (process.env.ACCESS_KEY_ID || process.env.ACCESS_KEY_SECRET || process.env.REGION || process.env.BUCKET || process.env.PREFIX) &#123;</span><br><span class="line">      //    plugins.push(</span><br><span class="line">      //        new AliOssPlugin(&#123;</span><br><span class="line">      //            accessKeyId: process.env.ACCESS_KEY_ID,</span><br><span class="line">      //            accessKeySecret: process.env.ACCESS_KEY_SECRET,</span><br><span class="line">      //            region: process.env.REGION,</span><br><span class="line">      //            bucket: process.env.BUCKET,</span><br><span class="line">      //            prefix: process.env.PREFIX,</span><br><span class="line">      //            exclude: /.*\.html$/,</span><br><span class="line">      //            deleteAll: false</span><br><span class="line">      //        &#125;)</span><br><span class="line">      //    );</span><br><span class="line">      //&#125;</span><br><span class="line"></span><br><span class="line">      // Zopfli压缩，需要响应VC库 https://webpack.js.org/plugins/compression-webpack-plugin/</span><br><span class="line">      // plugins.push(</span><br><span class="line">      //     new CompressionWebpackPlugin(&#123;</span><br><span class="line">      //         algorithm(input, compressionOptions, callback) &#123;</span><br><span class="line">      //             return zopfli.gzip(input, compressionOptions, callback);</span><br><span class="line">      //         &#125;,</span><br><span class="line">      //         compressionOptions: &#123;</span><br><span class="line">      //             numiterations: 15</span><br><span class="line">      //         &#125;,</span><br><span class="line">      //         minRatio: 0.99,</span><br><span class="line">      //         test: productionGzipExtensions</span><br><span class="line">      //     &#125;)</span><br><span class="line">      // );</span><br><span class="line">      // plugins.push(</span><br><span class="line">      //     new BrotliPlugin(&#123;</span><br><span class="line">      //         test: productionGzipExtensions,</span><br><span class="line">      //         minRatio: 0.99</span><br><span class="line">      //     &#125;)</span><br><span class="line">      // );</span><br><span class="line">      config.plugins = [...config.plugins, ...plugins];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  chainWebpack: config =&gt; &#123;</span><br><span class="line">    // 修复HMR</span><br><span class="line">    config.resolve.symlinks(true);</span><br><span class="line"></span><br><span class="line">    // 修复Lazy loading routes Error： Cyclic dependency  [https://github.com/vuejs/vue-cli/issues/1669]</span><br><span class="line">    config.plugin(&quot;html&quot;).tap(args =&gt; &#123;</span><br><span class="line">      args[0].chunksSortMode = &quot;none&quot;;</span><br><span class="line">      return args;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    // 添加别名</span><br><span class="line">    config.resolve.alias</span><br><span class="line">      .set(&quot;@&quot;, resolve(&quot;src&quot;))</span><br><span class="line">      .set(&quot;assets&quot;, resolve(&quot;src/assets&quot;))</span><br><span class="line">      .set(&quot;components&quot;, resolve(&quot;src/components&quot;))</span><br><span class="line">      .set(&quot;layout&quot;, resolve(&quot;src/layout&quot;))</span><br><span class="line">      .set(&quot;base&quot;, resolve(&quot;src/base&quot;))</span><br><span class="line">      .set(&quot;static&quot;, resolve(&quot;src/static&quot;));</span><br><span class="line"></span><br><span class="line">    // 打包分析</span><br><span class="line">    if (process.env.IS_ANALYZ) &#123;</span><br><span class="line">      config.plugin(&quot;webpack-report&quot;).use(BundleAnalyzerPlugin, [</span><br><span class="line">        &#123;</span><br><span class="line">          analyzerMode: &quot;static&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 多页面配置，为js添加hash</span><br><span class="line">    // config.output.chunkFilename(`js/[name].[chunkhash:8].js`)</span><br><span class="line"></span><br><span class="line">    // 修改图片输出路径</span><br><span class="line">    // config.module</span><br><span class="line">    //   .rule(&apos;images&apos;)</span><br><span class="line">    //   .test(/\.(png|jpe?g|gif|ico)(\?.*)?$/)</span><br><span class="line">    //   .use(&apos;url-loader&apos;)</span><br><span class="line">    //   .loader(&apos;url-loader&apos;)</span><br><span class="line">    //   .options(&#123;</span><br><span class="line">    //       name: path.join(&apos;../assets/&apos;, &apos;img/[name].[ext]&apos;)</span><br><span class="line">    //   &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  css: &#123;</span><br><span class="line">    modules: false,</span><br><span class="line">    extract: IS_PROD,</span><br><span class="line">    // 为css后缀添加hash</span><br><span class="line">    // extract: &#123;</span><br><span class="line">    //  filename: &apos;css/[name].[hash:8].css&apos;,</span><br><span class="line">    //  chunkFilename: &apos;css/[name].[hash:8].css&apos;</span><br><span class="line">    //&#125;，</span><br><span class="line">    sourceMap: false,</span><br><span class="line">    loaderOptions: &#123;</span><br><span class="line">      sass: &#123;</span><br><span class="line">        // 向全局sass样式传入共享的全局变量</span><br><span class="line">        // data: `@import &quot;~assets/scss/variables.scss&quot;;$src: &quot;$&#123;process.env.VUE_APP_SRC&#125;&quot;;`</span><br><span class="line">        data: `$src: &quot;$&#123;process.env.VUE_APP_SRC&#125;&quot;;`</span><br><span class="line">      &#125;</span><br><span class="line">      // px转换为rem</span><br><span class="line">      // postcss: &#123;</span><br><span class="line">      //   plugins: [</span><br><span class="line">      //     require(&apos;postcss-pxtorem&apos;)(&#123;</span><br><span class="line">      //       rootValue : 1, // 换算的基数</span><br><span class="line">      //       selectorBlackList  : [&apos;weui&apos;, &apos;el&apos;], // 忽略转换正则匹配项</span><br><span class="line">      //       propList   : [&apos;*&apos;]</span><br><span class="line">      //     &#125;)</span><br><span class="line">      //   ]</span><br><span class="line">      // &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  pluginOptions: &#123;</span><br><span class="line">    // 安装vue-cli-plugin-style-resources-loader插件</span><br><span class="line">    // 添加全局样式global.scss</span><br><span class="line">    // &quot;style-resources-loader&quot;: &#123;</span><br><span class="line">    //   preProcessor: &quot;scss&quot;,</span><br><span class="line">    //   patterns: [</span><br><span class="line">    //     resolve(__dirname, &quot;./src/scss/scss/variables.scss&quot;)</span><br><span class="line">    //   ]</span><br><span class="line">    // &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  parallel: require(&quot;os&quot;).cpus().length &gt; 1,</span><br><span class="line">  pwa: &#123;&#125;,</span><br><span class="line">  devServer: &#123;</span><br><span class="line">    // overlay: &#123;</span><br><span class="line">    //   warnings: true,</span><br><span class="line">    //   errors: true</span><br><span class="line">    // &#125;,</span><br><span class="line">    open: IS_PROD,</span><br><span class="line">    host: &quot;0.0.0.0&quot;,</span><br><span class="line">    port: 8000,</span><br><span class="line">    https: false,</span><br><span class="line">    hotOnly: false,</span><br><span class="line">    proxy: &#123;</span><br><span class="line">      &quot;/api&quot;: &#123;</span><br><span class="line">        target: process.env.VUE_APP_BASE_API || &quot;http://127.0.0.1:8080&quot;,</span><br><span class="line">        changeOrigin: true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/27/剖析node的Common-JS/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="武动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/27/剖析node的Common-JS/" itemprop="url">剖析node的Common.JS</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-27T20:11:16+08:00">
                2018-10-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Javascript最开始是怎样实现模块化呢？"><a href="#Javascript最开始是怎样实现模块化呢？" class="headerlink" title="Javascript最开始是怎样实现模块化呢？"></a>Javascript最开始是怎样实现模块化呢？</h3><p>我们知道javascript最开始是面向过程的思维编程，随着代码越来越庞大、复杂，在这种实际遇到的问题中，大佬们逐渐把面向对象、模块化的思想用在javascript当中。</p>
<h4 id="一开始，我们是把不同功能写在不同函数当中"><a href="#一开始，我们是把不同功能写在不同函数当中" class="headerlink" title="一开始，我们是把不同功能写在不同函数当中"></a>一开始，我们是把不同功能写在不同函数当中</h4><pre><code>// 比如getCssAttr函数来获取Css属性，当我们需要获取Css属性的时候可以直接调用该方法
function getCssAttr(obj, attr) {
    if (obj.currentStyle) {
        return obj.currentStyle[attr];
    } else {
        return window.getComputedStyle(obj, null)[attr];
    }
}

// 比如toJSON函数能够把url的query转为JSON对象
function toJSON(str) {
  var obj = {}, allArr = [], splitArr = [];
  str = str.indexOf(&apos;?&apos;) &gt;= 0 ? str.substr(1) : str;
  allArr = str.split(&apos;&amp;&apos;);
  for (var i = 0; i &lt; allArr.length; i++) {
    splitArr = allArr[i].split(&apos;=&apos;);
    obj[splitArr[0]] = splitArr[1];
  }
  return obj;
}
</code></pre><p>这样getCssAttr函数和toJSON组成了模块，当需要使用的时候，直接调用即可，但是随着项目代码量越来越庞大和复杂，而且这种方式会对全局变量造成了污染。</p>
<h4 id="为了解决上面的问题，会想到把这些方法、变量放到对象中"><a href="#为了解决上面的问题，会想到把这些方法、变量放到对象中" class="headerlink" title="为了解决上面的问题，会想到把这些方法、变量放到对象中"></a>为了解决上面的问题，会想到把这些方法、变量放到对象中</h4><pre><code>let utils = new Object({
    getCssAttr:function(){...},
    toJSON:function(){...}
})
</code></pre><p>当需要调用相应函数时，我们通过对象调用即可，<code>utils.getCssAttr()</code>、<code>utils.toJSON()</code>，但是这样会存在一个问题，就是可以直接通过外部修改内部方法属性。</p>
<pre><code>utils.getCssAttr = null
</code></pre><h4 id="那么我们有办法让内部方法属性不被修改吗？"><a href="#那么我们有办法让内部方法属性不被修改吗？" class="headerlink" title="那么我们有办法让内部方法属性不被修改吗？"></a>那么我们有办法让内部方法属性不被修改吗？</h4><p>答案是可以的，我们可以通过闭包的方式，使私有成员不暴露在外部。</p>
<pre><code>let utils = (function(){
    let getCssAttr = function(){...}
    let toJSON = function(){...}
    return {
        getCssAttr,
        toJSON
    }
})()
</code></pre><p>这样的话，外部就无法改变内部的私有成员了。</p>
<hr>
<h2 id="CMD和AMD规范"><a href="#CMD和AMD规范" class="headerlink" title="CMD和AMD规范"></a>CMD和AMD规范</h2><p>试想一下，如果一个项目，所有轮子都自己造，在现在追求敏捷开发的环境下，我们有必要所有轮子都自己造吗？一些常用通用的功能，是否可以提取出来，供大家使用，提高开发效率？</p>
<p>正所谓，无规矩不成方圆，每个程序猿的代码风格肯定是有差异的，你写你的，我写我的，这样就很难流通了，但是如果大家都遵循一个规范编写代码，形成一个个模块，就显得非常重要了。</p>
<p>在这样的背景下，形成了两种规范，一种是以sea.js为代表的CMD规范，另外一种是以require.js为代表的AMD规范。</p>
<ul>
<li>CMD规范（Common Module Definition 通用模块定义）</li>
<li>AMD规范（Asynchronous Module Definition 异步模块定义）</li>
</ul>
<p>在node.js中是遵循commonJS规范的，在对模块的导入是同步的，为什么这样说？因为在服务器中，模块都是存在本地的，即使要导入模块，也只是耗费了从硬盘读取模块的时间，而且可控。</p>
<p>但是在浏览器中，模块是需要通过网络请求获取的，如果是同步获取的话，那么网络请求的时间没办法保证，会造成浏览器假死的，但是异步的话，是不会阻塞主线程，所以不管是CMD还是AMD，都是属于异步的，CMD和AMD都是属于异步加载模块，当所需要依赖的模块加载完毕后，才通过一个回调函数，写我们所需要的业务逻辑。</p>
<h4 id="CMD和AMD的异同"><a href="#CMD和AMD的异同" class="headerlink" title="CMD和AMD的异同"></a>CMD和AMD的异同</h4><ul>
<li>CMD是<code>延迟执行，依赖就近</code>，而AMD是<code>提前执行，依赖前置</code>（require2.0开始可以改成延迟执行），怎么理解呢？看看下面代码<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// CMD</span><br><span class="line">define(function(require,exports,module)&#123;</span><br><span class="line">    var a = require(&apos;./a&apos;)</span><br><span class="line">    a.run()</span><br><span class="line">    </span><br><span class="line">    var b = require(&apos;./b&apos;)</span><br><span class="line">    b.eat()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// AMD</span><br><span class="line">define([&apos;./a&apos;,&apos;./b&apos;],function(a,b)&#123;</span><br><span class="line">    a.run()</span><br><span class="line">    b.eat()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="CMD-AMD执行对比"><a href="#CMD-AMD执行对比" class="headerlink" title="CMD,AMD执行对比"></a>CMD,AMD执行对比</h4><table>
<thead>
<tr>
<th>—</th>
<th style="text-align:center">CMD</th>
<th style="text-align:right">AMD</th>
</tr>
</thead>
<tbody>
<tr>
<td> 执行回调函数的时机</td>
<td style="text-align:center">快</td>
<td style="text-align:right">慢</td>
</tr>
<tr>
<td> 执行回调函数内的业务</td>
<td style="text-align:center">慢</td>
<td style="text-align:right">快</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="node-js遵循的commonJs规范"><a href="#node-js遵循的commonJs规范" class="headerlink" title="node.js遵循的commonJs规范"></a>node.js遵循的commonJs规范</h2><h3 id="首先，我们来剖析一下commonJs的源码"><a href="#首先，我们来剖析一下commonJs的源码" class="headerlink" title="首先，我们来剖析一下commonJs的源码"></a>首先，我们来剖析一下commonJs的源码</h3><p>我们分别创建两个文件<code>useModule.js</code>、<code>module.js</code>，并且打上断点。<br><img src="/2018/10/27/剖析node的Common-JS/166abfe6e856dc15.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// useModule.js</span><br><span class="line">let utils = require(&apos;./module&apos;)</span><br><span class="line">utils = require(&apos;./module&apos;)</span><br><span class="line">utils.sayhello()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// module.js</span><br><span class="line">let utils = &#123;</span><br><span class="line">  sayhello:function()&#123;</span><br><span class="line">    console.log(&apos;hello swr&apos;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">module.exports = utils</span><br></pre></td></tr></table></figure></p>
<p>然后开始执行，我们首先会进入commonJs的源码了<br><img src="/2018/10/27/剖析node的Common-JS/166ac006849ff31e.webp" alt=""><br> 在最上面可以看出是一个闭包的形式<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(function(exports,require,module,__filename,__dirname))&#123;</span><br><span class="line">  //...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> ，这里可以看出<code>__dirname</code>和<code>__filename</code>并非是<code>global</code>上的属性，而是每个模块对应的路径。</p>
<p>而且我们在模块当中<code>this</code>并不是指向<code>global</code>的，而是指向<code>module.exports</code>，至于为什么会这样呢？下面会讲到。</p>
<p>在红框中，我们可以看到<code>require</code>函数，<code>exports.requireDepth</code>可以暂时不用管，是一个引用深度的变量，接下来我们往下看，<code>return mod.require(path)</code>，这里的<code>mod</code>就是每一个文件、模块，而里面都有一个<code>require</code>方法，接下来我们看看<code>mod.require</code>函数内部是怎么写的。<br><img src="/2018/10/27/剖析node的Common-JS/1.webp" alt=""><br>进来后，我们会看到2个<code>assert</code>断言，用来判断<code>path</code>参数是否传递了，<code>path</code>是否字符串类型等等。</p>
<p><code>return Module._load(path,this,false)</code>，<code>path</code>为我们传入的模块路径，this则是这个模块，false则不是主要模块，主要模块的意思是，如果a.js加载了b.js，那么a.js是主要模块，而b.js则是非主要模块。</p>
<p>接下来我们看看<code>Module._load</code>这个静态方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Module._load = function(request, parent, isMain) &#123;</span><br><span class="line"></span><br><span class="line">  //  计算绝对路径</span><br><span class="line">  var filename = Module._resolveFilename(request, parent);</span><br><span class="line"></span><br><span class="line">  //  第一步：如果有缓存，取出缓存</span><br><span class="line">  var cachedModule = Module._cache[filename];</span><br><span class="line">  if (cachedModule) &#123;</span><br><span class="line">    return cachedModule.exports;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  // 第二步：是否为内置模块</span><br><span class="line">  if (NativeModule.exists(filename)) &#123;</span><br><span class="line">    return NativeModule.require(filename);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 第三步：生成模块实例，存入缓存</span><br><span class="line">  var module = new Module(filename, parent);</span><br><span class="line">  Module._cache[filename] = module;</span><br><span class="line"></span><br><span class="line">  // 第四步：加载模块</span><br><span class="line">  try &#123;</span><br><span class="line">    module.load(filename);</span><br><span class="line">    hadException = false;</span><br><span class="line">  &#125; finally &#123;</span><br><span class="line">    if (hadException) &#123;</span><br><span class="line">      delete Module._cache[filename];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 第五步：输出模块的exports属性</span><br><span class="line">  return module.exports;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><img src="/2018/10/27/剖析node的Common-JS/2.webp" alt=""><br><img src="/2018/10/27/剖析node的Common-JS/3.webp" alt=""><br><code>var filename = Module._resolveFilename(request, parent, isMain)</code>，这里的目的是解析出一个绝对路径，我们可以进去看看<code>Module._resolveFilename</code>函数是怎么写的<br><img src="/2018/10/27/剖析node的Common-JS/4.webp" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Module._resolveFilename = function(request, parent) &#123;</span><br><span class="line"></span><br><span class="line"> // 第一步：如果是内置模块，不含路径返回</span><br><span class="line"> if (NativeModule.exists(request)) &#123;</span><br><span class="line">   return request;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> // 第二步：确定所有可能的路径</span><br><span class="line"> var resolvedModule = Module._resolveLookupPaths(request, parent);</span><br><span class="line"> var id = resolvedModule[0];</span><br><span class="line"> var paths = resolvedModule[1];</span><br><span class="line"></span><br><span class="line"> // 第三步：确定哪一个路径为真</span><br><span class="line"> var filename = Module._findPath(request, paths);</span><br><span class="line"> if (!filename) &#123;</span><br><span class="line">   var err = new Error(&quot;Cannot find module &apos;&quot; + request + &quot;&apos;&quot;);</span><br><span class="line">   err.code = &apos;MODULE_NOT_FOUND&apos;;</span><br><span class="line">   throw err;</span><br><span class="line"> &#125;</span><br><span class="line"> return filename;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>上面代码中，在 Module.resolveFilrename 方法内部，又调用了两个方法  Module.reqolveLookPaths()和 Module._findPath(),前者用来列出可能的路径，后者用来确认哪一个路径为真。<br>有了可能的路径以后，下面就是 Module._findPath()的源码，用来确定到底哪一个是正确路径。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">Module._findPath = function(request, paths) &#123;</span><br><span class="line"></span><br><span class="line"> // 列出所有可能的后缀名：.js，.json, .node</span><br><span class="line"> var exts = Object.keys(Module._extensions);</span><br><span class="line"></span><br><span class="line"> // 如果是绝对路径，就不再搜索</span><br><span class="line"> if (request.charAt(0) === &apos;/&apos;) &#123;</span><br><span class="line">   paths = [&apos;&apos;];</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> // 是否有后缀的目录斜杠</span><br><span class="line"> var trailingSlash = (request.slice(-1) === &apos;/&apos;);</span><br><span class="line"></span><br><span class="line"> // 第一步：如果当前路径已在缓存中，就直接返回缓存</span><br><span class="line"> var cacheKey = JSON.stringify(&#123;request: request, paths: paths&#125;);</span><br><span class="line"> if (Module._pathCache[cacheKey]) &#123;</span><br><span class="line">   return Module._pathCache[cacheKey];</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> // 第二步：依次遍历所有路径</span><br><span class="line"> for (var i = 0, PL = paths.length; i &lt; PL; i++) &#123;</span><br><span class="line">   var basePath = path.resolve(paths[i], request);</span><br><span class="line">   var filename;</span><br><span class="line"></span><br><span class="line">   if (!trailingSlash) &#123;</span><br><span class="line">     // 第三步：是否存在该模块文件</span><br><span class="line">     filename = tryFile(basePath);</span><br><span class="line"></span><br><span class="line">     if (!filename &amp;&amp; !trailingSlash) &#123;</span><br><span class="line">       // 第四步：该模块文件加上后缀名，是否存在</span><br><span class="line">       filename = tryExtensions(basePath, exts);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   // 第五步：目录中是否存在 package.json </span><br><span class="line">   if (!filename) &#123;</span><br><span class="line">     filename = tryPackage(basePath, exts);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   if (!filename) &#123;</span><br><span class="line">     // 第六步：是否存在目录名 + index + 后缀名 </span><br><span class="line">     filename = tryExtensions(path.resolve(basePath, &apos;index&apos;), exts);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   // 第七步：将找到的文件路径存入返回缓存，然后返回</span><br><span class="line">   if (filename) &#123;</span><br><span class="line">     Module._pathCache[cacheKey] = filename;</span><br><span class="line">     return filename;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> // 第八步：没有找到文件，返回false </span><br><span class="line"> return false;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>有时在项目代码中，需要调用模块的绝对路径，那么除了 module.filename ，Node 还提供一个 require.resolve 方法，供外部调用，用于从模块名取到绝对路径。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">require.resolve = function(request) &#123;</span><br><span class="line">  return Module._resolveFilename(request, self);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 用法</span><br><span class="line">require.resolve(&apos;a.js&apos;)</span><br><span class="line">// 返回  /Users/danlan/workspace/node-stu/ree/a.js</span><br></pre></td></tr></table></figure></p>
<p><code>Module._resolveFilename</code>函数也没什么好说的，就是判断各种情况，然后解析出一个绝对路径出来，我们跳出这个函数，回到<code>Module._load</code>中.<br>然后我们看到<code>var cachedModule = Module._cache[filename]</code>，这是我们加载模块的缓存机制，就是说我们加载过一次模块后，会缓存到Module._cache这个对象中，并且是以<code>filename</code>作为键名，因为路径是唯一的，所以以路径作为唯一标识，如果已经缓存过，则会直接返回这个缓存过的模块。</p>
<p><code>NativeModule.nonInternalExists(filename)</code>判断是否原生模块，是的话则直接返回模块。</p>
<p>经过上面两个判断，基本可以判定这个模块没被加载过，那么接下来看到<code>var module = new Module(filename, parent)</code>，创建了一个模块，我们看看<code>Module</code>这个构造函数有什么内容<br><img src="/2018/10/27/剖析node的Common-JS/5.webp" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module.id 模块的识别符，通常是带有绝对路径的模块文件名。</span><br><span class="line">module.filename 模块的文件名，带有绝对路径。</span><br><span class="line">module.loaded 返回一个布尔值，表示模块是否已经完成加载。</span><br><span class="line">module.parent 返回一个对象，表示调用该模块的模块。</span><br><span class="line">module.children 返回一个数组，表示该模块要用到的其他模块。</span><br><span class="line">module.exports 表示模块对外输出的值。</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>下面是一个示例文件，最后一行输出module变量。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// example.js</span><br><span class="line">var jquery = require(&apos;jquery&apos;);</span><br><span class="line">exports.$ = jquery;</span><br><span class="line">console.log(module);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>执行这个文件，命令行会输出如下信息。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123; id: &apos;.&apos;,</span><br><span class="line">  exports: &#123; &apos;$&apos;: [Function] &#125;,</span><br><span class="line">  parent: null,</span><br><span class="line">  filename: &apos;/path/to/example.js&apos;,</span><br><span class="line">  loaded: false,</span><br><span class="line">  children:</span><br><span class="line">   [ &#123; id: &apos;/path/to/node_modules/jquery/dist/jquery.js&apos;,</span><br><span class="line">       exports: [Function],</span><br><span class="line">       parent: [Circular],</span><br><span class="line">       filename: &apos;/path/to/node_modules/jquery/dist/jquery.js&apos;,</span><br><span class="line">       loaded: true,</span><br><span class="line">       children: [],</span><br><span class="line">       paths: [Object] &#125; ],</span><br><span class="line">  paths:</span><br><span class="line">   [ &apos;/home/user/deleted/node_modules&apos;,</span><br><span class="line">     &apos;/home/user/node_modules&apos;,</span><br><span class="line">     &apos;/home/node_modules&apos;,</span><br><span class="line">     &apos;/node_modules&apos; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 这里的<code>id</code>，实际上就是<code>filename</code>唯一路径，另外一个很重要的是<code>this.exports</code>，也就是将来用于暴露模块的。<br>我们接着往下看，在创建一个实例后，接下来把这个实例存在缓存当中，<code>Module._cache[filename] = module</code><br>然后执行<code>tryModuleLoad(module, filename)</code>，这个函数非常重要，是用来加载模块的，我们看看是怎么写的<br><img src="/2018/10/27/剖析node的Common-JS/6.webp" alt=""><br> 这里有个<code>module.load</code>，我们再往里面看看是怎么写的<br><img src="/2018/10/27/剖析node的Common-JS/7.webp" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Module.prototype.load = function (filename) &#123;</span><br><span class="line">    var extension = path.extname(filename)  || &apos;js&apos;</span><br><span class="line">    if(!Module._extensions[extensions]) extension = &apos;.js&apos;</span><br><span class="line">    Module._extensions[extension](this, filename)</span><br><span class="line">    this.loaded = true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 兜兜转转，终于来到最核心的地方了<br><code>this.paths = Module._nodeModulePaths(path.dirname(filename))</code>，我们知道，我们安装npm包时，node会由里到外一层层找<code>node_modules</code>文件夹，而这一步，则是路径一层层丢进数组里，我们可以看看<code>this.paths</code>的数组</p>
<h4 id="CommonJS-模块查找规范"><a href="#CommonJS-模块查找规范" class="headerlink" title="CommonJS 模块查找规范"></a>CommonJS 模块查找规范</h4><p><img src="/2018/10/27/剖析node的Common-JS/13.svg" alt=""><br><img src="/2018/10/27/剖析node的Common-JS/8.webp" alt=""></p>
<blockquote>
<p>新建一个b.js</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var a = require(&apos;./a.js&apos;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>运行一下：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">module.id:  /Users/danlan/workspace/node-stu/ree/a.js</span><br><span class="line">module.exports:  &#123;&#125;</span><br><span class="line">module.parent:  Module &#123;</span><br><span class="line">  id: &apos;.&apos;,</span><br><span class="line">  exports: &#123;&#125;,</span><br><span class="line">  parent: null,</span><br><span class="line">  filename: &apos;/Users/danlan/workspace/node-stu/ree/b.js&apos;,</span><br><span class="line">  loaded: false,</span><br><span class="line">  children:</span><br><span class="line">   [ Module &#123;</span><br><span class="line">       id: &apos;/Users/danlan/workspace/node-stu/ree/a.js&apos;,</span><br><span class="line">       exports: &#123;&#125;,</span><br><span class="line">       parent: [Circular],</span><br><span class="line">       filename: &apos;/Users/danlan/workspace/node-stu/ree/a.js&apos;,</span><br><span class="line">       loaded: false,</span><br><span class="line">       children: [],</span><br><span class="line">       paths: [Array] &#125; ],</span><br><span class="line">  paths:</span><br><span class="line">   [ &apos;/Users/danlan/workspace/node-stu/ree/node_modules&apos;,</span><br><span class="line">     &apos;/Users/danlan/workspace/node-stu/node_modules&apos;,</span><br><span class="line">     &apos;/Users/danlan/workspace/node_modules&apos;,</span><br><span class="line">     &apos;/Users/danlan/node_modules&apos;,</span><br><span class="line">     &apos;/Users/node_modules&apos;,</span><br><span class="line">     &apos;/node_modules&apos; ] &#125;</span><br><span class="line">module.filename:  /Users/danlan/workspace/node-stu/ree/a.js</span><br><span class="line">module.loaded:  false</span><br><span class="line">module.children:  []</span><br><span class="line">module.paths:  [ &apos;/Users/danlan/workspace/node-stu/ree/node_modules&apos;,</span><br><span class="line">  &apos;/Users/danlan/workspace/node-stu/node_modules&apos;,</span><br><span class="line">  &apos;/Users/danlan/workspace/node_modules&apos;,</span><br><span class="line">  &apos;/Users/danlan/node_modules&apos;,</span><br><span class="line">  &apos;/Users/node_modules&apos;,</span><br><span class="line">  &apos;/node_modules&apos; ]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>举例来说，脚本/home/user/projects/foo.js执行了require(‘bar.js’)命令，Node会依次搜索以下文件。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/lib/node/bar.js</span><br><span class="line">/home/user/projects/node_modules/bar.js</span><br><span class="line">/home/user/node_modules/bar.js</span><br><span class="line">/home/node_modules/bar.js</span><br><span class="line">/node_modules/bar.js</span><br></pre></td></tr></table></figure>
<p>这样设计的目的是，使得不同的模块可以将所依赖的模块本地化。</p>
<ul>
<li>如果参数字符串不以“./“或”/“开头，而且是一个路径，比如require(‘example-module/path/to/file’)，则将先找到example-module的位置，然后再以它为参数，找到后续路径。</li>
<li><font color="#ff0000">如果指定的模块文件没有发现，Node会尝试为文件名添加.js、.json、.node后，再去搜索。.js件会以文本格式的JavaScript脚本文件解析，.json文件会以JSON格式的文本文件解析，.node文件会以编译后的二进制文件解析。</font></li>
<li>如果想得到require命令加载的确切文件名，使用require.resolve()方法。</li>
</ul>
<p>目录的加载规则</p>
<blockquote>
<p>在目录中放置一个package.json文件，并且将入口文件写入main字段。下面是一个例子。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// package.json</span><br><span class="line">&#123; </span><br><span class="line">  &quot;name&quot; : &quot;some-library&quot;,</span><br><span class="line">  &quot;main&quot; : &quot;./lib/some-library.js&quot; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 继续往下看，<code>var extension = path.extname(filename) || &#39;.js&#39;</code>是获取后缀名，如果没有后缀名的话，暂时默认添加一个<code>.js</code>后缀名。<br>继续往下看，<code>if (!Module._extensions[extension]) extension = &#39;.js&#39;</code>是判断<code>Module._extensions</code>这个对象，是否有这个属性，如果没有的话，则让这个后缀名为<code>.js</code><br>继续往下看，<code>Module._extensions[extension](this, filename)</code>，根据后缀名，执行对应的函数，那么我们看一下<code>Module._extensions</code>对象有哪几个函数<br><img src="/2018/10/27/剖析node的Common-JS/9.webp" alt=""><br> 从这里我们可以看到，<code>Module._extensions</code>中有3个函数，分别是<code>.js</code>、<code>.json</code>、<code>.node</code>函数，意思是根据不同的后缀名，执行不同的函数，来解析不同的内容，我们可以留意到读取文件都是用<code>fs.readFileSync</code>同步读取，因为这些文件都是保存在服务器硬盘中，读取这些文件耗费时间非常短，所以采用了同步而不是异步<br>其中<code>.json</code>最为简单，读取出文件后，再通过<code>JSON.parse</code>把字符串转化为<code>JSON</code>对象，然后把结果赋值给<code>module.exports</code><br>接下来看看<code>.js</code>，也是一样先读取出文件内容，然后通过<code>module._compile</code>这个函数来解析<code>.js</code>的内容，我们看一下<code>module._compile</code>函数怎么写的<br> <img src="/2018/10/27/剖析node的Common-JS/10.webp" alt=""><br> <img src="/2018/10/27/剖析node的Common-JS/11.webp" alt=""><br> <code>var wrapper = Module.wrap(content)</code>这里对<code>.js</code>文件的内容进行了一层处理，我们可以看看<code>Module.wrap</code>怎么写的<br>  <img src="/2018/10/27/剖析node的Common-JS/12.webp" alt=""><br> 在这里可以看出，<code>NativeModule.wrapper</code>数组中有两个数组成员，是不是看起来似曾相识？没错，这就是闭包的形式，而<code>Module.wrap</code>中，是直接把js文件的内容，和这个闭包拼接成一段字符串，对，就是在这里，把一个个模块，套一层闭包！实际上拼接出来的是</p>
<pre><code>// 字符串
&quot;(function(exports,require,module,__filename,__dirname){
    let utils = {
      sayhello:function(){
        console.log(&apos;hello swr&apos;)
      }
    }
})&quot;
</code></pre><p>我们跳出来，回到<code>Module.prototype._compile</code>看看，接下来看到<code>var compiledWrapper = vm.runInThisContext(wrapper,{...})</code>，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//虚拟机，帮我们创建一个黑箱执行代码，防止变量污染</span><br><span class="line">const vm = require(&quot;vm&quot;);</span><br></pre></td></tr></table></figure></p>
<p>在nodejs中是通过vm这个虚拟机，执行字符串，而且这样的好处是使内部完全是封闭的，不会被外在变量污染，而在前端的字符串模板则是通过<code>new Function()</code>来执行字符串，达到不被外在变量污染</p>
<p>继续往下看，<code>result = compiledWrapper.call(this.exports, this.exports, require, this,filename, dirname)</code>，其中<code>compiledWrapper</code>就是我们通过vm虚拟机执行的字符串后返回的闭包，而且通过<code>call</code>来把这个模块中的<code>this</code>指向更改为当前模块，而不是全局的<code>global</code>，这里就是为什么我们在模块当中打印<code>this</code>时，指向的是当前的<code>module.exports</code>而不是<code>global</code>，然后后面依次把相应的参数传递过去</p>
<p>最终一层层跳出后<code>Module._load</code>中，最后是<code>return module.exports</code>，也就是说我们通过<code>require</code>导入的模块，取的是<code>module.exports</code></p>
<h4 id="通过剖析commonJs源码，我们收获了什么？"><a href="#通过剖析commonJs源码，我们收获了什么？" class="headerlink" title="通过剖析commonJs源码，我们收获了什么？"></a>通过剖析commonJs源码，我们收获了什么？</h4><ul>
<li><p>懂得了模块加载的整个流程</p>
<ul>
<li>第一步：解析出一个绝对路径,如果是核心模块，比如fs，就直接返回模块</li>
<li>第二步：如文件没添加后缀，则添加<code>.js</code>、<code>.json</code>、<code>.node</code>作为后缀，然后通过<code>fs.existsSync</code>来判断文件是否存在<ul>
<li>.js 解析为JavaScript 文本文件</li>
<li>.json解析JSON对象</li>
<li>.node解析为二进制插件模块</li>
</ul>
</li>
<li>第三步：到缓存中找该模块是否被加载过(如果是带有路径的如/,./等等，则拼接出一个绝对路径，然后先读取缓存require.cache再读取文件。如果没有加后缀，则自动加后缀然后一一识别。)</li>
<li>第四步：new一个模块实例</li>
<li>第五步：把模块存到缓存当中(首次加载后的模块会缓存在require.cache之中，所以多次加载require，得到的对象是同一个。)</li>
<li>第六步：根据后缀名，加载这个模块<ul>
<li>在执行模块代码的时候，会将模块包装成如下模式，以便于作用域在模块范围之内。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">   (function(exports, require, module, __filename, __dirname) &#123;</span><br><span class="line">   // 模块的代码实际上在这里</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>知道如何实现由里到外一层层查找<code>node_modules</code></p>
</li>
<li>知道针对<code>.js</code>和<code>.json</code>是怎么解析的<ul>
<li><code>.js</code>是通过拼接字符串，形成一个闭包形式的字符串</li>
<li><code>.json</code>则是通过<code>JSON.parse</code>转为<code>JSON</code>对象</li>
</ul>
</li>
<li><p>知道如何执行字符串，并且不受外部变量污染</p>
<ul>
<li><p>nodejs中通过vm虚拟机来执行字符串</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">   let vm=require(&quot;vm&quot;)</span><br><span class="line">   let a=&apos;console.log(&quot;a&quot;)&apos;</span><br><span class="line">vm.runInThisContext(a)</span><br></pre></td></tr></table></figure>
</li>
<li><p>前端则是通过<code>new Function()</code>来执行字符串</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var f = new Function(&apos;x&apos;, &apos;y&apos;, &apos;return x+y&apos;); </span><br><span class="line">      f( 3, 4 )</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>知道为什么模块中的<code>this</code>指向的是<code>this.exports</code>而不是<code>global</code></p>
<ul>
<li>通过<code>call</code>把指针指向了<code>this.exports</code></li>
</ul>
</li>
</ul>
<hr>
<h3 id="接下来，我们手写一个简陋版的commonJs源码"><a href="#接下来，我们手写一个简陋版的commonJs源码" class="headerlink" title="接下来，我们手写一个简陋版的commonJs源码"></a>接下来，我们手写一个简陋版的commonJs源码</h3><p>commonJs其实在加载模块的时候，做了以下几个步骤</p>
<ul>
<li>第一步：解析出一个绝对路径</li>
<li>第二步：如文件没添加后缀，则添加<code>.js</code>、<code>.json</code>、<code>.node</code>作为后缀，然后通过<code>fs.existsSync</code>来判断文件是否存在</li>
<li>第三步：到缓存中找该模块是否被加载过</li>
<li>第四步：new一个模块实例</li>
<li>第五步：把模块存到缓存当中</li>
<li>第六步：根据后缀名，加载这个模块</li>
</ul>
<p>那么我们根据这几个步骤，来手写一下源码~</p>
<pre><code>// module.js
let utils = {
  sayhello: function () {
    console.log(&apos;hello swr&apos;)
  }
}
console.log(&apos;执行了&apos;)
module.exports = utils
</code></pre><p>首先写出解析一个绝对路径以及如文件没添加后缀，则添加<code>.js</code>、<code>.json</code>作为后缀，然后通过<code>fs.existsSync</code>来判断文件是否存在（ .. 每个步骤我都会标识1、2、3…</p>
<pre><code>// useModule.js
// 1.引入核心模块
let fs = require(&apos;fs&apos;)
let path = require(&apos;path&apos;)

// 3.声明一个Module构造函数
function Module(id) {
  this.id = id 
  this.exports = {} // 将来暴露模块的内容
}

// 8.支持的后缀名类型
Module._extensions = {
  &quot;.js&quot;:function(){},
  &quot;.json&quot;:function(){}
}

// 5.解析出绝对路径，_resolveFilename是Module的静态方法
Module._resolveFilename = function (relativePath) {
  // 6.返回一个路径
  let p = path.resolve(__dirname,relativePath)
  // 7.该路径是否存在文件，如果存在则直接返回
  //   这种情况主要考虑用户自行添加了后缀名
  //   如&apos;./module.js&apos;let exists = fs.existsSync(p)
  if(exists) return p
  // 9.如果relativePath传入的如&apos;./module&apos;，没有添加后缀
  //   那么我们给它添加后缀，并且判断添加后缀后是否存在该文件
  let keys = Object.keys(Module._extensions)
  let r = falsefor(let val of keys){ // 这里用for循环，是当找到文件后可以直接break跳出循环
    let realPath = p + val // 拼接后缀
    let exists = fs.existsSync(realPath)
    if(exists){
      r = realPath
      break
    }
  }
  if(!r){ // 如果找不到文件，则抛出错误
    throw new Error(&apos;file not exists&apos;)
  }
  return r
}

// 2.为了不与require冲突，这个函数命名为req
//   传入一个参数p 路径
function req(p) {
  // 10.因为Module._resolveFilename存在找不到文件
  //    找不到文件时会抛出错误，所以我们这里捕获错误
  try { 
    // 4.通过Module._resolveFilename解析出一个绝对路径
    let filename = Module._resolveFilename(p)
  } catch (e) {
    console.log(e)
  }
}

// 导入模块，并且导入两次，主要是校验是否加载过一次后
// 在有缓存的情况下，会不会直接返回缓存的模块
// 为此特意在module.js中添加了console.log(&quot;执行了&quot;)
// 来看打印了几次
let utils = req(&apos;./module&apos;)
utils = req(&apos;./module&apos;)
utils.sayhello()
</code></pre><p>然后到缓存中找该模块是否被加载过，如果没有加载过则new一个模块实例，把模块存到缓存当中，最后根据后缀名，加载这个模块（ .. 每个步骤我都会标识1、2、3…</p>
<pre><code>// useModule.js
// 1.引入核心模块
let fs = require(&apos;fs&apos;)
let path = require(&apos;path&apos;)

// 3.声明一个Module构造函数
function Module(id) {
  this.id = id 
  this.exports = {} // 将来暴露模块的内容
}

// * 21.因为处理js文件时，需要包裹一个闭包，我们写一个数组
Module.wrapper = [
  &quot;(function(exports,require,module){&quot;,
  &quot;\n})&quot;
]

// * 22.通过Module.wrap包裹成闭包的字符串形式
Module.wrap = function(script){
  return Module.wrapper[0] + script + Module.wrapper[1]
}

// 8.支持的后缀名类型
Module._extensions = {
  &quot;.js&quot;:function(module){ // * 20.其次看看js是如何处理的
    let str = fs.readFileSync(module.id,&apos;utf8&apos;)
    // * 23.通过Module.wrap函数把内容包裹成闭包
    let fnStr = Module.wrap(str)
    // * 24.引入vm虚拟机来执行字符串
    let vm = require(&apos;vm&apos;)
    let fn = vm.runInThisContext(fnStr)
    // 让产生的fn执行，并且把this指向更改为当前的module.exports
    fn.call(this.exports,this.exports,req,module)
  },
  &quot;.json&quot;:function(module){ // * 18.首先看看json是如何处理的
    let str = fs.readFileSync(module.id,&apos;utf8&apos;)
    // * 19.通过JSON.parse处理，并且赋值给module.exports
    let json = JSON.parse(str)
    module.exports = json
  }
}

// * 15.加载
Module.prototype._load = function(filename){
  // * 16.获取后缀名
  let extension = path.extname(filename)
  // * 17.根据不同后缀名 执行不同的方法
  Module._extensions[extension](this)
}

// 5.解析出绝对路径，_resolveFilename是Module的静态方法
Module._resolveFilename = function (relativePath) {
  // 6.返回一个路径
  let p = path.resolve(__dirname,relativePath)
  // 7.该路径是否存在文件，如果存在则直接返回
  //   这种情况主要考虑用户自行添加了后缀名
  //   如&apos;./module.js&apos;let exists = fs.existsSync(p)
  if(exists) return p
  // 9.如果relativePath传入的如&apos;./module&apos;，没有添加后缀
  //   那么我们给它添加后缀，并且判断添加后缀后是否存在该文件
  let keys = Object.keys(Module._extensions)
  let r = falsefor(let val of keys){ // 这里用for循环，是当找到文件后可以直接break跳出循环
    let realPath = p + val // 拼接后缀
    let exists = fs.existsSync(realPath)
    if(exists){
      r = realPath
      break
    }
  }
  if(!r){ // 如果找不到文件，则抛出错误
    throw new Error(&apos;file not exists&apos;)
  }
  return r
}

// * 11.缓存对象
Module._cache = {}

// 2.为了不与require冲突，这个函数命名为req
//   传入一个参数p 路径
function req(p) {
  // 10.因为Module._resolveFilename存在找不到文件
  //    找不到文件时会抛出错误，所以我们这里捕获错误
  try { 
    // 4.通过Module._resolveFilename解析出一个绝对路径
    let filename = Module._resolveFilename(p)
    // * 12.判断是否有缓存，如果有缓存的话，则直接返回缓存
    if(Module._cache[filename]){
      // * 因为实例的exports才是最终暴露出的内容
      return Module._cache[filename].exports
    }
    // * 13.new一个Module实例
    let module = new Module(filename)
    // * 14.加载这个模块
    module._load(filename)
    // * 25.把module存到缓存
    Module._cache[filename] = module
    // * 26.返回module.exprots
    return module.exports
  } catch (e) {
    console.log(e)
  }
}

// 导入模块，并且导入两次，主要是校验是否加载过一次后
// 在有缓存的情况下，会不会直接返回缓存的模块
// 为此特意在module.js中添加了console.log(&quot;执行了&quot;)
// 来看打印了几次
let utils = req(&apos;./module&apos;)
utils = req(&apos;./module&apos;)
utils.sayhello()
</code></pre><p>这样我们就完成了一个简陋版的commonJs，而且我们多次导入这个模块，只会打印出一次<code>执行了</code>，说明了只要缓存中有的，就直接返回，而不是重新加载这个模块<br>这里建议大家一个步骤一个步骤去理解，尝试敲一下代码，这样感悟会更加深</p>
<h4 id="那么为什么exports-xxx-却失效了呢？"><a href="#那么为什么exports-xxx-却失效了呢？" class="headerlink" title="那么为什么exports = xxx 却失效了呢？"></a>那么为什么exports = xxx 却失效了呢？</h4><pre><code>// 从上面源码我们可以看出，实际上
// exports = module.exports = {}
// 但是当我们exports = {name:&quot;CommonJS&quot;}时，
// require出来却获取不到这个对象，这是因为我们在上面源码中，
// req函数（即require）内部return出的是module.exports，而不是exports，
// 当我们exports = { name:&quot;CommonJS&quot; }时，实际上这个exports指向了一个新的对象，
// 而不是module.exports
// 那么我们的exports是不是多余的呢？肯定不是多余的，我们可以这样写
exports.name = &quot;CommonJS&quot; 
// 这样写没有改变exports的指向，而是在exports指向的module.exports对象上新增了属性

// 那么什么时候用exports，什么时候用module.exports呢？
// 如果导出的东西是一个，那么可以用module.exports，如果导出多个属性可以用exports，
// 一般情况下是用module.exports

// 还有一种方式，就是把属性挂载到global上供全局访问，不过不推荐。
</code></pre><h3 id="CommonJS模块总结"><a href="#CommonJS模块总结" class="headerlink" title="CommonJS模块总结"></a>CommonJS模块总结</h3><p><img src="/2018/10/27/剖析node的Common-JS/14.png" alt=""><br>CommonJS模块只能运行再支持此规范的环境之中，nodejs是基于CommonJS规范开发的，因此可以很完美地运行CommonJS模块，然后nodejs不支持ES6的模块规范，所以nodejs的服务器开发大家一般使用CommonJS规范来写。<br>CommonJS模块导入用require，导出用module.exports。导出的对象需注意，如果是静态值，而且非常量，后期可能会有所改动的，请使用函数动态获取，否则无法获取修改值。导入的参数，是可以随意改动的，所以大家使用时要小心。</p>
<h3 id="开发者需要了解的nodejs中require的机制"><a href="#开发者需要了解的nodejs中require的机制" class="headerlink" title="开发者需要了解的nodejs中require的机制"></a><a href="https://juejin.im/post/5bdea6b1518825170f50c485" target="_blank" rel="noopener">开发者需要了解的nodejs中require的机制</a></h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/25/解密webpack-tree-starking/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="武动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/25/解密webpack-tree-starking/" itemprop="url">解密webpack tree-starking</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-25T19:42:07+08:00">
                2018-10-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Tree-Shaking-简介"><a href="#Tree-Shaking-简介" class="headerlink" title="Tree-Shaking 简介"></a>Tree-Shaking 简介</h2><p>最近看了一篇 <strong> <a href="https://juejin.im/post/5a5652d8f265da3e497ff3de" target="_blank" rel="noopener">你的Tree-Shaking并没什么卵用</a> </strong>吓得我赶紧好好研究Tree-Shaking。</p>
<p><code>tree-sharking</code> 是 <code>Webpack 2</code> 后续版本的优化功能，顾名思义，就是将多余的代码给 “摇晃” 掉，在开发中我们经常使用一些第三方库，而这些第三方库只使用了这个库的一部门功能或代码，未使用的代码也要被打包进来，这样出口文件会非常大，<code>tree-sharking</code> 帮我们解决了这个问题，它可以将各个模块中没有使用的方法过滤掉，只对有效代码进行打包。</p>
<p>Tree-Shaking在前端界由rollup首先提出并实现，后续webpack在2.x版本也借助于UglifyJS实现了。自那以后，在各类讨论优化打包的文章中，都能看到Tree-Shaking的身影。</p>
<h4 id="Tree-Shaking的原理"><a href="#Tree-Shaking的原理" class="headerlink" title="Tree-Shaking的原理"></a>Tree-Shaking的原理</h4><p>这里我不多冗余阐述，直接贴百度外卖前端的一篇文章：<strong> <a href="https://juejin.im/post/5a4dc842518825698e7279a9" target="_blank" rel="noopener">Tree-Shaking性能优化实践 - 原理篇</a> </strong>。</p>
<hr>
<h3 id="AST-语法树分析"><a href="#AST-语法树分析" class="headerlink" title="AST 语法树分析"></a>AST 语法树分析</h3><blockquote>
<p>AST 抽象语法树简介</p>
</blockquote>
<p>AST（Abstract Syntax Tree）是源代码的抽象语法结构树状表现形式，Webpack、ESLint、JSX、TypeScript 的编译和模块化规则之间的转化都是通过 AST 来实现对代码的检查、分析以及编译等操作。</p>
<h3 id="JavaScript-语法的-AST-语法树"><a href="#JavaScript-语法的-AST-语法树" class="headerlink" title="JavaScript 语法的 AST 语法树"></a>JavaScript 语法的 AST 语法树</h3><blockquote>
<p>JavaScript 中想要使用 AST 进行开发，要知道抽象成语法树之后的结构是什么，里面的字段名称都代表什么含义以及遍历的规则，<br>我们可以通过在线转换网站<strong><a href="http://esprima.org/demo/parse.html" target="_blank" rel="noopener">http://esprima.org/demo/parse.html</a></strong>将 JS 代码装换成 AST 语法树。</p>
</blockquote>
<p>通过在线编译工具，可以将 <code>function fn(a, b) {}</code>编译为下面的结构。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;type&quot;: &quot;Program&quot;,</span><br><span class="line">    &quot;body&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;type&quot;: &quot;FunctionDeclaration&quot;,</span><br><span class="line">            &quot;id&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                &quot;name&quot;: &quot;fn&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;params&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                    &quot;name&quot;: &quot;a&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                    &quot;name&quot;: &quot;b&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            &quot;body&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;BlockStatement&quot;,</span><br><span class="line">                &quot;body&quot;: []</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;generator&quot;: false,</span><br><span class="line">            &quot;expression&quot;: false,</span><br><span class="line">            &quot;async&quot;: false</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;sourceType&quot;: &quot;script&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>将 JavaScript 语法编译成抽象语法树后，需要对它进行遍历、修该并重新编译，遍历树结构的过程为 “先序深度优先”。</p>
</blockquote>
<h2 id="esprima、estraverse-和-escodegen"><a href="#esprima、estraverse-和-escodegen" class="headerlink" title="esprima、estraverse 和 escodegen"></a>esprima、estraverse 和 escodegen</h2><p><code>esprima</code>、<code>estraverse</code> 和 <code>escodegen</code> 模块是操作 AST 的三个重要模块，也是实现 <code>babel</code> 的核心依赖，下面是分别介绍三个模块的作用。</p>
<h3 id="1、esprima-将-JS-转换成-AST"><a href="#1、esprima-将-JS-转换成-AST" class="headerlink" title="1、esprima 将 JS 转换成 AST"></a>1、esprima 将 JS 转换成 AST</h3><p><strong>esprima 模块的用法如下：</strong></p>
<blockquote>
<p>文件：esprima-test.js</p>
</blockquote>
<pre><code>const esprima = require(&quot;esprima&quot;);

let code = &quot;function fn() {}&quot;;

// 生成语法树
let tree = esprima.parseScript(code);

console.log(tree);

// Script {
//   type: &apos;Program&apos;,
//   body:
//    [ FunctionDeclaration {
//        type: &apos;FunctionDeclaration&apos;,
//        id: [Identifier],
//        params: [],
//        body: [BlockStatement],
//        generator: false,
//        expression: false,
//        async: false } ],
//   sourceType: &apos;script&apos; }
</code></pre><p>通过上面的案例可以看出，通过 <code>esprima</code> 模块的 <code>parseScript</code> 方法将 JS 代码块转换成语法树，代码块需要转换成字符串，也可以通过 <code>parseModule</code> 方法转换一个模块。</p>
<h3 id="2、estraverse-遍历和修改-AST"><a href="#2、estraverse-遍历和修改-AST" class="headerlink" title="2、estraverse 遍历和修改 AST"></a>2、estraverse 遍历和修改 AST</h3><p><strong>查看遍历过程：</strong></p>
<blockquote>
<p>文件：estraverse-test.js</p>
</blockquote>
<pre><code>const esprima = require(&quot;esprima&quot;);
const estraverse = require(&quot;estraverse&quot;);

let code = &quot;function fn() {}&quot;;

// 遍历语法树
estraverse.traverse(esprima.parseScript(code), {
    enter(node) {
console.log(&quot;enter&quot;, node.type);
    },
    leave() {
console.log(&quot;leave&quot;, node.type);
    }
});

// enter Program
// enter FunctionDeclaration
// enter Identifier
// leave Identifier
// enter BlockStatement
// leave BlockStatement
// leave FunctionDeclaration
// leave Program
</code></pre><p>上面代码通过 <code>estraverse</code> 模块的 <code>traverse</code> 方法将 <code>esprima</code> 模块转换的 AST 进行了遍历，并打印了所有的 <code>type</code> 属性并打印，每含有一个 <code>type</code> 属性的对象被叫做一个节点，修改是获取对应的类型并修改该节点中的属性即可。</p>
<p>其实深度遍历 AST 就是在遍历每一层的 <code>type</code> 属性，所以遍历会分为两个阶段，进入阶段和离开阶段，在 <code>estraverse</code> 的 <code>traverse</code> 方法中分别用参数指定的 <code>entry</code> 和 <code>leave</code> 两个函数监听，但是我们一般只使用 <code>entry</code>。</p>
<h3 id="3、escodegen-将-AST-转换成-JS"><a href="#3、escodegen-将-AST-转换成-JS" class="headerlink" title="3、escodegen 将 AST 转换成 JS"></a>3、escodegen 将 AST 转换成 JS</h3><p>下面的案例是一个段 JS 代码块被转换成 AST，并将遍历、修改后的 AST 重新转换成 JS 的全过程。</p>
<blockquote>
<p>文件：escodegen-test.js</p>
</blockquote>
<pre><code>const esprima = require(&quot;esprima&quot;);
const estraverse = require(&quot;estraverse&quot;);
const escodegen = require(&quot;escodegen&quot;);

let code = &quot;function fn() {}&quot;;

// 生成语法树
let tree = esprima.parseScript(code);

// 遍历语法树
estraverse.traverse(tree, {
    enter(node) {
// 修改函数名
if (node.type === &quot;FunctionDeclaration&quot;) {
            node.id.name = &quot;ast&quot;;
        }
    }
});

// 编译语法树
let result = escodegen.generate(tree);

console.log(result);

// function ast() {
// }
</code></pre><p><strong><em>在遍历 AST 的过程中 <code>params</code> 值为数组，没有 <code>type</code> 属性。</em></strong></p>
<hr>
<h2 id="实现-Babel-语法转换插件"><a href="#实现-Babel-语法转换插件" class="headerlink" title="实现 Babel 语法转换插件"></a>实现 Babel 语法转换插件</h2><p>实现语法转换插件需要借助 <code>babel-core</code> 和 <code>babel-types</code> 两个模块，其实这两个模块就是依赖 <code>esprima</code>、<code>estraverse</code> 和 <code>escodegen</code> 的。</p>
<p><strong>使用这两个模块需要安装，命令如下：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install babel-core babel-types</span><br></pre></td></tr></table></figure>
<h3 id="1、plugin-transform-arrow-functions"><a href="#1、plugin-transform-arrow-functions" class="headerlink" title="1、plugin-transform-arrow-functions"></a>1、plugin-transform-arrow-functions</h3><p><code>plugin-transform-arrow-functions</code> 是 Babel 家族成员之一，用于将箭头函数转换 ES5 语法的函数表达式。</p>
<blockquote>
<p>文件：plugin-transform-arrow-functions.js</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">const babel = require(&quot;babel-core&quot;);</span><br><span class="line">const types = require(&quot;babel-types&quot;);</span><br><span class="line"></span><br><span class="line">// 箭头函数代码块</span><br><span class="line">let sumCode = `</span><br><span class="line">const sum = (a, b) =&gt; &#123;</span><br><span class="line">    return a + b;</span><br><span class="line">&#125;`;</span><br><span class="line">let minusCode = `const minus = (a, b) =&gt; a - b;`;</span><br><span class="line"></span><br><span class="line">// 转化 ES5 插件</span><br><span class="line">let ArrowPlugin = &#123;</span><br><span class="line">// 访问者（访问者模式）</span><br><span class="line">    visitor: &#123;</span><br><span class="line">// path 是树的路径</span><br><span class="line">        ArrowFunctionExpression(path) &#123;</span><br><span class="line">// 获取树节点</span><br><span class="line">let node = path.node;</span><br><span class="line"></span><br><span class="line">// 获取参数和函数体</span><br><span class="line">let params = node.params;</span><br><span class="line">let body = node.body;</span><br><span class="line"></span><br><span class="line">// 判断函数体是否是代码块，不是代码块则添加 return 和 &#123;&#125;</span><br><span class="line">if (!types.isBlockStatement(body)) &#123;</span><br><span class="line">let returnStatement = types.returnStatement(body);</span><br><span class="line">                body = types.blockStatement([returnStatement]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">// 生成一个函数表达式树结构</span><br><span class="line">let func = types.functionExpression(null, params, body, false, false);</span><br><span class="line"></span><br><span class="line">// 用新的树结构替换掉旧的树结构</span><br><span class="line">            types.replaceWith(func);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 生成转换后的代码块</span><br><span class="line">let sumResult = babel.transform(sumCode, &#123;</span><br><span class="line">    plugins: [ArrowPlugin]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">let minusResult = babel.transform(minusCode, &#123;</span><br><span class="line">    plugins: [ArrowPlugin]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">console.log(sumResult.code);</span><br><span class="line">console.log(minusResult.code);</span><br><span class="line"></span><br><span class="line">// let sum = function (a, b) &#123;</span><br><span class="line">//   return a + b;</span><br><span class="line">// &#125;;</span><br><span class="line">// let minus = function (a, b) &#123;</span><br><span class="line">//   return a - b;</span><br><span class="line">// &#125;;</span><br></pre></td></tr></table></figure>
<p>我们主要使用 <code>babel-core</code> 的 <code>transform</code> 方法将 AST 转化成代码块，第一个参数为转换前的代码块（字符串），第二个参数为配置项，其中 <code>plugins</code> 值为数组，存储修改 <code>babal-core</code> 转换的 AST 的插件（对象），使用 <code>transform</code> 方法将旧的 AST 处理成新的代码块后，返回值为一个对象，对象的 <code>code</code> 属性为转换后的代码块（字符串）。</p>
<p>内部修改通过 <code>babel-types</code> 模块提供的方法实现，API 可以到 <a href="https://github.com/babel/babel/tree/6.x/packages/babel-types" target="_blank" rel="noopener">https://github.com/babel/babel/tree/6.x/packages/babel-types</a> 中查看。</p>
<p><code>ArrowPlugin</code> 就是传入 <code>transform</code> 方法的插件，必须含有 <code>visitor</code> 属性（固定），值同为对象，用于存储修改语法树的方法，方法名要严格按照 API，对应的方法会修改 AST 对应的节点。</p>
<p>在 <code>types.functionExpression</code> 方法中参数分别代表，函数名（匿名函数为 <code>null</code>）、函数参数（必填）、函数体（必填）、是否为 <code>generator</code> 函数（默认 <code>false</code>）、是否为 <code>async</code> 函数（默认 <code>false</code>），返回值为修改后的 AST，<code>types.replaceWith</code> 方法用于替换 AST，参数为新的 AST。</p>
<h3 id="2、plugin-transform-classes"><a href="#2、plugin-transform-classes" class="headerlink" title="2、plugin-transform-classes"></a>2、plugin-transform-classes</h3><p><code>plugin-transform-classes</code> 也是 Babel 家族中的成员之一，用于将 ES6 的 <code>class</code> 类转换成 ES5 的构造函数。</p>
<blockquote>
<p>文件：plugin-transform-classes.js</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">const babel = require(&quot;babel-core&quot;);</span><br><span class="line">const types = require(&quot;babel-types&quot;);</span><br><span class="line"></span><br><span class="line">// 类</span><br><span class="line">let code = `</span><br><span class="line">class Person &#123;</span><br><span class="line">    constructor(name) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    getName () &#123;</span><br><span class="line">        return this.name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;`;</span><br><span class="line"></span><br><span class="line">// 将类转化 ES5 构造函数插件</span><br><span class="line">let ClassPlugin = &#123;</span><br><span class="line">    visitor: &#123;</span><br><span class="line">        ClassDeclaration(path) &#123;</span><br><span class="line">let node = path.node;</span><br><span class="line">let classList = node.body.body;</span><br><span class="line"></span><br><span class="line">// 将取到的类名转换成标识符 &#123; type: &apos;Identifier&apos;, name: &apos;Person&apos; &#125;</span><br><span class="line">let className = types.identifier(node.id.name);</span><br><span class="line">let body = types.blockStatement([]);</span><br><span class="line">let func = types.functionDeclaration(className, [], body, false, false);</span><br><span class="line">            path.replaceWith(func);</span><br><span class="line"></span><br><span class="line">// 用于存储多个原型方法</span><br><span class="line">let es5Func = [];</span><br><span class="line"></span><br><span class="line">// 获取 class 中的代码体</span><br><span class="line">            classList.forEach((item, index) =&gt; &#123;</span><br><span class="line">// 函数的代码体</span><br><span class="line">let body = classList[index].body;</span><br><span class="line"></span><br><span class="line">// 获取参数</span><br><span class="line">let params = item.params.length ? item.params.map(val =&gt; val.name) : [];</span><br><span class="line"></span><br><span class="line">// 转化参数为标识符</span><br><span class="line">                params = types.identifier(params);</span><br><span class="line"></span><br><span class="line">// 判断是否是 constructor，如果构造函数那就生成新的函数替换</span><br><span class="line">if (item.kind === &quot;constructor&quot;) &#123;</span><br><span class="line">// 生成一个构造函数树结构</span><br><span class="line">                    func = types.functionDeclaration(className, [params], body, false, false);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">// 其他情况是原型方法</span><br><span class="line">let proto = types.memberExpression(className, types.identifier(&quot;prototype&quot;));</span><br><span class="line"></span><br><span class="line">// 左侧层层定义标识符 Person.prototype.getName</span><br><span class="line">let left = types.memberExpression(proto, types.identifier(item.key.name));</span><br><span class="line"></span><br><span class="line">// 右侧定义匿名函数</span><br><span class="line">let right = types.functionExpression(null, [params], body, false, false);</span><br><span class="line"></span><br><span class="line">// 将左侧和右侧进行合并并存入数组</span><br><span class="line">                    es5Func.push(types.assignmentExpression(&quot;=&quot;, left, right));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">// 如果没有原型方法，直接替换</span><br><span class="line">if (es5Func.length === 0) &#123;</span><br><span class="line">                path.replaceWith(func);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                es5Func.push(func);</span><br><span class="line">// 替换 n 个节点</span><br><span class="line">                path.replaceWithMultiple(es5Func);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 生成转换后的代码块</span><br><span class="line">result = babel.transform(code, &#123;</span><br><span class="line">    plugins: [ClassPlugin]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">console.log(result.code);</span><br><span class="line"></span><br><span class="line">// Person.prototype.getName = function () &#123;</span><br><span class="line">//     return this.name;</span><br><span class="line">// &#125;</span><br><span class="line">// function Person(name) &#123;</span><br><span class="line">//     this.name = name;</span><br><span class="line">// &#125;</span><br></pre></td></tr></table></figure>
<p>上面这个插件的实现要比 <code>plugin-transform-arrow-functions</code> 复杂一些，归根结底还是将要互相转换的 ES6 和 ES5 语法树做对比，找到他们的不同，并使用 <code>babel-types</code> 提供的 API 对语法树对应的节点属性进行修改并替换语法树，值得注意的是 <code>path.replaceWithMultiple</code> 与 <code>path.replaceWith</code> 不同，参数为一个数组，数组支持多个语法树结构，可根据具体修改语法树的场景选择使用，也可根据不同情况使用不同的替换方法。</p>
<blockquote>
<p>通过本节我们了解了什么是 AST 抽象语法树、抽象语法树在 JavaScript 中的体现以及在 NodeJS 中用于生成、遍历和修改 AST 抽象语法树的核心依赖，并通过使用 <code>babel-core</code> 和 <code>babel-types</code> 两个模块简易模拟了 ES6 新特性转换为 ES5 语法的过程，希望可以为后面自己实现一些编译插件提供了思路。</p>
</blockquote>
<hr>
<p>假设我们现在使用了 ElementUI 库的两个组件，通常会使用解构赋值来引入。</p>
<blockquote>
<p>优化前</p>
</blockquote>
<pre><code>import { Button, Alert } from&quot;element-ui&quot;;
</code></pre><p>这样引用资源， Webpack 在打包的时候会找到 <code>element-ui</code> 并把里面所有的代码全部打包到出口文件，我们只使用了两个组件，全部打包不是我们所希望的，<code>tree-sharking</code> 是通过在 Webpack 中配置 <code>babel-plugin-import</code> 插件来实现的，它可以将解构的代码转换成下面的形式。</p>
<blockquote>
<p>优化后</p>
</blockquote>
<pre><code>import Button from&quot;element-ui/lib/button&quot;;
import Alert from&quot;element-ui/lib/Alert&quot;;
</code></pre><p>转化后会去 <code>node_modules</code> 中的 <code>element-ui</code> 模块找到 <code>Button</code> 和 <code>Alert</code> 两个组件对应的文件，并打包到出口文件中。</p>
<p>通过上面的转换可以看出，其实 <code>tree-sharking</code> 的实现原理是通过改变 AST 语法树的结构来实现的，如果不了解抽象语法树可以参考 <a href="https://www.pandashen.com/2018/07/25/20180725130233/" target="_blank" rel="noopener">AST 抽象语法树</a>，</p>
<blockquote>
<p>优化前的 AST 语法树</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;type&quot;: &quot;Program&quot;,</span><br><span class="line">    &quot;body&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;type&quot;: &quot;ImportDeclaration&quot;,</span><br><span class="line">            &quot;specifiers&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;ImportSpecifier&quot;,</span><br><span class="line">                    &quot;local&quot;: &#123;</span><br><span class="line">                        &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                        &quot;name&quot;: &quot;Button&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &quot;imported&quot;: &#123;</span><br><span class="line">                        &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                        &quot;name&quot;: &quot;Button&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;ImportSpecifier&quot;,</span><br><span class="line">                    &quot;local&quot;: &#123;</span><br><span class="line">                        &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                        &quot;name&quot;: &quot;Alert&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &quot;imported&quot;: &#123;</span><br><span class="line">                        &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                        &quot;name&quot;: &quot;Alert&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            &quot;source&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;Literal&quot;,</span><br><span class="line">                &quot;value&quot;: &quot;element-ui&quot;,</span><br><span class="line">                &quot;raw&quot;: &quot;\&quot;element-ui\&quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;sourceType&quot;: &quot;module&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>优化后的 AST 语法树</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> &#123;</span><br><span class="line">    &quot;type&quot;: &quot;Program&quot;,</span><br><span class="line">    &quot;body&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;type&quot;: &quot;ImportDeclaration&quot;,</span><br><span class="line">            &quot;specifiers&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;ImportDefaultSpecifier&quot;,</span><br><span class="line">                    &quot;local&quot;: &#123;</span><br><span class="line">                        &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                        &quot;name&quot;: &quot;Button&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            &quot;source&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;Literal&quot;,</span><br><span class="line">                &quot;value&quot;: &quot;element-ui/lib/button&quot;,</span><br><span class="line">                &quot;raw&quot;: &quot;\&quot;element-ui/lib/button\&quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;type&quot;: &quot;ImportDeclaration&quot;,</span><br><span class="line">            &quot;specifiers&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;ImportDefaultSpecifier&quot;,</span><br><span class="line">                    &quot;local&quot;: &#123;</span><br><span class="line">                        &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                        &quot;name&quot;: &quot;Alert&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            &quot;source&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;Literal&quot;,</span><br><span class="line">                &quot;value&quot;: &quot;element-ui/lib/Alert&quot;,</span><br><span class="line">                &quot;raw&quot;: &quot;\&quot;element-ui/lib/Alert\&quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;sourceType&quot;: &quot;module&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的语法树对比，可以看出在优化前 <code>body</code> 里面只有一个对象，使用的组件信息存在 <code>specifiers</code> 里，<code>source</code> 指向了 <code>element-ui</code>，而在优化后，将两个组件分别拆成了两个对象存在 <code>body</code> 中，每个对象的的 <code>specifiers</code> 只存储一个组件，并在 <code>source</code> 里面指向了当前组件对应的路径。</p>
<hr>
<h2 id="模拟-tree-starking"><a href="#模拟-tree-starking" class="headerlink" title="模拟 tree-starking"></a>模拟 tree-starking</h2><p>既然我们已经清楚要修改语法树的位置，下面就使用 AST 来模拟 <code>tree-sharking</code> 功能，对语法树的操作是依赖于 <code>babel-core</code> 和 <code>babel-types</code> 两个核心模块的，下面先安装依赖。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install babel-core babel-types</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>文件：babel-plugin-my-import.js</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">const babel = require(&quot;babel-core&quot;);</span><br><span class="line">const types = require(&quot;babel-types&quot;);</span><br><span class="line"></span><br><span class="line">let code = `import &#123; Button, Alert &#125; from &quot;element-ui&quot;`;</span><br><span class="line"></span><br><span class="line">let importPlugin = &#123;</span><br><span class="line">    visitor: &#123;</span><br><span class="line">        ImportDeclaration(path) &#123;</span><br><span class="line">            let node = path.node;</span><br><span class="line">            let source = node.source.value;</span><br><span class="line">            let specifiers = node.specifiers;</span><br><span class="line"></span><br><span class="line">            // 判断是否是默认导出，其中一个不是默认导出，则都不是默认导出</span><br><span class="line">            if (!types.isImportDefaultSpecifier(specifiers[0])) &#123;</span><br><span class="line">                // 如果不是默认导出，则需要转换</span><br><span class="line">                specifiers = specifiers.map(specifier =&gt; &#123;</span><br><span class="line">                    // 数组内容：当前默认导出的标识、从哪里导入</span><br><span class="line">                    return types.importDeclaration(</span><br><span class="line">                        [types.importDefaultSpecifier(specifier.local)],</span><br><span class="line">                        types.stringLiteral(`$&#123;source&#125;/lib/$&#123;specifier.local.name.toLowerCase()&#125;`)</span><br><span class="line">                    );</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                // 替换树结构</span><br><span class="line">                path.replaceWithMultiple(specifiers);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">let result = babel.transform(code, &#123;</span><br><span class="line">    plugins: [importPlugin]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">console.log(result.code);</span><br><span class="line"></span><br><span class="line">// import Button from &quot;element-ui/lib/button&quot;;</span><br><span class="line">// import Alert from &quot;element-ui/lib/alert&quot;;</span><br></pre></td></tr></table></figure>
<p>通过上面的代码可以发现我们使用 <code>babel-core</code> 和 <code>babel-types</code> 两个模块的核心方法对语法书进行了遍历、修改和替换，更详细的 API 可以查看 <a href="https://github.com/babel/babel/tree/6.x/packages/babel-types" target="_blank" rel="noopener">https://github.com/babel/babel/tree/6.x/packages/babel-types</a>。</p>
<hr>
<h2 id="结合-Webpack-使用插件"><a href="#结合-Webpack-使用插件" class="headerlink" title="结合 Webpack 使用插件"></a>结合 Webpack 使用插件</h2><p>前面只是验证了 <code>tree-sharking</code> 中 JS 语法的转换过程，接下来将上面的代码转换成插件配合 Webpack 使用，来彻底感受 <code>tree-sharking</code> 的工作过程。</p>
<blockquote>
<p>文件：~node_modules/babel-plugin-my-import.js</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">const babel = require(&quot;babel-core&quot;);</span><br><span class="line">const types = require(&quot;babel-types&quot;);</span><br><span class="line"></span><br><span class="line">let importPlugin = &#123;</span><br><span class="line">    visitor: &#123;</span><br><span class="line">        ImportDeclaration(path) &#123;</span><br><span class="line">            let node = path.node;</span><br><span class="line">            let source = node.source.value;</span><br><span class="line">            let specifiers = node.specifiers;</span><br><span class="line"></span><br><span class="line">            // 判断是否是默认导出，其中一个不是默认导出，则都不是默认导出</span><br><span class="line">            if (!types.isImportDefaultSpecifier(specifiers[0])) &#123;</span><br><span class="line">                // 如果不是默认导出，则需要转换</span><br><span class="line">                specifiers = specifiers.map(specifier =&gt; &#123;</span><br><span class="line">                    // 数组内容：当前默认导出的标识、从哪里导入</span><br><span class="line">                    return types.importDeclaration(</span><br><span class="line">                        [types.importDefaultSpecifier(specifier.local)],</span><br><span class="line">                        types.stringLiteral(`$&#123;source&#125;/lib/$&#123;specifier.local.name.toLowerCase()&#125;`)</span><br><span class="line">                    );</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                // 替换树解构</span><br><span class="line">                path.replaceWithMultiple(specifiers);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">module.exports = importPlugin;</span><br></pre></td></tr></table></figure>
<p>上面删掉了多余的测试代码，将模块中的 <code>importPlugin</code> 插件导出，并把 <code>babel-plugin-my-import.js</code> 移入了 <code>node_modules</code> 当中。</p>
<p><strong>接下来安装需要的依赖：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install webpack webpack-cli babel-loader babel-presets-env</span><br><span class="line">npm install vue element-ui --save</span><br></pre></td></tr></table></figure></p>
<p>安装完依赖，写一个要编译的文件，使用 Webpack 进行打包，查看使用插件前和使用插件后出口文件的大小。<br>文件：import.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import Vue from&quot;vue&quot;;</span><br><span class="line">import &#123; Button, Alert &#125; from&quot;element-ui&quot;;</span><br></pre></td></tr></table></figure></p>
<p>下面来写一个简单的 Webpack 配置文件。</p>
<blockquote>
<p>文件：webpcak.config.js</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">    module.exports = &#123;</span><br><span class="line">    mode: &quot;development&quot;,</span><br><span class="line">    entry: &quot;import.js&quot;,</span><br><span class="line">    output: &#123;</span><br><span class="line">        filename: &quot;bundle.js&quot;,</span><br><span class="line">        path: __dirname</span><br><span class="line">    &#125;,</span><br><span class="line">    module: &#123;</span><br><span class="line">        rules: [&#123;</span><br><span class="line">            test: /\.js$/,</span><br><span class="line">            use: &#123;</span><br><span class="line">                loader: &quot;babel-loader&quot;,</span><br><span class="line">                options: &#123;</span><br><span class="line">                    presets: [</span><br><span class="line">                        &quot;env&quot;,</span><br><span class="line">                    ],</span><br><span class="line">                    plugins: [</span><br><span class="line">                        // 插件：不使用插件打包注释掉该行即可</span><br><span class="line">                        [&quot;my-import&quot;, &#123; libararyName: &quot;element-ui&quot; &#125;]</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            exclude: /node_modules/</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>为了防止 <code>babel</code> 相关的依赖升级 <code>7.0</code> 后出现一些问题导致 Webpack 无法启动，再此贴出 <code>package.json</code> 文件，按照对应版本下载依赖保证上面 Webpack 配置生效。</p>
<blockquote>
<p>文件：package.json</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> &quot;name&quot;: &quot;ast-lesson&quot;,</span><br><span class="line"> &quot;version&quot;: &quot;1.0.0&quot;,</span><br><span class="line"> &quot;description&quot;: &quot;tree-starking&quot;,</span><br><span class="line"> &quot;main&quot;: &quot;index.js&quot;,</span><br><span class="line"> &quot;scripts&quot;: &#123;</span><br><span class="line"> &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><br><span class="line">   &#125;,</span><br><span class="line"> &quot;keywords&quot;: [],</span><br><span class="line"> &quot;author&quot;: &quot;&quot;,</span><br><span class="line"> &quot;license&quot;: &quot;ISC&quot;,</span><br><span class="line"> &quot;dependencies&quot;: &#123;</span><br><span class="line"> &quot;babel-core&quot;: &quot;^6.26.3&quot;,</span><br><span class="line"> &quot;babel-loader&quot;: &quot;^7.1.5&quot;,</span><br><span class="line"> &quot;babel-preset-env&quot;: &quot;^1.7.0&quot;,</span><br><span class="line"> &quot;babel-types&quot;: &quot;^6.26.0&quot;,</span><br><span class="line"> &quot;escodegen&quot;: &quot;^1.10.0&quot;,</span><br><span class="line"> &quot;esprima&quot;: &quot;^4.0.0&quot;,</span><br><span class="line"> &quot;estraverse&quot;: &quot;^4.2.0&quot;,</span><br><span class="line"> &quot;webpack&quot;: &quot;^4.16.0&quot;,</span><br><span class="line"> &quot;webpack-cli&quot;: &quot;^3.0.8&quot;</span><br><span class="line">   &#125;,</span><br><span class="line"> &quot;devDependencies&quot;: &#123;</span><br><span class="line"> &quot;vue&quot;: &quot;^2.5.17&quot;,</span><br><span class="line"> &quot;element-ui&quot;: &quot;^2.4.6&quot;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="对比使用插件前后的出口文件"><a href="#对比使用插件前后的出口文件" class="headerlink" title="对比使用插件前后的出口文件"></a>对比使用插件前后的出口文件</h2><p>接下来分别在使用插件和不使用插件时执行打包命令，查看出口文件 <code>bondle.js</code> 的大小。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx webpack</span><br></pre></td></tr></table></figure></p>
<p>使用 <code>babel-plugin-my-import</code> 前：</p>
<p><a href="/2018/07/26/20180726122146/before-babel-plugin.jpg"><img src="/2018/10/25/解密webpack-tree-starking/before-babel-plugin.jpg" alt="使用 tree-starking 之前"></a></p>
<p>使用 <code>babel-plugin-my-import</code> 后：</p>
<p><a href="/2018/07/26/20180726122146/after-babel-plugin.jpg"><img src="/2018/10/25/解密webpack-tree-starking/after-babel-plugin.jpg" alt="使用 tree-starking 之后"></a></p>
<p>通过对比，可以看到使用 <code>tree-sharking</code> 即我们自己实现的 <code>babel-plugin-my-import</code> 插件后，打包的出口文件大大减小，其原因是将引入第三方库没有使用的代码全都过滤掉了，只打包了有效代码。</p>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上面对 Webpack 的 <code>tree-sharking</code> 进行了分析，并模拟 <code>babel-plugin-import</code> 简易的实现了一版 <code>tree-sharking</code> 的优化插件，这个过程中相信大家已经了解了 <code>tree-sharking</code> 的原理以及实现类似插件的思路，并已经具备了开发类似插件的基本条件，最后还有一点需要补充，<code>tree-sharking</code> 优化的方式是根据 ES6 语法 <code>import</code> “静态” 引入的特性实现的，如果要说 <code>tree-sharking</code> 很强大，还不如说 ES6 模块化规范 “静态” 引入的特性强大，正由于是基于 “静态” 引入，所以目前 <code>tree-sharking</code> 只支持遍历一层 <code>import</code> 关键字。</p>
<hr>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/10/koa-bodyparser中间件模拟/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="武动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/10/koa-bodyparser中间件模拟/" itemprop="url">koa-bodyparser中间件模拟</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-10T23:05:34+08:00">
                2018-10-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><code>Koa 2.x</code> 版本是当下最流行的 NodeJS 框架，<code>Koa 2.0</code> 的源码特别精简，不像 <code>Express</code> 封装的功能那么多，所以大部分的功能都是由 <code>Koa</code> 开发团队（同 <code>Express</code> 是一家出品）和社区贡献者针对 <code>Koa</code> 对 NodeJS 的封装特性实现的中间件来提供的，用法非常简单，就是引入中间件，并调用 <code>Koa</code> 的 <code>use</code> 方法使用在对应的位置，这样就可以通过在内部操作 <code>ctx</code> 实现一些功能，我们接下来就讨论常用中间件的实现原理以及我们应该如何开发一个 <code>Koa</code> 中间件供自己和别人使用。</p>
<h2 id="Koa-的洋葱模型介绍"><a href="#Koa-的洋葱模型介绍" class="headerlink" title="Koa 的洋葱模型介绍"></a>Koa 的洋葱模型介绍</h2><p>我们本次不对洋葱模型的实现原理进行过多的刨析，主要根据 API 的使用方式及洋葱模型分析中间件是如何工作的。</p>
<pre><code>// 洋葱模型特点// 引入 Koa
const Koa = require(&quot;koa&quot;);

// 创建服务
const app = new Koa();

app.use(async (ctx, next) =&gt; {
    console.log(1);
    await next();
    console.log(2);
});

app.use(async (ctx, next) =&gt; {
    console.log(3);
    await next();
    console.log(4);
});

app.use(async (ctx, next) =&gt; {
    console.log(5);
    await next();
    console.log(6);
});

// 监听服务
app.listen(3000);

// 1
// 3
// 5
// 6
// 4
// 2
</code></pre><p>我们知道 <code>Koa</code> 的 <code>use</code> 方法是支持异步的，所以为了保证正常的按照洋葱模型的执行顺序执行代码，需要在调用 <code>next</code> 的时候让代码等待，等待异步结束后再继续向下执行，所以我们在 <code>Koa</code> 中都是建议使用 <code>async/await</code> 的，引入的中间件都是在 <code>use</code> 方法中调用，由此我们可以分析出每一个 <code>Koa</code> 的中间件都是返回一个 <code>async</code> 函数的。</p>
<h2 id="koa-bodyparser-中间件模拟"><a href="#koa-bodyparser-中间件模拟" class="headerlink" title="koa-bodyparser 中间件模拟"></a>koa-bodyparser 中间件模拟</h2><p>想要分析 <code>koa-bodyparser</code> 的原理首先需要知道用法和作用，<code>koa-bodyparser</code> 中间件是将我们的 <code>post</code> 请求和表单提交的查询字符串转换成对象，并挂在 <code>ctx.request.body</code> 上，方便我们在其他中间件或接口处取值，使用前需提前安装。</p>
<blockquote>
<p>npm install koa koa-bodyparser</p>
</blockquote>
<p><strong>koa-bodyparser 具体用法如下：</strong></p>
<pre><code>// koa-bodyparser 的用法
const Koa = require(&quot;koa&quot;);
const bodyParser = require(&quot;koa-bodyparser&quot;);

const app = new Koa();

// 使用中间件
app.use(bodyParser());

app.use(async (ctx, next) =&gt; {
    if (ctx.path === &quot;/&quot; &amp;&amp; ctx.method === &quot;POST&quot;) {
        // 使用中间件后 ctx.request.body 属性自动加上了 post 请求的数据
        console.log(ctx.request.body);
    }
});

app.listen(3000);
</code></pre><p>根据用法我们可以看出 <code>koa-bodyparser</code> 中间件引入的其实是一个函数，我们把它放在了 <code>use</code> 中执行，根据 <code>Koa</code> 的特点，我们推断出 <code>koa-bodyparser</code> 的函数执行后应该给我们返回了一个 <code>async</code> 函数，下面是我们模拟实现的代码。</p>
<pre><code>// 文件：my-koa-bodyparser.js
const querystring = require(&quot;querystring&quot;);

module.exports = functionbodyParser() {
    returnasync (ctx, next) =&gt; {
        await new Promise((resolve, reject) =&gt; {
            // 存储数据的数组
            let dataArr = [];

            // 接收数据
            ctx.req.on(&quot;data&quot;, data =&gt; dataArr.push(data));

            // 整合数据并使用 Promise 成功
            ctx.req.on(&quot;end&quot;, () =&gt; {
                // 获取请求数据的类型 json 或表单
                let contentType = ctx.get(&quot;Content-Type&quot;);

                // 获取数据 Buffer 格式
                let data = Buffer.concat(dataArr).toString();

                if (contentType === &quot;application/x-www-form-urlencoded&quot;) {
                    // 如果是表单提交，则将查询字符串转换成对象赋值给 ctx.request.body
                    ctx.request.body = querystring.parse(data);
                } elseif (contentType === &quot;applaction/json&quot;) {
                    // 如果是 json，则将字符串格式的对象转换成对象赋值给 ctx.request.body
                    ctx.request.body = JSON.parse(data);
                }

                // 执行成功的回调
                resolve();
            });
        });

        // 继续向下执行
        await next();
    };
};
</code></pre><p>在上面代码中由几点是需要我们注意的，即 <code>next</code> 的调用以及为什么通过流接收数据、处理数据和将数据挂在 <code>ctx.request.body</code> 要在 Promise 中进行。</p>
<p><strong>首先是 <code>next</code> 的调用，我们知道 <code>Koa</code> 的 <code>next</code> 执行，其实就是在执行下一个中间件的函数，即下一个 <code>use</code> 中的 <code>async</code> 函数，为了保证后面的异步代码执行完毕后再继续执行当前的代码，所以我们需要使用 <code>await</code> 进行等待，其次就是数据从接收到挂在 <code>ctx.request.body</code> 都在 Promise 中执行，是因为在接收数据的操作是异步的，整个处理数据的过程需要等待异步完成后，再把数据挂在 <code>ctx.request.body</code> 上，可以保证我们在下一个 <code>use</code> 的 <code>async</code> 函数中可以在 <code>ctx.request.body</code> 上拿到数据，所以我们使用 <code>await</code> 等待一个 Promise 成功后再执行 <code>next</code>。</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/08/基于IntersectionObserver的图片懒加载实现/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="武动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/08/基于IntersectionObserver的图片懒加载实现/" itemprop="url">基于IntersectionObserver的图片懒加载实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-08T21:54:27+08:00">
                2018-10-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class="line">  &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot;&gt;</span><br><span class="line">  &lt;title&gt;图片懒加载&lt;/title&gt;</span><br><span class="line">  &lt;link href=&quot;./css/style.css&quot; rel=&quot;stylesheet&quot;/&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div id=&quot;view&quot;&gt;</span><br><span class="line">    &lt;img data-src=&quot;http://img.pconline.com.cn/images/upload/upc/tx/wallpaper/1301/05/c0/17135331_1357355776882.jpg&quot; class=&quot;lazy-image&quot;/&gt;</span><br><span class="line">    &lt;img data-src=&quot;http://f.hiphotos.baidu.com/zhidao/pic/item/eac4b74543a982267a3d54978a82b9014b90eb86.jpg&quot; class=&quot;lazy-image&quot;/&gt;</span><br><span class="line">    &lt;img data-src=&quot;http://pic1.win4000.com/wallpaper/2/58b61f7dc6c1d.jpg&quot; class=&quot;lazy-image&quot;/&gt;</span><br><span class="line">    &lt;img data-src=&quot;http://file03.16sucai.com/2017/1100/16sucai_p20161106032_0c2.JPG&quot; class=&quot;lazy-image&quot;/&gt;</span><br><span class="line">    &lt;img data-src=&quot;http://imgsrc.baidu.com/image/c0%3Dpixel_huitu%2C0%2C0%2C294%2C40/sign=5a7938d38acb39dbd5cd6f16b96e6c48/aec379310a55b3196c79de4c48a98226cffc1702.jpg&quot; class=&quot;lazy-image&quot;/&gt;</span><br><span class="line">    &lt;img data-src=&quot;http://c.hiphotos.baidu.com/zhidao/pic/item/8d5494eef01f3a2987a8062f9f25bc315d607ceb.jpg&quot; class=&quot;lazy-image&quot;/&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;link href=&quot;./css/style.css&quot; rel=&quot;stylesheet&quot;/&gt;</span><br><span class="line">&lt;script src=&quot;js/lazy-image.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  console.log(document.documentElement.clientHeight)</span><br><span class="line">  new LazyImage(&apos;.lazy-image&apos;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">class LazyImage &#123;</span><br><span class="line">    constructor(selector) &#123;</span><br><span class="line">      // 懒记载图片列表，将伪数组转为数组，以便可以使用数组的api</span><br><span class="line">      this.lazyImages = Array.prototype.slice.call(document.querySelectorAll(selector))</span><br><span class="line">      this.init()</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    inViewShow() &#123;</span><br><span class="line">      // 不支持IntersectionObserver api的情况下判断图片是否出现在可视区域内</span><br><span class="line">      let len = this.lazyImages.length</span><br><span class="line">      for(let i = 0; i &lt; len; i++) &#123;</span><br><span class="line">        let lazyImage = this.lazyImages[i]</span><br><span class="line">        const rect = lazyImage.getBoundingClientRect()</span><br><span class="line">        // 出现在视野的时候加载图片</span><br><span class="line">        if(rect.top &lt; document.documentElement.clientHeight) &#123;</span><br><span class="line">          lazyImage.src = lazyImage.dataset.src</span><br><span class="line">          // 移除掉已经显示的</span><br><span class="line">          this.lazyImages.splice(i, 1)</span><br><span class="line">          len--</span><br><span class="line">          i--</span><br><span class="line">          if(this.lazyImages.length === 0) &#123;</span><br><span class="line">            // 如果全部都加载完 则去掉滚动事件监听</span><br><span class="line">            document.removeEventListener(&apos;scroll&apos;, this._throttleFn)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    throttle(fn, delay = 15, mustRun = 30) &#123;</span><br><span class="line">      let t_start = null</span><br><span class="line">      let timer = null</span><br><span class="line">      let context = this</span><br><span class="line">      return function() &#123;</span><br><span class="line">        let t_current = +(new Date())</span><br><span class="line">        let args = Array.prototype.slice.call(arguments)</span><br><span class="line">        clearTimeout(timer)</span><br><span class="line">        if(!t_start) &#123;</span><br><span class="line">          t_start = t_current</span><br><span class="line">        &#125;</span><br><span class="line">        if(t_current - t_start &gt; mustRun) &#123;</span><br><span class="line">          fn.apply(context, args)</span><br><span class="line">          t_start = t_current</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          timer = setTimeout(() =&gt; &#123;</span><br><span class="line">            fn.apply(context, args)</span><br><span class="line">          &#125;, delay)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    init() &#123;</span><br><span class="line">      // 通过IntersectionObserver api判断图片是否出现在可视区域内，不需要监听Scroll来判断</span><br><span class="line">      if (&quot;IntersectionObserver&quot; in window) &#123;</span><br><span class="line">        let lazyImageObserver = new IntersectionObserver((entries, observer) =&gt; &#123;</span><br><span class="line">          entries.forEach((entry, index) =&gt; &#123;</span><br><span class="line">            // 如果元素可见</span><br><span class="line">            if (entry.isIntersecting) &#123;</span><br><span class="line">              let lazyImage = entry.target</span><br><span class="line">              lazyImage.src = lazyImage.dataset.src</span><br><span class="line">              lazyImageObserver.unobserve(lazyImage)</span><br><span class="line">              // this.lazyImages.splice(index, 1)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">        this.lazyImages.forEach(function(lazyImage) &#123;</span><br><span class="line">          lazyImageObserver.observe(lazyImage);</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        this.inViewShow()</span><br><span class="line">        this._throttleFn = this.throttle(this.inViewShow)</span><br><span class="line">        document.addEventListener(&apos;scroll&apos;, this._throttleFn)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">html,body &#123;</span><br><span class="line">  height: 100%;</span><br><span class="line">  width: 100%;</span><br><span class="line">  margin: 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#view &#123;</span><br><span class="line">  color: red;</span><br><span class="line">  width: 200px;</span><br><span class="line">  height: 300px</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.lazy-image &#123;</span><br><span class="line">  background: url(&apos;../img/loading.gif&apos;) no-repeat center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">img&#123;</span><br><span class="line">  margin-top: 100px;</span><br><span class="line">  background-size: cover;</span><br><span class="line">  background-position: center;</span><br><span class="line">  width: 490px;</span><br><span class="line">  height: 242px;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/05/Babel-将-Generator-编译成了什么/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="武动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/05/Babel-将-Generator-编译成了什么/" itemprop="url">Babel 将 Generator 编译成了什么</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-05T21:36:19+08:00">
                2018-10-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文就是简单介绍下 Generator 语法编译后的代码。</p>
<h2 id="Generator"><a href="#Generator" class="headerlink" title="Generator"></a>Generator</h2><pre><code>function* helloWorldGenerator() {
  yield&apos;hello&apos;;
  yield&apos;world&apos;;
  return&apos;ending&apos;;
}
</code></pre><p>我们打印下执行的结果：</p>
<pre><code>var hw = helloWorldGenerator();

console.log(hw.next()); // {value: &quot;hello&quot;, done: false}console.log(hw.next()); // {value: &quot;world&quot;, done: false}console.log(hw.next()); // {value: &quot;ending&quot;, done: true}console.log(hw.next()); // {value: undefined, done: true}
</code></pre><h2 id="Babel"><a href="#Babel" class="headerlink" title="Babel"></a>Babel</h2><p>具体的执行过程就不说了，我们直接在 Babel 官网的 <a href="https://babeljs.io/repl" target="_blank" rel="noopener">Try it out</a> 粘贴上述代码，然后查看代码被编译成了什么样子：</p>
<pre><code>/**
 * 我们就称呼这个版本为简单编译版本吧
 */var _marked = /*#__PURE__*/ regeneratorRuntime.mark(helloWorldGenerator);

functionhelloWorldGenerator() {
  return regeneratorRuntime.wrap(
    functionhelloWorldGenerator$(_context) {
      while (1) {
        switch ((_context.prev = _context.next)) {
          case0:
            _context.next = 2;
            return&quot;hello&quot;;

          case2:
            _context.next = 4;
            return&quot;world&quot;;

          case4:
            return _context.abrupt(&quot;return&quot;, &quot;ending&quot;);

          case5:
          case&quot;end&quot;:
            return _context.stop();
        }
      }
    },
    _marked,
    this
  );
}
</code></pre><p>猛一看，好像编译后的代码还蛮少的，但是细细一看，编译后的代码肯定是不能用的呀，<code>regeneratorRuntime</code> 是个什么鬼？哪里有声明呀？<code>mark</code> 和 <code>wrap</code> 方法又都做了什么？</p>
<p>难道就不能编译一个完整可用的代码吗？</p>
<h2 id="regenerator"><a href="#regenerator" class="headerlink" title="regenerator"></a>regenerator</h2><p>如果你想看到完整可用的代码，你可以使用 <a href="https://github.com/facebook/regenerator" target="_blank" rel="noopener">regenerator</a>，这是 facebook 下的一个工具，用于编译 ES6 的 generator 函数。</p>
<p>我们先安装一下 regenerator：</p>
<pre><code>npm install -g regenerator
</code></pre><p>然后新建一个 generator.js 文件，里面的代码就是文章最一开始的代码，我们执行命令：</p>
<pre><code>regenerator --include-runtime generator.js &gt; generator-es5.js
</code></pre><p>我们就可以在 generator-es5.js 文件看到编译后的完整可用的代码。</p>
<p>而这一编译就编译了 700 多行…… 编译后的代码可以查看 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Copyright (c) 2014-present, Facebook, Inc.</span><br><span class="line"> *</span><br><span class="line"> * This source code is licensed under the MIT license found in the</span><br><span class="line"> * LICENSE file in the root directory of this source tree.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">!(function(global) &#123;</span><br><span class="line">  &quot;use strict&quot;;</span><br><span class="line"></span><br><span class="line">  var Op = Object.prototype;</span><br><span class="line">  var hasOwn = Op.hasOwnProperty;</span><br><span class="line">  var undefined; // More compressible than void 0.</span><br><span class="line">  var $Symbol = typeof Symbol === &quot;function&quot; ? Symbol : &#123;&#125;;</span><br><span class="line">  var iteratorSymbol = $Symbol.iterator || &quot;@@iterator&quot;;</span><br><span class="line">  var asyncIteratorSymbol = $Symbol.asyncIterator || &quot;@@asyncIterator&quot;;</span><br><span class="line">  var toStringTagSymbol = $Symbol.toStringTag || &quot;@@toStringTag&quot;;</span><br><span class="line"></span><br><span class="line">  var inModule = typeof module === &quot;object&quot;;</span><br><span class="line">  var runtime = global.regeneratorRuntime;</span><br><span class="line">  if (runtime) &#123;</span><br><span class="line">    if (inModule) &#123;</span><br><span class="line">      // If regeneratorRuntime is defined globally and we&apos;re in a module,</span><br><span class="line">      // make the exports object identical to regeneratorRuntime.</span><br><span class="line">      module.exports = runtime;</span><br><span class="line">    &#125;</span><br><span class="line">    // Don&apos;t bother evaluating the rest of this file if the runtime was</span><br><span class="line">    // already defined globally.</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Define the runtime globally (as expected by generated code) as either</span><br><span class="line">  // module.exports (if we&apos;re in a module) or a new, empty object.</span><br><span class="line">  runtime = global.regeneratorRuntime = inModule ? module.exports : &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  function wrap(innerFn, outerFn, self, tryLocsList) &#123;</span><br><span class="line">    // If outerFn provided and outerFn.prototype is a Generator, then outerFn.prototype instanceof Generator.</span><br><span class="line">    var protoGenerator = outerFn &amp;&amp; outerFn.prototype instanceof Generator ? outerFn : Generator;</span><br><span class="line">    var generator = Object.create(protoGenerator.prototype);</span><br><span class="line">    var context = new Context(tryLocsList || []);</span><br><span class="line"></span><br><span class="line">    // The ._invoke method unifies the implementations of the .next,</span><br><span class="line">    // .throw, and .return methods.</span><br><span class="line">    generator._invoke = makeInvokeMethod(innerFn, self, context);</span><br><span class="line"></span><br><span class="line">    return generator;</span><br><span class="line">  &#125;</span><br><span class="line">  runtime.wrap = wrap;</span><br><span class="line"></span><br><span class="line">  // Try/catch helper to minimize deoptimizations. Returns a completion</span><br><span class="line">  // record like context.tryEntries[i].completion. This interface could</span><br><span class="line">  // have been (and was previously) designed to take a closure to be</span><br><span class="line">  // invoked without arguments, but in all the cases we care about we</span><br><span class="line">  // already have an existing method we want to call, so there&apos;s no need</span><br><span class="line">  // to create a new function object. We can even get away with assuming</span><br><span class="line">  // the method takes exactly one argument, since that happens to be true</span><br><span class="line">  // in every case, so we don&apos;t have to touch the arguments object. The</span><br><span class="line">  // only additional allocation required is the completion record, which</span><br><span class="line">  // has a stable shape and so hopefully should be cheap to allocate.</span><br><span class="line">  function tryCatch(fn, obj, arg) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      return &#123; type: &quot;normal&quot;, arg: fn.call(obj, arg) &#125;;</span><br><span class="line">    &#125; catch (err) &#123;</span><br><span class="line">      return &#123; type: &quot;throw&quot;, arg: err &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  var GenStateSuspendedStart = &quot;suspendedStart&quot;;</span><br><span class="line">  var GenStateSuspendedYield = &quot;suspendedYield&quot;;</span><br><span class="line">  var GenStateExecuting = &quot;executing&quot;;</span><br><span class="line">  var GenStateCompleted = &quot;completed&quot;;</span><br><span class="line"></span><br><span class="line">  // Returning this object from the innerFn has the same effect as</span><br><span class="line">  // breaking out of the dispatch switch statement.</span><br><span class="line">  var ContinueSentinel = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  // Dummy constructor functions that we use as the .constructor and</span><br><span class="line">  // .constructor.prototype properties for functions that return Generator</span><br><span class="line">  // objects. For full spec compliance, you may wish to configure your</span><br><span class="line">  // minifier not to mangle the names of these two functions.</span><br><span class="line">  function Generator() &#123;&#125;</span><br><span class="line">  function GeneratorFunction() &#123;&#125;</span><br><span class="line">  function GeneratorFunctionPrototype() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  // This is a polyfill for %IteratorPrototype% for environments that</span><br><span class="line">  // don&apos;t natively support it.</span><br><span class="line">  var IteratorPrototype = &#123;&#125;;</span><br><span class="line">  IteratorPrototype[iteratorSymbol] = function () &#123;</span><br><span class="line">    return this;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  var getProto = Object.getPrototypeOf;</span><br><span class="line">  var NativeIteratorPrototype = getProto &amp;&amp; getProto(getProto(values([])));</span><br><span class="line">  if (NativeIteratorPrototype &amp;&amp;</span><br><span class="line">      NativeIteratorPrototype !== Op &amp;&amp;</span><br><span class="line">      hasOwn.call(NativeIteratorPrototype, iteratorSymbol)) &#123;</span><br><span class="line">    // This environment has a native %IteratorPrototype%; use it instead</span><br><span class="line">    // of the polyfill.</span><br><span class="line">    IteratorPrototype = NativeIteratorPrototype;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  var Gp = GeneratorFunctionPrototype.prototype =</span><br><span class="line">    Generator.prototype = Object.create(IteratorPrototype);</span><br><span class="line">  GeneratorFunction.prototype = Gp.constructor = GeneratorFunctionPrototype;</span><br><span class="line">  GeneratorFunctionPrototype.constructor = GeneratorFunction;</span><br><span class="line">  GeneratorFunctionPrototype[toStringTagSymbol] =</span><br><span class="line">    GeneratorFunction.displayName = &quot;GeneratorFunction&quot;;</span><br><span class="line"></span><br><span class="line">  // Helper for defining the .next, .throw, and .return methods of the</span><br><span class="line">  // Iterator interface in terms of a single ._invoke method.</span><br><span class="line">  function defineIteratorMethods(prototype) &#123;</span><br><span class="line">    [&quot;next&quot;, &quot;throw&quot;, &quot;return&quot;].forEach(function(method) &#123;</span><br><span class="line">      prototype[method] = function(arg) &#123;</span><br><span class="line">        return this._invoke(method, arg);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  runtime.isGeneratorFunction = function(genFun) &#123;</span><br><span class="line">    var ctor = typeof genFun === &quot;function&quot; &amp;&amp; genFun.constructor;</span><br><span class="line">    return ctor</span><br><span class="line">      ? ctor === GeneratorFunction ||</span><br><span class="line">        // For the native GeneratorFunction constructor, the best we can</span><br><span class="line">        // do is to check its .name property.</span><br><span class="line">        (ctor.displayName || ctor.name) === &quot;GeneratorFunction&quot;</span><br><span class="line">      : false;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  runtime.mark = function(genFun) &#123;</span><br><span class="line">    if (Object.setPrototypeOf) &#123;</span><br><span class="line">      Object.setPrototypeOf(genFun, GeneratorFunctionPrototype);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      genFun.__proto__ = GeneratorFunctionPrototype;</span><br><span class="line">      if (!(toStringTagSymbol in genFun)) &#123;</span><br><span class="line">        genFun[toStringTagSymbol] = &quot;GeneratorFunction&quot;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    genFun.prototype = Object.create(Gp);</span><br><span class="line">    return genFun;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  // Within the body of any async function, `await x` is transformed to</span><br><span class="line">  // `yield regeneratorRuntime.awrap(x)`, so that the runtime can test</span><br><span class="line">  // `hasOwn.call(value, &quot;__await&quot;)` to determine if the yielded value is</span><br><span class="line">  // meant to be awaited.</span><br><span class="line">  runtime.awrap = function(arg) &#123;</span><br><span class="line">    return &#123; __await: arg &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  function AsyncIterator(generator) &#123;</span><br><span class="line">    function invoke(method, arg, resolve, reject) &#123;</span><br><span class="line">      var record = tryCatch(generator[method], generator, arg);</span><br><span class="line">      if (record.type === &quot;throw&quot;) &#123;</span><br><span class="line">        reject(record.arg);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        var result = record.arg;</span><br><span class="line">        var value = result.value;</span><br><span class="line">        if (value &amp;&amp;</span><br><span class="line">            typeof value === &quot;object&quot; &amp;&amp;</span><br><span class="line">            hasOwn.call(value, &quot;__await&quot;)) &#123;</span><br><span class="line">          return Promise.resolve(value.__await).then(function(value) &#123;</span><br><span class="line">            invoke(&quot;next&quot;, value, resolve, reject);</span><br><span class="line">          &#125;, function(err) &#123;</span><br><span class="line">            invoke(&quot;throw&quot;, err, resolve, reject);</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return Promise.resolve(value).then(function(unwrapped) &#123;</span><br><span class="line">          // When a yielded Promise is resolved, its final value becomes</span><br><span class="line">          // the .value of the Promise&lt;&#123;value,done&#125;&gt; result for the</span><br><span class="line">          // current iteration.</span><br><span class="line">          result.value = unwrapped;</span><br><span class="line">          resolve(result);</span><br><span class="line">        &#125;, function(error) &#123;</span><br><span class="line">          // If a rejected Promise was yielded, throw the rejection back</span><br><span class="line">          // into the async generator function so it can be handled there.</span><br><span class="line">          return invoke(&quot;throw&quot;, error, resolve, reject);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var previousPromise;</span><br><span class="line"></span><br><span class="line">    function enqueue(method, arg) &#123;</span><br><span class="line">      function callInvokeWithMethodAndArg() &#123;</span><br><span class="line">        return new Promise(function(resolve, reject) &#123;</span><br><span class="line">          invoke(method, arg, resolve, reject);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return previousPromise =</span><br><span class="line">        // If enqueue has been called before, then we want to wait until</span><br><span class="line">        // all previous Promises have been resolved before calling invoke,</span><br><span class="line">        // so that results are always delivered in the correct order. If</span><br><span class="line">        // enqueue has not been called before, then it is important to</span><br><span class="line">        // call invoke immediately, without waiting on a callback to fire,</span><br><span class="line">        // so that the async generator function has the opportunity to do</span><br><span class="line">        // any necessary setup in a predictable way. This predictability</span><br><span class="line">        // is why the Promise constructor synchronously invokes its</span><br><span class="line">        // executor callback, and why async functions synchronously</span><br><span class="line">        // execute code before the first await. Since we implement simple</span><br><span class="line">        // async functions in terms of async generators, it is especially</span><br><span class="line">        // important to get this right, even though it requires care.</span><br><span class="line">        previousPromise ? previousPromise.then(</span><br><span class="line">          callInvokeWithMethodAndArg,</span><br><span class="line">          // Avoid propagating failures to Promises returned by later</span><br><span class="line">          // invocations of the iterator.</span><br><span class="line">          callInvokeWithMethodAndArg</span><br><span class="line">        ) : callInvokeWithMethodAndArg();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Define the unified helper method that is used to implement .next,</span><br><span class="line">    // .throw, and .return (see defineIteratorMethods).</span><br><span class="line">    this._invoke = enqueue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  defineIteratorMethods(AsyncIterator.prototype);</span><br><span class="line">  AsyncIterator.prototype[asyncIteratorSymbol] = function () &#123;</span><br><span class="line">    return this;</span><br><span class="line">  &#125;;</span><br><span class="line">  runtime.AsyncIterator = AsyncIterator;</span><br><span class="line"></span><br><span class="line">  // Note that simple async functions are implemented on top of</span><br><span class="line">  // AsyncIterator objects; they just return a Promise for the value of</span><br><span class="line">  // the final result produced by the iterator.</span><br><span class="line">  runtime.async = function(innerFn, outerFn, self, tryLocsList) &#123;</span><br><span class="line">    var iter = new AsyncIterator(</span><br><span class="line">      wrap(innerFn, outerFn, self, tryLocsList)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    return runtime.isGeneratorFunction(outerFn)</span><br><span class="line">      ? iter // If outerFn is a generator, return the full iterator.</span><br><span class="line">      : iter.next().then(function(result) &#123;</span><br><span class="line">          return result.done ? result.value : iter.next();</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  function makeInvokeMethod(innerFn, self, context) &#123;</span><br><span class="line">    var state = GenStateSuspendedStart;</span><br><span class="line"></span><br><span class="line">    return function invoke(method, arg) &#123;</span><br><span class="line">      if (state === GenStateExecuting) &#123;</span><br><span class="line">        throw new Error(&quot;Generator is already running&quot;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (state === GenStateCompleted) &#123;</span><br><span class="line">        if (method === &quot;throw&quot;) &#123;</span><br><span class="line">          throw arg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Be forgiving, per 25.3.3.3.3 of the spec:</span><br><span class="line">        // https://people.mozilla.org/~jorendorff/es6-draft.html#sec-generatorresume</span><br><span class="line">        return doneResult();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      context.method = method;</span><br><span class="line">      context.arg = arg;</span><br><span class="line"></span><br><span class="line">      while (true) &#123;</span><br><span class="line">        var delegate = context.delegate;</span><br><span class="line">        if (delegate) &#123;</span><br><span class="line">          var delegateResult = maybeInvokeDelegate(delegate, context);</span><br><span class="line">          if (delegateResult) &#123;</span><br><span class="line">            if (delegateResult === ContinueSentinel) continue;</span><br><span class="line">            return delegateResult;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (context.method === &quot;next&quot;) &#123;</span><br><span class="line">          // Setting context._sent for legacy support of Babel&apos;s</span><br><span class="line">          // function.sent implementation.</span><br><span class="line">          context.sent = context._sent = context.arg;</span><br><span class="line"></span><br><span class="line">        &#125; else if (context.method === &quot;throw&quot;) &#123;</span><br><span class="line">          if (state === GenStateSuspendedStart) &#123;</span><br><span class="line">            state = GenStateCompleted;</span><br><span class="line">            throw context.arg;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          context.dispatchException(context.arg);</span><br><span class="line"></span><br><span class="line">        &#125; else if (context.method === &quot;return&quot;) &#123;</span><br><span class="line">          context.abrupt(&quot;return&quot;, context.arg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        state = GenStateExecuting;</span><br><span class="line"></span><br><span class="line">        var record = tryCatch(innerFn, self, context);</span><br><span class="line">        if (record.type === &quot;normal&quot;) &#123;</span><br><span class="line">          // If an exception is thrown from innerFn, we leave state ===</span><br><span class="line">          // GenStateExecuting and loop back for another invocation.</span><br><span class="line">          state = context.done</span><br><span class="line">            ? GenStateCompleted</span><br><span class="line">            : GenStateSuspendedYield;</span><br><span class="line"></span><br><span class="line">          if (record.arg === ContinueSentinel) &#123;</span><br><span class="line">            continue;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          return &#123;</span><br><span class="line">            value: record.arg,</span><br><span class="line">            done: context.done</span><br><span class="line">          &#125;;</span><br><span class="line"></span><br><span class="line">        &#125; else if (record.type === &quot;throw&quot;) &#123;</span><br><span class="line">          state = GenStateCompleted;</span><br><span class="line">          // Dispatch the exception by looping back around to the</span><br><span class="line">          // context.dispatchException(context.arg) call above.</span><br><span class="line">          context.method = &quot;throw&quot;;</span><br><span class="line">          context.arg = record.arg;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Call delegate.iterator[context.method](context.arg) and handle the</span><br><span class="line">  // result, either by returning a &#123; value, done &#125; result from the</span><br><span class="line">  // delegate iterator, or by modifying context.method and context.arg,</span><br><span class="line">  // setting context.delegate to null, and returning the ContinueSentinel.</span><br><span class="line">  function maybeInvokeDelegate(delegate, context) &#123;</span><br><span class="line">    var method = delegate.iterator[context.method];</span><br><span class="line">    if (method === undefined) &#123;</span><br><span class="line">      // A .throw or .return when the delegate iterator has no .throw</span><br><span class="line">      // method always terminates the yield* loop.</span><br><span class="line">      context.delegate = null;</span><br><span class="line"></span><br><span class="line">      if (context.method === &quot;throw&quot;) &#123;</span><br><span class="line">        if (delegate.iterator.return) &#123;</span><br><span class="line">          // If the delegate iterator has a return method, give it a</span><br><span class="line">          // chance to clean up.</span><br><span class="line">          context.method = &quot;return&quot;;</span><br><span class="line">          context.arg = undefined;</span><br><span class="line">          maybeInvokeDelegate(delegate, context);</span><br><span class="line"></span><br><span class="line">          if (context.method === &quot;throw&quot;) &#123;</span><br><span class="line">            // If maybeInvokeDelegate(context) changed context.method from</span><br><span class="line">            // &quot;return&quot; to &quot;throw&quot;, let that override the TypeError below.</span><br><span class="line">            return ContinueSentinel;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        context.method = &quot;throw&quot;;</span><br><span class="line">        context.arg = new TypeError(</span><br><span class="line">          &quot;The iterator does not provide a &apos;throw&apos; method&quot;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return ContinueSentinel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var record = tryCatch(method, delegate.iterator, context.arg);</span><br><span class="line"></span><br><span class="line">    if (record.type === &quot;throw&quot;) &#123;</span><br><span class="line">      context.method = &quot;throw&quot;;</span><br><span class="line">      context.arg = record.arg;</span><br><span class="line">      context.delegate = null;</span><br><span class="line">      return ContinueSentinel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var info = record.arg;</span><br><span class="line"></span><br><span class="line">    if (! info) &#123;</span><br><span class="line">      context.method = &quot;throw&quot;;</span><br><span class="line">      context.arg = new TypeError(&quot;iterator result is not an object&quot;);</span><br><span class="line">      context.delegate = null;</span><br><span class="line">      return ContinueSentinel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (info.done) &#123;</span><br><span class="line">      // Assign the result of the finished delegate to the temporary</span><br><span class="line">      // variable specified by delegate.resultName (see delegateYield).</span><br><span class="line">      context[delegate.resultName] = info.value;</span><br><span class="line"></span><br><span class="line">      // Resume execution at the desired location (see delegateYield).</span><br><span class="line">      context.next = delegate.nextLoc;</span><br><span class="line"></span><br><span class="line">      // If context.method was &quot;throw&quot; but the delegate handled the</span><br><span class="line">      // exception, let the outer generator proceed normally. If</span><br><span class="line">      // context.method was &quot;next&quot;, forget context.arg since it has been</span><br><span class="line">      // &quot;consumed&quot; by the delegate iterator. If context.method was</span><br><span class="line">      // &quot;return&quot;, allow the original .return call to continue in the</span><br><span class="line">      // outer generator.</span><br><span class="line">      if (context.method !== &quot;return&quot;) &#123;</span><br><span class="line">        context.method = &quot;next&quot;;</span><br><span class="line">        context.arg = undefined;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      // Re-yield the result returned by the delegate method.</span><br><span class="line">      return info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // The delegate iterator is finished, so forget it and continue with</span><br><span class="line">    // the outer generator.</span><br><span class="line">    context.delegate = null;</span><br><span class="line">    return ContinueSentinel;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Define Generator.prototype.&#123;next,throw,return&#125; in terms of the</span><br><span class="line">  // unified ._invoke helper method.</span><br><span class="line">  defineIteratorMethods(Gp);</span><br><span class="line"></span><br><span class="line">  Gp[toStringTagSymbol] = &quot;Generator&quot;;</span><br><span class="line"></span><br><span class="line">  // A Generator should always return itself as the iterator object when the</span><br><span class="line">  // @@iterator function is called on it. Some browsers&apos; implementations of the</span><br><span class="line">  // iterator prototype chain incorrectly implement this, causing the Generator</span><br><span class="line">  // object to not be returned from this call. This ensures that doesn&apos;t happen.</span><br><span class="line">  // See https://github.com/facebook/regenerator/issues/274 for more details.</span><br><span class="line">  Gp[iteratorSymbol] = function() &#123;</span><br><span class="line">    return this;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Gp.toString = function() &#123;</span><br><span class="line">    return &quot;[object Generator]&quot;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  function pushTryEntry(locs) &#123;</span><br><span class="line">    var entry = &#123; tryLoc: locs[0] &#125;;</span><br><span class="line"></span><br><span class="line">    if (1 in locs) &#123;</span><br><span class="line">      entry.catchLoc = locs[1];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (2 in locs) &#123;</span><br><span class="line">      entry.finallyLoc = locs[2];</span><br><span class="line">      entry.afterLoc = locs[3];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this.tryEntries.push(entry);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function resetTryEntry(entry) &#123;</span><br><span class="line">    var record = entry.completion || &#123;&#125;;</span><br><span class="line">    record.type = &quot;normal&quot;;</span><br><span class="line">    delete record.arg;</span><br><span class="line">    entry.completion = record;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function Context(tryLocsList) &#123;</span><br><span class="line">    // The root entry object (effectively a try statement without a catch</span><br><span class="line">    // or a finally block) gives us a place to store values thrown from</span><br><span class="line">    // locations where there is no enclosing try statement.</span><br><span class="line">    this.tryEntries = [&#123; tryLoc: &quot;root&quot; &#125;];</span><br><span class="line">    tryLocsList.forEach(pushTryEntry, this);</span><br><span class="line">    this.reset(true);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  runtime.keys = function(object) &#123;</span><br><span class="line">    var keys = [];</span><br><span class="line">    for (var key in object) &#123;</span><br><span class="line">      keys.push(key);</span><br><span class="line">    &#125;</span><br><span class="line">    keys.reverse();</span><br><span class="line"></span><br><span class="line">    // Rather than returning an object with a next method, we keep</span><br><span class="line">    // things simple and return the next function itself.</span><br><span class="line">    return function next() &#123;</span><br><span class="line">      while (keys.length) &#123;</span><br><span class="line">        var key = keys.pop();</span><br><span class="line">        if (key in object) &#123;</span><br><span class="line">          next.value = key;</span><br><span class="line">          next.done = false;</span><br><span class="line">          return next;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // To avoid creating an additional object, we just hang the .value</span><br><span class="line">      // and .done properties off the next function object itself. This</span><br><span class="line">      // also ensures that the minifier will not anonymize the function.</span><br><span class="line">      next.done = true;</span><br><span class="line">      return next;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  function values(iterable) &#123;</span><br><span class="line">    if (iterable) &#123;</span><br><span class="line">      var iteratorMethod = iterable[iteratorSymbol];</span><br><span class="line">      if (iteratorMethod) &#123;</span><br><span class="line">        return iteratorMethod.call(iterable);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (typeof iterable.next === &quot;function&quot;) &#123;</span><br><span class="line">        return iterable;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (!isNaN(iterable.length)) &#123;</span><br><span class="line">        var i = -1, next = function next() &#123;</span><br><span class="line">          while (++i &lt; iterable.length) &#123;</span><br><span class="line">            if (hasOwn.call(iterable, i)) &#123;</span><br><span class="line">              next.value = iterable[i];</span><br><span class="line">              next.done = false;</span><br><span class="line">              return next;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          next.value = undefined;</span><br><span class="line">          next.done = true;</span><br><span class="line"></span><br><span class="line">          return next;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        return next.next = next;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Return an iterator with no values.</span><br><span class="line">    return &#123; next: doneResult &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  runtime.values = values;</span><br><span class="line"></span><br><span class="line">  function doneResult() &#123;</span><br><span class="line">    return &#123; value: undefined, done: true &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Context.prototype = &#123;</span><br><span class="line">    constructor: Context,</span><br><span class="line"></span><br><span class="line">    reset: function(skipTempReset) &#123;</span><br><span class="line">      this.prev = 0;</span><br><span class="line">      this.next = 0;</span><br><span class="line">      // Resetting context._sent for legacy support of Babel&apos;s</span><br><span class="line">      // function.sent implementation.</span><br><span class="line">      this.sent = this._sent = undefined;</span><br><span class="line">      this.done = false;</span><br><span class="line">      this.delegate = null;</span><br><span class="line"></span><br><span class="line">      this.method = &quot;next&quot;;</span><br><span class="line">      this.arg = undefined;</span><br><span class="line"></span><br><span class="line">      this.tryEntries.forEach(resetTryEntry);</span><br><span class="line"></span><br><span class="line">      if (!skipTempReset) &#123;</span><br><span class="line">        for (var name in this) &#123;</span><br><span class="line">          // Not sure about the optimal order of these conditions:</span><br><span class="line">          if (name.charAt(0) === &quot;t&quot; &amp;&amp;</span><br><span class="line">              hasOwn.call(this, name) &amp;&amp;</span><br><span class="line">              !isNaN(+name.slice(1))) &#123;</span><br><span class="line">            this[name] = undefined;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    stop: function() &#123;</span><br><span class="line">      this.done = true;</span><br><span class="line"></span><br><span class="line">      var rootEntry = this.tryEntries[0];</span><br><span class="line">      var rootRecord = rootEntry.completion;</span><br><span class="line">      if (rootRecord.type === &quot;throw&quot;) &#123;</span><br><span class="line">        throw rootRecord.arg;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return this.rval;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    dispatchException: function(exception) &#123;</span><br><span class="line">      if (this.done) &#123;</span><br><span class="line">        throw exception;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      var context = this;</span><br><span class="line">      function handle(loc, caught) &#123;</span><br><span class="line">        record.type = &quot;throw&quot;;</span><br><span class="line">        record.arg = exception;</span><br><span class="line">        context.next = loc;</span><br><span class="line"></span><br><span class="line">        if (caught) &#123;</span><br><span class="line">          // If the dispatched exception was caught by a catch block,</span><br><span class="line">          // then let that catch block handle the exception normally.</span><br><span class="line">          context.method = &quot;next&quot;;</span><br><span class="line">          context.arg = undefined;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return !! caught;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      for (var i = this.tryEntries.length - 1; i &gt;= 0; --i) &#123;</span><br><span class="line">        var entry = this.tryEntries[i];</span><br><span class="line">        var record = entry.completion;</span><br><span class="line"></span><br><span class="line">        if (entry.tryLoc === &quot;root&quot;) &#123;</span><br><span class="line">          // Exception thrown outside of any try block that could handle</span><br><span class="line">          // it, so set the completion value of the entire function to</span><br><span class="line">          // throw the exception.</span><br><span class="line">          return handle(&quot;end&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (entry.tryLoc &lt;= this.prev) &#123;</span><br><span class="line">          var hasCatch = hasOwn.call(entry, &quot;catchLoc&quot;);</span><br><span class="line">          var hasFinally = hasOwn.call(entry, &quot;finallyLoc&quot;);</span><br><span class="line"></span><br><span class="line">          if (hasCatch &amp;&amp; hasFinally) &#123;</span><br><span class="line">            if (this.prev &lt; entry.catchLoc) &#123;</span><br><span class="line">              return handle(entry.catchLoc, true);</span><br><span class="line">            &#125; else if (this.prev &lt; entry.finallyLoc) &#123;</span><br><span class="line">              return handle(entry.finallyLoc);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125; else if (hasCatch) &#123;</span><br><span class="line">            if (this.prev &lt; entry.catchLoc) &#123;</span><br><span class="line">              return handle(entry.catchLoc, true);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125; else if (hasFinally) &#123;</span><br><span class="line">            if (this.prev &lt; entry.finallyLoc) &#123;</span><br><span class="line">              return handle(entry.finallyLoc);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            throw new Error(&quot;try statement without catch or finally&quot;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    abrupt: function(type, arg) &#123;</span><br><span class="line">      for (var i = this.tryEntries.length - 1; i &gt;= 0; --i) &#123;</span><br><span class="line">        var entry = this.tryEntries[i];</span><br><span class="line">        if (entry.tryLoc &lt;= this.prev &amp;&amp;</span><br><span class="line">            hasOwn.call(entry, &quot;finallyLoc&quot;) &amp;&amp;</span><br><span class="line">            this.prev &lt; entry.finallyLoc) &#123;</span><br><span class="line">          var finallyEntry = entry;</span><br><span class="line">          break;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (finallyEntry &amp;&amp;</span><br><span class="line">          (type === &quot;break&quot; ||</span><br><span class="line">           type === &quot;continue&quot;) &amp;&amp;</span><br><span class="line">          finallyEntry.tryLoc &lt;= arg &amp;&amp;</span><br><span class="line">          arg &lt;= finallyEntry.finallyLoc) &#123;</span><br><span class="line">        // Ignore the finally entry if control is not jumping to a</span><br><span class="line">        // location outside the try/catch block.</span><br><span class="line">        finallyEntry = null;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      var record = finallyEntry ? finallyEntry.completion : &#123;&#125;;</span><br><span class="line">      record.type = type;</span><br><span class="line">      record.arg = arg;</span><br><span class="line"></span><br><span class="line">      if (finallyEntry) &#123;</span><br><span class="line">        this.method = &quot;next&quot;;</span><br><span class="line">        this.next = finallyEntry.finallyLoc;</span><br><span class="line">        return ContinueSentinel;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return this.complete(record);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    complete: function(record, afterLoc) &#123;</span><br><span class="line">      if (record.type === &quot;throw&quot;) &#123;</span><br><span class="line">        throw record.arg;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (record.type === &quot;break&quot; ||</span><br><span class="line">          record.type === &quot;continue&quot;) &#123;</span><br><span class="line">        this.next = record.arg;</span><br><span class="line">      &#125; else if (record.type === &quot;return&quot;) &#123;</span><br><span class="line">        this.rval = this.arg = record.arg;</span><br><span class="line">        this.method = &quot;return&quot;;</span><br><span class="line">        this.next = &quot;end&quot;;</span><br><span class="line">      &#125; else if (record.type === &quot;normal&quot; &amp;&amp; afterLoc) &#123;</span><br><span class="line">        this.next = afterLoc;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return ContinueSentinel;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    finish: function(finallyLoc) &#123;</span><br><span class="line">      for (var i = this.tryEntries.length - 1; i &gt;= 0; --i) &#123;</span><br><span class="line">        var entry = this.tryEntries[i];</span><br><span class="line">        if (entry.finallyLoc === finallyLoc) &#123;</span><br><span class="line">          this.complete(entry.completion, entry.afterLoc);</span><br><span class="line">          resetTryEntry(entry);</span><br><span class="line">          return ContinueSentinel;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    &quot;catch&quot;: function(tryLoc) &#123;</span><br><span class="line">      for (var i = this.tryEntries.length - 1; i &gt;= 0; --i) &#123;</span><br><span class="line">        var entry = this.tryEntries[i];</span><br><span class="line">        if (entry.tryLoc === tryLoc) &#123;</span><br><span class="line">          var record = entry.completion;</span><br><span class="line">          if (record.type === &quot;throw&quot;) &#123;</span><br><span class="line">            var thrown = record.arg;</span><br><span class="line">            resetTryEntry(entry);</span><br><span class="line">          &#125;</span><br><span class="line">          return thrown;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // The context.catch method must only be called with a location</span><br><span class="line">      // argument that corresponds to a known catch block.</span><br><span class="line">      throw new Error(&quot;illegal catch attempt&quot;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    delegateYield: function(iterable, resultName, nextLoc) &#123;</span><br><span class="line">      this.delegate = &#123;</span><br><span class="line">        iterator: values(iterable),</span><br><span class="line">        resultName: resultName,</span><br><span class="line">        nextLoc: nextLoc</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      if (this.method === &quot;next&quot;) &#123;</span><br><span class="line">        // Deliberately forget the last sent value so that we don&apos;t</span><br><span class="line">        // accidentally pass it on to the delegate.</span><br><span class="line">        this.arg = undefined;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return ContinueSentinel;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)(</span><br><span class="line">  // In sloppy mode, unbound `this` refers to the global object, fallback to</span><br><span class="line">  // Function constructor if we&apos;re in global strict mode. That is sadly a form</span><br><span class="line">  // of indirect eval which violates Content Security Policy.</span><br><span class="line">  (function() &#123;</span><br><span class="line">    return this || (typeof self === &quot;object&quot; &amp;&amp; self);</span><br><span class="line">  &#125;)() || Function(&quot;return this&quot;)()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">var _marked =</span><br><span class="line">/*#__PURE__*/</span><br><span class="line">regeneratorRuntime.mark(helloWorldGenerator);</span><br><span class="line"></span><br><span class="line">function helloWorldGenerator() &#123;</span><br><span class="line">  return regeneratorRuntime.wrap(function helloWorldGenerator$(_context) &#123;</span><br><span class="line">    while (1) &#123;</span><br><span class="line">      switch (_context.prev = _context.next) &#123;</span><br><span class="line">        case 0:</span><br><span class="line">          _context.next = 2;</span><br><span class="line">          return &apos;hello&apos;;</span><br><span class="line"></span><br><span class="line">        case 2:</span><br><span class="line">          _context.next = 4;</span><br><span class="line">          return &apos;world&apos;;</span><br><span class="line"></span><br><span class="line">        case 4:</span><br><span class="line">          return _context.abrupt(&quot;return&quot;, &apos;ending&apos;);</span><br><span class="line"></span><br><span class="line">        case 5:</span><br><span class="line">        case &quot;end&quot;:</span><br><span class="line">          return _context.stop();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, _marked, this);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var hw = helloWorldGenerator();</span><br><span class="line">console.log(hw.next()); // &#123;value: &quot;hello&quot;, done: false&#125;</span><br><span class="line"></span><br><span class="line">console.log(hw.next()); // &#123;value: &quot;world&quot;, done: false&#125;</span><br><span class="line"></span><br><span class="line">console.log(hw.next()); // &#123;value: &quot;ending&quot;, done: true&#125;</span><br><span class="line"></span><br><span class="line">console.log(hw.next()); // &#123;value: undefined, done: true&#125;</span><br></pre></td></tr></table></figure>
<p>总之编译后的代码还蛮复杂，我们可以从中抽离出大致的逻辑，至少让简单编译的那段代码能够跑起来。</p>
<h2 id="mark-函数"><a href="#mark-函数" class="headerlink" title="mark 函数"></a>mark 函数</h2><p>简单编译后的代码第一段是这样的：</p>
<pre><code>var _marked = /*#__PURE__*/ regeneratorRuntime.mark(helloWorldGenerator);
</code></pre><p>我们查看完整编译版本中 mark 函数的源码：</p>
<pre><code>runtime.mark = function(genFun) {
  genFun.__proto__ = GeneratorFunctionPrototype;
  genFun.prototype = Object.create(Gp);
  return genFun;
};
</code></pre><p>这其中又涉及了 GeneratorFunctionPrototype 和 Gp 变量，我们也查看下对应的代码：</p>
<pre><code>functionGenerator() {}
functionGeneratorFunction() {}
functionGeneratorFunctionPrototype() {}

...

var Gp = GeneratorFunctionPrototype.prototype =
  Generator.prototype = Object.create(IteratorPrototype);

GeneratorFunction.prototype = Gp.constructor = GeneratorFunctionPrototype;

GeneratorFunctionPrototype.constructor = GeneratorFunction;

GeneratorFunctionPrototype[toStringTagSymbol] =
  GeneratorFunction.displayName = &quot;GeneratorFunction&quot;;
</code></pre><p>这段代码构建了一堆看起来很复杂的关系链，其实这是参照着 <a href="https://link.juejin.im?target=https%3A%2F%2Fwww.ecma-international.org%2Fecma-262%2F6.0%2F%23sec-generatorfunction-constructor" target="_blank" rel="noopener">ES6 规范</a>构建的关系链:<br><img src="/2018/10/05/Babel-将-Generator-编译成了什么/166c52b4064a3c92.webp" alt="regenerator"><br>图中 <code>+@@toStringTag:s = &#39;Generator&#39;</code> 的就是 Gp，<code>+@@toStringTag:s = &#39;GeneratorFunction&#39;</code> 的就是 GeneratorFunctionPrototype。</p>
<p>构建关系链的目的在于判断关系的时候能够跟原生的保持一致，就比如：</p>
<pre><code>function* f() {}
var g = f();
console.log(g.__proto__ === f.prototype); // trueconsole.log(g.__proto__.__proto__ === f.__proto__.prototype); // true
</code></pre><p>为了简化起见，我们可以把 Gp 先设置为一个空对象，不过正如你在上图中看到的，next()、 throw()、return() 函数都是挂载在 Gp 对象上，实际上，在完整的编译代码中，确实有为 Gp 添加这三个函数的方法：</p>
<pre><code>// 117 行functiondefineIteratorMethods(prototype) {
  [&quot;next&quot;, &quot;throw&quot;, &quot;return&quot;].forEach(function(method) {
    prototype[method] = function(arg) {
      returnthis._invoke(method, arg);
    };
  });
}

// 406 行
defineIteratorMethods(Gp);
</code></pre><p>为了简单起见，我们将整个 mark 函数简化为：</p>
<pre><code>runtime.mark = function(genFun) {
  var generator = Object.create({
    next: function(arg) {
      returnthis._invoke(&apos;next&apos;, arg)
    }
  });
  genFun.prototype = generator;
  return genFun;
};
</code></pre><h2 id="wrap-函数"><a href="#wrap-函数" class="headerlink" title="wrap 函数"></a>wrap 函数</h2><p>除了设置关系链之外，mark 函数的返回值 genFun 还作为了 wrap 函数的第二个参数传入：</p>
<pre><code>functionhelloWorldGenerator() {
  return regeneratorRuntime.wrap(
    functionhelloWorldGenerator$(_context) {
      ...
    },
    _marked,
    this
  );
}
</code></pre><p>我们再看下 wrap 函数：</p>
<pre><code>functionwrap(innerFn, outerFn, self) {
  var generator = Object.create(outerFn.prototype);
  var context = new Context([]);
  generator._invoke = makeInvokeMethod(innerFn, self, context);

  return generator;
}
</code></pre><p>所以当执行 <code>var hw = helloWorldGenerator();</code> 的时候，其实执行的是 wrap 函数，wrap 函数返回了 generator，generator 是一个对象，原型是 <code>outerFn.prototype</code>, <code>outerFn.prototype</code> 其实就是 <code>genFun.prototype</code>， <code>genFun.prototype</code> 是一个空对象，原型上有 next() 方法。</p>
<p>所以当你执行 <code>hw.next()</code> 的时候，执行的其实是 hw 原型的原型上的 next 函数，next 函数执行的又是 hw 的 _invoke 函数：</p>
<pre><code>generator._invoke = makeInvokeMethod(innerFn, self, context);
</code></pre><p>innerFn 就是 wrap 包裹的那个函数，其实就是 helloWordGenerato$ 函数，呐，就是这个函数：</p>
<pre><code>functionhelloWorldGenerator$(_context) {
  while (1) {
    switch ((_context.prev = _context.next)) {
      case0:
        _context.next = 2;
        return&quot;hello&quot;;

      case2:
        _context.next = 4;
        return&quot;world&quot;;

      case4:
        return _context.abrupt(&quot;return&quot;, &quot;ending&quot;);

      case5:
      case&quot;end&quot;:
        return _context.stop();
    }
  }
}
</code></pre><p>而 context 你可以直接理解为这样一个全局对象：</p>
<pre><code>var ContinueSentinel = {};

var context = {
  done: false,
  method: &quot;next&quot;,
  next: 0,
  prev: 0,
  abrupt: function(type, arg) {
    var record = {};
    record.type = type;
    record.arg = arg;

    returnthis.complete(record);
  },
  complete: function(record, afterLoc) {
    if (record.type === &quot;return&quot;) {
      this.rval = this.arg = record.arg;
      this.method = &quot;return&quot;;
      this.next = &quot;end&quot;;
    }

    return ContinueSentinel;
  },
  stop: function() {
    this.done = true;
    returnthis.rval;
  }
};
</code></pre><p>每次 <code>hw.next</code> 的时候，就会修改 next 和 prev 属性的值，当在 generator 函数中 return 的时候会执行 abrupt，abrupt 中又会执行 complete，执行完 complete，因为 <code>this.next = end</code> 的缘故，再执行就会执行 stop 函数。</p>
<p>我们来看下 makeInvokeMethod 函数：</p>
<pre><code>var ContinueSentinel = {};

functionmakeInvokeMethod(innerFn, self, context) {
  var state = &apos;start&apos;;

  returnfunctioninvoke(method, arg) {

    if (state === &apos;completed&apos;) {
      return { value: undefined, done: true };
    }

    context.method = method;
    context.arg = arg;

    while (true) {

      state = &apos;executing&apos;;

      var record = {
        type: &apos;normal&apos;,
        arg: innerFn.call(self, context)
      };
      if (record.type === &quot;normal&quot;) {

        state = context.done
          ? &apos;completed&apos;
          : &apos;yield&apos;;

        if (record.arg === ContinueSentinel) {
          continue;
        }

        return {
          value: record.arg,
          done: context.done
        };

      }
    }
  };
}
</code></pre><p>基本的执行过程就不分析了，我们重点看第三次执行 <code>hw.next()</code> 的时候:</p>
<p>第三次执行 <code>hw.next()</code> 的时候，其实执行了</p>
<pre><code>this._invoke(&quot;next&quot;, undefined);
</code></pre><p>我们在 invoke 函数中构建了一个 record 对象：</p>
<pre><code>var record = {
  type: &quot;normal&quot;,
  arg: innerFn.call(self, context)
};
</code></pre><p>而在 <code>innerFn.call(self, context)</code> 中，因为 _context.next 为 4 的缘故，其实执行了:</p>
<pre><code>_context.abrupt(&quot;return&quot;, &apos;ending&apos;);
</code></pre><p>而在 abrupt 中，我们又构建了一个 record 对象：</p>
<pre><code>var record = {};
record.type = &apos;return&apos;;
record.arg = &apos;ending&apos;;
</code></pre><p>然后执行了 <code>this.complete(record)</code>，</p>
<p>在 complete 中，因为 <code>record.type === &quot;return&quot;</code></p>
<pre><code>this.rval = &apos;ending&apos;;
this.method = &quot;return&quot;;
this.next = &quot;end&quot;;
</code></pre><p>然后返回了全局对象 ContinueSentinel，其实就是一个全局空对象。</p>
<p>然后在 invoke 函数中，因为 <code>record.arg === ContinueSentinel</code> 的缘故，没有执行后面的 return 语句，就直接进入下一个循环。</p>
<p>于是又执行了一遍 <code>innerFn.call(self, context)</code>，此时 <code>_context.next</code> 为 end, 执行了 <code>_context.stop()</code>, 在 stop 函数中：</p>
<pre><code>this.done = true;
returnthis.rval; // this.rval 其实就是 `ending`
</code></pre><p>所以最终返回的值为:</p>
<pre><code>{
  value: &apos;ending&apos;,
  done: true
};
</code></pre><p>之后，我们再执行 hw.next() 的时候，因为 state 已经是 ‘completed’ 的缘故，直接就返回 <code>{ value: undefined, done: true}</code></p>
<h2 id="不完整但可用的源码"><a href="#不完整但可用的源码" class="headerlink" title="不完整但可用的源码"></a>不完整但可用的源码</h2><p>当然这个过程，看文字理解起来可能有些难度，不完整但可用的代码如下，你可以断点调试查看具体的过程：</p>
<pre><code>(function() {
  var ContinueSentinel = {};

  var mark = function(genFun) {
    var generator = Object.create({
      next: function(arg) {
        returnthis._invoke(&quot;next&quot;, arg);
      }
    });
    genFun.prototype = generator;
    return genFun;
  };

  functionwrap(innerFn, outerFn, self) {
    var generator = Object.create(outerFn.prototype);

    var context = {
      done: false,
      method: &quot;next&quot;,
      next: 0,
      prev: 0,
      abrupt: function(type, arg) {
        var record = {};
        record.type = type;
        record.arg = arg;

        returnthis.complete(record);
      },
      complete: function(record, afterLoc) {
        if (record.type === &quot;return&quot;) {
          this.rval = this.arg = record.arg;
          this.method = &quot;return&quot;;
          this.next = &quot;end&quot;;
        }

        return ContinueSentinel;
      },
      stop: function() {
        this.done = true;
        returnthis.rval;
      }
    };

    generator._invoke = makeInvokeMethod(innerFn, context);

    return generator;
  }

  functionmakeInvokeMethod(innerFn, context) {
    var state = &quot;start&quot;;

    returnfunctioninvoke(method, arg) {
      if (state === &quot;completed&quot;) {
        return { value: undefined, done: true };
      }

      context.method = method;
      context.arg = arg;

      while (true) {
        state = &quot;executing&quot;;

        var record = {
          type: &quot;normal&quot;,
          arg: innerFn.call(self, context)
        };

        if (record.type === &quot;normal&quot;) {
          state = context.done ? &quot;completed&quot; : &quot;yield&quot;;

          if (record.arg === ContinueSentinel) {
            continue;
          }

          return {
            value: record.arg,
            done: context.done
          };
        }
      }
    };
  }

  window.regeneratorRuntime = {};

  regeneratorRuntime.wrap = wrap;
  regeneratorRuntime.mark = mark;
})();

var _marked = regeneratorRuntime.mark(helloWorldGenerator);

functionhelloWorldGenerator() {
  return regeneratorRuntime.wrap(
    functionhelloWorldGenerator$(_context) {
      while (1) {
        switch ((_context.prev = _context.next)) {
          case0:
            _context.next = 2;
            return&quot;hello&quot;;

          case2:
            _context.next = 4;
            return&quot;world&quot;;

          case4:
            return _context.abrupt(&quot;return&quot;, &quot;ending&quot;);

          case5:
          case&quot;end&quot;:
            return _context.stop();
        }
      }
    },
    _marked,
    this
  );
}

var hw = helloWorldGenerator();

console.log(hw.next());
console.log(hw.next());
console.log(hw.next());
console.log(hw.next());
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/04/简单理解async、await语法实现原理/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="武动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/04/简单理解async、await语法实现原理/" itemprop="url">简单理解async、await语法实现原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-04T23:57:27+08:00">
                2018-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>现在最新的前端框架生态都开始用上了Generator和yield，<br>有的甚至已经开始使用最新的async、await语法了，<br><strong>这两样都是基于Generator自动执行的原理。</strong></p>
<h2 id="阮一峰-async-函数的实现原理"><a href="#阮一峰-async-函数的实现原理" class="headerlink" title="阮一峰 async-函数的实现原理"></a>阮一峰 <a href="https://link.juejin.im?target=http%3A%2F%2Fes6.ruanyifeng.com%2F%23docs%2Fasync%23async-%25E5%2587%25BD%25E6%2595%25B0%25E7%259A%2584%25E5%25AE%259E%25E7%258E%25B0%25E5%258E%259F%25E7%2590%2586" target="_blank" rel="noopener">async-函数的实现原理</a></h2><h4 id="async-函数的实现原理，就是将-Generator-函数和自动执行器，包装在一个函数里。"><a href="#async-函数的实现原理，就是将-Generator-函数和自动执行器，包装在一个函数里。" class="headerlink" title="async 函数的实现原理，就是将 Generator 函数和自动执行器，包装在一个函数里。"></a>async 函数的实现原理，就是将 Generator 函数和自动执行器，包装在一个函数里。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">async function fn(args) &#123;</span><br><span class="line">  // ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 等同于</span><br><span class="line">function fn(args) &#123;</span><br><span class="line">  return spawn(function* () &#123;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有的async函数都可以写成上面的第二种形式，其中的spawn函数就是自动执行器。</p>
<p>下面给出spawn函数的实现，基本就是前文自动执行器的翻版。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">function spawn(genF) &#123;</span><br><span class="line">  return new Promise(function(resolve, reject) &#123;</span><br><span class="line">    const gen = genF();</span><br><span class="line">    function step(nextF) &#123;</span><br><span class="line">      let next;</span><br><span class="line">      try &#123;</span><br><span class="line">        next = nextF();</span><br><span class="line">      &#125; catch(e) &#123;</span><br><span class="line">        return reject(e);</span><br><span class="line">      &#125;</span><br><span class="line">      if(next.done) &#123;</span><br><span class="line">        return resolve(next.value);</span><br><span class="line">      &#125;</span><br><span class="line">      Promise.resolve(next.value).then(function(v) &#123;</span><br><span class="line">        step(function() &#123; return gen.next(v); &#125;);</span><br><span class="line">      &#125;, function(e) &#123;</span><br><span class="line">        step(function() &#123; return gen.throw(e); &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    step(function() &#123; return gen.next(undefined); &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">		&lt;title&gt;&lt;/title&gt;</span><br><span class="line">		&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">			function timeout(ms) &#123;</span><br><span class="line">				return &#123;</span><br><span class="line">					text: &apos;done&apos;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			function* start() &#123;</span><br><span class="line">				const res = yield timeout(1000);</span><br><span class="line">				return res;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">		 </span><br><span class="line">             </span><br><span class="line"></span><br><span class="line">			function fn(args) &#123;</span><br><span class="line">				return spawn(start);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			function spawn(genF) &#123;</span><br><span class="line">				return new Promise(function(resolve, reject) &#123;</span><br><span class="line">					const gen = genF();</span><br><span class="line">					function step(nextF) &#123;</span><br><span class="line">						let next;</span><br><span class="line">						try &#123;</span><br><span class="line">							next = nextF();</span><br><span class="line">						&#125; catch(e) &#123;</span><br><span class="line">							return reject(e);</span><br><span class="line">						&#125;</span><br><span class="line">						if(next.done) &#123;</span><br><span class="line">							return resolve(next.value);</span><br><span class="line">						&#125;</span><br><span class="line">						</span><br><span class="line">					</span><br><span class="line">						Promise.resolve(next.value).then(function(v) &#123;</span><br><span class="line">							step(function() &#123;</span><br><span class="line">								return gen.next(v);</span><br><span class="line">							&#125;);</span><br><span class="line">						&#125;, function(e) &#123;</span><br><span class="line">							step(function() &#123;</span><br><span class="line">								return gen.throw(e);</span><br><span class="line">							&#125;);</span><br><span class="line">						&#125;);</span><br><span class="line">					&#125;</span><br><span class="line">					step(function() &#123;</span><br><span class="line">						return gen.next();</span><br><span class="line">					&#125;);</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			 fn().then((data)=&gt;&#123;</span><br><span class="line">				console.log(data)</span><br><span class="line">			&#125;)</span><br><span class="line">		&lt;/script&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">	&lt;body&gt;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h3 id="看下babel转换后的"><a href="#看下babel转换后的" class="headerlink" title="看下babel转换后的"></a>看下babel转换后的</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">async function fns(args) &#123;</span><br><span class="line">				const res = await fetch(&apos;google.com&apos;);</span><br><span class="line">				return res.text();</span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&apos;use strict&apos;;</span><br><span class="line">    </span><br><span class="line">		var fns = function() &#123;</span><br><span class="line">			var _ref = _asyncToGenerator(regeneratorRuntime.mark(function _callee(args) &#123;</span><br><span class="line">				var res;</span><br><span class="line">				return regeneratorRuntime.wrap(function _callee$(_context) &#123;</span><br><span class="line">					while(1) &#123;</span><br><span class="line">						switch(_context.prev = _context.next) &#123;</span><br><span class="line">							case 0:</span><br><span class="line">								_context.next = 2;</span><br><span class="line">								return fetch(&apos;google.com&apos;);</span><br><span class="line">    </span><br><span class="line">							case 2:</span><br><span class="line">								res = _context.sent;</span><br><span class="line">								return _context.abrupt(&apos;return&apos;, res.text());</span><br><span class="line">    </span><br><span class="line">							case 4:</span><br><span class="line">							case&apos;end&apos;:</span><br><span class="line">								return _context.stop();</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;, _callee, this);</span><br><span class="line">			&#125;));</span><br><span class="line">    </span><br><span class="line">			returnfunction fns(_x) &#123;</span><br><span class="line">				return _ref.apply(this, arguments);</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;();</span><br><span class="line">    </span><br><span class="line">		function _asyncToGenerator(fn) &#123;  //Generator函数自动执行</span><br><span class="line">			returnfunction() &#123;</span><br><span class="line">				var gen = fn.apply(this, arguments);</span><br><span class="line">				return new Promise(function(resolve, reject) &#123;</span><br><span class="line">					function step(key, arg) &#123;</span><br><span class="line">						try &#123;</span><br><span class="line">							var info = gen[key](arg);</span><br><span class="line">							var value = info.value;</span><br><span class="line">						&#125; catch(error) &#123;</span><br><span class="line">							reject(error);</span><br><span class="line">							return;</span><br><span class="line">						&#125;</span><br><span class="line">						if(info.done) &#123;</span><br><span class="line">							resolve(value);</span><br><span class="line">						&#125; else &#123;</span><br><span class="line">							return Promise.resolve(value).then(function(value) &#123;</span><br><span class="line">								step(&quot;next&quot;, value);</span><br><span class="line">							&#125;, function(err) &#123;</span><br><span class="line">								step(&quot;throw&quot;, err);</span><br><span class="line">							&#125;);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					return step(&quot;next&quot;);</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>一、thunk函数<br>thunk函数指的是能将执行结果传入回调函数，并将该回调函数返回的函数。<br>是不是有点抽象，举个例子:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var readFile = function (fileName) &#123;</span><br><span class="line">    returnfunction (callback) &#123;</span><br><span class="line">        return fs.readFile(fileName, callback)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面我们来看下thunk函数怎样执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">readFile(&apos;./package.json&apos;)((err, str) =&gt; &#123;</span><br><span class="line">    console.log(str.toString())</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>问: thunk的执行比普通函数要麻烦不少，那么它有什么优势呢？</p>
<h3 id="thunk函数的优势在于它能将异步操作返回结果的获取权交给thunk函数的返回值，"><a href="#thunk函数的优势在于它能将异步操作返回结果的获取权交给thunk函数的返回值，" class="headerlink" title="thunk函数的优势在于它能将异步操作返回结果的获取权交给thunk函数的返回值，"></a>thunk函数的优势在于它能将异步操作返回结果的获取权交给thunk函数的返回值，</h3><p>而不是将异步操作结果传入thunk函数本身的作用域内，这点很重要，<br>因为它能结合Generator语法让Generator函数自动执行</p>
<p>二、Generator<br>es6的Generator函数，具体语法这里就不介绍了，</p>
<p>我们来编写一个基于thunk函数的Generator：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">let gen = function* () &#123;</span><br><span class="line">    let r1 = yield readFile(&apos;./package.json&apos;)</span><br><span class="line">    console.log(r1.toString())</span><br><span class="line">    let r2 = yield readFile(&apos;./index.js&apos;)</span><br><span class="line">    console.log(r2.toString())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们来手动执行一下这个Generator:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">let g = gen()</span><br><span class="line">let r1 = g.next()</span><br><span class="line">r1.value(function (err, data) &#123;</span><br><span class="line">    if (err) &#123;</span><br><span class="line">        throw err</span><br><span class="line">    &#125;</span><br><span class="line">    let r2 = g.next(data)</span><br><span class="line">    r2.value(function (err, data) &#123;</span><br><span class="line">        if (err) &#123;</span><br><span class="line">            throw err</span><br><span class="line">        &#125;</span><br><span class="line">        g.next(data)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>可以注意到，在我们手动执行基于thunk函数的Generator时，<br>有很多代码是可以复用的，<br>没错，所谓的Generator自动执行就是把这些可复用的部分封装成函数，<br>然后让它们递归执行，直到执行完所有的yield。</p>
<p>三、Generator自动执行器<br>下面就是Generator自动执行的核心代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function run(fn) &#123;</span><br><span class="line">    let gen = fn()</span><br><span class="line">    function next(err, data) &#123;</span><br><span class="line">        let result = gen.next(data)</span><br><span class="line">        if (result.done) &#123;</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        result.value(next)</span><br><span class="line">    &#125;</span><br><span class="line">    next()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到无非就是把可复用的部分封装成next函数，然后让其<strong>递归</strong>执行，<br>直到执行完所有的yield</p>
<p>其调用代码为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run(gen)</span><br></pre></td></tr></table></figure></p>
<p>这样就将原本繁杂的异步操作封装的十分简单了</p>
<p>基于Promise的Generator的自动执行<br>上面的例子是基于thunk函数的，而即将出现的es7的async、await语法是基于Promise的</p>
<p>这里再上一个基于Promise的Generator的自动执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">//包装返回Promise对象的函数</span><br><span class="line">functionreadFile(fileName) &#123;</span><br><span class="line">    return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">        fs.readFile(fileName, (error, data) =&gt; &#123;</span><br><span class="line">            if (error) &#123;</span><br><span class="line">                reject(error)</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                resolve(data)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">// 编写Generator</span><br><span class="line">let gen = function* () &#123;</span><br><span class="line">    let r1 = yield readFile(&apos;./package.json&apos;)</span><br><span class="line">    console.log(r1.toString())</span><br><span class="line">    let r2 = yield readFile(&apos;./index.js&apos;)</span><br><span class="line">    console.log(r2.toString())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 编写Generator执行器</span><br><span class="line">function run(gen) &#123;</span><br><span class="line">    let g = gen()</span><br><span class="line">    function next(data) &#123;</span><br><span class="line">        let result = g.next(data)</span><br><span class="line">        if (result.done) &#123;</span><br><span class="line">            return result.value</span><br><span class="line">        &#125;</span><br><span class="line">        result.value.then((data) =&gt; next(data))</span><br><span class="line">    &#125;</span><br><span class="line">    next()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//用Generator执行器自动执行</span><br><span class="line">run(gen)</span><br></pre></td></tr></table></figure></p>
<p>这个和基于thunk函数的大同小异，只是把函数返回值的获取权以Promise的方式交出</p>
<h4 id="参考-简单理解Generator自执行及async、await语法原理"><a href="#参考-简单理解Generator自执行及async、await语法原理" class="headerlink" title="参考 简单理解Generator自执行及async、await语法原理"></a>参考 <a href="https://link.juejin.im?target=https%3A%2F%2Fsegmentfault.com%2Fa%2F1190000008254704" target="_blank" rel="noopener">简单理解Generator自执行及async、await语法原理</a></h4>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/tx.jpg" alt="李斌">
            
              <p class="site-author-name" itemprop="name">李斌</p>
              <p class="site-description motion-element" itemprop="description">想要飞得高，那就把地平线忘掉</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">144</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">106</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/libin1991" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://juejin.im/user/57e737f6c4c971005f6bcd8d" target="_blank" title="juejin">
                      
                        <i class="fa fa-fw fa-spinner"></i>juejin</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李斌</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
<script type="text/javascript" src="/js/src/clicklove.js"></script>

