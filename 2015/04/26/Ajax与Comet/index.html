<!DOCTYPE html><html class="theme-next muse use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="Hexo, NexT"><meta name="description" content="服务器有新消息主动推送给客户端浏览器 下述内存主要讲述了《JavaScript高级程序设计（第3版）》第21章关于“Ajax与Comet”。  Ajax（Asynchronous JavaScript + XML的简写）可以向服务器请求数据而无需卸载（刷新）页面，带来更好的用户体验。Ajax技术的核心是XMLHttpRequest对象（简称XHR）。 一、XMLHttpRequest对象12345"><meta property="og:type" content="article"><meta property="og:title" content="Ajax与Comet"><meta property="og:url" content="http://yoursite.com/2015/04/26/Ajax与Comet/index.html"><meta property="og:site_name" content="舞动乾坤"><meta property="og:description" content="服务器有新消息主动推送给客户端浏览器 下述内存主要讲述了《JavaScript高级程序设计（第3版）》第21章关于“Ajax与Comet”。  Ajax（Asynchronous JavaScript + XML的简写）可以向服务器请求数据而无需卸载（刷新）页面，带来更好的用户体验。Ajax技术的核心是XMLHttpRequest对象（简称XHR）。 一、XMLHttpRequest对象12345"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://yoursite.com/2015/04/26/Ajax与Comet/20160419113844270.png"><meta property="og:image" content="http://yoursite.com/2015/04/26/Ajax与Comet/20160419114753780.png"><meta property="og:updated_time" content="2018-12-12T12:21:22.701Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Ajax与Comet"><meta name="twitter:description" content="服务器有新消息主动推送给客户端浏览器 下述内存主要讲述了《JavaScript高级程序设计（第3版）》第21章关于“Ajax与Comet”。  Ajax（Asynchronous JavaScript + XML的简写）可以向服务器请求数据而无需卸载（刷新）页面，带来更好的用户体验。Ajax技术的核心是XMLHttpRequest对象（简称XHR）。 一、XMLHttpRequest对象12345"><meta name="twitter:image" content="http://yoursite.com/2015/04/26/Ajax与Comet/20160419113844270.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://yoursite.com/2015/04/26/Ajax与Comet/"><title>Ajax与Comet | 舞动乾坤</title></head><body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"><div class="eevee"><div class="body"><div class="head"><div class="ears"><div class="ear"><div class="lobe"></div></div><div class="ear"><div class="lobe"></div></div></div><div class="face"><div class="eyes"><div class="eye"><div class="eyelid"></div></div><div class="eye"><div class="eyelid"></div></div></div><div class="nose"></div><div class="mouth"></div></div></div><div class="chest"><div class="fur"><div class="patch"></div></div><div class="fur"><div class="patch"></div></div><div class="fur"><div class="patch"></div></div></div><div class="legs"><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div></div><div class="tail"><div class="tail"><div class="tail"><div class="tail"><div class="tail"><div class="tail -end"></div></div></div></div></div></div></div></div></div><header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div id="sky"><div id="background" class="container"><svg id="svgout" height="100%" width="100%" viewbox="0 0 550 400"><defs><g id="bottomShadow"><path fill="#000000" stroke="none" d="M270.5 225.95 127.35 316.65 266.8 400 409.6 309.25 270.5 225.95Z"/></g><g id="Layer52_0_FILL"><path class="topGrass" fill="#B9D668" stroke="none" d="M397.85 229.3 397.85 225.6 269.85 152 135.75 228.6 135.75 233.65 262.1 306.55 397.85 229.3Z"/></g><g id="Layer51_0_FILL"><path class="leftSideGrass" fill="#6E9E4F" stroke="none" d="M135.1 229.95 135.1 256.85 262.1 328.4 262.1 301.85 135.1 229.95Z"/></g><g id="Layer50_0_FILL"><path class="rightGrassTop" fill="#8CB154" stroke="none" d="M397.85 225.95 395.8 225.95 261.75 301.55 261.75 328.4 397.85 251.15 397.85 225.95Z"/></g><g id="Layer48_0_FILL"><path class="crustLeftTop" fill="#955541" stroke="none" d="M135.45 282.4 135.75 298.15 262.1 372.1 261.75 355.65 135.45 282.4Z"/></g><g id="Layer47_0_FILL"><path class="middleLeftCrust" fill="#C77E61" stroke="none" d="M135.1 270.3 135.1 283.05 275.9 364.35 271.85 348.9 135.1 270.3Z"/></g><g id="Layer46_0_FILL"><path class="crustLeftTop" fill="#955541" stroke="none" d="M135.1 255.15 135.1 270.3 262.1 343.55 262.1 328.05 135.1 255.15Z"/></g><g id="Layer45_0_FILL"><path class="topRightCrust" fill="#A47237" stroke="none" d="M397.5 294.5 397.5 277 261.75 355.3 261.75 372.75 397.5 294.5Z"/></g><g id="Layer44_0_FILL"><path class="middleRightCrust" fill="#C89451" stroke="none" d="M397.5 269.95 397.15 266.6 262.1 343.2 262.1 355.95 397.5 279.7 397.5 269.95Z"/></g><g id="Layer43_0_FILL"><path class="topRightCrust" fill="#A47237" stroke="none" d="M397.5 266.6 397.5 250.45 261.75 328.4 261.75 343.85 397.5 266.6Z"/></g><g id="Layer41_0_FILL"><path class="greyRoad" fill="#B2B2B1" stroke="none" d="M295.05 283.05Q299.05 280.35 308.45 275.3 317.85 269.95 323.6 266.9L268.8 233.65 338.05 191.35 309.15 174.55 177.75 254.5Q191.55 262.2 198.25 266.25 204.65 269.95 209.7 271.95L241.6 250.45 295.05 283.05Z"/></g><g id="Layer40_0_FILL"><path fill="#FFFFFF" stroke="none" d="M199.95 256.85Q194.55 261.2 191.9 262.2L194.9 263.9 200.95 259.2 199.95 256.85M225.8 243.75 224.8 241.75 211.05 250.8 212.05 252.8 225.8 243.75M308.15 275.65 296.7 266.6 295.35 268.6 306.8 277.7 308.15 275.65M275.9 253.5 274.55 255.5 285.95 264.55 287.3 262.55 275.9 253.5M251.7 227.3 250.7 225.25 236.9 234.35 237.9 236.35 251.7 227.3M257.05 240.7 254.05 240.7 268.8 249.8 269.5 247.75 257.05 240.7M277.2 207.8 263.45 216.85 264.45 218.9 278.25 209.8 277.2 207.8M305.1 192.65 304.1 190.65 290.3 199.75 291.35 201.75 305.1 192.65Z"/></g><g id="Layer38_0_FILL"><path class="frontFascia" fill="#ECB27B" stroke="none" d="M359.25 187.95 346.4 174.95 333.85 202.9 359.25 187.95Z"/></g><g id="Layer37_0_FILL"><path class="frontWall" fill="#EFA258" stroke="none" d="M334 201.05 334.35 232 359.2 217.55 359.25 187.95 334 201.05Z"/></g><g id="Layer36_0_FILL"><path class="leftWall" fill="#C57F42" stroke="none" d="M334.35 232.3 334.35 205.1 305.1 191.35 305.1 216.85 334.35 232.3Z"/></g><g id="Layer35_0_FILL"><path class="rightRoof" fill="#EF4427" stroke="none" d="M329.7 167.9 331.05 167.9 344.55 176.7 347.85 176.7 363 192.25 363.15 189.55 350.65 176.7 350.55 176.7 334.25 167.5 334.25 159.1 329.7 159.1 329.7 164.9 322.65 160.95 322.3 162.15 329.7 167 329.7 167.9Z"/></g><g id="Layer34_0_FILL"><path class="leftRoof" fill="#F2563B" stroke="none" d="M334.05 207.05 350.65 176.7 322.1 160.45 302.1 192.05 334.05 207.05Z"/></g><g id="Layer30_0_FILL"><path id="windowFour" class="windows" stroke="none" fill="#975A42" d="M341.35 203.3Q340.9 203.45 340.5 203.8 340.1 204.2 339.85 204.75 339.7 205 339.7 205.3 339.6 205.75 339.7 206.1 339.7 206.15 339.7 206.2 339.8 206.5 340 206.8 340.55 207.4 341.45 207.4 342.35 207.4 343 206.8 343.4 206.5 343.65 206.1 343.85 205.75 343.95 205.3 344.05 204.4 343.55 203.8 343.3 203.45 343 203.3 342.65 203.15 342.2 203.15 341.8 203.15 341.35 203.3M355.85 198.45Q355.8 198.2 355.6 198 355.1 197.4 354.2 197.4 353.35 197.4 352.6 198 351.85 198.65 351.7 199.55 351.7 199.7 351.7 199.85 351.6 200.5 352 201.05 352.55 201.65 353.45 201.65 354.3 201.65 355.05 201.05 355.45 200.7 355.7 200.25 355.8 200.05 355.9 199.85 355.95 199.7 355.95 199.55 356.05 198.95 355.85 198.45Z"/><path class="door" fill="#B65041" stroke="none" d="M351.95 211.2 351.8 211.2 346.05 215.1 346.05 225.2 351.95 221.6 351.95 211.2M351.2 211.2 351.35 211.2 351.35 211.1 351.2 211.2Z"/></g><g><path id="Layer30_0_FILL" fill="#000000" fill-opacity="1" stroke="none" d="M183.7 215.3 183.7 215.6Q187.25 231.75 212.25 234.35L183.7 215.3Z"/></g><g id="Layer29_0_FILL"><path fill="#000000" fill-opacity="0.4" stroke="none" d="M305.1 216.85 305.15 217.2Q309.45 233.2 334.35 232.3L305.1 216.85Z"/></g><g id="Layer27_0_FILL"><path class="vegetation" fill="#78A950" stroke="none" d="M177.45 231.65Q175.75 235.35 181.8 239.35 185.5 235.7 185.15 231.3 182.8 230.65 181.45 234 179.45 231.3 177.45 231.65M236.9 266.6Q235.2 270.3 241.25 274.3 244.95 270.6 244.65 266.25 242.3 265.6 240.95 268.95 238.9 266.25 236.9 266.6M254.7 277Q253.05 280.7 259.1 284.75 262.75 281.05 262.45 276.65 260.1 276 258.75 279.35 256.7 276.65 254.7 277M315.5 245.75Q313.5 243.05 311.5 243.4 309.8 247.1 315.85 251.15 319.55 247.45 319.2 243.05 316.85 242.4 315.5 245.75M295.35 232.65Q293.7 236.35 299.75 240.4 303.45 236.7 303.1 232.3 300.75 231.65 299.4 235 297.4 232.3 295.35 232.65M277.2 171.85Q275.55 175.55 281.6 179.55 285.3 175.85 284.95 171.5 282.6 170.85 281.25 174.2 279.25 171.5 277.2 171.85Z"/></g><g id="Layer26_0_FILL"><path class="treeWood" fill="#AE663D" stroke="none" d="M175.1 177.55 172.05 177.55 172.05 191.1 159.3 172.85Q154.6 171.5 172.05 195.7L172.05 212.5 175.1 212.5 175.1 177.55M252.7 151.35 249 151.35 249 176.9 252.7 176.9 252.7 151.35Z"/></g><g id="Layer25_0_FILL"><path class="vegetation" fill="#77A951" stroke="none" d="M192.55 179.55Q200.95 173.5 200.95 165.1 200.95 156.4 192.55 150 184.15 144.3 172.05 144.3 160.3 144.3 151.9 150 143.15 156.4 143.15 165.1 143.15 173.5 151.9 179.55 160.3 185.95 172.05 185.95 184.15 185.95 192.55 179.55M236.25 106.65Q230.2 116.05 230.2 129.15 230.2 142.25 236.25 151.35 242.3 160.75 250.7 160.75 258.75 160.75 264.8 151.35 270.85 142.25 270.85 129.15 270.85 116.05 264.8 106.65 258.75 97.6 250.7 97.6 242.3 97.6 236.25 106.65Z"/></g><g id="Layer24_0_FILL"><path class="vegetation" fill="#77A951" stroke="none" d="M158.3 221.9Q160.65 221.9 161.95 220.2 163 219.55 163.3 218.55 164.65 218.9 166.35 218.9 170.05 218.9 172.4 216.2 175.1 213.85 175.1 210.15 175.1 206.45 172.4 203.75 170.05 201.4 166.35 201.4 162.65 201.4 159.95 203.75 157.6 206.45 157.6 210.15 157.6 210.8 157.6 211.15 155.95 211.5 154.6 212.5 152.9 214.15 152.9 216.55 152.9 218.9 154.6 220.2 156.25 221.9 158.3 221.9M338.35 240.05Q341.05 237.7 341.05 234 341.05 230.3 338.35 227.6 336 225.25 332.3 225.25 328.65 225.25 325.95 227.6 323.6 230.3 323.6 234 323.6 237.7 325.95 240.05 328.65 242.75 332.3 242.75 336 242.75 338.35 240.05Z"/></g><g id="Layer22_0_FILL"><path class="rightRoof" fill="#D05041" stroke="none" d="M220 173.85 236.8 186.7 264.35 171.15 244.5 159.55 220 173.85Z"/></g><g id="Layer21_0_FILL"><path class="leftWall" fill="#C57F42" stroke="none" d="M212.25 191.35 183.35 172.3 183.7 215.3 212.25 234.35 212.25 191.35Z"/></g><g id="Layer20_0_FILL"><path class="rightRoof" fill="#EF4427" stroke="none" d="M192.1 149.85 236.45 174.8 243.1 171.4Q220.05 150.55 196.3 139.95L192.1 149.85Z"/></g><g id="Layer19_0_FILL"><path class="frontFascia" fill="#EBB17B" stroke="none" d="M226.85 160.95 212 190.6 229.75 192.6 239.75 172.85 226.85 160.95Z"/></g><g id="Layer18_0_FILL"><path class="frontWall" fill="#EFA258" stroke="none" d="M240.15 172.65 211.9 191.6 212.25 233.65 264.35 201.7 264.35 170.8 240.8 184.45 240.15 172.65Z"/></g><g id="Layer17_0_FILL"><path class="rightRoof" fill="#EF4427" stroke="none" d="M210.9 142.2 205.9 142.2 205.9 152.65 210.9 152.65 210.9 142.2Z"/></g><g><path id="Layer16_0_FILL" class="leftRoof" fill="#F2563B" stroke="none" d="M210.25 195.5 227.4 160.95 195.45 141.35 177.65 175.85 210.25 195.5Z"/></g><g><path id="sun" fill="#E3BD0E" stroke="none" d="M257.05 15.95Q251.7 15.95 248 19.65 244.3 23.35 244.3 28.7 244.3 34.1 248 37.8 251.7 41.5 257.05 41.5 262.45 41.5 266.15 37.8 269.85 34.1 269.85 28.7 269.85 23.35 266.15 19.65 262.45 15.95 257.05 15.95Z"/></g><g id="Layer8_0_FILL"><path fill="#975A42" stroke="none" d="M238.45 189.65Q238.295703125 189.362109375 238.05 189.1 237.35 188.3 236.2 188.3 235.05 188.3 234.15 189.1 233.3 189.9 233.2 191.05 233.1 192.2 233.8 193 234.55 193.8 235.7 193.8 236.85 193.8 237.7 193 238.1970703125 192.558203125 238.45 192 238.6552734375 191.56484375 238.7 191.05 238.7671875 190.276953125 238.45 189.65M220.55 197.55Q220 197.55 219.5 197.75 218.95 197.95 218.5 198.35 217.933203125 198.8833984375 217.7 199.55 217.5833984375 199.916796875 217.55 200.3 217.4923828125 200.96171875 217.7 201.5 217.852734375 201.9103515625 218.15 202.25 218.95 203.05 220.1 203.05 221.25 203.05 222.05 202.25 222.95 201.45 223.05 200.3 223.15 199.15 222.4 198.35 222.05 197.95 221.65 197.75 221.15 197.55 220.55 197.55Z"/></g><g id="Layer7_0_FILL"><path class="door" fill="#B65041" stroke="none" d="M233.55 206.75 225.9 211.95 226.25 225.5 233.95 220.35 233.55 206.75Z"/></g><g><path id="windowOne" class="windows" fill="#975A42" stroke="none" d="M188.65 198.4 188.8 204.1 198.65 210.45 198.55 204.75 188.65 198.4M208.45 216.8 208.35 211.1 198.55 204.75 198.65 210.45 208.45 216.8M188.8 204.1 188.95 209.8 198.8 216.15 198.65 210.45 188.8 204.1M208.6 222.5 208.45 216.8 198.65 210.45 198.8 216.15 208.6 222.5Z"/></g><g><path id="windowThree" class="windows" fill="#975A42" stroke="none" d="M311.7 214.1 318.55 217.55 318.45 211.9 311.6 208.45 311.7 214.1M325.4 221 325.25 215.35 318.45 211.9 318.55 217.55 325.4 221M318.4 206.2 311.5 202.75 311.6 208.45 318.45 211.9 318.4 206.2M325.25 215.35 325.2 209.7 318.4 206.2 318.45 211.9 325.25 215.35Z"/></g><g id="Layer2_0_FILL"><path class="door" fill="#B65041" stroke="none" d="M259.7 183.25 244.6 191.9 244.6 213.8 259.7 204.55 259.7 183.25Z"/></g><path id="windowTwo" fill="#975A42" class="windows" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" d="M223.05 200.3Q222.95 201.45 222.05 202.25 221.25 203.05 220.1 203.05 218.95 203.05 218.15 202.25 217.852734375 201.9103515625 217.7 201.5 217.4923828125 200.96171875 217.55 200.3 217.5833984375 199.916796875 217.7 199.575 217.933203125 198.8833984375 218.5 198.35 218.95 197.95 219.5 197.75 220 197.55 220.55 197.55 221.15 197.55 221.65 197.75 222.05 197.95 222.4 198.35 223.15 199.15 223.05 200.3ZM238.7 191.05Q238.6552734375 191.56484375 238.45 192 238.1970703125 192.558203125 237.7 193 236.85 193.8 235.7 193.8 234.55 193.8 233.8 193 233.1 192.2 233.2 191.05 233.3 189.9 234.15 189.1 235.05 188.3 236.2 188.3 237.35 188.3 238.05 189.1 238.295703125 189.362109375 238.45 189.65 238.7671875 190.276953125 238.7 191.05Z"/><path fill="#F2563B" stroke="none" d="M351.95 211.2 351.8 211.2 346.05 215.1 346.05 225.2 351.95 221.6 351.95 211.2Z"/><path id="Layer6_0_1_STROKES" class="windowRims" stroke="#AE663D" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" fill="none" d="M198.55 204.75 208.35 211.1 208.45 216.8 208.6 222.5 198.8 216.15 188.95 209.8 188.8 204.1 188.65 198.4 198.55 204.75 198.65 210.45 208.45 216.8M198.8 216.15 198.65 210.45 188.8 204.1"/><path id="Layer5_0_1_STROKES" class="windowRims" stroke="#AE663D" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" fill="none" d="M325.25 215.35 325.4 221 318.55 217.55 311.7 214.1 311.6 208.45 311.5 202.75 318.4 206.2 325.2 209.7 325.25 215.35 318.45 211.9 318.55 217.55M318.4 206.2 318.45 211.9 311.6 208.45"/></defs><g id="shadow"><g transform="matrix( 1, 0, 0, 1, 0,0) "><use xlink:href="#bottomShadow"/></g></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use xlink:href="#sun"/></g><g id="earth"><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer52_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer51_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer50_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer48_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer47_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer46_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer45_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer44_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer43_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer41_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer40_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer38_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer37_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer36_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer35_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer34_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#windowFour"/><use class="element" xlink:href="#Layer32_0_1_STROKES"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer30_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer27_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer26_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer25_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer24_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer22_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer21_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer20_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer19_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer18_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer17_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer16_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer8_0_FILL"/><use class="element" xlink:href="#windowTwo"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer7_0_FILL"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#windowOne"/><use class="element" xlink:href="#Layer6_0_1_STROKES"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#windowThree"/><use class="element" xlink:href="#Layer5_0_1_STROKES"/></g><g transform="matrix( 1, 0, 0, 1, 0,0) "><use class="element" xlink:href="#Layer2_0_FILL"/></g></g></svg><div id="toggleButton" class="day-toggle"><div class="sun-icon"></div> <label class="switch"><input id="toggleCheckbox" type="checkbox"><div class="slider"></div></label><div class="cloud-icon"></div></div></div></div><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">舞动乾坤</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">星光不问赶路人 岁月不负有心人</p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/04/26/Ajax与Comet/"><span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="李斌"><meta itemprop="description" content=""><meta itemprop="image" content="/images/tx.jpg"></span><span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="舞动乾坤"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Ajax与Comet</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-04-26T20:19:20+08:00">2015-04-26</time></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="服务器有新消息主动推送给客户端浏览器"><a href="#服务器有新消息主动推送给客户端浏览器" class="headerlink" title="服务器有新消息主动推送给客户端浏览器"></a><a href="https://www.cnblogs.com/study-everyday/p/6140498.html" target="_blank" rel="noopener">服务器有新消息主动推送给客户端浏览器</a></h3><blockquote><p>下述内存主要讲述了《JavaScript高级程序设计（第3版）》第21章关于“Ajax与Comet”。</p></blockquote><p><strong>Ajax（Asynchronous JavaScript + XML的简写）</strong>可以向服务器请求数据而无需卸载（刷新）页面，带来更好的用户体验。<br><strong>Ajax技术的核心是XMLHttpRequest对象（简称XHR）。</strong></p><h3 id="一、XMLHttpRequest对象"><a href="#一、XMLHttpRequest对象" class="headerlink" title="一、XMLHttpRequest对象"></a>一、XMLHttpRequest对象</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/* 兼容IE早期版本 */</span><br><span class="line">function createXHR()&#123;</span><br><span class="line">    if (typeof XMLHttpRequest != &quot;undefined&quot;)&#123;</span><br><span class="line">        return new XMLHttpRequest();</span><br><span class="line">    &#125; else if (typeof ActiveXObject != &quot;undefined&quot;)&#123;    // 适用于IE7之前的版本</span><br><span class="line">        if (typeof arguments.callee.activeXString != &quot;string&quot;)&#123;</span><br><span class="line">            var versions = [&quot;MSXML2.XMLHttp.6.0&quot;, &quot;MSXML2.XMLHttp.3.0&quot;,</span><br><span class="line">                            &quot;MSXML2.XMLHttp&quot;],</span><br><span class="line">                i, len;</span><br><span class="line"></span><br><span class="line">            for (i=0,len=versions.length; i &lt; len; i++)&#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    new ActiveXObject(versions[i]);</span><br><span class="line">                    arguments.callee.activeXString = versions[i];</span><br><span class="line">                    break;</span><br><span class="line">                &#125; catch (ex)&#123;</span><br><span class="line">                    //skip</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return new ActiveXObject(arguments.callee.activeXString);</span><br><span class="line">    &#125; else &#123;  // XHR对象和ActiveX对象都不存在，则抛出错误 </span><br><span class="line">        throw new Error(&quot;No XHR object available.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-XHR的用法"><a href="#1-XHR的用法" class="headerlink" title="1. XHR的用法"></a>1. XHR的用法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xhr.open(&quot;请求的类型get|post等&quot;, &quot;请求的URL&quot;, &quot;是否异步发送请求&quot;);</span><br></pre></td></tr></table></figure><p><strong>说明：</strong><br>（1）URL相对于执行代码的当前页面（当然也可以使用绝对路径）<br>（2）open()方法并不会真正发送请求，而只是启动一个请求以备发送<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xhr.send(&quot;请求主体发送的数据&quot;);</span><br></pre></td></tr></table></figure><p></p><p><strong>说明：</strong><br>（1）如果不需要通过请求主体发送数据（比如get请求），则必须传入null，因为这个参数对有些浏览器来说是必需的<br>（2）调用send()之后，请求就会被分派到服务器</p><p><strong>补充</strong>：xhr.open()方法为“false”，即同步请求，JavaScript代码会等到服务器响应后再继续执行；否则，继续执行后续代码。</p><p>在收到服务器响应后，相应的数据会自动填充XHR对象的属性。</p><ul><li>responseText：作为响应主体被返回的文本</li><li>responseXML：如果响应的内容类型是”text/xml”或”application/xml”，这个属性中将保存包含着响应数据的XML DOM文档</li><li>status：响应的HTTP状态</li><li>statusText：HTTP状态的说明<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 为确保接收到适当的响应 200:成功；304:资源未被修改</span><br><span class="line">if((xhr.status &gt;= 200 &amp;&amp; xhr.status &lt; 300) || xhr.status == 304) &#123;</span><br><span class="line">    console.log(xhr.responseText);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><strong>说明</strong>：<br>（1）有的浏览器会错误的报告成功状态码为204<br>（2）无论内容类型是什么，响应主体的内容都会保存到responseText属性中；而对于XML数据而言，responseXML同时也将被赋值，否则其值为null</p><p><strong>对于异步请求，可以检测XHR对象的readyState属性，该属性表示请求/响应过程的当前活动阶段</strong></p><ul><li>0：未初始化。尚未调用open()方法</li><li>1：启动。已经调用open()方法，但尚未调用send()方法</li><li>2：发送。已经调用send()方法，但尚未接收到响应</li><li>3：接收。已经接收到部分响应数据</li><li>4：完成。已经接收全部响应数据，而且已经可以在客户端使用了。</li></ul><p>readyState属性的值发生变化，都会触发<strong>readystatechange</strong>事件。可以利用这个事件来检测每次状态变化后<strong>readyState</strong>的值。不过，<em>必须在调用open()之前指定onreadystatechange事件处理程序才能确保跨浏览器兼容性。</em></p><pre><code>var xhr = createXHR();        
xhr.onreadystatechange = function(event){
    // 不要使用this，作用域会产生问题，在部分浏览器中会执行失败
    if (xhr.readyState == 4){
        if ((xhr.status &gt;= 200 &amp;&amp; xhr.status &lt; 300) || xhr.status == 304){
            console.log(xhr.responseText);
        } else {
            console.log(&quot;Request was unsuccessful: &quot; + xhr.status);
        }
    }
};
xhr.open(&quot;get&quot;, &quot;example.txt&quot;, true);
xhr.send(null);
</code></pre><p>在接收到响应数据之前可以调用abort()方法来取消异步请求：</p><pre><code>xhr.abort();
xhr =null; // 解除引用，释放内存
</code></pre><h4 id="2-HTTP头部信息"><a href="#2-HTTP头部信息" class="headerlink" title="2. HTTP头部信息"></a>2. HTTP头部信息</h4><p><strong>setRequestHeader()</strong>：设置自定义的请求头信息。必须在调用open()方法之后且调用send()方法之前调用。<br><strong>getResponseHeader() getAllResponseHeaders()</strong>：可以获取指定（全部）响应头信息。</p><pre><code>var xhr = createXHR();        
xhr.onreadystatechange = function(){};
xhr.open(&quot;get&quot;, &quot;example.php&quot;, true);
xhr.setRequestHeader(&quot;MyHeader&quot;, &quot;MyValue&quot;);
xhr.send(null);
</code></pre><h4 id="3-GET请求"><a href="#3-GET请求" class="headerlink" title="3. GET请求"></a>3. GET请求</h4><p><strong>open()</strong>方法的URL尾部的查询字符串必须经过正确的编码</p><pre><code>functionaddURLParam(url, name, value) {
    url += (url.indexOf(&quot;?&quot;) == -1 ? &quot;?&quot; : &quot;&amp;&quot;);
    url += encodeURIComponent(name) + &quot;=&quot; + encodeURIComponent(value);
    return url;
}

var url = &quot;http://test.com&quot;;
url = addURLParam(url, &quot;uid&quot; , 5);
url = addURLParam(url, &quot;siteid&quot;, 123);  // &quot;http://test.com?uid=5&amp;siteid=123&quot;
xhr.open(&quot;get&quot;, url, true);
xhr.send(null);
</code></pre><h4 id="4-POST请求"><a href="#4-POST请求" class="headerlink" title="4. POST请求"></a>4. POST请求</h4><p>POST请求将数据作为请求的主体<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">/* 序列化表单 */</span><br><span class="line">function serialize(form)&#123;        </span><br><span class="line">    var parts = new Array();</span><br><span class="line">    var field = null;</span><br><span class="line"></span><br><span class="line">    for (var i=0, len=form.elements.length; i &lt; len; i++)&#123;</span><br><span class="line">        field = form.elements[i];</span><br><span class="line"></span><br><span class="line">        switch(field.type)&#123;</span><br><span class="line">            case &quot;select-one&quot;:</span><br><span class="line">            case &quot;select-multiple&quot;:</span><br><span class="line">                for (var j=0, optLen = field.options.length; j &lt; optLen; j++)&#123;</span><br><span class="line">                    var option = field.options[j];</span><br><span class="line">                    if (option.selected)&#123;</span><br><span class="line">                        var optValue = &quot;&quot;;</span><br><span class="line">                        if (option.hasAttribute)&#123;</span><br><span class="line">                            optValue = (option.hasAttribute(&quot;value&quot;) ? </span><br><span class="line">                                        option.value : option.text);</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            optValue = (option.attributes[&quot;value&quot;].specified ? </span><br><span class="line">                                        option.value : option.text);</span><br><span class="line">                        &#125;</span><br><span class="line">                        parts.push(encodeURIComponent(field.name) + &quot;=&quot; + </span><br><span class="line">                                   encodeURIComponent(optValue));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case undefined:     //fieldset</span><br><span class="line">            case &quot;file&quot;:        //file input</span><br><span class="line">            case &quot;submit&quot;:      //submit button</span><br><span class="line">            case &quot;reset&quot;:       //reset button</span><br><span class="line">            case &quot;button&quot;:      //custom button</span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            case &quot;radio&quot;:       //radio button</span><br><span class="line">            case &quot;checkbox&quot;:    //checkbox</span><br><span class="line">                if (!field.checked)&#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                /* falls through */              </span><br><span class="line">            default:</span><br><span class="line">                parts.push(encodeURIComponent(field.name) + &quot;=&quot; + </span><br><span class="line">                    encodeURIComponent(field.value));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;        </span><br><span class="line">    return parts.join(&quot;&amp;&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/* 发送请求 */</span><br><span class="line">function submitData()&#123;</span><br><span class="line">    var xhr = createXHR();        </span><br><span class="line">    xhr.onreadystatechange = function(event)&#123;</span><br><span class="line">        if (xhr.readyState == 4)&#123;</span><br><span class="line">            if ((xhr.status &gt;= 200 &amp;&amp; xhr.status &lt; 300) || xhr.status == 304)&#123;</span><br><span class="line">                alert(xhr.responseText);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                alert(&quot;Request was unsuccessful: &quot; + xhr.status);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    xhr.open(&quot;post&quot;, &quot;postexample.php&quot;, true);</span><br><span class="line">    // 表单提交的内容类型</span><br><span class="line">    xhr.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);</span><br><span class="line">    var form = document.getElementById(&quot;user-info&quot;);   </span><br><span class="line">    // 请求主体为数据         </span><br><span class="line">    xhr.send(serialize(form));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二、XMLHttpRequest-2级"><a href="#二、XMLHttpRequest-2级" class="headerlink" title="二、XMLHttpRequest 2级"></a>二、XMLHttpRequest 2级</h3><p>XMLHttpRequest 1级只是把已有的XHR对象的实现细节描述了出来。而XMLHttpRequest 2级则进一步发展了XHR。并非所有浏览器都完整地实现了XMLHttpRequest 2级规范，但所有浏览器都实现了它规定的部分内容。</p><h4 id="1-FormData"><a href="#1-FormData" class="headerlink" title="1. FormData"></a>1. FormData</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 创建FormData对象</span><br><span class="line">var data=new FormData();</span><br><span class="line">data.append(&quot;name&quot;, &quot;ligang&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 用表单元素填充</span><br><span class="line">xhr.open(&quot;post&quot;, &quot;postexample.php&quot;, true);</span><br><span class="line">var form = document.getElementById(&quot;user-info&quot;);</span><br><span class="line">// 使用FormData的方便之处在于不必明确地在XHR对象上设置请求头。</span><br><span class="line">// xhr.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);</span><br><span class="line">xhr.send(new FormData(form));</span><br></pre></td></tr></table></figure><h4 id="2-超时设定"><a href="#2-超时设定" class="headerlink" title="2. 超时设定"></a>2. 超时设定</h4><p>IE8为XHR对象添加了一个timeout属性，表示请求在等待响应多少毫秒后就终止。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">xhr.open(&quot;get&quot;, &quot;timeout.php&quot;, true);</span><br><span class="line">xhr.timeout = 60 * 1000;</span><br><span class="line">xhr.ontimeout = function()&#123;</span><br><span class="line">    alert(&quot;Request did not return in a second.&quot;);</span><br><span class="line">&#125;;        </span><br><span class="line">xhr.send(null);</span><br></pre></td></tr></table></figure><p></p><p>对于其他浏览器的兼容做法<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">xhr.open(&quot;get&quot;, &quot;timeout.php&quot;, true);</span><br><span class="line">xhr.onreadystatechange = function(event)&#123;if (xhr.readyState == 4)&#123;</span><br><span class="line">        // 清除定时器</span><br><span class="line">        clearTimeout(timeout);</span><br><span class="line">        if ((xhr.status &gt;= 200 &amp;&amp; xhr.status &lt; 300) || xhr.status == 304)&#123;</span><br><span class="line">            console.log(xhr.responseText);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            console.log(&quot;Request was unsuccessful: &quot; + xhr.status);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">// 设置超时时间 1分钟</span><br><span class="line">var timeout = setTimeout(function() &#123;</span><br><span class="line">    xmlHttpRequest.abort();</span><br><span class="line">    xmlHttpRequest = null;</span><br><span class="line">&#125;, 60 * 1000);</span><br><span class="line">xmlHttpRequest.send(null);</span><br></pre></td></tr></table></figure><p></p><h4 id="3-overrideMimeType-方法"><a href="#3-overrideMimeType-方法" class="headerlink" title="3. overrideMimeType()方法"></a>3. overrideMimeType()方法</h4><p>重写XHR响应的MIME类型，<em>必须在send()方法之前</em>。</p><p>如果，服务器返回的MIME类型是text/plain，但数据中实际包含的是XML。根据MIME类型，responseXML属性中仍然是null。此时，通过<strong>overrideMimeType()</strong>方法，可以保证把响应当作XML而非纯文本来处理（即，responseXML中被赋值）。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var xhr = createXHR();</span><br><span class="line">xhr.open(&quot;get&quot;, &quot;text.php&quot;, true);</span><br><span class="line">xhr.overrideMimeType(&quot;text/xml&quot;);</span><br><span class="line">xhr.send(null);</span><br></pre></td></tr></table></figure><p></p><h3 id="三、进度事件"><a href="#三、进度事件" class="headerlink" title="三、进度事件"></a>三、进度事件</h3><p>6个进度事件：</p><ul><li>loadstart：在接收到响应数据的第一个字节时触发。</li><li>progress：在接收响应期间持续不断地触发。</li><li>error：在请求发生错误时触发。</li><li>abort：在因为调用abort()方法而终止时触发。</li><li>load：在接收到完整的响应数据时触发。</li><li>loadend：在通信完成或者触发error、abort或load事件后触发。<br><img src="/2015/04/26/Ajax与Comet/20160419113844270.png" alt="图 进度事件"></li></ul><h4 id="1-load事件"><a href="#1-load事件" class="headerlink" title="1. load事件"></a>1. load事件</h4><p>可以代替readystatechagne事件。其处理程序会接收到一个event对象，其target属性指向XHR对象实例，因而可以访问到XHR对象的所有方法和属性。然而，并非所有浏览器都实现了事件对象。</p><h4 id="2-progress事件"><a href="#2-progress事件" class="headerlink" title="2. progress事件"></a>2. progress事件</h4><p>其处理程序会接收一个event对象，其target属性指向XHR对象实例，但包含着三个额外的属性</p><ul><li>lengthComputable：是一个表示进度信息是否可用的布尔值</li><li>position：表示已经接收的字节数</li><li>totalSize：根据content-length响应头确定的预期字节数<br><strong>注意</strong>：<em>其必须在调用open()方法之前添加</em><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">var xhr = createXHR();        </span><br><span class="line">xhr.onload = function(event)&#123;</span><br><span class="line">    // event.target存在兼容性问题，所以只能使用xhr</span><br><span class="line">    if ((xhr.status &gt;= 200 &amp;&amp; xhr.status &lt; 300) ||  xhr.status == 304)&#123;</span><br><span class="line">        console.log(xhr.responseText);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        console.log(&quot;Request was unsuccessful: &quot; + xhr.status);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">xhr.onprogress = function(event)&#123;</span><br><span class="line">    var divStatus = document.getElementById(&quot;status&quot;);</span><br><span class="line">    if (event.lengthComputable)&#123;</span><br><span class="line">        divStatus.innerHTML = &quot;Received &quot; + event.position + &quot; of &quot; + event.totalSize + &quot; bytes&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">xhr.open(&quot;get&quot;, &quot;altevents.php&quot;, true);</span><br><span class="line">xhr.send(null);</span><br></pre></td></tr></table></figure></li></ul><h3 id="四、跨源资源共享"><a href="#四、跨源资源共享" class="headerlink" title="四、跨源资源共享"></a>四、跨源资源共享</h3><p><strong>CORS（Cross-Origin Resource Sharing）</strong>背后的基本思想，就是使用自定义的HTTP头部让浏览器与服务器进行沟通，从而决定请求或响应是应该成功还是失败。</p><p>在发送请求时，给其附加一个额外的Origin头部，其中包含请求页面的源信息（协议、域名和端口），以便服务器根据这个头部信息来决定是否给予响应。</p><pre><code>Origin: http://www.test.com
</code></pre><p>如果服务认为这个请求可以接受，在Access-Control-Allow-Origin头部中回发相同的源信息（如果是公共资源，可以回发”*”）。</p><pre><code>Access-Control-Allow-Origin: http://www.test.com
</code></pre><p><strong>注意</strong>：请求和响应都不包含cookie信息。</p><h4 id="1-IE中实现CORS：XDR（XDomainRequest），所有的XDR请求都是异步的，不能创建同步请求。其使用方法类似于XHR。"><a href="#1-IE中实现CORS：XDR（XDomainRequest），所有的XDR请求都是异步的，不能创建同步请求。其使用方法类似于XHR。" class="headerlink" title="1. IE中实现CORS：XDR（XDomainRequest），所有的XDR请求都是异步的，不能创建同步请求。其使用方法类似于XHR。"></a>1. IE中实现CORS：XDR（XDomainRequest），所有的XDR请求都是异步的，不能创建同步请求。其使用方法类似于XHR。</h4><h4 id="2-其他浏览器对CORS的实现：通过XMLHttpRequest对象实现对CORS的原生支持。只需给open-方法传入绝对地址。支持同步请求。"><a href="#2-其他浏览器对CORS的实现：通过XMLHttpRequest对象实现对CORS的原生支持。只需给open-方法传入绝对地址。支持同步请求。" class="headerlink" title="2. 其他浏览器对CORS的实现：通过XMLHttpRequest对象实现对CORS的原生支持。只需给open()方法传入绝对地址。支持同步请求。"></a>2. 其他浏览器对CORS的实现：通过XMLHttpRequest对象实现对CORS的原生支持。只需给open()方法传入绝对地址。支持同步请求。</h4><p>跨域XHR对象的安全限制：</p><p>（1）不能使用setRequestHeader()设置自定义头部。</p><p>（2）不能发送和接收cookie。</p><p>（3）调用getAllResponseHeaders()方法总会返回空字符串。</p><p><strong>建议</strong>：访问本地资源，最好使用相对URL；访问远程资源，使用绝对URL。</p><h4 id="3-跨浏览器的CORS"><a href="#3-跨浏览器的CORS" class="headerlink" title="3. 跨浏览器的CORS"></a>3. 跨浏览器的CORS</h4><pre><code>functioncreateCORSRequest(method, url){var xhr = new XMLHttpRequest();
    if (&quot;withCredentials&quot;in xhr){    // 检测XHR是否支持CORS的简单方式，就是检测是否存在withCredentials属性
        xhr.open(method, url, true);
    } elseif (typeof XDomainRequest != &quot;undefined&quot;){    // IE XDR
        xhr = new XDomainRequest();
        xhr.open(method, url);
    } else {
        xhr = null;
    }
    return xhr;
}

var request = createCORSRequest(&quot;get&quot;, &quot;http://www.somewhere-else.com/xdr.php&quot;);
if (request){
    request.onload = function(){//do something with request.responseText
    };
    request.send();
}
</code></pre><h3 id="五、其他跨域技术"><a href="#五、其他跨域技术" class="headerlink" title="五、其他跨域技术"></a>五、其他跨域技术</h3><p>利用DOM中能够执行跨域请求的功能，在不依赖XHR对象的情况下也能发送某种请求，其不需要修改服务器端代码。</p><h4 id="1-图像Ping"><a href="#1-图像Ping" class="headerlink" title="1. 图像Ping"></a>1. 图像Ping</h4><p><code>&lt;img&gt;</code>标签，可以从任何网页中加载图像，无需关注是否跨域。这也是广告跟踪浏览量的主要方式。</p><p>图像Ping是与服务器进行简单、单向的跨域通信的一种方式。浏览器得不到任何具体的数据。但通过监听load和error事件，可以知道响应是什么时间接收到的。</p><pre><code>var img = new Image();
img.onload = img.error = function() {
    console.log(&quot;Done!&quot;);
};
img.src = &quot;http://www.test.com/getImage?id=1&quot;;
</code></pre><p><strong>缺点</strong>:</p><p>（1）只能发送Get请求</p><p>（2）无法访问服务器的响应文本</p><h4 id="2-JSONP（JSON-with-padding）"><a href="#2-JSONP（JSON-with-padding）" class="headerlink" title="2. JSONP（JSON with padding）"></a>2. JSONP（JSON with padding）</h4><p>两部分组成：回调函数和数据。</p><p>回调函数是当响应到来时应该在页面调用的函数。回到函数的名字一般是在请求中指定的。而数据是传入回调函数中的JSON数据。</p><p>JSONP是通过动态<code>&lt;script&gt;</code>元素来使用的</p><pre><code>function handleResponse(response){
    alert(&quot;You&apos;re at IP address &quot; + response.ip + &quot;, which is in &quot; + response.city + &quot;, &quot; + response.region_name);
}

var script = document.createElement(&quot;script&quot;);
script.src = &quot;http://freegeoip.net/json/?callback=handleResponse&quot;;
document.body.insertBefore(script, document.body.firstChild);
</code></pre><p><strong>优点</strong>：能够直接访问响应文本，支持在浏览器与服务器之间双向通信。<br><strong>缺点</strong>：</p><p>（1）JSONP是从其他域中加载代码执行，其安全性无法确保。</p><p>（2）不能很容易的确定JSONP请求是否失败。</p><h4 id="3-Comet"><a href="#3-Comet" class="headerlink" title="3. Comet"></a>3. Comet</h4><p>更高级的Ajax技术，服务器向页面推送数据。</p><p>Comet 本质上和 C/S 中的通信并不一样，它是通过长连接来模拟推送的。也就是说，在没有数据的时候，这个连接挂起，直到有数据来了（推送），服务器端返回响应，该连接结束，客户端的 JS 重新建立下一个等待连接。</p><p>这种方式并不像 C/S 通信建立长期使用的通道，只是长期“等待”而已，避免了在数据更新频率不大的情况下轮询的开销：试想如果五分钟才一次更新，那么轮询方式在此期间几秒钟就要发生一次请求&amp;响应，而这些请求响应都是没有价值的，因为它们并没有传输有用数据。Comet 避免的是这方面的浪费，不再有空请求，因为挂起的连接直到数据更新了才结束。</p><p>性能方面，对于数据量不大但需要实时更新的应用来说，Comet 能更有效利用连接，同时因为没有轮询的心跳频率，Comet 会比轮询更加实时——因为只消耗响应的网络传输时间。</p><p>但是 Comet 本身并不能在数据传输方面提供比轮询更高的效率，仅仅避免了轮询的空请求浪费。所以 Comet 和 web socket 之类的通讯方式差距还是有的。</p><p>大型网站的应用方面，知乎、QQ 邮箱都有用到 Comet，还有新浪微博的私信（聊天）。使用 Comet 主要需要是服务器端的支持，因为使用长连接，所以要有一定负载量一般得使用异步的网络框架，Python 的 tornado、gevent 和 JavaScript 的 node.js 都是此列。</p><p>两种实现Comet的方式：长轮询和流。<br><img src="/2015/04/26/Ajax与Comet/20160419114753780.png" alt="Ajax与Comet-Comet长轮询"></p><p>（1）长轮询：页面发起一个到服务器的请求，然后服务器一直保持连接打开，直到有数据可发送。发送完数据之后，浏览器关闭连接，随即又发起一个到服务器的新请求。【区别：短轮询，服务器立即发送响应，无论是否有效，而长轮询是等待发送响应。】</p><p>（2）HTTP流：生命周期内只使用一个HTTP连接。浏览器向服务器发送一个请求，而服务器保持连接打开，然后周期性地向浏览器发送数据。</p><pre><code>/**
 * progress：接收数据时调用的函数
 * finished：关闭连接时调用的函数
 */
function createStreamingClient(url, progress, finished){
 var xhr = new XMLHttpRequest(),
        received = 0;

    xhr.open(&quot;get&quot;, url, true);
    xhr.onreadystatechange = function(){var result;
        if (xhr.readyState == 3){
            //get only the new data and adjust counter
            result = xhr.responseText.substring(received);
            received += result.length;

            //call the progress callback
            progress(result);
        } elseif (xhr.readyState == 4){
            finished(xhr.responseText);
        }
    };
    xhr.send(null);
    return xhr;
}

var client = createStreamingClient(&quot;streaming.php&quot;,function(data){alert(&quot;Received: &quot; + data);}, function(data){alert(&quot;Done!&quot;);});
</code></pre><p>服务器发送事件：SSE和事件流</p><h4 id="4-Web-Sockets"><a href="#4-Web-Sockets" class="headerlink" title="4. Web Sockets"></a>4. Web Sockets</h4><p>目标是在一个单独的持久连接上提供全双工、双向通信。</p><p>优点：能够在客户端和服务器之间发送非常少量的数据，而不必担心HTTP那样字节级的开销。</p><p>缺点：制定协议的时间比制定JavaScript API的时间还要长。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 必须给WebSocket构造函数传入绝对URL</span><br><span class="line">var socket = new WebSocket(&quot;ws://www.example.com/server.php&quot;);</span><br><span class="line">// 向服务器发送数据（只能发送纯文本，其他数据需要序列化）</span><br><span class="line">socket.send(&quot;Hello&quot;);</span><br><span class="line">// 接收服务器的响应数据</span><br><span class="line">socket.onmessage = function(event) &#123;</span><br><span class="line">    var data = event.data;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p>其他事件：</p><ul><li>open：在成功建立连接时触发。</li><li>error：在发生错误时触发，连接不能持续。</li><li>close：在连接关闭时触发。</li></ul><p><strong>注意</strong>：WebSocket对象不支持DOM 2级事件侦听器，必须使用DOM 0级语法分别定义各个事件。</p><h3 id="jQuery-comet-js"><a href="#jQuery-comet-js" class="headerlink" title="jQuery.comet.js"></a>jQuery.comet.js</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">jQuery.comet = &#123;</span><br><span class="line"></span><br><span class="line">    fetching: false,</span><br><span class="line">    settings: &#123;&#125;,</span><br><span class="line">    url: &apos;&apos;,</span><br><span class="line">    bound: &#123;&#125;,</span><br><span class="line">    connect: function(url, options) &#123;</span><br><span class="line">        jQuery.comet.settings = jQuery.extend(&#123;</span><br><span class="line">            timeout: 60000,</span><br><span class="line">            onError: null,</span><br><span class="line">            requestMethod: &apos;GET&apos;,</span><br><span class="line">            typeAttr: &apos;type&apos;,</span><br><span class="line">            dataAttr: &apos;data&apos;</span><br><span class="line">        &#125;, options);</span><br><span class="line">        jQuery.comet.url = url;</span><br><span class="line">        jQuery.comet.fetch();</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    fetch: function() &#123;</span><br><span class="line">        if (jQuery.comet.fetching)</span><br><span class="line">            return;</span><br><span class="line"></span><br><span class="line">        jQuery.comet.fetching = true;</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            type: jQuery.comet.settings.requestMethod,</span><br><span class="line">            url: jQuery.comet.url,</span><br><span class="line">        </span><br><span class="line">            async: true,</span><br><span class="line">            cache: true,</span><br><span class="line">            timeout: jQuery.comet.settings.timeout,</span><br><span class="line">            ifModified: true,</span><br><span class="line">        </span><br><span class="line">            success: function(data) &#123;</span><br><span class="line">                jQuery.comet.fetching = false;</span><br><span class="line">                jQuery.comet.handle_update(data);</span><br><span class="line">                setTimeout(jQuery.comet.fetch, 1);</span><br><span class="line">            &#125;,</span><br><span class="line">            error: function(XMLHttpRequest, textStatus, errorThrown) &#123;</span><br><span class="line">                jQuery.comet.fetching = false;</span><br><span class="line">                if (textStatus == &apos;timeout&apos;) &#123;</span><br><span class="line">                    jQuery.comet.fetch()</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    if (jQuery.comet.settings.onError != null) &#123;</span><br><span class="line">                        jQuery.comet.settings.onError(XMLHttpRequest, textStatus, errorThrown);</span><br><span class="line">                    &#125;</span><br><span class="line">                    setTimeout(jQuery.comet.fetch, 10000);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    handle_update: function(update) &#123;</span><br><span class="line">        type = null;</span><br><span class="line">        data = update;</span><br><span class="line">        </span><br><span class="line">        if (update[jQuery.comet.settings.typeAttr]) &#123;</span><br><span class="line">            type = update[jQuery.comet.settings.typeAttr];</span><br><span class="line">        &#125;</span><br><span class="line">        if (update[jQuery.comet.settings.dataAttr]) &#123;</span><br><span class="line">            data = update[jQuery.comet.settings.dataAttr];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        jQuery(document).trigger(type + &quot;.comet&quot;, [data, type]);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2015/04/17/CSS-content属性/" rel="next" title="CSS content属性"><i class="fa fa-chevron-left"></i> CSS content属性</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2015/05/19/CSS等比例缩放的盒子/" rel="prev" title="CSS等比例缩放的盒子">CSS等比例缩放的盒子<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/tx.jpg" alt="李斌"><p class="site-author-name" itemprop="name">李斌</p><p class="site-description motion-element" itemprop="description">想要飞得高，那就把地平线忘掉</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">157</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">1</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/libin1991" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://juejin.im/user/57e737f6c4c971005f6bcd8d" target="_blank" title="juejin"><i class="fa fa-fw fa-spinner"></i> juejin</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#服务器有新消息主动推送给客户端浏览器"><span class="nav-number">1.</span> <span class="nav-text">服务器有新消息主动推送给客户端浏览器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一、XMLHttpRequest对象"><span class="nav-number">2.</span> <span class="nav-text">一、XMLHttpRequest对象</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-XHR的用法"><span class="nav-number">2.1.</span> <span class="nav-text">1. XHR的用法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-HTTP头部信息"><span class="nav-number">2.2.</span> <span class="nav-text">2. HTTP头部信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-GET请求"><span class="nav-number">2.3.</span> <span class="nav-text">3. GET请求</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-POST请求"><span class="nav-number">2.4.</span> <span class="nav-text">4. POST请求</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二、XMLHttpRequest-2级"><span class="nav-number">3.</span> <span class="nav-text">二、XMLHttpRequest 2级</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-FormData"><span class="nav-number">3.1.</span> <span class="nav-text">1. FormData</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-超时设定"><span class="nav-number">3.2.</span> <span class="nav-text">2. 超时设定</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-overrideMimeType-方法"><span class="nav-number">3.3.</span> <span class="nav-text">3. overrideMimeType()方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三、进度事件"><span class="nav-number">4.</span> <span class="nav-text">三、进度事件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-load事件"><span class="nav-number">4.1.</span> <span class="nav-text">1. load事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-progress事件"><span class="nav-number">4.2.</span> <span class="nav-text">2. progress事件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#四、跨源资源共享"><span class="nav-number">5.</span> <span class="nav-text">四、跨源资源共享</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-IE中实现CORS：XDR（XDomainRequest），所有的XDR请求都是异步的，不能创建同步请求。其使用方法类似于XHR。"><span class="nav-number">5.1.</span> <span class="nav-text">1. IE中实现CORS：XDR（XDomainRequest），所有的XDR请求都是异步的，不能创建同步请求。其使用方法类似于XHR。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-其他浏览器对CORS的实现：通过XMLHttpRequest对象实现对CORS的原生支持。只需给open-方法传入绝对地址。支持同步请求。"><span class="nav-number">5.2.</span> <span class="nav-text">2. 其他浏览器对CORS的实现：通过XMLHttpRequest对象实现对CORS的原生支持。只需给open()方法传入绝对地址。支持同步请求。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-跨浏览器的CORS"><span class="nav-number">5.3.</span> <span class="nav-text">3. 跨浏览器的CORS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#五、其他跨域技术"><span class="nav-number">6.</span> <span class="nav-text">五、其他跨域技术</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-图像Ping"><span class="nav-number">6.1.</span> <span class="nav-text">1. 图像Ping</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-JSONP（JSON-with-padding）"><span class="nav-number">6.2.</span> <span class="nav-text">2. JSONP（JSON with padding）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-Comet"><span class="nav-number">6.3.</span> <span class="nav-text">3. Comet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-Web-Sockets"><span class="nav-number">6.4.</span> <span class="nav-text">4. Web Sockets</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jQuery-comet-js"><span class="nav-number">7.</span> <span class="nav-text">jQuery.comet.js</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">李斌</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div> <span class="post-meta-divider">|</span><div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script type="text/javascript" src="/js/src/clicklove.js"></script><script type="text/javascript" src="/js/src/clipboard.min.js"></script><script type="text/javascript" src="/js/src/clipboard-use.js"></script></body></html>