<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="舞动乾坤">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="舞动乾坤">
<meta property="og:description" content="Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="舞动乾坤">
<meta name="twitter:description" content="Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>舞动乾坤 - 星光不问赶路人 岁月不负有心人</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband">
    	<div class="eevee"><div class="body"><div class="head"><div class="ears"><div class="ear"><div class="lobe"></div></div><div class="ear"><div class="lobe"></div></div></div><div class="face"><div class="eyes"><div class="eye"><div class="eyelid"></div></div><div class="eye"><div class="eyelid"></div></div></div><div class="nose"></div><div class="mouth"></div></div></div><div class="chest"><div class="fur"><div class="patch"></div></div><div class="fur"><div class="patch"></div></div><div class="fur"><div class="patch"></div></div></div><div class="legs"><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div></div><div class="tail"><div class="tail"><div class="tail"><div class="tail"><div class="tail"><div class="tail -end"></div></div></div></div></div></div></div></div>
    </div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
    	<div id="sky">
				<div id="background" class="container">
			<!-- svg file -->
			<svg id="svgout" height="100%" width="100%" viewbox="0 0 550 400">
				<defs>
					<g id="bottomShadow">
						<path fill="#000000" stroke="none" d="
		M 270.5 225.95
		L 127.35 316.65 266.8 400 409.6 309.25 270.5 225.95 Z"/>
					</g>
					<g id="Layer52_0_FILL">
						<path class="topGrass" fill="#B9D668" stroke="none" d="
	M 397.85 229.3
	L 397.85 225.6 269.85 152 135.75 228.6 135.75 233.65 262.1 306.55 397.85 229.3 Z"/>
					</g>
					<g id="Layer51_0_FILL">
						<path class="leftSideGrass" fill="#6E9E4F" stroke="none" d="
	M 135.1 229.95
	L 135.1 256.85 262.1 328.4 262.1 301.85 135.1 229.95 Z"/>
					</g>
					<g id="Layer50_0_FILL">
						<path class="rightGrassTop" fill="#8CB154" stroke="none" d="
	M 397.85 225.95
	L 395.8 225.95 261.75 301.55 261.75 328.4 397.85 251.15 397.85 225.95 Z"/>
					</g>
					<g id="Layer48_0_FILL">
						<path class="crustLeftTop" fill="#955541" stroke="none" d="
	M 135.45 282.4
	L 135.75 298.15 262.1 372.1 261.75 355.65 135.45 282.4 Z"/>
					</g>
					<g id="Layer47_0_FILL">
						<path class="middleLeftCrust" fill="#C77E61" stroke="none" d="
	M 135.1 270.3
	L 135.1 283.05 275.9 364.35 271.85 348.9 135.1 270.3 Z"/>
					</g>
					<g id="Layer46_0_FILL">
						<path class="crustLeftTop" fill="#955541" stroke="none" d="
	M 135.1 255.15
	L 135.1 270.3 262.1 343.55 262.1 328.05 135.1 255.15 Z"/>
					</g>
					<g id="Layer45_0_FILL">
						<path class="topRightCrust" fill="#A47237" stroke="none" d="
	M 397.5 294.5
	L 397.5 277 261.75 355.3 261.75 372.75 397.5 294.5 Z"/>
					</g>
					<g id="Layer44_0_FILL">
						<path class="middleRightCrust" fill="#C89451" stroke="none" d="
	M 397.5 269.95
	L 397.15 266.6 262.1 343.2 262.1 355.95 397.5 279.7 397.5 269.95 Z"/>
					</g>
					<g id="Layer43_0_FILL">
						<path class="topRightCrust" fill="#A47237" stroke="none" d="
	M 397.5 266.6
	L 397.5 250.45 261.75 328.4 261.75 343.85 397.5 266.6 Z"/>
					</g>
					<g id="Layer41_0_FILL">
						<path class="greyRoad" fill="#B2B2B1" stroke="none" d="
	M 295.05 283.05
	Q 299.05 280.35 308.45 275.3 317.85 269.95 323.6 266.9
	L 268.8 233.65 338.05 191.35 309.15 174.55 177.75 254.5
	Q 191.55 262.2 198.25 266.25 204.65 269.95 209.7 271.95
	L 241.6 250.45 295.05 283.05 Z"/>
					</g>
					<g id="Layer40_0_FILL">
						<path fill="#FFFFFF" stroke="none" d="
	M 199.95 256.85
	Q 194.55 261.2 191.9 262.2
	L 194.9 263.9 200.95 259.2 199.95 256.85
	M 225.8 243.75
	L 224.8 241.75 211.05 250.8 212.05 252.8 225.8 243.75
	M 308.15 275.65
	L 296.7 266.6 295.35 268.6 306.8 277.7 308.15 275.65
	M 275.9 253.5
	L 274.55 255.5 285.95 264.55 287.3 262.55 275.9 253.5
	M 251.7 227.3
	L 250.7 225.25 236.9 234.35 237.9 236.35 251.7 227.3
	M 257.05 240.7
	L 254.05 240.7 268.8 249.8 269.5 247.75 257.05 240.7
	M 277.2 207.8
	L 263.45 216.85 264.45 218.9 278.25 209.8 277.2 207.8
	M 305.1 192.65
	L 304.1 190.65 290.3 199.75 291.35 201.75 305.1 192.65 Z"/>
					</g>
					<g id="Layer38_0_FILL">
						<path class="frontFascia" fill="#ECB27B" stroke="none" d="
	M 359.25 187.95
	L 346.4 174.95 333.85 202.9 359.25 187.95 Z"/>
					</g>
					<g id="Layer37_0_FILL">
						<path class="frontWall" fill="#EFA258" stroke="none" d="
	M 334 201.05
	L 334.35 232 359.2 217.55 359.25 187.95 334 201.05 Z"/>
					</g>
					<g id="Layer36_0_FILL">
						<path class="leftWall" fill="#C57F42" stroke="none" d="
	M 334.35 232.3
	L 334.35 205.1 305.1 191.35 305.1 216.85 334.35 232.3 Z"/>
					</g>
					<g id="Layer35_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 329.7 167.9
	L 331.05 167.9 344.55 176.7 347.85 176.7 363 192.25 363.15 189.55 350.65 176.7 350.55 176.7 334.25 167.5 334.25 159.1 329.7 159.1 329.7 164.9 322.65 160.95 322.3 162.15 329.7 167 329.7 167.9 Z"/>
					</g>
					<g id="Layer34_0_FILL">
						<path class="leftRoof" fill="#F2563B" stroke="none" d="
	M 334.05 207.05
	L 350.65 176.7 322.1 160.45 302.1 192.05 334.05 207.05 Z"/>
					</g>
					<g id="Layer30_0_FILL">
						<path id="windowFour" class="windows" stroke="none" fill="#975A42" d="
	M 341.35 203.3
	Q 340.9 203.45 340.5 203.8 340.1 204.2 339.85 204.75 339.7 205 339.7 205.3 339.6 205.75 339.7 206.1 339.7 206.15 339.7 206.2 339.8 206.5 340 206.8 340.55 207.4 341.45 207.4 342.35 207.4 343 206.8 343.4 206.5 343.65 206.1 343.85 205.75 343.95 205.3 344.05 204.4 343.55 203.8 343.3 203.45 343 203.3 342.65 203.15 342.2 203.15 341.8 203.15 341.35 203.3
	M 355.85 198.45
	Q 355.8 198.2 355.6 198 355.1 197.4 354.2 197.4 353.35 197.4 352.6 198 351.85 198.65 351.7 199.55 351.7 199.7 351.7 199.85 351.6 200.5 352 201.05 352.55 201.65 353.45 201.65 354.3 201.65 355.05 201.05 355.45 200.7 355.7 200.25 355.8 200.05 355.9 199.85 355.95 199.7 355.95 199.55 356.05 198.95 355.85 198.45 Z"/>
						<path class="door" fill="#B65041" stroke="none" d="
	M 351.95 211.2
	L 351.8 211.2 346.05 215.1 346.05 225.2 351.95 221.6 351.95 211.2
	M 351.2 211.2
	L 351.35 211.2 351.35 211.1 351.2 211.2 Z"/>
					</g>
					<g>
						<path id="Layer30_0_FILL" fill="#000000" fill-opacity="1" stroke="none" d="
	M 183.7 215.3
	L 183.7 215.6
	Q 187.25 231.75 212.25 234.35
	L 183.7 215.3 Z"/>
					</g>
					<g id="Layer29_0_FILL">
						<path fill="#000000" fill-opacity="0.4" stroke="none" d="
	M 305.1 216.85
	L 305.15 217.2
	Q 309.45 233.2 334.35 232.3
	L 305.1 216.85 Z"/>
					</g>
					<g id="Layer27_0_FILL">
						<path class="vegetation" fill="#78A950" stroke="none" d="
	M 177.45 231.65
	Q 175.75 235.35 181.8 239.35 185.5 235.7 185.15 231.3 182.8 230.65 181.45 234 179.45 231.3 177.45 231.65
	M 236.9 266.6
	Q 235.2 270.3 241.25 274.3 244.95 270.6 244.65 266.25 242.3 265.6 240.95 268.95 238.9 266.25 236.9 266.6
	M 254.7 277
	Q 253.05 280.7 259.1 284.75 262.75 281.05 262.45 276.65 260.1 276 258.75 279.35 256.7 276.65 254.7 277
	M 315.5 245.75
	Q 313.5 243.05 311.5 243.4 309.8 247.1 315.85 251.15 319.55 247.45 319.2 243.05 316.85 242.4 315.5 245.75
	M 295.35 232.65
	Q 293.7 236.35 299.75 240.4 303.45 236.7 303.1 232.3 300.75 231.65 299.4 235 297.4 232.3 295.35 232.65
	M 277.2 171.85
	Q 275.55 175.55 281.6 179.55 285.3 175.85 284.95 171.5 282.6 170.85 281.25 174.2 279.25 171.5 277.2 171.85 Z"/>
					</g>
					<g id="Layer26_0_FILL">
						<path class="treeWood" fill="#AE663D" stroke="none" d="
	M 175.1 177.55
	L 172.05 177.55 172.05 191.1 159.3 172.85
	Q 154.6 171.5 172.05 195.7
	L 172.05 212.5 175.1 212.5 175.1 177.55
	M 252.7 151.35
	L 249 151.35 249 176.9 252.7 176.9 252.7 151.35 Z"/>
					</g>
					<g id="Layer25_0_FILL">
						<path class="vegetation" fill="#77A951" stroke="none" d="
	M 192.55 179.55
	Q 200.95 173.5 200.95 165.1 200.95 156.4 192.55 150 184.15 144.3 172.05 144.3 160.3 144.3 151.9 150 143.15 156.4 143.15 165.1 143.15 173.5 151.9 179.55 160.3 185.95 172.05 185.95 184.15 185.95 192.55 179.55
	M 236.25 106.65
	Q 230.2 116.05 230.2 129.15 230.2 142.25 236.25 151.35 242.3 160.75 250.7 160.75 258.75 160.75 264.8 151.35 270.85 142.25 270.85 129.15 270.85 116.05 264.8 106.65 258.75 97.6 250.7 97.6 242.3 97.6 236.25 106.65 Z"/>
					</g>
					<g id="Layer24_0_FILL">
						<path class="vegetation" fill="#77A951" stroke="none" d="
	M 158.3 221.9
	Q 160.65 221.9 161.95 220.2 163 219.55 163.3 218.55 164.65 218.9 166.35 218.9 170.05 218.9 172.4 216.2 175.1 213.85 175.1 210.15 175.1 206.45 172.4 203.75 170.05 201.4 166.35 201.4 162.65 201.4 159.95 203.75 157.6 206.45 157.6 210.15 157.6 210.8 157.6 211.15 155.95 211.5 154.6 212.5 152.9 214.15 152.9 216.55 152.9 218.9 154.6 220.2 156.25 221.9 158.3 221.9
	M 338.35 240.05
	Q 341.05 237.7 341.05 234 341.05 230.3 338.35 227.6 336 225.25 332.3 225.25 328.65 225.25 325.95 227.6 323.6 230.3 323.6 234 323.6 237.7 325.95 240.05 328.65 242.75 332.3 242.75 336 242.75 338.35 240.05 Z"/>
					</g>
					<g id="Layer22_0_FILL">
						<path class="rightRoof" fill="#D05041" stroke="none" d="
	M 220 173.85
	L 236.8 186.7 264.35 171.15 244.5 159.55 220 173.85 Z"/>
					</g>
					<g id="Layer21_0_FILL">
						<path class="leftWall" fill="#C57F42" stroke="none" d="
	M 212.25 191.35
	L 183.35 172.3 183.7 215.3 212.25 234.35 212.25 191.35 Z"/>
					</g>
					<g id="Layer20_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 192.1 149.85
	L 236.45 174.8 243.1 171.4
	Q 220.05 150.55 196.3 139.95
	L 192.1 149.85 Z"/>
					</g>
					<g id="Layer19_0_FILL">
						<path class="frontFascia" fill="#EBB17B" stroke="none" d="
	M 226.85 160.95
	L 212 190.6 229.75 192.6 239.75 172.85 226.85 160.95 Z"/>
					</g>
					<g id="Layer18_0_FILL">
						<path class="frontWall" fill="#EFA258" stroke="none" d="
	M 240.15 172.65
	L 211.9 191.6 212.25 233.65 264.35 201.7 264.35 170.8 240.8 184.45 240.15 172.65 Z"/>
					</g>
					<g id="Layer17_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 210.9 142.2
	L 205.9 142.2 205.9 152.65 210.9 152.65 210.9 142.2 Z"/>
					</g>
					<g>
						<path id="Layer16_0_FILL" class="leftRoof" fill="#F2563B" stroke="none" d="
	M 210.25 195.5
	L 227.4 160.95 195.45 141.35 177.65 175.85 210.25 195.5 Z"/>
					</g>
					<g>
						<path id="sun" fill="#E3BD0E" stroke="none" d="
	M 257.05 15.95
	Q 251.7 15.95 248 19.65 244.3 23.35 244.3 28.7 244.3 34.1 248 37.8 251.7 41.5 257.05 41.5 262.45 41.5 266.15 37.8 269.85 34.1 269.85 28.7 269.85 23.35 266.15 19.65 262.45 15.95 257.05 15.95 Z"/>
					</g>
					<g id="Layer8_0_FILL">
						<path fill="#975A42" stroke="none" d="
	M 238.45 189.65
	Q 238.295703125 189.362109375 238.05 189.1 237.35 188.3 236.2 188.3 235.05 188.3 234.15 189.1 233.3 189.9 233.2 191.05 233.1 192.2 233.8 193 234.55 193.8 235.7 193.8 236.85 193.8 237.7 193 238.1970703125 192.558203125 238.45 192 238.6552734375 191.56484375 238.7 191.05 238.7671875 190.276953125 238.45 189.65
	M 220.55 197.55
	Q 220 197.55 219.5 197.75 218.95 197.95 218.5 198.35 217.933203125 198.8833984375 217.7 199.55 217.5833984375 199.916796875 217.55 200.3 217.4923828125 200.96171875 217.7 201.5 217.852734375 201.9103515625 218.15 202.25 218.95 203.05 220.1 203.05 221.25 203.05 222.05 202.25 222.95 201.45 223.05 200.3 223.15 199.15 222.4 198.35 222.05 197.95 221.65 197.75 221.15 197.55 220.55 197.55 Z"/>
					</g>
					<g id="Layer7_0_FILL">
						<path class="door" fill="#B65041" stroke="none" d="
	M 233.55 206.75
	L 225.9 211.95 226.25 225.5 233.95 220.35 233.55 206.75 Z"/>
					</g>
					<g>
						<path id="windowOne" class="windows" fill="#975A42" stroke="none" d="
	M 188.65 198.4
	L 188.8 204.1 198.65 210.45 198.55 204.75 188.65 198.4
	M 208.45 216.8
	L 208.35 211.1 198.55 204.75 198.65 210.45 208.45 216.8
	M 188.8 204.1
	L 188.95 209.8 198.8 216.15 198.65 210.45 188.8 204.1
	M 208.6 222.5
	L 208.45 216.8 198.65 210.45 198.8 216.15 208.6 222.5 Z"/>
					</g>
					<g>
						<path id="windowThree" class="windows" fill="#975A42" stroke="none" d="
	M 311.7 214.1
	L 318.55 217.55 318.45 211.9 311.6 208.45 311.7 214.1
	M 325.4 221
	L 325.25 215.35 318.45 211.9 318.55 217.55 325.4 221
	M 318.4 206.2
	L 311.5 202.75 311.6 208.45 318.45 211.9 318.4 206.2
	M 325.25 215.35
	L 325.2 209.7 318.4 206.2 318.45 211.9 325.25 215.35 Z"/>
					</g>
					<g id="Layer2_0_FILL">
						<path class="door" fill="#B65041" stroke="none" d="
	M 259.7 183.25
	L 244.6 191.9 244.6 213.8 259.7 204.55 259.7 183.25 Z"/>
					</g>
					<path id="windowTwo" fill="#975A42" class="windows" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" d="
	M 223.05 200.3
	Q 222.95 201.45 222.05 202.25 221.25 203.05 220.1 203.05 218.95 203.05 218.15 202.25 217.852734375 201.9103515625 217.7 201.5 217.4923828125 200.96171875 217.55 200.3 217.5833984375 199.916796875 217.7 199.575 217.933203125 198.8833984375 218.5 198.35 218.95 197.95 219.5 197.75 220 197.55 220.55 197.55 221.15 197.55 221.65 197.75 222.05 197.95 222.4 198.35 223.15 199.15 223.05 200.3 Z
	M 238.7 191.05
	Q 238.6552734375 191.56484375 238.45 192 238.1970703125 192.558203125 237.7 193 236.85 193.8 235.7 193.8 234.55 193.8 233.8 193 233.1 192.2 233.2 191.05 233.3 189.9 234.15 189.1 235.05 188.3 236.2 188.3 237.35 188.3 238.05 189.1 238.295703125 189.362109375 238.45 189.65 238.7671875 190.276953125 238.7 191.05 Z"/>
					<path fill="#F2563B" stroke="none" d=" M 351.95 211.2 L 351.8 211.2 346.05 215.1 346.05 225.2 351.95 221.6 351.95 211.2 Z"/>
					<path id="Layer6_0_1_STROKES" class="windowRims" stroke="#AE663D" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" fill="none" d="
	M 198.55 204.75
	L 208.35 211.1 208.45 216.8 208.6 222.5 198.8 216.15 188.95 209.8 188.8 204.1 188.65 198.4 198.55 204.75 198.65 210.45 208.45 216.8
	M 198.8 216.15
	L 198.65 210.45 188.8 204.1"/>
					<path id="Layer5_0_1_STROKES" class="windowRims" stroke="#AE663D" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" fill="none" d="
	M 325.25 215.35
	L 325.4 221 318.55 217.55 311.7 214.1 311.6 208.45 311.5 202.75 318.4 206.2 325.2 209.7 325.25 215.35 318.45 211.9 318.55 217.55
	M 318.4 206.2
	L 318.45 211.9 311.6 208.45"/>
				</defs>
				<g id="shadow">
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use xlink:href="#bottomShadow"/>
					</g>
				</g>
				<g transform="matrix( 1, 0, 0, 1, 0,0) ">
					<use xlink:href="#sun"/>
				</g>
				<g id="earth">
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer52_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer51_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer50_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer48_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer47_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer46_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer45_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer44_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer43_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer41_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer40_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer38_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer37_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer36_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer35_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer34_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowFour"/>
						<use class="element" xlink:href="#Layer32_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer30_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer27_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer26_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer25_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer24_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer22_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer21_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer20_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer19_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer18_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer17_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer16_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer8_0_FILL"/>
						<use class="element" xlink:href="#windowTwo"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer7_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowOne"/>
						<use class="element" xlink:href="#Layer6_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowThree"/>
						<use class="element" xlink:href="#Layer5_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer2_0_FILL"/>
					</g>
				</g>
			</svg>
			<! -- End of SVG file -->
			<! -- Moon/Sun Toggle -->
			<div id="toggleButton" class="day-toggle">
				<div class="sun-icon"></div>
				<label class="switch">
            <input id="toggleCheckbox" type="checkbox">
            <div class="slider"></div>
        </label>
				<div class="cloud-icon"></div>
			</div>
			<! -- Moon/Sun Toggle -->
			<! -- End of Container -->
		</div>
			</div>
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">舞动乾坤</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">星光不问赶路人 岁月不负有心人</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/03/知否-？知否-？React插件了解一下！/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/03/知否-？知否-？React插件了解一下！/" itemprop="url">知否 ？知否 ？React插件了解一下！</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-03T15:50:17+08:00">
                2019-05-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="为什么选择插件，而不是组件？"><a href="#为什么选择插件，而不是组件？" class="headerlink" title="为什么选择插件，而不是组件？"></a>为什么选择插件，而不是组件？</h3><ul>
<li><font color="#ff0000"><strong>调用简单  this.$toast(“xxx”) ，不必再模板中提前定义 , 动态插入移除</strong></font></li>
<li>插件独立于业务</li>
<li>更新不影响代码逻辑，做到热更新</li>
<li>抽象逻辑</li>
<li>适用于toast，Dialog，Alert，Message，picker，Actionsheet等组件</li>
</ul>
<p><img src="/2019/05/03/知否-？知否-？React插件了解一下！/1.gif" alt=""></p>
<h3 id="react-toast-alert-demo地址"><a href="#react-toast-alert-demo地址" class="headerlink" title="react-toast-alert demo地址"></a><a href="https://github.com/libin1991/react-toast-alert" target="_blank" rel="noopener"><font color="#dd0000"><strong>react-toast-alert demo地址</strong></font></a></h3><blockquote>
<p>使用方法：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> $ <span class="keyword">from</span> <span class="string">'@/component/Toast/index'</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$.toast(&#123;</span><br><span class="line">	type:<span class="number">0</span>,</span><br><span class="line">	content: <span class="string">"我是默认Toast"</span>,</span><br><span class="line">	time: <span class="number">1000</span>,</span><br><span class="line">	opacity: <span class="number">.5</span>,</span><br><span class="line">	onSucc() &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">"我是Toast的回调！"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"> &#125;);</span><br><span class="line"></span><br><span class="line">$.toast(<span class="string">"我是默认Toast"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$.toast(&#123;</span><br><span class="line">	type:<span class="number">3</span>,</span><br><span class="line">	content: <span class="string">"我是默认loading"</span>,</span><br><span class="line">	time: <span class="number">1000</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;  <span class="comment">//3s后隐藏</span></span><br><span class="line">	$.hide();</span><br><span class="line">&#125;, <span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$.dialog(&#123;</span><br><span class="line">	type: <span class="number">0</span>,</span><br><span class="line">	opacity:<span class="number">0.5</span>,</span><br><span class="line">	title: <span class="string">"我是title"</span>,</span><br><span class="line">	content: <span class="string">"我是content"</span>,</span><br><span class="line">	btnSucc: <span class="string">"我是成功"</span>,</span><br><span class="line">	btnFail: <span class="string">"我是取消"</span>,</span><br><span class="line">	onSucc(e) &#123;</span><br><span class="line">		e.stopPropagation();</span><br><span class="line">		$.toast(<span class="string">"我是默认Toast"</span>);</span><br><span class="line">	&#125;,</span><br><span class="line">	onFail(e) &#123;</span><br><span class="line">		e.stopPropagation();</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">"我是失败的回调！"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Vue-插件"><a href="#Vue-插件" class="headerlink" title="Vue 插件"></a>Vue 插件</h3><p>在Vue里，一般将toast，alert等非业务相关的写成插件，挂载在Vue的原型链上，使用的时候直接this.$toast即可，非常方便！相关原理在这里就不说了，感兴趣的可以查阅官网.<br>先看看Vue的插件写法：</p>
<blockquote>
<p>@/components/vue-toast/index.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ToastComponent <span class="keyword">from</span> <span class="string">"./vue-toast.vue"</span>; <span class="comment">// 引入先前写好的vue</span></span><br><span class="line"><span class="keyword">var</span> Toast = &#123;&#125;;</span><br><span class="line"><span class="comment">//避免重复install，设立flag</span></span><br><span class="line">Toast.installed = <span class="literal">false</span>;</span><br><span class="line">Toast.install = <span class="function"><span class="keyword">function</span>(<span class="params">Vue, options = &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">	type: <span class="string">"success"</span>, <span class="regexp">//</span>success fail  warning loading toast</span></span></span><br><span class="line"><span class="function"><span class="params">	msg: <span class="string">"操作成功"</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">	time: <span class="number">1000</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">	callback(</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;) &#123;</span><br><span class="line">	<span class="keyword">if</span>(Toast.installed) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">var</span> obj;</span><br><span class="line">	Vue.prototype.$toast = <span class="function">(<span class="params">config = &#123;&#125;, type</span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">if</span>(type == <span class="string">'close'</span>) &#123;</span><br><span class="line">			obj &amp;&amp; obj.removeToast();</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">typeof</span> config==<span class="string">"object"</span>)&#123;</span><br><span class="line">			config = &#123;</span><br><span class="line">				...options,</span><br><span class="line">				...config</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			config = &#123;</span><br><span class="line">				...options,</span><br><span class="line">				...&#123;</span><br><span class="line">					type: <span class="string">"toast"</span>, </span><br><span class="line">	                msg: config</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 如果页面有toast则不继续执行</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">document</span>.querySelector(<span class="string">'.vue-toast'</span>)) <span class="keyword">return</span>;</span><br><span class="line">		<span class="comment">// 1、创建构造器，定义好提示信息的模板</span></span><br><span class="line">		<span class="keyword">const</span> toastTip = Vue.extend(ToastComponent);</span><br><span class="line">		obj = <span class="keyword">new</span> toastTip();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">var</span> property <span class="keyword">in</span> config) &#123;</span><br><span class="line">			obj[property] = config[property];</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//删除弹框</span></span><br><span class="line">		obj.removeToast = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			<span class="built_in">document</span>.body.removeChild(tpl);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//插入页面</span></span><br><span class="line">		<span class="keyword">let</span> tpl = obj.$mount().$el;</span><br><span class="line">		<span class="built_in">document</span>.body.appendChild(tpl);</span><br><span class="line">		Toast.installed = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>([<span class="string">'success'</span>, <span class="string">'fail'</span>, <span class="string">'warning'</span>,<span class="string">'toast'</span>].indexOf(config.type) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">			setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">				obj.removeToast();</span><br><span class="line">				obj.callback();</span><br><span class="line">			&#125;, config.time)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		[<span class="string">'close'</span>].forEach(<span class="function"><span class="keyword">function</span>(<span class="params">type</span>) </span>&#123;</span><br><span class="line">			Vue.prototype.$toast[type] = <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">return</span> Vue.prototype.$toast(&#123;&#125;, type)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 自动安装  ，有了ES6就不要写AMD，CMD了</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">'undefined'</span> &amp;&amp; <span class="built_in">window</span>.Vue) &#123;</span><br><span class="line">	<span class="built_in">window</span>.Vue.use(Toast)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Toast</span><br></pre></td></tr></table></figure>
<blockquote>
<p>@/components/vue-toast/vue-toast.vue</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"mask vue-toast"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"toast"</span> <span class="attr">v-if</span>=<span class="string">"['success', 'fail', 'warning','loading'].indexOf(type) &gt; -1"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"icon"</span> <span class="attr">v-if</span>=<span class="string">"['success', 'fail', 'warning'].indexOf(type) &gt; -1"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"type=='success'"</span> <span class="attr">class</span>=<span class="string">"success-icon"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"type=='fail'"</span> <span class="attr">class</span>=<span class="string">"fail-icon"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"type=='warning'"</span> <span class="attr">class</span>=<span class="string">"warning-icon"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"loading-icon"</span> <span class="attr">v-else</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"msg"</span> <span class="attr">v-html</span>=<span class="string">"msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-else</span> <span class="attr">class</span>=<span class="string">"toast-msg"</span> <span class="attr">v-html</span>=<span class="string">"msg"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="undefined">  data() &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">      msg: <span class="string">" "</span>,</span></span><br><span class="line"><span class="javascript">      type: <span class="string">"success"</span></span></span><br><span class="line"><span class="undefined">    &#125;;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">&#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>=<span class="string">"scoped "</span> <span class="attr">lang</span>=<span class="string">"less"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-class">.mask</span> &#123;</span></span><br><span class="line"><span class="undefined">  width: 100%;</span></span><br><span class="line"><span class="undefined">  height: 100%;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">background</span>: <span class="selector-tag">rgba</span>(0, 0, 0, 0<span class="selector-class">.4</span>);</span></span><br><span class="line"><span class="undefined">  position: fixed;</span></span><br><span class="line"><span class="undefined">  left: 0px;</span></span><br><span class="line"><span class="undefined">  top: 0px;</span></span><br><span class="line"><span class="undefined">  display: flex;</span></span><br><span class="line"><span class="undefined">  justify-content: center;</span></span><br><span class="line"><span class="undefined">  align-items: center;</span></span><br><span class="line"><span class="undefined">  z-index: 10000;</span></span><br><span class="line"><span class="css">  <span class="selector-class">.toast-msg</span> &#123;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">font-size</span>: 0<span class="selector-class">.24rem</span>;</span></span><br><span class="line"><span class="undefined">    text-align: center;</span></span><br><span class="line"><span class="undefined">    position: relative;</span></span><br><span class="line"><span class="undefined">    transform: translateX(-50%);</span></span><br><span class="line"><span class="css">    <span class="selector-tag">color</span>: <span class="selector-id">#fff</span>;</span></span><br><span class="line"><span class="undefined">    left: 50%;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">padding</span>: 0<span class="selector-class">.18rem</span> 0<span class="selector-class">.27rem</span>;</span></span><br><span class="line"><span class="undefined">    overflow: hidden;</span></span><br><span class="line"><span class="undefined">    border-radius: 4px;</span></span><br><span class="line"><span class="undefined">    white-space: nowrap;</span></span><br><span class="line"><span class="undefined">    display: block;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">background</span>: <span class="selector-tag">rgba</span>(0, 0, 0, 0<span class="selector-class">.7</span>);</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="css">  <span class="selector-class">.toast</span> &#123;</span></span><br><span class="line"><span class="undefined">    font-size: 0rem;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">padding</span>: 0<span class="selector-class">.27rem</span> <span class="selector-class">.090rem</span>;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">width</span>: 2<span class="selector-class">.26rem</span>;</span></span><br><span class="line"><span class="undefined">    overflow: hidden;</span></span><br><span class="line"><span class="undefined">    display: flex;</span></span><br><span class="line"><span class="undefined">    align-items: center;</span></span><br><span class="line"><span class="undefined">    flex-direction: column;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">color</span>: <span class="selector-id">#f2f2f2</span>;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">background</span>: <span class="selector-tag">rgba</span>(51, 51, 51, 0<span class="selector-class">.94</span>);</span></span><br><span class="line"><span class="css">    <span class="selector-tag">border-radius</span>: 0<span class="selector-class">.09rem</span>;</span></span><br><span class="line"><span class="undefined">    text-align: center;</span></span><br><span class="line"><span class="css">    <span class="selector-class">.icon</span> &#123;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">width</span>: 0<span class="selector-class">.72rem</span>;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">height</span>: 0<span class="selector-class">.72rem</span>;</span></span><br><span class="line"><span class="undefined">      border-radius: 50%;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">border</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#f2f2f2</span>;</span></span><br><span class="line"><span class="undefined">      position: relative;</span></span><br><span class="line"><span class="undefined">      justify-content: center;</span></span><br><span class="line"><span class="undefined">      align-items: center;</span></span><br><span class="line"><span class="undefined">      display: flex;</span></span><br><span class="line"><span class="undefined">      </span></span><br><span class="line"><span class="undefined">      position: relative;</span></span><br><span class="line"><span class="css">      <span class="selector-class">.success-icon</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">border-right</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#f2f2f2</span>;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">border-bottom</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#f2f2f2</span>;</span></span><br><span class="line"><span class="undefined">        transform: rotate(45deg);</span></span><br><span class="line"><span class="css">        <span class="selector-tag">width</span>: 0<span class="selector-class">.27rem</span>;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">height</span>: 0<span class="selector-class">.45rem</span>;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">margin-top</span>: <span class="selector-tag">-0</span><span class="selector-class">.18rem</span>;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="css">      <span class="selector-class">.fail-icon</span> &#123;</span></span><br><span class="line"><span class="css">        &amp;<span class="selector-pseudo">:before</span> &#123;</span></span><br><span class="line"><span class="undefined">          content: " ";</span></span><br><span class="line"><span class="undefined">          position: absolute;</span></span><br><span class="line"><span class="undefined">          top: 50%;</span></span><br><span class="line"><span class="undefined">          left: 50%;</span></span><br><span class="line"><span class="undefined">          transform: translate(-50%, -50%) rotate(45deg);</span></span><br><span class="line"><span class="css">          <span class="selector-tag">border-top</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#f2f2f2</span>;</span></span><br><span class="line"><span class="css">          <span class="selector-tag">width</span>: 0<span class="selector-class">.5rem</span>;</span></span><br><span class="line"><span class="undefined">          height: 0px;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="css">        &amp;<span class="selector-pseudo">:after</span> &#123;</span></span><br><span class="line"><span class="undefined">          content: " ";</span></span><br><span class="line"><span class="undefined">          content: " ";</span></span><br><span class="line"><span class="undefined">          position: absolute;</span></span><br><span class="line"><span class="undefined">          top: 50%;</span></span><br><span class="line"><span class="undefined">          left: 50%;</span></span><br><span class="line"><span class="undefined">          transform: translate(-50%, -50%) rotate(-45deg);</span></span><br><span class="line"><span class="css">          <span class="selector-tag">border-top</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#f2f2f2</span>;</span></span><br><span class="line"><span class="css">          <span class="selector-tag">width</span>: 0<span class="selector-class">.5rem</span>;</span></span><br><span class="line"><span class="undefined">          height: 0px;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="css">      <span class="selector-class">.warning-icon</span> &#123;</span></span><br><span class="line"><span class="css">        &amp;<span class="selector-pseudo">:before</span> &#123;</span></span><br><span class="line"><span class="undefined">          content: " ";</span></span><br><span class="line"><span class="undefined">          position: absolute;</span></span><br><span class="line"><span class="undefined">          top: 50%;</span></span><br><span class="line"><span class="undefined">          left: 50%;</span></span><br><span class="line"><span class="undefined">          transform: translate(-50%, -500%) rotate(90deg);</span></span><br><span class="line"><span class="css">          <span class="selector-tag">border-top</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#f2f2f2</span>;</span></span><br><span class="line"><span class="css">          <span class="selector-tag">width</span>: 0<span class="selector-class">.27rem</span>;</span></span><br><span class="line"><span class="undefined">          height: 0px;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="css">        &amp;<span class="selector-pseudo">:after</span> &#123;</span></span><br><span class="line"><span class="undefined">          content: " ";</span></span><br><span class="line"><span class="undefined">          content: " ";</span></span><br><span class="line"><span class="undefined">          position: absolute;</span></span><br><span class="line"><span class="undefined">          top: 50%;</span></span><br><span class="line"><span class="undefined">          left: 50%;</span></span><br><span class="line"><span class="undefined">          transform: translate(-50%, 250%) rotate(-45deg);</span></span><br><span class="line"><span class="css">          <span class="selector-tag">background</span>: <span class="selector-id">#f2f2f2</span>;</span></span><br><span class="line"><span class="undefined">          width: 3px;</span></span><br><span class="line"><span class="undefined">          border-radius: 50%;</span></span><br><span class="line"><span class="undefined">          height: 3px;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="css">    <span class="selector-class">.msg</span> &#123;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">margin-top</span>: 0<span class="selector-class">.18rem</span>;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">font-size</span>: 0<span class="selector-class">.24rem</span>;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-class">.loading-icon</span> &#123;</span></span><br><span class="line"><span class="undefined">  font-size: 0px;</span></span><br><span class="line"><span class="undefined">  box-sizing: border-box;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">width</span>: 0<span class="selector-class">.72rem</span>;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">height</span>: 0<span class="selector-class">.72rem</span>;</span></span><br><span class="line"><span class="undefined">  position: relative;</span></span><br><span class="line"><span class="undefined">  span &#123;</span></span><br><span class="line"><span class="undefined">    position: absolute;</span></span><br><span class="line"><span class="undefined">    height: 1px;</span></span><br><span class="line"><span class="undefined">    left: 50%;</span></span><br><span class="line"><span class="undefined">    top: 50%;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">width</span>: 0<span class="selector-class">.18rem</span>;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">animation</span>: <span class="selector-tag">loading-fade-light</span> 1<span class="selector-class">.1s</span> <span class="selector-tag">infinite</span> <span class="selector-tag">linear</span>;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">background</span>: <span class="selector-tag">rgba</span>(255, 255, 255, 0<span class="selector-class">.3</span>);</span></span><br><span class="line"><span class="css">    <span class="selector-tag">transform-origin</span>: <span class="selector-tag">-0</span><span class="selector-class">.18rem</span> 50%;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">margin-left</span>: 0<span class="selector-class">.18rem</span>;</span></span><br><span class="line"><span class="css">    &amp;<span class="selector-pseudo">:nth-child(1)</span> &#123;</span></span><br><span class="line"><span class="undefined">      animation-delay: 0s;</span></span><br><span class="line"><span class="undefined">      transform: rotate(0deg);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="css">    &amp;<span class="selector-pseudo">:nth-child(2)</span> &#123;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">animation-delay</span>: 0<span class="selector-class">.1s</span>;</span></span><br><span class="line"><span class="undefined">      transform: rotate(30deg);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="css">    &amp;<span class="selector-pseudo">:nth-child(3)</span> &#123;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">animation-delay</span>: 0<span class="selector-class">.2s</span>;</span></span><br><span class="line"><span class="undefined">      transform: rotate(60deg);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="css">    &amp;<span class="selector-pseudo">:nth-child(4)</span> &#123;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">animation-delay</span>: 0<span class="selector-class">.3s</span>;</span></span><br><span class="line"><span class="undefined">      transform: rotate(90deg);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="css">    &amp;<span class="selector-pseudo">:nth-child(5)</span> &#123;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">animation-delay</span>: 0<span class="selector-class">.4s</span>;</span></span><br><span class="line"><span class="undefined">      transform: rotate(120deg);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="css">    &amp;<span class="selector-pseudo">:nth-child(6)</span> &#123;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">animation-delay</span>: 0<span class="selector-class">.5s</span>;</span></span><br><span class="line"><span class="undefined">      transform: rotate(150deg);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="css">    &amp;<span class="selector-pseudo">:nth-child(7)</span> &#123;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">animation-delay</span>: 0<span class="selector-class">.6s</span>;</span></span><br><span class="line"><span class="undefined">      transform: rotate(180deg);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="css">    &amp;<span class="selector-pseudo">:nth-child(8)</span> &#123;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">animation-delay</span>: 0<span class="selector-class">.7s</span>;</span></span><br><span class="line"><span class="undefined">      transform: rotate(210deg);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="css">    &amp;<span class="selector-pseudo">:nth-child(9)</span> &#123;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">animation-delay</span>: 0<span class="selector-class">.8s</span>;</span></span><br><span class="line"><span class="undefined">      transform: rotate(240deg);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="css">    &amp;<span class="selector-pseudo">:nth-child(10)</span> &#123;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">animation-delay</span>: 0<span class="selector-class">.9s</span>;</span></span><br><span class="line"><span class="undefined">      transform: rotate(270deg);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="css">    &amp;<span class="selector-pseudo">:nth-child(11)</span> &#123;</span></span><br><span class="line"><span class="undefined">      animation-delay: 1s;</span></span><br><span class="line"><span class="undefined">      transform: rotate(300deg);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="css">    &amp;<span class="selector-pseudo">:nth-child(12)</span> &#123;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">animation-delay</span>: 1<span class="selector-class">.1s</span>;</span></span><br><span class="line"><span class="undefined">      transform: rotate(330deg);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">@-<span class="keyword">webkit</span>-<span class="keyword">keyframes</span> loading-fade-light &#123;</span></span><br><span class="line"><span class="undefined">  0% &#123;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">background-color</span>: <span class="selector-id">#fff</span>;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">  100% &#123;</span></span><br><span class="line"><span class="undefined">    background-color: rgba(255, 255, 255, 0);</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">@<span class="keyword">keyframes</span> loading-fade-light &#123;</span></span><br><span class="line"><span class="undefined">  0% &#123;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">background-color</span>: <span class="selector-id">#fff</span>;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">  100% &#123;</span></span><br><span class="line"><span class="undefined">    background-color: rgba(255, 255, 255, 0);</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>入口文件注册：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> vueToast <span class="keyword">from</span> <span class="string">'@/components/vue-toast'</span></span><br><span class="line">Vue.use(vueToast);</span><br></pre></td></tr></table></figure>
<h3 id="React-插件toast的封装"><a href="#React-插件toast的封装" class="headerlink" title="React 插件toast的封装"></a>React 插件toast的封装</h3><blockquote>
<p>Toast/index.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> Toast <span class="keyword">from</span> <span class="string">'./toast'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Global</span> </span>&#123;</span><br><span class="line">	<span class="keyword">static</span> toastEle=<span class="string">''</span>;</span><br><span class="line">	<span class="keyword">static</span> toast(option) &#123;</span><br><span class="line">		<span class="keyword">var</span> setting=&#123;</span><br><span class="line">			type:<span class="number">0</span>,</span><br><span class="line">		 	content:<span class="string">"默认信息"</span>,</span><br><span class="line">		 	time:<span class="number">2000</span>,</span><br><span class="line">		 	opacity:<span class="number">0</span>,</span><br><span class="line">		 	onSucc:<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">typeof</span> option ==<span class="string">"string"</span>)&#123;</span><br><span class="line">			setting=&#123;...setting,<span class="attr">content</span>:option,<span class="attr">type</span>:<span class="number">4</span>&#125;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			setting=&#123;...setting,...option&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">this</span>.show(<span class="number">0</span>,setting);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(setting.type!==<span class="number">3</span>)&#123;   <span class="comment">//loading需要手动关闭</span></span><br><span class="line">			setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">				<span class="keyword">this</span>.hide();</span><br><span class="line">				setting.onSucc();</span><br><span class="line">			&#125;, setting.time);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">static</span> dialog(option) &#123;</span><br><span class="line">		 <span class="keyword">var</span> setting=&#123;</span><br><span class="line">		 	type:<span class="number">0</span>,</span><br><span class="line">		 	title:<span class="string">"我是默认title"</span>,</span><br><span class="line">		 	content:<span class="string">"我是默认content"</span>,</span><br><span class="line">		 	btnSucc:<span class="string">"我是默认btn"</span>,</span><br><span class="line">		 	CloseShow:<span class="literal">false</span>,</span><br><span class="line">		 	onClose()&#123;</span><br><span class="line">		 		<span class="built_in">console</span>.log(<span class="string">"蒙层回调"</span>);</span><br><span class="line">		    &#125;,</span><br><span class="line">		 	onSucc()&#123;</span><br><span class="line">		 		<span class="built_in">console</span>.log(<span class="string">"成功回调"</span>);</span><br><span class="line">		    &#125;,</span><br><span class="line">		    onFail()&#123;</span><br><span class="line">		    	<span class="built_in">console</span>.log(<span class="string">"失败回调"</span>);</span><br><span class="line">		    &#125;</span><br><span class="line">		 &#125;;</span><br><span class="line">		 </span><br><span class="line">		 setting=&#123;...setting,...option&#125;;</span><br><span class="line">		 </span><br><span class="line">		 <span class="keyword">this</span>.show(<span class="number">1</span>,setting);</span><br><span class="line">	&#125;</span><br><span class="line">   </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">static</span> show(n,setting) &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">var</span> div = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line">		<span class="keyword">var</span> id = <span class="built_in">document</span>.createAttribute(<span class="string">"id"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">this</span>.toastEle=<span class="string">'pluginEle-'</span>+<span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</span><br><span class="line">		</span><br><span class="line">		id.value = <span class="keyword">this</span>.toastEle;</span><br><span class="line">		div.setAttributeNode(id);</span><br><span class="line">		<span class="built_in">document</span>.body.appendChild(div);</span><br><span class="line">		ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">Toast</span> <span class="attr">setting</span>=<span class="string">&#123;setting&#125;</span> /&gt;</span>, div);</span></span><br><span class="line"><span class="xml">	&#125;</span></span><br><span class="line"><span class="xml">	</span></span><br><span class="line"><span class="xml">	static hide() &#123;</span></span><br><span class="line"><span class="xml">		var toastEle = document.querySelector("#"+this.toastEle);</span></span><br><span class="line"><span class="xml">		if(toastEle)&#123;</span></span><br><span class="line"><span class="xml">			ReactDOM.unmountComponentAtNode(toastEle);</span></span><br><span class="line"><span class="xml">		    document.body.removeChild(toastEle);</span></span><br><span class="line"><span class="xml">		&#125;</span></span><br><span class="line"><span class="xml">	&#125;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Toast/toast.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./toast.less'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Toast</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">	<span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">		<span class="keyword">super</span>(props);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	checkToast(n) &#123;</span><br><span class="line">		<span class="keyword">switch</span>(n) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">				<span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"icon"</span>&gt;</span></span></span><br><span class="line"><span class="xml">				          <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"success-icon"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">			           <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">				<span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"icon"</span>&gt;</span></span></span><br><span class="line"><span class="xml">				          <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"fail-icon"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">			           <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">				<span class="keyword">return</span> (<span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"icon"</span>&gt;</span></span></span><br><span class="line"><span class="xml">				          <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">"warning-icon"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">			           <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">				<span class="keyword">return</span> (</span><br><span class="line">			            &lt;div className=<span class="string">"loading-icon"</span>&gt;</span><br><span class="line">				          &lt;span&gt;<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">				          &lt;span&gt;<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">				          &lt;span&gt;<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">				          &lt;span&gt;<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">				          &lt;span&gt;<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">				          &lt;span&gt;<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">				          &lt;span&gt;<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">				          &lt;span&gt;<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">				          &lt;span&gt;<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">				          &lt;span&gt;<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">				          &lt;span&gt;<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">				          &lt;span&gt;<span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">				        &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">			        )</span></span><br><span class="line"><span class="regexp">				break;</span></span><br><span class="line"><span class="regexp">			default:</span></span><br><span class="line"><span class="regexp">			    return null</span></span><br><span class="line"><span class="regexp">		&#125;</span></span><br><span class="line"><span class="regexp">	&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">	render() &#123;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">		let &#123;</span></span><br><span class="line"><span class="regexp">			type,content,opacity = 0</span></span><br><span class="line"><span class="regexp">		&#125; = this.props.setting;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">		let style = &#123;</span></span><br><span class="line"><span class="regexp">			"background": `rgba(0,0,0,$&#123;opacity&#125;)`</span></span><br><span class="line"><span class="regexp">		&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">		return(</span></span><br><span class="line"><span class="regexp">			&lt;div className="mask" style=&#123;style&#125;&gt;</span></span><br><span class="line"><span class="regexp">			    &lt;div className="toast"&gt;</span></span><br><span class="line"><span class="regexp">			        &#123;this.checkToast(type)&#125;</span></span><br><span class="line"><span class="regexp">			        &lt;div className="msg"&gt;&#123;content&#125;&lt;/</span>div&gt;</span><br><span class="line">			    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">			&lt;/</span>div&gt;</span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Toast/toast.less</p>
</blockquote>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.mask</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(0, 0, 0, 0.4);</span><br><span class="line">    <span class="attribute">position</span>: fixed;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">0px</span>;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">0px</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">10000</span>;</span><br><span class="line">    .toast-msg &#123;</span><br><span class="line">        <span class="selector-tag">font-size</span>: 24<span class="selector-tag">px</span>;</span><br><span class="line">        <span class="selector-tag">text-align</span>: <span class="selector-tag">center</span>;</span><br><span class="line">        <span class="selector-tag">position</span>: <span class="selector-tag">relative</span>;</span><br><span class="line">        <span class="selector-tag">transform</span>: <span class="selector-tag">translateX</span>(<span class="selector-tag">-50</span>%);</span><br><span class="line">        <span class="selector-tag">color</span>: <span class="selector-id">#fff</span>;</span><br><span class="line">        <span class="selector-tag">left</span>: 50%;</span><br><span class="line">        <span class="selector-tag">padding</span><span class="selector-pseudo">:18px</span> 27<span class="selector-tag">px</span>;</span><br><span class="line">        <span class="selector-tag">overflow</span>: <span class="selector-tag">hidden</span>;</span><br><span class="line">        <span class="selector-tag">border-radius</span>: 4<span class="selector-tag">px</span>;</span><br><span class="line">        <span class="selector-tag">white-space</span>: <span class="selector-tag">nowrap</span>;</span><br><span class="line">        <span class="selector-tag">display</span>: <span class="selector-tag">block</span>;</span><br><span class="line">        <span class="selector-tag">background</span>: <span class="selector-tag">rgba</span>(0, 0, 0, 0<span class="selector-class">.7</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-class">.toast</span> &#123;</span><br><span class="line">        <span class="attribute">font-size</span>: <span class="number">0px</span>;</span><br><span class="line">        <span class="attribute">padding</span>: <span class="number">27px</span> <span class="number">9px</span>;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">226px</span>;</span><br><span class="line">        <span class="attribute">overflow</span>: hidden;</span><br><span class="line">        <span class="attribute">display</span>: flex;</span><br><span class="line">        <span class="attribute">align-items</span>: center;</span><br><span class="line">        <span class="attribute">flex-direction</span>: column;</span><br><span class="line">        <span class="attribute">color</span>: <span class="number">#f2f2f2</span>;</span><br><span class="line">        <span class="attribute">background</span>: <span class="built_in">rgba</span>(51, 51, 51, 0.94);</span><br><span class="line">        <span class="attribute">border-radius</span>: <span class="number">9px</span>;</span><br><span class="line">        <span class="attribute">text-align</span>: center;</span><br><span class="line">        .icon &#123;</span><br><span class="line">            <span class="selector-tag">width</span><span class="selector-pseudo">:72px</span>;</span><br><span class="line">            <span class="selector-tag">height</span><span class="selector-pseudo">:72px</span>;</span><br><span class="line">            <span class="selector-tag">border-radius</span>: 50%;</span><br><span class="line">            <span class="selector-tag">border</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#f2f2f2</span>;</span><br><span class="line">            <span class="selector-tag">position</span>: <span class="selector-tag">relative</span>;</span><br><span class="line">            <span class="selector-tag">justify-content</span>: <span class="selector-tag">center</span>;</span><br><span class="line">            <span class="selector-tag">align-items</span>: <span class="selector-tag">center</span>;</span><br><span class="line">            <span class="selector-tag">display</span>: <span class="selector-tag">flex</span>;</span><br><span class="line">            <span class="selector-tag">position</span>: <span class="selector-tag">relative</span>;</span><br><span class="line">            <span class="selector-tag">margin-bottom</span>: 18<span class="selector-tag">px</span>;</span><br><span class="line">            <span class="selector-class">.success-icon</span> &#123;</span><br><span class="line">                <span class="attribute">border-right</span>: <span class="number">1px</span> solid <span class="number">#f2f2f2</span>;</span><br><span class="line">                <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="number">#f2f2f2</span>;</span><br><span class="line">                <span class="attribute">transform</span>: <span class="built_in">rotate</span>(45deg);</span><br><span class="line">                <span class="attribute">width</span>:<span class="number">27px</span>;</span><br><span class="line">                <span class="attribute">height</span>: <span class="number">45px</span>;</span><br><span class="line">                <span class="attribute">margin-top</span>: -<span class="number">18px</span>;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="selector-class">.fail-icon</span> &#123;</span><br><span class="line">                &amp;:before &#123;</span><br><span class="line">                    <span class="selector-tag">content</span>: " ";</span><br><span class="line">                    <span class="selector-tag">position</span>: <span class="selector-tag">absolute</span>;</span><br><span class="line">                    <span class="selector-tag">top</span>: 50%;</span><br><span class="line">                    <span class="selector-tag">left</span>: 50%;</span><br><span class="line">                    <span class="selector-tag">transform</span>: <span class="selector-tag">translate</span>(<span class="selector-tag">-50</span>%, <span class="selector-tag">-50</span>%) <span class="selector-tag">rotate</span>(45<span class="selector-tag">deg</span>);</span><br><span class="line">                    <span class="selector-tag">border-top</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#f2f2f2</span>;</span><br><span class="line">                    <span class="selector-tag">width</span>: 50<span class="selector-tag">px</span>;</span><br><span class="line">                    <span class="selector-tag">height</span>: 0<span class="selector-tag">px</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                &amp;<span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">                    <span class="attribute">content</span>: <span class="string">" "</span>;</span><br><span class="line">                    <span class="attribute">content</span>: <span class="string">" "</span>;</span><br><span class="line">                    <span class="attribute">position</span>: absolute;</span><br><span class="line">                    <span class="attribute">top</span>: <span class="number">50%</span>;</span><br><span class="line">                    <span class="attribute">left</span>: <span class="number">50%</span>;</span><br><span class="line">                    <span class="attribute">transform</span>: <span class="built_in">translate</span>(-50%, -50%) <span class="built_in">rotate</span>(-45deg);</span><br><span class="line">                    <span class="attribute">border-top</span>: <span class="number">1px</span> solid <span class="number">#f2f2f2</span>;</span><br><span class="line">                    <span class="attribute">width</span>: <span class="number">50px</span>;</span><br><span class="line">                    <span class="attribute">height</span>: <span class="number">0px</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="selector-class">.warning-icon</span> &#123;</span><br><span class="line">                &amp;:before &#123;</span><br><span class="line">                    <span class="selector-tag">content</span>: "";</span><br><span class="line">                    <span class="selector-tag">display</span>: <span class="selector-tag">block</span>;</span><br><span class="line">                    <span class="selector-tag">position</span>: <span class="selector-tag">absolute</span>;</span><br><span class="line">                    <span class="selector-tag">top</span>: 15<span class="selector-tag">px</span>;</span><br><span class="line">                    <span class="selector-tag">left</span>: 50%;</span><br><span class="line">                    <span class="selector-tag">background</span>:<span class="selector-id">#f2f2f2</span>;</span><br><span class="line">                    <span class="selector-tag">width</span><span class="selector-pseudo">:1px</span>;</span><br><span class="line">                    <span class="selector-tag">height</span>: 30<span class="selector-tag">px</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                &amp;<span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">                    <span class="attribute">content</span>: <span class="string">""</span>;</span><br><span class="line">                    <span class="attribute">position</span>: absolute;</span><br><span class="line">                    <span class="attribute">bottom</span>: <span class="number">14px</span>;</span><br><span class="line">                    <span class="attribute">left</span>: <span class="number">50%</span>;</span><br><span class="line">                    <span class="attribute">background</span>:<span class="number">#f2f2f2</span>;</span><br><span class="line">                    <span class="attribute">width</span>: <span class="number">6px</span>;</span><br><span class="line">                    <span class="attribute">margin-left</span>: -<span class="number">2px</span>;</span><br><span class="line">                    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">                    <span class="attribute">height</span>: <span class="number">6px</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="selector-class">.msg</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="attribute">font-size</span>:<span class="number">24px</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.loading-icon</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0px</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">18px</span>;</span><br><span class="line">    <span class="attribute">box-sizing</span>: border-box;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">72px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">72px</span>;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    span &#123;</span><br><span class="line">        <span class="selector-tag">position</span>: <span class="selector-tag">absolute</span>;</span><br><span class="line">        <span class="selector-tag">height</span>: 1<span class="selector-tag">px</span>;</span><br><span class="line">        <span class="selector-tag">left</span>: 50%;</span><br><span class="line">        <span class="selector-tag">top</span>: 50%;</span><br><span class="line">        <span class="selector-tag">width</span>: 18<span class="selector-tag">px</span>;</span><br><span class="line">        <span class="selector-tag">animation</span>: <span class="selector-tag">loading-fade-light</span> 1<span class="selector-class">.1s</span> <span class="selector-tag">infinite</span> <span class="selector-tag">linear</span>;</span><br><span class="line">        <span class="selector-tag">background</span>: <span class="selector-tag">rgba</span>(255, 255, 255, 0<span class="selector-class">.3</span>);</span><br><span class="line">        <span class="selector-tag">transform-origin</span>: <span class="selector-tag">-18px</span> 50%;</span><br><span class="line">        <span class="selector-tag">margin-left</span>: 18<span class="selector-tag">px</span>;</span><br><span class="line">        &amp;<span class="selector-pseudo">:nth-child(1)</span> &#123;</span><br><span class="line">            <span class="attribute">animation-delay</span>: <span class="number">0s</span>;</span><br><span class="line">            <span class="attribute">transform</span>: <span class="built_in">rotate</span>(0deg);</span><br><span class="line">        &#125;</span><br><span class="line">        &amp;<span class="selector-pseudo">:nth-child(2)</span> &#123;</span><br><span class="line">            <span class="attribute">animation-delay</span>: <span class="number">0.1s</span>;</span><br><span class="line">            <span class="attribute">transform</span>: <span class="built_in">rotate</span>(30deg);</span><br><span class="line">        &#125;</span><br><span class="line">        &amp;<span class="selector-pseudo">:nth-child(3)</span> &#123;</span><br><span class="line">            <span class="attribute">animation-delay</span>: <span class="number">0.2s</span>;</span><br><span class="line">            <span class="attribute">transform</span>: <span class="built_in">rotate</span>(60deg);</span><br><span class="line">        &#125;</span><br><span class="line">        &amp;<span class="selector-pseudo">:nth-child(4)</span> &#123;</span><br><span class="line">            <span class="attribute">animation-delay</span>: <span class="number">0.3s</span>;</span><br><span class="line">            <span class="attribute">transform</span>: <span class="built_in">rotate</span>(90deg);</span><br><span class="line">        &#125;</span><br><span class="line">        &amp;<span class="selector-pseudo">:nth-child(5)</span> &#123;</span><br><span class="line">            <span class="attribute">animation-delay</span>: <span class="number">0.4s</span>;</span><br><span class="line">            <span class="attribute">transform</span>: <span class="built_in">rotate</span>(120deg);</span><br><span class="line">        &#125;</span><br><span class="line">        &amp;<span class="selector-pseudo">:nth-child(6)</span> &#123;</span><br><span class="line">            <span class="attribute">animation-delay</span>: <span class="number">0.5s</span>;</span><br><span class="line">            <span class="attribute">transform</span>: <span class="built_in">rotate</span>(150deg);</span><br><span class="line">        &#125;</span><br><span class="line">        &amp;<span class="selector-pseudo">:nth-child(7)</span> &#123;</span><br><span class="line">            <span class="attribute">animation-delay</span>: <span class="number">0.6s</span>;</span><br><span class="line">            <span class="attribute">transform</span>: <span class="built_in">rotate</span>(180deg);</span><br><span class="line">        &#125;</span><br><span class="line">        &amp;<span class="selector-pseudo">:nth-child(8)</span> &#123;</span><br><span class="line">            <span class="attribute">animation-delay</span>: <span class="number">0.7s</span>;</span><br><span class="line">            <span class="attribute">transform</span>: <span class="built_in">rotate</span>(210deg);</span><br><span class="line">        &#125;</span><br><span class="line">        &amp;<span class="selector-pseudo">:nth-child(9)</span> &#123;</span><br><span class="line">            <span class="attribute">animation-delay</span>: <span class="number">0.8s</span>;</span><br><span class="line">            <span class="attribute">transform</span>: <span class="built_in">rotate</span>(240deg);</span><br><span class="line">        &#125;</span><br><span class="line">        &amp;<span class="selector-pseudo">:nth-child(10)</span> &#123;</span><br><span class="line">            <span class="attribute">animation-delay</span>: <span class="number">0.9s</span>;</span><br><span class="line">            <span class="attribute">transform</span>: <span class="built_in">rotate</span>(270deg);</span><br><span class="line">        &#125;</span><br><span class="line">        &amp;<span class="selector-pseudo">:nth-child(11)</span> &#123;</span><br><span class="line">            <span class="attribute">animation-delay</span>: <span class="number">1s</span>;</span><br><span class="line">            <span class="attribute">transform</span>: <span class="built_in">rotate</span>(300deg);</span><br><span class="line">        &#125;</span><br><span class="line">        &amp;<span class="selector-pseudo">:nth-child(12)</span> &#123;</span><br><span class="line">            <span class="attribute">animation-delay</span>: <span class="number">1.1s</span>;</span><br><span class="line">            <span class="attribute">transform</span>: <span class="built_in">rotate</span>(330deg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@-<span class="keyword">webkit</span>-<span class="keyword">keyframes</span> loading-fade-light &#123;</span><br><span class="line">    0% &#123;</span><br><span class="line">        <span class="attribute">background-color</span>: <span class="number">#fff</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    100% &#123;</span><br><span class="line">        <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(255, 255, 255, 0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="keyword">keyframes</span> loading-fade-light &#123;</span><br><span class="line">    0% &#123;</span><br><span class="line">        <span class="attribute">background-color</span>: <span class="number">#fff</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    100% &#123;</span><br><span class="line">        <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(255, 255, 255, 0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> $ <span class="keyword">from</span> <span class="string">'@/component/Toast/index'</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$.toast(&#123;</span><br><span class="line">	type:<span class="number">0</span>,</span><br><span class="line">	content: <span class="string">"我是默认Toast"</span>,</span><br><span class="line">	time: <span class="number">1000</span>,</span><br><span class="line">	opacity: <span class="number">.5</span>,</span><br><span class="line">	onSucc() &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">"我是Toast的回调！"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line">		</span><br><span class="line">$.toast(<span class="string">"我是默认Toast"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="为什么不挂载在React原型链上？"><a href="#为什么不挂载在React原型链上？" class="headerlink" title="为什么不挂载在React原型链上？"></a>为什么不挂载在React原型链上？</h3><blockquote>
<p><strong>有坑！主要原因还是React组件的this神出鬼没！</strong></p>
</blockquote>
<h3 id="ES6-toast插件"><a href="#ES6-toast插件" class="headerlink" title="ES6 toast插件"></a>ES6 toast插件</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> body = <span class="built_in">document</span>.body</span><br><span class="line"><span class="keyword">var</span> tip</span><br><span class="line"><span class="keyword">var</span> timeout</span><br><span class="line"><span class="keyword">var</span> time = <span class="number">3000</span></span><br><span class="line"><span class="keyword">var</span> setStyleTime = <span class="number">50</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Tip</span> (<span class="params">str, time</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (tip) &#123;</span><br><span class="line">    clearTimeout(timeout)</span><br><span class="line">    <span class="comment">// tip.find('p').html(str);</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    tip = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>)</span><br><span class="line">    tip.className = <span class="string">'__toast'</span></span><br><span class="line">    tip.innerHTML = str</span><br><span class="line">    <span class="comment">// tip.style.cssText = 'z-index: 999;position: fixed;webkit-transition: opacity .3s ease;transition: opacity .3s ease;opacity: 0;color: #fff;border-radius: 8px;left: 50%;width: 80%;margin-left: -40%; /*px*/text-align: center;line-height: 1.5;background: rgba(0,0,0,.6);padding: 1% 1%;top: 45%;box-sizing: border-box;font-size: 1.5em;';</span></span><br><span class="line">    body.appendChild(tip)</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      tip.style.opacity = <span class="number">1</span></span><br><span class="line">    &#125;, setStyleTime)</span><br><span class="line">  &#125;</span><br><span class="line">  timeout = clear(time)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clear</span> (<span class="params">time</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> setTimeout(remove, time)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">remove</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (tip) &#123;</span><br><span class="line">    body.removeChild(tip)</span><br><span class="line">    tip = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">entry</span> (<span class="params">msg, expire</span>) </span>&#123;</span><br><span class="line">  msg = msg || <span class="string">''</span></span><br><span class="line">  <span class="keyword">if</span> (!expire || expire &lt;= setStyleTime) &#123;</span><br><span class="line">    expire = time</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Tip(msg, expire)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> entry</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/17/为啥await不能用在forEach中/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/17/为啥await不能用在forEach中/" itemprop="url">为啥await不能用在forEach中</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-17T21:09:46+08:00">
                2019-04-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="不知道你是否写过类似的代码"><a href="#不知道你是否写过类似的代码" class="headerlink" title="不知道你是否写过类似的代码:"></a>不知道你是否写过类似的代码:</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"> <span class="keyword">let</span> arr = [<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line"> arr.forEach(<span class="keyword">async</span> item =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> fetch(item)</span><br><span class="line">  <span class="built_in">console</span>.log(res)</span><br><span class="line"> &#125;)</span><br><span class="line"> <span class="built_in">console</span>.log(<span class="string">'end'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fetch</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">   resolve(x)</span><br><span class="line">  &#125;, <span class="number">500</span> * x)</span><br><span class="line"> &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test()</span><br></pre></td></tr></table></figure>
<p>我当时期望的打印顺序是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">3</span><br><span class="line">2</span><br><span class="line">1</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p>
<p> 结果现实与我开了个玩笑，打印顺序居然是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">end</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>为什么？</strong></p>
</blockquote>
<p>其实原因很简单，<strong>那就是 forEach 只支持同步代码</strong>。</p>
<p>我们可以参考下 Polyfill 版本的 forEach，简化以后类似就是这样的伪代码<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (index &lt; arr.length) &#123;</span><br><span class="line">  callback(item, index)   <span class="comment">//也就是我们传入的回调函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从上述代码中我们可以发现，forEach 只是简单的执行了下回调函数而已，并不会去处理异步的情况。<br><strong>并且你在 callback 中即使使用 break 也并不能结束遍历。</strong></p>
<blockquote>
<p>怎么解决？</p>
</blockquote>
<p>一般来说解决的办法有2种,for…of和for循环。</p>
<p>使用 Promise.all 的方式行不行，答案是： <font color="#ff0000"> <strong>不行</strong> </font></p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"> <span class="keyword">let</span> arr = [<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line"> <span class="keyword">await</span> <span class="built_in">Promise</span>.all(</span><br><span class="line">  arr.map(<span class="keyword">async</span> item =&gt; &#123;</span><br><span class="line">   <span class="keyword">const</span> res = <span class="keyword">await</span> fetch(item)</span><br><span class="line">   <span class="built_in">console</span>.log(res)</span><br><span class="line">  &#125;)</span><br><span class="line"> )</span><br><span class="line"> <span class="built_in">console</span>.log(<span class="string">'end'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2019/04/17/为啥await不能用在forEach中/1.png" alt=""></p>
<p>可以看到并没有按照我们期望的输出。</p>
<p>这样可以生效的原因是 async 函数肯定会返回一个 Promise 对象，调用 map 以后返回值就是一个存放了 Promise 的数组了，这样我们把数组传入 Promise.all 中就可以解决问题了。但是这种方式其实并不能达成我们要的效果，如果你希望内部的 fetch 是顺序完成的，可以选择第二种方式。</p>
<h3 id="第1种方法是使用-for…of"><a href="#第1种方法是使用-for…of" class="headerlink" title="第1种方法是使用 for…of"></a>第1种方法是使用 for…of</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"> <span class="keyword">let</span> arr = [<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line"> <span class="keyword">for</span> (<span class="keyword">const</span> item <span class="keyword">of</span> arr) &#123;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> fetch(item)</span><br><span class="line">  <span class="built_in">console</span>.log(res)</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">console</span>.log(<span class="string">'end'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2019/04/17/为啥await不能用在forEach中/2.png" alt=""></p>
<p>这种方式相比 Promise.all 要简洁的多，并且也可以实现开头我想要的输出顺序。</p>
<p>但是这时候你是否又多了一个疑问？为啥 for…of 内部就能让 await 生效呢。</p>
<p>因为 for…of 内部处理的机制和 forEach 不同，forEach 是直接调用回调函数，for…of 是通过迭代器的方式去遍历。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"> <span class="keyword">let</span> arr = [<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line"> <span class="keyword">const</span> iterator = arr[<span class="built_in">Symbol</span>.iterator]()</span><br><span class="line"> <span class="keyword">let</span> res = iterator.next()</span><br><span class="line"> <span class="keyword">while</span> (!res.done) &#123;</span><br><span class="line">  <span class="keyword">const</span> value = res.value</span><br><span class="line">  <span class="keyword">const</span> res1 = <span class="keyword">await</span> fetch(value)</span><br><span class="line">  <span class="built_in">console</span>.log(res1)</span><br><span class="line">  res = iterator.next()</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">console</span>.log(<span class="string">'end'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="第2种方法是使用-for循环"><a href="#第2种方法是使用-for循环" class="headerlink" title="第2种方法是使用 for循环"></a>第2种方法是使用 for循环</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> arr = [<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;arr.length;i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> fetch(arr[i])</span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'end'</span>)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fetch</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">   resolve(x)</span><br><span class="line">  &#125;, <span class="number">500</span> * x)</span><br><span class="line"> &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test()</span><br></pre></td></tr></table></figure>
<p><img src="/2019/04/17/为啥await不能用在forEach中/3.png" alt=""></p>
<h3 id="第3种方法是使用-while循环"><a href="#第3种方法是使用-while循环" class="headerlink" title="第3种方法是使用 while循环"></a>第3种方法是使用 while循环</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> arr = [<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line">  <span class="keyword">var</span> i=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span>(i!==arr.length)&#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> fetch(arr[i])</span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'end'</span>)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fetch</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">   resolve(x)</span><br><span class="line">  &#125;, <span class="number">500</span> * x)</span><br><span class="line"> &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test()</span><br></pre></td></tr></table></figure>
<p><img src="/2019/04/17/为啥await不能用在forEach中/5.png" alt=""></p>
<h3 id="要想在循环中使用async-await，请使用for…of-或者-for-循环-while循环"><a href="#要想在循环中使用async-await，请使用for…of-或者-for-循环-while循环" class="headerlink" title="要想在循环中使用async await，请使用for…of 或者 for 循环, while循环"></a><strong><font color="#ff0000">要想在循环中使用async await，请使用for…of 或者 for 循环, while循环</font></strong></h3><p><img src="/2019/04/17/为啥await不能用在forEach中/4.png" alt=""></p>
<h3 id="forEach支持async-await"><a href="#forEach支持async-await" class="headerlink" title="forEach支持async await"></a>forEach支持async await</h3><p>forEach 在正常情况像下面这么写肯定是做不到同步的，程序不会等一个循环中的异步完成再进行下一个循环。原因很明显，在上面的模拟中，while 循环只是简单执行了 callback，所以尽管 callback 内使用了 await ，也只是影响到 callback 内部。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">arr.myforeach(<span class="keyword">async</span> v =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> fetch(v);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p><strong>要支持上面这种写法，只要稍微改一下就好</strong><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Array</span>.prototype.myforeach = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params">fn, context = null</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> arr = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(fn + <span class="string">' is not a function'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (index &lt; arr.length) &#123;</span><br><span class="line">        <span class="keyword">if</span> (index <span class="keyword">in</span> arr) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">await</span> fn.call(context, arr[index], index, arr);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        index ++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>参考链接：</p>
</blockquote>
<h4 id="async-await与forEach引发的血案"><a href="#async-await与forEach引发的血案" class="headerlink" title="async,await与forEach引发的血案"></a><a href="https://juejin.im/post/5cb5a669e51d456e845b41f6" target="_blank" rel="noopener">async,await与forEach引发的血案</a></h4><h4 id="【JS基础】从JavaScript中的for…of说起-下-async和await"><a href="#【JS基础】从JavaScript中的for…of说起-下-async和await" class="headerlink" title="【JS基础】从JavaScript中的for…of说起(下) - async和await"></a><a href="https://juejin.im/post/5cb53a516fb9a06853012584" target="_blank" rel="noopener">【JS基础】从JavaScript中的for…of说起(下) - async和await</a></h4>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/31/HTTP缓存机制及原理/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/31/HTTP缓存机制及原理/" itemprop="url">HTTP缓存机制及原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-31T21:47:12+08:00">
                2019-03-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="HTTP缓存机制-200还是304"><a href="#HTTP缓存机制-200还是304" class="headerlink" title="HTTP缓存机制(200还是304)"></a><a href="https://libin1991.github.io/2018/11/22/HTTP%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6-200%E8%BF%98%E6%98%AF304/" target="_blank" rel="noopener"><font color="#dd0000">HTTP缓存机制(200还是304)</font></a></h3><h3 id="从输入-URL-到展现涉及哪些缓存环节"><a href="#从输入-URL-到展现涉及哪些缓存环节" class="headerlink" title="从输入 URL 到展现涉及哪些缓存环节"></a><a href="https://juejin.im/post/5c6e77da6fb9a049db73bb07" target="_blank" rel="noopener">从输入 URL 到展现涉及哪些缓存环节</a></h3><h3 id="译-写给大家看的-Cache-Control-指令配置"><a href="#译-写给大家看的-Cache-Control-指令配置" class="headerlink" title="[译] 写给大家看的 Cache-Control 指令配置"></a><a href="https://juejin.im/post/5c9d92506fb9a070f5067b3d" target="_blank" rel="noopener">[译] 写给大家看的 Cache-Control 指令配置</a></h3><h3 id="node实战前端缓存总结"><a href="#node实战前端缓存总结" class="headerlink" title="node实战前端缓存总结"></a><a href="https://juejin.im/post/5ca083eaf265da30bd3e459b" target="_blank" rel="noopener">node实战前端缓存总结</a></h3><h3 id="深入现代浏览器的HTTP缓存机制"><a href="#深入现代浏览器的HTTP缓存机制" class="headerlink" title="深入现代浏览器的HTTP缓存机制"></a><a href="https://juejin.im/post/5ca2e0c0f265da30d561ed8b" target="_blank" rel="noopener">深入现代浏览器的HTTP缓存机制</a></h3><h3 id="缓存规则及解析"><a href="#缓存规则及解析" class="headerlink" title="缓存规则及解析"></a>缓存规则及解析</h3><p>为方便大家理解，我假设览器存在一个缓存数据库，用于存储缓存信息。在客户端第一次请求数据时，此时缓存数据库中没有对应的缓存数据，需要请求服务器，服务器返回后，将数据存储至缓存数据库中。如下流程图所示：</p>
<p><img src="/2019/03/31/HTTP缓存机制及原理/1.png" alt=""><br>根据是否需要重新向服务器发起请求来分类，将HTTP缓存规则分为两大类(强制缓存，对比缓存)在详细介绍这两种规则之前，先通过时序图的方式，让大家对这两种规则有个简单了解。</p>
<p>（1）已存在缓存数据时，仅基于强制缓存，请求数据的流程如下所示：</p>
<p><img src="/2019/03/31/HTTP缓存机制及原理/2.png" alt=""><br>（2）已存在缓存数据时，仅基于对比缓存，请求数据的流程如下所示：</p>
<p><img src="/2019/03/31/HTTP缓存机制及原理/3.png" alt=""><br>我们可以看到两类缓存规则的不同，强制缓存如果生效，不需要再和服务器发生交互，而对比缓存不管是否生效，都需要与服务端发生交互。</p>
<p>两类缓存规则可以同时存在，强制缓存优先级高于对比缓存，也就是说，当执行强制缓存的规则时，如果缓存生效，直接使用缓存，不再执行对比缓存规则。</p>
<h3 id="缓存常用字段"><a href="#缓存常用字段" class="headerlink" title="缓存常用字段"></a>缓存常用字段</h3><h3 id="1、http1-0时期的缓存方案"><a href="#1、http1-0时期的缓存方案" class="headerlink" title="1、http1.0时期的缓存方案"></a>1、http1.0时期的缓存方案</h3><p><img src="/2019/03/31/HTTP缓存机制及原理/4.png" alt=""><br>注意： </p>
<p>（1）如果使用了<code>Pragma: &#39;no-cache&#39;</code>的话，再设置<code>Expires</code>或者<code>Cache-Control</code>，就没有用了，说明<code>Pragma</code>的权值比后两者高。</p>
<p> （2）如果设置了<code>Expires</code>之后，客户端在需要请求数据的时候，首先会对比当前系统时间和这个<code>Expires</code>时间，如果没有超过<code>Expires</code>时间，则直接读取本地磁盘中的缓存数据，不发送请求。</p>
<h3 id="2、http1-1-时期的缓存方案"><a href="#2、http1-1-时期的缓存方案" class="headerlink" title="2、http1.1 时期的缓存方案"></a>2、http1.1 时期的缓存方案</h3><p>2.1、Cache-Control 字段 </p>
<p>2.1.1、Cache-Control 作为请求头字段</p>
<p><img src="/2019/03/31/HTTP缓存机制及原理/5.png" alt=""><br>（1）Cache-Control: no-cache </p>
<p>使用<code>no-cache</code>指令的目的是为了防止从缓存中返回过期的资源。 客户端发送的请求中如果包含 <code>no-cache</code> 指令，则表示客户端将不会接收缓存的资源。每次请求都是从服务器获取资源，返回304。</p>
<p>（2）Cache-Control: no-store </p>
<p>使用<code>no-store</code> 指令表示请求的资源不会被缓存，下次任何其它请求获取该资源，还是会从服务器获取，返回 200，即资源本身。</p>
<p>2.1.2、Cache-Control 作为响应头字段</p>
<p><img src="/2019/03/31/HTTP缓存机制及原理/6.png" alt=""><br>Cache-Control: public </p>
<p>当指定使用 <code>public</code>指令时，则明确表明其他用户也可利用缓存。</p>
<p> Cache-Control: private</p>
<p>当指定 <code>private</code> 指令后，响应只以特定的用户作为对象，这与 <code>public</code> 指令的行为相反。 缓存服务器会对该特定用户提供资源缓存的服务，对于其他用户发送 过来的请求，代理服务器则不会返回缓存。</p>
<p> Cache-Control: no-cache </p>
<p>如果服务器返回的响应中包含<code>no-cache</code>指令，每次客户端请求，必需先向服务器确认其有效性，如果资源没有更改，则返回304. </p>
<p>Cache-Control: no-store </p>
<p>不对响应的资源进行缓存，即用户下次请求还是返回 200，返回资源本身。 </p>
<p>Cache-Control: max-age=604800（单位：秒） </p>
<p>资源缓存在本地浏览器的时间，如果超过该时间，则重新向服务器获取。</p>
<p>2.2、请求头部字段 &amp; 响应头部字段</p>
<p>2.2.1、请求头部字段</p>
<p><img src="/2019/03/31/HTTP缓存机制及原理/7.png" alt=""><br>2.2.2、响应头部字段</p>
<p><img src="/2019/03/31/HTTP缓存机制及原理/8.png" alt=""><br>注意：</p>
<p>（1）<code>If-None-Match</code>的优先级比<code>If-Modified-Since</code>高，所以两者同时存在时，遵从前者。</p>
<h3 id="实验验证"><a href="#实验验证" class="headerlink" title="实验验证"></a>实验验证</h3><p>1、实验1 —  请求的资源没修改，验证2种缓存出现的情形</p>
<p>服务端使用<code>node.js</code> ， 客户端使用 <code>axios</code>进行请求：</p>
<p>1.1、请求头部 / 响应头部 设置</p>
<p>（1）服务端响应头部设置：</p>
<p><code>res.setHeader(&#39;Cache-Control&#39;, &#39;public, max-age=10&#39;);</code></p>
<p>（2）客户端请求头部使用默认设置</p>
<p>1.2、实验步骤</p>
<p>（1）请求 3 次，第一次请求请求资源；第二次在10秒内再次请求该资源，第三次在 10 秒后再次请求该资源（实验过程中，服务端的资源没有进行改变）</p>
<p>1.3、实验结果</p>
<p> 3次请求的 HTTP 信息如下图所示，从图中的信息可以得出，第一次请求该资源是从服务器获取；第二次（10 秒内）请求该资源是直接从浏览器缓存中获取该资源（没有向服务器确认）；第三次（10 秒后）请求该资源时，因为资源缓存时间（10 秒）过期，所以向服务器获取资源，服务器判断该资源与本地缓存的资源没有做更改，所以返回 304，让客户端直接从浏览器缓存中获取该资源；以下，根据 HTTP 头部信息详细介绍三个操作的交互过程。</p>
<p><img src="/2019/03/31/HTTP缓存机制及原理/9.png" alt=""><br>1.3.1、第一次请求资源</p>
<p> 第一次请求资源的请求头部和响应头部的截图如下所示，因为第一次请求该资源，本地并没有缓存，所以直接从服务器获取该资源；我们从截图可以看到，服务器返回改资源的响应头部中包含3个属性与资源缓存相关：</p>
<p>（1）<code>cache-control: public, max-age=10</code></p>
<p> 缓存规则的设置，我们这个示例中，设置缓存规则为 <code>public</code>, 并且设置缓存过期时间为10秒；</p>
<p>（2）<code>etag: W/&quot;95f15b-16994d7ebf6&quot;</code></p>
<p>资源的唯一标识符，客户端下次访问该资源时，会在请求头中携带 <code>etag</code> 去向服务器确认，该资源是否被修改；</p>
<p>（3）<code>last-modified: Tue, 19 Mar 2019 07:26:12 GMT</code></p>
<p>资源最后一次修改时间，客户端下次访问该资源时，会在请求头中携带该信息去向服务器进行匹配，该资源是否被修改；</p>
<p><img src="/2019/03/31/HTTP缓存机制及原理/10.png" alt=""><br>1.3.2、第二次请求资源（10秒内，即在缓存时间失效前）</p>
<p>第二次请求资源的请求头部和响应头部的截图如下所示，因为第二次请求该资源，该资源本地缓存还没失效，所以就直接从浏览器缓存中获取该资源。</p>
<p><img src="/2019/03/31/HTTP缓存机制及原理/11.png" alt=""><br>1.3.3、第三次请求资源（10秒后，即在缓存时间失效后）</p>
<p>第三次请求资源的请求头部和响应头部的截图如下所示，因为第三次请求该资源，该资源本地缓存已经失效，所以在请求头部中加入<code>If-Modified-Since</code>和 <code>If-None-Match</code>属性，来向服务器进行确认该资源是否有被更改。</p>
<p><img src="/2019/03/31/HTTP缓存机制及原理/12.png" alt=""><br>2、实验2 —  请求的资源进行修改，验证2种缓存出现的情形</p>
<p>服务端使用<code>node.js</code>， 客户端使用 <code>axios</code>进行请求：</p>
<p>2.1、请求头部 / 响应头部 设置</p>
<p>（1）服务端响应头部设置：</p>
<p><code>res.setHeader(&#39;Cache-Control&#39;, &#39;public, max-age=20&#39;);</code></p>
<p>（2）客户端请求头部使用默认设置</p>
<p>2.2、实验步骤</p>
<p>（1）请求 3 次，第一次请求资源；然后在服务器对请求的资源进行修改，第二次在 20 秒内再次请求该资源，第三次在 20 秒后再次请求该资源</p>
<p>2.3、实验结果</p>
<p>3 次请求的 HTTP 信息如下图所示，从图中的信息可以得出，第一次请求该资源是从服务器获取；第二次（20 秒内）请求该资源是直接从浏览器缓存中获取该资源（没有向服务器确认）；第三次（20 秒后）请求该资源时，因为资源缓存时间（20 秒）过期，所以向服务器获取资源，服务器判断该资源与本地缓存的资源不同，所以重新返回该资源；以下，根据 HTTP 头部信息详细介绍三个操作的交互过程。</p>
<p><img src="/2019/03/31/HTTP缓存机制及原理/13.png" alt=""><br>2.3.1、第一次请求资源</p>
<p>第一次请求资源的请求头部和响应头部的截图如下所示，具体详细信息与 1.3.1 小节相同，在此不同重复介绍。</p>
<p><img src="/2019/03/31/HTTP缓存机制及原理/14.png" alt=""><br>2.3.2、第二次请求资源（20 秒内，即在缓存时间失效前）</p>
<p>第二次请求资源的请求头部和响应头部的截图如下所示，（注意：即使此时服务器上的资源已经更改，但是由于缓存在浏览器中的资源没有过期，所以还是从缓存中返回旧资源）。</p>
<p><img src="/2019/03/31/HTTP缓存机制及原理/15.png" alt=""><br>2.3.3、第三次请求资源（20 秒后，即在缓存时间失效后）</p>
<p>第三次请求资源的请求头部和响应头部的截图如下所示，因为第三次请求该资源，该资源本地缓存已经失效，所以在请求头部中加入<code>If-Modified-Since</code>和<code>If-None-Match</code>属性，来向服务器进行确认该资源是否有被更改，从下图中可以看到，响应头部的属性 <code>etag</code>与 请求头部的属性<code>If-None-Match</code>  不同，响应头部的属性<code>If-Modified-Since</code>与 请求头部的属性 <code>last-modified</code>不同；所以服务器返回该资源的最新资源。</p>
<p><img src="/2019/03/31/HTTP缓存机制及原理/16.png" alt=""></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>1、对于强制缓存，服务器通知浏览器一个缓存时间，在缓存时间内，下次请求，直接用缓存，不在时间内，执行比较缓存策略。</p>
<p>2、对于比较缓存，将缓存信息中的Etag和Last-Modified通过请求发送给服务器，由服务器校验，返回304状态码时，浏览器直接使用缓存。</p>
<p>总结流程图如下所示：</p>
<p><img src="/2019/03/31/HTTP缓存机制及原理/17.png" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/29/JavaScript手写代码秘籍/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/29/JavaScript手写代码秘籍/" itemprop="url">JavaScript手写代码秘籍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-29T23:10:33+08:00">
                2019-03-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-实现一个new操作符"><a href="#1-实现一个new操作符" class="headerlink" title="1. 实现一个new操作符"></a>1. 实现一个<code>new</code>操作符</h2><blockquote>
<p><a href="https://link.juejin.im?target=http%3A%2F%2Fblog.ifyouseewendy.com%2Fblog%2F2017%2F07%2F03%2Freview-you-dont-know-js-this-and-object-prototypes%2F%23what-happened-when-we-callnew-" target="_blank" rel="noopener">来源：「你不知道的javascript」 英文版</a></p>
</blockquote>
<p><code>new</code>操作符做了这些事：</p>
<ul>
<li>它创建了一个全新的对象。</li>
<li>它会被执行<code>[[Prototype]]</code>（也就是<code>__proto__</code>）链接。</li>
<li>它使<code>this</code>指向新创建的对象。。</li>
<li>通过<code>new</code>创建的每个对象将最终被<code>[[Prototype]]</code>链接到这个函数的<code>prototype</code>对象上。</li>
<li>如果函数没有返回对象类型<code>Object</code>(包含<code>Functoin, Array, Date, RegExg, Error</code>)，那么<code>new</code>表达式中的函数调用将返回该对象引用。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">New</span>(<span class="params">func</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> res = &#123;&#125;;</span><br><span class="line">    <span class="keyword">if</span> (func.prototype !== <span class="literal">null</span>) &#123;</span><br><span class="line">        res.__proto__ = func.prototype;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> ret = func.apply(res, <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">typeof</span> ret === <span class="string">"object"</span> || <span class="keyword">typeof</span> ret === <span class="string">"function"</span>) &amp;&amp; ret !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> obj = New(A, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="comment">// equals to</span></span><br><span class="line"><span class="keyword">var</span> obj = <span class="keyword">new</span> A(<span class="number">1</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<h2 id="2-实现一个JSON-stringify"><a href="#2-实现一个JSON-stringify" class="headerlink" title="2. 实现一个JSON.stringify"></a>2. 实现一个<code>JSON.stringify</code></h2><blockquote>
<p><code>JSON.stringify(value[, replacer [, space]])</code>：</p>
</blockquote>
<ul>
<li><code>Boolean | Number| String</code> 类型会自动转换成对应的原始值。</li>
<li><code>undefined</code>、任意函数以及<code>symbol</code>，会被忽略（出现在非数组对象的属性值中时），或者被转换成 <code>null</code>（出现在数组中时）。</li>
<li>不可枚举的属性会被忽略</li>
<li>如果一个对象的属性值通过某种间接的方式指回该对象本身，即循环引用，属性也会被忽略。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">jsonStringify</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    lettype = <span class="keyword">typeof</span> obj;</span><br><span class="line">    <span class="keyword">if</span> (type !== <span class="string">"object"</span> || type === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="regexp">/string|undefined|function/</span>.test(type)) &#123;</span><br><span class="line">            obj = <span class="string">'"'</span> + obj + <span class="string">'"'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">String</span>(obj);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> json = []</span><br><span class="line">        arr = (obj &amp;&amp; obj.constructor === <span class="built_in">Array</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">in</span> obj) &#123;</span><br><span class="line">            <span class="keyword">let</span> v = obj[k];</span><br><span class="line">            lettype = <span class="keyword">typeof</span> v;</span><br><span class="line">            <span class="keyword">if</span> (<span class="regexp">/string|undefined|function/</span>.test(type)) &#123;</span><br><span class="line">                v = <span class="string">'"'</span> + v + <span class="string">'"'</span>;</span><br><span class="line">            &#125; elseif (type === <span class="string">"object"</span>) &#123;</span><br><span class="line">                v = jsonStringify(v);</span><br><span class="line">            &#125;</span><br><span class="line">            json.push((arr ? <span class="string">""</span> : <span class="string">'"'</span> + k + <span class="string">'":'</span>) + <span class="built_in">String</span>(v));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (arr ? <span class="string">"["</span> : <span class="string">"&#123;"</span>) + <span class="built_in">String</span>(json) + (arr ? <span class="string">"]"</span> : <span class="string">"&#125;"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">jsonStringify(&#123;<span class="attr">x</span> : <span class="number">5</span>&#125;) <span class="comment">// "&#123;"x":5&#125;"</span></span><br><span class="line">jsonStringify([<span class="number">1</span>, <span class="string">"false"</span>, <span class="literal">false</span>]) <span class="comment">// "[1,"false",false]"</span></span><br><span class="line">jsonStringify(&#123;<span class="attr">b</span>: <span class="literal">undefined</span>&#125;) <span class="comment">// "&#123;"b":"undefined"&#125;"</span></span><br></pre></td></tr></table></figure>
<h2 id="3-实现一个JSON-parse"><a href="#3-实现一个JSON-parse" class="headerlink" title="3. 实现一个JSON.parse"></a>3. 实现一个<code>JSON.parse</code></h2><blockquote>
<p><code>JSON.parse(text[, reviver])</code></p>
</blockquote>
<p>用来解析JSON字符串，构造由字符串描述的JavaScript值或对象。提供可选的reviver函数用以在返回之前对所得到的对象执行变换(操作)。</p>
<h3 id="3-1-第一种：直接调用-eval"><a href="#3-1-第一种：直接调用-eval" class="headerlink" title="3.1 第一种：直接调用 eval"></a>3.1 第一种：直接调用 eval</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">jsonParse</span>(<span class="params">opt</span>) </span>&#123;</span><br><span class="line">    returneval(<span class="string">'('</span> + opt + <span class="string">')'</span>);</span><br><span class="line">&#125;</span><br><span class="line">jsonParse(jsonStringify(&#123;<span class="attr">x</span> : <span class="number">5</span>&#125;))</span><br><span class="line"><span class="comment">// Object &#123; x: 5&#125;</span></span><br><span class="line">jsonParse(jsonStringify([<span class="number">1</span>, <span class="string">"false"</span>, <span class="literal">false</span>]))</span><br><span class="line"><span class="comment">// [1, "false", falsr]</span></span><br><span class="line">jsonParse(jsonStringify(&#123;<span class="attr">b</span>: <span class="literal">undefined</span>&#125;))</span><br><span class="line"><span class="comment">// Object &#123; b: "undefined"&#125;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>避免在不必要的情况下使用 <code>eval</code>，eval() 是一个危险的函数， 他执行的代码拥有着执行者的权利。如果你用 eval()运行的字符串代码被恶意方（不怀好意的人）操控修改，您最终可能会在您的网页/扩展程序的权限下，在用户计算机上运行恶意代码。</p>
</blockquote>
<p><strong>它会执行JS代码，有XSS漏洞。</strong></p>
<p><strong>如果你只想记这个方法，就得对参数json做校验。</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rx_one = <span class="regexp">/^[\],:&#123;&#125;\s]*$/</span>;</span><br><span class="line"><span class="keyword">var</span> rx_two = <span class="regexp">/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]&#123;4&#125;)/g</span>;</span><br><span class="line"><span class="keyword">var</span> rx_three = <span class="regexp">/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g</span>;</span><br><span class="line"><span class="keyword">var</span> rx_four = <span class="regexp">/(?:^|:|,)(?:\s*\[)+/g</span>;</span><br><span class="line"><span class="keyword">if</span> (</span><br><span class="line">    rx_one.test(</span><br><span class="line">        json</span><br><span class="line">            .replace(rx_two, <span class="string">"@"</span>)</span><br><span class="line">            .replace(rx_three, <span class="string">"]"</span>)</span><br><span class="line">            .replace(rx_four, <span class="string">""</span>)</span><br><span class="line">    )</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">var</span> obj = <span class="built_in">eval</span>(<span class="string">"("</span> +json + <span class="string">")"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-第二种：Function"><a href="#3-2-第二种：Function" class="headerlink" title="3.2 第二种：Function"></a>3.2 第二种：Function</h3><blockquote>
<p>来源 <a href="https://link.juejin.im?target=https%3A%2F%2Fimys.net%2F20151222%2Feval-with-new-function.html" target="_blank" rel="noopener">神奇的eval()与new Function()</a></p>
</blockquote>
<p>核心：<code>Function</code>与<code>eval</code>有相同的字符串参数特性。</p>
<blockquote>
<p><code>var func = new Function(arg1, arg2, ..., functionBody);</code></p>
</blockquote>
<p>在转换JSON的实际应用中，只需要这么做。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> jsonStr = <span class="string">'&#123; "age": 20, "name": "jack" &#125;'</span></span><br><span class="line"><span class="keyword">var</span> json = (<span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">'return '</span> + jsonStr))();</span><br></pre></td></tr></table></figure></p>
<p><code>eval</code> 与 <code>Function</code> 都有着动态编译js代码的作用，但是在实际的编程中并不推荐使用。</p>
<p><strong>这里是面向面试编程，写这两种就够了。至于第三，第四种，涉及到繁琐的递归和状态机相关原理，具体可以看：</strong></p>
<blockquote>
<p><a href="https://link.juejin.im?target=https%3A%2F%2Fgithub.com%2Fyoungwind%2Fblog%2Fissues%2F115" target="_blank" rel="noopener">《JSON.parse 三种实现方式》</a></p>
</blockquote>
<h2 id="4-实现一个call或-apply"><a href="#4-实现一个call或-apply" class="headerlink" title="4. 实现一个call或 apply"></a>4. 实现一个<code>call</code>或 <code>apply</code></h2><p><code>call</code>语法：</p>
<blockquote>
<p><code>fun.call(thisArg, arg1, arg2, ...)</code>，调用一个函数, 其具有一个指定的this值和分别地提供的参数(参数的列表)。</p>
</blockquote>
<p><code>apply</code>语法：</p>
<blockquote>
<p><code>func.apply(thisArg, [argsArray])</code>，调用一个函数，以及作为一个数组（或类似数组对象）提供的参数。</p>
</blockquote>
<h3 id="4-1-Function-call按套路实现"><a href="#4-1-Function-call按套路实现" class="headerlink" title="4.1 Function.call按套路实现"></a>4.1 <code>Function.call</code>按套路实现</h3><p><code>call</code>核心：</p>
<ul>
<li>将函数设为对象的属性</li>
<li>执行&amp;删除这个函数</li>
<li>指定<code>this</code>到函数并传入给定参数执行函数</li>
<li>如果不传入参数，默认指向为 window</li>
</ul>
<p>为啥说是套路实现呢？因为真实面试中，面试官很喜欢让你逐步地往深考虑，这时候你可以反套路他，先写个简单版的：</p>
<h3 id="4-1-1-简单版"><a href="#4-1-1-简单版" class="headerlink" title="4.1.1 简单版"></a>4.1.1 简单版</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = &#123;</span><br><span class="line">    value: <span class="number">1</span>,</span><br><span class="line">    bar: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">foo.bar() <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>
<h3 id="4-1-2-完善版"><a href="#4-1-2-完善版" class="headerlink" title="4.1.2 完善版"></a>4.1.2 完善版</h3><p>当面试官有进一步的发问，或者此时你可以假装思考一下。然后写出以下版本：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.call2 = <span class="function"><span class="keyword">function</span>(<span class="params">content = window</span>) </span>&#123;</span><br><span class="line">    content.fn = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">let</span> args = [...arguments].slice(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">let</span> result = content.fn(...args);</span><br><span class="line">    delect content.fn;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> foo = &#123;</span><br><span class="line">    value: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params">name, age</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(name)</span><br><span class="line">    <span class="built_in">console</span>.log(age)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.value);</span><br><span class="line">&#125;</span><br><span class="line">bar.call2(foo, <span class="string">'black'</span>, <span class="string">'18'</span>) <span class="comment">// black 18 1</span></span><br></pre></td></tr></table></figure></p>
<h3 id="4-2-Function-apply的模拟实现"><a href="#4-2-Function-apply的模拟实现" class="headerlink" title="4.2 Function.apply的模拟实现"></a>4.2 <code>Function.apply</code>的模拟实现</h3><p><code>apply()</code>的实现和<code>call()</code>类似，只是参数形式不同。直接贴代码吧：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.apply2 = <span class="function"><span class="keyword">function</span>(<span class="params">context = window</span>) </span>&#123;</span><br><span class="line">    context.fn = <span class="keyword">this</span></span><br><span class="line">    <span class="keyword">let</span> result;</span><br><span class="line">    <span class="comment">// 判断是否有第二个参数</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">arguments</span>[<span class="number">1</span>]) &#123;</span><br><span class="line">        result = context.fn(...arguments[<span class="number">1</span>])</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = context.fn()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span> context.fn()</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="5-实现一个Function-bind"><a href="#5-实现一个Function-bind" class="headerlink" title="5. 实现一个Function.bind()"></a>5. 实现一个<code>Function.bind()</code></h2><p><code>bind()</code>方法:</p>
<blockquote>
<p>会创建一个新函数。当这个新函数被调用时，bind() 的第一个参数将作为它运行时的 this，之后的一序列参数将会在传递的实参前传入作为它的参数。(来自于 MDN )</p>
</blockquote>
<p>此外，<code>bind</code>实现需要考虑实例化后对原型链的影响。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.bind2 = <span class="function"><span class="keyword">function</span>(<span class="params">content</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="keyword">this</span> != <span class="string">"function"</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">Error</span>(<span class="string">"not a function"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 若没问参数类型则从这开始写</span></span><br><span class="line">    <span class="keyword">let</span> fn = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">let</span> args = [...arguments].slice(<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> resFn = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fn.apply(<span class="keyword">this</span> <span class="keyword">instanceof</span> resFn ? <span class="keyword">this</span> : content,args.concat(...arguments) )</span><br><span class="line">    &#125;</span><br><span class="line">    functiontmp() &#123;&#125;</span><br><span class="line">    tmp.prototype = <span class="keyword">this</span>.prototype;</span><br><span class="line">    resFn.prototype = <span class="keyword">new</span> tmp();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> resFn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="6-实现一个继承"><a href="#6-实现一个继承" class="headerlink" title="6. 实现一个继承"></a>6. 实现一个继承</h2><p><strong>寄生组合式继承</strong></p>
<p>一般只建议写这种，因为其它方式的继承会在一次实例中调用两次父类的构造函数或有其它缺点。</p>
<p>核心实现是：<strong>用一个 <code>F</code> 空的构造函数去取代执行了 <code>Parent</code> 这个构造函数。</strong><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Parent</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">&#125;</span><br><span class="line">Parent.prototype.sayName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'parent name:'</span>, <span class="keyword">this</span>.name);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Child</span>(<span class="params">name, parentName</span>) </span>&#123;</span><br><span class="line">    Parent.call(<span class="keyword">this</span>, parentName);  </span><br><span class="line">    <span class="keyword">this</span>.name = name;    </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params">proto</span>) </span>&#123;</span><br><span class="line">    functionF()&#123;&#125;</span><br><span class="line">    F.prototype = proto;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> F();</span><br><span class="line">&#125;</span><br><span class="line">Child.prototype = create(Parent.prototype);</span><br><span class="line">Child.prototype.sayName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'child name:'</span>, <span class="keyword">this</span>.name);</span><br><span class="line">&#125;</span><br><span class="line">Child.prototype.constructor = Child;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> parent = <span class="keyword">new</span> Parent(<span class="string">'father'</span>);</span><br><span class="line">parent.sayName();    <span class="comment">// parent name: father</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> child = <span class="keyword">new</span> Child(<span class="string">'son'</span>, <span class="string">'father'</span>);</span><br></pre></td></tr></table></figure></p>
<h2 id="7-实现一个JS函数柯里化"><a href="#7-实现一个JS函数柯里化" class="headerlink" title="7. 实现一个JS函数柯里化"></a>7. 实现一个JS函数柯里化</h2><blockquote>
<p>在计算机科学中，柯里化（Currying）是把接受多个参数的函数变换成接受一个单一参数（最初函数的第一个参数）的函数，并且返回接受余下的参数且返回结果的新函数的技术。</p>
</blockquote>
<p><strong>函数柯里化的主要作用和特点就是参数复用、提前返回和延迟执行。</strong></p>
<h3 id="7-1-通用版"><a href="#7-1-通用版" class="headerlink" title="7.1  通用版"></a>7.1  通用版</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">functioncurry() &#123;</span><br><span class="line">    <span class="keyword">var</span> args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>);</span><br><span class="line">	<span class="keyword">var</span> fn = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> newArgs = args.concat(<span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>));</span><br><span class="line">        <span class="keyword">return</span> multi.apply(<span class="keyword">this</span>, newArgs);</span><br><span class="line">    &#125;</span><br><span class="line">    fn.toString = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> args.reduce(<span class="function"><span class="keyword">function</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> a * b;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fn;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">multiFn</span>(<span class="params">a, b, c</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a * b * c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> multi = curry(multiFn);</span><br><span class="line"></span><br><span class="line">multi(<span class="number">2</span>)(<span class="number">3</span>)(<span class="number">4</span>);</span><br><span class="line">multi(<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">multi(<span class="number">2</span>)(<span class="number">3</span>,<span class="number">4</span>);</span><br><span class="line">multi(<span class="number">2</span>,<span class="number">3</span>)(<span class="number">4</span>);</span><br></pre></td></tr></table></figure>
<h3 id="7-2-ES6骚写法"><a href="#7-2-ES6骚写法" class="headerlink" title="7.2 ES6骚写法"></a>7.2 <code>ES6</code>骚写法</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> curry = <span class="function">(<span class="params">fn, arr = []</span>) =&gt;</span> (...args) =&gt; (</span><br><span class="line">  arg =&gt; arg.length === fn.length</span><br><span class="line">    ? fn(...arg)</span><br><span class="line">    : curry(fn, arg)</span><br><span class="line">)([...arr, ...args])</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> curryTest=curry(<span class="function">(<span class="params">a,b,c,d</span>)=&gt;</span>a+b+c+d)</span><br><span class="line">curryTest(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)(<span class="number">4</span>) <span class="comment">//返回10</span></span><br><span class="line">curryTest(<span class="number">1</span>,<span class="number">2</span>)(<span class="number">4</span>)(<span class="number">3</span>) <span class="comment">//返回10</span></span><br><span class="line">curryTest(<span class="number">1</span>,<span class="number">2</span>)(<span class="number">3</span>,<span class="number">4</span>) <span class="comment">//返回10</span></span><br></pre></td></tr></table></figure>
<h2 id="8-手写一个Promise-中高级必考"><a href="#8-手写一个Promise-中高级必考" class="headerlink" title="8. 手写一个Promise(中高级必考)"></a>8. 手写一个<code>Promise</code>(中高级必考)</h2><p>我们来过一遍<code>Promise/A+</code>规范：</p>
<ul>
<li>三种状态<code>pending| fulfilled(resolved) | rejected</code></li>
<li>当处于<code>pending</code>状态的时候，可以转移到<code>fulfilled(resolved)</code>或者<code>rejected</code>状态</li>
<li>当处于<code>fulfilled(resolved)</code>状态或者<code>rejected</code>状态的时候，就不可变。</li>
</ul>
<blockquote>
<p>必须有一个<code>then</code>异步执行方法，<code>then</code>接受两个参数且必须返回一个promise：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// onFulfilled 用来接收promise成功的值</span></span><br><span class="line"><span class="comment">// onRejected 用来接收promise失败的原因</span></span><br><span class="line">promise1=promise.then(onFulfilled, onRejected);</span><br></pre></td></tr></table></figure>
<h3 id="8-1-Promise的流程图分析"><a href="#8-1-Promise的流程图分析" class="headerlink" title="8.1 Promise的流程图分析"></a>8.1 <code>Promise</code>的流程图分析</h3><p><img src="/2019/03/29/JavaScript手写代码秘籍/1.png" alt=""><br>来回顾下<code>Promise</code>用法：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (操作成功) &#123;</span><br><span class="line">        resolve(value)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        reject(error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">promise.then(<span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// success</span></span><br><span class="line">&#125;,<span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// failure</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="8-2-面试够用版"><a href="#8-2-面试够用版" class="headerlink" title="8.2 面试够用版"></a>8.2 面试够用版</h3><blockquote>
<p>来源：<a href="https://link.juejin.im?target=https%3A%2F%2Fgithub.com%2Fforthealllight%2Fblog%2Fissues%2F4" target="_blank" rel="noopener">实现一个完美符合Promise/A+规范的Promise</a></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myPromise</span>(<span class="params">constructor</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> self=<span class="keyword">this</span>;</span><br><span class="line">    self.status=<span class="string">"pending"</span> <span class="comment">//定义状态改变前的初始状态</span></span><br><span class="line">    self.value=<span class="literal">undefined</span>;<span class="comment">//定义状态为resolved的时候的状态</span></span><br><span class="line">    self.reason=<span class="literal">undefined</span>;<span class="comment">//定义状态为rejected的时候的状态</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">resolve</span>(<span class="params">value</span>)</span>&#123;</span><br><span class="line">        <span class="comment">//两个==="pending"，保证了状态的改变是不可逆的</span></span><br><span class="line">       <span class="keyword">if</span>(self.status===<span class="string">"pending"</span>)&#123;</span><br><span class="line">          self.value=value;</span><br><span class="line">          self.status=<span class="string">"resolved"</span>;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">reject</span>(<span class="params">reason</span>)</span>&#123;</span><br><span class="line">        <span class="comment">//两个==="pending"，保证了状态的改变是不可逆的</span></span><br><span class="line">       <span class="keyword">if</span>(self.status===<span class="string">"pending"</span>)&#123;</span><br><span class="line">          self.reason=reason;</span><br><span class="line">          self.status=<span class="string">"rejected"</span>;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//捕获构造异常</span></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">       <span class="keyword">constructor</span>(resolve,reject);</span><br><span class="line">    &#125;catch(e)&#123;</span><br><span class="line">       reject(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时，需要在<code>myPromise</code>的原型上定义链式调用的<code>then</code>方法：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">myPromise.prototype.then=<span class="function"><span class="keyword">function</span>(<span class="params">onFullfilled,onRejected</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">let</span> self=<span class="keyword">this</span>;</span><br><span class="line">   <span class="keyword">switch</span>(self.status)&#123;</span><br><span class="line">      <span class="keyword">case</span><span class="string">"resolved"</span>:</span><br><span class="line">        onFullfilled(self.value);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span><span class="string">"rejected"</span>:</span><br><span class="line">        onRejected(self.reason);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:       </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>测试一下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p=<span class="keyword">new</span> myPromise(<span class="function"><span class="keyword">function</span>(<span class="params">resolve,reject</span>)</span>&#123;resolve(<span class="number">1</span>)&#125;);</span><br><span class="line">p.then(<span class="function"><span class="keyword">function</span>(<span class="params">x</span>)</span>&#123;<span class="built_in">console</span>.log(x)&#125;)</span><br><span class="line"><span class="comment">//输出1</span></span><br></pre></td></tr></table></figure></p>
<h3 id="8-3-大厂专供版"><a href="#8-3-大厂专供版" class="headerlink" title="8.3 大厂专供版"></a>8.3 大厂专供版</h3><p>直接贴出来吧，这个版本还算好理解<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PENDING = <span class="string">"pending"</span>;</span><br><span class="line"><span class="keyword">const</span> FULFILLED = <span class="string">"fulfilled"</span>;</span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">"rejected"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Promise</span>(<span class="params">excutor</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> that = <span class="keyword">this</span>; <span class="comment">// 缓存当前promise实例对象</span></span><br><span class="line">    that.status = PENDING; <span class="comment">// 初始状态</span></span><br><span class="line">    that.value = <span class="literal">undefined</span>; <span class="comment">// fulfilled状态时 返回的信息</span></span><br><span class="line">    that.reason = <span class="literal">undefined</span>; <span class="comment">// rejected状态时 拒绝的原因</span></span><br><span class="line">    that.onFulfilledCallbacks = []; <span class="comment">// 存储fulfilled状态对应的onFulfilled函数</span></span><br><span class="line">    that.onRejectedCallbacks = []; <span class="comment">// 存储rejected状态对应的onRejected函数</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">resolve</span>(<span class="params">value</span>) </span>&#123; <span class="comment">// value成功态时接收的终值</span></span><br><span class="line">        <span class="keyword">if</span>(value <span class="keyword">instanceof</span> <span class="built_in">Promise</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> value.then(resolve, reject);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 实践中要确保 onFulfilled 和 onRejected 方法异步执行，且应该在 then 方法被调用的那一轮事件循环之后的新执行栈中执行。</span></span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 调用resolve 回调对应onFulfilled函数</span></span><br><span class="line">            <span class="keyword">if</span> (that.status === PENDING) &#123;</span><br><span class="line">                <span class="comment">// 只能由pending状态 =&gt; fulfilled状态 (避免调用多次resolve reject)</span></span><br><span class="line">                that.status = FULFILLED;</span><br><span class="line">                that.value = value;</span><br><span class="line">                that.onFulfilledCallbacks.forEach(<span class="function"><span class="params">cb</span> =&gt;</span> cb(that.value));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">reject</span>(<span class="params">reason</span>) </span>&#123; <span class="comment">// reason失败态时接收的拒因</span></span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 调用reject 回调对应onRejected函数</span></span><br><span class="line">            <span class="keyword">if</span> (that.status === PENDING) &#123;</span><br><span class="line">                <span class="comment">// 只能由pending状态 =&gt; rejected状态 (避免调用多次resolve reject)</span></span><br><span class="line">                that.status = REJECTED;</span><br><span class="line">                that.reason = reason;</span><br><span class="line">                that.onRejectedCallbacks.forEach(<span class="function"><span class="params">cb</span> =&gt;</span> cb(that.reason));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 捕获在excutor执行器中抛出的异常</span></span><br><span class="line">    <span class="comment">// new Promise((resolve, reject) =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//     throw new Error('error in excutor')</span></span><br><span class="line">    <span class="comment">// &#125;)</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        excutor(resolve, reject);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        reject(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.prototype.then = <span class="function"><span class="keyword">function</span>(<span class="params">onFulfilled, onRejected</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> that = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">let</span> newPromise;</span><br><span class="line">    <span class="comment">// 处理参数默认值 保证参数后续能够继续执行</span></span><br><span class="line">    onFulfilled =</span><br><span class="line">        <span class="keyword">typeof</span> onFulfilled === <span class="string">"function"</span> ? onFulfilled : <span class="function"><span class="params">value</span> =&gt;</span> value;</span><br><span class="line">    onRejected =</span><br><span class="line">        <span class="keyword">typeof</span> onRejected === <span class="string">"function"</span> ? onRejected : <span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> reason;</span><br><span class="line">        &#125;;</span><br><span class="line">    <span class="keyword">if</span> (that.status === FULFILLED) &#123; <span class="comment">// 成功态</span></span><br><span class="line">        <span class="keyword">return</span> newPromise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="keyword">let</span> x = onFulfilled(that.value);</span><br><span class="line">                    resolvePromise(newPromise, x, resolve, reject); <span class="comment">// 新的promise resolve 上一个onFulfilled的返回值</span></span><br><span class="line">                &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                    reject(e); <span class="comment">// 捕获前面onFulfilled中抛出的异常 then(onFulfilled, onRejected);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (that.status === REJECTED) &#123; <span class="comment">// 失败态</span></span><br><span class="line">        <span class="keyword">return</span> newPromise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> x = onRejected(that.reason);</span><br><span class="line">                    resolvePromise(newPromise, x, resolve, reject);</span><br><span class="line">                &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                    reject(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (that.status === PENDING) &#123; <span class="comment">// 等待态</span></span><br><span class="line">        <span class="comment">// 当异步调用resolve/rejected时 将onFulfilled/onRejected收集暂存到集合中</span></span><br><span class="line">        <span class="keyword">return</span> newPromise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            that.onFulfilledCallbacks.push(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> x = onFulfilled(value);</span><br><span class="line">                    resolvePromise(newPromise, x, resolve, reject);</span><br><span class="line">                &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                    reject(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            that.onRejectedCallbacks.push(<span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> x = onRejected(reason);</span><br><span class="line">                    resolvePromise(newPromise, x, resolve, reject);</span><br><span class="line">                &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                    reject(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>emmm，我还是乖乖地写回进阶版吧。</p>
<h2 id="9-手写防抖-Debouncing-和节流-Throttling"><a href="#9-手写防抖-Debouncing-和节流-Throttling" class="headerlink" title="9. 手写防抖(Debouncing)和节流(Throttling)"></a>9. 手写防抖(<code>Debouncing</code>)和节流(<code>Throttling</code>)</h2><blockquote>
<p><code>scroll</code> 事件本身会触发页面的重新渲染，同时 <code>scroll</code> 事件的 <code>handler</code> 又会被高频度的触发, 因此事件的 <code>handler</code> 内部不应该有复杂操作，例如 <code>DOM</code> 操作就不应该放在事件处理中。<br>针对此类高频度触发事件问题（例如页面 <code>scroll</code> ，屏幕 <code>resize</code>，监听用户输入等），有两种常用的解决方法，防抖和节流。</p>
</blockquote>
<h3 id="9-1-防抖-Debouncing-实现"><a href="#9-1-防抖-Debouncing-实现" class="headerlink" title="9.1 防抖(Debouncing)实现"></a>9.1 防抖(<code>Debouncing</code>)实现</h3><p>典型例子：限制 鼠标连击 触发。</p>
<p>一个比较好的解释是：</p>
<blockquote>
<p>当一次事件发生后，事件处理器要等一定阈值的时间，如果这段时间过去后 再也没有 事件发生，就处理最后一次发生的事件。假设还差 <code>0.01</code> 秒就到达指定时间，这时又来了一个事件，那么之前的等待作废，需要重新再等待指定时间。</p>
</blockquote>
<p><img src="/2019/03/29/JavaScript手写代码秘籍/2.png" alt=""></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 防抖动函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">debounce</span>(<span class="params">fn,wait=<span class="number">50</span>,immediate</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> timer;</span><br><span class="line">    returnfunction() &#123;</span><br><span class="line">        <span class="keyword">if</span>(immediate) &#123;</span><br><span class="line">            fn.apply(<span class="keyword">this</span>,<span class="built_in">arguments</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(timer) clearTimeout(timer)</span><br><span class="line">        timer = setTimeout(<span class="function"><span class="params">()</span>=&gt;</span> &#123;</span><br><span class="line">            fn.apply(<span class="keyword">this</span>,<span class="built_in">arguments</span>)</span><br><span class="line">        &#125;,wait)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="9-2-节流-Throttling-实现"><a href="#9-2-节流-Throttling-实现" class="headerlink" title="9.2 节流(Throttling)实现"></a>9.2 节流(<code>Throttling</code>)实现</h3><blockquote>
<p>可以理解为事件在一个管道中传输，加上这个节流阀以后，事件的流速就会减慢。实际上这个函数的作用就是如此，它可以将一个函数的调用频率限制在一定阈值内，例如 1s，那么 1s 内这个函数一定不会被调用两次</p>
</blockquote>
<p><img src="/2019/03/29/JavaScript手写代码秘籍/3.png" alt=""></p>
<p>简单的节流函数:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">throttle</span>(<span class="params">fn, wait</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> prev = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">	returnfunction() &#123; </span><br><span class="line">	    <span class="keyword">const</span> args = <span class="built_in">arguments</span>;</span><br><span class="line">		<span class="keyword">const</span> now = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">		<span class="keyword">if</span> (now - prev &gt; wait) &#123;</span><br><span class="line">			fn.apply(<span class="keyword">this</span>, args);</span><br><span class="line">			prev = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="9-3-结合实践"><a href="#9-3-结合实践" class="headerlink" title="9.3 结合实践"></a>9.3 结合实践</h3><p><strong>通过第三个参数来切换模式。</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> throttle = <span class="function"><span class="keyword">function</span>(<span class="params">fn, delay, isDebounce</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> timer</span><br><span class="line">  <span class="keyword">let</span> lastCall = <span class="number">0</span></span><br><span class="line">  returnfunction (...args) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDebounce) &#123;</span><br><span class="line">      <span class="keyword">if</span> (timer) clearTimeout(timer)</span><br><span class="line">      timer = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        fn(...args)</span><br><span class="line">      &#125;, delay)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> now = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime()</span><br><span class="line">      <span class="keyword">if</span> (now - lastCall &lt; delay) <span class="keyword">return</span></span><br><span class="line">      lastCall = now</span><br><span class="line">      fn(...args)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="10-手写一个JS深拷贝"><a href="#10-手写一个JS深拷贝" class="headerlink" title="10. 手写一个JS深拷贝"></a>10. 手写一个JS深拷贝</h2><p>有个最著名的乞丐版实现，在《你不知道的JavaScript（上）》里也有提及：<br><img src="/2019/03/29/JavaScript手写代码秘籍/4.png" alt=""></p>
<h3 id="10-1-乞丐版"><a href="#10-1-乞丐版" class="headerlink" title="10.1 乞丐版"></a>10.1 乞丐版</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> newObj = <span class="built_in">JSON</span>.parse( <span class="built_in">JSON</span>.stringify( someObj ) );</span><br></pre></td></tr></table></figure>
<h3 id="10-2-面试够用版"><a href="#10-2-面试够用版" class="headerlink" title="10.2 面试够用版"></a>10.2 面试够用版</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deepCopy</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//判断是否是简单数据类型，</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> obj == <span class="string">"object"</span>)&#123;</span><br><span class="line">        <span class="comment">//复杂数据类型</span></span><br><span class="line">        <span class="keyword">var</span> result = obj.constructor == <span class="built_in">Array</span> ? [] : &#123;&#125;;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">in</span> obj)&#123;</span><br><span class="line">            result[i] = <span class="keyword">typeof</span> obj[i] == <span class="string">"object"</span> ? deepCopy(obj[i]) : obj[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//简单数据类型 直接 == 赋值</span></span><br><span class="line">        <span class="keyword">var</span> result = obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于深拷贝的讨论天天有，这里就贴两种吧，毕竟我…</p>
<h2 id="11-实现一个instanceOf"><a href="#11-实现一个instanceOf" class="headerlink" title="11.实现一个instanceOf"></a>11.实现一个<code>instanceOf</code></h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">instanceOf</span>(<span class="params">left,right</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> proto = left.__proto__;</span><br><span class="line">    <span class="keyword">let</span> prototype = right.prototype</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(proto === <span class="literal">null</span>) returnfalseif(proto === prototype) returntrue</span><br><span class="line">        proto = proto.__proto__;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/13/一道赋值面试题引发的思考4/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/13/一道赋值面试题引发的思考4/" itemprop="url">一道赋值面试题引发的思考4</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-13T21:35:22+08:00">
                2019-03-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="实现一个run方法-使得run-fucArr-能顺序输出1、2、3"><a href="#实现一个run方法-使得run-fucArr-能顺序输出1、2、3" class="headerlink" title="实现一个run方法,使得run(fucArr)能顺序输出1、2、3"></a>实现一个run方法,使得run(fucArr)能顺序输出1、2、3</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fucArr = [</span><br><span class="line">	next =&gt; &#123;</span><br><span class="line">		setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">			next()</span><br><span class="line">		&#125;, <span class="number">300</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	next =&gt; &#123;</span><br><span class="line">		setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">			next()</span><br><span class="line">		&#125;, <span class="number">200</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	next =&gt; &#123;</span><br><span class="line">		setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">			next()</span><br><span class="line">		&#125;, <span class="number">100</span>)</span><br><span class="line">	&#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> run = <span class="function"><span class="params">arr</span>=&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="题目简析"><a href="#题目简析" class="headerlink" title="题目简析"></a>题目简析</h3><p>我们观察 <code>fucArr</code> 每一个子项都具有如下结构：</p>
<ol>
<li>接收一个方法 <code>next</code></li>
<li>有一个计时器，计时器回调方法体内对应着相应的输出</li>
<li>输出结束调用 <code>next</code> 方法。</li>
</ol>
<p>他们的差异就是：计时器时间逐个减少。</p>
<p>直接循环调用 <code>3</code> 个方法肯定是不可取的。为了能按序输出，函数的执行过程应该是上一个函数 <code>console</code> 之后， 再执行下一个函数，而接收的这个 <code>next</code>参数就是执行下一个方法的关键。因为是头到尾依次调用，我们就把<code>fucArr</code> 称之为一个队列。</p>
<h3 id="思路一-递归"><a href="#思路一-递归" class="headerlink" title="思路一:递归"></a>思路一:递归</h3><p>我们假象自己是个编译器，然后把执行的过程进行单步拆解。</p>
<ol>
<li><code>fucArr</code> 是做先执行等待队列第一个，等待中的函数队列为原函数队列的slice(1)；</li>
<li>等待next执行后，然后又执行等待函数队列的第一个函数，等待中的函数队列为原函数队列的slice(1)；</li>
</ol>
<p>听着是不是很像一个<strong> 递归 </strong>的过程，没错，那我们先用递归来实现一下<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> run = <span class="function"><span class="params">arr</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// 递归语句千万条，找到出口第一条，那咱们判断递归出口的条件就是等待队列为空if (arr.length === 0) return;</span></span><br><span class="line">	<span class="comment">// 好的，一句话执行过程写完了</span></span><br><span class="line">	arr[<span class="number">0</span>](<span class="function"><span class="params">()</span> =&gt;</span> run(arr.slice(<span class="number">1</span>)));</span><br><span class="line">&#125;</span><br><span class="line">run(fucArr)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1 2 3；</span></span><br></pre></td></tr></table></figure></p>
<h3 id="思路二"><a href="#思路二" class="headerlink" title="思路二"></a>思路二</h3><p>现在我们从递归的思路中跳脱出来，换种思路继续思考…..</p>
<p>上一个函数执行到某个时机触发了下一个函数的执行。</p>
<p>也就是说上一个函数 <code>trigger</code>，下一个函数才开始执行。</p>
<p>根据描述 <code>trigger</code> 实际上做的就是触发等待队列的第一个函数的执行，因此我们可以如下定义。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> run = <span class="function"><span class="params">arr</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> trigger = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (arr.length === <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">		arr.shift()();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>那么 <code>trigger</code> 何时进行调用呢？很显然， 上一个函数式通过<code>next</code> 去触发下一个函数调用，因此 <code>trigger</code> 应该就是函数接收的<code>next</code>，我们为了方便参数绑定需要重构一下咱们的等待队列函数。当然不要忘了，首次执行要手动<code>trigger</code>一下喔。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> run = <span class="function"><span class="params">arr</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> trigger = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (arr.length === <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">		arr.shift()();</span><br><span class="line">	&#125;</span><br><span class="line">	arr = arr.map(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span><span class="function"><span class="params">()</span> =&gt;</span> val(trigger);</span><br><span class="line">	&#125;)</span><br><span class="line">	trigger();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其实做参数绑定还有一种更优雅一点的方式，bind，所以大家注意咯，bind不单单能绑定this喔。</p>
<p>我们可以稍微改动一下:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> run = <span class="function"><span class="params">arr</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> trigger = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (arr.length === <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">		arr.shift()();</span><br><span class="line">	&#125;</span><br><span class="line">	arr = arr.map(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> val.bind(<span class="literal">null</span>, trigger);</span><br><span class="line">	&#125;)</span><br><span class="line">	trigger();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>都9102年了，既然是前端面试那肯定少不了<code>Promise</code> 的对吧，那我们可不可以掺入一些<code>Promise</code>的元素在里面呢？答案是必然的。</p>
<p>根据<code>Promise</code>的特性，当本身状态改变，去触发<code>then</code>里的方法（这里不要深究这句话，意思了解就好）。是<code>resolve</code> 作为本身状态改动的方法。那状态改变是去做什么事呢？好的，没错<code>trigger</code>。那何时状态改变呢？上一个函数<code>next</code>调用的时候。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> run = <span class="function"><span class="params">arr</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> trigger = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (arr.length === <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">		arr.shift()();</span><br><span class="line">	&#125;</span><br><span class="line">	arr = arr.map(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span><span class="function"><span class="params">()</span> =&gt;</span><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">			val(resolve)</span><br><span class="line">		&#125;).then(trigger);</span><br><span class="line">	&#125;)</span><br><span class="line">	trigger();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="redux的思路"><a href="#redux的思路" class="headerlink" title="redux的思路"></a>redux的思路</h3><p>现在继续清空上面的思路，不要被干扰。</p>
<p>首先给 <code>applymiddleware</code>（以下简称<code>amw</code>）一个简单的定义，<code>amw</code>是接收若干个函数作为参数，最终会返回一个函数，这个函数调用，会按照顺序，依次执行前面作为参数传入的函数。为了不把问题复杂化，请接收我的误导引导，不要怀疑。</p>
<p>以下是作为参数传入的函数要求的结构以下称<code>a</code>结构:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">store=&gt;<span class="function"><span class="params">next</span>=&gt;</span><span class="function"><span class="params">action</span>=&gt;</span>&#123;</span><br><span class="line">	<span class="comment">// dosomething...</span></span><br><span class="line">	next()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>a</code>结构在第一次调用时，会返回一个方法，第二次调用时返回第二个方法，我们先来看源码的一个操作过程。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const chain = middlewares.map(middleware =&gt; middleware(middlewareAPI))</span><br></pre></td></tr></table></figure></p>
<p>首先是一层循环调用，使得函数体变为<code>b</code>结构：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">next=&gt;<span class="function"><span class="params">action</span>=&gt;</span>&#123;</span><br><span class="line">	<span class="comment">// dosomething...</span></span><br><span class="line">	next()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样做是为了以闭包的形式在 <code>dosomething</code> 中能够使用到 <code>middlewareApi</code>。</p>
<p>根据<code>b</code>结构我们可以稍稍改变下原题 ：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fucArr = [</span><br><span class="line">	next =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">		setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">			<span class="built_in">console</span>.log(action++);</span><br><span class="line">			next(action)</span><br><span class="line">		&#125;, <span class="number">300</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	next =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">		setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">			<span class="built_in">console</span>.log(action++);</span><br><span class="line">			next(action)</span><br><span class="line">		&#125;, <span class="number">200</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	next =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">		setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">			<span class="built_in">console</span>.log(action++);</span><br><span class="line">			next(action)</span><br><span class="line">		&#125;, <span class="number">100</span>)</span><br><span class="line">	&#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> run = <span class="function"><span class="params">arr</span>=&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 实现一个run方法，run方法接收fucArr为参数；返回一个函数，这个函数接收一个参数1，最终，依次输出1、2、3// run(fucArr)(1) =&gt; 1 2 3</span></span><br></pre></td></tr></table></figure></p>
<p>变题相对于多了一个参数传递的过程，实际上我们需要顺序执行的其实是结构c：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">action=&gt;&#123;</span><br><span class="line">    <span class="comment">// dosomething...</span></span><br><span class="line">	next()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这些关键还是要如何构建每个函数接收的参数<code>next</code>。</p>
<p>我们做如下假设，当<code>fucArr</code>只有一个函数时 返回的就应该是：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fucArr[<span class="number">0</span>](<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;) <span class="comment">// 为了避免报错，next应为一个空函数// 即：</span></span><br><span class="line">action =&gt; &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(action++);</span><br><span class="line">        <span class="comment">//(()=&gt;&#123;&#125;) 这玩意儿就是接收的next</span></span><br><span class="line">        (<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;)(action)</span><br><span class="line">    &#125;, <span class="number">300</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当<code>fucArr</code>有两个函数时返回：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fucArr[<span class="number">0</span>](fucArr[<span class="number">1</span>](<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;))</span><br><span class="line"><span class="comment">// 即：</span></span><br><span class="line">action =&gt; &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(action++);        </span><br><span class="line">		fucArr[<span class="number">1</span>](<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;)(action)</span><br><span class="line">    &#125;, <span class="number">300</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当有三个函数的时返回：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fucArr[0](fucArr[1](fucArr[2](()=&gt;&#123;&#125;))</span><br></pre></td></tr></table></figure></p>
<p>仔细观察返回函数的结构发现，所有的函数都是接受上一个函数调用后的返回值（以下称模式1），最后一个函数接收的是一个空函数。我们尝试构建模式1：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首先初始想法模型是这样的</span></span><br><span class="line"><span class="comment">// 但是由于咱们是程序执行，不能像上面咱们描述问题的时候，继续往next里塞函数。</span></span><br><span class="line"><span class="comment">// 而在遍历到 next 的下一个函数的时当前是无法明确next应该是什么，因此我们需要将模式改变一下。</span></span><br><span class="line">pre(next());</span><br><span class="line"><span class="comment">// 当遍历到next下一个节点时，把当前函数作为arg传入进来</span></span><br><span class="line">arg=&gt;pre(next(arg))</span><br></pre></td></tr></table></figure></p>
<p><code>pre</code> + <code>next</code> + 遍历，这三个关键词没错，就是reduce。因此：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> reduceResult = fucArr.reduce(<span class="function">(<span class="params">pre,next</span>)=&gt;</span> (...arg)=&gt;pre(next(...arg)));</span><br><span class="line"><span class="comment">// 我们发现这个返回的还是一个 arg=&gt;pre(next(arg)) 这样模式的函数，接收的参数任然是一个函数。</span></span><br><span class="line"><span class="comment">// 于是乎真的需要返回的函数其实是 return reduceResult(()=&gt;&#123;&#125;);</span></span><br></pre></td></tr></table></figure>
<p>所以最终形态是<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> run = <span class="function"><span class="params">arr</span>=&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> reduceResult = arr.reduce(<span class="function">(<span class="params">pre,next</span>)=&gt;</span> (...arg)=&gt;pre(next(...arg)));</span><br><span class="line">	<span class="keyword">return</span> reduceResult(<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;);</span><br><span class="line">&#125;</span><br><span class="line">run(fucArr)(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 1 2 3</span></span><br></pre></td></tr></table></figure></p>
<h3 id="一个关于连续回调的面试题"><a href="#一个关于连续回调的面试题" class="headerlink" title="一个关于连续回调的面试题"></a><a href="http://www.qiutianaimeili.com/html/page/2019/03/8rfqp1yeul5.html" target="_blank" rel="noopener">一个关于连续回调的面试题</a></h3><h3 id="递归"><a href="#递归" class="headerlink" title="递归"></a>递归</h3><p>我们每次只执行数组中的第一个方法，同时，我们向next里面塞一个方法，这个方法会剔除掉数组中的第一个元素然后继续执行数组中“第一个方法”。（注意，这个方法是数组中的第二个方法）<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> run = <span class="function"><span class="params">arr</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(arr.length === <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    arr[<span class="number">0</span>](<span class="function"><span class="params">()</span> =&gt;</span> run(arr.slice(<span class="number">1</span>)));</span><br><span class="line">&#125;</span><br><span class="line">run(fucArr)</span><br></pre></td></tr></table></figure></p>
<h3 id="async-await"><a href="#async-await" class="headerlink" title="async await"></a>async await</h3><p>上面的问题其实就是异步串行，async中利用for配合await可以比较简单的写出异步串行：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">go</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;fucArr.length;i++)&#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span>=&gt;</span>&#123;</span><br><span class="line">            fucArr[i](resolve);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">go();</span><br></pre></td></tr></table></figure></p>
<h3 id="reduce-Promise-resolve"><a href="#reduce-Promise-resolve" class="headerlink" title="reduce Promise.resolve()"></a>reduce Promise.resolve()</h3><p>在我的另外一篇文章中，有介绍reduce和Promise.resolve()的妙用， reduce使用Promise.resolve()构造连续Promise回调，它们也是解决异步串行的一个方法：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">go</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    fucArr.reduce(<span class="function">(<span class="params">prev,next</span>)=&gt;</span>&#123;    </span><br><span class="line">        <span class="keyword">return</span> prev.then(<span class="function"><span class="params">()</span>=&gt;</span><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span>=&gt;</span>&#123;</span><br><span class="line">            next(resolve);</span><br><span class="line">        &#125;))</span><br><span class="line">    &#125;,<span class="built_in">Promise</span>.resolve());</span><br><span class="line">&#125;</span><br><span class="line">go();</span><br></pre></td></tr></table></figure></p>
<h3 id="map-Promise-resolve"><a href="#map-Promise-resolve" class="headerlink" title="map Promise.resolve()"></a>map Promise.resolve()</h3><p>和上的思路差不多，但是写法略有不同：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> resolve=<span class="built_in">Promise</span>.resolve();</span><br><span class="line">fucArr.map(<span class="function"><span class="params">item</span>=&gt;</span>&#123;</span><br><span class="line">     resolve=resolve.then(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(item);</span><br><span class="line">     &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="Generator"><a href="#Generator" class="headerlink" title="Generator"></a>Generator</h3><p>利用Generator方法也是很容易解决这种异步串行问题：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">go</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;fucArr.length;i++)&#123;</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span>=&gt;</span>&#123;</span><br><span class="line">            fucArr[i](resolve);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> g=go();</span><br><span class="line"><span class="keyword">let</span> run=<span class="function">(<span class="params">p</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!p.done)&#123;</span><br><span class="line">        p.value.then(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">            run(g.next())</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">run(g.next());</span><br></pre></td></tr></table></figure></p>
<h3 id="reduceRight"><a href="#reduceRight" class="headerlink" title="reduceRight"></a>reduceRight</h3><p>我们假设fucArr中的三个方法分别为f1,f2,f3,那么f1(f2(f3(()=&gt;{})))肯定是可以满足要求的，reduceRight就是把这写方法拼凑成f1(f2(f3(()=&gt;{})))这种形式。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fucArr.reduceRight(<span class="function">(<span class="params">prev, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span><span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        next(prev)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, () =&gt; &#123;&#125;)()</span><br></pre></td></tr></table></figure></p>
<p>让我们看看reduceRight执行的具体过程：<br><img src="/2019/03/13/一道赋值面试题引发的思考4/6.png" alt=""></p>
<h3 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h3><p>上面讲了如何用reduceRight去拼凑f1(f2(f3(()=&gt;{})))这种形式，其实用reduce也可以拼凑的：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> run = <span class="function"><span class="params">arr</span> =&gt;</span> arr.reduce(<span class="function">(<span class="params">prev, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">        prev(<span class="function"><span class="params">()</span> =&gt;</span> next(...args))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">run(fucArr)(<span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;);</span><br></pre></td></tr></table></figure></p>
<p>它这种拼凑方式我认为是最复杂的，下面看看具体步骤：<br><img src="/2019/03/13/一道赋值面试题引发的思考4/7.png" alt=""><br>虚线框表示在闭包内，剪头代表参数归谁.</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">const</span> fucArr = [</span></span><br><span class="line"><span class="undefined">				next =&gt; &#123;</span></span><br><span class="line"><span class="javascript">					setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">						<span class="built_in">console</span>.log(<span class="number">1</span>);</span></span><br><span class="line"><span class="undefined">						next()</span></span><br><span class="line"><span class="undefined">					&#125;, 900)</span></span><br><span class="line"><span class="undefined">				&#125;,</span></span><br><span class="line"><span class="undefined">				next =&gt; &#123;</span></span><br><span class="line"><span class="javascript">					setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">						<span class="built_in">console</span>.log(<span class="number">2</span>);</span></span><br><span class="line"><span class="undefined">						next()</span></span><br><span class="line"><span class="undefined">					&#125;, 500)</span></span><br><span class="line"><span class="undefined">				&#125;,</span></span><br><span class="line"><span class="undefined">				next =&gt; &#123;</span></span><br><span class="line"><span class="javascript">					setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">						<span class="built_in">console</span>.log(<span class="number">3</span>);</span></span><br><span class="line"><span class="undefined">						next()</span></span><br><span class="line"><span class="undefined">					&#125;, 100)</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			]</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">var</span> run1 = <span class="function"><span class="params">arr</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">				(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">arr</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">							arr[i](resolve);</span></span><br><span class="line"><span class="undefined">						&#125;);</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined">				&#125;)(arr);</span></span><br><span class="line"><span class="undefined">			&#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="comment">//run1(fucArr);</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">var</span> run2 = <span class="function"><span class="params">arr</span> =&gt;</span></span></span><br><span class="line"><span class="undefined">				arr.reduce(</span></span><br><span class="line"><span class="undefined">					(next, v) =&gt;</span></span><br><span class="line"><span class="javascript">					next.then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">						v(res);</span></span><br><span class="line"><span class="undefined">					&#125;)),</span></span><br><span class="line"><span class="javascript">					<span class="built_in">Promise</span>.resolve()</span></span><br><span class="line"><span class="undefined">				);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="comment">//run2(fucArr);</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="function"><span class="keyword">function</span> <span class="title">run3</span>(<span class="params">fucArr</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(!fucArr.length) <span class="keyword">return</span>;</span></span><br><span class="line"><span class="javascript">				fucArr.shift()(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="undefined">					run3(fucArr);</span></span><br><span class="line"><span class="undefined">				&#125;)</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">            </span></span><br><span class="line"><span class="javascript">			<span class="comment">//run3(fucArr)</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">var</span> run4 = <span class="function">(<span class="params">arr</span>) =&gt;</span> arr.reduceRight(<span class="function">(<span class="params">p, v</span>) =&gt;</span> v.bind(<span class="keyword">this</span>, p), () =&gt; &#123;&#125;)();</span></span><br><span class="line"><span class="javascript">			<span class="comment">//run4(fucArr)</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">run5</span>(<span class="params">arr</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">for</span>(<span class="keyword">var</span> item <span class="keyword">of</span> arr) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="undefined">						item(res);</span></span><br><span class="line"><span class="undefined">					&#125;)</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="comment">//run5(fucArr);</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="keyword">const</span> run6 = <span class="function"><span class="params">arr</span> =&gt;</span> </span></span><br><span class="line"><span class="javascript">			                arr.reduce(<span class="function">(<span class="params">prev, next</span>) =&gt;</span></span></span><br><span class="line"><span class="javascript">			                                    (...args) =&gt; prev(<span class="function"><span class="params">()</span> =&gt;</span> next(...args))</span></span><br><span class="line"><span class="javascript">			                             )(<span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;);</span></span><br><span class="line"><span class="javascript">			run6(fucArr);    <span class="comment">// redux思想</span></span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="javascript">			<span class="keyword">var</span> run7 = <span class="function"><span class="params">arr</span>=&gt;</span> arr.length &amp;&amp; arr.shift()(<span class="function"><span class="params">()</span> =&gt;</span> run(arr))</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="自定义事件-new-CustomEvent-amp-document-createEvent"><a href="#自定义事件-new-CustomEvent-amp-document-createEvent" class="headerlink" title="自定义事件 new CustomEvent &amp; document.createEvent"></a>自定义事件 new CustomEvent &amp; document.createEvent</h2><h3 id="new-CustomEvent"><a href="#new-CustomEvent" class="headerlink" title="new CustomEvent"></a>new CustomEvent</h3><p>最近一个项目中需要模拟发起事件，在mdn中发现了这个构造方法CustomEvent<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造方法 CustomerEvent() 创建一个新的 CustomEvent 对象。</span></span><br><span class="line">event = = <span class="keyword">new</span> CustomEvent(typeArg ,customEventInit)</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>参数说明：</p>
</blockquote>
<ul>
<li>typeArg是DOMString代表事件的名称。一个表示 event 名字的字符串</li>
<li>customEventInit（可选）：一个字典类型参数，有如下字段<ul>
<li>detail, 可选的默认值是 null 的任意类型数据，是一个与 event 相关的值</li>
<li>bubbles 一个布尔值，表示该事件能否冒泡。 来自 EventInit。注意：测试chrome默认为不冒泡。</li>
<li>cancelable 一个布尔值，表示该事件是否可以取消。 来自 EventInit</li>
</ul>
</li>
</ul>
<h4 id="发起事件用法"><a href="#发起事件用法" class="headerlink" title="发起事件用法"></a>发起事件用法</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> CustomEvent(eventName, params);</span><br></pre></td></tr></table></figure>
<h4 id="创建一个自定义事件"><a href="#创建一个自定义事件" class="headerlink" title="创建一个自定义事件"></a>创建一个自定义事件</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> event=<span class="keyword">new</span> CustomEvent(<span class="string">'mock-event'</span>);</span><br></pre></td></tr></table></figure>
<h4 id="传递参数"><a href="#传递参数" class="headerlink" title="传递参数"></a>传递参数</h4><p>这里值得注意，需要把想要传递的参数包裹在一个包含detail属性的对象，否则传递的参数不会被挂载？（这里不太确定，我试过传id和params都不会生效）<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createEvent</span>(<span class="params">params, eventName = <span class="string">'mock-event'</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CustomEvent(eventName, &#123; <span class="attr">detail</span>: params &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> event = createEvent(&#123; <span class="attr">id</span>: <span class="string">'0010'</span> &#125;);</span><br></pre></td></tr></table></figure></p>
<h4 id="发起事件调用dispatchEvent方法发起事件，传入你刚才创建的方法"><a href="#发起事件调用dispatchEvent方法发起事件，传入你刚才创建的方法" class="headerlink" title="发起事件调用dispatchEvent方法发起事件，传入你刚才创建的方法"></a>发起事件调用dispatchEvent方法发起事件，传入你刚才创建的方法</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.dispatchEvent(event);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//监听事件</span></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'mock-event'</span>, (&#123; <span class="attr">detail</span>: &#123; id &#125; &#125;) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'id'</span>,id) <span class="comment">// 会在控制台打印0010</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ev = <span class="built_in">document</span>.getElementById(<span class="string">'main'</span>);    </span><br><span class="line"><span class="keyword">const</span> event = <span class="keyword">new</span> CustomEvent(<span class="string">'eventName'</span>, &#123;         </span><br><span class="line">	detail: &#123;               </span><br><span class="line">		message: <span class="string">'Hello World'</span>,</span><br><span class="line">		 time: <span class="keyword">new</span> <span class="built_in">Date</span>()         </span><br><span class="line">	&#125;,</span><br><span class="line">	bubbles: <span class="literal">true</span>,</span><br><span class="line">	cancelable: <span class="literal">true</span>,</span><br><span class="line">	    </span><br><span class="line">&#125;);    </span><br><span class="line">ev.addEventListener(<span class="string">'eventName'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;      </span><br><span class="line">	<span class="built_in">console</span>.log(e);    </span><br><span class="line">&#125;, );    </span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;      </span><br><span class="line">	ev.dispatchEvent(event); <span class="comment">//给节点分派一个合成事件</span></span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>
<h3 id="document-createEvent"><a href="#document-createEvent" class="headerlink" title="document.createEvent"></a>document.createEvent</h3><p>首先创建自定义事件对象<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> event = <span class="built_in">document</span>.createEvent(<span class="string">"CustomEvent"</span>);</span><br></pre></td></tr></table></figure></p>
<p>然后初始化事件对象<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">event.initCustomEvent(<span class="keyword">in</span> DOMString type, <span class="keyword">in</span> boolean canBubble, <span class="keyword">in</span> boolean cancelable, <span class="keyword">in</span> any detail);</span><br></pre></td></tr></table></figure></p>
<p>其中，第一个参数为要处理的事件名<br>第二个参数为表明事件是否冒泡<br>第三个参数为表明是否可以取消事件的默认行为<br>第四个参数为细节参数</p>
<blockquote>
<p>例如：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">event.initCustomEvent(<span class="string">"test"</span>, <span class="literal">true</span>, <span class="literal">true</span>, &#123;<span class="attr">a</span>:<span class="number">1</span>, <span class="attr">b</span>:<span class="number">2</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>表明要处理的事件名为test，事件冒泡，可以取消事件的默认行为，细节参数为一个对象{a:”test”, b:”success”}</p>
<p>最后触发事件对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">document.dispatchEvent(event);</span><br><span class="line"></span><br><span class="line">//当然我们需要定义监控test事件的处理程序</span><br><span class="line">document.addEventListener(&quot;test&quot;, function(e)&#123;</span><br><span class="line">    var obj = e.detail;</span><br><span class="line">    alert(obj.a + &quot;  &quot; + obj.b);</span><br><span class="line">&#125;);</span><br><span class="line">// &quot;test success&quot;</span><br></pre></td></tr></table></figure></p>
<h3 id="综合"><a href="#综合" class="headerlink" title="综合"></a>综合</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatchEvent</span>(<span class="params">element, type, data</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> event; <span class="comment">// Event and CustomEvent on IE9-11 are global objects, not constructors</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(isFunction(Event) &amp;&amp; isFunction(CustomEvent)) &#123;</span><br><span class="line">		event = <span class="keyword">new</span> CustomEvent(type, &#123;</span><br><span class="line">			detail: data,</span><br><span class="line">			bubbles: <span class="literal">true</span>,</span><br><span class="line">			cancelable: <span class="literal">true</span></span><br><span class="line">		&#125;);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		event = <span class="built_in">document</span>.createEvent(<span class="string">'CustomEvent'</span>);</span><br><span class="line">		event.initCustomEvent(type, <span class="literal">true</span>, <span class="literal">true</span>, data);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> element.dispatchEvent(event);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">window</span>.CustomEvent === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">CustomEvent</span>(<span class="params">event, params</span>) </span>&#123;</span><br><span class="line">            params = params || &#123;</span><br><span class="line">                bubbles: <span class="literal">false</span>,</span><br><span class="line">                cancelable: <span class="literal">false</span>,</span><br><span class="line">                detail: <span class="literal">undefined</span></span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">var</span> evt = <span class="built_in">document</span>.createEvent(<span class="string">'Events'</span>);</span><br><span class="line">            <span class="keyword">var</span> bubbles = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> name <span class="keyword">in</span> params) &#123;</span><br><span class="line">                (name === <span class="string">'bubbles'</span>) ? (bubbles = !!params[name]) : (evt[name] = params[name]);</span><br><span class="line">            &#125;</span><br><span class="line">            evt.initEvent(event, bubbles, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> evt;</span><br><span class="line">        &#125;;</span><br><span class="line">        CustomEvent.prototype = <span class="built_in">window</span>.Event.prototype;</span><br><span class="line">        <span class="built_in">window</span>.CustomEvent = CustomEvent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"><span class="comment">//触发如下：</span></span><br><span class="line"><span class="built_in">document</span>.dispatchEvent(event);</span><br><span class="line"></span><br><span class="line"><span class="comment">//3</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">window</span>.CustomEvent) &#123;</span><br><span class="line">        <span class="built_in">window</span>.CustomEvent = <span class="function"><span class="keyword">function</span>(<span class="params">type, config</span>) </span>&#123;</span><br><span class="line">            config = config || &#123; <span class="attr">bubbles</span>: <span class="literal">false</span>, <span class="attr">cancelable</span>: <span class="literal">false</span>, <span class="attr">detail</span>: <span class="literal">undefined</span>&#125;;</span><br><span class="line">            <span class="keyword">var</span> e = <span class="built_in">document</span>.createEvent(<span class="string">'CustomEvent'</span>);</span><br><span class="line">            e.initCustomEvent(type, config.bubbles, config.cancelable, config.detail);</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="built_in">window</span>.CustomEvent.prototype = <span class="built_in">window</span>.Event.prototype;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//触发的时候</span></span><br><span class="line"><span class="keyword">var</span> dispatch = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> e = <span class="keyword">new</span> CustomEvent(event, &#123;</span><br><span class="line">            bubbles: <span class="literal">true</span>,</span><br><span class="line">            cancelable: <span class="literal">true</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//noinspection JSUnresolvedFunction</span></span><br><span class="line">        <span class="built_in">window</span>.dispatchEvent(e);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="数组拍平-扁平化"><a href="#数组拍平-扁平化" class="headerlink" title="数组拍平,扁平化"></a>数组拍平,扁平化</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> arr = [</span><br><span class="line">  [</span><br><span class="line">    [<span class="string">'1-7'</span>, <span class="string">'2-6'</span>],</span><br><span class="line">    <span class="string">'4-6'</span>,</span><br><span class="line">    [</span><br><span class="line">      [<span class="string">'2-0'</span>, <span class="string">'1-4'</span>],</span><br><span class="line">      [<span class="string">'3-9'</span>],</span><br><span class="line">      <span class="string">'4-5'</span>,</span><br><span class="line">    ],</span><br><span class="line">  ]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// Q1: 完成数组 flat 函数</span></span><br><span class="line"><span class="comment">// const flat= arr =&gt; [].concat(...arr.map(v =&gt; Array.isArray(v) ? flat(v) : v));</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flat</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// code</span></span><br><span class="line">   </span><br><span class="line">  <span class="keyword">return</span> arr</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">arr = flat(arr);</span><br><span class="line"><span class="built_in">console</span>.log(arr);</span><br></pre></td></tr></table></figure>
<h3 id="递归-1"><a href="#递归-1" class="headerlink" title="递归"></a>递归</h3><p>如果有对递归不太熟悉的同学，可以看看我的读书笔记 <a href="https://juejin.im/post/5c6524f8f265da2dc0063ef0" target="_blank" rel="noopener">【算法图解】读书笔记：第3章 递归</a>。</p>
<p>递归的核心就在于两步：找到基线条件和递归条件。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flat</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> result = []; <span class="comment">// 利用闭包缓存我们的结果</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_flat</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">    arr.forEach(<span class="function"><span class="params">element</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(element)) &#123; <span class="comment">// 递归条件</span></span><br><span class="line">        _flat(element);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123; <span class="comment">// 基准条件</span></span><br><span class="line">        result.push(element); <span class="comment">// 将符合结果的值推入我们的结果数组中</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  _flat(arr);</span><br><span class="line">  arr = result;</span><br><span class="line">  <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="迭代-广度优先搜索"><a href="#迭代-广度优先搜索" class="headerlink" title="迭代 - 广度优先搜索"></a>迭代 - 广度优先搜索</h3><p>这个思路是我借鉴《图解算法》中广度优先搜索算法章节写的。</p>
<p>1.创建一个数组，保存结果<br>2.创建一个队列<br>3.初始化<br>4.使用 while 循环去遍历 list 里面的每一项<br>5.将第一项推出队列</p>
<ul>
<li>如果是数组，将子项依次推入队列</li>
<li>如果是字符串，将子项推入结果</li>
</ul>
<p>6.当 list 长度为0时候，遍历完成</p>
<p>但是广度优先搜索的结果是不保证顺序的。</p>
<ul>
<li>参考书籍：《图解算法》</li>
<li>不推荐的笔记，没书可以看看<a href="https://github.com/ykst615/Blogs/issues/9" target="_blank" rel="noopener">【算法图解】读书笔记：第6章 广度优先搜索</a></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flat</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> result = []; <span class="comment">// 利用闭包缓存我们的结果</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_flat</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">    arr.forEach(<span class="function"><span class="params">element</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(element)) &#123; <span class="comment">// 递归条件</span></span><br><span class="line">        _flat(element);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123; <span class="comment">// 基准条件</span></span><br><span class="line">        result.push(element); <span class="comment">// 将符合结果的值推入我们的结果数组中</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  _flat(arr);</span><br><span class="line">  arr = result;</span><br><span class="line">  <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="投机取巧的-toString"><a href="#投机取巧的-toString" class="headerlink" title="投机取巧的 toString"></a>投机取巧的 toString</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [1,2,3,[44,55,[66,77]]].toString().split(",")</span></span><br><span class="line"><span class="comment">// [1,2,3,[44,55,[66,77]]].join().split(",")</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// [1,2,3,[44,55,[66,77]]].flat(2)</span></span><br><span class="line"><span class="comment">// ["1", "2", "3", "44", "55", "66", "77"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 首页你得确定你的数据里面没有字符串 ',' 哦</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flat</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  arr.toString().split(<span class="string">','</span>)</span><br><span class="line">  <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// or </span></span><br><span class="line"><span class="comment">// 异曲同工</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flat</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  arr.join(<span class="string">','</span>).split(<span class="string">','</span>)</span><br><span class="line">  <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="迭代-深度优先搜索"><a href="#迭代-深度优先搜索" class="headerlink" title="迭代 - 深度优先搜索"></a>迭代 - 深度优先搜索</h3><p>原理与广度优先搜索类似，通过模拟栈的行为去遍历数组。好处是能够保证有序输出。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flat</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> ret = [];</span><br><span class="line">  <span class="keyword">let</span> s = []; <span class="comment">// 模拟栈的行为</span></span><br><span class="line">  <span class="keyword">if</span> (arr.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = arr.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123; <span class="comment">// 先进后出</span></span><br><span class="line">      s.push(arr[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (s.length &gt; <span class="number">0</span>) &#123; <span class="comment">// 当栈空了，遍历完成</span></span><br><span class="line">    <span class="keyword">let</span> cur = s.pop();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(cur)) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = cur.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        s.push(cur[i]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ret.push(cur);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="数组计算-‘1-7’-gt-1-7-7"><a href="#数组计算-‘1-7’-gt-1-7-7" class="headerlink" title="数组计算 ‘1-7’ =&gt; 1 * 7 = 7"></a>数组计算 ‘1-7’ =&gt; 1 * 7 = 7</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calc</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 随手骚一下，不建议 eval</span></span><br><span class="line">  arr = arr.map(<span class="function"><span class="params">el</span> =&gt;</span> <span class="built_in">eval</span>(el.replace(<span class="string">'-'</span>, <span class="string">'*'</span>)));</span><br><span class="line">  <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calc</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  arr = arr.map(<span class="function"><span class="params">el</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> list = el.split(<span class="string">'-'</span>);</span><br><span class="line">    <span class="keyword">return</span> +list[<span class="number">0</span>] * +list[<span class="number">1</span>];</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="打印出1-5-2-8-6-3-10-9-7-4"><a href="#打印出1-5-2-8-6-3-10-9-7-4" class="headerlink" title="打印出1 5 2 8 6 3 10 9 7 4"></a>打印出1 5 2 8 6 3 10 9 7 4</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">5  2</span><br><span class="line">8  6 3</span><br><span class="line">10 9 7 4</span><br></pre></td></tr></table></figure>
<p><img src="/2019/03/13/一道赋值面试题引发的思考4/1.png" alt=""></p>
<h3 id="思路1"><a href="#思路1" class="headerlink" title="思路1:"></a>思路1:</h3><p><img src="/2019/03/13/一道赋值面试题引发的思考4/2.png" alt=""><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printArr</span>(<span class="params">n</span>) </span>&#123;   <span class="comment">//n 代表行数</span></span><br><span class="line">	<span class="keyword">var</span> a = [],</span><br><span class="line">		k = <span class="number">1</span>,  <span class="comment">//起始值</span></span><br><span class="line">		p = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">		p = i;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; n - i; j++) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span>(a[j]) &#123;</span><br><span class="line">				a[p][j] = k;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				a[j] = [];</span><br><span class="line">				a[j][j] = k;</span><br><span class="line">			&#125;</span><br><span class="line">			k++;</span><br><span class="line">			p++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(printArr(<span class="number">4</span>));</span><br><span class="line"><span class="built_in">console</span>.log(printArr(<span class="number">5</span>));</span><br><span class="line"><span class="built_in">console</span>.log(printArr(<span class="number">6</span>));</span><br></pre></td></tr></table></figure></p>
<h3 id="思路2-从最后一位往前push-if当前push个数-行数-行数-1"><a href="#思路2-从最后一位往前push-if当前push个数-行数-行数-1" class="headerlink" title="思路2:从最后一位往前push,if当前push个数=行数,行数+1"></a>思路2:从最后一位往前push,if当前push个数=行数,行数+1</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//i 代表行数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printArr</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> a = [],</span><br><span class="line">		k = <span class="number">1</span>;   <span class="comment">//起始值</span></span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">var</span> j = i; j &lt; n; j++) &#123;</span><br><span class="line">			<span class="keyword">if</span>(a[j]) &#123;</span><br><span class="line">				a[j].unshift(k++)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				a[j] = [];</span><br><span class="line">				a[j].unshift(k++)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(printArr(<span class="number">4</span>));</span><br><span class="line"><span class="built_in">console</span>.log(printArr(<span class="number">5</span>));</span><br><span class="line"><span class="built_in">console</span>.log(printArr(<span class="number">6</span>));</span><br></pre></td></tr></table></figure>
<h2 id="快速排序-三路快排"><a href="#快速排序-三路快排" class="headerlink" title="快速排序,三路快排"></a>快速排序,三路快排</h2><h3 id="快速排序算法的优化思路总结"><a href="#快速排序算法的优化思路总结" class="headerlink" title="快速排序算法的优化思路总结"></a><a href="https://juejin.im/post/5aa94ca6518825558252120c" target="_blank" rel="noopener">快速排序算法的优化思路总结</a></h3><h3 id="算法与面试之-如何准备算法面试"><a href="#算法与面试之-如何准备算法面试" class="headerlink" title="算法与面试之-如何准备算法面试"></a><a href="https://juejin.im/post/5b23761a6fb9a00e67148e9e" target="_blank" rel="noopener">算法与面试之-如何准备算法面试</a></h3><blockquote>
<p>快速排序是什么?</p>
</blockquote>
<p>快速排序是图灵奖得主C. A. R. Hoare（1934–）于1960时提出来的。<br>快速排序是对冒泡排序的一种改进。它的基本思想是：通过一趟排序将要排序的数据分割成独立的两部分，其中一部分的所有数据都比另外一不部分的所有数据都要小，然后再按此方法对这两部分数据分别进行快速排序，整个排序过程可以递归进行，以此达到整个数据变成有序序列。</p>
<p>整个排序过程只需要三步：</p>
<ul>
<li>在数据集之中，选择一个元素作为”基准”（pivot）。</li>
<li>所有小于”基准”的元素，都移到”基准”的左边；所有大于”基准”的元素，都移到”基准”的右边。</li>
<li>对”基准”左边和右边的两个子集，不断重复第一步和第二步，直到所有子集只剩下一个元素为止。 </li>
</ul>
<blockquote>
<p>引自wikipedia 快速排序（英语：Quicksort），又称划分交换排序（partition-exchange sort），一种排序算法，最早由东尼·霍尔提出。在平均状况下，排序n个项目要Ο(n log n)次比较。在最坏状况下则需要Ο(n2)次比较，但这种状况并不常见。事实上，快速排序通常明显比其他Ο(n log n)算法更快，因为它的内部循环（inner loop）可以在大部分的架构上很有效率地被实现出来。</p>
</blockquote>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li>找到该数组的基准点(中间数)，并创建两个空数组left和right；</li>
<li>遍历数组，拿出数组中的每个数和基准点进行比较，如果比基准点小就放到left数组中，如果比基准点大就放到right数组中；</li>
<li>对数组left和right进行递归调用。</li>
</ol>
<h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">quickSort</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (arr.length&lt;=<span class="number">1</span>) &#123;<span class="keyword">return</span> arr;&#125;</span><br><span class="line">	<span class="keyword">var</span> left = [],</span><br><span class="line">		right = [],</span><br><span class="line">		baseDot =<span class="built_in">Math</span>.round(arr.length/<span class="number">2</span>),</span><br><span class="line">		base =arr.splice(baseDot, <span class="number">1</span>)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> i =<span class="number">0</span>; i &lt;arr.length; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (arr[i] &lt; base) &#123;</span><br><span class="line">			left.push(arr[i])</span><br><span class="line">		&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">			right.push(arr[i])</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> quickSort(left).concat([base], quickSort(right));</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">var</span> arr=[<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">8</span>,<span class="number">7</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">7</span>];</span><br><span class="line"><span class="built_in">console</span>.log(quick_sort(arr));</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">qSort</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (arr.length==<span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> [];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">var</span> left = [];</span><br><span class="line">      <span class="keyword">var</span> right = [];</span><br><span class="line">      <span class="keyword">var</span> pivot = arr[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i =<span class="number">1</span>; i &lt;arr.length; i++) &#123; <span class="comment">// 注意这里的起始值，因为有一个作为flag了</span></span><br><span class="line">         <span class="keyword">if</span> (arr[i] &lt; pivot) &#123;</span><br><span class="line">               left.push(arr[i]);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              right.push(arr[i]);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> qSort(left).concat(pivot, qSort(right));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">qSort</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (arr.length==<span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> [];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> left = [];</span><br><span class="line">  <span class="keyword">var</span> right = [];</span><br><span class="line">  <span class="keyword">var</span> pivot = arr[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i =<span class="number">1</span>; i &lt;arr.length; i++) &#123; <span class="comment">// 注意这里的起始值，因为有一个作为flag了</span></span><br><span class="line">     <span class="keyword">if</span> (arr[i] &lt; pivot) &#123;</span><br><span class="line">           left.push(arr[i]);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          right.push(arr[i]);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> [...qSort(left),pivot,...qSort(right)]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现一个quickSort的封装，并且定义left和right，找到数组的基准点baseDot和对应的基数base，然后遍历数组的每一项和base进行对比，最后递归调用，给出一个跳出条件<code>if (arr.length &lt;= 1) {return arr;}</code></p>
<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">function quickSort(array, left, right) &#123;</span><br><span class="line">	var length =array.length;</span><br><span class="line">		left =typeof left ===&apos;number&apos;? left :0,</span><br><span class="line">		right =typeof right ===&apos;number&apos;? right : length-1;</span><br><span class="line"></span><br><span class="line">    if (left &lt; right) &#123;</span><br><span class="line">        var index = left -1;</span><br><span class="line">        for (var i = left; i &lt;= right; i++) &#123;</span><br><span class="line">            if (array[i] &lt;= array[right]) &#123;</span><br><span class="line">                index++;</span><br><span class="line">                var temp = array[index];</span><br><span class="line">                array[index] = array[i];</span><br><span class="line">                array[i] = temp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        quickSort(array, left, index -1);</span><br><span class="line">        quickSort(array, index +1, right);</span><br><span class="line">    &#125;</span><br><span class="line">    return array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>快速排序的基本思想就是分治法</p>
<blockquote>
<p>引自wikipedia 在计算机科学中，分治法是建基于多项分支递归的一种很重要的算法范式。字面上的解释是“分而治之”，就是把一个复杂的问题分成两个或更多的相同或相似的子问题，直到最后子问题可以简单的直接求解，原问题的解即子问题的解的合并。</p>
</blockquote>
<h3 id="快速排序的改进方法：三路快排"><a href="#快速排序的改进方法：三路快排" class="headerlink" title="快速排序的改进方法：三路快排"></a>快速排序的改进方法：三路快排</h3><blockquote>
<p><strong>定义:</strong> 三路快速排序是快速排序的的一个优化版本， 将数组分成三段， 即小于基准元素、 等于 基准元素和大于基准元素， 这样可以比较高效的处理数组中存在相同元素的情况,其它特征与快速排序基本相同。</p>
</blockquote>
<p>我这里简单概括一下思路，有兴趣的同学可到上面的链接上阅读：<a href="http://www.cnblogs.com/noKing/archive/2017/11/29/7922397.html" target="_blank" rel="noopener">快速排序及优化(Java实现)</a></p>
<ul>
<li>随机选取基准值base(支点随机选取),参考<a href="https://juejin.im/post/5aa94ca6518825558252120c" target="_blank" rel="noopener">快速排序算法的优化思路总结</a></li>
<li>配合着使用插入排序(当问题规模较小时，近乎有序时，插入排序表现的很好)</li>
<li>当大量数据，且重复数多时，用三路快排</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="built_in">console</span>.time(<span class="string">"test0"</span>)</span></span><br><span class="line"><span class="javascript">			<span class="function"><span class="keyword">function</span> <span class="title">qSort</span>(<span class="params">arr</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(arr.length == <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">return</span> [];</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> left = [];</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> right = [];</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> pivot = arr[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript">				<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; arr.length; i++) &#123; <span class="comment">// 注意这里的起始值，因为有一个作为flag了</span></span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(arr[i] &lt; pivot) &#123;</span></span><br><span class="line"><span class="undefined">						left.push(arr[i]);</span></span><br><span class="line"><span class="javascript">					&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="undefined">						right.push(arr[i]);</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">return</span> [...qSort(left), pivot, ...qSort(right)];</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="javascript">			<span class="built_in">console</span>.log(qSort([<span class="number">9</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">0</span>]));</span></span><br><span class="line"><span class="javascript">			<span class="built_in">console</span>.timeEnd(<span class="string">"test0"</span>)</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="built_in">console</span>.time(<span class="string">"test1"</span>)</span></span><br><span class="line"><span class="javascript">			<span class="function"><span class="keyword">function</span> <span class="title">qSort3</span>(<span class="params">arr</span>) </span>&#123;       <span class="comment">//三路快排</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(arr.length == <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">return</span> [];</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> left = [];</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> center = [];</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> right = [];</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> pivot = arr[<span class="number">0</span>];    <span class="comment">//偷懒，直接取第一个,实际取值情况 参考[快速排序算法的优化思路总结]</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;      </span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(arr[i] &lt; pivot) &#123;</span></span><br><span class="line"><span class="undefined">						left.push(arr[i]);</span></span><br><span class="line"><span class="javascript">					&#125; <span class="keyword">else</span> <span class="keyword">if</span>(arr[i] == pivot) &#123;</span></span><br><span class="line"><span class="undefined">						center.push(arr[i]);</span></span><br><span class="line"><span class="javascript">					&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="undefined">						right.push(arr[i]);</span></span><br><span class="line"><span class="undefined">					&#125;</span></span><br><span class="line"><span class="undefined">				&#125;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">return</span> [...qSort3(left), ...center, ...qSort3(right)];</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="javascript">			<span class="built_in">console</span>.log(qSort3([<span class="number">9</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">0</span>]))</span></span><br><span class="line"><span class="javascript">			<span class="built_in">console</span>.timeEnd(<span class="string">"test1"</span>)</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2019/03/13/一道赋值面试题引发的思考4/3.png" alt=""><br><img src="/2019/03/13/一道赋值面试题引发的思考4/4.png" alt=""><br><img src="/2019/03/13/一道赋值面试题引发的思考4/5.png" alt=""><br>可以看到对有重复数据的数据优化还是很可观的。</p>
<h2 id="Vue利用Object-freeze-提升性能"><a href="#Vue利用Object-freeze-提升性能" class="headerlink" title="Vue利用Object.freeze()提升性能"></a>Vue利用Object.freeze()提升性能</h2><p>Object.freeze()是ES5新增的特性，可以冻结一个对象，防止对象被修改。<br>Object.freeze() 可以冻结一个对象，冻结之后不能向这个对象添加新的属性，不能修改其已有属性的值，不能删除已有属性，以及不能修改该对象已有属性的可枚举性、可配置性、可写性。该方法返回被冻结的对象。<br>当你把一个普通的 JavaScript 对象传给 Vue 实例的  data  选项，Vue 将遍历此对象所有的属性，并使用  Object.defineProperty  把这些属性全部转为 getter/setter，这些 getter/setter 对用户来说是不可见的，但是在内部它们让 Vue 追踪依赖，在属性被访问和修改时通知变化。<br>但 Vue 在遇到像 Object.freeze() 这样被设置为不可配置之后的对象属性时，不会为对象加上 setter getter 等数据劫持的方法。</p>
<p>vue 1.0.18+对其提供了支持，对于data或vuex里使用freeze冻结了的对象，vue不会做getter和setter的转换。</p>
<p>如果你有一个巨大的数组或Object，并且确信数据不会修改，使用Object.freeze()可以让性能大幅提升。在我的实际开发中，这种提升大约有5~10倍，倍数随着数据量递增。</p>
<p>并且，Object.freeze()冻结的是值，你仍然可以将变量的引用替换掉。举个例子：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">v-for</span>=<span class="string">"item in list"</span>&gt;</span>&#123;&#123; item.value &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    data: &#123;</span><br><span class="line">        <span class="comment">// vue不会对list里的object做getter、setter绑定</span></span><br><span class="line">        list: <span class="built_in">Object</span>.freeze([</span><br><span class="line">            &#123; <span class="attr">value</span>: <span class="number">1</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">value</span>: <span class="number">2</span> &#125;</span><br><span class="line">        ])</span><br><span class="line">    &#125;,</span><br><span class="line">    created () &#123;</span><br><span class="line">        <span class="comment">// 界面不会有响应</span></span><br><span class="line">        <span class="keyword">this</span>.list[<span class="number">0</span>].value = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 下面两种做法，界面都会响应</span></span><br><span class="line">        <span class="keyword">this</span>.list = [</span><br><span class="line">            &#123; <span class="attr">value</span>: <span class="number">100</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">value</span>: <span class="number">200</span> &#125;</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">this</span>.list = <span class="built_in">Object</span>.freeze([</span><br><span class="line">            &#123; <span class="attr">value</span>: <span class="number">100</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">value</span>: <span class="number">200</span> &#125;</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>vue的文档没有写上这个特性，但这是个非常实用的做法，对于纯展示的大数据，都可以使用Object.freeze提升性能。<br>由于 Object.freeze() 会把对象冻结，所以比较适合展示类的场景，如果你的数据属性需要改变，可以重新替换成一个新的 Object.freeze()的对象。</p>
<h2 id="使用-vm-compile-编译dom"><a href="#使用-vm-compile-编译dom" class="headerlink" title="使用 vm.$compile 编译dom"></a>使用 vm.$compile 编译dom</h2><p>$compile函数可以用来手动调用vue的方式来编译dom。在你需要处理某个jQuery插件生成的html或者服务端返回的html的时候，这个函数可以派上用场。但注意这是个私有api，随时都有可能变动，并且这种做法有违vue的理念。仅在不得已的时候使用。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    data: &#123;</span><br><span class="line">        value: <span class="string">'demo'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    created () &#123;</span><br><span class="line">        <span class="keyword">let</span> dom = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line">        dom.innerHTML = <span class="string">'&#123;&#123; value &#125;&#125;'</span>;</span><br><span class="line">        <span class="keyword">this</span>.$compile(dom);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/26/写一个webpack内联代码插件/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/26/写一个webpack内联代码插件/" itemprop="url">写一个webpack内联代码插件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-26T17:44:40+08:00">
                2019-02-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>单页开发很多时候index.html只有些html,外链一些css和js,通常导致一些打包后的代码非常大,造成头轻脚重。导致index.html很小，打包的js和css很臃肿，我们可以将一些常用的例如reset.css,jquery,vue等内联到index.html,合理分配文件大小，毕竟index.html一个http请求就拿那么点东西，太浪费了。</p>
<p>我们尝试写一个webpack plugin,通过配置实现内联代码！</p>
<h2 id="要求："><a href="#要求：" class="headerlink" title="要求："></a>要求：</h2><ul>
<li>传一个数组，第一个表示要内联的js路径列表，第二个是css路径列表</li>
<li>css插入<code>&lt;head&gt;</code>标签中，js插入<code>&lt;body&gt;</code>标签中</li>
<li>按数组顺序插入</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> WebpackInlineSourcePlugin([&#123;</span><br><span class="line">	path:[<span class="string">'./src/lib/jquery-3.2.1.min.js'</span>,<span class="string">'./src/lib/vue.min.js'</span>]</span><br><span class="line">&#125;,&#123;</span><br><span class="line">	path:[<span class="string">'./src/lib/reset.min.css'</span>,<span class="string">'./src/lib/A.css'</span>]</span><br><span class="line">&#125;]),</span><br></pre></td></tr></table></figure>
<h3 id="WebPackInlineSourcePlugin插件代码-webpack内联code插件"><a href="#WebPackInlineSourcePlugin插件代码-webpack内联code插件" class="headerlink" title="WebPackInlineSourcePlugin插件代码               webpack内联code插件  "></a>WebPackInlineSourcePlugin插件代码              <a href="https://github.com/libin1991/webpack4-vue-more-page-cli/tree/master/webpack%E5%86%85%E8%81%94code%E6%8F%92%E4%BB%B6" target="_blank" rel="noopener"><font color="#dd0000"> webpack内联code插件  </font></a></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> assert = <span class="built_in">require</span>(<span class="string">'assert'</span>); <span class="comment">//断言库</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">typeOf</span>(<span class="params">value, type</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Object</span>.prototype.toString.call(value).slice(<span class="number">8</span>, <span class="number">-1</span>).toLowerCase() === type.toLowerCase();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizeAssets</span>(<span class="params">assets, normalized = &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">	js: [], </span></span></span><br><span class="line"><span class="function"><span class="params">	css: []</span></span></span><br><span class="line"><span class="function"><span class="params">&#125;</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(typeOf(assets, <span class="string">'array'</span>)) &#123;</span><br><span class="line">		assets.forEach(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span>(!index) &#123;</span><br><span class="line">				normalized.js.push(...item.path)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				normalized.css.push(...item.path)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> normalized;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractSource</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> fs.readFileSync(path, &#123;</span><br><span class="line">		encoding: <span class="string">'utf8'</span></span><br><span class="line">	&#125;).toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processAsset</span>(<span class="params">asset</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(asset.type === <span class="string">'css'</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">`&lt;style type="text/css"&gt;<span class="subst">$&#123;extractSource(asset.path)&#125;</span>&lt;/style&gt;`</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">`&lt;script type="text/javascript"&gt;<span class="subst">$&#123;extractSource(asset.path)&#125;</span>&lt;/script&gt;`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">WebpackInlineSourcePlugin</span>(<span class="params">assets, filter</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.assets = normalizeAssets(assets);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">WebpackInlineSourcePlugin.prototype.apply = <span class="function"><span class="keyword">function</span>(<span class="params">compiler</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">const</span> self = <span class="keyword">this</span>;</span><br><span class="line">	compiler.plugin(<span class="string">'compilation'</span>, (compilation) =&gt; &#123;</span><br><span class="line">		compilation.plugin(<span class="string">'html-webpack-plugin-before-html-processing'</span>, (htmlPluginData) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">const</span> bodyAssets = self.assets.js.map(<span class="function">(<span class="params">item</span>)=&gt;</span>&#123;</span><br><span class="line">				<span class="keyword">return</span> &#123;</span><br><span class="line">					path:item,</span><br><span class="line">					type:<span class="string">'js'</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;).map(processAsset);</span><br><span class="line">			 </span><br><span class="line">			<span class="keyword">const</span> headAssets = self.assets.css.map(<span class="function">(<span class="params">item</span>)=&gt;</span>&#123;</span><br><span class="line">				<span class="keyword">return</span> &#123;</span><br><span class="line">					path:item,</span><br><span class="line">					type:<span class="string">'css'</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;).map(processAsset);</span><br><span class="line">          </span><br><span class="line">			htmlPluginData.html = htmlPluginData.html.replace(<span class="regexp">/(&lt;\/head&gt;)/i</span>, (match, head) =&gt; headAssets.join(<span class="string">'\n'</span>) + head);</span><br><span class="line">			htmlPluginData.html = htmlPluginData.html.replace(<span class="regexp">/(&lt;\/body&gt;)/i</span>, (match, body) =&gt; bodyAssets.join(<span class="string">'\n'</span>) + body);</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">	&#125;);</span><br><span class="line">	compiler.plugin(<span class="string">'done'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'Hello World!'</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = WebpackInlineSourcePlugin;</span><br></pre></td></tr></table></figure>
<p>我们以Vue-cli为例,vue.config.js配置：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> WebpackInlineSourcePlugin = <span class="built_in">require</span>(<span class="string">'./plugin/plugin2'</span>);</span><br><span class="line"><span class="keyword">const</span> WebpackfilelistPlugin = <span class="built_in">require</span>(<span class="string">'./plugin/filelist.js'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolve</span>(<span class="params">dir</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> path.join(__dirname, dir)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="comment">// 基本路径</span></span><br><span class="line">    baseUrl: <span class="string">'./'</span>,</span><br><span class="line">    devServer: &#123;</span><br><span class="line">        port: <span class="number">8888</span>,</span><br><span class="line">        open: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    configureWebpack: &#123;</span><br><span class="line">        plugins: [</span><br><span class="line">            <span class="keyword">new</span> webpack.ProvidePlugin(&#123;</span><br><span class="line">                jQuery: <span class="string">'jquery'</span>,</span><br><span class="line">                $: <span class="string">'jquery'</span></span><br><span class="line">            &#125;),</span><br><span class="line">            <span class="keyword">new</span> WebpackInlineSourcePlugin([&#123;</span><br><span class="line">            	path:[<span class="string">'./src/lib/jquery-3.2.1.min.js'</span>,<span class="string">'./src/lib/vue.min.js'</span>]</span><br><span class="line">            &#125;,&#123;</span><br><span class="line">            	path:[<span class="string">'./src/lib/reset.min.css'</span>,<span class="string">'./src/lib/A.css'</span>]</span><br><span class="line">            &#125;]),</span><br><span class="line">            <span class="keyword">new</span> WebpackfilelistPlugin()</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    productionSourceMap: <span class="literal">false</span>,</span><br><span class="line">    lintOnSave: <span class="literal">false</span>,</span><br><span class="line">    chainWebpack: <span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">        config.entry.app = [<span class="string">"babel-polyfill"</span>, resolve(<span class="string">'src/main.js'</span>)]</span><br><span class="line">        <span class="comment">//config.resolve.alias.set('@', resolve('src'))</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="走起"><a href="#走起" class="headerlink" title="走起"></a>走起</h3><p><img src="/2019/02/26/写一个webpack内联代码插件/1.jpg" alt=""><br><img src="/2019/02/26/写一个webpack内联代码插件/2.jpg" alt=""></p>
<h3 id="plugin和loader的区别是什么"><a href="#plugin和loader的区别是什么" class="headerlink" title="plugin和loader的区别是什么"></a>plugin和loader的区别是什么</h3><p>在 Webpack 运行的生命周期中会广播出许多事件，Plugin 可以监听这些事件，在合适的时机通过 Webpack 提供的 API 【事件钩子】改变输出结果。</p>
<blockquote>
<p><font color="#ff0000">对于loader，它就是一个转换器【文件解析器】，将A文件进行编译形成B文件，这里操作的是文件，比如将A.scss或A.less转变为B.css，单纯的文件转换过程 </font><br> </p>
</blockquote>
<blockquote>
<font color="#ff0000">plugin是一个扩展器，它丰富了wepack本身，针对是loader结束后，webpack打包的整个过程，它并不直接操作文件，而是基于事件机制工作，会监听webpack打包过程中的某些节点，执行广泛的任务。 </font> 
</blockquote>
<p>webpack整个构建流程有许多钩子，开发者可以在指定的阶段加入自己的行为到webpack构建流程中。插件由以下构成:</p>
<ul>
<li>一个 JavaScript 命名函数。</li>
<li>在插件函数的 prototype 上定义一个 apply 方法。</li>
<li>指定一个绑定到 webpack 自身的事件钩子。</li>
<li>处理 webpack 内部实例的特定数据。</li>
<li>功能完成后调用 webpack 提供的回调。</li>
</ul>
<p>整个webpack流程由compiler和compilation构成,compiler只会创建一次，compilation如果开起了watch文件变化，那么会多次生成compilation.  </p>
<hr>
<h2 id="Webpack-Plugin原理"><a href="#Webpack-Plugin原理" class="headerlink" title="Webpack Plugin原理"></a>Webpack Plugin原理</h2><p>Webpack 通过 Plugin 机制让其更加灵活，以适应各种应用场景。<br>在 Webpack 运行的生命周期中会广播出许多事件，Plugin 可以监听这些事件，在合适的时机通过 Webpack 提供的 API 改变输出结果。</p>
<p>一个最基础的 Plugin 的代码是这样的：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasicPlugin</span></span>&#123;</span><br><span class="line">  <span class="comment">// 在构造函数中获取用户给该插件传入的配置</span></span><br><span class="line">  <span class="keyword">constructor</span>(options)&#123;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Webpack 会调用 BasicPlugin 实例的 apply 方法给插件实例传入 compiler 对象</span></span><br><span class="line">  apply(compiler)&#123;</span><br><span class="line">    compiler.plugin(<span class="string">'compilation'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">compilation</span>) </span>&#123;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出 Plugin</span></span><br><span class="line"><span class="built_in">module</span>.exports = BasicPlugin;</span><br></pre></td></tr></table></figure></p>
<p>在使用这个 Plugin 时，相关配置代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> BasicPlugin = <span class="built_in">require</span>(<span class="string">'./BasicPlugin.js'</span>);</span><br><span class="line"><span class="built_in">module</span>.export = &#123;</span><br><span class="line">  plugins:[</span><br><span class="line">    <span class="keyword">new</span> BasicPlugin(options),</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Webpack 启动后，在读取配置的过程中会先执行 <code>new BasicPlugin(options)</code> 初始化一个 BasicPlugin 获得其实例。<br>在初始化 compiler 对象后，再调用 <code>basicPlugin.apply(compiler)</code> 给插件实例传入 compiler 对象。<br>插件实例在获取到 compiler 对象后，就可以通过 <code>compiler.plugin(事件名称, 回调函数)</code> 监听到 Webpack 广播出来的事件。<br>并且可以通过 compiler 对象去操作 Webpack。</p>
<p>通过以上最简单的 Plugin 相信你大概明白了 Plugin 的工作原理，但实际开发中还有很多细节需要注意，下面来详细介绍。</p>
<h2 id="Compiler-和-Compilation"><a href="#Compiler-和-Compilation" class="headerlink" title="Compiler 和 Compilation"></a>Compiler 和 Compilation</h2><p>在开发 Plugin 时最常用的两个对象就是 Compiler 和 Compilation，它们是 Plugin 和 Webpack 之间的桥梁。<br>Compiler 和 Compilation 的含义如下：</p>
<ul>
<li>Compiler 对象包含了 Webpack 环境所有的的配置信息，包含 options，loaders，plugins 这些信息，这个对象在 Webpack 启动时候被实例化，它是全局唯一的，可以简单地把它理解为 Webpack 实例；</li>
<li>Compilation 对象包含了当前的模块资源、编译生成资源、变化的文件等。当 Webpack 以开发模式运行时，每当检测到一个文件变化，一次新的 Compilation 将被创建。Compilation 对象也提供了很多事件回调供插件做扩展。通过 Compilation 也能读取到 Compiler 对象。</li>
</ul>
<p>Compiler 和 Compilation 的区别在于：Compiler 代表了整个 Webpack 从启动到关闭的生命周期，而 Compilation 只是代表了一次新的编译。</p>
<h2 id="事件流"><a href="#事件流" class="headerlink" title="事件流"></a>事件流</h2><p>Webpack 就像一条生产线，要经过一系列处理流程后才能将源文件转换成输出结果。<br>这条生产线上的每个处理流程的职责都是单一的，多个流程之间有存在依赖关系，只有完成当前处理后才能交给下一个流程去处理。<br>插件就像是一个插入到生产线中的一个功能，在特定的时机对生产线上的资源做处理。</p>
<p>Webpack 通过 <a href="https://link.juejin.im?target=https%3A%2F%2Fgithub.com%2Fwebpack%2Ftapable" target="_blank" rel="noopener">Tapable</a> 来组织这条复杂的生产线。<br>Webpack 在运行过程中会广播事件，插件只需要监听它所关心的事件，就能加入到这条生产线中，去改变生产线的运作。<br>Webpack 的事件流机制保证了插件的有序性，使得整个系统扩展性很好。</p>
<p>Webpack 的事件流机制应用了观察者模式，和 Node.js 中的 EventEmitter 非常相似。<br>Compiler 和 Compilation 都继承自 Tapable，可以直接在 Compiler 和 Compilation 对象上广播和监听事件，方法如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 广播出事件</span></span><br><span class="line"><span class="comment">* event-name 为事件名称，注意不要和现有的事件重名</span></span><br><span class="line"><span class="comment">* params 为附带的参数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">compiler.apply(<span class="string">'event-name'</span>,params);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 监听名称为 event-name 的事件，当 event-name 事件发生时，函数就会被执行。</span></span><br><span class="line"><span class="comment">* 同时函数中的 params 参数为广播事件时附带的参数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">compiler.plugin(<span class="string">'event-name'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>同理，compilation.apply 和 compilation.plugin 使用方法和上面一致。</p>
<p>在开发插件时，你可能会不知道该如何下手，因为你不知道该监听哪个事件才能完成任务。</p>
<p>在开发插件时，还需要注意以下两点：</p>
<ul>
<li>只要能拿到 Compiler 或 Compilation 对象，就能广播出新的事件，所以在新开发的插件中也能广播出事件，给其它插件监听使用。</li>
<li>传给每个插件的 Compiler 和 Compilation 对象都是同一个引用。也就是说在一个插件中修改了 Compiler 或 Compilation 对象上的属性，会影响到后面的插件。</li>
<li>有些事件是异步的，这些异步的事件会附带两个参数，第二个参数为回调函数，在插件处理完任务时需要调用回调函数通知 Webpack，才会进入下一处理流程。例如： <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  compiler.plugin(<span class="string">'emit'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">compilation, callback</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 支持处理逻辑</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理完毕后执行 callback 以通知 Webpack </span></span><br><span class="line">  <span class="comment">// 如果不执行 callback，运行流程将会一直卡在这不往下执行 </span></span><br><span class="line">  callback();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="常用-API"><a href="#常用-API" class="headerlink" title="常用 API"></a>常用 API</h2><p>插件可以用来修改输出文件、增加输出文件、甚至可以提升 Webpack 性能、等等，总之插件通过调用 Webpack 提供的 API 能完成很多事情。<br>由于 Webpack 提供的 API 非常多，有很多 API 很少用的上，又加上篇幅有限，下面来介绍一些常用的 API。</p>
<h3 id="读取输出资源、代码块、模块及其依赖"><a href="#读取输出资源、代码块、模块及其依赖" class="headerlink" title="读取输出资源、代码块、模块及其依赖"></a>读取输出资源、代码块、模块及其依赖</h3><p>有些插件可能需要读取 Webpack 的处理结果，例如输出资源、代码块、模块及其依赖，以便做下一步处理。</p>
<p>在 <code>emit</code> 事件发生时，代表源文件的转换和组装已经完成，在这里可以读取到最终将输出的资源、代码块、模块及其依赖，并且可以修改输出资源的内容。<br>插件代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Plugin</span> </span>&#123;</span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    compiler.plugin(<span class="string">'emit'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">compilation, callback</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// compilation.chunks 存放所有代码块，是一个数组</span></span><br><span class="line">      compilation.chunks.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// chunk 代表一个代码块</span></span><br><span class="line">        <span class="comment">// 代码块由多个模块组成，通过 chunk.forEachModule 能读取组成代码块的每个模块</span></span><br><span class="line">        chunk.forEachModule(<span class="function"><span class="keyword">function</span> (<span class="params">module</span>) </span>&#123;</span><br><span class="line">          <span class="comment">// module 代表一个模块</span></span><br><span class="line">          <span class="comment">// module.fileDependencies 存放当前模块的所有依赖的文件路径，是一个数组</span></span><br><span class="line">          <span class="built_in">module</span>.fileDependencies.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">filepath</span>) </span>&#123;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Webpack 会根据 Chunk 去生成输出的文件资源，每个 Chunk 都对应一个及其以上的输出文件</span></span><br><span class="line">        <span class="comment">// 例如在 Chunk 中包含了 CSS 模块并且使用了 ExtractTextPlugin 时，</span></span><br><span class="line">        <span class="comment">// 该 Chunk 就会生成 .js 和 .css 两个文件</span></span><br><span class="line">        chunk.files.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">filename</span>) </span>&#123;</span><br><span class="line">          <span class="comment">// compilation.assets 存放当前所有即将输出的资源</span></span><br><span class="line">          <span class="comment">// 调用一个输出资源的 source() 方法能获取到输出资源的内容</span></span><br><span class="line">          <span class="keyword">let</span> source = compilation.assets[filename].source();</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 这是一个异步事件，要记得调用 callback 通知 Webpack 本次事件监听处理结束。</span></span><br><span class="line">      <span class="comment">// 如果忘记了调用 callback，Webpack 将一直卡在这里而不会往后执行。</span></span><br><span class="line">      callback();</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="监听文件变化"><a href="#监听文件变化" class="headerlink" title="监听文件变化"></a>监听文件变化</h3><p>在<a href="https://link.juejin.im?target=..%2F4%25E4%25BC%2598%25E5%258C%2596%2F4-5%25E4%25BD%25BF%25E7%2594%25A8%25E8%2587%25AA%25E5%258A%25A8%25E5%2588%25B7%25E6%2596%25B0.md" target="_blank" rel="noopener">4-5使用自动刷新</a> 中介绍过 Webpack 会从配置的入口模块出发，依次找出所有的依赖模块，当入口模块或者其依赖的模块发生变化时，<br>就会触发一次新的 Compilation。</p>
<p>在开发插件时经常需要知道是哪个文件发生变化导致了新的 Compilation，为此可以使用如下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当依赖的文件发生变化时会触发 watch-run 事件</span></span><br><span class="line">compiler.plugin(<span class="string">'watch-run'</span>, (watching, callback) =&gt; &#123;</span><br><span class="line">	<span class="comment">// 获取发生变化的文件列表</span></span><br><span class="line">	<span class="keyword">const</span> changedFiles = watching.compiler.watchFileSystem.watcher.mtimes;</span><br><span class="line">	<span class="comment">// changedFiles 格式为键值对，键为发生变化的文件路径。</span></span><br><span class="line">	<span class="keyword">if</span> (changedFiles[filePath] !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">	  <span class="comment">// filePath 对应的文件发生了变化</span></span><br><span class="line">	&#125;</span><br><span class="line">	callback();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>默认情况下 Webpack 只会监视入口和其依赖的模块是否发生变化，在有些情况下项目可能需要引入新的文件，例如引入一个 HTML 文件。<br>由于 JavaScript 文件不会去导入 HTML 文件，Webpack 就不会监听 HTML 文件的变化，编辑 HTML 文件时就不会重新触发新的 Compilation。<br>为了监听 HTML 文件的变化，我们需要把 HTML 文件加入到依赖列表中，为此可以使用如下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">compiler.plugin(<span class="string">'after-compile'</span>, (compilation, callback) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 把 HTML 文件添加到文件依赖列表，好让 Webpack 去监听 HTML 模块文件，在 HTML 模版文件发生变化时重新启动一次编译</span></span><br><span class="line">	compilation.fileDependencies.push(filePath);</span><br><span class="line">	callback();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="修改输出资源"><a href="#修改输出资源" class="headerlink" title="修改输出资源"></a>修改输出资源</h3><p>有些场景下插件需要修改、增加、删除输出的资源，要做到这点需要监听 <code>emit</code> 事件，因为发生 <code>emit</code> 事件时所有模块的转换和代码块对应的文件已经生成好，<br>需要输出的资源即将输出，因此 <code>emit</code> 事件是修改 Webpack 输出资源的最后时机。</p>
<p>所有需要输出的资源会存放在 <code>compilation.assets</code> 中，<code>compilation.assets</code> 是一个键值对，键为需要输出的文件名称，值为文件对应的内容。</p>
<p>设置 <code>compilation.assets</code> 的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">compiler.plugin(<span class="string">'emit'</span>, (compilation, callback) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 设置名称为 fileName 的输出资源</span></span><br><span class="line">  compilation.assets[fileName] = &#123;</span><br><span class="line">    <span class="comment">// 返回文件内容</span></span><br><span class="line">    source: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// fileContent 既可以是代表文本文件的字符串，也可以是代表二进制文件的 Buffer</span></span><br><span class="line">      <span class="keyword">return</span> fileContent;</span><br><span class="line">  	&#125;,</span><br><span class="line">    <span class="comment">// 返回文件大小</span></span><br><span class="line">  	size: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> Buffer.byteLength(fileContent, <span class="string">'utf8'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  callback();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>读取 <code>compilation.assets</code> 的代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">compiler.plugin(<span class="string">'emit'</span>, (compilation, callback) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 读取名称为 fileName 的输出资源</span></span><br><span class="line">  <span class="keyword">const</span> asset = compilation.assets[fileName];</span><br><span class="line">  <span class="comment">// 获取输出资源的内容</span></span><br><span class="line">  asset.source();</span><br><span class="line">  <span class="comment">// 获取输出资源的文件大小</span></span><br><span class="line">  asset.size();</span><br><span class="line">  callback();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="判断-Webpack-使用了哪些插件"><a href="#判断-Webpack-使用了哪些插件" class="headerlink" title="判断 Webpack 使用了哪些插件"></a>判断 Webpack 使用了哪些插件</h3><p>在开发一个插件时可能需要根据当前配置是否使用了其它某个插件而做下一步决定，因此需要读取 Webpack 当前的插件配置情况。<br>以判断当前是否使用了 ExtractTextPlugin 为例，可以使用如下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断当前配置使用使用了 ExtractTextPlugin，</span></span><br><span class="line"><span class="comment">// compiler 参数即为 Webpack 在 apply(compiler) 中传入的参数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hasExtractTextPlugin</span>(<span class="params">compiler</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 当前配置所有使用的插件列表</span></span><br><span class="line">  <span class="keyword">const</span> plugins = compiler.options.plugins;</span><br><span class="line">  <span class="comment">// 去 plugins 中寻找有没有 ExtractTextPlugin 的实例</span></span><br><span class="line">  <span class="keyword">return</span> plugins.find(<span class="function"><span class="params">plugin</span>=&gt;</span>plugin.__proto__.constructor === ExtractTextPlugin) != <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>下面我们举一个实际的例子，带你一步步去实现一个插件。</p>
<p>该插件的名称取名叫 EndWebpackPlugin，作用是在 Webpack 即将退出时再附加一些额外的操作，例如在 Webpack 成功编译和输出了文件后执行发布操作把输出的文件上传到服务器。<br>同时该插件还能区分 Webpack 构建是否执行成功。使用该插件时方法如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  plugins:[</span><br><span class="line">    <span class="comment">// 在初始化 EndWebpackPlugin 时传入了两个参数，分别是在成功时的回调函数和失败时的回调函数；</span></span><br><span class="line">    <span class="keyword">new</span> EndWebpackPlugin(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// Webpack 构建成功，并且文件输出了后会执行到这里，在这里可以做发布文件操作</span></span><br><span class="line">    &#125;, (err) =&gt; &#123;</span><br><span class="line">      <span class="comment">// Webpack 构建失败，err 是导致错误的原因</span></span><br><span class="line">      <span class="built_in">console</span>.error(err);        </span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要实现该插件，需要借助两个事件：</p>
<ul>
<li><strong>done</strong>：在成功构建并且输出了文件后，Webpack 即将退出时发生；</li>
<li><strong>failed</strong>：在构建出现异常导致构建失败，Webpack 即将退出时发生；</li>
</ul>
<p>实现该插件非常简单，完整代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EndWebpackPlugin</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(doneCallback, failCallback) &#123;</span><br><span class="line">    <span class="comment">// 存下在构造函数中传入的回调函数</span></span><br><span class="line">    <span class="keyword">this</span>.doneCallback = doneCallback;</span><br><span class="line">    <span class="keyword">this</span>.failCallback = failCallback;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    compiler.plugin(<span class="string">'done'</span>, (stats) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 在 done 事件中回调 doneCallback</span></span><br><span class="line">        <span class="keyword">this</span>.doneCallback(stats);</span><br><span class="line">    &#125;);</span><br><span class="line">    compiler.plugin(<span class="string">'failed'</span>, (err) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 在 failed 事件中回调 failCallback</span></span><br><span class="line">        <span class="keyword">this</span>.failCallback(err);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 导出插件 </span></span><br><span class="line"><span class="built_in">module</span>.exports = EndWebpackPlugin;</span><br></pre></td></tr></table></figure>
<p>从开发这个插件可以看出，找到合适的事件点去完成功能在开发插件时显得尤为重要。</p>
<h2 id="输出打包文件列表"><a href="#输出打包文件列表" class="headerlink" title="输出打包文件列表"></a>输出打包文件列表</h2><p><img src="/2019/02/26/写一个webpack内联代码插件/3.jpg" alt=""><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> gzipSize = <span class="built_in">require</span>(<span class="string">'gzip-size'</span>);</span><br><span class="line"><span class="keyword">const</span> filesize = <span class="built_in">require</span>(<span class="string">'filesize'</span>);</span><br><span class="line"><span class="keyword">const</span> herb = <span class="built_in">require</span>(<span class="string">'herb'</span>);   <span class="comment">//表格输出</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="title">TablePlugin</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    options = &#123;</span><br><span class="line">      errorSize: <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">500</span></span><br><span class="line">    &#125;</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">this</span>.options = options;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    <span class="keyword">const</span> errorSize = <span class="keyword">this</span>.options.errorSize;</span><br><span class="line">    <span class="keyword">const</span> beforeMsg = <span class="keyword">this</span>.options.beforeMsg;</span><br><span class="line">    <span class="keyword">const</span> afterMsg = <span class="keyword">this</span>.options.afterMsg;</span><br><span class="line">    compiler.hooks.done.tapPromise(<span class="string">'table-plugin'</span>, <span class="keyword">async</span> (stats) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (stats.hasErrors()) <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">const</span> assets = stats.compilation.assets;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> gzipedSizes = <span class="keyword">await</span> <span class="built_in">Promise</span>.all(</span><br><span class="line">        <span class="built_in">Object</span>.keys(assets).map(<span class="keyword">async</span> (name) =&gt; &#123;</span><br><span class="line">        	<span class="built_in">console</span>.log(<span class="string">'--------------------------'</span>)</span><br><span class="line">          <span class="built_in">console</span>.log(name)</span><br><span class="line">          <span class="keyword">const</span> size = <span class="keyword">await</span> gzipSize(assets[name].source());</span><br><span class="line">          <span class="keyword">return</span> size;</span><br><span class="line">        &#125;)</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">const</span> headers = [<span class="string">'asset'</span>, <span class="string">'size'</span>, <span class="string">'gziped'</span>];</span><br><span class="line">      <span class="keyword">const</span> rows = <span class="built_in">Object</span>.keys(assets).map(<span class="function">(<span class="params">name, i</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> row = [name, filesize(assets[name].size()), filesize(gzipedSizes[i])];</span><br><span class="line">        <span class="keyword">if</span> (assets[name].size() &gt;= errorSize) &#123;</span><br><span class="line">          row = row.map(herb.red);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> row;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">if</span> (beforeMsg) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(beforeMsg, <span class="string">'\n'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      herb.table(&#123;</span><br><span class="line">        headers,</span><br><span class="line">        rows,</span><br><span class="line">        borders: <span class="literal">false</span></span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">if</span> (afterMsg) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'\n'</span>, afterMsg);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="webpack原理"><a href="#webpack原理" class="headerlink" title="webpack原理"></a><a href="https://segmentfault.com/a/1190000015088834#articleHeader28" target="_blank" rel="noopener">webpack原理</a></h2><h2 id="webpack-loader和plugin编写"><a href="#webpack-loader和plugin编写" class="headerlink" title="webpack loader和plugin编写"></a><a href="https://juejin.im/post/5bbf190de51d450ea52fffd3#heading-1" target="_blank" rel="noopener">webpack loader和plugin编写</a></h2><h2 id="webpack-源码探索之插件机制"><a href="#webpack-源码探索之插件机制" class="headerlink" title="webpack 源码探索之插件机制"></a><a href="https://juejin.im/post/5a80e7fe6fb9a0633a70fe62" target="_blank" rel="noopener">webpack 源码探索之插件机制</a></h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/25/撸一个webpack-loader-plugin/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/25/撸一个webpack-loader-plugin/" itemprop="url">撸一个webpack-loader&plugin</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-25T23:48:29+08:00">
                2019-02-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong> 在 webpack 中，loader 和 plugin 的区分是很清楚的，针对文件模块转换要做的使用 loader，而其他构建过程,干涉构建内容的可以使用 plugin。 </strong></p>
</blockquote>
<h2 id="24-个实例入门并掌握「Webpack4」-一"><a href="#24-个实例入门并掌握「Webpack4」-一" class="headerlink" title="24 个实例入门并掌握「Webpack4」(一)"></a><a href="https://juejin.im/post/5cae0f616fb9a068a93f0613" target="_blank" rel="noopener">24 个实例入门并掌握「Webpack4」(一)</a></h2><h2 id="24-个实例入门并掌握「Webpack4」-二"><a href="#24-个实例入门并掌握「Webpack4」-二" class="headerlink" title="24 个实例入门并掌握「Webpack4」(二)"></a><a href="https://juejin.im/post/5cb01ab0e51d456e3428c0ca" target="_blank" rel="noopener">24 个实例入门并掌握「Webpack4」(二)</a></h2><h2 id="24-个实例入门并掌握「Webpack4」-三"><a href="#24-个实例入门并掌握「Webpack4」-三" class="headerlink" title="24 个实例入门并掌握「Webpack4」(三)"></a><a href="https://juejin.im/post/5cb01f32e51d456e5e035ef7" target="_blank" rel="noopener">24 个实例入门并掌握「Webpack4」(三)</a></h2><h2 id="编写一个-loader"><a href="#编写一个-loader" class="headerlink" title="编写一个 loader"></a><a href="https://www.webpackjs.com/contribute/writing-a-loader/" target="_blank" rel="noopener">编写一个 loader</a></h2><p><a href="https://github.com/libin1991/webpack4-learn?organization=libin1991&amp;organization=libin1991" target="_blank" rel="noopener">webpack-plugin webpack-loader大全</a></p>
<p>新建文件夹，<code>npm init -y</code>，<code>npm i webpack webpack-cli -D</code>，新建 src/index.js，写入 <code>console.log(&#39;hello world&#39;)</code></p>
<p>新建 <code>loaders/replaceLoader.js</code> 文件<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> source.replace(<span class="string">'world'</span>, <span class="string">'loader'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>source 参数就是我们的源代码，这里是将源码中的 world 替换成 loader</p>
<p>新建 <code>webpack.config.js</code><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">'development'</span>,</span><br><span class="line">  entry: &#123;</span><br><span class="line">    main: <span class="string">'./src/index.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/.js/</span>,</span><br><span class="line">        use: [path.resolve(__dirname, <span class="string">'./loaders/replaceLoader.js'</span>)] <span class="comment">// 引入自定义 loader</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    filename: <span class="string">'[name].js'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>目录结构：<br><img src="/2019/02/25/撸一个webpack-loader-plugin/1.jpg" alt=""><br>打包后打开 dist/main.js 文件，在最底部可以看到 world 已经被改为了 loader，一个最简单的 loader 就写完了</p>
<p>添加 optiions 属性<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">'development'</span>,</span><br><span class="line">  entry: &#123;</span><br><span class="line">    main: <span class="string">'./src/index.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/.js/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          &#123;</span><br><span class="line">            loader: path.resolve(__dirname, <span class="string">'./loaders/replaceLoader.js'</span>),</span><br><span class="line">            options: &#123;</span><br><span class="line">              name: <span class="string">'xh'</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    filename: <span class="string">'[name].js'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>修改 replaceLoader.js 文件，保存后打包，输出看看效果<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span>.query)</span><br><span class="line">  <span class="keyword">return</span> source.replace(<span class="string">'world'</span>, <span class="keyword">this</span>.query.name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/2019/02/25/撸一个webpack-loader-plugin/2.jpg" alt=""><br>打包后生成的文件也改为了 options 中定义的 name</p>
<p>更多的配置见官网 <a href="https://www.webpackjs.com/contribute/writing-a-loader/" target="_blank" rel="noopener">API</a>，找到 Loader Interface，里面有个 this.query<br><img src="/2019/02/25/撸一个webpack-loader-plugin/3.jpg" alt=""></p>
<p>如果你的 options 不是一个对象，而是按字符串形式写的话，可能会有一些问题，这里官方推荐使用 <a href="https://link.juejin.im?target=https%3A%2F%2Fgithub.com%2Fwebpack%2Floader-utils%23getoptions" target="_blank" rel="noopener">loader-utils</a> 来获取 options 中的内容</p>
<blockquote>
<p>充分利用 loader-utils 包。它提供了许多有用的工具，但最常用的一种工具是获取传递给 loader 的选项。schema-utils 包配合 loader-utils，用于保证 loader 选项，进行与 JSON Schema 结构一致的校验。</p>
</blockquote>
<p>安装 <code>npm i loader-utils -D</code>，修改 replaceLoader.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options = loaderUtils.getOptions(<span class="keyword">this</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(options)</span><br><span class="line">  <span class="keyword">return</span> source.replace(<span class="string">'world'</span>, options.name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>console.log(options)</code> 与 <code>console.log(this.query)</code> 输出内容一致</p>
<p>如果你想传递额外的信息出去，return 就不好用了，官网给我们提供了 <a href="https://link.juejin.im?target=https%3A%2F%2Fwebpack.js.org%2Fapi%2Floaders%2F%23thiscallback" target="_blank" rel="noopener">this.callback</a> API，用法如下<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.callback(</span><br><span class="line">  err: <span class="built_in">Error</span> | <span class="literal">null</span>,</span><br><span class="line">  content: string | Buffer,</span><br><span class="line">  sourceMap?: SourceMap,</span><br><span class="line">  meta?: any</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>修改 replaceLoader.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options = loaderUtils.getOptions(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">const</span> result = source.replace(<span class="string">'world'</span>, options.name)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.callback(<span class="literal">null</span>, result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>目前没有用到 sourceMap(必须是此模块可解析的源映射)、meta(可以是任何内容(例如一些元数据)) 这两个可选参数，只将 result 返回回去，保存重新打包后，效果和 return 是一样的</p>
<p>如果在 loader 中写异步代码，会怎么样<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options = loaderUtils.getOptions(<span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = source.replace(<span class="string">'world'</span>, options.name)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/2019/02/25/撸一个webpack-loader-plugin/4.jpg" alt=""></p>
<p>报错 loader 没有返回，这里使用 <a href="https://link.juejin.im?target=https%3A%2F%2Fwebpack.js.org%2Fapi%2Floaders%2F%23thisasync" target="_blank" rel="noopener">this.async</a> 来写异步代码<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options = loaderUtils.getOptions(<span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> callback = <span class="keyword">this</span>.async()</span><br><span class="line"></span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = source.replace(<span class="string">'world'</span>, options.name)</span><br><span class="line">    callback(<span class="literal">null</span>, result)</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>模拟一个同步 loader 和一个异步 loader</p>
<p>新建一个 <code>replaceLoaderAsync.js</code> 文件，将之前写的异步代码放入，修改 <code>replaceLoader.js</code> 为同步代码<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// replaceLoaderAsync.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>)</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options = loaderUtils.getOptions(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">const</span> callback = <span class="keyword">this</span>.async()</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = source.replace(<span class="string">'world'</span>, options.name)</span><br><span class="line">    callback(<span class="literal">null</span>, result)</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// replaceLoader.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> source.replace(<span class="string">'xh'</span>, <span class="string">'world'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>修改 <code>webpack.config.js</code>，loader 的执行顺序是从下到上，先执行异步代码，将 world 改为 xh，再执行同步代码，将 xh 改为 world<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">  rules: [</span><br><span class="line">    &#123;</span><br><span class="line">      test: <span class="regexp">/.js/</span>,</span><br><span class="line">      use: [</span><br><span class="line">        &#123;</span><br><span class="line">          loader: path.resolve(__dirname, <span class="string">'./loaders/replaceLoader.js'</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          loader: path.resolve(__dirname, <span class="string">'./loaders/replaceLoaderAsync.js'</span>),</span><br><span class="line">          options: &#123;</span><br><span class="line">            name: <span class="string">'xh'</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>保存后打包，在 mian.js 中可以看到已经改为了 <code>hello world</code>，使用多个 loader 也完成了</p>
<p>如果有多个自定义 loader，每次都通过 <code>path.resolve(__dirname, xxx)</code> 这种方式去写，有没有更好的方法？</p>
<p>使用 <code>resolveLoader</code>，定义 modules，当你使用 loader 的时候，会先去 <code>node_modules</code> 中去找，如果没找到就会去 <code>./loaders</code> 中找<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">'development'</span>,</span><br><span class="line">  entry: &#123;</span><br><span class="line">    main: <span class="string">'./src/index.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  resolveLoader: &#123;</span><br><span class="line">    modules: [<span class="string">'node_modules'</span>, <span class="string">'./loaders'</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/.js/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'replaceLoader.js'</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'replaceLoaderAsync.js'</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              name: <span class="string">'xh'</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    filename: <span class="string">'[name].js'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="编写一个-plugin"><a href="#编写一个-plugin" class="headerlink" title="编写一个 plugin"></a><a href="https://www.webpackjs.com/contribute/writing-a-plugin/" target="_blank" rel="noopener">编写一个 plugin</a></h2><p>使用阶段式的构建回调，开发者可以引入它们自己的行为到 webpack 构建流程中。<br>首先新建一个文件夹，npm 起手式操作一番，具体的在前几节已经说了，不再赘述</p>
<p>在根目录下新建 plugins 文件夹，新建 <code>copyright-webpack-plugin.js</code>，一般我们用的都是 <code>xxx-webpack-plugin</code>，所以我们命名也按这样来，plugin 的定义是一个类<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">classCopyrightWebpackPlugin&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'插件被使用了'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  apply(compiler) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = CopyrightWebpackPlugin</span><br></pre></td></tr></table></figure></p>
<p>在 webpack.config.js 中使用，所以每次使用 plugin 都要使用 <strong>new</strong>，因为本质上 plugin 是一个类<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> CopyrightWebpackPlugin = <span class="built_in">require</span>(<span class="string">'./plugins/copyright-webpack-plugin'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">'development'</span>,</span><br><span class="line">  entry: &#123;</span><br><span class="line">    main: <span class="string">'./src/index.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [<span class="keyword">new</span> CopyrightWebpackPlugin()],</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    filename: <span class="string">'[name].js'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>保存后打包，插件被使用了，只不过我们什么都没干</p>
<p><img src="/2019/02/25/撸一个webpack-loader-plugin/5.jpg" alt=""></p>
<p>如果我们要传递参数，可以这样<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> CopyrightWebpackPlugin(&#123;</span><br><span class="line">  name: <span class="string">'xh'</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>同时在 <code>copyright-webpack-plugin.js</code> 中接收<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">classCopyrightWebpackPlugin&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(options) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'插件被使用了'</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'options = '</span>, options)</span><br><span class="line">  &#125;</span><br><span class="line">  apply(compiler) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = CopyrightWebpackPlugin</span><br></pre></td></tr></table></figure></p>
<p><img src="/2019/02/25/撸一个webpack-loader-plugin/6.jpg" alt=""><br>我们先把 <strong>constructor</strong> 注释掉，在即将要把打包的结果，<strong>放入 dist 目录之前</strong>的这个时刻，我们来做一些操作</p>
<p><code>apply(compiler) {}</code> <strong>compiler 可以看作是 webpack 的实例</strong>，具体见官网 <a href="https://link.juejin.im?target=https%3A%2F%2Fwebpack.js.org%2Fapi%2Fcompiler-hooks" target="_blank" rel="noopener">compiler-hooks</a></p>
<p>hooks 是钩子，像 vue、react 的生命周期一样，找到 <code>emit</code> 这个时刻，将打包结果放入 dist 目录前执行，这里是个 <code>AsyncSeriesHook</code> 异步方法<br><img src="/2019/02/25/撸一个webpack-loader-plugin/7.jpg" alt=""><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CopyrightWebpackPlugin</span> </span>&#123;</span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    compiler.hooks.emit.tapAsync(</span><br><span class="line">      <span class="string">'CopyrightWebpackPlugin'</span>,</span><br><span class="line">      (compilation, cb) =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">11</span>)</span><br><span class="line">        cb()</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = CopyrightWebpackPlugin</span><br></pre></td></tr></table></figure></p>
<p>因为 <strong>emit</strong> 是<strong>异步</strong>的，可以通过 <strong>tapAsync</strong> 来写，当要把代码放入到 dist 目录之前，就会触发这个钩子，走到我们定义的函数里，如果你用 <strong>tapAsync</strong> 函数，记得最后要用 <strong>cb()</strong> ，tapAsync 要传递两个参数，第一个参数传递我们定义的插件名称</p>
<p>保存后再次打包，我们写的内容也输出了<br><img src="/2019/02/25/撸一个webpack-loader-plugin/8.jpg" alt=""><br><strong>compilation</strong> 这个参数里存放了这次打包的所有内容，可以输出一下 <code>compilation.assets</code> 看一下<br><img src="/2019/02/25/撸一个webpack-loader-plugin/9.jpg" alt=""><br>返回结果是一个对象，<code>main.js</code> 是 key，也就是打包后生成的文件名及文件后缀，我们可以来仿照一下<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">classCopyrightWebpackPlugin&#123;</span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    compiler.hooks.emit.tapAsync(</span><br><span class="line">      <span class="string">'CopyrightWebpackPlugin'</span>,</span><br><span class="line">      (compilation, cb) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 生成一个 copyright.txt 文件</span></span><br><span class="line">        compilation.assets[<span class="string">'copyright.txt'</span>] = &#123;</span><br><span class="line">          source: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span><span class="string">'copyright by xh'</span></span><br><span class="line">          &#125;,</span><br><span class="line">          size: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            return15<span class="comment">// 上面 source 返回的字符长度</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'compilation.assets = '</span>, compilation.assets)</span><br><span class="line">        cb()</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = CopyrightWebpackPlugin</span><br></pre></td></tr></table></figure></p>
<p><img src="/2019/02/25/撸一个webpack-loader-plugin/10.jpg" alt=""><br>在 dist 目录下生成了 <code>copyright.txt</code> 文件</p>
<p>之前介绍的是异步钩子，现在使用同步钩子<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">classCopyrightWebpackPlugin&#123;</span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line">    <span class="comment">// 同步钩子</span></span><br><span class="line">    compiler.hooks.compile.tap(<span class="string">'CopyrightWebpackPlugin'</span>, compilation =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'compile'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异步钩子</span></span><br><span class="line">    compiler.hooks.emit.tapAsync(</span><br><span class="line">      <span class="string">'CopyrightWebpackPlugin'</span>,</span><br><span class="line">      (compilation, cb) =&gt; &#123;</span><br><span class="line">        compilation.assets[<span class="string">'copyright.txt'</span>] = &#123;</span><br><span class="line">          source: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span><span class="string">'copyright by xh'</span></span><br><span class="line">          &#125;,</span><br><span class="line">          size: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            return15<span class="comment">// 字符长度</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'compilation.assets = '</span>, compilation.assets)</span><br><span class="line">        cb()</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = CopyrightWebpackPlugin</span><br></pre></td></tr></table></figure></p>
<h2 id="参考博客"><a href="#参考博客" class="headerlink" title="参考博客"></a><a href="https://itxiaohao.github.io/blog/webpack/webpack4-third.html#%E4%BA%8C%E5%8D%81%E4%BA%8C%E3%80%81%E7%BC%96%E5%86%99-loader" target="_blank" rel="noopener">参考博客</a></h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/24/Puppeteer学习/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/24/Puppeteer学习/" itemprop="url">Puppeteer学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-24T20:00:54+08:00">
                2019-02-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="撸一个node命令omiga，测试网页性能Performance-基于puppeteer"><a href="#撸一个node命令omiga，测试网页性能Performance-基于puppeteer" class="headerlink" title=" 撸一个node命令omiga，测试网页性能Performance,基于puppeteer  "></a><a href="https://github.com/libin1991/omiga" target="_blank" rel="noopener"><font color="#dd0000"> 撸一个node命令omiga，测试网页性能Performance,基于puppeteer  </font></a></h2><h2 id="Puppeteer-简介"><a href="#Puppeteer-简介" class="headerlink" title="Puppeteer 简介"></a>Puppeteer 简介</h2><p>Puppeteer 是一个node库，他提供了一组用来操纵Chrome的API, 通俗来说就是一个 headless chrome浏览器(当然你也可以配置成有UI的，默认是没有的)。既然是浏览器，那么我们手工可以在浏览器上做的事情 Puppeteer 都能胜任,另外，Puppeteer 翻译成中文是”木偶”意思，所以听名字就知道，操纵起来很方便，你可以很方便的操纵她去实现：</p>
<blockquote>
<p>1） 生成网页截图或者 PDF<br>2） 高级爬虫，可以爬取大量异步渲染内容的网页<br>3） 模拟键盘输入、表单自动提交、登录网页等，实现 UI 自动化测试<br>4） 捕获站点的时间线，以便追踪你的网站，帮助分析网站性能问题<br>5） 从网站抓取内容</p>
</blockquote>
<p>如果你用过 PhantomJS 的话，你会发现她们有点类似，但Puppeteer是Chrome官方团队进行维护的，用俗话说就是”有娘家的人“，前景更好。</p>
<h2 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h2><p>查看 Puppeteer 的官方 API 你会发现满屏的 async, await 之类，这些都是 ES7 的规范，所以你需要：</p>
<ol>
<li>Nodejs 的版本不能低于 v7.6.0, 需要支持 async, await.</li>
<li>需要最新的 chrome driver, 这个你在通过 npm 安装 Puppeteer 的时候系统会自动下载的</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm i puppeteer -D</span><br></pre></td></tr></table></figure>
<h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><p>先开看看官方的入门的 DEMO<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch();</span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">'https://www.baidu.com/'</span>);</span><br><span class="line">  <span class="keyword">await</span> page.screenshot(&#123;<span class="attr">path</span>: <span class="string">'baidu.png'</span>&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></p>
<p>上面这段代码就实现了网页截图，先大概解读一下上面几行代码：</p>
<ol>
<li>先通过 puppeteer.launch() 创建一个浏览器实例 Browser 对象</li>
<li>然后通过 Browser 对象创建页面 Page 对象</li>
<li>然后 page.goto() 跳转到指定的页面</li>
<li>调用 page.screenshot() 对页面进行截图</li>
<li>关闭浏览器</li>
</ol>
<p>是不是觉得好简单？ 反正我是觉得比 PhantomJS 简单，至于跟 selenium-webdriver 比起来，<br>那更不用说了。下面就介绍一下 puppeteer 的常用的几个 API。</p>
<h2 id="puppeteer-launch-options"><a href="#puppeteer-launch-options" class="headerlink" title="puppeteer.launch(options)"></a>puppeteer.launch(options)</h2><p>使用 puppeteer.launch() 运行 puppeteer，它会 return 一个 promise，使用 then 方法获取 browser 实例， 当然高版本的<br>的 nodejs 已经支持 await 特性了，所以上面的例子使用 await 关键字，这一点需要特殊说明一下，<strong>Puppeteer 几乎所有的操作都是<br>异步的</strong>, 为了使用大量的 then 使得代码的可读性降低，本文所有 demo 代码都是用 <strong>async, await</strong> 方式实现。这个<br>也是 Puppeteer 官方推荐的写法。 </p>
<h3 id="options-参数详解"><a href="#options-参数详解" class="headerlink" title="options 参数详解"></a>options 参数详解</h3><p><img src="/2019/02/24/Puppeteer学习/1.jpg" alt=""></p>
<h2 id="Browser-对象"><a href="#Browser-对象" class="headerlink" title="Browser 对象"></a>Browser 对象</h2><p>当 Puppeteer 连接到一个 Chrome 实例的时候就会创建一个 Browser 对象，有以下两种方式：</p>
<p>Puppeteer.launch 和 Puppeteer.connect.</p>
<p>下面这个 DEMO 实现断开连接之后重新连接浏览器实例<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"></span><br><span class="line">puppeteer.launch().then(<span class="keyword">async</span> browser =&gt; &#123;</span><br><span class="line">  <span class="comment">// 保存 Endpoint，这样就可以重新连接  Chromium</span></span><br><span class="line">  <span class="keyword">const</span> browserWSEndpoint = browser.wsEndpoint();</span><br><span class="line">  <span class="comment">// 从Chromium 断开连接</span></span><br><span class="line">  browser.disconnect();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用endpoint 重新和 Chromiunm 建立连接</span></span><br><span class="line">  <span class="keyword">const</span> browser2 = <span class="keyword">await</span> puppeteer.connect(&#123;browserWSEndpoint&#125;);</span><br><span class="line">  <span class="comment">// Close Chromium</span></span><br><span class="line">  <span class="keyword">await</span> browser2.close();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="Browser-对象-API"><a href="#Browser-对象-API" class="headerlink" title="Browser 对象 API"></a>Browser 对象 API</h3><p><img src="/2019/02/24/Puppeteer学习/2.png" alt=""></p>
<h2 id="Puppeteer-实战"><a href="#Puppeteer-实战" class="headerlink" title="Puppeteer 实战"></a>Puppeteer 实战</h2><p>了解 API 之后我们就可以来一些实战了，在此之前，我们先了解一下 Puppeteer 的设计原理，简单来说 Puppeteer 跟 webdriver 以及 PhantomJS 最大的<br>的不同就是它是站在用户浏览的角度，而 webdriver 和 PhantomJS 最初设计就是用来做自动化测试的，所以它是站在机器浏览的角度来设计的，所以它们<br>使用的是不同的设计哲学。举个栗子，加入我需要打开京东的首页并进行一次产品搜索，分别看看使用 Puppeteer 和 webdriver 的实现流程：</p>
<p><strong>Puppeteer 的实现流程：</strong></p>
<ol>
<li>打开京东首页</li>
<li>将光标 focus 到搜索输入框</li>
<li>键盘点击输入文字</li>
<li>点击搜索按钮</li>
</ol>
<p><strong>webdriver 的实现流程：</strong></p>
<ol>
<li>打开京东首页</li>
<li>找到输入框的 input 元素</li>
<li>设置 input 的值为要搜索文字</li>
<li>触发搜索按钮的单机事件</li>
</ol>
<p>个人感觉 Puppeteer 设计哲学更符合任何的操作习惯，更自然一些。</p>
<p>下面我们就用一个简单的需求实现来进行 Puppeteer 的入门学习。这个简单的需求就是：</p>
<blockquote>
<p>在京东商城抓取10个手机商品，并把商品的详情页截图。</p>
</blockquote>
<p>首先我们来梳理一下操作流程</p>
<ol>
<li>打开京东首页</li>
<li>输入“手机”关键字并搜索</li>
<li>获取前10个商品的 A 标签，并获取 href 属性值，获取商品详情链接</li>
<li>分别打开10个商品的详情页，截取网页图片</li>
</ol>
<p>要实现上面的功能需要用到查找元素，获取属性，键盘事件等，那接下来我们就一个一个的讲解一下。</p>
<h3 id="获取元素"><a href="#获取元素" class="headerlink" title="获取元素"></a>获取元素</h3><p>Page 对象提供了2个 API 来获取页面元素</p>
<p>(1). Page.$(selector) 获取单个元素，底层是调用的是 document.querySelector() , 所以选择器的 selector 格式遵循 <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Selectors" target="_blank" rel="noopener">css 选择器规范</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> inputElement = <span class="keyword">await</span> page.$(<span class="string">"#search"</span>, input =&gt; input);</span><br><span class="line"><span class="comment">//下面写法等价</span></span><br><span class="line"><span class="keyword">let</span> inputElement = <span class="keyword">await</span> page.$(<span class="string">'#search'</span>);</span><br></pre></td></tr></table></figure>
<p>(2). Page.$$(selector) 获取一组元素，底层调用的是 document.querySelectorAll(). 返回 Promise(Array(ElemetHandle)) 元素数组.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> links = <span class="keyword">await</span> page.$$(<span class="string">"a"</span>);</span><br><span class="line"><span class="comment">//下面写法等价</span></span><br><span class="line"><span class="keyword">const</span> links = <span class="keyword">await</span> page.$$(<span class="string">"a"</span>, links =&gt; links);</span><br></pre></td></tr></table></figure>
<p>最终返回的都是 ElemetHandle 对象</p>
<h3 id="获取元素属性"><a href="#获取元素属性" class="headerlink" title="获取元素属性"></a>获取元素属性</h3><p>Puppeteer 获取元素属性跟我们平时写前段的js的逻辑有点不一样，按照通常的逻辑，应该是现获取元素，然后在获取元素的属性。但是上面我们知道<br>获取元素的 API 最终返回的都是 ElemetHandle 对象，而你去查看 ElemetHandle 的 API 你会发现，它并没有获取元素属性的 API.</p>
<p>事实上 Puppeteer 专门提供了一套获取属性的 API， Page.$eval() 和 Page.$$eval()</p>
<p>(1). Page.$$eval(selector, pageFunction[, …args]), 获取单个元素的属性，这里的选择器 selector 跟上面 Page.$(selector) 是一样的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> value = <span class="keyword">await</span> page.$<span class="built_in">eval</span>(<span class="string">'input[name=search]'</span>, input =&gt; input.value);</span><br><span class="line"><span class="keyword">const</span> href = <span class="keyword">await</span> page.$<span class="built_in">eval</span>(<span class="string">'#a", ele =&gt; ele.href);</span></span><br><span class="line"><span class="string">const content = await page.$eval('</span>.content<span class="string">', ele =&gt; ele.outerHTML);</span></span><br></pre></td></tr></table></figure>
<h3 id="执行自定义的-JS-脚本"><a href="#执行自定义的-JS-脚本" class="headerlink" title="执行自定义的 JS 脚本"></a>执行自定义的 JS 脚本</h3><p>Puppeteer 的 Page 对象提供了一系列 evaluate 方法，你可以通过他们来执行一些自定义的 js 代码，主要提供了下面三个 API</p>
<blockquote>
<p>(1). page.evaluate(pageFunction, …args) 返回一个可序列化的普通对象，pageFunction 表示要在页面执行的函数，<br>args 表示传入给 pageFunction 的参数， 下面的 pageFunction 和 args 表示同样的意思。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> page.evaluate(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(<span class="number">8</span> * <span class="number">7</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(result); <span class="comment">// prints "56"</span></span><br></pre></td></tr></table></figure>
<p>这个方法很有用，比如我们在获取页面的截图的时候，默认是只截图当前浏览器窗口的尺寸大小，默认值是800x600，那如果我们需要获取整个网页的完整<br>截图是没办法办到的。Page.screenshot() 方法提供了可以设置截图区域大小的参数，那么我们只要在页面加载完了之后获取页面的宽度和高度就可以解决<br>这个问题了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">	<span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123;<span class="attr">headless</span>:<span class="literal">true</span>&#125;);</span><br><span class="line">	<span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">	<span class="keyword">await</span> page.goto(<span class="string">'https://jr.dayi35.com'</span>);</span><br><span class="line">	<span class="keyword">await</span> page.setViewport(&#123;<span class="attr">width</span>:<span class="number">1920</span>, <span class="attr">height</span>:<span class="number">1080</span>&#125;);</span><br><span class="line">	<span class="keyword">const</span> documentSize = <span class="keyword">await</span> page.evaluate(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &#123;</span><br><span class="line">			width: <span class="built_in">document</span>.documentElement.clientWidth,</span><br><span class="line">			height : <span class="built_in">document</span>.body.clientHeight,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">await</span> page.screenshot(&#123;<span class="attr">path</span>:<span class="string">"example.png"</span>, <span class="attr">clip</span> : &#123;<span class="attr">x</span>:<span class="number">0</span>, <span class="attr">y</span>:<span class="number">0</span>, <span class="attr">width</span>:<span class="number">1920</span>, <span class="attr">height</span>:documentSize.height&#125;&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>(2). Page.evaluateHandle(pageFunction, …args) 在 Page 上下文执行一个 pageFunction, 返回 JSHandle 实体</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> aWindowHandle = <span class="keyword">await</span> page.evaluateHandle(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">Promise</span>.resolve(<span class="built_in">window</span>));</span><br><span class="line">aWindowHandle; <span class="comment">// Handle for the window object. </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> aHandle = <span class="keyword">await</span> page.evaluateHandle(<span class="string">'document'</span>); <span class="comment">// Handle for the 'document'.</span></span><br></pre></td></tr></table></figure>
<p>从上面的代码可以看出，page.evaluateHandle() 方法也是通过 Promise.resolve 方法直接把 Promise 的最终处理结果返回，<br>只不过把最后返回的对象封装成了 JSHandle 对象。本质上跟 evaluate 没有什么区别。</p>
<p>下面这段代码实现获取页面的动态（包括js动态插入的元素） HTML 代码.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> aHandle = <span class="keyword">await</span> page.evaluateHandle(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">document</span>.body);</span><br><span class="line"><span class="keyword">const</span> resultHandle = <span class="keyword">await</span> page.evaluateHandle(<span class="function"><span class="params">body</span> =&gt;</span> body.innerHTML, aHandle);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">await</span> resultHandle.jsonValue());</span><br><span class="line"><span class="keyword">await</span> resultHandle.dispose();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>(3). page.evaluateOnNewDocument(pageFunction, …args), 在文档页面载入前调用 pageFunction, 如果页面中有 iframe 或者 frame, 则函数调用<br>的上下文环境将变成子页面的，即iframe 或者 frame, 由于是在页面加载前调用，这个函数一般是用来初始化 javascript 环境的，比如重置或者<br>初始化一些全局变量。</p>
</blockquote>
<h3 id="Page-exposeFunction"><a href="#Page-exposeFunction" class="headerlink" title="Page.exposeFunction"></a>Page.exposeFunction</h3><p>除此上面三个 API 之外，还有一类似的非常有用的 API， 那就是 <strong>Page.exposeFunction</strong>，这个 API 用来在页面注册全局函数，非常有用：</p>
<p>因为有时候需要在页面处理一些操作的时候需要用到一些函数，虽然可以通过 Page.evaluate() API 在页面定义函数，比如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> docSize = <span class="keyword">await</span> page.evaluate(<span class="function"><span class="params">()</span>=&gt;</span> &#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getPageSize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> &#123;</span><br><span class="line">			width: <span class="built_in">document</span>.documentElement.clientWidth,</span><br><span class="line">			height : <span class="built_in">document</span>.body.clientHeight,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> getPageSize();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>但是这样的函数不是全局的，需要在每个 evaluate 中去重新定义，无法做到代码复用，在一个就是 nodejs 有很多工具包可以很轻松的实现很复杂的功能<br>比如要实现 md5 加密函数，这个用纯 js 去实现就不太方便了，而用 nodejs 却是几行代码的事情。</p>
<p>下面代码实现给 Page 上下文的 window 对象添加 md5 函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"></span><br><span class="line">puppeteer.launch().then(<span class="keyword">async</span> browser =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">  page.on(<span class="string">'console'</span>, msg =&gt; <span class="built_in">console</span>.log(msg.text));</span><br><span class="line">  <span class="keyword">await</span> page.exposeFunction(<span class="string">'md5'</span>, text =&gt;</span><br><span class="line">    crypto.createHash(<span class="string">'md5'</span>).update(text).digest(<span class="string">'hex'</span>)</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">await</span> page.evaluate(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// use window.md5 to compute hashes</span></span><br><span class="line">    <span class="keyword">const</span> myString = <span class="string">'PUPPETEER'</span>;</span><br><span class="line">    <span class="keyword">const</span> myHash = <span class="keyword">await</span> <span class="built_in">window</span>.md5(myString);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`md5 of <span class="subst">$&#123;myString&#125;</span> is <span class="subst">$&#123;myHash&#125;</span>`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>可以看出，Page.exposeFunction API 使用起来是很方便的，也非常有用，在比如给 window 对象注册 readfile 全局函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">puppeteer.launch().then(<span class="keyword">async</span> browser =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">  page.on(<span class="string">'console'</span>, msg =&gt; <span class="built_in">console</span>.log(msg.text));</span><br><span class="line">  <span class="keyword">await</span> page.exposeFunction(<span class="string">'readfile'</span>, <span class="keyword">async</span> filePath =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      fs.readFile(filePath, <span class="string">'utf8'</span>, (err, text) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (err)</span><br><span class="line">          reject(err);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          resolve(text);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">await</span> page.evaluate(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// use window.readfile to read contents of a file</span></span><br><span class="line">    <span class="keyword">const</span> content = <span class="keyword">await</span> <span class="built_in">window</span>.readfile(<span class="string">'/etc/hosts'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(content);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Page-emulate-修改模拟器-客户端-运行配置"><a href="#Page-emulate-修改模拟器-客户端-运行配置" class="headerlink" title="Page.emulate 修改模拟器(客户端)运行配置"></a>Page.emulate 修改模拟器(客户端)运行配置</h2><p>Puppeteer 提供了一些 API 供我们修改浏览器终端的配置</p>
<ol>
<li>Page.setViewport() 修改浏览器视窗大小</li>
<li>Page.setUserAgent() 设置浏览器的 UserAgent 信息</li>
<li>Page.emulateMedia() 更改页面的CSS媒体类型，用于进行模拟媒体仿真。可选值为 “screen”, “print”, “null”, 如果设置为 null 则表示禁用媒体仿真。</li>
<li>Page.emulate() 模拟设备，参数设备对象，比如 iPhone, Mac, Android 等</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">page.setViewport(&#123;<span class="attr">width</span>:<span class="number">1920</span>, <span class="attr">height</span>:<span class="number">1080</span>&#125;); <span class="comment">//设置视窗大小为 1920x1080</span></span><br><span class="line">page.setUserAgent(<span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.90 Safari/537.36'</span>);</span><br><span class="line">page.emulateMedia(<span class="string">'print'</span>); <span class="comment">//设置打印机媒体样式</span></span><br></pre></td></tr></table></figure>
<p>除此之外我们还可以模拟非 PC 机设备, 比如下面这段代码模拟 iPhone 6 访问google：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"><span class="keyword">const</span> devices = <span class="built_in">require</span>(<span class="string">'puppeteer/DeviceDescriptors'</span>);</span><br><span class="line"><span class="keyword">const</span> iPhone = devices[<span class="string">'iPhone 6'</span>];</span><br><span class="line"></span><br><span class="line">puppeteer.launch().then(<span class="keyword">async</span> browser =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">  <span class="keyword">await</span> page.emulate(iPhone);</span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">'https://www.google.com'</span>);</span><br><span class="line">  <span class="comment">// other actions...</span></span><br><span class="line">  <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Puppeteer 支持很多设备模拟仿真，比如Galaxy, iPhone, IPad 等，想要知道详细设备支持，请戳这里 <a href="https://github.com/GoogleChrome/puppeteer/blob/master/DeviceDescriptors.js" target="_blank" rel="noopener">DeviceDescriptors.js.</a></p>
<h2 id="键盘和鼠标"><a href="#键盘和鼠标" class="headerlink" title="键盘和鼠标"></a>键盘和鼠标</h2><p>键盘和鼠标的API比较简单，键盘的几个API如下：</p>
<ul>
<li>keyboard.down(key[, options]) 触发 keydown 事件</li>
<li>keyboard.press(key[, options]) 按下某个键，key 表示键的名称，比如 ‘ArrowLeft’ 向左键，详细的键名映射请<a href="https://github.com/GoogleChrome/puppeteer/blob/master/lib/USKeyboardLayout.js" target="_blank" rel="noopener">戳这里</a></li>
<li>keyboard.sendCharacter(char) 输入一个字符</li>
<li>keyboard.type(text, options) 输入一个字符串</li>
<li>keyboard.up(key) 触发 keyup 事件</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">page.keyboard.press(<span class="string">"Shift"</span>); <span class="comment">//按下 Shift 键</span></span><br><span class="line">page.keyboard.sendCharacter(<span class="string">'嗨'</span>);</span><br><span class="line">page.keyboard.type(<span class="string">'Hello'</span>); <span class="comment">// 一次输入完成</span></span><br><span class="line">page.keyboard.type(<span class="string">'World'</span>, &#123;<span class="attr">delay</span>: <span class="number">100</span>&#125;); <span class="comment">// 像用户一样慢慢输入</span></span><br></pre></td></tr></table></figure>
<p>鼠标操作:</p>
<ul>
<li>mouse.click(x, y, [options]) 移动鼠标指针到指定的位置，然后按下鼠标，这个其实 mouse.move 和 mouse.down 或 mouse.up 的快捷操作</li>
<li>mouse.down([options]) 触发 mousedown 事件，options 可配置:<ul>
<li>options.button 按下了哪个键，可选值为[left, right, middle], 默认是 left, 表示鼠标左键</li>
<li>options.clickCount 按下的次数，单击，双击或者其他次数</li>
<li>delay 按键延时时间</li>
</ul>
</li>
<li>mouse.move(x, y, [options]) 移动鼠标到指定位置， options.steps 表示移动的步长</li>
<li>mouse.up([options]) 触发 mouseup 事件</li>
</ul>
<h2 id="另外几个有用的-API"><a href="#另外几个有用的-API" class="headerlink" title="另外几个有用的 API"></a>另外几个有用的 API</h2><p>Puppeteer 还提供几个非常有用的 API， 比如：</p>
<h3 id="Page-waitFor-系列-API"><a href="#Page-waitFor-系列-API" class="headerlink" title="Page.waitFor 系列 API"></a>Page.waitFor 系列 API</h3><ul>
<li>page.waitFor(selectorOrFunctionOrTimeout[, options[, …args]]) 下面三个的综合 API</li>
<li>page.waitForFunction(pageFunction[, options[, …args]]) 等待 pageFunction 执行完成之后</li>
<li>page.waitForNavigation(options) 等待页面基本元素加载完之后，比如同步的 HTML, CSS, JS 等代码</li>
<li>page.waitForSelector(selector[, options]) 等待某个选择器的元素加载之后，这个元素可以是异步加载的，这个 API 非常有用，你懂的。</li>
</ul>
<p>比如我想获取某个通过 js 异步加载的元素，那么直接获取肯定是获取不到的。这个时候就可以使用 page.waitForSelector 来解决：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.waitForSelector(<span class="string">'.gl-item'</span>); <span class="comment">//等待元素加载之后，否则获取不到异步加载的元素</span></span><br><span class="line"><span class="keyword">const</span> links = <span class="keyword">await</span> page.$$<span class="built_in">eval</span>(<span class="string">'.gl-item &gt; .gl-i-wrap &gt; .p-img &gt; a'</span>, links =&gt; &#123;</span><br><span class="line">	<span class="keyword">return</span> links.map(<span class="function"><span class="params">a</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &#123;</span><br><span class="line">			href: a.href.trim(),</span><br><span class="line">			name: a.title</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>其实上面的代码就可以解决我们最上面的需求，抓取京东的产品，因为是异步加载的，所以使用这种方式。</p>
<h3 id="page-getMetrics"><a href="#page-getMetrics" class="headerlink" title="page.getMetrics()"></a>page.getMetrics()</h3><p>通过 page.getMetrics() 可以得到一些页面性能数据， 捕获网站的时间线跟踪，以帮助诊断性能问题。</p>
<ul>
<li>Timestamp 度量标准采样的时间戳</li>
<li>Documents 页面文档数</li>
<li>Frames 页面 frame 数</li>
<li>JSEventListeners 页面内事件监听器数</li>
<li>Nodes 页面 DOM 节点数</li>
<li>LayoutCount 页面布局总数</li>
<li>RecalcStyleCount 样式重算数</li>
<li>LayoutDuration 所有页面布局的合并持续时间</li>
<li>RecalcStyleDuration 所有页面样式重新计算的组合持续时间。</li>
<li>ScriptDuration 所有脚本执行的持续时间</li>
<li>TaskDuration 所有浏览器任务时长</li>
<li>JSHeapUsedSize JavaScript 占用堆大小</li>
<li>JSHeapTotalSize JavaScript 堆总量</li>
</ul>
<h2 id="总结和源码"><a href="#总结和源码" class="headerlink" title="总结和源码"></a>总结和源码</h2><p>本文通过一个实际需求来学习了 Puppeteer 的一些基本的常用的 API， API 的版本是 v0.13.0-alpha. 最新邦本的 API 请参考<br><a href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md" target="_blank" rel="noopener">Puppeteer 官方API</a>.</p>
<p>总的来说，Puppeteer 真是一款不错的 headless 工具，操作简单，功能强大。用来做UI自动化测试，和一些小工具都是很不错的。</p>
<p>下面贴上我们开始的需求实现源码，仅供参考：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//延时函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params">delay</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">		setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				resolve(<span class="number">1</span>)</span><br><span class="line">			&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">				reject(<span class="number">0</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;, delay)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line">puppeteer.launch(&#123;</span><br><span class="line">	ignoreHTTPSErrors:<span class="literal">true</span>, </span><br><span class="line">	headless:<span class="literal">false</span>,<span class="attr">slowMo</span>:<span class="number">250</span>, </span><br><span class="line">	timeout:<span class="number">0</span>&#125;).then(<span class="keyword">async</span> browser =&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">let</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">	<span class="keyword">await</span> page.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">	<span class="keyword">await</span> page.goto(<span class="string">"https://www.jd.com/"</span>);</span><br><span class="line">	<span class="keyword">const</span> searchInput = <span class="keyword">await</span> page.$(<span class="string">"#key"</span>);</span><br><span class="line">	<span class="keyword">await</span> searchInput.focus(); <span class="comment">//定位到搜索框</span></span><br><span class="line">	<span class="keyword">await</span> page.keyboard.type(<span class="string">"手机"</span>);</span><br><span class="line">	<span class="keyword">const</span> searchBtn = <span class="keyword">await</span> page.$(<span class="string">".button"</span>);</span><br><span class="line">	<span class="keyword">await</span> searchBtn.click();</span><br><span class="line">	<span class="keyword">await</span> page.waitForSelector(<span class="string">'.gl-item'</span>); <span class="comment">//等待元素加载之后，否则获取不异步加载的元素</span></span><br><span class="line">	<span class="keyword">const</span> links = <span class="keyword">await</span> page.$$<span class="built_in">eval</span>(<span class="string">'.gl-item &gt; .gl-i-wrap &gt; .p-img &gt; a'</span>, links =&gt; &#123;</span><br><span class="line">		<span class="keyword">return</span> links.map(<span class="function"><span class="params">a</span> =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> &#123;</span><br><span class="line">				href: a.href.trim(),</span><br><span class="line">				title: a.title</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line">	page.close();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> aTags = links.splice(<span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; aTags.length; i++) &#123;</span><br><span class="line">		page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">		page.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">		<span class="keyword">await</span> page.setViewport(&#123;<span class="attr">width</span>:<span class="number">1920</span>, <span class="attr">height</span>:<span class="number">1080</span>&#125;);</span><br><span class="line">		<span class="keyword">var</span> a = aTags[i];</span><br><span class="line">		<span class="keyword">await</span> page.goto(a.href, &#123;<span class="attr">timeout</span>:<span class="number">0</span>&#125;); <span class="comment">//防止页面太长，加载超时</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//注入代码，慢慢把滚动条滑到最底部，保证所有的元素被全部加载</span></span><br><span class="line">		<span class="keyword">let</span> scrollEnable = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">let</span> scrollStep = <span class="number">500</span>; <span class="comment">//每次滚动的步长</span></span><br><span class="line">		<span class="keyword">while</span> (scrollEnable) &#123;</span><br><span class="line">			scrollEnable = <span class="keyword">await</span> page.evaluate(<span class="function">(<span class="params">scrollStep</span>) =&gt;</span> &#123;</span><br><span class="line">				<span class="keyword">let</span> scrollTop = <span class="built_in">document</span>.scrollingElement.scrollTop;</span><br><span class="line">				<span class="built_in">document</span>.scrollingElement.scrollTop = scrollTop + scrollStep;</span><br><span class="line">				<span class="keyword">return</span> <span class="built_in">document</span>.body.clientHeight &gt; scrollTop + <span class="number">1080</span> ? <span class="literal">true</span> : <span class="literal">false</span></span><br><span class="line">			&#125;, scrollStep);</span><br><span class="line">			<span class="keyword">await</span> sleep(<span class="number">100</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">await</span> page.waitForSelector(<span class="string">"#footer-2014"</span>, &#123;<span class="attr">timeout</span>:<span class="number">0</span>&#125;); <span class="comment">//判断是否到达底部了</span></span><br><span class="line">		<span class="keyword">let</span> filename = <span class="string">"images/items-"</span>+i+<span class="string">".png"</span>;</span><br><span class="line">		<span class="comment">//这里有个Puppeteer的bug一直没有解决，发现截图的高度最大只能是16384px， 超出部分被截掉了。</span></span><br><span class="line">		<span class="keyword">await</span> page.screenshot(&#123;<span class="attr">path</span>:filename, <span class="attr">fullPage</span>:<span class="literal">true</span>&#125;);</span><br><span class="line">		page.close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	browser.close();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="测试网页性能performance"><a href="#测试网页性能performance" class="headerlink" title="测试网页性能performance"></a>测试网页性能performance</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);　</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"></span><br><span class="line">　</span><br><span class="line"><span class="comment">//(async() =&gt; &#123;　　</span></span><br><span class="line"><span class="comment">//	const browser = await puppeteer.launch(&#123; headless: true &#125;);　　</span></span><br><span class="line"><span class="comment">//	const page = await browser.newPage();　　</span></span><br><span class="line"><span class="comment">//	await page.setViewport(&#123; width: 2000, height: 800, &#125;);   //修改浏览器视窗大小</span></span><br><span class="line"><span class="comment">//	await page.goto('https://www.baidu.com/');</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	await page.focus("#kw");</span></span><br><span class="line"><span class="comment">//  await page.keyboard.sendCharacter('123');</span></span><br><span class="line"><span class="comment">//  await page.waitFor(".s_search");</span></span><br><span class="line"><span class="comment">//  await page.click(".s_search");</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	console.log('123');</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	page.on("load", async () =&gt; &#123;</span></span><br><span class="line"><span class="comment">//		const performanceTiming = JSON.parse(　　</span></span><br><span class="line"><span class="comment">//			await page.evaluate(() =&gt; JSON.stringify(window.peformance.timing))　　</span></span><br><span class="line"><span class="comment">//		);　　</span></span><br><span class="line"><span class="comment">//		console.log(performanceTiming);</span></span><br><span class="line"><span class="comment">//		 </span></span><br><span class="line"><span class="comment">//	&#125;);</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	page.on('pageCreated', async (page) =&gt; &#123;</span></span><br><span class="line"><span class="comment">//		</span></span><br><span class="line"><span class="comment">//		console.log('pageCreated')</span></span><br><span class="line"><span class="comment">//		</span></span><br><span class="line"><span class="comment">//       const performanceTiming = JSON.parse(　　</span></span><br><span class="line"><span class="comment">//			await page.evaluate(() =&gt; JSON.stringify(window.peformance.timing))　　</span></span><br><span class="line"><span class="comment">//		);　　</span></span><br><span class="line"><span class="comment">//		console.log(performanceTiming);</span></span><br><span class="line"><span class="comment">//  &#125;);</span></span><br><span class="line"><span class="comment">//  page.on('perf',async (page) =&gt;   &#123;</span></span><br><span class="line"><span class="comment">//  	</span></span><br><span class="line"><span class="comment">//  	console.log('perf')</span></span><br><span class="line"><span class="comment">//  	</span></span><br><span class="line"><span class="comment">//      const performanceTiming = JSON.parse(　　</span></span><br><span class="line"><span class="comment">//			await page.evaluate(() =&gt; JSON.stringify(window.peformance.timing))　　</span></span><br><span class="line"><span class="comment">//		);　　</span></span><br><span class="line"><span class="comment">//		console.log(performanceTiming);</span></span><br><span class="line"><span class="comment">//  &#125;);</span></span><br><span class="line"><span class="comment">//  page.on('metrics',async (page) =&gt;   &#123;</span></span><br><span class="line"><span class="comment">//  	</span></span><br><span class="line"><span class="comment">//  	console.log('metrics')</span></span><br><span class="line"><span class="comment">//  	</span></span><br><span class="line"><span class="comment">//      const performanceTiming = JSON.parse(　　</span></span><br><span class="line"><span class="comment">//			await page.evaluate(() =&gt; JSON.stringify(window.peformance.timing))　　</span></span><br><span class="line"><span class="comment">//		);　　</span></span><br><span class="line"><span class="comment">//		console.log(performanceTiming);</span></span><br><span class="line"><span class="comment">//  &#125;);　　　　</span></span><br><span class="line"><span class="comment">//&#125;)();</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> extractDataFromPerformanceTiming = <span class="function">(<span class="params">timing, ...dataNames</span>) =&gt;</span> &#123;　　</span><br><span class="line">	<span class="keyword">const</span> navigationStart = timing.navigationStart;　　</span><br><span class="line">	<span class="keyword">const</span> extractedData = &#123;&#125;;　　</span><br><span class="line">	dataNames.forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;　　</span><br><span class="line">		extractedData[name] = timing[name] - navigationStart;　　</span><br><span class="line">	&#125;);　　</span><br><span class="line">	<span class="keyword">return</span> extractedData;　　</span><br><span class="line">&#125;;　　</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">testPage</span>(<span class="params">page</span>) </span>&#123;　　</span><br><span class="line">	<span class="keyword">await</span> page.goto(<span class="string">"https://www.cnblogs.com"</span>);　</span><br><span class="line">	<span class="keyword">const</span> performanceTiming = <span class="built_in">JSON</span>.parse(<span class="keyword">await</span> page.evaluate(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">JSON</span>.stringify(<span class="built_in">window</span>.performance.timing)));　　</span><br><span class="line">	<span class="keyword">return</span> extractDataFromPerformanceTiming(</span><br><span class="line">		performanceTiming,</span><br><span class="line">		<span class="string">'domainLookupStart'</span>, <span class="comment">// dns开始</span></span><br><span class="line">		<span class="string">'domainLookupEnd'</span>, <span class="comment">// dns结束</span></span><br><span class="line">		<span class="string">'connectStart'</span>, <span class="comment">// tcp开始</span></span><br><span class="line">		<span class="string">'connectEnd'</span>, <span class="comment">// tcp结束</span></span><br><span class="line">		<span class="string">'responseStart'</span>, <span class="comment">// ttfb，time to first byte，首字节抵达</span></span><br><span class="line">		<span class="string">'responseEnd'</span>, <span class="comment">// 最后一个字节抵达</span></span><br><span class="line">		<span class="string">'domLoading'</span>, <span class="comment">// dom 开始解析，即Document.readyState属性变为“loading”、相应的readystatechange事件触发</span></span><br><span class="line">		<span class="string">'domInteractive'</span>, <span class="comment">// 文档完成解析，但是诸如图像，样式表和框架之类的子资源仍在加载。即Document.readyState属性变为“interactive”、相应的readystatechange事件触发</span></span><br><span class="line">		<span class="string">'domContentLoadedEventStart'</span>, <span class="comment">// DOMContentLoaded 事件触发，即所有需要被执行的脚本已经被解析</span></span><br><span class="line">		<span class="string">'domContentLoadedEventEnd'</span>, <span class="comment">// 所有需要立即执行的脚本已经被执行</span></span><br><span class="line">		<span class="string">'domComplete'</span>, <span class="comment">// 文档和所有子资源已完成加载，即Document.readyState变为 'complete'且相对应的readystatechange 被触发，load 事件即将被触发</span></span><br><span class="line">		<span class="string">'loadEventStart'</span>, <span class="comment">// 文档触发load事件的时间。如果load事件没有触发，那么该接口就返回0</span></span><br><span class="line">		<span class="string">'loadEventEnd'</span> <span class="comment">// 文档触发load事件结束后的时间。如果load事件没有触发，那么该接口就返回0</span></span><br><span class="line">	);　　</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRequestCount</span>(<span class="params">page</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">const</span> res = &#123;</span><br><span class="line">		post: <span class="number">0</span>,</span><br><span class="line">		get: <span class="number">0</span>,</span><br><span class="line">		js: <span class="number">0</span>,</span><br><span class="line">		css: <span class="number">0</span></span><br><span class="line">	&#125;;</span><br><span class="line">	page.on(<span class="string">'request'</span>, request =&gt; &#123;</span><br><span class="line">		<span class="keyword">const</span> method = request.method();</span><br><span class="line">		<span class="keyword">const</span> pathname = url.parse(request.url()).pathname;</span><br><span class="line">		<span class="keyword">if</span>(method === <span class="string">'GET'</span>) &#123;</span><br><span class="line">			res.get++;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span>(method === <span class="string">'POST'</span>) &#123;</span><br><span class="line">			res.post++;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(pathname.endsWith(<span class="string">'.js'</span>)) &#123;</span><br><span class="line">			res.js++;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span>(pathname.endsWith(<span class="string">'.css'</span>)) &#123;</span><br><span class="line">			res.css++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">		page.on(<span class="string">'load'</span>, () =&gt; &#123;</span><br><span class="line">			resolve(res);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span>() =&gt; &#123;　　</span><br><span class="line">	<span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch();　　</span><br><span class="line">	<span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> res = &#123;</span><br><span class="line">		post: <span class="number">0</span>,</span><br><span class="line">		get: <span class="number">0</span>,</span><br><span class="line">		js: <span class="number">0</span>,</span><br><span class="line">		css: <span class="number">0</span></span><br><span class="line">	&#125;;</span><br><span class="line">	</span><br><span class="line"><span class="comment">//	page.on('load',async () =&gt; &#123;</span></span><br><span class="line"><span class="comment">//		console.log("222222")</span></span><br><span class="line"><span class="comment">//		console.log(res)</span></span><br><span class="line"><span class="comment">//		</span></span><br><span class="line"><span class="comment">//		//await browser.close();</span></span><br><span class="line"><span class="comment">//	&#125;);</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	page.on('request', request =&gt; &#123;</span></span><br><span class="line"><span class="comment">//		console.log("1111")</span></span><br><span class="line"><span class="comment">//		const method = request.method();</span></span><br><span class="line"><span class="comment">//		const pathname = url.parse(request.url()).pathname;</span></span><br><span class="line"><span class="comment">//		if(method === 'GET') &#123;</span></span><br><span class="line"><span class="comment">//			res.get++;</span></span><br><span class="line"><span class="comment">//		&#125; else if(method === 'POST') &#123;</span></span><br><span class="line"><span class="comment">//			res.post++;</span></span><br><span class="line"><span class="comment">//		&#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//		if(pathname.endsWith('.js')) &#123;</span></span><br><span class="line"><span class="comment">//			res.js++;</span></span><br><span class="line"><span class="comment">//		&#125; else if(pathname.endsWith('.css')) &#123;</span></span><br><span class="line"><span class="comment">//			res.css++;</span></span><br><span class="line"><span class="comment">//		&#125;</span></span><br><span class="line"><span class="comment">//	&#125;);</span></span><br><span class="line">	</span><br><span class="line">	　　</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="keyword">await</span> testPage(page));</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="keyword">await</span> getRequestCount(page));</span><br><span class="line">	<span class="keyword">await</span> browser.close();　　</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/18/用keep-alive优化页面性能/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/18/用keep-alive优化页面性能/" itemprop="url">用keep-alive优化页面性能</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-18T21:35:00+08:00">
                2019-02-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="keep-alive"><a href="#keep-alive" class="headerlink" title="keep-alive"></a>keep-alive</h2><p>keep-alive是Vue提供的一个抽象组件，用来对组件进行缓存，从而节省性能，由于是一个抽象组件，所以在v页面渲染完毕后不会被渲染成一个DOM元素<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//keep-alive 用来缓存组件,避免多次加载相应的组件,减少性能消耗</span></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=<span class="string">"app"</span>&gt;</span><br><span class="line">    &lt;keep-alive&gt;</span><br><span class="line">      &lt;router-view&gt;<span class="xml"><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li><p><code>&lt;keep-alive&gt;</code>包裹动态组件时，会缓存不活动的组件实例，而不是销毁它们。和 <transition> 相似，<keep-alive> 是一个抽象组件：它自身不会渲染一个 DOM 元素，也不会出现在父组件链中。</keep-alive></transition></p>
</li>
<li><p>keep-alive内被切换时组件的activated、deactivated这两个生命周期钩子函数会被执行</p>
</li>
<li>被包裹在keep-alive中的组件的状态将会被保留，例如我们将某个列表类组件内容滑动到第10条位置，那么我们在切换到一个组件后再次切换回到该组件，该组件的位置状态依旧会保持在第10条列表处.</li>
</ul>
<p>我们在创建一个router实例的时候，可以提供一个scrollBehavior方法，该方法会在用户切换路由时触发<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router=<span class="keyword">new</span> VueRouter(&#123;</span><br><span class="line">        routes:[</span><br><span class="line">            &#123;</span><br><span class="line">                path:<span class="string">"/"</span>,</span><br><span class="line">                component:Home</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        scrollBehavior(to,form,savedPosition)&#123;</span><br><span class="line">        <span class="comment">//scrollBehavior方法接收to，form路由对象</span></span><br><span class="line">        <span class="comment">//第三个参数savedPosition当且仅当在浏览器前进后退按钮触发时才可用</span></span><br><span class="line">        <span class="comment">//该方法会返回滚动位置的对象信息，如果返回false，或者是一个空的对象，那么不会发生滚动</span></span><br><span class="line">        <span class="comment">//我们可以在该方法中设置返回值来指定页面的滚动位置，例如：</span></span><br><span class="line">         <span class="keyword">return</span> &#123;<span class="attr">x</span>:<span class="number">0</span>,<span class="attr">y</span>:<span class="number">0</span>&#125;</span><br><span class="line">        <span class="comment">//表示在用户切换路由时让是所有页面都返回到顶部位置</span></span><br><span class="line">        <span class="comment">//如果返回savedPosition,那么在点击后退按钮时就会表现的像原生浏览器一样，返回的页面会滚动过到之前按钮点击跳转的位置，大概写法如下：</span></span><br><span class="line">         <span class="keyword">if</span>(savedPosition)&#123;</span><br><span class="line">            <span class="keyword">return</span> savedPosition</span><br><span class="line">         &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           <span class="keyword">return</span> &#123;<span class="attr">x</span>:<span class="number">0</span>,<span class="attr">y</span>:<span class="number">0</span>&#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">//如果想要模拟滚动到锚点的行为:</span></span><br><span class="line">         <span class="keyword">if</span>(to.hash)&#123;</span><br><span class="line">           <span class="keyword">return</span> &#123;</span><br><span class="line">             selector:to.hash</span><br><span class="line">           &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>还有一个方法就是利用我们上面说过的，在keep-alive激活会触发activated钩子函数，那么在该函数内设置scrollTop为0<br>被keep-alive包裹的动态组件或router-view会缓存不活动的实例，再次被调用这些被缓存的实例会被再次复用，对于我们的某些不是需要实时更新的页面来说大大减少了性能上的消耗，不需要再次发送HTTP请求，但是同样也存在一个问题就是被keep-alive包裹的组件我们请求获取的数据不会再重新渲染页面，这也就出现了例如我们使用动态路由做匹配的话页面只会保持第一次请求数据的渲染结果，所以需要我们在特定的情况下强制刷新某些组件</p>
<h2 id="利用include、exclude属性"><a href="#利用include、exclude属性" class="headerlink" title="利用include、exclude属性"></a>利用include、exclude属性</h2><blockquote>
<p>prop:</p>
</blockquote>
<ul>
<li>include: 字符串或正则表达式。只有匹配的组件会被缓存，keep-alive组件激活时调用。</li>
<li>exclude: 字符串或正则表达式。任何匹配的组件都不会被缓存，组件停用时调用。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;keep-alive include=<span class="string">"bookLists,bookLists"</span>&gt;</span><br><span class="line">      &lt;router-view&gt;<span class="xml"><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span></span><br><span class="line">&lt;keep-alive exclude="indexLists"&gt;</span><br><span class="line">      &lt;router-view&gt;&lt;/router-view&gt;</span><br><span class="line">&lt;/keep-alive&gt;</span><br></pre></td></tr></table></figure>
<p>include属性表示只有name属性为bookLists，bookLists的组件会被缓存，（注意是组件的名字，不是路由的名字）其它组件不会被缓存exclude属性表示除了name属性为indexLists的组件不会被缓存，其它组件都会被缓存<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//利用meta属性</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span>[</span><br><span class="line"> &#123;</span><br><span class="line">  path:<span class="string">'/'</span>,</span><br><span class="line">  name:<span class="string">'home'</span>,</span><br><span class="line">  components:Home,</span><br><span class="line">  meta:&#123;</span><br><span class="line">    keepAlive:<span class="literal">true</span> <span class="comment">//需要被缓存的组件</span></span><br><span class="line"> &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">  path:<span class="string">'/book'</span>,</span><br><span class="line">  name:<span class="string">'book'</span>,</span><br><span class="line">  components:Book,</span><br><span class="line">  meta:&#123;</span><br><span class="line">     keepAlive:<span class="literal">false</span> <span class="comment">//不需要被缓存的组件</span></span><br><span class="line"> &#125; </span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">&lt;keep-alive&gt;</span><br><span class="line">  &lt;router-view v-<span class="keyword">if</span>=<span class="string">"this.$route.meat.keepAlive"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="comment">&lt;!--这里是会被缓存的组件--&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span></span><br><span class="line">&lt;keep-alive v-if="!this.$router.meta.keepAlive"&gt;&lt;/keep-alive&gt;</span><br><span class="line">&lt;!--这里是不会被缓存的组件--&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong> 当引入keep-alive的时候，页面第一次进入，钩子的触发顺序 created-&gt; mounted-&gt; activated，退出时触发deactivated。当再次进入（前进或者后退）时，只触发activated。</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//$route发生变化时再次赋值listId</span><br><span class="line">watch: &#123;</span><br><span class="line">   &apos;$route&apos;() &#123;</span><br><span class="line">        this.listId = this.$route.params.id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line">//通过activated钩子触发请求函数</span><br><span class="line">activated() &#123;</span><br><span class="line">    this.getDetail();</span><br><span class="line">&#125;,</span><br><span class="line">//返回详情页面时 隐藏内容div区块 再进入详情时 显示内容div区块 </span><br><span class="line">deactivated() &#123;</span><br><span class="line">    this.isShowContent = false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="DEMO前进刷新-后退不刷新"><a href="#DEMO前进刷新-后退不刷新" class="headerlink" title="DEMO前进刷新,后退不刷新"></a>DEMO前进刷新,后退不刷新</h2><blockquote>
<p>App.vue</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=<span class="string">"app"</span>&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"title"</span>&gt;F12，打开控制台，通过<span class="built_in">console</span>查看数据变化&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    &lt;keep-alive&gt;</span></span><br><span class="line"><span class="regexp">        &lt;router-view v-if="$route.meta.keepAlive"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;!-- 这里是会被缓存的视图组件，比如 page1,page2 --&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>router-view&gt;</span><br><span class="line">    &lt;<span class="regexp">/keep-alive&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    &lt;router-view v-if="!$route.meta.keepAlive"&gt;</span></span><br><span class="line"><span class="regexp">        &lt;!-- 这里是不被缓存的视图组件，比如 page3 --&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>router-view&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  name: <span class="string">"app"</span></span><br><span class="line">&#125;;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;style&gt;</span></span><br><span class="line"><span class="regexp">#app &#123;</span></span><br><span class="line"><span class="regexp">  font-family: "Avenir", Helvetica, Arial, sans-serif;</span></span><br><span class="line"><span class="regexp">  -webkit-font-smoothing: antialiased;</span></span><br><span class="line"><span class="regexp">  -moz-osx-font-smoothing: grayscale;</span></span><br><span class="line"><span class="regexp">  text-align: center;</span></span><br><span class="line"><span class="regexp">  color: #2c3e50;</span></span><br><span class="line"><span class="regexp">  margin-top: 60px;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">.title &#123;</span></span><br><span class="line"><span class="regexp">  font-size: 20px;</span></span><br><span class="line"><span class="regexp">  color: red;</span></span><br><span class="line"><span class="regexp">  margin-bottom: 40px;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">&lt;/</span>style&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>router/index.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">'vue-router'</span></span><br><span class="line"><span class="keyword">import</span> index <span class="keyword">from</span> <span class="string">'@/components/index'</span></span><br><span class="line"><span class="keyword">import</span> page1 <span class="keyword">from</span> <span class="string">'@/components/page1'</span></span><br><span class="line"><span class="keyword">import</span> page2 <span class="keyword">from</span> <span class="string">'@/components/page2'</span></span><br><span class="line"><span class="keyword">import</span> page3 <span class="keyword">from</span> <span class="string">'@/components/page3'</span></span><br><span class="line"></span><br><span class="line">Vue.use(Router)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Router(&#123;</span><br><span class="line">	routes: [&#123;</span><br><span class="line">			path: <span class="string">'/'</span>,</span><br><span class="line">			name: <span class="string">'index'</span>,</span><br><span class="line">			component: index,</span><br><span class="line">			meta: &#123;</span><br><span class="line">				keepAlive: <span class="literal">false</span>, <span class="comment">//此组件不需要被缓存</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			path: <span class="string">'/page1'</span>,</span><br><span class="line">			name: <span class="string">'page1'</span>,</span><br><span class="line">			component: page1,</span><br><span class="line">			meta: &#123;</span><br><span class="line">				keepAlive: <span class="literal">true</span>, <span class="comment">//此组件需要被缓存</span></span><br><span class="line">				isBack: <span class="literal">false</span>, <span class="comment">//用于判断上一个页面是哪个</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			path: <span class="string">'/page2'</span>,</span><br><span class="line">			name: <span class="string">'page2'</span>,</span><br><span class="line">			component: page2,</span><br><span class="line">			meta: &#123;</span><br><span class="line">				keepAlive: <span class="literal">true</span>, <span class="comment">// 此组件需要被缓存</span></span><br><span class="line">				isBack: <span class="literal">false</span>, <span class="comment">//用于判断上一个页面是哪个</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			path: <span class="string">'/page3'</span>,</span><br><span class="line">			name: <span class="string">'page3'</span>,</span><br><span class="line">			component: page3,</span><br><span class="line">			meta: &#123;</span><br><span class="line">				keepAlive: <span class="literal">false</span>, <span class="comment">// 此组件不需要被缓存</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	mode: <span class="string">'history'</span>,</span><br><span class="line">	scrollBehavior(to, <span class="keyword">from</span>, savedPosition) &#123;</span><br><span class="line">		<span class="keyword">if</span>(savedPosition) &#123;</span><br><span class="line">			<span class="keyword">return</span> savedPosition</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> &#123;</span><br><span class="line">				x: <span class="number">0</span>,</span><br><span class="line">				y: <span class="number">0</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>page.vue  page1.vue  page2.vue  page3.vue</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line">//page.vue</span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">      &lt;router-link to=&quot;page1&quot;&gt;第一个页面&lt;/router-link&gt;</span><br><span class="line">      &lt;router-link to=&quot;page2&quot;&gt;第二个页面&lt;/router-link&gt;</span><br><span class="line">      &lt;router-link to=&quot;page3&quot;&gt;第三个页面&lt;/router-link&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">a&#123;</span><br><span class="line">    display: block;</span><br><span class="line">    margin-top: 20px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//page1.vue</span><br><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div class=&quot;page1&quot;&gt;</span><br><span class="line">		&lt;button @click=&quot;goBack&quot;&gt;返回&lt;/button&gt;</span><br><span class="line">		&lt;p&gt;&#123;&#123;msg&#125;&#125;&lt;/p&gt;</span><br><span class="line">		&lt;p&gt;&#123;&#123;str&#125;&#125;&lt;/p&gt;</span><br><span class="line">		&lt;input type=&quot;text&quot; v-model=&quot;val&quot; /&gt;</span><br><span class="line">		&lt;router-link to=&quot;page2&quot;&gt;跳转到下一个页面&lt;/router-link&gt;</span><br><span class="line">	&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">	export default &#123;</span><br><span class="line">		name: &quot;page1&quot;,</span><br><span class="line">		data() &#123;</span><br><span class="line">			return &#123;</span><br><span class="line">				val:&quot;我是输入框&quot;,</span><br><span class="line">				msg: &quot;我是第一个页面&quot;,</span><br><span class="line">				str: &quot;&quot;, // 加载页面后执行获取数据的方法，插入到此</span><br><span class="line">				isFirstEnter: false // 是否第一次进入，默认false</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;,</span><br><span class="line">		methods: &#123;</span><br><span class="line">			getData() &#123;</span><br><span class="line">				// getData方法，模拟从后台请求数据</span><br><span class="line">				console.warn(&quot;我调用第一个页面getData方法了&quot;);</span><br><span class="line">				this.str = &quot;我是通过调用方法加载的数据。。。&quot;;</span><br><span class="line">			&#125;,</span><br><span class="line">			goBack() &#123;</span><br><span class="line">				this.$router.go(-1);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		beforeRouteEnter(to, from, next) &#123;</span><br><span class="line">			console.log(&quot;我是第一个页面的beforeRouteEnter方法&quot;);</span><br><span class="line">			// 路由导航钩子，此时还不能获取组件实例 `this`，所以无法在data中定义变量（利用vm除外）</span><br><span class="line">			// 参考 https://router.vuejs.org/zh-cn/advanced/navigation-guards.html</span><br><span class="line">			// 所以，利用路由元信息中的meta字段设置变量，方便在各个位置获取。这就是为什么在meta中定义isBack</span><br><span class="line">			// 参考 https://router.vuejs.org/zh-cn/advanced/meta.html</span><br><span class="line">			if(from.name == &apos;page2&apos;) &#123;</span><br><span class="line">				to.meta.isBack = true;</span><br><span class="line">				//判断是从哪个路由过来的，如果是page2过来的，表明当前页面不需要刷新获取新数据，直接用之前缓存的数据即可</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			next();</span><br><span class="line">		&#125;,</span><br><span class="line">		created() &#123;</span><br><span class="line">			console.log(&quot;我是第一个页面的 created 方法&quot;);</span><br><span class="line">			this.isFirstEnter = true;</span><br><span class="line">			// 只有第一次进入或者刷新页面后才会执行此钩子函数</span><br><span class="line">			// 使用keep-alive后（2+次）进入不会再执行此钩子函数</span><br><span class="line">		&#125;,</span><br><span class="line">		mounted() &#123;</span><br><span class="line">			console.log(&quot;我是第一个页面的 mounted 方法&quot;);</span><br><span class="line">		&#125;,</span><br><span class="line">		activated() &#123;</span><br><span class="line">			console.log(&quot;我是第一个页面的 activated 方法&quot;);</span><br><span class="line">			if(!this.$route.meta.isBack || this.isFirstEnter) &#123;</span><br><span class="line">				// 如果isBack是false，表明需要获取新数据，否则就不再请求，直接使用缓存的数据</span><br><span class="line">				// 如果isFirstEnter是true，表明是第一次进入此页面或用户刷新了页面，需获取新数据</span><br><span class="line">				this.str = &apos;&apos; // 把数据清空，可以稍微避免让用户看到之前缓存的数据</span><br><span class="line">				this.getData();</span><br><span class="line">			&#125;</span><br><span class="line">			// 恢复成默认的false，避免isBack一直是true，导致下次无法获取数据</span><br><span class="line">			this.$route.meta.isBack = false</span><br><span class="line">			// 恢复成默认的false，避免isBack一直是true，导致每次都获取新数据</span><br><span class="line">			this.isFirstEnter = false;</span><br><span class="line"></span><br><span class="line">		&#125;,</span><br><span class="line">		deactivated() &#123;</span><br><span class="line">			console.log(&quot;我是第一个页面的 deactivated 方法&quot;);</span><br><span class="line">		&#125;,</span><br><span class="line">		destroyed() &#123;</span><br><span class="line">			console.log(&quot;我是第一个页面的 destroyed 方法&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- Add &quot;scoped&quot; attribute to limit CSS to this component only --&gt;</span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//page2.vue</span><br><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div class=&quot;page2&quot;&gt;</span><br><span class="line">		&lt;button @click=&quot;goBack&quot;&gt;返回&lt;/button&gt;</span><br><span class="line">		&lt;p&gt;&#123;&#123;msg&#125;&#125;&lt;/p&gt;</span><br><span class="line">		&lt;p&gt;&#123;&#123;str&#125;&#125;&lt;/p&gt;</span><br><span class="line">		&lt;input type=&quot;text&quot; v-model=&quot;val&quot; /&gt;</span><br><span class="line">		&lt;router-link to=&quot;page3&quot;&gt;跳转到下一个页面&lt;/router-link&gt;</span><br><span class="line">	&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">	export default &#123;</span><br><span class="line">		name: &quot;page2&quot;,</span><br><span class="line">		data() &#123;</span><br><span class="line">			return &#123;</span><br><span class="line">				val:&quot;我是输入框&quot;,</span><br><span class="line">				msg: &quot;我是第二个页面&quot;,</span><br><span class="line">				str: &quot;&quot;,</span><br><span class="line">				isFirstEnter: false</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;,</span><br><span class="line">		methods: &#123;</span><br><span class="line">			getData() &#123;</span><br><span class="line">				console.warn(&quot;我调用第二个页面getData方法了&quot;);</span><br><span class="line">				this.str = &quot;我是通过调用方法加载的数据。。。&quot;;</span><br><span class="line">			&#125;,</span><br><span class="line">			goBack() &#123;</span><br><span class="line">				this.$router.go(-1);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		beforeRouteEnter(to, from, next) &#123;</span><br><span class="line">			console.log(&apos;我是第二个页面的beforeRouteEnter方法&apos;)</span><br><span class="line">			if(from.name == &apos;page3&apos;) &#123;</span><br><span class="line">				to.meta.isBack = true;</span><br><span class="line">			&#125;</span><br><span class="line">			next()</span><br><span class="line">		&#125;,</span><br><span class="line">		created() &#123;</span><br><span class="line">			console.log(&quot;我是第二个页面的 created 方法&quot;);</span><br><span class="line">			this.isFirstEnter = true;</span><br><span class="line">		&#125;,</span><br><span class="line">		mounted() &#123;</span><br><span class="line">			console.log(&quot;我是第二个页面的 mounted 方法&quot;);</span><br><span class="line">		&#125;,</span><br><span class="line">		activated() &#123;</span><br><span class="line">			console.log(&quot;我是第二个页面的 activated 方法&quot;);</span><br><span class="line">			if(!this.$route.meta.isBack || this.isFirstEnter) &#123;</span><br><span class="line">				this.str = &apos;&apos;</span><br><span class="line">				this.getData();</span><br><span class="line">			&#125;</span><br><span class="line">			this.$route.meta.isBack = false</span><br><span class="line">			this.isFirstEnter = false;</span><br><span class="line">		&#125;,</span><br><span class="line">		deactivated() &#123;</span><br><span class="line">			console.log(&quot;我是第二个页面的 deactivated 方法&quot;);</span><br><span class="line">		&#125;,</span><br><span class="line">		destroyed() &#123;</span><br><span class="line">			console.log(&quot;我是第二个页面的 destroyed 方法&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- Add &quot;scoped&quot; attribute to limit CSS to this component only --&gt;</span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//page3.vue</span><br><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div class=&quot;page3&quot;&gt;</span><br><span class="line">		&lt;button @click=&quot;goBack&quot;&gt;返回&lt;/button&gt;</span><br><span class="line">		&lt;p&gt;&#123;&#123;msg&#125;&#125;&lt;/p&gt;</span><br><span class="line">		&lt;p&gt;&#123;&#123;str&#125;&#125;&lt;/p&gt;</span><br><span class="line">	&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">	export default &#123;</span><br><span class="line">		name: &quot;page3&quot;,</span><br><span class="line">		data() &#123;</span><br><span class="line">			return &#123;</span><br><span class="line">				msg: &quot;我是第三个页面&quot;,</span><br><span class="line">				str: &apos;&apos;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;,</span><br><span class="line">		methods: &#123;</span><br><span class="line">			getData() &#123;</span><br><span class="line">				console.warn(&apos;我调用第三个页面getData方法了&apos;)</span><br><span class="line">				this.str = &quot;我是通过调用方法加载的数据。。。&quot;;</span><br><span class="line">			&#125;,</span><br><span class="line">			goBack() &#123;</span><br><span class="line">				this.$router.go(-1)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		beforeRouteEnter(to, from, next) &#123;</span><br><span class="line">			console.log(&apos;我是第三个页面的beforeRouteEnter方法&apos;)</span><br><span class="line">			next()</span><br><span class="line">		&#125;,</span><br><span class="line">		created() &#123;</span><br><span class="line">			console.log(&apos;我是第三个页面的 created 方法&apos;)</span><br><span class="line">		&#125;,</span><br><span class="line">		mounted() &#123;</span><br><span class="line">			this.getData()</span><br><span class="line">			console.log(&apos;我是第三个页面的 mounted 方法&apos;)</span><br><span class="line">		&#125;,</span><br><span class="line">		activated() &#123;</span><br><span class="line">			console.log(&apos;我是第三个页面的 activated 方法&apos;)</span><br><span class="line">		&#125;,</span><br><span class="line">		deactivated() &#123;</span><br><span class="line">			console.log(&apos;我是第三个页面的 deactivated 方法&apos;)</span><br><span class="line">		&#125;,</span><br><span class="line">		destroyed() &#123;</span><br><span class="line">			console.log(&apos;我是第三个页面的 destroyed 方法&apos;)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- Add &quot;scoped&quot; attribute to limit CSS to this component only --&gt;</span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p><strong> 依次加入page1,page2,page1 </strong><br><img src="/2019/02/18/用keep-alive优化页面性能/1.png" alt=""><br><img src="/2019/02/18/用keep-alive优化页面性能/2.png" alt=""></p>
<h2 id="vue-keep-scroll-position"><a href="#vue-keep-scroll-position" class="headerlink" title="vue-keep-scroll-position"></a>vue-keep-scroll-position</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">(function () &#123;</span><br><span class="line">	var plugin;</span><br><span class="line">	plugin = function (Vue) &#123;</span><br><span class="line">		return Vue.directive(&apos;keep-scroll-position&apos;, &#123;</span><br><span class="line">			bind: function (el) &#123;</span><br><span class="line">				el.addEventListener(&apos;scroll&apos;, function (event) &#123;</span><br><span class="line">					event.target.setAttribute(&apos;data-vue-keep-scroll-position&apos;, event.target.scrollLeft + &apos;-&apos; + event.target.scrollTop);</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;,</span><br><span class="line">			inserted: function (el) &#123;</span><br><span class="line">				var i, len, pos, target, targets;</span><br><span class="line">				targets = el.querySelectorAll(&apos;[data-vue-keep-scroll-position]&apos;);</span><br><span class="line">				if (targets.length &gt; 0) &#123;</span><br><span class="line">					for (i = 0, len = targets.length; i &lt; len; i++) &#123;</span><br><span class="line">						target = targets[i];</span><br><span class="line">						pos = target.getAttribute(&apos;data-vue-keep-scroll-position&apos;).split(&apos;-&apos;);</span><br><span class="line">						target.scrollLeft = pos[0];</span><br><span class="line">						target.scrollTop = pos[1];</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; else &#123;</span><br><span class="line">					if (el.hasAttribute(&apos;data-vue-keep-scroll-position&apos;)) &#123;</span><br><span class="line">						pos = el.getAttribute(&apos;data-vue-keep-scroll-position&apos;).split(&apos;-&apos;);</span><br><span class="line">						el.scrollLeft = pos[0];</span><br><span class="line">						el.scrollTop = pos[1];</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;;</span><br><span class="line">	if (typeof Vue !== &quot;undefined&quot; &amp;&amp; Vue !== null) &#123;</span><br><span class="line">		Vue.use(plugin);</span><br><span class="line">	&#125;</span><br><span class="line">	if (typeof exports === &apos;object&apos; &amp;&amp; typeof module === &apos;object&apos;) &#123;</span><br><span class="line">		return module.exports = plugin;</span><br><span class="line">	&#125; else if (typeof define === &apos;function&apos; &amp;&amp; define.amd) &#123;</span><br><span class="line">		return define(function () &#123;</span><br><span class="line">			return plugin;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125; else if (typeof window !== &quot;undefined&quot; &amp;&amp; window !== null) &#123;</span><br><span class="line">		return window.VueKeepScrollPosition = plugin;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>Install<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -S vue-keep-scroll-position</span><br></pre></td></tr></table></figure></p>
<p>Use:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import Vue from &apos;vue&apos;</span><br><span class="line">import VueKeepScrollPosition from &apos;vue-keep-scroll-position&apos;</span><br><span class="line">Vue.use VueKeepScrollPosition</span><br></pre></td></tr></table></figure></p>
<p>只需添加v-keep-scroll-position到您的组件内即可<keep-alive>。用于router-view：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;keep-alive&gt;</span><br><span class="line">  &lt;router-view  v-keep-scroll-position&gt; &lt;/router-view&gt;</span><br><span class="line">&lt;/keep-alive&gt;</span><br></pre></td></tr></table></figure></keep-alive></p>
<p>对于简单的动态组件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;keep-alive&gt;</span><br><span class="line">  &lt;component :is=&quot;someComponentName&quot;  v-keep-scroll-position&gt;&lt;/component&gt;</span><br><span class="line">&lt;/keep-alive&gt;</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="keep-alive组件实现原理"><a href="#keep-alive组件实现原理" class="headerlink" title="keep-alive组件实现原理"></a>keep-alive组件实现原理</h2><h2 id="Vue源码keep-alive-js文件地址"><a href="#Vue源码keep-alive-js文件地址" class="headerlink" title="Vue源码keep-alive.js文件地址"></a><a href="https://github.com/vuejs/vue/blob/59d8579fbd3a3450ab684d6a596f1853f2257d08/src/core/components/keep-alive.js" target="_blank" rel="noopener">Vue源码keep-alive.js文件地址</a></h2><h2 id="深入keep-alive组件实现"><a href="#深入keep-alive组件实现" class="headerlink" title="深入keep-alive组件实现"></a>深入keep-alive组件实现</h2><p>说完了keep-alive组件的使用，我们从源码角度看一下keep-alive组件究竟是如何实现组件的缓存的呢？</p>
<ul>
<li>首先，你要知道Vue.js内部将DOM节点抽象成了一个个的VNode节点，这个我之前写过相关文章可以参考VNode节点。所以，keep-alive的缓存也是基于VNode节点的而不是直接存储DOM结构。</li>
<li>其实就是将需要缓存的VNode节点保存在this.cache中／在render时,如果VNode的name符合在缓存条件（可以用include以及exclude控制），则会从this.cache中取出之前缓存的VNode实例进行渲染。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">type VNodeCache = &#123; [key: string]: ?VNode &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> patternTypes: <span class="built_in">Array</span>&lt;<span class="built_in">Function</span>&gt; = [<span class="built_in">String</span>, <span class="built_in">RegExp</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 获取组件名称 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getComponentName</span> (<span class="params">opts: ? VNodeComponentOptions</span>): ?<span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> opts &amp;&amp; (opts.Ctor.options.name || opts.tag)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 检测name是否匹配 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">matches</span> (<span class="params">pattern: string | RegExp, name: string</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> pattern === <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="comment">/* 字符串情况，如a,b,c */</span></span><br><span class="line">    <span class="keyword">return</span> pattern.split(<span class="string">','</span>).indexOf(name) &gt; <span class="number">-1</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isRegExp(pattern)) &#123;</span><br><span class="line">    <span class="comment">/* 正则 */</span></span><br><span class="line">    <span class="keyword">return</span> pattern.test(name)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* istanbul ignore next */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 修正cache */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pruneCache</span> (<span class="params">cache: VNodeCache, current: VNode, filter: Function</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> cache) &#123;</span><br><span class="line">    <span class="comment">/* 取出cache中的vnode */</span></span><br><span class="line">    <span class="keyword">const</span> cachedNode: ?VNode = cache[key]</span><br><span class="line">    <span class="keyword">if</span> (cachedNode) &#123;</span><br><span class="line">      <span class="keyword">const</span> name: ?string = getComponentName(cachedNode.componentOptions)</span><br><span class="line">      <span class="comment">/* name不符合filter条件的，同时不是目前渲染的vnode时，销毁vnode对应的组件实例（Vue实例），并从cache中移除 */</span></span><br><span class="line">      <span class="keyword">if</span> (name &amp;&amp; !filter(name)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cachedNode !== current) &#123;</span><br><span class="line">          pruneCacheEntry(cachedNode)</span><br><span class="line">        &#125;</span><br><span class="line">        cache[key] = <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 销毁vnode对应的组件实例（Vue实例） */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pruneCacheEntry</span> (<span class="params">vnode: ?VNode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (vnode) &#123;</span><br><span class="line">    vnode.componentInstance.$destroy()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* keep-alive组件 */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  name: <span class="string">'keep-alive'</span>,</span><br><span class="line">  <span class="comment">/* 抽象组件 */</span></span><br><span class="line">  abstract: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  props: &#123;</span><br><span class="line">    include: patternTypes,</span><br><span class="line">    exclude: patternTypes</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  created () &#123;</span><br><span class="line">    <span class="comment">/* 缓存对象 */</span></span><br><span class="line">    <span class="keyword">this</span>.cache = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* destroyed钩子中销毁所有cache中的组件实例 */</span></span><br><span class="line">  destroyed () &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> <span class="keyword">this</span>.cache) &#123;</span><br><span class="line">      pruneCacheEntry(<span class="keyword">this</span>.cache[key])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  watch: &#123;</span><br><span class="line">    <span class="comment">/* 监视include以及exclude，在被修改的时候对cache进行修正 */</span></span><br><span class="line">    include (val: string | <span class="built_in">RegExp</span>) &#123;</span><br><span class="line">      pruneCache(<span class="keyword">this</span>.cache, <span class="keyword">this</span>._vnode, name =&gt; matches(val, name))</span><br><span class="line">    &#125;,</span><br><span class="line">    exclude (val: string | <span class="built_in">RegExp</span>) &#123;</span><br><span class="line">      pruneCache(<span class="keyword">this</span>.cache, <span class="keyword">this</span>._vnode, name =&gt; !matches(val, name))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  render () &#123;</span><br><span class="line">    <span class="comment">/* 得到slot插槽中的第一个组件 */</span></span><br><span class="line">    <span class="keyword">const</span> vnode: VNode = getFirstComponentChild(<span class="keyword">this</span>.$slots.default)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> componentOptions: ?VNodeComponentOptions = vnode &amp;&amp; vnode.componentOptions</span><br><span class="line">    <span class="keyword">if</span> (componentOptions) &#123;</span><br><span class="line">      <span class="comment">// check pattern</span></span><br><span class="line">      <span class="comment">/* 获取组件名称，优先获取组件的name字段，否则是组件的tag */</span></span><br><span class="line">      <span class="keyword">const</span> name: ?string = getComponentName(componentOptions)</span><br><span class="line">      <span class="comment">/* name不在inlcude中或者在exlude中则直接返回vnode（没有取缓存） */</span></span><br><span class="line">      <span class="keyword">if</span> (name &amp;&amp; (</span><br><span class="line">        (<span class="keyword">this</span>.include &amp;&amp; !matches(<span class="keyword">this</span>.include, name)) ||</span><br><span class="line">        (<span class="keyword">this</span>.exclude &amp;&amp; matches(<span class="keyword">this</span>.exclude, name))</span><br><span class="line">      )) &#123;</span><br><span class="line">        <span class="keyword">return</span> vnode</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> key: ?string = vnode.key == <span class="literal">null</span></span><br><span class="line">        <span class="comment">// same constructor may get registered as different local components</span></span><br><span class="line">        <span class="comment">// so cid alone is not enough (#3269)</span></span><br><span class="line">        ? componentOptions.Ctor.cid + (componentOptions.tag ? <span class="string">`::<span class="subst">$&#123;componentOptions.tag&#125;</span>`</span> : <span class="string">''</span>)</span><br><span class="line">        : vnode.key</span><br><span class="line">      <span class="comment">/* 如果已经做过缓存了则直接从缓存中获取组件实例给vnode，还未缓存过则进行缓存 */</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.cache[key]) &#123;</span><br><span class="line">        vnode.componentInstance = <span class="keyword">this</span>.cache[key].componentInstance</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.cache[key] = vnode</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/* keepAlive标记位 */</span></span><br><span class="line">      vnode.data.keepAlive = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> vnode</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="created与destroyed钩子"><a href="#created与destroyed钩子" class="headerlink" title="created与destroyed钩子"></a>created与destroyed钩子</h3><p>created钩子会创建一个cache对象，用来作为缓存容器，保存vnode节点。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">type VNodeCache = &#123; [key: string]: ?VNode &#125;;    <span class="comment">//缓存keep-alive对象VNodeCache</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">created () &#123;</span><br><span class="line">    <span class="comment">/* 缓存对象 */</span></span><br><span class="line">   <span class="keyword">this</span>.cache = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>destroyed钩子则在组件被销毁的时候清除cache缓存中的所有组件实例。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* destroyed钩子中销毁所有cache中的组件实例 */</span></span><br><span class="line">destroyed () &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> <span class="keyword">this</span>.cache) &#123;</span><br><span class="line">        pruneCacheEntry(<span class="keyword">this</span>.cache[key])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<h3 id="render"><a href="#render" class="headerlink" title="render"></a>render</h3><p>接下来是render函数。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">render () &#123;</span><br><span class="line">    <span class="comment">/* 得到slot插槽中的第一个组件 */</span></span><br><span class="line">    <span class="keyword">const</span> vnode: VNode = getFirstComponentChild(<span class="keyword">this</span>.$slots.default)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> componentOptions: ?VNodeComponentOptions = vnode &amp;&amp; vnode.componentOptions</span><br><span class="line">    <span class="keyword">if</span> (componentOptions) &#123;</span><br><span class="line">        <span class="comment">// check pattern</span></span><br><span class="line">        <span class="comment">/* 获取组件名称，优先获取组件的name字段，否则是组件的tag */</span></span><br><span class="line">        <span class="keyword">const</span> name: ?string = getComponentName(componentOptions)</span><br><span class="line">        <span class="comment">/* name不在inlcude中或者在exlude中则直接返回vnode（没有取缓存） */</span></span><br><span class="line">        <span class="keyword">if</span> (name &amp;&amp; (</span><br><span class="line">        (<span class="keyword">this</span>.include &amp;&amp; !matches(<span class="keyword">this</span>.include, name)) ||</span><br><span class="line">        (<span class="keyword">this</span>.exclude &amp;&amp; matches(<span class="keyword">this</span>.exclude, name))</span><br><span class="line">        )) &#123;</span><br><span class="line">            <span class="keyword">return</span> vnode</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> key: ?string = vnode.key == <span class="literal">null</span></span><br><span class="line">        <span class="comment">// same constructor may get registered as different local components</span></span><br><span class="line">        <span class="comment">// so cid alone is not enough (#3269)</span></span><br><span class="line">        ? componentOptions.Ctor.cid + (componentOptions.tag ? <span class="string">`::<span class="subst">$&#123;componentOptions.tag&#125;</span>`</span> : <span class="string">''</span>)</span><br><span class="line">        : vnode.key</span><br><span class="line">        <span class="comment">/* 如果已经做过缓存了则直接从缓存中获取组件实例给vnode，还未缓存过则进行缓存 */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.cache[key]) &#123;</span><br><span class="line">            vnode.componentInstance = <span class="keyword">this</span>.cache[key].componentInstance</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.cache[key] = vnode</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* keepAlive标记位 */</span></span><br><span class="line">        vnode.data.keepAlive = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> vnode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先通过getFirstComponentChild获取第一个子组件，获取该组件的name（存在组件名则直接使用组件名，否则会使用tag）。接下来会将这个name通过include与exclude属性进行匹配，匹配不成功（说明不需要进行缓存）则不进行任何操作直接返回vnode，vnode是一个VNode类型的对象，不了解VNode的同学可以参考笔者的另一篇文章<a href="https://link.jianshu.com?t=https://github.com/answershuto/learnVue/blob/master/docs/VNode%E8%8A%82%E7%82%B9.MarkDown" target="_blank" rel="noopener">《VNode节点》</a> .<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 检测name是否匹配 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">matches</span> (<span class="params">pattern: string | RegExp, name: string</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> pattern === <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="comment">/* 字符串情况，如a,b,c */</span></span><br><span class="line">    <span class="keyword">return</span> pattern.split(<span class="string">','</span>).indexOf(name) &gt; <span class="number">-1</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isRegExp(pattern)) &#123;</span><br><span class="line">    <span class="comment">/* 正则 */</span></span><br><span class="line">    <span class="keyword">return</span> pattern.test(name)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* istanbul ignore next */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>检测include与exclude属性匹配的函数很简单，include与exclude属性支持字符串如”a,b,c”这样组件名以逗号隔开的情况以及正则表达式。matches通过这两种方式分别检测是否匹配当前组件。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.cache[key]) &#123;</span><br><span class="line">    vnode.componentInstance = <span class="keyword">this</span>.cache[key].componentInstance</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.cache[key] = vnode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来的事情很简单，根据key在this.cache中查找，如果存在则说明之前已经缓存过了，直接将缓存的vnode的componentInstance（组件实例）覆盖到目前的vnode上面。否则将vnode存储在cache中。</p>
<p>最后返回vnode（有缓存时该vnode的componentInstance已经被替换成缓存中的了）。</p>
<h3 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h3><p>用watch来监听pruneCache与pruneCache这两个属性的改变，在改变的时候修改cache缓存中的缓存数据。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">watch: &#123;</span><br><span class="line">    <span class="comment">/* 监视include以及exclude，在被修改的时候对cache进行修正 */</span></span><br><span class="line">    include (val: string | <span class="built_in">RegExp</span>) &#123;</span><br><span class="line">        pruneCache(<span class="keyword">this</span>.cache, <span class="keyword">this</span>._vnode, name =&gt; matches(val, name))</span><br><span class="line">    &#125;,</span><br><span class="line">    exclude (val: string | <span class="built_in">RegExp</span>) &#123;</span><br><span class="line">        pruneCache(<span class="keyword">this</span>.cache, <span class="keyword">this</span>._vnode, name =&gt; !matches(val, name))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>来看一下pruneCache的实现。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 修正cache */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pruneCache</span> (<span class="params">cache: VNodeCache, current: VNode, filter: Function</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> cache) &#123;</span><br><span class="line">    <span class="comment">/* 取出cache中的vnode */</span></span><br><span class="line">    <span class="keyword">const</span> cachedNode: ?VNode = cache[key]</span><br><span class="line">    <span class="keyword">if</span> (cachedNode) &#123;</span><br><span class="line">      <span class="keyword">const</span> name: ?string = getComponentName(cachedNode.componentOptions)</span><br><span class="line">      <span class="comment">/* name不符合filter条件的，同时不是目前渲染的vnode时，销毁vnode对应的组件实例（Vue实例），并从cache中移除 */</span></span><br><span class="line">      <span class="keyword">if</span> (name &amp;&amp; !filter(name)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cachedNode !== current) &#123;</span><br><span class="line">          pruneCacheEntry(cachedNode)</span><br><span class="line">        &#125;</span><br><span class="line">        cache[key] = <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">/* 销毁vnode对应的组件实例（Vue实例） */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pruneCacheEntry</span> (<span class="params">vnode: ?VNode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (vnode) &#123;</span><br><span class="line">    vnode.componentInstance.$destroy()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>遍历cache中的所有项，如果不符合filter指定的规则的话，则会执行pruneCacheEntry。pruneCacheEntry则会调用组件实例的$destroy方法来将组件销毁。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>Vue.js内部将DOM节点抽象成了一个个的<a href="https://link.jianshu.com?t=https://github.com/answershuto/learnVue/blob/master/docs/VNode%E8%8A%82%E7%82%B9.MarkDown" target="_blank" rel="noopener">VNode节点</a>，keep-alive组件的缓存也是基于VNode节点的而不是直接存储DOM结构。它将满足条件（pruneCache与pruneCache）的组件在cache对象中缓存起来，在需要重新渲染的时候再将vnode节点从cache对象中取出并渲染。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/14/React用PureComponent和React-memo优化性能/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动乾坤">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/14/React用PureComponent和React-memo优化性能/" itemprop="url">React用PureComponent和React.memo优化性能</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-14T15:38:13+08:00">
                2019-02-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文将从 render 函数的角度总结 React App 的优化技巧。</p>
<p>需要提醒的是，文中将涉及 React 16.8.2 版本的内容(也即 Hooks），因此请至少了解 useState 以保证食用效果。</p>
<p>当我们讨论 React App 的性能问题时，组件的<strong>渲染</strong>速度是一个重要问题。在进入到具体优化建议之前，我们先要理解以下 3 点：</p>
<ol>
<li>当我们在说「render」时，我们在说什么？</li>
<li>什么时候会执行「render」？</li>
<li>在「render」过程中会发生什么？</li>
</ol>
<h2 id="解读-render-函数"><a href="#解读-render-函数" class="headerlink" title="解读 render 函数"></a>解读 render 函数</h2><p>这部分涉及 reconciliation 和 diffing 的概念，当然官方文档在<a href="https://link.juejin.im?target=https%3A%2F%2Freactjs.org%2Fdocs%2Freconciliation.html" target="_blank" rel="noopener">这里</a>。</p>
<h3 id="当我们在说「render」时，我们在说什么？"><a href="#当我们在说「render」时，我们在说什么？" class="headerlink" title="当我们在说「render」时，我们在说什么？"></a>当我们在说「render」时，我们在说什么？</h3><p>这个问题其实写过 React 的人都会知道，这里再简单说下：</p>
<p>在 class 组件中，我们指的是 render 方法：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line"> render() &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span> Foo <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在函数式组件中，我们指的是函数组件本身：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span><span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span> Foo <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="什么时候会执行「render」？"><a href="#什么时候会执行「render」？" class="headerlink" title="什么时候会执行「render」？"></a>什么时候会执行「render」？</h3><p>render 函数会在两种场景下被调用：</p>
<h4 id="状态更新时"><a href="#状态更新时" class="headerlink" title="状态更新时"></a>状态更新时</h4><h5 id="a-继承自-React-Component-的-class-组件更新状态时"><a href="#a-继承自-React-Component-的-class-组件更新状态时" class="headerlink" title="a. 继承自 React.Component 的 class 组件更新状态时"></a>a. 继承自 React.Component 的 class 组件更新状态时</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">"react-dom"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Foo</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">class Foo extends React.Component &#123;</span></span><br><span class="line"><span class="xml">  state = &#123; count: 0 &#125;;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  increment = () =&gt; &#123;</span></span><br><span class="line"><span class="xml">    const &#123; count &#125; = this.state;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    const newCount = count <span class="tag">&lt; <span class="attr">10</span> ? <span class="attr">count</span> + <span class="attr">1</span> <span class="attr">:</span> <span class="attr">count</span>;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    this.setState(&#123; count: newCount &#125;);</span></span><br><span class="line"><span class="xml">  &#125;;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  render() &#123;</span></span><br><span class="line"><span class="xml">    const &#123; count &#125; = this.state;</span></span><br><span class="line"><span class="xml">    console.log("Foo render");</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    return (</span></span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h1&gt; &#123;count&#125; &lt;/h1&gt;</span><br><span class="line">        &lt;button onClick=&#123;this.increment&#125;&gt;Increment&lt;/button&gt;</span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    );</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">const rootElement = document.getElementById("root");</span></span><br><span class="line"><span class="xml">ReactDOM.render(<span class="tag">&lt;<span class="name">App</span> /&gt;</span>, rootElement);</span></span><br></pre></td></tr></table></figure>
<p>可以看到，代码中的逻辑是我们点击就会更新 count，到 10 以后，就会维持在 10。增加一个 console.log，这样我们就可以知道 render 是否被调用了。从执行结果可以知道，即使 count 到了 10 以上，render 仍然会被调用。</p>
<p>总结：<strong> <font color="#ff0000"> 继承了 React.Component 的 class 组件，即使状态没变化，只要调用了setState 依然会触发 render。</font> </strong></p>
<h5 id="b-函数式组件更新状态时"><a href="#b-函数式组件更新状态时" class="headerlink" title="b. 函数式组件更新状态时"></a>b. 函数式组件更新状态时</h5><p>我们用函数实现相同的组件，当然因为要有状态，我们用上了 useState hook：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">"react-dom"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Foo</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">function Foo() &#123;</span></span><br><span class="line"><span class="xml">  const [count, setCount] = useState(0);</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  function increment() &#123;</span></span><br><span class="line"><span class="xml">    const newCount = count <span class="tag">&lt; <span class="attr">10</span> ? <span class="attr">count</span> + <span class="attr">1</span> <span class="attr">:</span> <span class="attr">count</span>;</span></span></span><br><span class="line"><span class="xml">    setCount(newCount);</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  console.log("Foo render");</span></span><br><span class="line"><span class="xml">  </span></span><br><span class="line"><span class="xml">  return (</span></span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1&gt; &#123;count&#125; &lt;/h1&gt;</span><br><span class="line">      &lt;button onClick=&#123;increment&#125;&gt;Increment&lt;/button&gt;</span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">  );</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">const rootElement = document.getElementById("root");</span></span><br><span class="line"><span class="xml">ReactDOM.render(<span class="tag">&lt;<span class="name">App</span> /&gt;</span>, rootElement);</span></span><br></pre></td></tr></table></figure></p>
<p>我们可以注意到，当状态值不再改变之后，render 的调用就停止了。</p>
<p>总结：<strong> <font color="#ff0000"> 对函数式组件来说，状态值改变时才会触发 render 函数的调用。</font> </strong></p>
<h4 id="父容器重新渲染时"><a href="#父容器重新渲染时" class="headerlink" title="父容器重新渲染时"></a>父容器重新渲染时</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">"react-dom"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123; <span class="attr">name</span>: <span class="string">"App"</span> &#125;;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">        &lt;Foo /&gt;</span><br><span class="line">        &lt;button onClick=&#123;() =&gt; <span class="keyword">this</span>.setState(&#123; <span class="attr">name</span>: <span class="string">"App"</span> &#125;)&#125;&gt;</span><br><span class="line">          Change name</span><br><span class="line">        &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Foo render"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1&gt; Foo &lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rootElement = <span class="built_in">document</span>.getElementById(<span class="string">"root"</span>);</span><br><span class="line">ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>, rootElement);</span></span><br></pre></td></tr></table></figure>
<p>只要点击了 App 组件内的 Change name 按钮，就会重新 render。而且可以注意到，不管 Foo 具体实现是什么，Foo 都会被重新渲染。</p>
<p>总结：<strong> <font color="#ff0000"> 无论组件是继承自 React.Component 的 class 组件还是函数式组件，一旦父容器重新 render，组件的 render 都会再次被调用。</font> </strong></p>
<h3 id="在「render」过程中会发生什么？"><a href="#在「render」过程中会发生什么？" class="headerlink" title="在「render」过程中会发生什么？"></a>在「render」过程中会发生什么？</h3><p>只要 render 函数被调用，就会有两个步骤按顺序执行。这两个步骤非常重要，理解了它们才好知道如何去优化 React App。</p>
<h4 id="Diffing-【对比】"><a href="#Diffing-【对比】" class="headerlink" title="Diffing 【对比】"></a>Diffing 【对比】</h4><p>在此步骤中，React 将新调用的 render 函数返回的树与旧版本的VDOM树进行比较，这一步是 React 决定如何更新 DOM 的必要步骤。虽然 React 使用高度优化的算法执行此步骤，但仍然有一定的性能开销。</p>
<h4 id="Reconciliation-【更新】"><a href="#Reconciliation-【更新】" class="headerlink" title="Reconciliation 【更新】"></a>Reconciliation 【更新】</h4><p>基于 diffing 的结果，React 更新 DOM 树。这一步因为需要卸载和挂载 DOM 节点同样存在许多性能开销。</p>
<h2 id="开始我们的-Tips"><a href="#开始我们的-Tips" class="headerlink" title="开始我们的 Tips"></a>开始我们的 Tips</h2><h3 id="谨慎分配-state-以避免不必要的-render-调用"><a href="#谨慎分配-state-以避免不必要的-render-调用" class="headerlink" title="谨慎分配 state 以避免不必要的 render 调用"></a>谨慎分配 state 以避免不必要的 render 调用</h3><p>我们以下面为例，其中 App 会渲染两个组件：</p>
<ul>
<li><code>CounterLabel</code>，接收 count 值和一个 inc 父组件 App 中状态 count 的方法。</li>
<li><code>List</code>，接收 item 的列表。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">"react-dom"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ITEMS = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [items, setItems] = useState(ITEMS);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &lt;CounterLabel count=&#123;count&#125; increment=&#123;() =&gt; setCount(count + <span class="number">1</span>)&#125; /&gt;</span><br><span class="line">      &lt;List items=&#123;items&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function CounterLabel(&#123; count, increment &#125;) &#123;</span></span><br><span class="line"><span class="regexp">  return (</span></span><br><span class="line"><span class="regexp">    &lt;div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;h1&gt;&#123;count&#125; &lt;/</span>h1&gt;</span><br><span class="line">      &lt;button onClick=&#123;increment&#125;&gt; Increment &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;div/</span>&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">List</span>(<span class="params">&#123; items &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"List render"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &#123;items.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> (</span><br><span class="line">        &lt;li key=&#123;index&#125;&gt;&#123;item&#125; &lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">      ))&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/u</span>l&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rootElement = <span class="built_in">document</span>.getElementById(<span class="string">"root"</span>);</span><br><span class="line">ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>, rootElement);</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>执行上面代码可知，只要父组件 App 中的状态被更新，<code>CounterLabel</code> 和 <code>List</code> 就都会更新。</p>
<p>当然，<code>CounterLabel</code> 重新渲染是正常的，因为 count 发生了变化，自然要重新渲染；但是对于 <code>List</code> 而言，就完全是不必要的更新了，因为它的渲染与 count 无关。</p>
<p><strong>  <font color="#ff0000"> 尽管 React 并不会在 reconciliation 阶段真的更新 DOM，毕竟完全没变化，但是仍然会执行 diffing 阶段来对前后的树进行对比，这仍然存在性能开销。</font> </strong></p>
<p>还记得 render 执行过程中的 diffing 和 reconciliation 阶段吗？前面讲过的东西在这里碰到了。</p>
<p>因此，为了避免不必要的 diffing 开销，我们应当考虑将特定的状态值放到更低的层级或组件中（与 React 中所说的「提升」概念刚好相反）。在这个例子中，我们可以通过将 count 放到 <code>CounterLabel</code> 组件中管理来解决这个问题。</p>
<h3 id="合并状态更新"><a href="#合并状态更新" class="headerlink" title="合并状态更新"></a>合并状态更新</h3><p>因为每次状态更新都会触发新的 render 调用，那么更少的状态更新也就可以更少的调用 render 了。</p>
<p>我们知道，React class 组件有 <code>componentDidUpdate(prevProps, prevState)</code> 的钩子，可以用来检测 props 或 state 有没有发生变化。尽管有时有必要在 props 发生变化时再触发 state 更新，但我们总可以避免在一次 state 变化后再进行一次 state 更新这种操作：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">"react-dom"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRange</span>(<span class="params">limit</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> range = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; limit; i++) &#123;</span><br><span class="line">    range.push(i);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> range;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    numbers: getRange(<span class="number">7</span>),</span><br><span class="line">    limit: <span class="number">7</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  handleLimitChange = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> limit = e.target.value;</span><br><span class="line">    <span class="keyword">const</span> limitChanged = limit !== <span class="keyword">this</span>.state.limit;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (limitChanged) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; limit &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  componentDidUpdate(prevProps, prevState) &#123;</span><br><span class="line">    <span class="keyword">const</span> limitChanged = prevState.limit !== <span class="keyword">this</span>.state.limit;</span><br><span class="line">    <span class="keyword">if</span> (limitChanged) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">numbers</span>: getRange(<span class="keyword">this</span>.state.limit) &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;input</span><br><span class="line">          onChange=&#123;<span class="keyword">this</span>.handleLimitChange&#125;</span><br><span class="line">          placeholder=<span class="string">"limit"</span></span><br><span class="line">          value=&#123;<span class="keyword">this</span>.state.limit&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">        &#123;<span class="keyword">this</span>.state.numbers.map(<span class="function">(<span class="params">number, idx</span>) =&gt;</span> (</span><br><span class="line">          &lt;p key=&#123;idx&#125;&gt;&#123;number&#125; &lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">        ))&#125;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rootElement = <span class="built_in">document</span>.getElementById(<span class="string">"root"</span>);</span><br><span class="line">ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>, rootElement);</span></span><br></pre></td></tr></table></figure></p>
<p>这里渲染了一个范围数字序列，即范围为 0 到 limit。只要用户改变了 limit 值，我们就会在 componentDidUpdate 中进行检测，并设定新的数字列表。</p>
<p>毫无疑问，上面的代码是可以满足需求的，但是，我们仍然可以进行优化。</p>
<p>上面的代码中，每次 limit 发生改变，我们都会触发两次状态更新：第一次是为了修改 limit，第二次是为了修改展示的数字列表。这样一来，每次 limit 的变化会带来两次 render 开销：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始状态</span></span><br><span class="line">&#123; <span class="attr">limit</span>: <span class="number">7</span>, <span class="attr">numbers</span>: [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br><span class="line"><span class="comment">// 更新 limit -&gt; 4</span></span><br><span class="line">render <span class="number">1</span>: &#123; <span class="attr">limit</span>: <span class="number">4</span>, <span class="attr">numbers</span>: [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>] &#125; </span><br><span class="line">render <span class="number">2</span>: &#123; <span class="attr">limit</span>: <span class="number">4</span>, <span class="attr">numbers</span>: [<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br></pre></td></tr></table></figure>
<p>我们的代码逻辑带来了下面的问题：</p>
<ul>
<li>我们触发了比实际需要更多的状态更新；</li>
<li>我们出现了「不连续」的渲染结果，即数字列表与 limit 不匹配。</li>
</ul>
<p>为了改进，我们应避免在不同的状态更新中改变数字列表。事实上，我们可以在一次状态更新中搞定：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">"react-dom"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRange</span>(<span class="params">limit</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> range = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; limit; i++) &#123;</span><br><span class="line">    range.push(i);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> range;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    numbers: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>],</span><br><span class="line">    limit: <span class="number">7</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  handleLimitChange = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> limit = e.target.value;</span><br><span class="line">    <span class="keyword">const</span> limitChanged = limit !== <span class="keyword">this</span>.state.limit;</span><br><span class="line">    <span class="keyword">if</span> (limitChanged) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; limit, <span class="attr">numbers</span>: getRange(limit) &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;input</span><br><span class="line">          onChange=&#123;<span class="keyword">this</span>.handleLimitChange&#125;</span><br><span class="line">          placeholder=<span class="string">"limit"</span></span><br><span class="line">          value=&#123;<span class="keyword">this</span>.state.limit&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">        &#123;<span class="keyword">this</span>.state.numbers.map(<span class="function">(<span class="params">number, idx</span>) =&gt;</span> (</span><br><span class="line">          &lt;p key=&#123;idx&#125;&gt;&#123;number&#125; &lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">        ))&#125;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rootElement = <span class="built_in">document</span>.getElementById(<span class="string">"root"</span>);</span><br><span class="line">ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>, rootElement);</span></span><br></pre></td></tr></table></figure></p>
<h3 id="使用-PureComponent-和-React-memo-以避免不必要的-render-调用"><a href="#使用-PureComponent-和-React-memo-以避免不必要的-render-调用" class="headerlink" title="使用 PureComponent 和 React.memo 以避免不必要的 render 调用"></a>使用 PureComponent 和 React.memo 以避免不必要的 render 调用</h3><p>我们在之前的例子中看到将特定状态值放到更低的层级来避免不必要渲染的方法，不过这并不总是有用。</p>
<p>我们来看下下面的例子：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">"react-dom"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [isFooVisible, setFooVisibility] = useState(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &#123;isFooVisible ? (</span><br><span class="line">        &lt;Foo hideFoo=&#123;() =&gt; setFooVisibility(<span class="literal">false</span>)&#125; /&gt;</span><br><span class="line">      ) : (</span><br><span class="line">        &lt;button onClick=&#123;() =&gt; setFooVisibility(<span class="literal">true</span>)&#125;&gt;Show Foo &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      )&#125;</span></span><br><span class="line"><span class="regexp">      &lt;Bar name="Bar" /</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function Foo(&#123; hideFoo &#125;) &#123;</span></span><br><span class="line"><span class="regexp">  return (</span></span><br><span class="line"><span class="regexp">    &lt;&gt;</span></span><br><span class="line"><span class="regexp">      &lt;h1&gt;Foo&lt;/</span>h1&gt;</span><br><span class="line">      &lt;button onClick=&#123;hideFoo&#125;&gt;Hide Foo&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Bar</span>(<span class="params">&#123; name &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rootElement = <span class="built_in">document</span>.getElementById(<span class="string">"root"</span>);</span><br><span class="line">ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>, rootElement);</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到，只要父组件 App 的状态值 isFooVisible 发生变化，Foo 和 Bar 就都会被重新渲染。</p>
<p>这里因为为了决定 Foo 是否要被渲染出来，我们需要将 isFooVisible 放在 App中维护，因此也就不能将状态拆出放到更低的层级。</p>
<p>不过，在 isFooVisible 发生变化时重新渲染 Bar 仍然是不必要的，因为 Bar 并不依赖 isFooVisible。我们只希望 Bar 在传入属性 name 变化时重新渲染。</p>
<p>那我们该怎么搞呢？两种方法。</p>
<p>其一，对 Bar 做记忆化（memoize）：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Bar = React.memo(<span class="function"><span class="keyword">function</span> <span class="title">Bar</span>(<span class="params">&#123;name&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>这就能保证 Bar 只在 name 发生变化时才重新渲染。</p>
<p>此外，另一个方法就是让 Bar 继承<strong> <font color="#ff0000"> React.PureComponent </font> </strong>而非 React.Component：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bar</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">PureComponent</span> </span>&#123;</span><br><span class="line"> render() &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>是不是很熟悉？我们经常提到使用 React.PureComponent 能带来一定的性能提升，避免不必要的 render。</p>
<p>总结：<strong> <font color="#ff0000"> 避免组件不必要的渲染的方法有：React.memo 包裹的函数式组件，继承自 React.PureComponent 的 class 组件 。</font> </strong></p>
<h4 id="为什么不让每个组件都继承-PureComponent-或者用-memo-包呢？"><a href="#为什么不让每个组件都继承-PureComponent-或者用-memo-包呢？" class="headerlink" title="为什么不让每个组件都继承 PureComponent 或者用 memo 包呢？"></a>为什么不让每个组件都继承 PureComponent 或者用 memo 包呢？</h4><p>如果这条建议可以让我们避免不必要的重新渲染，那我们为什么不把每个 class 组件变成 PureComponent、把每个函数式组件用 React.memo 包起来？为什么有了更好的方法还要保留 React.Component 呢？为什么函数式组件不默认记忆化呢？</p>
<p>毫无疑问，这些方法并不总是万灵药。</p>
<h5 id="嵌套对象的问题"><a href="#嵌套对象的问题" class="headerlink" title="嵌套对象的问题"></a>嵌套对象的问题</h5><p>我们先来考虑下 PureComponent 和 React.memo 的组件到底做了什么？</p>
<p>每次更新的时候（包括状态更新或上层组件重新渲染），它们就会在新 props、state 和旧 props、state 之间对 key 和 value 进行浅比较。浅比较是个严格相等的检查，如果检测到差异，render 就会执行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本类型的比较</span></span><br><span class="line">shallowCompare(&#123; <span class="attr">name</span>: <span class="string">'bar'</span>&#125;, &#123; <span class="attr">name</span>: <span class="string">'bar'</span>&#125;); <span class="comment">// output: true</span></span><br><span class="line">shallowCompare(&#123; <span class="attr">name</span>: <span class="string">'bar'</span>&#125;, &#123; <span class="attr">name</span>: <span class="string">'bar1'</span>&#125;); <span class="comment">// output: false</span></span><br></pre></td></tr></table></figure>
<p>尽管基本类型（如字符串、数字、布尔）的比较可以工作的很好，但对象这类复杂的情况可能就会带来意想不到的行为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shallowCompare(&#123; <span class="attr">name</span>: &#123;<span class="attr">first</span>: <span class="string">'John'</span>, <span class="attr">last</span>: <span class="string">'Schilling'</span>&#125;&#125;,</span><br><span class="line">			   &#123; <span class="attr">name</span>: &#123;<span class="attr">first</span>: <span class="string">'John'</span>, <span class="attr">last</span>: <span class="string">'Schilling'</span>&#125;&#125;); <span class="comment">// output: false</span></span><br></pre></td></tr></table></figure>
<p>上述两个 name 对应的对象的引用是不同的。</p>
<p>我们重新看下之前的例子，然后修改我们传入 Bar 的 props：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">"react-dom"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Bar = React.memo(<span class="function"><span class="keyword">function</span> <span class="title">Bar</span>(<span class="params">&#123; name: &#123; first, last &#125; &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"Bar render"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;h1&gt;</span><br><span class="line">      &#123;first&#125; &#123;last&#125;</span><br><span class="line">    &lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function Foo(&#123; hideFoo &#125;) &#123;</span></span><br><span class="line"><span class="regexp">  return (</span></span><br><span class="line"><span class="regexp">    &lt;&gt;</span></span><br><span class="line"><span class="regexp">      &lt;h1&gt;Foo&lt;/</span>h1&gt;</span><br><span class="line">      &lt;button onClick=&#123;hideFoo&#125;&gt;Hide Foo&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [isFooVisible, setFooVisibility] = useState(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">      &#123;isFooVisible ? (</span><br><span class="line">        &lt;Foo hideFoo=&#123;() =&gt; setFooVisibility(<span class="literal">false</span>)&#125; /&gt;</span><br><span class="line">      ) : (</span><br><span class="line">        &lt;button onClick=&#123;() =&gt; setFooVisibility(<span class="literal">true</span>)&#125;&gt;Show Foo&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      )&#125;</span></span><br><span class="line"><span class="regexp">      &lt;Bar name=&#123;&#123; first: "John", last: "Schilling" &#125;&#125; /</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const rootElement = document.getElementById("root");</span></span><br><span class="line"><span class="regexp">ReactDOM.render(&lt;App /</span>&gt;, rootElement);</span><br></pre></td></tr></table></figure></p>
<p>尽管 Bar 做了记忆化且 props 值并没有发生变动，每次父组件重新渲染时它仍然会重新渲染。这是因为尽管每次比较的两个对象拥有相同的值，引用并不同。</p>
<h5 id="函数-props-的问题"><a href="#函数-props-的问题" class="headerlink" title="函数 props 的问题"></a>函数 props 的问题</h5><p>我们也可以把函数作为 props 向组件传递，当然，在 JavaScript 中函数也会传递引用，因此浅比较也是基于其传递的引用。</p>
<p><strong>因此，如果我们传递的是箭头函数（匿名函数），组件仍然会在父组件重新渲染时重新渲染</strong>。</p>
<h3 id="更好的-props-写法"><a href="#更好的-props-写法" class="headerlink" title="更好的 props 写法"></a>更好的 props 写法</h3><p>前面的问题的一种解决方法是改写我们的 props。</p>
<p>我们不传递对象作为 props，而是<strong>将对象拆分成基本类型</strong>：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Bar</span> <span class="attr">firstName</span>=<span class="string">"John"</span> <span class="attr">lastName</span>=<span class="string">"Schilling"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>而对于传递箭头函数的场景，我们可以代以只唯一声明过一次的函数，从而总可以拿到相同的引用，如下所示：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">this</span>.doSomethingMethod = <span class="keyword">this</span>.doSomethingMethod.bind(<span class="keyword">this</span>);    </span><br><span class="line">  &#125;</span><br><span class="line">  doSomethingMethod () &#123; <span class="comment">// do something&#125;</span></span><br><span class="line">  </span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Bar</span> <span class="attr">onSomething</span>=<span class="string">&#123;this.doSomethingMethod&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="控制更新"><a href="#控制更新" class="headerlink" title="控制更新"></a>控制更新</h3><p>还是那句话，任何方法总有其适用范围。</p>
<p>第三条建议虽然处理了不必要的更新问题，但我们也不总能使用它。</p>
<p>而第四条，在某些情况下我们并不能拆分对象，如果我们传递了某种嵌套确实复杂的数据结构，那我们也很难将其拆分开来。</p>
<p>不仅如此，我们也不总能传递只声明了一次的函数。比如在我们的例子中，如果 App 是个函数式组件，恐怕就不能做到这一点了（在 class 组件中，我们可以用 bind 或者类内箭头函数来保证 this 的指向及唯一声明，而在函数式组件中则可能会有些问题）。</p>
<p>幸运的是，<strong> <font color="#ff0000"> 无论是 class 组件还是函数式组件，我们都有办法控制浅比较的逻辑 。</font></strong></p>
<p><table><tr><td bgcolor="#FF00FF"> 在 class 组件中，我们可以使用生命周期钩子 <code>shouldComponentUpdate(prevProps, prevState)</code> 来返回一个布尔值，当返回值为 true 时才会触发 render。常用Immutable.js库的is()比较。</td></tr></table> <strong> <a href="https://juejin.im/post/5c62ae34e51d450aab0a373f#heading-17" target="_blank" rel="noopener">Immutable.js了解一下？</a> </strong></p>
<p>而如果我们使用 React.memo，我们可以传递一个比较函数作为第二个参数。</p>
<blockquote>
<p><strong>注意！</strong>React.memo 的第二参数（比较函数）和 <code>shouldComponentUpdate</code> 的逻辑是相反的，只有当返回值为 false 的时候才会触发 render。<a href="https://link.juejin.im?target=https%3A%2F%2Freactjs.org%2Fdocs%2Freact-api.html%23reactmemo" target="_blank" rel="noopener">参考文档</a>。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Bar = React.memo(</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Bar</span>(<span class="params">&#123; name: &#123; first, last &#125; &#125;</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"update"</span>);</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;h1&gt;</span><br><span class="line">        &#123;first&#125; &#123;last&#125;</span><br><span class="line">      &lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">  (prevProps, newProps) =&gt;</span></span><br><span class="line"><span class="regexp">    prevProps.name.first === newProps.name.first &amp;&amp;</span></span><br><span class="line"><span class="regexp">    prevProps.name.last === newProps.name.last</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure>
<p>尽管这条建议是可行的，但我们仍要注意<strong>比较函数的性能开销</strong>。如果 props 对象过深，反而会消耗不少的性能。</p>
<hr>
<h2 id="PureComponent-Vs-Component"><a href="#PureComponent-Vs-Component" class="headerlink" title="PureComponent Vs Component"></a>PureComponent Vs Component</h2><p>它们几乎完全相同，但是PureComponent通过prop和state的浅比较来实现shouldComponentUpdate，某些情况下可以用PureComponent提升性能</p>
<ol>
<li>所谓<code>浅比较</code>(shallowEqual)，即react源码中的一个函数，然后根据下面的方法进行是不是<code>PureComponent</code>的判断，帮我们做了本来应该我们在<code>shouldComponentUpdate</code>中做的事情<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>._compositeType === CompositeTypes.PureClass) &#123;</span><br><span class="line">  shouldUpdate = !shallowEqual(prevProps, nextProps) || ! shallowEqual(inst.state, nextState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>而本来我们做的事情如下，这里判断了<code>state</code>有没有发生变化（prop同理），从而决定要不要重新渲染，这里的函数在一个继承了<code>Component</code>的组件中，而这里<code>this.state.person</code>是一个对象，你会发现，在这个对象的引用没有发生变化的时候是不会重新<code>render</code>的（即下面提到的第三点），所以我们可以用<code>shouldComponentUpdate</code>进行优化，这个方法如果返回<code>false</code>，表示不需要重新进行渲染，返回<code>true</code>则重新渲染，默认返回<code>true</code><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shouldComponentUpdate(nextProps, nextState) &#123;</span><br><span class="line">   <span class="keyword">return</span> (nextState.person !== <span class="keyword">this</span>.state.person);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li><p>上面提到的某些情况下可以使用<code>PureComponent</code>来提升性能，那具体是哪些情况可以，哪些情况不可以呢，实践出真知</p>
</li>
<li><p>如下显示的是一个<code>IndexPage</code>组件，设置了一个<code>state</code>是<code>isShow</code>，通过一个按钮点击可以改变它的值，</p>
</li>
</ol>
<p>结果是：初始化的时候输出的是<code>constructor</code>，<code>render</code>，而第一次点击按钮，会输出一次render，即重新渲染了一次，界面也会从显示<code>false</code>变成显示<code>true</code>，</p>
<p>但是当这个组件是继承自<code>PureComponent</code>的时候，再点击的时，不会再输出<code>render</code>，即不会再重新渲染了，而当这个组件是继承自<code>Component</code>时，还是会输出<code>render</code>，还是会重新渲染，这时候就是<code>PureComponent</code>内部做了优化的体现</p>
<ol start="4">
<li><p>同理也适用于<code>string</code>，<code>number</code>等基本数据类型，因为基本数据类型，值改变了就算改变了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexPage</span> <span class="keyword">extends</span> <span class="title">PureComponent</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      isShow: <span class="literal">false</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'constructor'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  changeState = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">      isShow: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'render'</span>);</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="keyword">this</span>.changeState&#125;&gt;点击&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">        &lt;div&gt;&#123;this.state.isShow.toString()&#125;&lt;/</span>div&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>当这个<code>this.state.arr</code>是一个数组时，且这个组件是继承自<code>PureComponent</code>时，初始化依旧是输出<code>constructor</code>和<code>render</code>，但是当点击按钮时，界面上没有变化，也没有输出<code>render</code>，证明没有渲染，但是我们可以从下面的注释中看到，每点击一次按钮，我们想要修改的<code>arr</code>的值已经改变，而这个值将去修改<code>this.state.arr</code>,但是因为在<code>PureComponent</code>中<code>浅比较</code>这个数组的引用没有变化所以没有渲染，<code>this.state.arr</code>也没有更新，因为在<code>this.setState()</code>以后，值是在<code>render</code>的时候更新的，这里涉及到<code>this.setState()</code>的知识</p>
</li>
<li><p>但是当这个组件是继承自<code>Component</code>的时候，初始化依旧是输出<code>constructor</code>和<code>render</code>，但是当点击按钮时，界面上出现了变化，即我们打印处理的<code>arr</code>的值输出，而且每点击一次按钮都会输出一次<code>render</code>，证明已经重新渲染，<code>this.state.arr</code>的值已经更新，所以我们能在界面上看到这个变化</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexPage</span> <span class="keyword">extends</span> <span class="title">PureComponent</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      arr:[<span class="string">'1'</span>]</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'constructor'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  changeState = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; arr &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    arr.push(<span class="string">'2'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(arr);</span><br><span class="line">    <span class="comment">// ["1", "2"]</span></span><br><span class="line">    <span class="comment">// ["1", "2", "2"]</span></span><br><span class="line">    <span class="comment">// ["1", "2", "2", "2"] </span></span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">      arr</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'render'</span>);</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="keyword">this</span>.changeState&#125;&gt;点击&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">        &lt;div&gt;</span></span><br><span class="line"><span class="regexp">          &#123;this.state.arr.map((item) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">            return item;</span></span><br><span class="line"><span class="regexp">          &#125;)&#125;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>div&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>7.下面的例子用<code>扩展运算符</code>产生新数组，使<code>this.state.arr</code>的引用发生了变化，所以初始化的时候输出<code>constructor</code>和<code>render</code>后，每次点击按钮都会输出<code>render</code>，界面也会变化，不管该组件是继承自<code>Component</code>还是<code>PureComponent</code>的<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexPage</span> <span class="keyword">extends</span> <span class="title">PureComponent</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      arr:[<span class="string">'1'</span>]</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'constructor'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  changeState = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; arr &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">      arr: [...arr, <span class="string">'2'</span>]</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'render'</span>);</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="keyword">this</span>.changeState&#125;&gt;点击&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">        &lt;div&gt;</span></span><br><span class="line"><span class="regexp">          &#123;this.state.arr.map((item) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">            return item;</span></span><br><span class="line"><span class="regexp">          &#125;)&#125;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>div&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>8.上面的情况同样适用于<code>对象</code>的情况</p>
<h3 id="PureComponent不仅会影响本身，而且会影响子组件，所以PureComponent最佳情况是展示组件"><a href="#PureComponent不仅会影响本身，而且会影响子组件，所以PureComponent最佳情况是展示组件" class="headerlink" title="PureComponent不仅会影响本身，而且会影响子组件，所以PureComponent最佳情况是展示组件"></a>PureComponent不仅会影响本身，而且会影响子组件，所以PureComponent最佳情况是展示组件</h3><p>1.我们让<code>IndexPage</code>组件里面包含一个子组件<code>Example</code>来展示<code>PureComponent</code>是如何影响子组件的</p>
<p>2.父组件继承<code>PureComponent</code>，子组件继承<code>Component</code>时：下面的结果初始化时输出为<code>constructor</code>，<code>IndexPage render</code>，<code>example render</code>，但是当我们点击按钮时，界面没有变化，因为这个<code>this.state.person</code>对象的引用没有改变，只是改变了它里面的属性值所以尽管子组件是继承<code>Component</code>的也没有办法渲染，因为父组件是<code>PureComponent</code>，父组件根本没有渲染，所以子组件也不会渲染</p>
<p>3.父组件继承<code>PureComponent</code>，子组件继承<code>PureComponent</code>时：因为渲染在父组件的时候就没有进行，相当于被拦截了，所以子组件是<code>PureComponent</code>还是<code>Component</code>根本不会影响结果，界面依旧没有变化</p>
<p>4.父组件继承<code>Component</code>，子组件继承<code>PureComponent</code>时：结果和我们预期的一样，即初始化是会输出<code>constructor</code>，<code>IndexPage render</code>，<code>example render</code>，但是点击的时候只会出现<code>IndexPage render</code>，因为父组件是<code>Component</code>，所以父组件会渲染，但是</p>
<p>当父组件把值传给子组件的时候，因为子组件是<code>PureComponent</code>，所以它会对<code>prop</code>进行浅比较，发现这个<code>person</code>对象的引用没有发生变化，所以不会重新渲染，而界面显示是由子组件显示的，所以界面也不会变化</p>
<p>5.父组件继承<code>Component</code>，子组件继承<code>Component</code>时：初始化是会输出<code>constructor</code>，<code>IndexPage render</code>，<code>example render</code>，当我们第一次点击按钮以后，界面发生变化，后面就不再改变，因为我们一直把它设置为sxt2，但是每点击一次都会输出<code>IndexPage render</code>，<code>example render</code>，因为每次不管父组件还是子组件都会渲染</p>
<p>6.所以正如下面第四条说的，如果<code>state</code>和<code>prop</code>一直变化的话，还是建议使用<code>Component</code>，并且<code>PureComponent</code>的最好作为展示组件</p>
<pre><code class="js"><span class="comment">//父组件</span>
<span class="keyword">import</span> React, { PureComponent, Component } <span class="keyword">from</span> <span class="string">'react'</span>;
<span class="keyword">import</span> Example <span class="keyword">from</span> <span class="string">"../components/Example"</span>;

<span class="class"><span class="keyword">class</span> <span class="title">IndexPage</span> <span class="keyword">extends</span> <span class="title">PureComponent</span></span>{
  <span class="keyword">constructor</span>() {
    <span class="keyword">super</span>();
    <span class="keyword">this</span>.state = {
      person: {
        name: <span class="string">'sxt'</span>
      }
    };
    <span class="built_in">console</span>.log(<span class="string">'constructor'</span>);
  }
  changeState = <span class="function"><span class="params">()</span> =&gt;</span> {
    <span class="keyword">let</span> { person } = <span class="keyword">this</span>.state;
    person.name = <span class="string">'sxt2'</span>;
    <span class="keyword">this</span>.setState({
      person
    })
  };
  render() {
    <span class="built_in">console</span>.log(<span class="string">'IndexPage render'</span>);
    <span class="keyword">const</span> { person } = <span class="keyword">this</span>.state;
    <span class="keyword">return</span> (
      &lt;div&gt;
        &lt;button onClick={<span class="keyword">this</span>.changeState}&gt;点击&lt;<span class="regexp">/button&gt;</span>
<span class="regexp">        &lt;Example person={person} /</span>&gt;
      &lt;<span class="regexp">/div&gt;</span>
<span class="regexp">    );</span>
<span class="regexp">  }</span>
<span class="regexp">}</span>
<span class="regexp">/</span><span class="regexp">/子组件</span>
<span class="regexp">import React, { Component } from 'react';</span>
<span class="regexp"></span>
<span class="regexp">class Example extends Component {</span>
<span class="regexp"></span>
<span class="regexp">  render() {</span>
<span class="regexp">    console.log('example render');</span>
<span class="regexp">    const { person } = this.props;</span>
<span class="regexp">    return(</span>
<span class="regexp">      &lt;div&gt;</span>
<span class="regexp">        {person.name}</span>
<span class="regexp">      &lt;/</span>div&gt;
    );
  }
}
</code></pre>
<h3 id="三-若是数组和对象等引用类型，则要引用不同，才会渲染"><a href="#三-若是数组和对象等引用类型，则要引用不同，才会渲染" class="headerlink" title="三.若是数组和对象等引用类型，则要引用不同，才会渲染"></a>三.若是数组和对象等引用类型，则要引用不同，才会渲染</h3><h3 id="四-如果prop和state每次都会变，那么PureComponent的效率还不如Component，因为你知道的，进行浅比较也是需要时间"><a href="#四-如果prop和state每次都会变，那么PureComponent的效率还不如Component，因为你知道的，进行浅比较也是需要时间" class="headerlink" title="四.如果prop和state每次都会变，那么PureComponent的效率还不如Component，因为你知道的，进行浅比较也是需要时间"></a>四.如果prop和state每次都会变，那么PureComponent的效率还不如Component，因为你知道的，进行浅比较也是需要时间</h3><h3 id="五-若有shouldComponentUpdate，则执行它，若没有这个方法会判断是不是PureComponent，若是，进行浅比较"><a href="#五-若有shouldComponentUpdate，则执行它，若没有这个方法会判断是不是PureComponent，若是，进行浅比较" class="headerlink" title="五.若有shouldComponentUpdate，则执行它，若没有这个方法会判断是不是PureComponent，若是，进行浅比较"></a>五.若有shouldComponentUpdate，则执行它，若没有这个方法会判断是不是PureComponent，若是，进行浅比较</h3><p>1.继承自<code>Component</code>的组件，若是<code>shouldComponentUpdate</code>返回<code>false</code>，就不会渲染了，继承自<code>PureComponent</code>的组件不用我们手动去判断<code>prop</code>和<code>state</code>，所以在<code>PureComponent</code>中使用<code>shouldComponentUpdate</code>会有如下警告:</p>
<p><strong>IndexPage has a method called shouldComponentUpdate(). shouldComponentUpdate should not be used when extending React.PureComponent. Please extend React.Component if shouldComponentUpdate is used.</strong></p>
<p>也是比较好理解的，就是不要在<code>PureComponent</code>中使用<code>shouldComponentUpdate</code>，因为根本没有必要.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/tx.jpg" alt="李斌">
            
              <p class="site-author-name" itemprop="name">李斌</p>
              <p class="site-description motion-element" itemprop="description">想要飞得高，那就把地平线忘掉</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">154</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">109</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/libin1991" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://juejin.im/user/57e737f6c4c971005f6bcd8d" target="_blank" title="juejin">
                      
                        <i class="fa fa-fw fa-spinner"></i>juejin</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李斌</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
<script type="text/javascript" src="/js/src/clicklove.js"></script>

