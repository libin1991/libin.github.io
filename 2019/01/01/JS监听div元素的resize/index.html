<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Event Loop,js,nextTick,">










<meta name="description" content="在实现一个自定义滚动条需求的时候，需要监听到某个div元素的宽高变化，第一时间想到的是resize事件，但是很不幸运的是，resize事件只能加在window对象上，并不能监听具体某个DOM元素。 多方查阅之后，了解到MutationObserver和Resize Observer,  DOMSubtreeModified ,迫不及待的直接看直接看   resize-detector实现方式">
<meta name="keywords" content="Event Loop,js,nextTick">
<meta property="og:type" content="article">
<meta property="og:title" content="JS监听div元素的resize">
<meta property="og:url" content="http://yoursite.com/2019/01/01/JS监听div元素的resize/index.html">
<meta property="og:site_name" content="Zero Days">
<meta property="og:description" content="在实现一个自定义滚动条需求的时候，需要监听到某个div元素的宽高变化，第一时间想到的是resize事件，但是很不幸运的是，resize事件只能加在window对象上，并不能监听具体某个DOM元素。 多方查阅之后，了解到MutationObserver和Resize Observer,  DOMSubtreeModified ,迫不及待的直接看直接看   resize-detector实现方式">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2019/01/01/JS监听div元素的resize/1.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/01/JS监听div元素的resize/2.webp">
<meta property="og:image" content="http://yoursite.com/2019/01/01/JS监听div元素的resize/7.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/01/JS监听div元素的resize/8.jpg">
<meta property="og:image" content="http://yoursite.com/2019/01/01/JS监听div元素的resize/3.gif">
<meta property="og:image" content="http://yoursite.com/2019/01/01/JS监听div元素的resize/4.webp">
<meta property="og:image" content="http://yoursite.com/2019/01/01/JS监听div元素的resize/5.png">
<meta property="og:image" content="http://yoursite.com/2019/01/01/JS监听div元素的resize/6.webp">
<meta property="og:updated_time" content="2019-11-11T14:31:27.285Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JS监听div元素的resize">
<meta name="twitter:description" content="在实现一个自定义滚动条需求的时候，需要监听到某个div元素的宽高变化，第一时间想到的是resize事件，但是很不幸运的是，resize事件只能加在window对象上，并不能监听具体某个DOM元素。 多方查阅之后，了解到MutationObserver和Resize Observer,  DOMSubtreeModified ,迫不及待的直接看直接看   resize-detector实现方式">
<meta name="twitter:image" content="http://yoursite.com/2019/01/01/JS监听div元素的resize/1.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/01/01/JS监听div元素的resize/">





  <title>JS监听div元素的resize | Zero Days</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband">
    	<div class="eevee"><div class="body"><div class="head"><div class="ears"><div class="ear"><div class="lobe"></div></div><div class="ear"><div class="lobe"></div></div></div><div class="face"><div class="eyes"><div class="eye"><div class="eyelid"></div></div><div class="eye"><div class="eyelid"></div></div></div><div class="nose"></div><div class="mouth"></div></div></div><div class="chest"><div class="fur"><div class="patch"></div></div><div class="fur"><div class="patch"></div></div><div class="fur"><div class="patch"></div></div></div><div class="legs"><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div></div><div class="tail"><div class="tail"><div class="tail"><div class="tail"><div class="tail"><div class="tail -end"></div></div></div></div></div></div></div></div>
    </div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
    	<div id="sky">
				<div id="background" class="container">
			<!-- svg file -->
			<svg id="svgout" height="100%" width="100%" viewbox="0 0 550 400">
				<defs>
					<g id="bottomShadow">
						<path fill="#000000" stroke="none" d="
		M 270.5 225.95
		L 127.35 316.65 266.8 400 409.6 309.25 270.5 225.95 Z"/>
					</g>
					<g id="Layer52_0_FILL">
						<path class="topGrass" fill="#B9D668" stroke="none" d="
	M 397.85 229.3
	L 397.85 225.6 269.85 152 135.75 228.6 135.75 233.65 262.1 306.55 397.85 229.3 Z"/>
					</g>
					<g id="Layer51_0_FILL">
						<path class="leftSideGrass" fill="#6E9E4F" stroke="none" d="
	M 135.1 229.95
	L 135.1 256.85 262.1 328.4 262.1 301.85 135.1 229.95 Z"/>
					</g>
					<g id="Layer50_0_FILL">
						<path class="rightGrassTop" fill="#8CB154" stroke="none" d="
	M 397.85 225.95
	L 395.8 225.95 261.75 301.55 261.75 328.4 397.85 251.15 397.85 225.95 Z"/>
					</g>
					<g id="Layer48_0_FILL">
						<path class="crustLeftTop" fill="#955541" stroke="none" d="
	M 135.45 282.4
	L 135.75 298.15 262.1 372.1 261.75 355.65 135.45 282.4 Z"/>
					</g>
					<g id="Layer47_0_FILL">
						<path class="middleLeftCrust" fill="#C77E61" stroke="none" d="
	M 135.1 270.3
	L 135.1 283.05 275.9 364.35 271.85 348.9 135.1 270.3 Z"/>
					</g>
					<g id="Layer46_0_FILL">
						<path class="crustLeftTop" fill="#955541" stroke="none" d="
	M 135.1 255.15
	L 135.1 270.3 262.1 343.55 262.1 328.05 135.1 255.15 Z"/>
					</g>
					<g id="Layer45_0_FILL">
						<path class="topRightCrust" fill="#A47237" stroke="none" d="
	M 397.5 294.5
	L 397.5 277 261.75 355.3 261.75 372.75 397.5 294.5 Z"/>
					</g>
					<g id="Layer44_0_FILL">
						<path class="middleRightCrust" fill="#C89451" stroke="none" d="
	M 397.5 269.95
	L 397.15 266.6 262.1 343.2 262.1 355.95 397.5 279.7 397.5 269.95 Z"/>
					</g>
					<g id="Layer43_0_FILL">
						<path class="topRightCrust" fill="#A47237" stroke="none" d="
	M 397.5 266.6
	L 397.5 250.45 261.75 328.4 261.75 343.85 397.5 266.6 Z"/>
					</g>
					<g id="Layer41_0_FILL">
						<path class="greyRoad" fill="#B2B2B1" stroke="none" d="
	M 295.05 283.05
	Q 299.05 280.35 308.45 275.3 317.85 269.95 323.6 266.9
	L 268.8 233.65 338.05 191.35 309.15 174.55 177.75 254.5
	Q 191.55 262.2 198.25 266.25 204.65 269.95 209.7 271.95
	L 241.6 250.45 295.05 283.05 Z"/>
					</g>
					<g id="Layer40_0_FILL">
						<path fill="#FFFFFF" stroke="none" d="
	M 199.95 256.85
	Q 194.55 261.2 191.9 262.2
	L 194.9 263.9 200.95 259.2 199.95 256.85
	M 225.8 243.75
	L 224.8 241.75 211.05 250.8 212.05 252.8 225.8 243.75
	M 308.15 275.65
	L 296.7 266.6 295.35 268.6 306.8 277.7 308.15 275.65
	M 275.9 253.5
	L 274.55 255.5 285.95 264.55 287.3 262.55 275.9 253.5
	M 251.7 227.3
	L 250.7 225.25 236.9 234.35 237.9 236.35 251.7 227.3
	M 257.05 240.7
	L 254.05 240.7 268.8 249.8 269.5 247.75 257.05 240.7
	M 277.2 207.8
	L 263.45 216.85 264.45 218.9 278.25 209.8 277.2 207.8
	M 305.1 192.65
	L 304.1 190.65 290.3 199.75 291.35 201.75 305.1 192.65 Z"/>
					</g>
					<g id="Layer38_0_FILL">
						<path class="frontFascia" fill="#ECB27B" stroke="none" d="
	M 359.25 187.95
	L 346.4 174.95 333.85 202.9 359.25 187.95 Z"/>
					</g>
					<g id="Layer37_0_FILL">
						<path class="frontWall" fill="#EFA258" stroke="none" d="
	M 334 201.05
	L 334.35 232 359.2 217.55 359.25 187.95 334 201.05 Z"/>
					</g>
					<g id="Layer36_0_FILL">
						<path class="leftWall" fill="#C57F42" stroke="none" d="
	M 334.35 232.3
	L 334.35 205.1 305.1 191.35 305.1 216.85 334.35 232.3 Z"/>
					</g>
					<g id="Layer35_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 329.7 167.9
	L 331.05 167.9 344.55 176.7 347.85 176.7 363 192.25 363.15 189.55 350.65 176.7 350.55 176.7 334.25 167.5 334.25 159.1 329.7 159.1 329.7 164.9 322.65 160.95 322.3 162.15 329.7 167 329.7 167.9 Z"/>
					</g>
					<g id="Layer34_0_FILL">
						<path class="leftRoof" fill="#F2563B" stroke="none" d="
	M 334.05 207.05
	L 350.65 176.7 322.1 160.45 302.1 192.05 334.05 207.05 Z"/>
					</g>
					<g id="Layer30_0_FILL">
						<path id="windowFour" class="windows" stroke="none" fill="#975A42" d="
	M 341.35 203.3
	Q 340.9 203.45 340.5 203.8 340.1 204.2 339.85 204.75 339.7 205 339.7 205.3 339.6 205.75 339.7 206.1 339.7 206.15 339.7 206.2 339.8 206.5 340 206.8 340.55 207.4 341.45 207.4 342.35 207.4 343 206.8 343.4 206.5 343.65 206.1 343.85 205.75 343.95 205.3 344.05 204.4 343.55 203.8 343.3 203.45 343 203.3 342.65 203.15 342.2 203.15 341.8 203.15 341.35 203.3
	M 355.85 198.45
	Q 355.8 198.2 355.6 198 355.1 197.4 354.2 197.4 353.35 197.4 352.6 198 351.85 198.65 351.7 199.55 351.7 199.7 351.7 199.85 351.6 200.5 352 201.05 352.55 201.65 353.45 201.65 354.3 201.65 355.05 201.05 355.45 200.7 355.7 200.25 355.8 200.05 355.9 199.85 355.95 199.7 355.95 199.55 356.05 198.95 355.85 198.45 Z"/>
						<path class="door" fill="#B65041" stroke="none" d="
	M 351.95 211.2
	L 351.8 211.2 346.05 215.1 346.05 225.2 351.95 221.6 351.95 211.2
	M 351.2 211.2
	L 351.35 211.2 351.35 211.1 351.2 211.2 Z"/>
					</g>
					<g>
						<path id="Layer30_0_FILL" fill="#000000" fill-opacity="1" stroke="none" d="
	M 183.7 215.3
	L 183.7 215.6
	Q 187.25 231.75 212.25 234.35
	L 183.7 215.3 Z"/>
					</g>
					<g id="Layer29_0_FILL">
						<path fill="#000000" fill-opacity="0.4" stroke="none" d="
	M 305.1 216.85
	L 305.15 217.2
	Q 309.45 233.2 334.35 232.3
	L 305.1 216.85 Z"/>
					</g>
					<g id="Layer27_0_FILL">
						<path class="vegetation" fill="#78A950" stroke="none" d="
	M 177.45 231.65
	Q 175.75 235.35 181.8 239.35 185.5 235.7 185.15 231.3 182.8 230.65 181.45 234 179.45 231.3 177.45 231.65
	M 236.9 266.6
	Q 235.2 270.3 241.25 274.3 244.95 270.6 244.65 266.25 242.3 265.6 240.95 268.95 238.9 266.25 236.9 266.6
	M 254.7 277
	Q 253.05 280.7 259.1 284.75 262.75 281.05 262.45 276.65 260.1 276 258.75 279.35 256.7 276.65 254.7 277
	M 315.5 245.75
	Q 313.5 243.05 311.5 243.4 309.8 247.1 315.85 251.15 319.55 247.45 319.2 243.05 316.85 242.4 315.5 245.75
	M 295.35 232.65
	Q 293.7 236.35 299.75 240.4 303.45 236.7 303.1 232.3 300.75 231.65 299.4 235 297.4 232.3 295.35 232.65
	M 277.2 171.85
	Q 275.55 175.55 281.6 179.55 285.3 175.85 284.95 171.5 282.6 170.85 281.25 174.2 279.25 171.5 277.2 171.85 Z"/>
					</g>
					<g id="Layer26_0_FILL">
						<path class="treeWood" fill="#AE663D" stroke="none" d="
	M 175.1 177.55
	L 172.05 177.55 172.05 191.1 159.3 172.85
	Q 154.6 171.5 172.05 195.7
	L 172.05 212.5 175.1 212.5 175.1 177.55
	M 252.7 151.35
	L 249 151.35 249 176.9 252.7 176.9 252.7 151.35 Z"/>
					</g>
					<g id="Layer25_0_FILL">
						<path class="vegetation" fill="#77A951" stroke="none" d="
	M 192.55 179.55
	Q 200.95 173.5 200.95 165.1 200.95 156.4 192.55 150 184.15 144.3 172.05 144.3 160.3 144.3 151.9 150 143.15 156.4 143.15 165.1 143.15 173.5 151.9 179.55 160.3 185.95 172.05 185.95 184.15 185.95 192.55 179.55
	M 236.25 106.65
	Q 230.2 116.05 230.2 129.15 230.2 142.25 236.25 151.35 242.3 160.75 250.7 160.75 258.75 160.75 264.8 151.35 270.85 142.25 270.85 129.15 270.85 116.05 264.8 106.65 258.75 97.6 250.7 97.6 242.3 97.6 236.25 106.65 Z"/>
					</g>
					<g id="Layer24_0_FILL">
						<path class="vegetation" fill="#77A951" stroke="none" d="
	M 158.3 221.9
	Q 160.65 221.9 161.95 220.2 163 219.55 163.3 218.55 164.65 218.9 166.35 218.9 170.05 218.9 172.4 216.2 175.1 213.85 175.1 210.15 175.1 206.45 172.4 203.75 170.05 201.4 166.35 201.4 162.65 201.4 159.95 203.75 157.6 206.45 157.6 210.15 157.6 210.8 157.6 211.15 155.95 211.5 154.6 212.5 152.9 214.15 152.9 216.55 152.9 218.9 154.6 220.2 156.25 221.9 158.3 221.9
	M 338.35 240.05
	Q 341.05 237.7 341.05 234 341.05 230.3 338.35 227.6 336 225.25 332.3 225.25 328.65 225.25 325.95 227.6 323.6 230.3 323.6 234 323.6 237.7 325.95 240.05 328.65 242.75 332.3 242.75 336 242.75 338.35 240.05 Z"/>
					</g>
					<g id="Layer22_0_FILL">
						<path class="rightRoof" fill="#D05041" stroke="none" d="
	M 220 173.85
	L 236.8 186.7 264.35 171.15 244.5 159.55 220 173.85 Z"/>
					</g>
					<g id="Layer21_0_FILL">
						<path class="leftWall" fill="#C57F42" stroke="none" d="
	M 212.25 191.35
	L 183.35 172.3 183.7 215.3 212.25 234.35 212.25 191.35 Z"/>
					</g>
					<g id="Layer20_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 192.1 149.85
	L 236.45 174.8 243.1 171.4
	Q 220.05 150.55 196.3 139.95
	L 192.1 149.85 Z"/>
					</g>
					<g id="Layer19_0_FILL">
						<path class="frontFascia" fill="#EBB17B" stroke="none" d="
	M 226.85 160.95
	L 212 190.6 229.75 192.6 239.75 172.85 226.85 160.95 Z"/>
					</g>
					<g id="Layer18_0_FILL">
						<path class="frontWall" fill="#EFA258" stroke="none" d="
	M 240.15 172.65
	L 211.9 191.6 212.25 233.65 264.35 201.7 264.35 170.8 240.8 184.45 240.15 172.65 Z"/>
					</g>
					<g id="Layer17_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 210.9 142.2
	L 205.9 142.2 205.9 152.65 210.9 152.65 210.9 142.2 Z"/>
					</g>
					<g>
						<path id="Layer16_0_FILL" class="leftRoof" fill="#F2563B" stroke="none" d="
	M 210.25 195.5
	L 227.4 160.95 195.45 141.35 177.65 175.85 210.25 195.5 Z"/>
					</g>
					<g>
						<path id="sun" fill="#E3BD0E" stroke="none" d="
	M 257.05 15.95
	Q 251.7 15.95 248 19.65 244.3 23.35 244.3 28.7 244.3 34.1 248 37.8 251.7 41.5 257.05 41.5 262.45 41.5 266.15 37.8 269.85 34.1 269.85 28.7 269.85 23.35 266.15 19.65 262.45 15.95 257.05 15.95 Z"/>
					</g>
					<g id="Layer8_0_FILL">
						<path fill="#975A42" stroke="none" d="
	M 238.45 189.65
	Q 238.295703125 189.362109375 238.05 189.1 237.35 188.3 236.2 188.3 235.05 188.3 234.15 189.1 233.3 189.9 233.2 191.05 233.1 192.2 233.8 193 234.55 193.8 235.7 193.8 236.85 193.8 237.7 193 238.1970703125 192.558203125 238.45 192 238.6552734375 191.56484375 238.7 191.05 238.7671875 190.276953125 238.45 189.65
	M 220.55 197.55
	Q 220 197.55 219.5 197.75 218.95 197.95 218.5 198.35 217.933203125 198.8833984375 217.7 199.55 217.5833984375 199.916796875 217.55 200.3 217.4923828125 200.96171875 217.7 201.5 217.852734375 201.9103515625 218.15 202.25 218.95 203.05 220.1 203.05 221.25 203.05 222.05 202.25 222.95 201.45 223.05 200.3 223.15 199.15 222.4 198.35 222.05 197.95 221.65 197.75 221.15 197.55 220.55 197.55 Z"/>
					</g>
					<g id="Layer7_0_FILL">
						<path class="door" fill="#B65041" stroke="none" d="
	M 233.55 206.75
	L 225.9 211.95 226.25 225.5 233.95 220.35 233.55 206.75 Z"/>
					</g>
					<g>
						<path id="windowOne" class="windows" fill="#975A42" stroke="none" d="
	M 188.65 198.4
	L 188.8 204.1 198.65 210.45 198.55 204.75 188.65 198.4
	M 208.45 216.8
	L 208.35 211.1 198.55 204.75 198.65 210.45 208.45 216.8
	M 188.8 204.1
	L 188.95 209.8 198.8 216.15 198.65 210.45 188.8 204.1
	M 208.6 222.5
	L 208.45 216.8 198.65 210.45 198.8 216.15 208.6 222.5 Z"/>
					</g>
					<g>
						<path id="windowThree" class="windows" fill="#975A42" stroke="none" d="
	M 311.7 214.1
	L 318.55 217.55 318.45 211.9 311.6 208.45 311.7 214.1
	M 325.4 221
	L 325.25 215.35 318.45 211.9 318.55 217.55 325.4 221
	M 318.4 206.2
	L 311.5 202.75 311.6 208.45 318.45 211.9 318.4 206.2
	M 325.25 215.35
	L 325.2 209.7 318.4 206.2 318.45 211.9 325.25 215.35 Z"/>
					</g>
					<g id="Layer2_0_FILL">
						<path class="door" fill="#B65041" stroke="none" d="
	M 259.7 183.25
	L 244.6 191.9 244.6 213.8 259.7 204.55 259.7 183.25 Z"/>
					</g>
					<path id="windowTwo" fill="#975A42" class="windows" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" d="
	M 223.05 200.3
	Q 222.95 201.45 222.05 202.25 221.25 203.05 220.1 203.05 218.95 203.05 218.15 202.25 217.852734375 201.9103515625 217.7 201.5 217.4923828125 200.96171875 217.55 200.3 217.5833984375 199.916796875 217.7 199.575 217.933203125 198.8833984375 218.5 198.35 218.95 197.95 219.5 197.75 220 197.55 220.55 197.55 221.15 197.55 221.65 197.75 222.05 197.95 222.4 198.35 223.15 199.15 223.05 200.3 Z
	M 238.7 191.05
	Q 238.6552734375 191.56484375 238.45 192 238.1970703125 192.558203125 237.7 193 236.85 193.8 235.7 193.8 234.55 193.8 233.8 193 233.1 192.2 233.2 191.05 233.3 189.9 234.15 189.1 235.05 188.3 236.2 188.3 237.35 188.3 238.05 189.1 238.295703125 189.362109375 238.45 189.65 238.7671875 190.276953125 238.7 191.05 Z"/>
					<path fill="#F2563B" stroke="none" d=" M 351.95 211.2 L 351.8 211.2 346.05 215.1 346.05 225.2 351.95 221.6 351.95 211.2 Z"/>
					<path id="Layer6_0_1_STROKES" class="windowRims" stroke="#AE663D" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" fill="none" d="
	M 198.55 204.75
	L 208.35 211.1 208.45 216.8 208.6 222.5 198.8 216.15 188.95 209.8 188.8 204.1 188.65 198.4 198.55 204.75 198.65 210.45 208.45 216.8
	M 198.8 216.15
	L 198.65 210.45 188.8 204.1"/>
					<path id="Layer5_0_1_STROKES" class="windowRims" stroke="#AE663D" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" fill="none" d="
	M 325.25 215.35
	L 325.4 221 318.55 217.55 311.7 214.1 311.6 208.45 311.5 202.75 318.4 206.2 325.2 209.7 325.25 215.35 318.45 211.9 318.55 217.55
	M 318.4 206.2
	L 318.45 211.9 311.6 208.45"/>
				</defs>
				<g id="shadow">
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use xlink:href="#bottomShadow"/>
					</g>
				</g>
				<g transform="matrix( 1, 0, 0, 1, 0,0) ">
					<use xlink:href="#sun"/>
				</g>
				<g id="earth">
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer52_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer51_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer50_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer48_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer47_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer46_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer45_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer44_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer43_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer41_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer40_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer38_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer37_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer36_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer35_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer34_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowFour"/>
						<use class="element" xlink:href="#Layer32_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer30_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer27_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer26_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer25_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer24_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer22_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer21_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer20_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer19_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer18_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer17_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer16_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer8_0_FILL"/>
						<use class="element" xlink:href="#windowTwo"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer7_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowOne"/>
						<use class="element" xlink:href="#Layer6_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowThree"/>
						<use class="element" xlink:href="#Layer5_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer2_0_FILL"/>
					</g>
				</g>
			</svg>
			<! -- End of SVG file -->
			<! -- Moon/Sun Toggle -->
			<div id="toggleButton" class="day-toggle">
				<div class="sun-icon"></div>
				<label class="switch">
            <input id="toggleCheckbox" type="checkbox">
            <div class="slider"></div>
        </label>
				<div class="cloud-icon"></div>
			</div>
			<! -- Moon/Sun Toggle -->
			<! -- End of Container -->
		</div>
			</div>
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zero Days</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">人生如逆旅    我亦是行人</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/01/JS监听div元素的resize/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zero Days">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">JS监听div元素的resize</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-01T20:21:48+08:00">
                2019-01-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>在实现一个<strong>自定义滚动条</strong>需求的时候，需要监听到某个div元素的宽高变化，第一时间想到的是resize事件，但是很不幸运的是，resize事件只能加在window对象上，并不能监听具体某个DOM元素。</p>
<p>多方查阅之后，了解到<span style="border-bottom:2px solid red;"><strong>MutationObserver</strong></span>和<span style="border-bottom:2px solid red;"><strong>Resize Observer</strong></span>, <span style="border-bottom:2px solid red;"> <strong>DOMSubtreeModified </strong></span>,迫不及待的直接看直接看  <a href="#resize-detector实现方式"><font color="#00dd00"><strong> resize-detector实现方式  </strong></font></a> 可以用来监听整个DOM中任何变化的东西，可以把它理解为一个类，实例化之后调用类实例的几个简单接口即可完成监听，以下具体介绍：</p>
<h3 id="MutationObserver介绍"><a href="#MutationObserver介绍" class="headerlink" title="MutationObserver介绍"></a>MutationObserver介绍</h3><h4 id="构造函数为window-MutationObserver，参数为一个回调函数。"><a href="#构造函数为window-MutationObserver，参数为一个回调函数。" class="headerlink" title="构造函数为window.MutationObserver，参数为一个回调函数。"></a>构造函数为window.MutationObserver，参数为一个回调函数。</h4><p>监控到DOM中的改变并且等待一系列改变结束后就会触发回调函数。它与事件的不同之处在于，它在DOM变化时，会记录每一个DOM的变化（为一个MutationRecord对象），但是到DOM变化结束时触发回调。DOM变化可能是一系列的（比如元素的宽和高同时改变），那么这一系列的变化就会产生一个队列，这个队列会作为参数传递给回调函数。</p>
<p>由于浏览器差异的原因，一些版本的浏览器各自支持了构造函数，但是用法都是一样的，实例化一个观察者的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> MutationObserver = <span class="built_in">window</span>.MutationObserver ||</span><br><span class="line">                       <span class="built_in">window</span>.WebKitMutationObserver || </span><br><span class="line">                       <span class="built_in">window</span>.MozMutationObserver</span><br><span class="line">                       </span><br><span class="line"><span class="keyword">let</span> observer = <span class="keyword">new</span> MutationObserver(callback)</span><br></pre></td></tr></table></figure>
<h4 id="调用接口开始监控DOM。"><a href="#调用接口开始监控DOM。" class="headerlink" title="调用接口开始监控DOM。"></a>调用接口开始监控DOM。</h4><blockquote>
<p>常用的接口有三个：</p>
</blockquote>
<ul>
<li><p>observe(element, options)　配置<code>MutationObserver</code>在DOM更改匹配给定选项时，通过其回调函数开始接收通知。</p>
<p>element即要监听的DOM元素，options为监听选项对象，可选的选项如下：</p>
</li>
</ul>
<p><img src="/2019/01/01/JS监听div元素的resize/1.jpg" alt></p>
<p>　所以监听元素宽高变化，就是监听其style属性变化：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">observer.observe(element, &#123; </span><br><span class="line">        attributes: <span class="literal">true</span>, </span><br><span class="line">        attributeFilter: [<span class="string">'style'</span>], </span><br><span class="line">        attributeOldValue: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure></p>
<p>   这样当元素的style发生改变的时候，就会触发构造函数中传入的callback函数。</p>
<ul>
<li><p>disconnect()  <code>阻止 MutationObserver</code> 实例继续接收的通知，直到再次调用其observe方法，该观察者对象包含的回调函数都不会再被调用。</p>
</li>
<li><p>takeRecords() 从MutationObserver的通知队列中删除所有待处理的通知，并将它们返回到一个MutationRecord对象构成的新数组中。</p>
</li>
</ul>
<blockquote>
<p>示例</p>
</blockquote>
<p>这里以Vue中的一个组件作为实例，了解了以上所述内容后其实非常简单,代码如下:</p>
<p><img src="/2019/01/01/JS监听div元素的resize/2.webp" alt><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/vue.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span></span><br><span class="line">			html,body&#123;</span><br><span class="line">				width: 100%;</span><br><span class="line">				height: 100%;</span><br><span class="line">			&#125;</span><br><span class="line"><span class="css">			<span class="selector-class">.container</span> &#123;</span></span><br><span class="line">				width: 100%;</span><br><span class="line">				height: 100%;</span><br><span class="line">				position: relative</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line"><span class="css">			<span class="selector-class">.resize-element</span> &#123;</span></span><br><span class="line">				position: absolute;</span><br><span class="line">				top: 50%;</span><br><span class="line">				left: 50%;</span><br><span class="line">				height: 10rem;</span><br><span class="line">				width: 10rem;</span><br><span class="line">				transform: translate(-50%,-50%);</span><br><span class="line">				overflow: hidden;</span><br><span class="line"><span class="css">				<span class="selector-tag">resize</span>: <span class="selector-tag">both</span>;   <span class="comment">/*用户可以调节元素的宽度和高度*/</span></span></span><br><span class="line">				display: block;</span><br><span class="line"><span class="css">				<span class="selector-tag">box-shadow</span>: 0 0 1<span class="selector-tag">px</span> 1<span class="selector-tag">px</span> <span class="selector-id">#3361D8</span>;</span></span><br><span class="line">				border-radius: 2px;</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span> <span class="attr">id</span>=<span class="string">"main"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"resize-element"</span>&gt;</span></span><br><span class="line">				改变大小试试</span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"resize-record"</span>&gt;</span></span><br><span class="line">				触发了&#123;&#123;firedNum&#125;&#125;次resize事件。</span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">				el: <span class="string">"#main"</span>,</span></span><br><span class="line">				data: &#123;</span><br><span class="line"><span class="javascript">					observer: <span class="literal">null</span>,</span></span><br><span class="line">					firedNum: 0,</span><br><span class="line"><span class="javascript">					recordOldValue: &#123; <span class="comment">// 记录下旧的宽高数据，避免重复触发回调函数</span></span></span><br><span class="line"><span class="javascript">						width: <span class="string">'0'</span>,</span></span><br><span class="line"><span class="javascript">						height: <span class="string">'0'</span></span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				mounted() &#123;</span><br><span class="line"><span class="javascript">					<span class="keyword">let</span> MutationObserver = <span class="built_in">window</span>.MutationObserver || <span class="built_in">window</span>.WebKitMutationObserver || <span class="built_in">window</span>.MozMutationObserver</span></span><br><span class="line"><span class="javascript">					<span class="keyword">let</span> element = <span class="built_in">document</span>.querySelector(<span class="string">'.resize-element'</span>)</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.observer = <span class="keyword">new</span> MutationObserver(<span class="function">(<span class="params">mutationList</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">for</span>(<span class="keyword">let</span> mutation <span class="keyword">of</span> mutationList) &#123;</span></span><br><span class="line"><span class="javascript">							<span class="built_in">console</span>.log(mutation)</span></span><br><span class="line">						&#125;</span><br><span class="line"><span class="javascript">						<span class="keyword">let</span> width = getComputedStyle(element).getPropertyValue(<span class="string">'width'</span>)</span></span><br><span class="line"><span class="javascript">						<span class="keyword">let</span> height = getComputedStyle(element).getPropertyValue(<span class="string">'height'</span>)</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(width === <span class="keyword">this</span>.recordOldValue.width &amp;&amp; height === <span class="keyword">this</span>.recordOldValue.height) <span class="keyword">return</span></span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.recordOldValue = &#123;</span></span><br><span class="line">							width,</span><br><span class="line">							height</span><br><span class="line">						&#125;</span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.firedNum += <span class="number">1</span></span></span><br><span class="line">					&#125;)</span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.observer.observe(element, &#123;</span></span><br><span class="line"><span class="javascript">						attributes: <span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">						attributeFilter: [<span class="string">'style'</span>],</span></span><br><span class="line"><span class="javascript">						attributeOldValue: <span class="literal">true</span></span></span><br><span class="line">					&#125;)</span><br><span class="line">				&#125;,</span><br><span class="line">				beforeDestroyed() &#123;</span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="keyword">this</span>.observer) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.observer.disconnect()</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.observer.takeRecords()</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.observer = <span class="literal">null</span></span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">			&#125;)</span><br><span class="line">		<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>这里记录了旧的宽高数据来避免重复触发回调函数，这样做的原因在于宽高数据改变时，不一定是整数，而MutationRecord.recordOldValue中记录的是取整后的数据，这样就会导致在拖动改变DOM元素的宽高时，数值一直在整数和小数之间跳动，会多次触发。</strong></p>
</blockquote>
<h3 id="MutationObserver实现Vue-nextTick"><a href="#MutationObserver实现Vue-nextTick" class="headerlink" title="MutationObserver实现Vue nextTick"></a>MutationObserver实现Vue nextTick</h3><p>Vue 倡导开发者尽量不直接操作DOM，但有的时候由于各种需求让开发者不得不这样做，于是 <strong>nextTick</strong> 的实现就是让开发者在修改数据后，能够在数据更新到DOM后才执行对应的函数，从而获取最新的 DON 数据。</p>
<p>那么如何实现 <strong>nextTick</strong>呢，我们首先可以想到的是利用 <strong>setTimeout</strong> 的异步回调来实现，不过由于各个浏览器的不同，setTimeout 的延迟很高，因此在 <strong>nextTick</strong> 中只作为最后的备胎，首选的方案则是 <strong>MutationObserver</strong>(在后面的内容中 MO 代表 MutationObserver)</p>
<h4 id="nextTick-的源码实现"><a href="#nextTick-的源码实现" class="headerlink" title="nextTick 的源码实现"></a>nextTick 的源码实现</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> nextTick = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> callbacks = []</span><br><span class="line">  <span class="keyword">var</span> pending = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">var</span> timerFunc</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">nextTickHandler</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    pending = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">var</span> copies = callbacks.slice(<span class="number">0</span>)</span><br><span class="line">    callbacks = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; copies.length; i++) &#123;</span><br><span class="line">      copies[i]()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> MutationObserver !== <span class="string">'undefined'</span>) &#123; <span class="comment">// 首选 MutationObserver </span></span><br><span class="line">    <span class="keyword">var</span> counter = <span class="number">1</span></span><br><span class="line">    <span class="keyword">var</span> observer = <span class="keyword">new</span> MutationObserver(nextTickHandler) <span class="comment">// 声明 MO 和回调函数</span></span><br><span class="line">    <span class="keyword">var</span> textNode = <span class="built_in">document</span>.createTextNode(counter)</span><br><span class="line">    observer.observe(textNode, &#123; <span class="comment">// 监听 textNode 这个文本节点</span></span><br><span class="line">      characterData: <span class="literal">true</span> <span class="comment">// 一旦文本改变则触发回调函数 nextTickHandler</span></span><br><span class="line">    &#125;)</span><br><span class="line">    timerFunc = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      counter = (counter + <span class="number">1</span>) % <span class="number">2</span> <span class="comment">// 每次执行 timeFunc 都会让文本在 1 和 0 间切换</span></span><br><span class="line">      textNode.data = counter</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    timerFunc = setTimeout <span class="comment">// 如果不支持 MutationObserver, 退选 setTimeout</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">cb, ctx</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> func = ctx</span><br><span class="line">      ? <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; cb.call(ctx) &#125;</span><br><span class="line">      : cb</span><br><span class="line">    callbacks.push(func)</span><br><span class="line">    <span class="keyword">if</span> (pending) <span class="keyword">return</span></span><br><span class="line">    pending = <span class="literal">true</span></span><br><span class="line">    timerFunc(nextTickHandler, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<h4 id="从Vue-2-5-开始，抽出来了一个单独的文件next-tick-js来执行它"><a href="#从Vue-2-5-开始，抽出来了一个单独的文件next-tick-js来执行它" class="headerlink" title="从Vue 2.5+开始，抽出来了一个单独的文件next-tick.js来执行它"></a>从Vue 2.5+开始，抽出来了一个单独的文件next-tick.js来执行它</h4><p><a href="https://libin1991.github.io/2017/10/21/%E9%9D%A2%E8%AF%95%E4%B9%8BVue-nextTick%E5%8E%9F%E7%90%86/" target="_blank" rel="noopener">面试之Vue.$nextTick原理</a><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">    延迟一个任务使其异步执行，在下一个tick时执行，一个立即执行函数，返回一个function</span></span><br><span class="line"><span class="comment">    这个函数的作用是在task或者microtask中推入一个timerFunc，</span></span><br><span class="line"><span class="comment">    在当前调用栈执行完以后以此执行直到执行到timerFunc</span></span><br><span class="line"><span class="comment">    目的是延迟到当前调用栈执行完以后执行</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/*存放异步执行的回调*/</span></span><br><span class="line"><span class="keyword">const</span> callbacks = []</span><br><span class="line"><span class="comment">/*一个标记位，如果已经有timerFunc被推送到任务队列中去则不需要重复推送*/</span></span><br><span class="line"><span class="keyword">let</span> pending = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*下一个tick时的回调*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushCallbacks</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">/*一个标记位，标记等待状态（即函数已经被推入任务队列或者主线程，已经在等待当前栈执行完毕去执行），这样就不需要在push多个回调到callbacks时将timerFunc多次推入任务队列或者主线程*/</span></span><br><span class="line">  pending = <span class="literal">false</span></span><br><span class="line">  <span class="comment">//复制callback</span></span><br><span class="line">  <span class="keyword">const</span> copies = callbacks.slice(<span class="number">0</span>)</span><br><span class="line">  <span class="comment">//清除callbacks</span></span><br><span class="line">  callbacks.length = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; copies.length; i++) &#123;</span><br><span class="line">  <span class="comment">//触发callback的回调函数</span></span><br><span class="line">    copies[i]()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Here we have async deferring wrappers using both microtasks and (macro) tasks.</span></span><br><span class="line"><span class="comment">// In &lt; 2.4 we used microtasks everywhere, but there are some scenarios where</span></span><br><span class="line"><span class="comment">// microtasks have too high a priority and fire in between supposedly</span></span><br><span class="line"><span class="comment">// sequential events (e.g. #4521, #6690) or even between bubbling of the same</span></span><br><span class="line"><span class="comment">// event (#6566). However, using (macro) tasks everywhere also has subtle problems</span></span><br><span class="line"><span class="comment">// when state is changed right before repaint (e.g. #6813, out-in transitions).</span></span><br><span class="line"><span class="comment">// Here we use microtask by default, but expose a way to force (macro) task when</span></span><br><span class="line"><span class="comment">// needed (e.g. in event handlers attached by v-on).</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">其大概的意思就是：在Vue2.4之前的版本中，nextTick几乎都是基于microTask实现的，</span></span><br><span class="line"><span class="comment">但是由于microTask的执行优先级非常高，在某些场景之下它甚至要比事件冒泡还要快，</span></span><br><span class="line"><span class="comment">就会导致一些诡异的问题；但是如果全部都改成macroTask，对一些有重绘和动画的场</span></span><br><span class="line"><span class="comment">景也会有性能的影响。所以最终nextTick采取的策略是默认走microTask，对于一些DOM</span></span><br><span class="line"><span class="comment">的交互事件，如v-on绑定的事件回调处理函数的处理，会强制走macroTask。</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> microTimerFunc</span><br><span class="line"><span class="keyword">let</span> macroTimerFunc</span><br><span class="line"><span class="keyword">let</span> useMacroTask = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Determine (macro) task defer implementation.</span></span><br><span class="line"><span class="comment">// Technically setImmediate should be the ideal choice, but it's only available</span></span><br><span class="line"><span class="comment">// in IE. The only polyfill that consistently queues the callback after all DOM</span></span><br><span class="line"><span class="comment">// events triggered in the same loop is by using MessageChannel.</span></span><br><span class="line"><span class="comment">/* istanbul ignore if */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">而对于macroTask的执行，Vue优先检测是否支持原生setImmediate（高版本IE和Edge支持），</span></span><br><span class="line"><span class="comment">不支持的话再去检测是否支持原生MessageChannel，如果还不支持的话为setTimeout(fn, 0)。</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> setImmediate !== <span class="string">'undefined'</span> &amp;&amp; isNative(setImmediate)) &#123;</span><br><span class="line">  macroTimerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setImmediate(flushCallbacks)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> MessageChannel !== <span class="string">'undefined'</span> &amp;&amp; ( </span><br><span class="line"><span class="comment">// MessageChannel与原先的MutationObserver异曲同工</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">在Vue 2.4版本以前使用的MutationObserver来模拟异步任务。</span></span><br><span class="line"><span class="comment">而Vue 2.5版本以后，由于兼容性弃用了MutationObserver。</span></span><br><span class="line"><span class="comment">Vue 2.5+版本使用了MessageChannel来模拟macroTask。</span></span><br><span class="line"><span class="comment">除了IE以外，messageChannel的兼容性还是比较可观的。</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">  isNative(MessageChannel) ||</span><br><span class="line">  <span class="comment">// PhantomJS</span></span><br><span class="line">  MessageChannel.toString() === <span class="string">'[object MessageChannelConstructor]'</span></span><br><span class="line">)) &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  可见，新建一个MessageChannel对象，该对象通过port1来检测信息，port2发送信息。</span></span><br><span class="line"><span class="comment">  通过port2的主动postMessage来触发port1的onmessage事件，</span></span><br><span class="line"><span class="comment">  进而把回调函数flushCallbacks作为macroTask参与事件循环。</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  <span class="keyword">const</span> channel = <span class="keyword">new</span> MessageChannel()</span><br><span class="line">  <span class="keyword">const</span> port = channel.port2</span><br><span class="line">  channel.port1.onmessage = flushCallbacks</span><br><span class="line">  macroTimerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    port.postMessage(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">/* istanbul ignore next */</span></span><br><span class="line">   <span class="comment">//上面两种都不支持，用setTimeout</span></span><br><span class="line">  macroTimerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(flushCallbacks, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Determine microtask defer implementation.</span></span><br><span class="line"><span class="comment">/* istanbul ignore next, $flow-disable-line */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">Promise</span> !== <span class="string">'undefined'</span> &amp;&amp; isNative(<span class="built_in">Promise</span>)) &#123;</span><br><span class="line"><span class="comment">/*使用Promise*/</span></span><br><span class="line">  <span class="keyword">const</span> p = <span class="built_in">Promise</span>.resolve()</span><br><span class="line">  microTimerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    p.then(flushCallbacks)</span><br><span class="line">    <span class="comment">// in problematic UIWebViews, Promise.then doesn't completely break, but</span></span><br><span class="line">    <span class="comment">// it can get stuck in a weird state where callbacks are pushed into the</span></span><br><span class="line">    <span class="comment">// microtask queue but the queue isn't being flushed, until the browser</span></span><br><span class="line">    <span class="comment">// needs to do some other work, e.g. handle a timer. Therefore we can</span></span><br><span class="line">    <span class="comment">// "force" the microtask queue to be flushed by adding an empty timer.</span></span><br><span class="line">    <span class="comment">//iOS的webview下，需要强制刷新队列，执行上面的回调函数</span></span><br><span class="line">    <span class="keyword">if</span> (isIOS) setTimeout(noop)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// fallback to macro</span></span><br><span class="line">  microTimerFunc = macroTimerFunc</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Wrap a function so that if any code inside triggers state change,</span></span><br><span class="line"><span class="comment"> * the changes are queued using a (macro) task instead of a microtask.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> 在Vue执行绑定的DOM事件时，默认会给回调的handler函数调用withMacroTask方法做一层包装，</span></span><br><span class="line"><span class="comment"> 它保证整个回调函数的执行过程中，遇到数据状态的改变，这些改变而导致的视图更新（DOM更新）</span></span><br><span class="line"><span class="comment"> 的任务都会被推到macroTask而不是microtask。</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">withMacroTask</span> (<span class="params">fn: Function</span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> fn._withTask || (fn._withTask = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    useMacroTask = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">const</span> res = fn.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>)</span><br><span class="line">    useMacroTask = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">    推送到队列中下一个tick时执行</span></span><br><span class="line"><span class="comment">    cb 回调函数</span></span><br><span class="line"><span class="comment">    ctx 上下文</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">nextTick</span> (<span class="params">cb?: Function, ctx?: Object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> _resolve</span><br><span class="line">   <span class="comment">/*cb存到callbacks中*/</span></span><br><span class="line">  callbacks.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cb) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        cb.call(ctx)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        handleError(e, ctx, <span class="string">'nextTick'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_resolve) &#123;</span><br><span class="line">      _resolve(ctx)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (!pending) &#123;</span><br><span class="line">    pending = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (useMacroTask) &#123;</span><br><span class="line">      macroTimerFunc()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      microTimerFunc()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// $flow-disable-line</span></span><br><span class="line">  <span class="keyword">if</span> (!cb &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">Promise</span> !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      _resolve = resolve</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>看了源码发现timerFunc会检测当前环境而不同实现，其实就是按照Promise，MutationObserver，setTimeout优先级，哪个存在使用哪个，最不济的环境下使用setTimeout</p>
<p><span style="border-bottom:2px solid red;">setTimeout是最后的一种备选方案，并且默认有4ms延时，setTimeout延时0不会老老实实立即执行：</span><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"我不是立即执行的,一般我会延时4ms,哈哈"</span>);</span><br><span class="line">&#125;,<span class="number">0</span>);</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>优先使用Promise，在Promise不存在的情况下使用MutationObserver，这两个方法的回调函数都会在microtask中执行，它们会比setTimeout更早执行，所以优先使用。<br>如果上述两种方法都不支持的环境则会使用setTimeout，在task尾部推入这个函数，等待调用执行。</p>
</blockquote>
<h4 id="Event-Loop"><a href="#Event-Loop" class="headerlink" title="Event Loop"></a>Event Loop</h4><p>当一个程序有：setTimeout， setInterval ，setImmediate， I/O， UI渲染，Promise ，process.nextTick， Object.observe， MutationObserver的时候：</p>
<ul>
<li>先执行 macrotasks：I/O -》 UI渲染</li>
<li>再执行 microtasks ：process.nextTick -》 Promise -》MutationObserver -&gt;Object.observe</li>
<li>再把setTimeout setInterval setImmediate 塞入一个新的macrotasks，依次： setTimeout ，setInterval –&gt; setImmediate</li>
</ul>
<p>综上，nextTick的目的就是产生一个回调函数加入task或者microtask中，当前栈执行完以后（可能中间还有别的排在前面的函数）调用该回调函数，起到了异步触发（即下一个tick时触发）的目的。</p>
<p>任务队列<br>异步任务分为task（宏任务，也可称为macroTask）和microtask（微任务）两类。<br>当满足执行条件时，task和microtask会被放入各自的队列中等待放入主线程执行，我们把这两个队列称为Task Queue(也叫Macrotask Queue)和Microtask Queue。</p>
<blockquote>
<font color="#dd0000"> <strong> macrotasks: </strong>   script中代码, setTimeout ，setInterval， setImmediate，requestAnimationFrame, I/O ，UI渲染  </font>
</blockquote>
<blockquote>
<font color="#dd0000"> <strong> microtasks: </strong>   Promise， process.nextTick， Object.observe， MutationObserver  </font>
</blockquote>
<p><table><tr><td bgcolor="#000"><font color="#fff"> microtask(微任务)一定比macroTask(宏任务)先执行吗：script中代码最先执行，但是script代码是macrotasks(宏任务) </font></td></tr></table></p>
<blockquote>
<p><strong>其实promise的then和catch才是microtask，本身的内部代码不是</strong></p>
</blockquote>
<h4 id="具体过程"><a href="#具体过程" class="headerlink" title="具体过程"></a>具体过程</h4><ul>
<li>执行完主执行线程中的任务</li>
<li>取出Microtask Queue中任务执行直到清空。</li>
<li>取出Macrotask Queue中一个任务执行。</li>
<li>取出Microtask Queue中任务执行直到清空。</li>
<li>重复3和4。</li>
</ul>
<p>即为同步完成，一个宏任务，所有微任务，一个宏任务，所有微任务……</p>
<p><img src="/2019/01/01/JS监听div元素的resize/7.jpg" alt><br><img src="/2019/01/01/JS监听div元素的resize/8.jpg" alt></p>
<hr>
<h3 id="MutationObserver-的功能和作用"><a href="#MutationObserver-的功能和作用" class="headerlink" title="MutationObserver 的功能和作用"></a>MutationObserver 的功能和作用</h3><blockquote>
<p>MO 给开发者提供了一种能在某个范围内的DOM数发生变化时作出适当反应的能力 </p>
</blockquote>
<p>用人话说是开发者能通过它创建一个观察者对象，这个对象会监听某个DOM元素，并在它的DOM树发生变化时执行我们提供的回调函数。</p>
<p>具体参考这个 <a href="https://jsfiddle.net/chenjsh36/1b5LL0b7/1/" target="_blank" rel="noopener">DEMO</a>点击预览</p>
<p>比较特别的是实例化的时候需要先传入回调函数：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> observer = <span class="keyword">new</span> MutationObserver(<span class="function"><span class="keyword">function</span>(<span class="params">mutations</span>) </span>&#123;</span><br><span class="line">  mutations.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">mutation</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(mutation.type);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>然后才配置观察选项，包括观察节点和观察的属性：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 选择目标节点</span></span><br><span class="line"><span class="keyword">var</span> target = <span class="built_in">document</span>.querySelector(<span class="string">'#some-id'</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 配置观察选项:</span></span><br><span class="line"><span class="keyword">var</span> config = &#123; <span class="attr">attributes</span>: <span class="literal">true</span>, <span class="attr">childList</span>: <span class="literal">true</span>, <span class="attr">characterData</span>: <span class="literal">true</span> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 传入目标节点和观察选项</span></span><br><span class="line">observer.observe(target, config);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 随后,你还可以停止观察</span></span><br><span class="line">observer.disconnect();</span><br></pre></td></tr></table></figure>
<p>对于老版本的谷歌和火狐，则需要使用带前缀的 MO：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var MutationObserver = window.MutationObserver || </span><br><span class="line">                       window.WebKitMutationObserver || </span><br><span class="line">                       window.MozMutationObserver</span><br></pre></td></tr></table></figure>
<h3 id="MutationObserver-和-microtask"><a href="#MutationObserver-和-microtask" class="headerlink" title="MutationObserver 和 microtask"></a>MutationObserver 和 microtask</h3><p>那么为什么优选使用 MutationObserver呢？</p>
<p>一开始以为是 MO 就是用来监听 DOM 变化的，那么使用 textnode 模拟 DOM 变化再利用 MO 来监听触发从而实现 nextTick 不就很适合，直到了解看到了知乎上的<a href="https://www.zhihu.com/question/55364497" target="_blank" rel="noopener">问答</a>才知道是因为 MO 会比 setTimeout 早执行的缘故，</p>
<p>这里需要了解<strong>JS的运行运行机制</strong>（重新刷新了我的三观）, JS 的事件运行机制执行的时候会区分 <strong>task</strong> 和 <strong>microtask</strong>, 引擎在每个 <strong>task</strong> 执行完毕，并在从队列里取<strong>下一个task来执行之前</strong>， 执行完所有的 <strong>microtask</strong> 队列中的 microtask.</p>
<p><strong> setTimeout</strong> 回调会被分配到一个新的task中等待执行，而 Promise 的 resolver、MO 的 回调都会被分配到 microtask 的队列中，所以会比 setTimout 先执行.</p>
<p>除了比 setTimout 快之外，还有 <strong>渲染性能</strong> 的问题，根据<a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model" target="_blank" rel="noopener">HTML Standard</a>, <strong>每个 task 运行完以后， UI 都会重新渲染，那么在 microtask 中就完成数据更新， 当前 task 结束就可以得到最新的 UI， 反之如果新建一个 task 来做数据更新，那么渲染就会进行两次。</strong></p>
<p>所以性价比如此高的 MO 自然成为了首选</p>
<p>关于 microtask，具体可以阅读 Jake 写的 <a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/" target="_blank" rel="noopener">Tasks, microtasks, queues and schedules</a></p>
<h3 id="Vue-nextTick的版本迭代"><a href="#Vue-nextTick的版本迭代" class="headerlink" title="Vue nextTick的版本迭代"></a>Vue nextTick的版本迭代</h3><p>上面关于 <strong>nextTick</strong> 的源码实现属于 vue 最早的版本 v1.0.9，在深挖 mutationObserver 的时候发现 <strong>nextTick</strong> 在vue的版本迭代中也在不断的进化，同事也发生过退化，非常有趣：</p>
<p>先说说退化的事件，尤大（vue的作者）曾经使用 <code>window.postMessage</code> 来替代 MO 实现 nextTick，结果开发者使用后发现了问题，可以看看这两个 JSFiddle：<a href="https://jsfiddle.net/k6bgu2z6/4/" target="_blank" rel="noopener">jsfiddle1</a>点击预览 和 <a href="https://jsfiddle.net/v9q9L0hw/2/" target="_blank" rel="noopener">jsfiddle2</a>点击预览, 两个例子用了不同版本来实现元素的绝对定位，第一个使用的是 2.0.0-rc6，这个版本采用的是 MO，而后来因为 IOS 9.3 的 WebView 里 MO 有 bug，尤大便换成 window.postMessage来实现，即第二个实例版本为 2.0.0-rc7, 但是由于 postMessage 会将回调放到 macrotask 其实也就是 task 里面，导致可能执行了多次 UI 的task都没有执行 window.postMessage 的 task，也就延迟了更新DOM操作的时间。尤大在后续版本撤回了这一次修改，具体的讨论可以看<a href="https://github.com/vuejs/vue/issues/3771#issuecomment-249692588" target="_blank" rel="noopener">issue</a></p>
<p>关于进化，在后续的版本里，由于 es6 的新语法，nextTick 开始使用 Promise.then 和 MO 来做首选和次选，在前面的讨论中已经提到，Promise.then 也属于 microtask。</p>
<h3 id="Resize-Observer"><a href="#Resize-Observer" class="headerlink" title="Resize Observer"></a>Resize Observer</h3><blockquote>
<p>Resize Observer是一个新的JavaScript API，与Intersection Observer API、Mutation Observer等其他观察者API非常相似。<br>它允许在尺寸发生变化时通知元素。</p>
</blockquote>
<p>ResizeObserver的解释:开发过程当中经常遇到的一个问题就是如何监听一个 div 的尺寸变化。但众所周知，为了监听 div 的尺寸变化，都将侦听器附加到 window 中的 resize 事件。但这很容易导致性能问题，因为大量的触发事件。换句话说，使用 window.resize 通常是浪费的，因为它告诉我们每个视窗大小的变化，而不仅仅是当一个元素的大小发生变化。</p>
<p>使用 ResizeObserver 的API的另一个用例就是视窗 resize 事件不能帮助我们：当元素被动态地添加或删除时，会影响父元素的大小。这也是现代单页应用程序越来越频繁使用 ResizeObserver 原因之一。<br>通过 window.resize 事件的监听，可以调用一个回调函数。在这个回调函数中做我们需要做的事情。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// define a callback</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// something cool here</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// add resize listener to window object</span></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'resize'</span>, callback)</span><br></pre></td></tr></table></figure>
<p>比如说，你要调整一个元素的大小，那就需要在 resize 的回调函数 callback() 中调用 getBoundingClientRect 或 getComputerStyle 不过你要是不小心处理所有的读和写操作，就会导致布局混乱。比如下面这个小示例：</p>
<p>当你改变浏览器视窗大小的时候，就可以看到相应的变化：</p>
<p><img src="/2019/01/01/JS监听div元素的resize/3.gif" alt></p>
<p>这也就是为什么 ResizeObserver 是一个有用的API。它对所观察到的任何元素的大小的变化做出反应，而不依赖于所引起的变化。它还提供了对所观察元素的新大小的访问。那接下来让我们直接切入正题。</p>
<h4 id="简单总结一下："><a href="#简单总结一下：" class="headerlink" title="简单总结一下："></a>简单总结一下：</h4><p>ResizeObserver 允许我们观察DOM元素的内容矩形大小（宽度、高度）的变化，并做出相应的响应。它就像给元素添加 document.onresize() 或 window.resize() 事件（但在JavaScript中，只有 window 才有 resize 事件）。当元素改变大小而不调整视窗大小时，它是有用的。 下面描述一些调整观察者的行为：</p>
<ul>
<li>当观察到的元素被插入或从DOM中删除时，观察将会触发</li>
<li>当观察到的元素 display 值为 none 时，观察都会触发</li>
<li>观察不会对未替换的内联元素（non-replaced inline element）触发</li>
<li>观察不会由CSS的 transform 触发</li>
<li>如果元素有显示，而且元素大小不是 0,0 ，观察将会触发</li>
</ul>
<p>基本用法<br>使用Resize Observer非常简单，只需实例化一个新的ResizeObserver对象并传入一个回调函数，该函数接收观察到的条目</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myObserver = <span class="keyword">new</span> ResizeObserver(<span class="function"><span class="params">entries</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 遍历条目，做一些事情</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>然后，我们可以在实例上调用observe并传入一个元素来观察</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> someEl = <span class="built_in">document</span>.querySelector(<span class="string">'.some-element'</span>);</span><br><span class="line"><span class="keyword">const</span> someOtherEl = <span class="built_in">document</span>.querySelector(<span class="string">'.some-other-element'</span>);</span><br><span class="line"></span><br><span class="line">myObserver.observe(someEl);</span><br><span class="line">myObserver.observe(someOtherEl);</span><br></pre></td></tr></table></figure>
<p>对于每个entry，我们都会得到一个包含contentRect和一个target属性的对象。target是DOM元素本身，contentRect是具有以下属性的对象：width，height，x，y，top，right，bottom和left。</p>
<p>与元素的<strong>getBoundingClientRect</strong>不同，contentRect的width和height值不包含padding。contentRect.top是元素的顶部padding，contentRect.left是元素的左侧padding。</p>
<p>比如要打印出被监听元素寸尺变化时width和height的值，可以像下面这样做:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myObserver = <span class="keyword">new</span> ResizeObserver(<span class="function"><span class="params">entries</span> =&gt;</span> &#123;</span><br><span class="line">  entries.forEach(<span class="function"><span class="params">entry</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'width'</span>, entry.contentRect.width);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'height'</span>, entry.contentRect.height);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> someEl = <span class="built_in">document</span>.querySelector(<span class="string">'.some-element'</span>);</span><br><span class="line">myObserver.observe(someEl);</span><br></pre></td></tr></table></figure></p>
<p>上面的示例中，使用了forEach 循环来遍历观察者的回调中的 entries ，其实在 entries 上使用  for … of  可以得到相同的效果</p>
<h4 id="Resize-Observer-API-示例"><a href="#Resize-Observer-API-示例" class="headerlink" title="Resize Observer API 示例"></a>Resize Observer API 示例</h4><p>下面是一个简单的演示，以查看Resize Observer API的实际应用。<br>通过调整浏览器窗口的大小来尝试一下，注意渐变角度和文本内容仅在元素的大小受到影响时才发生变化：</p>
<p><img src="/2019/01/01/JS监听div元素的resize/4.webp" alt><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/vue.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span></span><br><span class="line">			html,</span><br><span class="line">			body &#123;</span><br><span class="line">				width: 100%;</span><br><span class="line">				height: 100%;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line"><span class="css">			<span class="selector-class">.box</span> &#123;</span></span><br><span class="line">				text-align: center;</span><br><span class="line">				height: 20vh;</span><br><span class="line">				border-radius: 8px;</span><br><span class="line">				box-shadow: 0 0 4px var(--subtle);</span><br><span class="line">				display: flex;</span><br><span class="line">				justify-content: center;</span><br><span class="line">				align-items: center;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line"><span class="css">			<span class="selector-class">.box</span> <span class="selector-tag">h3</span> &#123;</span></span><br><span class="line"><span class="css">				<span class="selector-tag">color</span>: <span class="selector-id">#fff</span>;</span></span><br><span class="line">				margin: 0;</span><br><span class="line">				font-size: 5vmin;</span><br><span class="line"><span class="css">				<span class="selector-tag">text-shadow</span>: 0 0 10<span class="selector-tag">px</span> <span class="selector-tag">rgba</span>(0, 0, 0, 0<span class="selector-class">.4</span>);</span></span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line"><span class="css">			<span class="selector-class">.box</span><span class="selector-class">.small</span> &#123;</span></span><br><span class="line">				max-width: 550px;</span><br><span class="line">				margin: 1rem auto;</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"info"</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box small"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"info"</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">const</span> boxes = <span class="built_in">document</span>.querySelectorAll(<span class="string">'.box'</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">			<span class="keyword">const</span> myObserver = <span class="keyword">new</span> ResizeObserver(<span class="function"><span class="params">entries</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">for</span>(<span class="keyword">let</span> entry <span class="keyword">of</span> entries) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> infoEl = entry.target.querySelector(<span class="string">'.info'</span>);</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> width = <span class="built_in">Math</span>.floor(entry.contentRect.width);</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> height = <span class="built_in">Math</span>.floor(entry.contentRect.height);</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> angle = <span class="built_in">Math</span>.floor(width / <span class="number">360</span> * <span class="number">100</span>);</span></span><br><span class="line"><span class="javascript">					<span class="keyword">const</span> gradient = <span class="string">`linear-gradient(<span class="subst">$&#123; angle &#125;</span>deg, rgba(0,143,104,1) 50%, rgba(250,224,66,1) 50%)`</span>;</span></span><br><span class="line"></span><br><span class="line">					entry.target.style.background = gradient;</span><br><span class="line"></span><br><span class="line"><span class="javascript">					infoEl.innerText = <span class="string">`I'm <span class="subst">$&#123; width &#125;</span>px and <span class="subst">$&#123; height &#125;</span>px tall`</span>;</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line"></span><br><span class="line"><span class="javascript">			boxes.forEach(<span class="function"><span class="params">box</span> =&gt;</span> &#123;</span></span><br><span class="line">				myObserver.observe(box);</span><br><span class="line">			&#125;);</span><br><span class="line">		<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="DOM变动事件的用法"><a href="#DOM变动事件的用法" class="headerlink" title="DOM变动事件的用法"></a>DOM变动事件的用法</h3><p>DOM2级的変动事件是为XML或html的DOM设计的，不特定于某种语言。 </p>
<h4 id="变动事件的分类有7种，最常用的浏览器支持最多的有3种"><a href="#变动事件的分类有7种，最常用的浏览器支持最多的有3种" class="headerlink" title="变动事件的分类有7种，最常用的浏览器支持最多的有3种:"></a>变动事件的分类有7种，最常用的浏览器支持最多的有3种:</h4><ol>
<li><strong>DOMSubtreeModified</strong>：在DOM结构中发生任何变化时触发； </li>
<li><strong>DOMNodeInserted</strong>：在一个节点作为子节点被插入到另一个节点中时触发； </li>
<li><strong>DOMNodeRemoved</strong>：在节点从其父节点中被移除时触发； </li>
<li>DOMNodeInsertedIntoDocument：在一个节点被直接插入文档中或者通过子树间接插入文档后触发。在DOMNodeInserted之后触发； </li>
<li>DOMNodeRemovedFromDocument：在一个节点被直接从文档中删除或通过子树间接从文档中移除之前触发。在DOMNodeRemoved之后触发。 </li>
<li>DOMAttrModified：在特性被修改之后触发； </li>
<li>DOMCharacterDataModified：在文本节点的值发生变化的时候触发。 </li>
</ol>
<h4 id="删除节点检测？"><a href="#删除节点检测？" class="headerlink" title="删除节点检测？"></a>删除节点检测？</h4><ul>
<li>首先触发的是DOMNodeRemoved事件，它对应的event对象中的target属性值是被删除的节点，relatedNode属性值是被删除节点的父节点，该事件会冒泡；</li>
<li>其次出发的是DOMNodeRemovedFromDocument事件，它对应的event对象中的target属性值为指定的被删除的子节点。只有绑定到它的子节点上才能被触发。</li>
<li>最后触发的是DOMSubtreeModified事件。这个事件对应event对象中的target属性是被移除节点的父节点。 </li>
</ul>
<p>(下面注释的序号为触发的顺序:)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">functiongetFirstChild(obj)&#123;// 获取第一子节点(找到第一个不为空的节点)var first = obj.firstChild;</span><br><span class="line">        while(first.nodeType != 1)&#123;</span><br><span class="line">            first = first.nextSibling;</span><br><span class="line">        &#125;</span><br><span class="line">        return first;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">EventUtil.addHandler(window,&quot;load&quot;,function(event)&#123;</span><br><span class="line">    varlist = document.getElementById(&apos;myList&apos;);</span><br><span class="line">    var btn = document.getElementById(&quot;mbtn&quot;);</span><br><span class="line"></span><br><span class="line">    EventUtil.addHandler(document,&quot;DOMNodeRemoved&quot;,function(event)&#123;</span><br><span class="line">        console.log(event.type);        //1:DOMNodeRemoved</span><br><span class="line">        console.log(event.target);      //2:ul节点,即被删除的节点</span><br><span class="line">        console.log(event.relatedNode); //3:body节点,即被删除节点的父节点</span><br><span class="line">    &#125;)</span><br><span class="line">    EventUtil.addHandler(getFirstChild(list),&quot;DOMNodeRemovedFromDocument&quot;,function(event)&#123;</span><br><span class="line">        console.log(event.type)         //4:DOMNodeRemovedFromDocument</span><br><span class="line">        console.log(event.target)       //5:li节点，即&lt;li&gt;item1&lt;/li&gt;</span><br><span class="line">    &#125;);</span><br><span class="line">    EventUtil.addHandler(document,&quot;DOMSubtreeModified&quot;,function(event)&#123;</span><br><span class="line">        console.log(event.type);        //6:DOMSubtreeModified</span><br><span class="line">        console.log(event.target);      //7:body节点，即被删除节点的父节点</span><br><span class="line">    &#125;)</span><br><span class="line">    EventUtil.addHandler(btn,&apos;click&apos;,function(event)&#123;</span><br><span class="line">        list.parentNode.removeChild(list);  //</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h4 id="插入节点检测？"><a href="#插入节点检测？" class="headerlink" title="插入节点检测？"></a>插入节点检测？</h4><p> 在使用appendChild()、replaceChild()或insertBefore()向DOM中插入节点的时候：</p>
<ul>
<li>首先触发DOMInserted事件，它对应的event对象中的target属性为添加的节点，relateNode属性对应被添加节点的父节点。（可冒泡）；</li>
<li>其次触发的是DOMNodeInsertedIntoDocument事件，它对应的event对象中的target属性是添加的节点，只有指定给一个子节点的事件处理程序才会被调用</li>
<li>最后出发的是DOMSubtreeModified事件，它对应的event对象长得target属性值是新节点的父节点。 </li>
</ul>
<blockquote>
<p>代码如下所示：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">functiongetFirstChild(obj)&#123;<span class="comment">// 获取第一子节点(找到第一个不为空的节点)var first = obj.firstChild;</span></span><br><span class="line">    <span class="keyword">while</span>(first.nodeType != <span class="number">1</span>)&#123;</span><br><span class="line">        first = first.nextSibling;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> first;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EventUtil.addHandler(<span class="built_in">window</span>,<span class="string">"load"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> list = <span class="built_in">document</span>.getElementById(<span class="string">'myList'</span>);</span><br><span class="line">    <span class="keyword">var</span> btn = <span class="built_in">document</span>.getElementById(<span class="string">"mbtn"</span>);</span><br><span class="line">    <span class="keyword">var</span> item4 = <span class="built_in">document</span>.createElement(<span class="string">'li'</span>);</span><br><span class="line">    <span class="keyword">var</span> item4Text = <span class="built_in">document</span>.createTextNode(<span class="string">'item4'</span>);</span><br><span class="line"></span><br><span class="line">    EventUtil.addHandler(<span class="built_in">document</span>,<span class="string">"DOMNodeInserted"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(event.type);        <span class="comment">//1:DOMNodeInserted</span></span><br><span class="line">        <span class="built_in">console</span>.log(event.target);      <span class="comment">//2:li节点，即被添加的节点</span></span><br><span class="line">        <span class="built_in">console</span>.log(event.relatedNode); <span class="comment">//3:ul节点，即被添加节点的父节点</span></span><br><span class="line">    &#125;);</span><br><span class="line">    EventUtil.addHandler(item4,<span class="string">"DOMNodeInsertedIntoDocument"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(event.type);        <span class="comment">//4:DOMNodeInsertedIntoDocument</span></span><br><span class="line">        <span class="built_in">console</span>.log(event.target);      <span class="comment">//5:li节点，即被添加的节点&lt;li&gt;item4&lt;/li&gt;</span></span><br><span class="line">    &#125;);</span><br><span class="line">    EventUtil.addHandler(<span class="built_in">document</span>,<span class="string">"DOMSubtreeModified"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(event.type);        <span class="comment">//6:DOMSubtreeModified</span></span><br><span class="line">        <span class="built_in">console</span>.log(event.target);      <span class="comment">//7:ul节点，即被触发节点的父节点</span></span><br><span class="line">    &#125;)</span><br><span class="line">    EventUtil.addHandler(btn,<span class="string">'click'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        item4.appendChild(item4Text);     getFirstChild</span><br><span class="line"></span><br><span class="line">        list.replaceChild(item4,getFirstChild(list));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="常用npm包"><a href="#常用npm包" class="headerlink" title="常用npm包"></a>常用npm包</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">element-resize-detector 【推荐】</span><br><span class="line">resize-detector</span><br><span class="line">size-sensor</span><br></pre></td></tr></table></figure>
<p><img src="/2019/01/01/JS监听div元素的resize/5.png" alt></p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><ul>
<li>Install</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm i --save size-sensor</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; bind, clear &#125; <span class="keyword">from</span> <span class="string">'size-sensor'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>bind&amp;unbind</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; bind, clear &#125; <span class="keyword">from</span> <span class="string">'size-sensor'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// bind the event on element, will get the `unbind` function</span></span><br><span class="line"><span class="keyword">const</span> unbind1 = bind(<span class="built_in">document</span>.querySelector(<span class="string">'.container'</span>), element =&gt; &#123;</span><br><span class="line">  <span class="comment">// do what you want to to.</span></span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> unbind2 = bind(<span class="built_in">document</span>.querySelector(<span class="string">'.container'</span>), element =&gt; &#123;</span><br><span class="line">  <span class="comment">// do what you want to to.</span></span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// if you want to cancel bind event.</span></span><br><span class="line">unbind1();</span><br></pre></td></tr></table></figure>
<ul>
<li>clear</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; bind, clear &#125; <span class="keyword">from</span> <span class="string">'size-sensor'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * // bind the resize event.</span></span><br><span class="line"><span class="comment"> * const unbind1 = bind(...);</span></span><br><span class="line"><span class="comment"> * const unbind2 = bind(...);</span></span><br><span class="line"><span class="comment"> * ...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// you can cancel all the event of element.</span></span><br><span class="line">clear(element);</span><br></pre></td></tr></table></figure>
<ul>
<li>实现方式：<br><img src="/2019/01/01/JS监听div元素的resize/6.webp" alt></li>
</ul>
<h3 id="resize-detector实现方式"><a href="#resize-detector实现方式" class="headerlink" title="resize-detector实现方式"></a>resize-detector实现方式</h3><h4 id="Github"><a href="#Github" class="headerlink" title="Github"></a><a href="https://github.com/libin1991/resize-detector" target="_blank" rel="noopener"><font color="#dd0000">Github</font></a></h4><blockquote>
<font color="#ff0000"><strong> 依次判断window.ResizeObserver,DOMSubtreeModified,window.MutationObserver </strong></font>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  createStyles,</span><br><span class="line">  createElement,</span><br><span class="line">  requestAnimationFrame,</span><br><span class="line">  cancelAnimationFrame,</span><br><span class="line">  getComputedStyle,</span><br><span class="line">  getRenderInfo</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'./util'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> triggerStyles <span class="keyword">from</span> <span class="string">'./triggers.css'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> total = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> style = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">addListener</span> (<span class="params">elem, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!elem.__resize_mutation_handler__) &#123;</span><br><span class="line">    elem.__resize_mutation_handler__ = handleMutation.bind(elem)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> listeners = elem.__resize_listeners__</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!listeners) &#123;</span><br><span class="line">    elem.__resize_listeners__ = []</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.ResizeObserver) &#123;</span><br><span class="line">      <span class="keyword">let</span> &#123; offsetWidth, offsetHeight &#125; = elem</span><br><span class="line">      <span class="keyword">let</span> ro = <span class="keyword">new</span> ResizeObserver(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!elem.__resize_observer_triggered__) &#123;</span><br><span class="line">          elem.__resize_observer_triggered__ = <span class="literal">true</span></span><br><span class="line">          <span class="keyword">if</span> (elem.offsetWidth === offsetWidth &amp;&amp; elem.offsetHeight === offsetHeight) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        runCallbacks(elem)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// initially display none won't trigger ResizeObserver callback</span></span><br><span class="line">      <span class="keyword">let</span> &#123; detached, rendered &#125; = getRenderInfo(elem)</span><br><span class="line">      elem.__resize_observer_triggered__ = detached === <span class="literal">false</span> &amp;&amp; rendered === <span class="literal">false</span></span><br><span class="line">      elem.__resize_observer__ = ro</span><br><span class="line">      ro.observe(elem)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (elem.attachEvent &amp;&amp; elem.addEventListener) &#123;</span><br><span class="line">      <span class="comment">// targeting IE9/10</span></span><br><span class="line">      elem.__resize_legacy_resize_handler__ = <span class="function"><span class="keyword">function</span> <span class="title">handleLegacyResize</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        runCallbacks(elem)</span><br><span class="line">      &#125;</span><br><span class="line">      elem.attachEvent(<span class="string">'onresize'</span>, elem.__resize_legacy_resize_handler__)</span><br><span class="line">      <span class="built_in">document</span>.addEventListener(<span class="string">'DOMSubtreeModified'</span>, elem.__resize_mutation_handler__)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!total) &#123;</span><br><span class="line">        style = createStyles(triggerStyles)</span><br><span class="line">      &#125;</span><br><span class="line">      initTriggers(elem)</span><br><span class="line"></span><br><span class="line">      elem.__resize_rendered__ = getRenderInfo(elem).rendered</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">window</span>.MutationObserver) &#123;</span><br><span class="line">        <span class="keyword">let</span> mo = <span class="keyword">new</span> MutationObserver(elem.__resize_mutation_handler__)</span><br><span class="line">        mo.observe(<span class="built_in">document</span>, &#123;</span><br><span class="line">          attributes: <span class="literal">true</span>,</span><br><span class="line">          childList: <span class="literal">true</span>,</span><br><span class="line">          characterData: <span class="literal">true</span>,</span><br><span class="line">          subtree: <span class="literal">true</span></span><br><span class="line">        &#125;)</span><br><span class="line">        elem.__resize_mutation_observer__ = mo</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  elem.__resize_listeners__.push(callback)</span><br><span class="line">  total++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">removeListener</span> (<span class="params">elem, callback</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// targeting IE9/10</span></span><br><span class="line">  <span class="keyword">if</span> (elem.detachEvent &amp;&amp; elem.removeEventListener) &#123;</span><br><span class="line">    elem.detachEvent(<span class="string">'onresize'</span>, elem.__resize_legacy_resize_handler__)</span><br><span class="line">    <span class="built_in">document</span>.removeEventListener(<span class="string">'DOMSubtreeModified'</span>, elem.__resize_mutation_handler__)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> listeners = elem.__resize_listeners__</span><br><span class="line">  <span class="keyword">if</span> (!listeners) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  listeners.splice(listeners.indexOf(callback), <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!listeners.length) &#123;</span><br><span class="line">    <span class="keyword">if</span> (elem.__resize_observer__) &#123;</span><br><span class="line">      elem.__resize_observer__.unobserve(elem)</span><br><span class="line">      elem.__resize_observer__.disconnect()</span><br><span class="line">      elem.__resize_observer__ = <span class="literal">null</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (elem.__resize_mutation_observer__) &#123;</span><br><span class="line">        elem.__resize_mutation_observer__.disconnect()</span><br><span class="line">        elem.__resize_mutation_observer__ = <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">      elem.removeEventListener(<span class="string">'scroll'</span>, handleScroll)</span><br><span class="line">      elem.removeChild(elem.__resize_triggers__.triggers)</span><br><span class="line">      elem.__resize_triggers__ = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    elem.__resize_listeners__ = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!--total &amp;&amp; style) &#123;</span><br><span class="line">    style.parentNode.removeChild(style)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUpdatedSize</span> (<span class="params">elem</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> &#123; width, height &#125; = elem.__resize_last__</span><br><span class="line">  <span class="keyword">let</span> &#123; offsetWidth, offsetHeight &#125; = elem</span><br><span class="line">  <span class="keyword">if</span> (offsetWidth !== width || offsetHeight !== height) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      width: offsetWidth,</span><br><span class="line">      height: offsetHeight</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleMutation</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// `this` denotes the scrolling element</span></span><br><span class="line">  <span class="keyword">let</span> &#123; rendered, detached &#125; = getRenderInfo(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">if</span> (rendered !== <span class="keyword">this</span>.__resize_rendered__) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!detached &amp;&amp; <span class="keyword">this</span>.__resize_triggers__) &#123;</span><br><span class="line">      resetTriggers(<span class="keyword">this</span>)</span><br><span class="line">      <span class="keyword">this</span>.addEventListener(<span class="string">'scroll'</span>, handleScroll, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.__resize_rendered__ = rendered</span><br><span class="line">    runCallbacks(<span class="keyword">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleScroll</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// `this` denotes the scrolling element</span></span><br><span class="line">  resetTriggers(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.__resize_raf__) &#123;</span><br><span class="line">    cancelAnimationFrame(<span class="keyword">this</span>.__resize_raf__)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.__resize_raf__ = requestAnimationFrame(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> updated = getUpdatedSize(<span class="keyword">this</span>)</span><br><span class="line">    <span class="keyword">if</span> (updated) &#123;</span><br><span class="line">      <span class="keyword">this</span>.__resize_last__ = updated</span><br><span class="line">      runCallbacks(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runCallbacks</span> (<span class="params">elem</span>) </span>&#123;</span><br><span class="line">  elem.__resize_listeners__.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> &#123;</span><br><span class="line">    callback.call(elem)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initTriggers</span> (<span class="params">elem</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> position = getComputedStyle(elem, <span class="string">'position'</span>)</span><br><span class="line">  <span class="keyword">if</span> (!position || position === <span class="string">'static'</span>) &#123;</span><br><span class="line">    elem.style.position = <span class="string">'relative'</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  elem.__resize_old_position__ = position</span><br><span class="line">  elem.__resize_last__ = &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> triggers = createElement(<span class="string">'div'</span>, &#123;</span><br><span class="line">    className: <span class="string">'resize-triggers'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">let</span> expand = createElement(<span class="string">'div'</span>, &#123;</span><br><span class="line">    className: <span class="string">'resize-expand-trigger'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">let</span> expandChild = createElement(<span class="string">'div'</span>)</span><br><span class="line">  <span class="keyword">let</span> contract = createElement(<span class="string">'div'</span>, &#123;</span><br><span class="line">    className: <span class="string">'resize-contract-trigger'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  expand.appendChild(expandChild)</span><br><span class="line">  triggers.appendChild(expand)</span><br><span class="line">  triggers.appendChild(contract)</span><br><span class="line">  elem.appendChild(triggers)</span><br><span class="line"></span><br><span class="line">  elem.__resize_triggers__ = &#123;</span><br><span class="line">    triggers,</span><br><span class="line">    expand,</span><br><span class="line">    expandChild,</span><br><span class="line">    contract</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resetTriggers(elem)</span><br><span class="line">  elem.addEventListener(<span class="string">'scroll'</span>, handleScroll, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">  elem.__resize_last__ = &#123;</span><br><span class="line">    width: elem.offsetWidth,</span><br><span class="line">    height: elem.offsetHeight</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resetTriggers</span> (<span class="params">elem</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> &#123; expand, expandChild, contract &#125; = elem.__resize_triggers__</span><br><span class="line"></span><br><span class="line">  <span class="comment">// batch read</span></span><br><span class="line">  <span class="keyword">let</span> &#123; <span class="attr">scrollWidth</span>: csw, <span class="attr">scrollHeight</span>: csh &#125; = contract</span><br><span class="line">  <span class="keyword">let</span> &#123; <span class="attr">offsetWidth</span>: eow, <span class="attr">offsetHeight</span>: eoh, <span class="attr">scrollWidth</span>: esw, <span class="attr">scrollHeight</span>: esh &#125; = expand</span><br><span class="line"></span><br><span class="line">  <span class="comment">// batch write</span></span><br><span class="line">  contract.scrollLeft = csw</span><br><span class="line">  contract.scrollTop = csh</span><br><span class="line">  expandChild.style.width = eow + <span class="number">1</span> + <span class="string">'px'</span></span><br><span class="line">  expandChild.style.height = eoh + <span class="number">1</span> + <span class="string">'px'</span></span><br><span class="line">  expand.scrollLeft = esw</span><br><span class="line">  expand.scrollTop = esh</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//util.js</span></span><br><span class="line"><span class="keyword">let</span> raf = <span class="literal">null</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">requestAnimationFrame</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!raf) &#123;</span><br><span class="line">    raf = (</span><br><span class="line">      <span class="built_in">window</span>.requestAnimationFrame ||</span><br><span class="line">      <span class="built_in">window</span>.webkitRequestAnimationFrame ||</span><br><span class="line">      <span class="built_in">window</span>.mozRequestAnimationFrame ||</span><br><span class="line">      <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> setTimeout(callback, <span class="number">16</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ).bind(<span class="built_in">window</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> raf(callback)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> caf = <span class="literal">null</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">cancelAnimationFrame</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!caf) &#123;</span><br><span class="line">    caf = (</span><br><span class="line">      <span class="built_in">window</span>.cancelAnimationFrame ||</span><br><span class="line">      <span class="built_in">window</span>.webkitCancelAnimationFrame ||</span><br><span class="line">      <span class="built_in">window</span>.mozCancelAnimationFrame ||</span><br><span class="line">      <span class="function"><span class="keyword">function</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">        clearTimeout(id)</span><br><span class="line">      &#125;</span><br><span class="line">    ).bind(<span class="built_in">window</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  caf(id)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createStyles</span> (<span class="params">styleText</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> style = <span class="built_in">document</span>.createElement(<span class="string">'style'</span>)</span><br><span class="line">  style.type = <span class="string">'text/css'</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (style.styleSheet) &#123;</span><br><span class="line">    style.styleSheet.cssText = styleText</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    style.appendChild(<span class="built_in">document</span>.createTextNode(styleText))</span><br><span class="line">  &#125;</span><br><span class="line">  (<span class="built_in">document</span>.querySelector(<span class="string">'head'</span>) || <span class="built_in">document</span>.body).appendChild(style)</span><br><span class="line">  <span class="keyword">return</span> style</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElement</span> (<span class="params">tagName, props = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> elem = <span class="built_in">document</span>.createElement(tagName)</span><br><span class="line">  <span class="built_in">Object</span>.keys(props).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    elem[key] = props[key]</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> elem</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getComputedStyle</span> (<span class="params">elem, prop, pseudo</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// for older versions of Firefox, `getComputedStyle` required</span></span><br><span class="line">  <span class="comment">// the second argument and may return `null` for some elements</span></span><br><span class="line">  <span class="comment">// when `display: none`</span></span><br><span class="line">  <span class="keyword">let</span> computedStyle = <span class="built_in">window</span>.getComputedStyle(elem, pseudo || <span class="literal">null</span>) || &#123;</span><br><span class="line">    display: <span class="string">'none'</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> computedStyle[prop]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getRenderInfo</span> (<span class="params">elem</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">document</span>.documentElement.contains(elem)) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      detached: <span class="literal">true</span>,</span><br><span class="line">      rendered: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> current = elem</span><br><span class="line">  <span class="keyword">while</span> (current !== <span class="built_in">document</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (getComputedStyle(current, <span class="string">'display'</span>) === <span class="string">'none'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        detached: <span class="literal">false</span>,</span><br><span class="line">        rendered: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    current = current.parentNode</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    detached: <span class="literal">false</span>,</span><br><span class="line">    rendered: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自适应滚动条"><a href="#自适应滚动条" class="headerlink" title="自适应滚动条"></a>自适应滚动条</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">"box"</span> <span class="attr">class</span>=<span class="string">"scrollbar_box"</span> </span></span><br><span class="line"><span class="tag">		@<span class="attr">wheel</span>=<span class="string">"scroll"</span> </span></span><br><span class="line"><span class="tag">		@<span class="attr">mouseenter</span>=<span class="string">"mouseenter($event)"</span></span></span><br><span class="line"><span class="tag">		@<span class="attr">mouseleave</span>=<span class="string">"mouseleave($event)"</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">"container"</span> <span class="attr">class</span>=<span class="string">"scrollbar_container"</span> </span></span><br><span class="line"><span class="tag">			<span class="attr">:style</span>=<span class="string">"&#123; transform : `translate(0px, $&#123;top*-1&#125;px)` &#125;"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">slot</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">"scrollbarPath"</span> <span class="attr">class</span>=<span class="string">"scrollbar_path"</span> </span></span><br><span class="line"><span class="tag">			<span class="attr">v-show</span>=<span class="string">"isVerticalBtn"</span> </span></span><br><span class="line"><span class="tag">			<span class="attr">:class</span>=<span class="string">"&#123;on: verticalCur&#125;"</span>&gt;</span></span><br><span class="line">			</span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">"verticalBtn"</span> </span></span><br><span class="line"><span class="tag">				<span class="attr">class</span>=<span class="string">"scrollbar_verticalBtn"</span> </span></span><br><span class="line"><span class="tag">				<span class="attr">:style</span>=<span class="string">"&#123; height: `$&#123;barHeight&#125;%`, top : `$&#123;barTop&#125;%` &#125;"</span> </span></span><br><span class="line"><span class="tag">				@<span class="attr">mousedown</span>=<span class="string">"startmoveV"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">import</span> ElementResizeDetectorMaker <span class="keyword">from</span> <span class="string">'element-resize-detector'</span></span></span><br><span class="line"><span class="javascript">	<span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">		data() &#123;</span><br><span class="line"><span class="javascript">			<span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">				top: <span class="number">0</span>, <span class="comment">//box偏移量px</span></span></span><br><span class="line">				</span><br><span class="line"><span class="javascript">				barHeight: <span class="number">0</span>, <span class="comment">//竖直滚动条高度</span></span></span><br><span class="line"><span class="javascript">				barTop: <span class="number">0</span>, <span class="comment">//竖直滚动条上下偏移量%</span></span></span><br><span class="line">				</span><br><span class="line"><span class="javascript">				isVerticalBtn: <span class="literal">false</span>, <span class="comment">//竖直滚动条是否显示</span></span></span><br><span class="line"><span class="javascript">				verticalCur: <span class="literal">false</span>,  <span class="comment">//鼠标悬浮滚动条显示</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript">				isStartmoveV: <span class="literal">false</span>, <span class="comment">//点击拖拽垂直标志位</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript">				point: &#123; <span class="comment">//相对拖快左上角的x,y坐标</span></span></span><br><span class="line">					y: 0</span><br><span class="line">				&#125;,</span><br><span class="line">				</span><br><span class="line"><span class="javascript">				boxPoint: &#123; <span class="comment">// 4个角容器的坐标</span></span></span><br><span class="line">					minY: 0</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		props: &#123;</span><br><span class="line"><span class="javascript">			speed: &#123; <span class="comment">//鼠标滚轮速度</span></span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">Number</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="number">20</span></span></span><br><span class="line">			&#125;,</span><br><span class="line"></span><br><span class="line"><span class="javascript">			changeTop: &#123; <span class="comment">//上下偏移量 px</span></span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">Number</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="number">0</span></span></span><br><span class="line">			&#125;,</span><br><span class="line">			</span><br><span class="line"><span class="javascript">			containerH:&#123;  <span class="comment">//滚动区域高度</span></span></span><br><span class="line"><span class="javascript">				type: <span class="built_in">Number</span>,</span></span><br><span class="line"><span class="javascript">				<span class="keyword">default</span>: <span class="number">0</span></span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		watch: &#123;</span><br><span class="line"><span class="javascript">			changeTop() &#123; <span class="comment">// 当外面传这个发送变化时就让到这个位置</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.setbarTop();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.setbarHeight();</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		computed: &#123;&#125;,</span><br><span class="line">		methods: &#123;</span><br><span class="line">			mouseenter() &#123;</span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.verticalCur = <span class="literal">true</span>;</span></span><br><span class="line">			&#125;,</span><br><span class="line">			mouseleave() &#123;</span><br><span class="line"><span class="javascript">				setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.verticalCur = <span class="literal">false</span>;</span></span><br><span class="line">				&#125;, 1000)</span><br><span class="line">			&#125;,</span><br><span class="line"><span class="javascript">			<span class="comment">// 滚动</span></span></span><br><span class="line">			scroll(e) &#123;</span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.verticalCur = <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.isVerticalBtn) &#123;</span></span><br><span class="line">					e.preventDefault();</span><br><span class="line">					e.stopPropagation();</span><br><span class="line"><span class="javascript">				&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line">				&#125;</span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> speed = <span class="keyword">this</span>.speed;</span></span><br><span class="line">				</span><br><span class="line"><span class="javascript">				<span class="comment">//如果delta的值是负的，那么滚轮就是向下滚动，正的就是向上</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> scrollY = e.deltaY &gt; <span class="number">0</span> ? speed * <span class="number">1</span> : speed * <span class="number">-1</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> nextY = <span class="keyword">this</span>.top * <span class="number">1</span> + scrollY;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">				<span class="comment">// 如果没有垂直的滚动条就滚动横向的</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.isVerticalBtn) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.setVerticalScroll(nextY)</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line"><span class="javascript">			<span class="comment">//val是偏移量 滚动的 </span></span></span><br><span class="line">			setVerticalScroll(val) &#123; </span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> size = <span class="keyword">this</span>.getSize();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> topEnd = size.containerHeight - size.boxHeight;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(val &gt;= topEnd) &#123;</span></span><br><span class="line">					val = topEnd;</span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="keyword">this</span>.top == val) &#123; <span class="comment">// 已经到底部就不用继续执行了</span></span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line">					&#125;</span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.$emit(<span class="string">'bottom'</span>);</span></span><br><span class="line">				&#125;;</span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(val &lt;= <span class="number">0</span>) &#123;</span></span><br><span class="line">					val = 0;</span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="keyword">this</span>.top == val) &#123; <span class="comment">// 已经到顶部就不用继续执行了</span></span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line">					&#125;</span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.$emit(<span class="string">'top'</span>);</span></span><br><span class="line">				&#125;</span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.top = val;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.$emit(<span class="string">'update:changeTop'</span>, <span class="keyword">this</span>.top);</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.$emit(<span class="string">'update:containerH'</span>, size.containerHeight);</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.barTop = (val / size.containerHeight) * <span class="number">100</span>; <span class="comment">// 导航条的top的计算 </span></span></span><br><span class="line">			&#125;,</span><br><span class="line"><span class="javascript">			<span class="comment">// 垂直btn点击后的事件</span></span></span><br><span class="line">			startmoveV(e) &#123;</span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.verticalCur = <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">				e.preventDefault(); <span class="comment">//阻止默认事件，取消文字选中</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> verticalBtnReat=<span class="keyword">this</span>.$refs.verticalBtn.getBoundingClientRect()  <span class="comment">//获取滑块的坐标</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.point.y = e.clientY-verticalBtnReat.top</span></span><br><span class="line">				</span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.isStartmoveV = <span class="literal">true</span> <span class="comment">//鼠标按下标志位</span></span></span><br><span class="line">				</span><br><span class="line"><span class="javascript">				<span class="built_in">document</span>.addEventListener(<span class="string">'mousemove'</span>, <span class="keyword">this</span>.fnMousemoveV, <span class="literal">false</span>);</span></span><br><span class="line"><span class="javascript">				<span class="built_in">document</span>.addEventListener(<span class="string">'mouseup'</span>, <span class="keyword">this</span>.fnMouseup, <span class="literal">false</span>);</span></span><br><span class="line">			&#125;,</span><br><span class="line"><span class="javascript">			<span class="comment">// 垂直移动监听</span></span></span><br><span class="line">			fnMousemoveV(e) &#123;</span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.verticalCur = <span class="literal">true</span>;</span></span><br><span class="line">				e.preventDefault();</span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.isStartmoveV) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.setVerticalClick(e.clientY - <span class="keyword">this</span>.point.y);   <span class="comment">//鼠标移动位置</span></span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line"><span class="javascript">			<span class="comment">// 点击拖拽设置</span></span></span><br><span class="line">			setVerticalClick(val) &#123;</span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.verticalCur = <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> size = <span class="keyword">this</span>.getSize();</span></span><br><span class="line">				</span><br><span class="line"><span class="javascript">				<span class="comment">//计算出拖快top值换算成百分比</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> barTop = ((val - <span class="keyword">this</span>.boxPoint.minY) / <span class="keyword">this</span>.$refs.box.clientHeight) * <span class="number">100</span>; </span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(barTop &lt;= <span class="number">0</span>) &#123;</span></span><br><span class="line">					barTop = 0;</span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="keyword">this</span>.barTop == barTop) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line">					&#125;</span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.$emit(<span class="string">'top'</span>);</span></span><br><span class="line">				&#125;</span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(barTop + <span class="keyword">this</span>.barHeight &gt;= <span class="number">100</span>) &#123;</span></span><br><span class="line"><span class="javascript">					barTop = <span class="number">100</span> - <span class="keyword">this</span>.barHeight;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="keyword">this</span>.barTop == barTop) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line">					&#125;</span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.$emit(<span class="string">'bottom'</span>);</span></span><br><span class="line">				&#125;</span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.barTop = barTop; <span class="comment">// 这里是百分比的需要转换</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.top = ((barTop / <span class="number">100</span>) * size.containerHeight).toFixed(<span class="number">2</span>) * <span class="number">1</span>; <span class="comment">//换算百分百</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.$emit(<span class="string">'update:changeTop'</span>, <span class="keyword">this</span>.top);</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.$emit(<span class="string">'update:containerH'</span>, size.containerHeight);</span></span><br><span class="line">			&#125;,</span><br><span class="line"><span class="javascript">			<span class="comment">// 鼠标抬起监听</span></span></span><br><span class="line">			fnMouseup(e) &#123;</span><br><span class="line">				e.preventDefault();</span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.isStartmoveV = <span class="literal">false</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.clearMousemove();</span></span><br><span class="line">			&#125;,</span><br><span class="line"><span class="javascript">			<span class="comment">// 清除监听</span></span></span><br><span class="line">			clearMousemove() &#123;</span><br><span class="line"><span class="javascript">				<span class="built_in">document</span>.removeEventListener(<span class="string">'mousemove'</span>, <span class="keyword">this</span>.fnMousemoveV, <span class="literal">false</span>);</span></span><br><span class="line"><span class="javascript">				<span class="built_in">document</span>.removeEventListener(<span class="string">'mouseup'</span>, <span class="keyword">this</span>.fnMouseup, <span class="literal">false</span>);</span></span><br><span class="line">			&#125;,</span><br><span class="line"><span class="javascript">			<span class="comment">// 返回盒子尺寸</span></span></span><br><span class="line">			getSize() &#123; </span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> _container = <span class="keyword">this</span>.$refs.container;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> _box = <span class="keyword">this</span>.$refs.box;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">					containerHeight: _container.clientHeight, <span class="comment">//滚动内容的高度宽度</span></span></span><br><span class="line">					containerWidth: _container.clientWidth,</span><br><span class="line"></span><br><span class="line"><span class="javascript">					boxHeight: _box.clientHeight, <span class="comment">//最外面盒子的高度宽度</span></span></span><br><span class="line">					boxWidth: _box.clientWidth,</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line"><span class="javascript">			setbarHeight() &#123; <span class="comment">//设置拖快高度</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> size = <span class="keyword">this</span>.getSize();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> boxPoint = <span class="keyword">this</span>.$refs.box.getBoundingClientRect(); <span class="comment">// container的极坐标</span></span></span><br><span class="line">				</span><br><span class="line"><span class="javascript">				<span class="comment">// 保存box窗口坐标</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.boxPoint.minY = boxPoint.top;</span></span><br><span class="line">				</span><br><span class="line"><span class="javascript">				<span class="comment">// 计算拖拽条的宽高</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.barHeight = (size.boxHeight / size.containerHeight) * <span class="number">100</span>; <span class="comment">//100是百分比，box的高度是100%,比例计算</span></span></span><br><span class="line">				</span><br><span class="line"><span class="javascript">				<span class="comment">// 是否显示拖拽条</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.isVerticalBtn = (<span class="keyword">this</span>.barHeight &gt;= <span class="number">100</span> &amp;&amp; !!<span class="keyword">this</span>.barHeight) ? <span class="literal">false</span> : <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(!<span class="keyword">this</span>.isVerticalBtn) &#123;  <span class="comment">//不显示滚动条清0 </span></span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.top = <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.barTop = <span class="number">0</span>;</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			setbarTop() &#123;</span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.top == <span class="keyword">this</span>.changeTop) <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> size = <span class="keyword">this</span>.getSize();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> topEnd = size.containerHeight - size.boxHeight;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="keyword">this</span>.changeTop &lt; <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.top = <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">				&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.changeTop &gt;= topEnd) &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.top = topEnd;</span></span><br><span class="line"><span class="javascript">				&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.top = <span class="keyword">this</span>.changeTop;</span></span><br><span class="line">				&#125;</span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.barTop = ((<span class="keyword">this</span>.top * <span class="number">100</span>) / size.containerHeight) * <span class="number">1</span>;</span></span><br><span class="line">			&#125;,</span><br><span class="line">			resizeListener() &#123;</span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> elementResizeDetector = ElementResizeDetectorMaker(&#123;</span></span><br><span class="line"><span class="javascript">					strategy: <span class="string">'scroll'</span>,</span></span><br><span class="line"><span class="javascript">					callOnAdd: <span class="literal">false</span></span></span><br><span class="line">				&#125;)</span><br><span class="line">				</span><br><span class="line"><span class="javascript">				elementResizeDetector.listenTo(<span class="keyword">this</span>.$refs.container, () =&gt; &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> newcontainerH = <span class="keyword">this</span>.$slots.default[<span class="number">0</span>][<span class="string">'elm'</span>]</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(<span class="keyword">this</span>.top==<span class="number">0</span>)&#123;</span></span><br><span class="line"><span class="javascript">						<span class="built_in">console</span>.log(newcontainerH.clientHeight-<span class="keyword">this</span>.containerH)</span></span><br><span class="line"><span class="javascript">						<span class="keyword">var</span> top=newcontainerH.clientHeight-<span class="keyword">this</span>.containerH;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.$emit(<span class="string">'update:changeTop'</span>, top);</span></span><br><span class="line">					&#125;</span><br><span class="line">					</span><br><span class="line">				&#125;)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		mounted() &#123;</span><br><span class="line"><span class="javascript">			<span class="keyword">this</span>.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.setbarTop();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.setbarHeight();</span></span><br><span class="line">				</span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.resizeListener();</span></span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;,</span><br><span class="line"><span class="javascript">		updated() &#123; <span class="comment">//由于数据更改导致的虚拟 DOM 重新渲染和打补丁，在这之后会调用该钩子</span></span></span><br><span class="line"><span class="javascript">			<span class="keyword">this</span>.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.setbarTop();</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.setbarHeight();</span></span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span> <span class="attr">lang</span>=<span class="string">"less"</span>&gt;</span></span><br><span class="line"><span class="css">	<span class="selector-class">.scrollbar_box</span> &#123;</span></span><br><span class="line">		overflow: hidden;</span><br><span class="line">		position: relative;</span><br><span class="line">		height: 100%;</span><br><span class="line">		width: 100%;</span><br><span class="line">		transform: translateZ(0);</span><br><span class="line">		backface-visibility: hidden;</span><br><span class="line">		perspective: 1000;</span><br><span class="line">		transform: translate3d(0, 0, 0);</span><br><span class="line"><span class="css">		<span class="selector-class">.scrollbar_path</span> &#123;</span></span><br><span class="line">			position: absolute;</span><br><span class="line">			top: 0px;</span><br><span class="line">			right: 0px;</span><br><span class="line">			width: 6px;</span><br><span class="line">			height: 100%;</span><br><span class="line">			background-color: white;</span><br><span class="line">			opacity: 0;</span><br><span class="line">			transition: opacity 500ms;</span><br><span class="line"><span class="css">			&amp;<span class="selector-class">.on</span> &#123;</span></span><br><span class="line">				opacity: 1;</span><br><span class="line">			&#125;</span><br><span class="line"><span class="css">			<span class="selector-class">.scrollbar_verticalBtn</span> &#123;</span></span><br><span class="line">				position: absolute;</span><br><span class="line">				top: 0px;</span><br><span class="line">				right: 0px;</span><br><span class="line">				width: 6px;</span><br><span class="line">				border-radius: 3px;</span><br><span class="line"><span class="css">				<span class="selector-tag">background-color</span>: <span class="selector-id">#51555e</span>;</span></span><br><span class="line">				cursor: pointer;</span><br><span class="line">				z-index: 50;</span><br><span class="line"><span class="css">				&amp;<span class="selector-pseudo">:hover</span> &#123;</span></span><br><span class="line">					background-color: green;</span><br><span class="line">					z-index: 51;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用方法</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"box"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">scrollbar</span> @<span class="attr">bottom</span>=<span class="string">"bottom"</span> @<span class="attr">top</span>=<span class="string">"top"</span> <span class="attr">:changeTop.sync</span>=<span class="string">"changeTop"</span> <span class="attr">:containerH.sync</span>=<span class="string">"containerH"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">				<span class="comment">&lt;!--&lt;p&gt;Vue自定义滚动条&lt;/p&gt;--&gt;</span></span><br><span class="line"> 				<span class="tag">&lt;<span class="name">div</span> <span class="attr">v-for</span>=<span class="string">"(str,index) in data"</span>&gt;</span> &#123;&#123;str&#125;&#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">scrollbar</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"loadingbox"</span> <span class="attr">v-show</span>=<span class="string">"isloading"</span>&gt;</span>loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">import</span> scrollbar <span class="keyword">from</span> <span class="string">'./vue-scroll.vue'</span></span></span><br><span class="line"><span class="javascript">	<span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">		components: &#123;</span><br><span class="line">			scrollbar</span><br><span class="line">		&#125;,</span><br><span class="line">		data() &#123;</span><br><span class="line"><span class="javascript">			<span class="keyword">return</span> &#123;</span></span><br><span class="line">				data: [...Array(30).keys()],</span><br><span class="line"><span class="javascript">				isloading: <span class="literal">false</span>,</span></span><br><span class="line">				changeTop: 10000000,</span><br><span class="line">				containerH:0</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		methods: &#123;</span><br><span class="line">			top() &#123;</span><br><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'顶部'</span>);</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.isloading = <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> newdata = [</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line">				];</span><br><span class="line"><span class="javascript">				setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.data = [...newdata,...this.data];</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.isloading = <span class="literal">false</span>;</span></span><br><span class="line">				&#125;, 1500);</span><br><span class="line">			&#125;,</span><br><span class="line">			bottom() &#123;</span><br><span class="line"><span class="javascript">				<span class="keyword">return</span></span></span><br><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'底部'</span>)</span></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.isloading = <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">var</span> newdata = [</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line"><span class="javascript">					<span class="string">'我是新加的数据'</span>,</span></span><br><span class="line">				];</span><br><span class="line"><span class="javascript">				setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.data = [...this.data,...newdata];</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.isloading = <span class="literal">false</span>;</span></span><br><span class="line">				&#125;, 1500);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">	* &#123;</span><br><span class="line">		padding: 0px;</span><br><span class="line">		margin: 0px;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"><span class="css">	<span class="selector-id">#box</span> &#123;</span></span><br><span class="line">		margin: 50px auto;</span><br><span class="line">		text-align: center;</span><br><span class="line">		width: 500px;</span><br><span class="line">		height: 500px;</span><br><span class="line">		border: 1px solid red;</span><br><span class="line">		border-radius: 3px;</span><br><span class="line">		position: relative;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"><span class="css">	<span class="selector-id">#container</span> &#123;</span></span><br><span class="line">		width: 100%;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"><span class="css">	<span class="selector-id">#loadingbox</span> &#123;</span></span><br><span class="line">		width: 100%;</span><br><span class="line"><span class="css">		<span class="selector-tag">background</span>: <span class="selector-tag">rgba</span>(255, 255, 255, <span class="selector-class">.8</span>);</span></span><br><span class="line">		position: absolute;</span><br><span class="line">		left: 0;</span><br><span class="line">		bottom: 0;</span><br><span class="line">		text-align: center;</span><br><span class="line">		font-weight: bold;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="模拟windows的resize"><a href="#模拟windows的resize" class="headerlink" title="模拟windows的resize"></a>模拟windows的resize</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/vue.js"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span></span><br><span class="line">			html,body&#123;</span><br><span class="line">				width: 100%;</span><br><span class="line">				height: 100%;</span><br><span class="line">			&#125;</span><br><span class="line"><span class="css">			<span class="selector-class">.container</span> &#123;</span></span><br><span class="line">				width: 100%;</span><br><span class="line">				height: 100%;</span><br><span class="line">				position: relative</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line"><span class="css">			<span class="selector-class">.resize-element</span> &#123;</span></span><br><span class="line">				position: absolute;</span><br><span class="line">				top: 50%;</span><br><span class="line">				left: 50%;</span><br><span class="line">				height: 10rem;</span><br><span class="line">				width: 10rem;</span><br><span class="line">				transform: translate(-50%,-50%);</span><br><span class="line">				overflow: hidden;</span><br><span class="line"><span class="css">				<span class="selector-tag">resize</span>: <span class="selector-tag">both</span>;   <span class="comment">/*用户可以调节元素的宽度和高度*/</span></span></span><br><span class="line">				display: block;</span><br><span class="line"><span class="css">				<span class="selector-tag">box-shadow</span>: 0 0 1<span class="selector-tag">px</span> 1<span class="selector-tag">px</span> <span class="selector-id">#3361D8</span>;</span></span><br><span class="line">				border-radius: 2px;</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span> <span class="attr">id</span>=<span class="string">"main"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"resize-element"</span>&gt;</span></span><br><span class="line">				改变大小试试</span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"resize-record"</span>&gt;</span></span><br><span class="line">				窗口触发了&#123;&#123;firedNum&#125;&#125;次resize事件。</span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">const</span> CSS = <span class="string">'position:absolute;left:0;top:-100%;width:100%;height:100%;margin:1px 0 0;border:none;opacity:0;visibility:hidden;pointer-events:none;'</span>;</span></span><br><span class="line"><span class="javascript">			<span class="function"><span class="keyword">function</span> <span class="title">observeResize</span>(<span class="params">element, handler</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> frame = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span></span><br><span class="line">				frame.style.cssText = CSS;</span><br><span class="line"><span class="javascript">				frame.onload = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">					frame.contentWindow.onresize = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line">						handler(element);</span><br><span class="line">					&#125;;</span><br><span class="line">				&#125;;</span><br><span class="line">				element.appendChild(frame);</span><br><span class="line"><span class="javascript">				<span class="keyword">return</span> frame;</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">			<span class="keyword">let</span> element = <span class="built_in">document</span>.getElementById(<span class="string">'main'</span>);</span></span><br><span class="line"><span class="javascript">			<span class="comment">// listen for resize</span></span></span><br><span class="line">			observeResize(element, () =&gt; &#123;</span><br><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'new size: '</span>, &#123;</span></span><br><span class="line">					width: element.clientWidth,</span><br><span class="line">					height: element.clientHeight</span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;);</span><br><span class="line">		<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="实现一个简单的div-resize-Listener"><a href="#实现一个简单的div-resize-Listener" class="headerlink" title="实现一个简单的div resize Listener"></a>实现一个简单的div resize Listener</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span>Example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">			<span class="function"><span class="keyword">function</span> <span class="title">ResizeSensor</span>(<span class="params">element, callback</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">				<span class="function"><span class="keyword">function</span> <span class="title">EventQueue</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.q = [];</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.add = <span class="function"><span class="keyword">function</span>(<span class="params">ev</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">this</span>.q.push(ev);</span></span><br><span class="line">					&#125;;</span><br><span class="line"></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> i, j;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">this</span>.call = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">for</span>(i = <span class="number">0</span>, j = <span class="keyword">this</span>.q.length; i &lt; j; i++) &#123;</span></span><br><span class="line"><span class="javascript">							<span class="keyword">this</span>.q[i].call();</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">				<span class="function"><span class="keyword">function</span> <span class="title">getComputedStyle</span>(<span class="params">element, prop</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(element.currentStyle) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> element.currentStyle[prop];</span></span><br><span class="line"><span class="javascript">					&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">window</span>.getComputedStyle) &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> <span class="built_in">window</span>.getComputedStyle(element, <span class="literal">null</span>).getPropertyValue(prop);</span></span><br><span class="line"><span class="javascript">					&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">return</span> element.style[prop];</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">				<span class="function"><span class="keyword">function</span> <span class="title">attachResizeEvent</span>(<span class="params">element, resized</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(!element.resizedAttached) &#123;</span></span><br><span class="line"><span class="javascript">						element.resizedAttached = <span class="keyword">new</span> EventQueue();</span></span><br><span class="line">						element.resizedAttached.add(resized);</span><br><span class="line"><span class="javascript">					&#125; <span class="keyword">else</span> <span class="keyword">if</span>(element.resizedAttached) &#123;</span></span><br><span class="line">						element.resizedAttached.add(resized);</span><br><span class="line"><span class="javascript">						<span class="keyword">return</span>;</span></span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">					element.resizeSensor = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span></span><br><span class="line"><span class="javascript">					element.resizeSensor.className = <span class="string">'resize-sensor'</span>;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> style = <span class="string">'position: absolute; left: 0; top: 0; right: 0; bottom: 0; overflow: scroll; z-index: -1; visibility: hidden;'</span>;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> styleChild = <span class="string">'position: absolute; left: 0; top: 0;'</span>;</span></span><br><span class="line"></span><br><span class="line">					element.resizeSensor.style.cssText = style;</span><br><span class="line">					element.resizeSensor.innerHTML =</span><br><span class="line"><span class="xml">						'<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"resize-sensor-expand"</span> <span class="attr">style</span>=<span class="string">"' + style + '"</span>&gt;</span>' +</span></span><br><span class="line"><span class="xml">						'<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"' + styleChild + '"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>' +</span></span><br><span class="line"><span class="javascript">						<span class="string">'&lt;/div&gt;'</span> +</span></span><br><span class="line"><span class="xml">						'<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"resize-sensor-shrink"</span> <span class="attr">style</span>=<span class="string">"' + style + '"</span>&gt;</span>' +</span></span><br><span class="line"><span class="xml">						'<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"' + styleChild + ' width: 200%; height: 200%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>' +</span></span><br><span class="line"><span class="javascript">						<span class="string">'&lt;/div&gt;'</span>;</span></span><br><span class="line">					element.appendChild(element.resizeSensor);</span><br><span class="line"></span><br><span class="line"><span class="javascript">					<span class="keyword">if</span>(!&#123;</span></span><br><span class="line">							fixed: 1,</span><br><span class="line">							absolute: 1</span><br><span class="line"><span class="javascript">						&#125;[getComputedStyle(element, <span class="string">'position'</span>)]) &#123;</span></span><br><span class="line"><span class="javascript">						element.style.position = <span class="string">'relative'</span>;</span></span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> expand = element.resizeSensor.childNodes[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> expandChild = expand.childNodes[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> shrink = element.resizeSensor.childNodes[<span class="number">1</span>];</span></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> shrinkChild = shrink.childNodes[<span class="number">0</span>];</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> lastWidth, lastHeight;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> reset = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						expandChild.style.width = expand.offsetWidth + <span class="number">10</span> + <span class="string">'px'</span>;</span></span><br><span class="line"><span class="javascript">						expandChild.style.height = expand.offsetHeight + <span class="number">10</span> + <span class="string">'px'</span>;</span></span><br><span class="line">						expand.scrollLeft = expand.scrollWidth;</span><br><span class="line">						expand.scrollTop = expand.scrollHeight;</span><br><span class="line">						shrink.scrollLeft = shrink.scrollWidth;</span><br><span class="line">						shrink.scrollTop = shrink.scrollHeight;</span><br><span class="line">						lastWidth = element.offsetWidth;</span><br><span class="line">						lastHeight = element.offsetHeight;</span><br><span class="line">					&#125;;</span><br><span class="line"></span><br><span class="line">					reset();</span><br><span class="line"></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> changed = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(element.resizedAttached) &#123;</span></span><br><span class="line">							element.resizedAttached.call();</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;;</span><br><span class="line"></span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> addEvent = <span class="function"><span class="keyword">function</span>(<span class="params">el, name, cb</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(el.attachEvent) &#123;</span></span><br><span class="line"><span class="javascript">							el.attachEvent(<span class="string">'on'</span> + name, cb);</span></span><br><span class="line"><span class="javascript">						&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line">							el.addEventListener(name, cb);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;;</span><br><span class="line"></span><br><span class="line"><span class="javascript">					addEvent(expand, <span class="string">'scroll'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(element.offsetWidth &gt; lastWidth || element.offsetHeight &gt; lastHeight) &#123;</span></span><br><span class="line">							changed();</span><br><span class="line">						&#125;</span><br><span class="line">						reset();</span><br><span class="line">					&#125;);</span><br><span class="line"></span><br><span class="line"><span class="javascript">					addEvent(shrink, <span class="string">'scroll'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">						<span class="keyword">if</span>(element.offsetWidth &lt; lastWidth || element.offsetHeight &lt; lastHeight) &#123;</span></span><br><span class="line">							changed();</span><br><span class="line">						&#125;</span><br><span class="line">						reset();</span><br><span class="line">					&#125;);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(<span class="string">"[object Array]"</span> === <span class="built_in">Object</span>.prototype.toString.call(element) ||(<span class="string">'undefined'</span> !== <span class="keyword">typeof</span> jQuery &amp;&amp; element <span class="keyword">instanceof</span> jQuery) <span class="comment">//jquery</span></span></span><br><span class="line"><span class="javascript">					||(<span class="string">'undefined'</span> !== <span class="keyword">typeof</span> Elements &amp;&amp; element <span class="keyword">instanceof</span> Elements) <span class="comment">//mootools</span></span></span><br><span class="line">				) &#123;</span><br><span class="line"><span class="javascript">					<span class="keyword">var</span> i = <span class="number">0</span>,</span></span><br><span class="line">						j = element.length;</span><br><span class="line"><span class="javascript">					<span class="keyword">for</span>(; i &lt; j; i++) &#123;</span></span><br><span class="line">						attachResizeEvent(element[i], callback);</span><br><span class="line">					&#125;</span><br><span class="line"><span class="javascript">				&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line">					attachResizeEvent(element, callback);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">				<span class="keyword">this</span>.detach = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line">					ResizeSensor.detach(element);</span><br><span class="line">				&#125;;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line"><span class="javascript">			ResizeSensor.detach = <span class="function"><span class="keyword">function</span>(<span class="params">element</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">				<span class="keyword">if</span>(element.resizeSensor) &#123;</span></span><br><span class="line">					element.removeChild(element.resizeSensor);</span><br><span class="line"><span class="javascript">					<span class="keyword">delete</span> element.resizeSensor;</span></span><br><span class="line"><span class="javascript">					<span class="keyword">delete</span> element.resizedAttached;</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;;</span><br><span class="line">		<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"width"</span>&gt;</span>100px wide<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"main"</span> <span class="attr">style</span>=<span class="string">"resize:both;width:100px;overflow:scroll;border:1px solid black;"</span> <span class="attr">id</span>=<span class="string">"resize"</span>&gt;</span>You can resize me!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">"textarea"</span>&gt;</span>You can focus me!<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">var</span> sensor = <span class="keyword">new</span> ResizeSensor(<span class="built_in">document</span>.getElementById(<span class="string">"main"</span>),<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">					<span class="built_in">console</span>.log(<span class="string">"anything inside of element caused my size to change"</span>);</span></span><br><span class="line">				&#125;)</span><br><span class="line"><span class="javascript">			<span class="keyword">var</span> sensor2 = <span class="keyword">new</span> ResizeSensor(<span class="built_in">document</span>.getElementById(<span class="string">"textarea"</span>),<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">					<span class="built_in">console</span>.log(<span class="string">"anything inside of element caused my size to change"</span>);</span></span><br><span class="line">				&#125;)</span><br><span class="line">		<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="一段监视-DOM-的神奇代码"><a href="#一段监视-DOM-的神奇代码" class="headerlink" title="一段监视 DOM 的神奇代码"></a><a href="https://juejin.im/post/5dc9276a5188251d47166dcc" target="_blank" rel="noopener">一段监视 DOM 的神奇代码</a></h3>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Event-Loop/" rel="tag"># Event Loop</a>
          
            <a href="/tags/js/" rel="tag"># js</a>
          
            <a href="/tags/nextTick/" rel="tag"># nextTick</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/12/31/ES6之-Generator-的惰性执行/" rel="next" title="ES6之 Generator 的惰性执行">
                <i class="fa fa-chevron-left"></i> ES6之 Generator 的惰性执行
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/02/JS实现多行溢出省略号思路/" rel="prev" title="JS实现多行溢出省略号思路">
                JS实现多行溢出省略号思路 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/tx.jpg" alt="李斌">
            
              <p class="site-author-name" itemprop="name">李斌</p>
              <p class="site-description motion-element" itemprop="description">人生如逆旅     我亦是行人</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">201</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">121</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/libin1991" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://juejin.im/user/57e737f6c4c971005f6bcd8d" target="_blank" title="juejin">
                      
                        <i class="fa fa-fw fa-spinner"></i>juejin</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#MutationObserver介绍"><span class="nav-number">1.</span> <span class="nav-text">MutationObserver介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#构造函数为window-MutationObserver，参数为一个回调函数。"><span class="nav-number">1.1.</span> <span class="nav-text">构造函数为window.MutationObserver，参数为一个回调函数。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#调用接口开始监控DOM。"><span class="nav-number">1.2.</span> <span class="nav-text">调用接口开始监控DOM。</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MutationObserver实现Vue-nextTick"><span class="nav-number">2.</span> <span class="nav-text">MutationObserver实现Vue nextTick</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#nextTick-的源码实现"><span class="nav-number">2.1.</span> <span class="nav-text">nextTick 的源码实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从Vue-2-5-开始，抽出来了一个单独的文件next-tick-js来执行它"><span class="nav-number">2.2.</span> <span class="nav-text">从Vue 2.5+开始，抽出来了一个单独的文件next-tick.js来执行它</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Event-Loop"><span class="nav-number">2.3.</span> <span class="nav-text">Event Loop</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#具体过程"><span class="nav-number">2.4.</span> <span class="nav-text">具体过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MutationObserver-的功能和作用"><span class="nav-number">3.</span> <span class="nav-text">MutationObserver 的功能和作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MutationObserver-和-microtask"><span class="nav-number">4.</span> <span class="nav-text">MutationObserver 和 microtask</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Vue-nextTick的版本迭代"><span class="nav-number">5.</span> <span class="nav-text">Vue nextTick的版本迭代</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Resize-Observer"><span class="nav-number">6.</span> <span class="nav-text">Resize Observer</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#简单总结一下："><span class="nav-number">6.1.</span> <span class="nav-text">简单总结一下：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Resize-Observer-API-示例"><span class="nav-number">6.2.</span> <span class="nav-text">Resize Observer API 示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DOM变动事件的用法"><span class="nav-number">7.</span> <span class="nav-text">DOM变动事件的用法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#变动事件的分类有7种，最常用的浏览器支持最多的有3种"><span class="nav-number">7.1.</span> <span class="nav-text">变动事件的分类有7种，最常用的浏览器支持最多的有3种:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#删除节点检测？"><span class="nav-number">7.2.</span> <span class="nav-text">删除节点检测？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#插入节点检测？"><span class="nav-number">7.3.</span> <span class="nav-text">插入节点检测？</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常用npm包"><span class="nav-number">8.</span> <span class="nav-text">常用npm包</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#使用"><span class="nav-number">8.1.</span> <span class="nav-text">使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#resize-detector实现方式"><span class="nav-number">9.</span> <span class="nav-text">resize-detector实现方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Github"><span class="nav-number">9.1.</span> <span class="nav-text">Github</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自适应滚动条"><span class="nav-number">10.</span> <span class="nav-text">自适应滚动条</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模拟windows的resize"><span class="nav-number">11.</span> <span class="nav-text">模拟windows的resize</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现一个简单的div-resize-Listener"><span class="nav-number">12.</span> <span class="nav-text">实现一个简单的div resize Listener</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一段监视-DOM-的神奇代码"><span class="nav-number">13.</span> <span class="nav-text">一段监视 DOM 的神奇代码</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李斌</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  
  <!--
  	描述：点击红心
  -->
  <script type="text/javascript" src="/js/src/clicklove.js"></script>
  <!--
  	描述：复制代码
  -->
  <script type="text/javascript" src="/js/src/clipboard.min.js"></script>
  <script type="text/javascript" src="/js/src/clipboard-use.js"></script>
</body>
</html>


