<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="GC 全称 Garbage Collection ，即：垃圾回收。 计算机程序垃圾指的是什么呢？写过计算机程序的都知道，程序中无时无刻伴不随着变量的引用，赋值，运算等操作。于是乎存在着某些变量在使用过后，程序不会再用到它们，但是他们依然占据着一定的内存空间。内存中这样不会被程序再次使用的数据便可称之为‘垃圾’。 什么是回收？简而言之，回收就是将上面讲到的 程序运行时产生的‘垃圾’ 释放掉，以便于">
<meta property="og:type" content="article">
<meta property="og:title" content="V8垃圾回收GC">
<meta property="og:url" content="http://yoursite.com/2019/11/19/V8垃圾回收GC/index.html">
<meta property="og:site_name" content="Zero Days">
<meta property="og:description" content="GC 全称 Garbage Collection ，即：垃圾回收。 计算机程序垃圾指的是什么呢？写过计算机程序的都知道，程序中无时无刻伴不随着变量的引用，赋值，运算等操作。于是乎存在着某些变量在使用过后，程序不会再用到它们，但是他们依然占据着一定的内存空间。内存中这样不会被程序再次使用的数据便可称之为‘垃圾’。 什么是回收？简而言之，回收就是将上面讲到的 程序运行时产生的‘垃圾’ 释放掉，以便于">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://user-images.githubusercontent.com/16753554/69109158-d529d880-0ab1-11ea-8208-3545f035a0bd.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/16753554/69109197-f12d7a00-0ab1-11ea-83e1-75d4bb8c46bb.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/16753554/69109286-3d78ba00-0ab2-11ea-88fb-15995698244a.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/16753554/69109318-571a0180-0ab2-11ea-9c00-dc2b906ff800.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/16753554/69109423-af510380-0ab2-11ea-8041-8d336996bb77.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/16753554/69109448-c42d9700-0ab2-11ea-9f48-ccf7261104c7.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/16753554/69109556-1373c780-0ab3-11ea-85fb-b3019138ee47.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/16753554/69109777-b0cefb80-0ab3-11ea-9272-b4f53660278a.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/16753554/69109798-c2b09e80-0ab3-11ea-9839-46d61be6d22f.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/16753554/69109845-da882280-0ab3-11ea-934b-98e16407530c.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/16753554/69109911-0efbde80-0ab4-11ea-980a-fc59abe32f85.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/16753554/69109969-3baff600-0ab4-11ea-84ce-af75aef43ff4.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/16753554/69110070-7f0a6480-0ab4-11ea-9d2d-e51ceee918a0.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/16753554/69110106-98131580-0ab4-11ea-9743-ecb98502ed8c.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/16753554/69110130-b0833000-0ab4-11ea-8714-202d4f12e49d.png">
<meta property="og:updated_time" content="2019-12-29T16:09:17.051Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="V8垃圾回收GC">
<meta name="twitter:description" content="GC 全称 Garbage Collection ，即：垃圾回收。 计算机程序垃圾指的是什么呢？写过计算机程序的都知道，程序中无时无刻伴不随着变量的引用，赋值，运算等操作。于是乎存在着某些变量在使用过后，程序不会再用到它们，但是他们依然占据着一定的内存空间。内存中这样不会被程序再次使用的数据便可称之为‘垃圾’。 什么是回收？简而言之，回收就是将上面讲到的 程序运行时产生的‘垃圾’ 释放掉，以便于">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/16753554/69109158-d529d880-0ab1-11ea-8208-3545f035a0bd.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/11/19/V8垃圾回收GC/">





  <title>V8垃圾回收GC | Zero Days</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband">
    	<div class="eevee"><div class="body"><div class="head"><div class="ears"><div class="ear"><div class="lobe"></div></div><div class="ear"><div class="lobe"></div></div></div><div class="face"><div class="eyes"><div class="eye"><div class="eyelid"></div></div><div class="eye"><div class="eyelid"></div></div></div><div class="nose"></div><div class="mouth"></div></div></div><div class="chest"><div class="fur"><div class="patch"></div></div><div class="fur"><div class="patch"></div></div><div class="fur"><div class="patch"></div></div></div><div class="legs"><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div><div class="leg"><div class="inner-leg"></div></div></div><div class="tail"><div class="tail"><div class="tail"><div class="tail"><div class="tail"><div class="tail -end"></div></div></div></div></div></div></div></div>
    </div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
    	<div id="sky">
				<div id="background" class="container">
			<!-- svg file -->
			<svg id="svgout" height="100%" width="100%" viewbox="0 0 550 400">
				<defs>
					<g id="bottomShadow">
						<path fill="#000000" stroke="none" d="
		M 270.5 225.95
		L 127.35 316.65 266.8 400 409.6 309.25 270.5 225.95 Z"/>
					</g>
					<g id="Layer52_0_FILL">
						<path class="topGrass" fill="#B9D668" stroke="none" d="
	M 397.85 229.3
	L 397.85 225.6 269.85 152 135.75 228.6 135.75 233.65 262.1 306.55 397.85 229.3 Z"/>
					</g>
					<g id="Layer51_0_FILL">
						<path class="leftSideGrass" fill="#6E9E4F" stroke="none" d="
	M 135.1 229.95
	L 135.1 256.85 262.1 328.4 262.1 301.85 135.1 229.95 Z"/>
					</g>
					<g id="Layer50_0_FILL">
						<path class="rightGrassTop" fill="#8CB154" stroke="none" d="
	M 397.85 225.95
	L 395.8 225.95 261.75 301.55 261.75 328.4 397.85 251.15 397.85 225.95 Z"/>
					</g>
					<g id="Layer48_0_FILL">
						<path class="crustLeftTop" fill="#955541" stroke="none" d="
	M 135.45 282.4
	L 135.75 298.15 262.1 372.1 261.75 355.65 135.45 282.4 Z"/>
					</g>
					<g id="Layer47_0_FILL">
						<path class="middleLeftCrust" fill="#C77E61" stroke="none" d="
	M 135.1 270.3
	L 135.1 283.05 275.9 364.35 271.85 348.9 135.1 270.3 Z"/>
					</g>
					<g id="Layer46_0_FILL">
						<path class="crustLeftTop" fill="#955541" stroke="none" d="
	M 135.1 255.15
	L 135.1 270.3 262.1 343.55 262.1 328.05 135.1 255.15 Z"/>
					</g>
					<g id="Layer45_0_FILL">
						<path class="topRightCrust" fill="#A47237" stroke="none" d="
	M 397.5 294.5
	L 397.5 277 261.75 355.3 261.75 372.75 397.5 294.5 Z"/>
					</g>
					<g id="Layer44_0_FILL">
						<path class="middleRightCrust" fill="#C89451" stroke="none" d="
	M 397.5 269.95
	L 397.15 266.6 262.1 343.2 262.1 355.95 397.5 279.7 397.5 269.95 Z"/>
					</g>
					<g id="Layer43_0_FILL">
						<path class="topRightCrust" fill="#A47237" stroke="none" d="
	M 397.5 266.6
	L 397.5 250.45 261.75 328.4 261.75 343.85 397.5 266.6 Z"/>
					</g>
					<g id="Layer41_0_FILL">
						<path class="greyRoad" fill="#B2B2B1" stroke="none" d="
	M 295.05 283.05
	Q 299.05 280.35 308.45 275.3 317.85 269.95 323.6 266.9
	L 268.8 233.65 338.05 191.35 309.15 174.55 177.75 254.5
	Q 191.55 262.2 198.25 266.25 204.65 269.95 209.7 271.95
	L 241.6 250.45 295.05 283.05 Z"/>
					</g>
					<g id="Layer40_0_FILL">
						<path fill="#FFFFFF" stroke="none" d="
	M 199.95 256.85
	Q 194.55 261.2 191.9 262.2
	L 194.9 263.9 200.95 259.2 199.95 256.85
	M 225.8 243.75
	L 224.8 241.75 211.05 250.8 212.05 252.8 225.8 243.75
	M 308.15 275.65
	L 296.7 266.6 295.35 268.6 306.8 277.7 308.15 275.65
	M 275.9 253.5
	L 274.55 255.5 285.95 264.55 287.3 262.55 275.9 253.5
	M 251.7 227.3
	L 250.7 225.25 236.9 234.35 237.9 236.35 251.7 227.3
	M 257.05 240.7
	L 254.05 240.7 268.8 249.8 269.5 247.75 257.05 240.7
	M 277.2 207.8
	L 263.45 216.85 264.45 218.9 278.25 209.8 277.2 207.8
	M 305.1 192.65
	L 304.1 190.65 290.3 199.75 291.35 201.75 305.1 192.65 Z"/>
					</g>
					<g id="Layer38_0_FILL">
						<path class="frontFascia" fill="#ECB27B" stroke="none" d="
	M 359.25 187.95
	L 346.4 174.95 333.85 202.9 359.25 187.95 Z"/>
					</g>
					<g id="Layer37_0_FILL">
						<path class="frontWall" fill="#EFA258" stroke="none" d="
	M 334 201.05
	L 334.35 232 359.2 217.55 359.25 187.95 334 201.05 Z"/>
					</g>
					<g id="Layer36_0_FILL">
						<path class="leftWall" fill="#C57F42" stroke="none" d="
	M 334.35 232.3
	L 334.35 205.1 305.1 191.35 305.1 216.85 334.35 232.3 Z"/>
					</g>
					<g id="Layer35_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 329.7 167.9
	L 331.05 167.9 344.55 176.7 347.85 176.7 363 192.25 363.15 189.55 350.65 176.7 350.55 176.7 334.25 167.5 334.25 159.1 329.7 159.1 329.7 164.9 322.65 160.95 322.3 162.15 329.7 167 329.7 167.9 Z"/>
					</g>
					<g id="Layer34_0_FILL">
						<path class="leftRoof" fill="#F2563B" stroke="none" d="
	M 334.05 207.05
	L 350.65 176.7 322.1 160.45 302.1 192.05 334.05 207.05 Z"/>
					</g>
					<g id="Layer30_0_FILL">
						<path id="windowFour" class="windows" stroke="none" fill="#975A42" d="
	M 341.35 203.3
	Q 340.9 203.45 340.5 203.8 340.1 204.2 339.85 204.75 339.7 205 339.7 205.3 339.6 205.75 339.7 206.1 339.7 206.15 339.7 206.2 339.8 206.5 340 206.8 340.55 207.4 341.45 207.4 342.35 207.4 343 206.8 343.4 206.5 343.65 206.1 343.85 205.75 343.95 205.3 344.05 204.4 343.55 203.8 343.3 203.45 343 203.3 342.65 203.15 342.2 203.15 341.8 203.15 341.35 203.3
	M 355.85 198.45
	Q 355.8 198.2 355.6 198 355.1 197.4 354.2 197.4 353.35 197.4 352.6 198 351.85 198.65 351.7 199.55 351.7 199.7 351.7 199.85 351.6 200.5 352 201.05 352.55 201.65 353.45 201.65 354.3 201.65 355.05 201.05 355.45 200.7 355.7 200.25 355.8 200.05 355.9 199.85 355.95 199.7 355.95 199.55 356.05 198.95 355.85 198.45 Z"/>
						<path class="door" fill="#B65041" stroke="none" d="
	M 351.95 211.2
	L 351.8 211.2 346.05 215.1 346.05 225.2 351.95 221.6 351.95 211.2
	M 351.2 211.2
	L 351.35 211.2 351.35 211.1 351.2 211.2 Z"/>
					</g>
					<g>
						<path id="Layer30_0_FILL" fill="#000000" fill-opacity="1" stroke="none" d="
	M 183.7 215.3
	L 183.7 215.6
	Q 187.25 231.75 212.25 234.35
	L 183.7 215.3 Z"/>
					</g>
					<g id="Layer29_0_FILL">
						<path fill="#000000" fill-opacity="0.4" stroke="none" d="
	M 305.1 216.85
	L 305.15 217.2
	Q 309.45 233.2 334.35 232.3
	L 305.1 216.85 Z"/>
					</g>
					<g id="Layer27_0_FILL">
						<path class="vegetation" fill="#78A950" stroke="none" d="
	M 177.45 231.65
	Q 175.75 235.35 181.8 239.35 185.5 235.7 185.15 231.3 182.8 230.65 181.45 234 179.45 231.3 177.45 231.65
	M 236.9 266.6
	Q 235.2 270.3 241.25 274.3 244.95 270.6 244.65 266.25 242.3 265.6 240.95 268.95 238.9 266.25 236.9 266.6
	M 254.7 277
	Q 253.05 280.7 259.1 284.75 262.75 281.05 262.45 276.65 260.1 276 258.75 279.35 256.7 276.65 254.7 277
	M 315.5 245.75
	Q 313.5 243.05 311.5 243.4 309.8 247.1 315.85 251.15 319.55 247.45 319.2 243.05 316.85 242.4 315.5 245.75
	M 295.35 232.65
	Q 293.7 236.35 299.75 240.4 303.45 236.7 303.1 232.3 300.75 231.65 299.4 235 297.4 232.3 295.35 232.65
	M 277.2 171.85
	Q 275.55 175.55 281.6 179.55 285.3 175.85 284.95 171.5 282.6 170.85 281.25 174.2 279.25 171.5 277.2 171.85 Z"/>
					</g>
					<g id="Layer26_0_FILL">
						<path class="treeWood" fill="#AE663D" stroke="none" d="
	M 175.1 177.55
	L 172.05 177.55 172.05 191.1 159.3 172.85
	Q 154.6 171.5 172.05 195.7
	L 172.05 212.5 175.1 212.5 175.1 177.55
	M 252.7 151.35
	L 249 151.35 249 176.9 252.7 176.9 252.7 151.35 Z"/>
					</g>
					<g id="Layer25_0_FILL">
						<path class="vegetation" fill="#77A951" stroke="none" d="
	M 192.55 179.55
	Q 200.95 173.5 200.95 165.1 200.95 156.4 192.55 150 184.15 144.3 172.05 144.3 160.3 144.3 151.9 150 143.15 156.4 143.15 165.1 143.15 173.5 151.9 179.55 160.3 185.95 172.05 185.95 184.15 185.95 192.55 179.55
	M 236.25 106.65
	Q 230.2 116.05 230.2 129.15 230.2 142.25 236.25 151.35 242.3 160.75 250.7 160.75 258.75 160.75 264.8 151.35 270.85 142.25 270.85 129.15 270.85 116.05 264.8 106.65 258.75 97.6 250.7 97.6 242.3 97.6 236.25 106.65 Z"/>
					</g>
					<g id="Layer24_0_FILL">
						<path class="vegetation" fill="#77A951" stroke="none" d="
	M 158.3 221.9
	Q 160.65 221.9 161.95 220.2 163 219.55 163.3 218.55 164.65 218.9 166.35 218.9 170.05 218.9 172.4 216.2 175.1 213.85 175.1 210.15 175.1 206.45 172.4 203.75 170.05 201.4 166.35 201.4 162.65 201.4 159.95 203.75 157.6 206.45 157.6 210.15 157.6 210.8 157.6 211.15 155.95 211.5 154.6 212.5 152.9 214.15 152.9 216.55 152.9 218.9 154.6 220.2 156.25 221.9 158.3 221.9
	M 338.35 240.05
	Q 341.05 237.7 341.05 234 341.05 230.3 338.35 227.6 336 225.25 332.3 225.25 328.65 225.25 325.95 227.6 323.6 230.3 323.6 234 323.6 237.7 325.95 240.05 328.65 242.75 332.3 242.75 336 242.75 338.35 240.05 Z"/>
					</g>
					<g id="Layer22_0_FILL">
						<path class="rightRoof" fill="#D05041" stroke="none" d="
	M 220 173.85
	L 236.8 186.7 264.35 171.15 244.5 159.55 220 173.85 Z"/>
					</g>
					<g id="Layer21_0_FILL">
						<path class="leftWall" fill="#C57F42" stroke="none" d="
	M 212.25 191.35
	L 183.35 172.3 183.7 215.3 212.25 234.35 212.25 191.35 Z"/>
					</g>
					<g id="Layer20_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 192.1 149.85
	L 236.45 174.8 243.1 171.4
	Q 220.05 150.55 196.3 139.95
	L 192.1 149.85 Z"/>
					</g>
					<g id="Layer19_0_FILL">
						<path class="frontFascia" fill="#EBB17B" stroke="none" d="
	M 226.85 160.95
	L 212 190.6 229.75 192.6 239.75 172.85 226.85 160.95 Z"/>
					</g>
					<g id="Layer18_0_FILL">
						<path class="frontWall" fill="#EFA258" stroke="none" d="
	M 240.15 172.65
	L 211.9 191.6 212.25 233.65 264.35 201.7 264.35 170.8 240.8 184.45 240.15 172.65 Z"/>
					</g>
					<g id="Layer17_0_FILL">
						<path class="rightRoof" fill="#EF4427" stroke="none" d="
	M 210.9 142.2
	L 205.9 142.2 205.9 152.65 210.9 152.65 210.9 142.2 Z"/>
					</g>
					<g>
						<path id="Layer16_0_FILL" class="leftRoof" fill="#F2563B" stroke="none" d="
	M 210.25 195.5
	L 227.4 160.95 195.45 141.35 177.65 175.85 210.25 195.5 Z"/>
					</g>
					<g>
						<path id="sun" fill="#E3BD0E" stroke="none" d="
	M 257.05 15.95
	Q 251.7 15.95 248 19.65 244.3 23.35 244.3 28.7 244.3 34.1 248 37.8 251.7 41.5 257.05 41.5 262.45 41.5 266.15 37.8 269.85 34.1 269.85 28.7 269.85 23.35 266.15 19.65 262.45 15.95 257.05 15.95 Z"/>
					</g>
					<g id="Layer8_0_FILL">
						<path fill="#975A42" stroke="none" d="
	M 238.45 189.65
	Q 238.295703125 189.362109375 238.05 189.1 237.35 188.3 236.2 188.3 235.05 188.3 234.15 189.1 233.3 189.9 233.2 191.05 233.1 192.2 233.8 193 234.55 193.8 235.7 193.8 236.85 193.8 237.7 193 238.1970703125 192.558203125 238.45 192 238.6552734375 191.56484375 238.7 191.05 238.7671875 190.276953125 238.45 189.65
	M 220.55 197.55
	Q 220 197.55 219.5 197.75 218.95 197.95 218.5 198.35 217.933203125 198.8833984375 217.7 199.55 217.5833984375 199.916796875 217.55 200.3 217.4923828125 200.96171875 217.7 201.5 217.852734375 201.9103515625 218.15 202.25 218.95 203.05 220.1 203.05 221.25 203.05 222.05 202.25 222.95 201.45 223.05 200.3 223.15 199.15 222.4 198.35 222.05 197.95 221.65 197.75 221.15 197.55 220.55 197.55 Z"/>
					</g>
					<g id="Layer7_0_FILL">
						<path class="door" fill="#B65041" stroke="none" d="
	M 233.55 206.75
	L 225.9 211.95 226.25 225.5 233.95 220.35 233.55 206.75 Z"/>
					</g>
					<g>
						<path id="windowOne" class="windows" fill="#975A42" stroke="none" d="
	M 188.65 198.4
	L 188.8 204.1 198.65 210.45 198.55 204.75 188.65 198.4
	M 208.45 216.8
	L 208.35 211.1 198.55 204.75 198.65 210.45 208.45 216.8
	M 188.8 204.1
	L 188.95 209.8 198.8 216.15 198.65 210.45 188.8 204.1
	M 208.6 222.5
	L 208.45 216.8 198.65 210.45 198.8 216.15 208.6 222.5 Z"/>
					</g>
					<g>
						<path id="windowThree" class="windows" fill="#975A42" stroke="none" d="
	M 311.7 214.1
	L 318.55 217.55 318.45 211.9 311.6 208.45 311.7 214.1
	M 325.4 221
	L 325.25 215.35 318.45 211.9 318.55 217.55 325.4 221
	M 318.4 206.2
	L 311.5 202.75 311.6 208.45 318.45 211.9 318.4 206.2
	M 325.25 215.35
	L 325.2 209.7 318.4 206.2 318.45 211.9 325.25 215.35 Z"/>
					</g>
					<g id="Layer2_0_FILL">
						<path class="door" fill="#B65041" stroke="none" d="
	M 259.7 183.25
	L 244.6 191.9 244.6 213.8 259.7 204.55 259.7 183.25 Z"/>
					</g>
					<path id="windowTwo" fill="#975A42" class="windows" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" d="
	M 223.05 200.3
	Q 222.95 201.45 222.05 202.25 221.25 203.05 220.1 203.05 218.95 203.05 218.15 202.25 217.852734375 201.9103515625 217.7 201.5 217.4923828125 200.96171875 217.55 200.3 217.5833984375 199.916796875 217.7 199.575 217.933203125 198.8833984375 218.5 198.35 218.95 197.95 219.5 197.75 220 197.55 220.55 197.55 221.15 197.55 221.65 197.75 222.05 197.95 222.4 198.35 223.15 199.15 223.05 200.3 Z
	M 238.7 191.05
	Q 238.6552734375 191.56484375 238.45 192 238.1970703125 192.558203125 237.7 193 236.85 193.8 235.7 193.8 234.55 193.8 233.8 193 233.1 192.2 233.2 191.05 233.3 189.9 234.15 189.1 235.05 188.3 236.2 188.3 237.35 188.3 238.05 189.1 238.295703125 189.362109375 238.45 189.65 238.7671875 190.276953125 238.7 191.05 Z"/>
					<path fill="#F2563B" stroke="none" d=" M 351.95 211.2 L 351.8 211.2 346.05 215.1 346.05 225.2 351.95 221.6 351.95 211.2 Z"/>
					<path id="Layer6_0_1_STROKES" class="windowRims" stroke="#AE663D" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" fill="none" d="
	M 198.55 204.75
	L 208.35 211.1 208.45 216.8 208.6 222.5 198.8 216.15 188.95 209.8 188.8 204.1 188.65 198.4 198.55 204.75 198.65 210.45 208.45 216.8
	M 198.8 216.15
	L 198.65 210.45 188.8 204.1"/>
					<path id="Layer5_0_1_STROKES" class="windowRims" stroke="#AE663D" stroke-width="1" stroke-linejoin="round" stroke-linecap="round" fill="none" d="
	M 325.25 215.35
	L 325.4 221 318.55 217.55 311.7 214.1 311.6 208.45 311.5 202.75 318.4 206.2 325.2 209.7 325.25 215.35 318.45 211.9 318.55 217.55
	M 318.4 206.2
	L 318.45 211.9 311.6 208.45"/>
				</defs>
				<g id="shadow">
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use xlink:href="#bottomShadow"/>
					</g>
				</g>
				<g transform="matrix( 1, 0, 0, 1, 0,0) ">
					<use xlink:href="#sun"/>
				</g>
				<g id="earth">
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer52_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer51_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer50_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer48_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer47_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer46_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer45_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer44_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer43_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer41_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer40_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer38_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer37_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer36_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer35_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer34_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowFour"/>
						<use class="element" xlink:href="#Layer32_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer30_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer27_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer26_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer25_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer24_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer22_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer21_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer20_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer19_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer18_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer17_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer16_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer8_0_FILL"/>
						<use class="element" xlink:href="#windowTwo"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer7_0_FILL"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowOne"/>
						<use class="element" xlink:href="#Layer6_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#windowThree"/>
						<use class="element" xlink:href="#Layer5_0_1_STROKES"/>
					</g>
					<g transform="matrix( 1, 0, 0, 1, 0,0) ">
						<use class="element" xlink:href="#Layer2_0_FILL"/>
					</g>
				</g>
			</svg>
			<! -- End of SVG file -->
			<! -- Moon/Sun Toggle -->
			<div id="toggleButton" class="day-toggle">
				<div class="sun-icon"></div>
				<label class="switch">
            <input id="toggleCheckbox" type="checkbox">
            <div class="slider"></div>
        </label>
				<div class="cloud-icon"></div>
			</div>
			<! -- Moon/Sun Toggle -->
			<! -- End of Container -->
		</div>
			</div>
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zero Days</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">人生如逆旅    我亦是行人</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/19/V8垃圾回收GC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李斌">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/tx.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zero Days">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">V8垃圾回收GC</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-19T21:26:09+08:00">
                2019-11-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p> GC 全称 Garbage Collection ，即：<strong>垃圾回收</strong>。</p>
<h2 id="计算机程序垃圾指的是什么呢？"><a href="#计算机程序垃圾指的是什么呢？" class="headerlink" title="计算机程序垃圾指的是什么呢？"></a>计算机程序垃圾指的是什么呢？</h2><p>写过计算机程序的都知道，程序中无时无刻伴不随着变量的引用，赋值，运算等操作。于是乎存在着某些变量在使用过后，程序不会再用到它们，但是他们依然占据着一定的内存空间。内存中这样不会被程序再次使用的数据便可称之为‘垃圾’。</p>
<h2 id="什么是回收？"><a href="#什么是回收？" class="headerlink" title="什么是回收？"></a>什么是回收？</h2><p>简而言之，回收就是将上面讲到的 程序运行时产生的‘垃圾’ 释放掉，以便于程序再次使用这块内存区域。</p>
<h2 id="GC-的历史"><a href="#GC-的历史" class="headerlink" title="GC 的历史"></a>GC 的历史</h2><ul>
<li>1960 年 John McCarthy  首次发布著名的CG 算法 ，<strong>GC 标记-清除算法</strong></li>
<li>1960 年 George E. Collins  发布了<strong>引用计数</strong>的GC算法</li>
<li>1963 年 Marvin L. Minsky 发布了 <strong>GC 赋值算法</strong></li>
</ul>
<p>令人惊叹的是，目前所有的GC算法只不过是上述3种算法的组合或应用，也就是说从1963年赋值算法诞生时，到目前为止没有诞生新的GC算法！</p>
<h2 id="GC-中的基本概念"><a href="#GC-中的基本概念" class="headerlink" title="GC 中的基本概念"></a>GC 中的基本概念</h2><p>首先我们明确个知识点，GC在内存中<strong>销毁移动</strong>的基本单位是<strong>对象。</strong></p>
<h3 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h3><p>对象由头（head）和 域（field）构成。</p>
<p><img src="https://user-images.githubusercontent.com/16753554/69109158-d529d880-0ab1-11ea-8208-3545f035a0bd.png" alt="image"></p>
<h4 id="头-head"><a href="#头-head" class="headerlink" title="头 head"></a>头 head</h4><p>对象中保存对象本身信息的部分称之为‘头’。head中的信息用户无法访问和修改，包含下列信息。</p>
<ul>
<li>对象的大小</li>
<li>对象种类</li>
</ul>
<h4 id="域-field"><a href="#域-field" class="headerlink" title="域 field"></a>域 field</h4><p>field 对于我们而言比较熟悉，在<strong>JavaScript</strong>使用属性操作符便可以直接访问的部分被称之为域。域包含两种数据类型。</p>
<ul>
<li>指针 ，   即：引用数据类型</li>
<li>非指针， 即：基本数据类型，例如 true , false , 1, ……。</li>
</ul>
<h3 id="mutator"><a href="#mutator" class="headerlink" title="mutator"></a>mutator</h3><p>指的是修改CG对象之间的引用关系。更准确的来讲它就是 ‘<strong>应用程序</strong>’本身，也就是我们写的代码。</p>
<h3 id="堆-heap"><a href="#堆-heap" class="headerlink" title="堆 heap"></a>堆 heap</h3><p>堆指的是用于动态（也就是执行程序时）存放对象的内存空间。当 mutator 申请存放对象时， 所需的内存空间就会从这个堆中被分配给 mutator。</p>
<h3 id="活动对象-非活动对像"><a href="#活动对象-非活动对像" class="headerlink" title="活动对象/非活动对像"></a>活动对象/非活动对像</h3><p>也就是分配到内存空间中的对象中那些能够通过 mutator 引用的对象称之为 ‘活动对象’，反之为‘非活动对象’即：垃圾。</p>
<h3 id="根-root"><a href="#根-root" class="headerlink" title="根 root"></a>根 root</h3><p>在CG世界中，根指的是对象指针的起点部分。也就是<strong>mutator </strong>(应用程序) 中的全局变量，通过递归这些根（<strong>全局变量</strong>）可以遍历到的对象就是活动对象，反之就是非活动对象（<strong>垃圾</strong>）。</p>
<p><img src="https://user-images.githubusercontent.com/16753554/69109197-f12d7a00-0ab1-11ea-83e1-75d4bb8c46bb.png" alt="image"></p>
<center>（根与堆中对象的关系）</center>

<h2 id="GC标记-清除算法"><a href="#GC标记-清除算法" class="headerlink" title="GC标记-清除算法"></a>GC标记-清除算法</h2><p>如该算法的名称所描述，它的执行可以分为两个阶段，即：<strong>标记</strong> 和 <strong>清除</strong>。<strong>标记</strong>就是通过上面提到的<strong>根(全局对象)</strong>能遍历到的内存中的对象标记为<strong>活动对象</strong>，标记完成之后接下来就<strong>清除</strong>内存中没有被标记的对象，也就是<strong>非活动对象。</strong>通过这两个阶节阶段实现了内存空间的重复利用<strong>。</strong></p>
<h3 id="标记阶段"><a href="#标记阶段" class="headerlink" title="标记阶段"></a>标记阶段</h3><p><strong>标记过程</strong>实际上可以通过伪代码来更加具体展现：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*标记函数*/</span></span><br><span class="line">mark_phase()&#123;  </span><br><span class="line">  <span class="comment">// 遍历全局对象，即：根</span></span><br><span class="line">  <span class="keyword">for</span>(r : $roots)    </span><br><span class="line">    	mark(*r) </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 标记遍历到的对象,然后继续遍历该对象的引用对象。 标记过程采用的是深度优先算法 */</span></span><br><span class="line">mark(obj)&#123;</span><br><span class="line">    <span class="comment">// 遍历到已经设置为 true 的对象则不再处理</span></span><br><span class="line">    <span class="keyword">if</span>(obj.mark == FALSE)</span><br><span class="line">        obj.mark = TRUE</span><br><span class="line">    <span class="comment">// 标记后继续遍历当前对象的引用对象，直至所有的活动对象都被遍历到</span></span><br><span class="line">    <span class="keyword">for</span>(child : children(obj))      </span><br><span class="line">    	mark(*child) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="清除阶段"><a href="#清除阶段" class="headerlink" title="清除阶段"></a>清除阶段</h3><p><strong>清除阶段</strong>的遍历过程是从堆的首地址开始，一个个的遍历对象的标志位。</p>
<p>伪代码如下所示：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">sweep_phase()&#123;</span><br><span class="line">    <span class="comment">//  $heap_start 指针指堆中的第一个对象的指针</span></span><br><span class="line">    sweeping = $heap_start</span><br><span class="line">    <span class="comment">// 遍历堆时的边界控制，不能超出堆的大小</span></span><br><span class="line">    <span class="keyword">while</span>(sweeping &lt; $heap_end)</span><br><span class="line">    <span class="keyword">if</span>(sweeping.mark == TRUE)</span><br><span class="line">    	<span class="comment">// 遇到标记为 true 的对象,则取消标志位，准备下一次GC</span></span><br><span class="line">      sweeping.mark = FALSE</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    	<span class="comment">// 这里就是关键的回收处理了，首先$free_list 就是‘空闲链表’，程序需要的内存就是从其中分配获得。</span></span><br><span class="line">        <span class="comment">// 可能有小伙伴看不懂这里，就详细解释一下：</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">      	     $free_list 是指向‘空闲链表’的指针，将它赋值给要回收对象的 next 域，那么接下来这个要被回收</span></span><br><span class="line"><span class="comment">             的对象就变成了‘空闲链表’的头，即：header,也就是这个对象被加入到了空闲链表中，接下来就会被</span></span><br><span class="line"><span class="comment">            当做空闲空间来分配给应用程序。最后再将头指针赋给 $free_list 变量，也就是 $free_list 回指向</span></span><br><span class="line"><span class="comment">            空闲链表，然后继续遍历……</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        sweeping.next = $free_list</span><br><span class="line">        $free_list = sweeping</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// size 保存着被回收对象的大小，这步操作实际上就是移动至堆中的下一个对象，进行回收操作。   </span></span><br><span class="line">    sweeping += sweeping.size</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过下图可以形象的看出完成一次 GC 回收过后堆的状态：<br><img src="https://user-images.githubusercontent.com/16753554/69109286-3d78ba00-0ab2-11ea-88fb-15995698244a.png" alt="image"></p>
<center>（一次GC回收过后堆的状态）</center>

<h2 id="引用计数法"><a href="#引用计数法" class="headerlink" title="引用计数法"></a>引用计数法</h2><p><strong>GC</strong> 被本质上来说就是一种研究如何<strong>释放无法被引用对象</strong>的技术。那么，可以想到，如果让对象自己记录一下，它有没有被程序引用。这就是<strong>引用计数法</strong>。<br><img src="https://user-images.githubusercontent.com/16753554/69109318-571a0180-0ab2-11ea-9c00-dc2b906ff800.png" alt="image"></p>
<center>（引用计数法的对象）</center>

<p><strong>引用计数法</strong>与 <strong>mutator（应用程序）</strong>的执行密切相关，也就是在程序处理数据对象的过程中通过增减计数器来实现内存管理。 在对象的生成和被引用时会发生计数器的增减，也就是 <code>new_obj()</code> 函数和 <code>update_ptr()</code> 函数。</p>
<h3 id="new-obj-函数，分配内存"><a href="#new-obj-函数，分配内存" class="headerlink" title="new_obj() 函数，分配内存"></a>new_obj() 函数，分配内存</h3><p>伪代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">new_obj(size)&#123;</span><br><span class="line">    <span class="comment">// 从‘空闲链表’中为程序分配空间</span></span><br><span class="line">    obj = pickup_chunk(size, $free_list)</span><br><span class="line">  <span class="comment">// 分配空间失败</span></span><br><span class="line">  <span class="keyword">if</span>(obj == NULL)    </span><br><span class="line">    allocation_fail()  </span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="comment">// 为分配成功的对象设置计数器，并初始化</span></span><br><span class="line">    obj.ref_cnt = <span class="number">1</span>    </span><br><span class="line">    <span class="keyword">return</span> obj </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="update-ptr-函数，程序引用该对象"><a href="#update-ptr-函数，程序引用该对象" class="headerlink" title="update_ptr()函数，程序引用该对象"></a>update_ptr()函数，程序引用该对象</h3><p>伪代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">update_ptr(ptr, obj)&#123;</span><br><span class="line">    <span class="comment">// obj 对象的计数器增量操作</span></span><br><span class="line">    inc_ref_cnt(obj)</span><br><span class="line">    <span class="comment">// ptr 指针原来执行的对象计数器减量操作</span></span><br><span class="line">    dec_ref_cnt(*ptr)</span><br><span class="line">    <span class="comment">// ptr 指正指向 obj</span></span><br><span class="line">    *ptr = obj</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该函数就是让指针 ptr 要指向 obj 对象，实际中的代码类似于：</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    var a = &#123;&#125;;</span></span><br><span class="line"><span class="comment">    var b = &#123;&#125;;</span></span><br><span class="line"><span class="comment">    a 对象计数器自增，b 对象计数器自减，</span></span><br><span class="line"><span class="comment">    b=a;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p><strong>inc_ref_cnt()</strong> 函数伪代码实现：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里很简单 ，就是计数器自增</span></span><br><span class="line">inc_ref_cnt(obj)&#123;  </span><br><span class="line">    obj.ref_cnt++ </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>dec_ref_cnt()</strong> 函数伪代码实现：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dec_ref_cnt(obj)&#123;</span><br><span class="line">    <span class="comment">// obj 对象计数器自减</span></span><br><span class="line">    obj.ref_cnt--</span><br><span class="line">    <span class="comment">// 如果计数器等于 0 ,也就是说 obj 对象变为垃圾了 </span></span><br><span class="line">    <span class="keyword">if</span>(obj.ref_cnt == <span class="number">0</span>)</span><br><span class="line">  	    <span class="comment">// 那么被 obj 所引用的对象也应该做减量操作</span></span><br><span class="line">        <span class="keyword">for</span>(child : children(obj))      </span><br><span class="line">    	    dec_ref_cnt(*child)</span><br><span class="line">        <span class="comment">// 将 obj 对象连接至空闲链表</span></span><br><span class="line">    reclaim(obj) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><p>循环引用，造成内存无法被回收<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注意：例子仅用于描述场景，不符合真实环境情况</span></span><br><span class="line"></span><br><span class="line">funciton Person(name,lover) &#123; </span><br><span class="line">  <span class="keyword">this</span>.name = name;</span><br><span class="line">  <span class="keyword">this</span>.lover= lover;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> jxy = <span class="keyword">new</span> Person(<span class="string">"jxy"</span>); </span><br><span class="line"><span class="keyword">let</span> xxx = <span class="keyword">new</span> Person(<span class="string">"xxx"</span>)</span><br><span class="line">jxy.lover = xxx;</span><br><span class="line">xxx.lover = jxy;</span><br><span class="line"></span><br><span class="line">xxx = <span class="literal">null</span>;</span><br><span class="line">jxy = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当GC采用引用计数法管理内存的时候，在上面例子中虽然变量都被赋值为空，但是两个对象本身确相互</span></span><br><span class="line"><span class="comment">// 引用，这样就导致了内存无法被有效回收，即：内存泄露复制代码</span></span><br></pre></td></tr></table></figure></p>
<h2 id="GC复制算法"><a href="#GC复制算法" class="headerlink" title="GC复制算法"></a>GC复制算法</h2><p>复制算法顾名思义，就是将堆中的所有活动对象复制到另外一个空间，然后原来的空间全部回收掉。这样的好处就是防止出现内存的碎片化，易于随后为程序分配新的空间。可以形象的理解为下图：</p>
<p><img src="https://user-images.githubusercontent.com/16753554/69109423-af510380-0ab2-11ea-8041-8d336996bb77.png" alt="image"></p>
<h3 id="复制算法"><a href="#复制算法" class="headerlink" title="复制算法"></a>复制算法</h3><p>我们把原来的活动对象空间称之为 <strong>From </strong>空间，将要复制到的新空间称之为 <strong>To</strong> 空间。当 <strong>From </strong>空间被完全占满时，GC 会将活动对象复制到 <strong>To</strong> 空间。复制完成后，该算法会把 <strong>From</strong> 空间和 <strong>To</strong> 空间互换，本次 GC 也就结束了。GC 复制算法概要如下图所示：</p>
<p><img src="https://user-images.githubusercontent.com/16753554/69109448-c42d9700-0ab2-11ea-9f48-ccf7261104c7.png" alt="image"></p>
<center>（GC 复制算法概要）</center>

<p>这里再说明一下，<strong>mutator </strong>就是应用程序本身，一次回收完成之后，程序会继续执行，再次产生垃圾，新的 <strong>From</strong> 空间会被填满，然后 GC 又开始新的一轮回收操作，回收操作伴随程序的整个生命周期。</p>
<p>下面我们通过伪代码来的看一下 GC 复制算法的具体实现思路。</p>
<p><strong>copying()</strong> 函数伪代码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">copying()&#123;	</span><br><span class="line">    <span class="comment">// 用 $free 变量记录 To 空间的开始位置</span></span><br><span class="line">    $free = $to_start</span><br><span class="line">    <span class="comment">// 遍历所有的根对象，使用 copy 方法将他们复制到 To 空间</span></span><br><span class="line">    <span class="keyword">for</span>(r : $roots)</span><br><span class="line">        <span class="comment">// 返回的 *r 是对象被复制到 To 空间后新的指针。 </span></span><br><span class="line">        *r = copy(*r)</span><br><span class="line">    <span class="comment">// 复制完成之后，交换 From 和 To 空间</span></span><br><span class="line">    swap($from_start, $to_start)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>copy()</strong>函数伪代码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* copy 函数将作为参数给出的对象复制，再递归复制其子对象 */</span></span><br><span class="line">copy(obj)&#123;</span><br><span class="line">    <span class="comment">// obj 对象的 tag 域用于标记是否是一个已经被赋值过的对象 </span></span><br><span class="line">    <span class="keyword">if</span>(obj.tag != COPIED)</span><br><span class="line">  	    <span class="comment">// 使用 copy_data 方法具体来拷贝 obj 对象，同时传入To 空间地址，以及 obj d对象的大小  </span></span><br><span class="line">        copy_data($free, obj, obj.size)</span><br><span class="line">        <span class="comment">// 拷贝完成之后，标记一下，该对象已经被赋值过了. $free 变量指向新的 obj</span></span><br><span class="line">        obj.tag = COPIED</span><br><span class="line">        <span class="comment">//  旧的 obj 对象的 forwarding 域保存新的 obj 对象的指针，用于后面将其赋给程序中原始的指向</span></span><br><span class="line">        obj.forwarding = $free</span><br><span class="line">        <span class="comment">// $free 跳过已经被复制的 obj 的空间，指向 To 空间的空闲位置，方便下一次复制使用 </span></span><br><span class="line">        $free += obj.size</span><br><span class="line">        <span class="comment">// 递归复制 obj 对象的引用对象</span></span><br><span class="line">        <span class="keyword">for</span>(child : children(obj.forwarding))</span><br><span class="line">        *child = copy(*child)</span><br><span class="line">    <span class="comment">// 当拷贝完成之后返回新对象的指针</span></span><br><span class="line">    <span class="keyword">return</span> obj.forwarding</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Chrome-V8-的垃圾回收"><a href="#Chrome-V8-的垃圾回收" class="headerlink" title="Chrome V8 的垃圾回收"></a>Chrome V8 的垃圾回收</h2><p>前面写了那么多，那么到底我们常用的浏览器使用的是那种回收算法呢？我想这可能是小伙伴们最关心的了。那么以我们最喜爱的 Chrome 为例，它使用的是多种回收算法的组合优化，而非某种单一算法。V8 的 GC 算法统称为<strong>分代垃圾回收算法</strong>，也就是通过记录对象的引用次数，将超过一定引用次数的对象划分为<strong>老年对象</strong>，剩下的称之为<strong>新生代对象，</strong>然后分别对他们采用不同到的垃圾回收算法<strong>。</strong>那这样划分到底有什么优势呢，我们知道程序中生成的大多数对象其实都是产生之后随即丢弃。以下面代码为例，函数内部生成了对象，在该函数执行完毕，出栈之后，包括函数本身以及它内部的变量都会立刻成为垃圾：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 该函数的执行上下文环境非全局作用域</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> a = &#123;<span class="attr">c</span>:<span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">var</span> c = &#123;<span class="attr">c</span>:<span class="number">2</span>&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>那么对于这种新生代对象来说，回收就会变得很频繁，如果使用 <strong>GC 标记清除算法</strong>，那么就意味着每次清除过程需要处理很多的对象，会浪费大量的的时间。于是如果对新生代对象采用 <strong>GC 复制算法</strong>的只需要将活动对象复制出来，然后将整个 <strong>From </strong>清空即可，无需再去遍历需要清除的对象，达到优化的目的。而针对老年对象则不同，它们都有多个引用，也就意味着它们成为非活动对象的概率较小，也就可以理解为<strong>老年对象</strong>不会轻易变成垃圾。再进一步也就是<strong>老对象</strong>产生的垃圾很少，如果采用复制算法的话得不偿失，大量的<strong>老年对象</strong>被复制来复制去也会增加负担，所以针对老年对象采用的是<strong>标记清除法，</strong>需要清除的老年对象只是少数，这样<strong>标记清除算法</strong>会更有优势<strong>。</strong>还有随着程序的执行新生代的对象会变成老年对象，这个具体过程比较复杂，小的能力有限，这里也就一笔带过了。既然对象分为新生带对像和老年对象，那么它们在堆中是如何分布的呢，请看下图：</p>
<p><img src="https://user-images.githubusercontent.com/16753554/69109556-1373c780-0ab3-11ea-85fb-b3019138ee47.png" alt="image"></p>
<center>（V8 的 VM 堆结构示意图 ）</center>

<p>这里我们只需要知道堆被分为新生带空间，和老年代空间即可。除了新生代空间中方的 <strong>From </strong>空间和 <strong>To</strong> 空间外，老年代空间中细分优化，各位大佬请自由探索，小的能有限，就不敢造次了o(╥﹏╥)o。</p>
<h2 id="V8-引擎如何进行垃圾内存的回收？"><a href="#V8-引擎如何进行垃圾内存的回收？" class="headerlink" title="V8 引擎如何进行垃圾内存的回收？"></a>V8 引擎如何进行垃圾内存的回收？</h2><p>JS 语言不像 C/C++, 让程序员自己去开辟或者释放内存，而是类似Java，采用自己的一套垃圾回收算法进行自动的内存管理。作为一名资深的前端工程师，对于JS内存回收的机制是需要非常清楚, 以便于在极端的环境下能够分析出系统性能的瓶颈，另一方面，学习这其中的机制，也对我们深入理解JS的闭包特性、以及对内存的高效使用，都有很大的帮助。</p>
<h3 id="V8-内存限制"><a href="#V8-内存限制" class="headerlink" title="V8 内存限制"></a>V8 内存限制</h3><p>在其他的后端语言中，如Java/Go, 对于内存的使用没有什么限制，但是JS不一样，V8只能使用系统的一部分内存，具体来说，在64位系统下，V8最多只能分配1.4G, 在 32 位系统中，最多只能分配0.7G。你想想在前端这样的大内存需求其实并不大，但对于后端而言，nodejs如果遇到一个2G多的文件，那么将无法全部将其读入内存进行各种操作了。</p>
<p>我们知道对于栈内存而言，当ESP指针下移，也就是上下文切换之后，栈顶的空间会自动被回收。但对于堆内存而言就比较复杂了，我们下面着重分析堆内存的垃圾回收。</p>
<p>上一篇我们提到过了，所有的对象类型的数据在JS中都是通过堆进行空间分配的。当我们构造一个对象进行赋值操作的时候，其实相应的内存已经分配到了堆上。你可以不断的这样创建对象，让 V8 为它分配空间，直到堆的大小达到上限。</p>
<p>那么问题来了，V8 为什么要给它设置内存上限？明明我的机器大几十G的内存，只能让我用这么一点？</p>
<p>究其根本，是由两个因素所共同决定的，一个是JS单线程的执行机制，另一个是JS垃圾回收机制的限制。</p>
<p>首先JS是单线程运行的，这意味着一旦进入到垃圾回收，那么其它的各种运行逻辑都要暂停; 另一方面垃圾回收其实是非常耗时间的操作，V8 官方是这样形容的:</p>
<blockquote>
<p>以 1.5GB 的垃圾回收堆内存为例，V8 做一次小的垃圾回收需要50ms 以上，做一次非增量式(ps:后面会解释)的垃圾回收甚至要 1s 以上。</p>
</blockquote>
<p>可见其耗时之久，而且在这么长的时间内，我们的JS代码执行会一直没有响应，造成应用卡顿，导致应用性能和响应能力直线下降。因此，V8 做了一个简单粗暴的选择，那就是限制堆内存，也算是一种权衡的手段，因为大部分情况是不会遇到操作几个G内存这样的场景的。</p>
<p>不过，如果你想调整这个内存的限制也不是不行。配置命令如下:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这是调整老生代这部分的内存，单位是MB。后面会详细介绍新生代和老生代内存</span></span><br><span class="line">node --max-old-space-size=<span class="number">2048</span> xxx.js</span><br></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 这是调整新生代这部分的内存，单位是 KB。</span><br><span class="line">node --max-new-space-size=2048 xxx.js</span><br></pre></td></tr></table></figure></p>
<h3 id="新生代内存的回收"><a href="#新生代内存的回收" class="headerlink" title="新生代内存的回收"></a>新生代内存的回收</h3><p>V8 把堆内存分成了两部分进行处理——新生代内存和老生代内存。顾名思义，新生代就是临时分配的内存，存活时间短， 老生代是常驻内存，存活的时间长。V8 的堆内存，也就是两个内存之和。</p>
<p><img src="https://user-images.githubusercontent.com/16753554/69109777-b0cefb80-0ab3-11ea-9272-b4f53660278a.png" alt="image"></p>
<p>根据这两种不同种类的堆内存，V8 采用了不同的回收策略，来根据不同的场景做针对性的优化。</p>
<p>首先是新生代的内存，刚刚已经介绍了调整新生代内存的方法，那它的内存默认限制是多少？在 64 位和 32 位系统下分别为 32MB 和 16MB。够小吧，不过也很好理解，新生代中的变量存活时间短，来了马上就走，不容易产生太大的内存负担，因此可以将它设的足够小。</p>
<p>那好了，新生代的垃圾回收是怎么做的呢？</p>
<p>首先将新生代内存空间一分为二:</p>
<p><img src="https://user-images.githubusercontent.com/16753554/69109798-c2b09e80-0ab3-11ea-9839-46d61be6d22f.png" alt="image"></p>
<p>其中From部分表示正在使用的内存，To 是目前闲置的内存。</p>
<p>当进行垃圾回收时，V8 将From部分的对象检查一遍，如果是存活对象那么复制到To内存中(在To内存中按照顺序从头放置的)，如果是非存活对象直接回收即可。</p>
<p>当所有的From中的存活对象按照顺序进入到To内存之后，From 和 To 两者的角色对调，From现在被闲置，To为正在使用，如此循环。</p>
<p>那你很可能会问了，直接将非存活对象回收了不就万事大吉了嘛，为什么还要后面的一系列操作？</p>
<p>注意，我刚刚特别说明了，在To内存中按照顺序从头放置的，这是为了应对这样的场景:</p>
<p><img src="https://user-images.githubusercontent.com/16753554/69109845-da882280-0ab3-11ea-934b-98e16407530c.png" alt="image"></p>
<p>深色的小方块代表存活对象，白色部分表示待分配的内存，由于堆内存是连续分配的，这样零零散散的空间可能会导致稍微大一点的对象没有办法进行空间分配，这种零散的空间也叫做内存碎片。刚刚介绍的新生代垃圾回收算法也叫Scavenge算法。</p>
<p><strong>Scavenge 算法主要就是解决内存碎片的问题</strong>，在进行一顿复制之后，To空间变成了这个样子:</p>
<p><img src="https://user-images.githubusercontent.com/16753554/69109911-0efbde80-0ab4-11ea-980a-fc59abe32f85.png" alt="image"></p>
<p>是不是整齐了许多？这样就大大方便了后续连续空间的分配。</p>
<p>不过Scavenge 算法的劣势也非常明显，就是内存只能使用新生代内存的一半，但是它只存放生命周期短的对象，这种对象一般很少，因此时间性能非常优秀。</p>
<h3 id="老生代内存的回收"><a href="#老生代内存的回收" class="headerlink" title="老生代内存的回收"></a>老生代内存的回收</h3><p>刚刚介绍了新生代的回收方式，那么新生代中的变量如果经过多次回收后依然存在，那么就会被放入到老生代内存中，这种现象就叫晋升。</p>
<p>发生晋升其实不只是这一种原因，我们来梳理一下会有那些情况触发晋升:</p>
<ul>
<li>已经经历过一次 Scavenge 回收。</li>
<li>To（闲置）空间的内存占用超过25%。</li>
</ul>
<p>现在进入到老生代的垃圾回收机制当中，老生代中累积的变量空间一般都是很大的，当然不能用Scavenge算法啦，浪费一半空间不说，对庞大的内存空间进行复制岂不是劳民伤财？</p>
<p>那么对于老生代而言，究竟是采取怎样的策略进行垃圾回收的呢？</p>
<p>第一步，进行标记-清除。这个过程在《JavaScript高级程序设计(第三版)》中有过详细的介绍，主要分成两个阶段，即标记阶段和清除阶段。首先会遍历堆中的所有对象，对它们做上标记，然后对于代码环境中使用的变量以及被强引用的变量取消标记，剩下的就是要删除的变量了，在随后的清除阶段对其进行空间的回收。</p>
<p>当然这又会引发内存碎片的问题，存活对象的空间不连续对后续的空间分配造成障碍。老生代又是如何处理这个问题的呢？</p>
<p>第二步，整理内存碎片。V8 的解决方式非常简单粗暴，在清除阶段结束后，把存活的对象全部往一端靠拢。</p>
<p><img src="https://user-images.githubusercontent.com/16753554/69109969-3baff600-0ab4-11ea-84ce-af75aef43ff4.png" alt="image"></p>
<p>由于是移动对象，它的执行速度不可能很快，事实上也是整个过程中最耗时间的部分。</p>
<h3 id="增量标记"><a href="#增量标记" class="headerlink" title="增量标记"></a>增量标记</h3><p>由于JS的单线程机制，V8 在进行垃圾回收的时候，不可避免地会阻塞业务逻辑的执行，倘若老生代的垃圾回收任务很重，那么耗时会非常可怕，严重影响应用的性能。那这个时候为了避免这样问题，V8 采取了增量标记的方案，即将一口气完成的标记任务分为很多小的部分完成，每做完一个小的部分就”歇”一下，就js应用逻辑执行一会儿，然后再执行下面的部分，如果循环，直到标记阶段完成才进入内存碎片的整理上面来。其实这个过程跟React Fiber的思路有点像，这里就不展开了。</p>
<p>经过增量标记之后，垃圾回收过程对JS应用的阻塞时间减少到原来了1 / 6, 可以看到，这是一个非常成功的改进。</p>
<p>JS垃圾回收的原理就介绍到这里了，其实理解起来是非常简单的，重要的是理解它为什么要这么做，而不仅仅是如何做的，希望这篇总结能够对你有所启发。</p>
<h2 id="V8-执行一段JS代码的过程？"><a href="#V8-执行一段JS代码的过程？" class="headerlink" title="V8 执行一段JS代码的过程？"></a>V8 执行一段JS代码的过程？</h2><p>站在 V8 的角度，理解其中的执行机制，也能够帮助我们理解很多的上层应用，包括Babel、Eslint、前端框架的底层机制。那么，一段 JavaScript 代码放在 V8 当中究竟是如何执行的呢？</p>
<p>首先需要明白的是，机器是读不懂 JS 代码，机器只能理解特定的机器码，那如果要让 JS 的逻辑在机器上运行起来，就必须将 JS 的代码翻译成机器码，然后让机器识别。JS属于解释型语言，对于解释型的语言说，解释器会对源代码做如下分析:</p>
<p>通过词法分析和语法分析生成 AST(抽象语法树)<br>生成字节码<br>然后解释器根据字节码来执行程序。但 JS 整个执行的过程其实会比这个更加复杂，接下来就来一一地拆解。</p>
<h3 id="1-生成-AST"><a href="#1-生成-AST" class="headerlink" title="1.生成 AST"></a>1.生成 AST</h3><p>生成 AST 分为两步——词法分析和语法分析。</p>
<p>词法分析即分词，它的工作就是将一行行的代码分解成一个个token。 比如下面一行代码:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> name = <span class="string">'sanyuan'</span></span><br></pre></td></tr></table></figure></p>
<p>其中会把句子分解成四个部分:</p>
<p><img src="https://user-images.githubusercontent.com/16753554/69110070-7f0a6480-0ab4-11ea-9d2d-e51ceee918a0.png" alt="image"></p>
<p>即解析成了四个token，这就是词法分析的作用。</p>
<p>接下来语法分析阶段，将生成的这些 token 数据，根据一定的语法规则转化为AST。举个例子:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> name = <span class="string">'sanyuan'</span></span><br><span class="line"><span class="built_in">console</span>.log(name)</span><br></pre></td></tr></table></figure></p>
<p>最后生成的 AST 是这样的:</p>
<p><img src="https://user-images.githubusercontent.com/16753554/69110106-98131580-0ab4-11ea-9743-ecb98502ed8c.png" alt="image"></p>
<p>当生成了 AST 之后，编译器/解释器后续的工作都要依靠 AST 而不是源代码。顺便补充一句，babel 的工作原理就是将ES5 的代码解析生成ES5的AST，然后将ES5 的 AST 转换为 ES6 的AST,最后才将 ES6 的 AST 转化为具体的 ES6 代码。由于本文着重阐述原理，关于 babel 编译的细节就不展开了，推荐大家去读一读荒山的babel文章, 帮你打开新世界的大门: )</p>
<p>回到 V8 本身，生成 AST 后，接下来会生成执行上下文，关于执行上下文，可以参考上上篇《JavaScript内存机制之问——数据是如何存储的？》中对于上下文压栈出栈过程的讲解。</p>
<p>#2. 生成字节码<br>开头就已经提到过了，生成 AST 之后，直接通过 V8 的解释器(也叫Ignition)来生成字节码。但是字节码并不能让机器直接运行，那你可能就会说了，不能执行还转成字节码干嘛，直接把 AST 转换成机器码不就得了，让机器直接执行。确实，在 V8 的早期是这么做的，但后来因为机器码的体积太大，引发了严重的内存占用问题。</p>
<p>给一张对比图让大家直观地感受以下三者代码量的差异:</p>
<p><img src="https://user-images.githubusercontent.com/16753554/69110130-b0833000-0ab4-11ea-8714-202d4f12e49d.png" alt="image"></p>
<p>很容易得出，字节码是比机器码轻量得多的代码。那 V8 为什么要使用字节码，字节码到底是个什么东西？</p>
<blockquote>
<p>子节码是介于AST 和 机器码之间的一种代码，但是与特定类型的机器码无关，字节码需要通过解释器将其转换为机器码然后执行。</p>
</blockquote>
<p>字节码仍然需要转换为机器码，但和原来不同的是，现在不用一次性将全部的字节码都转换成机器码，而是通过解释器来逐行执行字节码，省去了生成二进制文件的操作，这样就大大降低了内存的压力。</p>
<h3 id="执行代码"><a href="#执行代码" class="headerlink" title="执行代码"></a>执行代码</h3><p>接下来，就进入到字节码解释执行的阶段啦！</p>
<p>在执行字节码的过程中，如果发现某一部分代码重复出现，那么 V8 将它记做热点代码(HotSpot)，然后将这么代码编译成机器码保存起来，这个用来编译的工具就是V8的编译器(也叫做TurboFan) , 因此在这样的机制下，代码执行的时间越久，那么执行效率会越来越高，因为有越来越多的字节码被标记为热点代码，遇到它们时直接执行相应的机器码，不用再次将转换为机器码。</p>
<p>其实当你听到有人说 JS 就是一门解释器语言的时候，其实这个说法是有问题的。因为字节码不仅配合了解释器，而且还和编译器打交道，所以 JS 并不是完全的解释型语言。而编译器和解释器的 根本区别在于前者会编译生成二进制文件但后者不会。</p>
<p>并且，这种字节码跟编译器和解释器结合的技术，我们称之为即时编译, 也就是我们经常听到的JIT。</p>
<p>这就是 V8 中执行一段JS代码的整个过程，梳理一下:</p>
<ul>
<li>首先通过词法分析和语法分析生成 AST</li>
<li>将 AST 转换为字节码</li>
<li>由解释器逐行执行字节码，遇到热点代码启动编译器进行编译，生成对应的机器码, 以优化执行效率</li>
</ul>
<p>关于这个问题的拆解就到这里，希望对你有所启发。</p>
<h2 id="文章参考"><a href="#文章参考" class="headerlink" title="文章参考"></a>文章参考</h2><ul>
<li><a href="https://juejin.im/post/5e00c5dc518825121e380303" target="_blank" rel="noopener">JavaScript进阶-内存机制(表情包初探)</a></li>
<li><a href="https://sanyuan0704.github.io/frontend_daily_question/" target="_blank" rel="noopener">前端每日一问</a></li>
<li><a href="https://juejin.im/post/5dc4d823f265da4d4c202d3b" target="_blank" rel="noopener">V8 是怎么跑起来的 —— V8 的 JavaScript 执行管道</a></li>
<li><a href="https://www.ituring.com.cn/book/1460" target="_blank" rel="noopener">垃圾回收的算法与实现</a></li>
<li><a href="https://juejin.im/post/5b1f7e62e51d45068a6cb98f" target="_blank" rel="noopener">javascript 垃圾回收算法了解一下</a></li>
<li><a href="https://juejin.im/post/5db580c751882564420f0553#heading-20" target="_blank" rel="noopener">聊聊垃圾回收 GC</a></li>
<li><a href="https://juejin.im/post/5db2beb8e51d455b450a64b4" target="_blank" rel="noopener">Chrome 浏览器垃圾回收机制与内存泄漏分析</a></li>
<li><a href="https://juejin.im/post/5dbac42ce51d4529e1569922" target="_blank" rel="noopener">这一次，彻底弄清楚V8垃圾回收的流程</a></li>
<li><a href="https://sanyuan0704.github.io/frontend_daily_question/week07/038.html#v8-%E5%86%85%E5%AD%98%E9%99%90%E5%88%B6" target="_blank" rel="noopener">V8 引擎如何进行垃圾内存的回收？</a></li>
<li><a href="https://juejin.im/post/5cb33660e51d456e811d2687#heading-10" target="_blank" rel="noopener">JavaScript中的垃圾回收和内存泄漏</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/11/03/你可能不知道的元属性new-target/" rel="next" title="你可能不知道的元属性new.target">
                <i class="fa fa-chevron-left"></i> 你可能不知道的元属性new.target
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/11/19/一道面试题引发的思考5/" rel="prev" title="一道面试题引发的思考5">
                一道面试题引发的思考5 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/tx.jpg" alt="李斌">
            
              <p class="site-author-name" itemprop="name">李斌</p>
              <p class="site-description motion-element" itemprop="description">人生如逆旅     我亦是行人</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">201</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">121</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/libin1991" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://juejin.im/user/57e737f6c4c971005f6bcd8d" target="_blank" title="juejin">
                      
                        <i class="fa fa-fw fa-spinner"></i>juejin</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#计算机程序垃圾指的是什么呢？"><span class="nav-number">1.</span> <span class="nav-text">计算机程序垃圾指的是什么呢？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是回收？"><span class="nav-number">2.</span> <span class="nav-text">什么是回收？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GC-的历史"><span class="nav-number">3.</span> <span class="nav-text">GC 的历史</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GC-中的基本概念"><span class="nav-number">4.</span> <span class="nav-text">GC 中的基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#对象"><span class="nav-number">4.1.</span> <span class="nav-text">对象</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#头-head"><span class="nav-number">4.1.1.</span> <span class="nav-text">头 head</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#域-field"><span class="nav-number">4.1.2.</span> <span class="nav-text">域 field</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mutator"><span class="nav-number">4.2.</span> <span class="nav-text">mutator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#堆-heap"><span class="nav-number">4.3.</span> <span class="nav-text">堆 heap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#活动对象-非活动对像"><span class="nav-number">4.4.</span> <span class="nav-text">活动对象/非活动对像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#根-root"><span class="nav-number">4.5.</span> <span class="nav-text">根 root</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GC标记-清除算法"><span class="nav-number">5.</span> <span class="nav-text">GC标记-清除算法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#标记阶段"><span class="nav-number">5.1.</span> <span class="nav-text">标记阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#清除阶段"><span class="nav-number">5.2.</span> <span class="nav-text">清除阶段</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#引用计数法"><span class="nav-number">6.</span> <span class="nav-text">引用计数法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#new-obj-函数，分配内存"><span class="nav-number">6.1.</span> <span class="nav-text">new_obj() 函数，分配内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#update-ptr-函数，程序引用该对象"><span class="nav-number">6.2.</span> <span class="nav-text">update_ptr()函数，程序引用该对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#缺点"><span class="nav-number">6.3.</span> <span class="nav-text">缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GC复制算法"><span class="nav-number">7.</span> <span class="nav-text">GC复制算法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#复制算法"><span class="nav-number">7.1.</span> <span class="nav-text">复制算法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chrome-V8-的垃圾回收"><span class="nav-number">8.</span> <span class="nav-text">Chrome V8 的垃圾回收</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#V8-引擎如何进行垃圾内存的回收？"><span class="nav-number">9.</span> <span class="nav-text">V8 引擎如何进行垃圾内存的回收？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#V8-内存限制"><span class="nav-number">9.1.</span> <span class="nav-text">V8 内存限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新生代内存的回收"><span class="nav-number">9.2.</span> <span class="nav-text">新生代内存的回收</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#老生代内存的回收"><span class="nav-number">9.3.</span> <span class="nav-text">老生代内存的回收</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#增量标记"><span class="nav-number">9.4.</span> <span class="nav-text">增量标记</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#V8-执行一段JS代码的过程？"><span class="nav-number">10.</span> <span class="nav-text">V8 执行一段JS代码的过程？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-生成-AST"><span class="nav-number">10.1.</span> <span class="nav-text">1.生成 AST</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行代码"><span class="nav-number">10.2.</span> <span class="nav-text">执行代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文章参考"><span class="nav-number">11.</span> <span class="nav-text">文章参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李斌</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

  
  <!--
  	描述：点击红心
  -->
  <script type="text/javascript" src="/js/src/clicklove.js"></script>
  <!--
  	描述：复制代码
  -->
  <script type="text/javascript" src="/js/src/clipboard.min.js"></script>
  <script type="text/javascript" src="/js/src/clipboard-use.js"></script>
</body>
</html>


